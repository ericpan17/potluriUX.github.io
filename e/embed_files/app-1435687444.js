(function() {
    window.Bookmarkleter = (function() {
        var
            _normalize = function(str) {
                var
                    Text = str;
                Text = Text.replace(/\r/g, '\n');
                Text = _removeComments(Text);
                Text = Text.replace(/[\t ]+/g, ' ');
                Text = Text.replace(/'/g, '"<$<$<$<$<$<');
                var
                    NewlineArray = Text.split('\n');
                var
                    LineCount = NewlineArray.length;
                var
                    QuoteArray = Array();
                var
                    SplitCount = 0;
                for (i = 0; i < LineCount; i++) {
                    NewlineArray[i] = NewlineArray[i].replace(/^[\t ]+/g, '');
                    NewlineArray[i] = NewlineArray[i].replace(/[\t ]+$/g, '');
                    QuoteArray = NewlineArray[i].split('"');
                    SplitCount = QuoteArray.length;
                    for (j = 0; j < SplitCount; j++) {
                        if ((j % 2) == 0) QuoteArray[j] = _makeReplacements(QuoteArray[j]);
                    }
                    NewlineArray[i] = QuoteArray.join('"');
                }
                Text = NewlineArray.join('');
                Text = Text.replace(/"<\$<\$<\$<\$<\$</g, "'");
                Text = Text.replace(/%/g, '%25');
                Text = Text.replace(/"/g, '%22');
                Text = Text.replace(/</g, '%3C');
                Text = Text.replace(/>/g, '%3E');
                Text = Text.replace(/#/g, '%23');
                Text = Text.replace(/@/g, '%40');
                Text = Text.replace(/ /g, '%20');
                Text = Text.replace(/\&/g, '%26');
                Text = Text.replace(/\?/g, '%3F');
                if (Text.substring(0, 11) == 'javascript:') Text = Text.substring(11);
                TextLength = Text.length;
                if ((Text.substring(0, 12) + Text.substring(TextLength - 5)) != '(function(){})();') Text = '(function(){' + Text + '})();';
                Text = 'javascript:' + Text;
                return Text;
            };
        var
            _makeReplacements = function(str) {
                Text = str.replace(/ ?; ?/g, ';');
                Text = Text.replace(/ ?: ?/g, ':');
                Text = Text.replace(/ ?, ?/g, ',');
                Text = Text.replace(/ ?= ?/g, '=');
                Text = Text.replace(/ ?% ?/g, '%');
                Text = Text.replace(/ ?\+ ?/g, '+');
                Text = Text.replace(/ ?\* ?/g, '*');
                Text = Text.replace(/ ?\? ?/g, '?');
                Text = Text.replace(/ ?\{ ?/g, '{');
                Text = Text.replace(/ ?\} ?/g, '}');
                Text = Text.replace(/ ?\[ ?/g, '[');
                Text = Text.replace(/ ?\] ?/g, ']');
                Text = Text.replace(/ ?\( ?/g, '(');
                Text = Text.replace(/ ?\) ?/g, ')');
                return Text;
            };

        function
        _removeComments(str) {
            str = ('__' + str + '__').split('');
            var
                mode = {
                    singleQuote: false,
                    doubleQuote: false,
                    regex: false,
                    blockComment: false,
                    lineComment: false,
                    condComp: false
                };
            for (var
                    i = 0, l = str.length; i < l; i++) {
                if (mode.regex) {
                    if (str[i] === '/' && str[i - 1] !== '\\') {
                        mode.regex = false;
                    }
                    continue;
                }
                if (mode.singleQuote) {
                    if (str[i] === "'" && str[i - 1] !== '\\') {
                        mode.singleQuote = false;
                    }
                    continue;
                }
                if (mode.doubleQuote) {
                    if (str[i] === '"' && str[i - 1] !== '\\') {
                        mode.doubleQuote = false;
                    }
                    continue;
                }
                if (mode.blockComment) {
                    if (str[i] === '*' && str[i + 1] === '/') {
                        str[i + 1] = '';
                        mode.blockComment = false;
                    }
                    str[i] = '';
                    continue;
                }
                if (mode.lineComment) {
                    if (str[i + 1] === '\n' || str[i + 1] === '\r') {
                        mode.lineComment = false;
                    }
                    str[i] = '';
                    continue;
                }
                if (mode.condComp) {
                    if (str[i - 2] === '@' && str[i - 1] === '*' && str[i] === '/') {
                        mode.condComp = false;
                    }
                    continue;
                }
                mode.doubleQuote = str[i] === '"';
                mode.singleQuote = str[i] === "'";
                if (str[i] === '/') {
                    if (str[i + 1] === '*' && str[i + 2] === '@') {
                        mode.condComp = true;
                        continue;
                    }
                    if (str[i + 1] === '*') {
                        str[i] = '';
                        mode.blockComment = true;
                        continue;
                    }
                    if (str[i + 1] === '/') {
                        str[i] = '';
                        mode.lineComment = true;
                        continue;
                    }
                    mode.regex = true;
                }
            }
            return str.join('').slice(2, -2);
        };
        return {
            convert: function(str) {
                return _normalize(str);
            }
        };
    })();
})();
(function() {
    var
        initializing = false,
        fnTest = /xyz/.test(function() {
            xyz;
        }) ? /\b_super\b/ : /.*/;
    this.Class = function() {};
    Class.extend = function(prop) {
        var
            _super = this.prototype;
        initializing = true;
        var
            prototype = new
        this();
        initializing = false;
        for (var
                name in
                prop) {
            prototype[name] = typeof
            prop[name] == "function" && typeof
            _super[name] == "function" && fnTest.test(prop[name]) ? (function(name, fn) {
                return function() {
                    var
                        tmp = this._super;
                    this._super = _super[name];
                    var
                        ret = fn.apply(this, arguments);
                    this._super = tmp;
                    return ret;
                };
            })(name, prop[name]) : prop[name];
        }

        function
        Class() {
            if (!initializing && this.init) this.init.apply(this, arguments);
        }
        Class.prototype = prototype;
        Class.prototype.constructor = Class;
        Class.extend = arguments.callee;
        return Class;
    };
})();
(function(e, t) {
    var
        n, r, i = typeof
    t, o = e.document, a = e.location, s = e.jQuery, u = e.$, l = {}, c = [], p = "1.9.1", f = c.concat, d = c.push, h = c.slice, g = c.indexOf, m = l.toString, y = l.hasOwnProperty, v = p.trim, b = function(e, t) {
        return new
        b.fn.init(e, t, r)
    }, x = /[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source, w = /\S+/g, T = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, N = /^(?:(<[\w\W]+>)[^>]*|#([\w-]*))$/, C = /^<(\w+)\s*\/?>(?:<\/\1>|)$/, k = /^[\],:{}\s]*$/, E = /(?:^|:|,)(?:\s*\[)+/g, S = /\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g, A = /"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g, j = /^-ms-/, D = /-([\da-z])/gi, L = function(e, t) {
        return t.toUpperCase()
    }, H = function(e) {
        (o.addEventListener || "load" === e.type || "complete" === o.readyState) && (q(), b.ready())
    }, q = function() {
        o.addEventListener ? (o.removeEventListener("DOMContentLoaded", H, !1), e.removeEventListener("load", H, !1)) : (o.detachEvent("onreadystatechange", H), e.detachEvent("onload", H))
    };
    b.fn = b.prototype = {
        jquery: p,
        constructor: b,
        init: function(e, n, r) {
            var
                i, a;
            if (!e) return this;
            if ("string" == typeof e) {
                if (i = "<" === e.charAt(0) && ">" === e.charAt(e.length - 1) && e.length >= 3 ? [null, e, null] : N.exec(e), !i || !i[1] && n) return !n || n.jquery ? (n || r).find(e) : this.constructor(n).find(e);
                if (i[1]) {
                    if (n = n instanceof b ? n[0] : n, b.merge(this, b.parseHTML(i[1], n && n.nodeType ? n.ownerDocument || n : o, !0)), C.test(i[1]) && b.isPlainObject(n))
                        for (i in
                            n) b.isFunction(this[i]) ? this[i](n[i]) : this.attr(i, n[i]);
                    return this
                }
                if (a = o.getElementById(i[2]), a && a.parentNode) {
                    if (a.id !== i[2]) return r.find(e);
                    this.length = 1, this[0] = a
                }
                return this.context = o, this.selector = e, this
            }
            return e.nodeType ? (this.context = this[0] = e, this.length = 1, this) : b.isFunction(e) ? r.ready(e) : (e.selector !== t && (this.selector = e.selector, this.context = e.context), b.makeArray(e, this))
        },
        selector: "",
        length: 0,
        size: function() {
            return this.length
        },
        toArray: function() {
            return h.call(this)
        },
        get: function(e) {
            return null == e ? this.toArray() : 0 > e ? this[this.length + e] : this[e]
        },
        pushStack: function(e) {
            var
                t = b.merge(this.constructor(), e);
            return t.prevObject = this, t.context = this.context, t
        },
        each: function(e, t) {
            return b.each(this, e, t)
        },
        ready: function(e) {
            return b.ready.promise().done(e), this
        },
        slice: function() {
            return this.pushStack(h.apply(this, arguments))
        },
        first: function() {
            return this.eq(0)
        },
        last: function() {
            return this.eq(-1)
        },
        eq: function(e) {
            var
                t = this.length,
                n = +e + (0 > e ? t : 0);
            return this.pushStack(n >= 0 && t > n ? [this[n]] : [])
        },
        map: function(e) {
            return this.pushStack(b.map(this, function(t, n) {
                return e.call(t, n, t)
            }))
        },
        end: function() {
            return this.prevObject || this.constructor(null)
        },
        push: d,
        sort: [].sort,
        splice: [].splice
    }, b.fn.init.prototype = b.fn, b.extend = b.fn.extend = function() {
        var
            e, n, r, i, o, a, s = arguments[0] || {},
            u = 1,
            l = arguments.length,
            c = !1;
        for ("boolean" == typeof s && (c = s, s = arguments[1] || {}, u = 2), "object" == typeof s || b.isFunction(s) || (s = {}), l === u && (s = this, --u); l > u; u++)
            if (null != (o = arguments[u]))
                for (i in
                    o) e = s[i], r = o[i], s !== r && (c && r && (b.isPlainObject(r) || (n = b.isArray(r))) ? (n ? (n = !1, a = e && b.isArray(e) ? e : []) : a = e && b.isPlainObject(e) ? e : {}, s[i] = b.extend(c, a, r)) : r !== t && (s[i] = r));
        return s
    }, b.extend({
        noConflict: function(t) {
            return e.$ === b && (e.$ = u), t && e.jQuery === b && (e.jQuery = s), b
        },
        isReady: !1,
        readyWait: 1,
        holdReady: function(e) {
            e ? b.readyWait++ : b.ready(!0)
        },
        ready: function(e) {
            if (e === !0 ? !--b.readyWait : !b.isReady) {
                if (!o.body) return setTimeout(b.ready);
                b.isReady = !0, e !== !0 && --b.readyWait > 0 || (n.resolveWith(o, [b]), b.fn.trigger && b(o).trigger("ready").off("ready"))
            }
        },
        isFunction: function(e) {
            return "function" === b.type(e)
        },
        isArray: Array.isArray || function(e) {
            return "array" === b.type(e)
        },
        isWindow: function(e) {
            return null != e && e == e.window
        },
        isNumeric: function(e) {
            return !isNaN(parseFloat(e)) && isFinite(e)
        },
        type: function(e) {
            return null == e ? e + "" : "object" == typeof
            e || "function" == typeof
            e ? l[m.call(e)] || "object" : typeof
            e
        },
        isPlainObject: function(e) {
            if (!e || "object" !== b.type(e) || e.nodeType || b.isWindow(e)) return !1;
            try {
                if (e.constructor && !y.call(e, "constructor") && !y.call(e.constructor.prototype, "isPrototypeOf")) return !1
            } catch (n) {
                return !1
            }
            var
                r;
            for (r in
                e);
            return r === t || y.call(e, r)
        },
        isEmptyObject: function(e) {
            var
                t;
            for (t in
                e) return !1;
            return !0
        },
        error: function(e) {
            throw Error(e)
        },
        parseHTML: function(e, t, n) {
            if (!e || "string" != typeof e) return null;
            "boolean" == typeof
            t && (n = t, t = !1), t = t || o;
            var
                r = C.exec(e),
                i = !n && [];
            return r ? [t.createElement(r[1])] : (r = b.buildFragment([e], t, i), i && b(i).remove(), b.merge([], r.childNodes))
        },
        parseJSON: function(n) {
            return e.JSON && e.JSON.parse ? e.JSON.parse(n) : null === n ? n : "string" == typeof
            n && (n = b.trim(n), n && k.test(n.replace(S, "@").replace(A, "]").replace(E, ""))) ? Function("return " + n)() : (b.error("Invalid JSON: " + n), t)
        },
        parseXML: function(n) {
            var
                r, i;
            if (!n || "string" != typeof n) return null;
            try {
                e.DOMParser ? (i = new DOMParser, r = i.parseFromString(n, "text/xml")) : (r = new ActiveXObject("Microsoft.XMLDOM"), r.async = "false", r.loadXML(n))
            } catch (o) {
                r = t
            }
            return r && r.documentElement && !r.getElementsByTagName("parsererror").length || b.error("Invalid XML: " + n), r
        },
        noop: function() {},
        globalEval: function(t) {
            t && b.trim(t) && (e.execScript || function(t) {
                e.eval.call(e, t)
            })(t)
        },
        camelCase: function(e) {
            return e.replace(j, "ms-").replace(D, L)
        },
        nodeName: function(e, t) {
            return e.nodeName && e.nodeName.toLowerCase() === t.toLowerCase()
        },
        each: function(e, t, n) {
            var
                r, i = 0,
                o = e.length,
                a = M(e);
            if (n) {
                if (a) {
                    for (; o > i; i++)
                        if (r = t.apply(e[i], n), r === !1) break
                } else
                    for (i in
                        e)
                        if (r = t.apply(e[i], n), r === !1) break
            } else
            if (a) {
                for (; o > i; i++)
                    if (r = t.call(e[i], i, e[i]), r === !1) break
            } else
                for (i in
                    e)
                    if (r = t.call(e[i], i, e[i]), r === !1) break; return e
        },
        trim: v && !v.call("\ufeff\u00a0") ? function(e) {
            return null == e ? "" : v.call(e)
        } : function(e) {
            return null == e ? "" : (e + "").replace(T, "")
        },
        makeArray: function(e, t) {
            var
                n = t || [];
            return null != e && (M(Object(e)) ? b.merge(n, "string" == typeof e ? [e] : e) : d.call(n, e)), n
        },
        inArray: function(e, t, n) {
            var
                r;
            if (t) {
                if (g) return g.call(t, e, n);
                for (r = t.length, n = n ? 0 > n ? Math.max(0, r + n) : n : 0; r > n; n++)
                    if (n in
                        t && t[n] === e) return n
            }
            return -1
        },
        merge: function(e, n) {
            var
                r = n.length,
                i = e.length,
                o = 0;
            if ("number" == typeof r)
                for (; r > o; o++) e[i++] = n[o];
            else
                while (n[o] !== t) e[i++] = n[o++];
            return e.length = i, e
        },
        grep: function(e, t, n) {
            var
                r, i = [],
                o = 0,
                a = e.length;
            for (n = !!n; a > o; o++) r = !!t(e[o], o), n !== r && i.push(e[o]);
            return i
        },
        map: function(e, t, n) {
            var
                r, i = 0,
                o = e.length,
                a = M(e),
                s = [];
            if (a)
                for (; o > i; i++) r = t(e[i], i, n), null != r && (s[s.length] = r);
            else
                for (i in
                    e) r = t(e[i], i, n), null != r && (s[s.length] = r);
            return f.apply([], s)
        },
        guid: 1,
        proxy: function(e, n) {
            var
                r, i, o;
            return "string" == typeof
            n && (o = e[n], n = e, e = o), b.isFunction(e) ? (r = h.call(arguments, 2), i = function() {
                return e.apply(n || this, r.concat(h.call(arguments)))
            }, i.guid = e.guid = e.guid || b.guid++, i) : t
        },
        access: function(e, n, r, i, o, a, s) {
            var
                u = 0,
                l = e.length,
                c = null == r;
            if ("object" === b.type(r)) {
                o = !0;
                for (u in
                    r) b.access(e, n, u, r[u], !0, a, s)
            } else
            if (i !== t && (o = !0, b.isFunction(i) || (s = !0), c && (s ? (n.call(e, i), n = null) : (c = n, n = function(e, t, n) {
                    return c.call(b(e), n)
                })), n))
                for (; l > u; u++) n(e[u], r, s ? i : i.call(e[u], u, n(e[u], r)));
            return o ? e : c ? n.call(e) : l ? n(e[0], r) : a
        },
        now: function() {
            return (new Date).getTime()
        }
    }), b.ready.promise = function(t) {
        if (!n)
            if (n = b.Deferred(), "complete" === o.readyState) setTimeout(b.ready);
            else
        if (o.addEventListener) o.addEventListener("DOMContentLoaded", H, !1), e.addEventListener("load", H, !1);
        else {
            o.attachEvent("onreadystatechange", H), e.attachEvent("onload", H);
            var
                r = !1;
            try {
                r = null == e.frameElement && o.documentElement
            } catch (i) {}
            r && r.doScroll && function
            a() {
                if (!b.isReady) {
                    try {
                        r.doScroll("left")
                    } catch (e) {
                        return setTimeout(a, 50)
                    }
                    q(), b.ready()
                }
            }()
        }
        return n.promise(t)
    }, b.each("Boolean Number String Function Array Date RegExp Object Error".split(" "), function(e, t) {
        l["[object " + t + "]"] = t.toLowerCase()
    });

    function
    M(e) {
        var
            t = e.length,
            n = b.type(e);
        return b.isWindow(e) ? !1 : 1 === e.nodeType && t ? !0 : "array" === n || "function" !== n && (0 === t || "number" == typeof t && t > 0 && t - 1 in
            e)
    }
    r = b(o);
    var
        _ = {};

    function
    F(e) {
        var
            t = _[e] = {};
        return b.each(e.match(w) || [], function(e, n) {
            t[n] = !0
        }), t
    }
    b.Callbacks = function(e) {
        e = "string" == typeof
        e ? _[e] || F(e) : b.extend({}, e);
        var
            n, r, i, o, a, s, u = [],
            l = !e.once && [],
            c = function(t) {
                for (r = e.memory && t, i = !0, a = s || 0, s = 0, o = u.length, n = !0; u && o > a; a++)
                    if (u[a].apply(t[0], t[1]) === !1 && e.stopOnFalse) {
                        r = !1;
                        break
                    }
                n = !1, u && (l ? l.length && c(l.shift()) : r ? u = [] : p.disable())
            },
            p = {
                add: function() {
                    if (u) {
                        var
                            t = u.length;
                        (function i(t) {
                            b.each(t, function(t, n) {
                                var
                                    r = b.type(n);
                                "function" === r ? e.unique && p.has(n) || u.push(n) : n && n.length && "string" !== r && i(n)
                            })
                        })(arguments), n ? o = u.length : r && (s = t, c(r))
                    }
                    return this
                },
                remove: function() {
                    return u && b.each(arguments, function(e, t) {
                        var
                            r;
                        while ((r = b.inArray(t, u, r)) > -1) u.splice(r, 1), n && (o >= r && o--, a >= r && a--)
                    }), this
                },
                has: function(e) {
                    return e ? b.inArray(e, u) > -1 : !(!u || !u.length)
                },
                empty: function() {
                    return u = [], this
                },
                disable: function() {
                    return u = l = r = t, this
                },
                disabled: function() {
                    return !u
                },
                lock: function() {
                    return l = t, r || p.disable(), this
                },
                locked: function() {
                    return !l
                },
                fireWith: function(e, t) {
                    return t = t || [], t = [e, t.slice ? t.slice() : t], !u || i && !l || (n ? l.push(t) : c(t)), this
                },
                fire: function() {
                    return p.fireWith(this, arguments), this
                },
                fired: function() {
                    return !!i
                }
            };
        return p
    }, b.extend({
        Deferred: function(e) {
            var
                t = [
                    ["resolve", "done", b.Callbacks("once memory"), "resolved"],
                    ["reject", "fail", b.Callbacks("once memory"), "rejected"],
                    ["notify", "progress", b.Callbacks("memory")]
                ],
                n = "pending",
                r = {
                    state: function() {
                        return n
                    },
                    always: function() {
                        return i.done(arguments).fail(arguments), this
                    },
                    then: function() {
                        var
                            e = arguments;
                        return b.Deferred(function(n) {
                            b.each(t, function(t, o) {
                                var
                                    a = o[0],
                                    s = b.isFunction(e[t]) && e[t];
                                i[o[1]](function() {
                                    var
                                        e = s && s.apply(this, arguments);
                                    e && b.isFunction(e.promise) ? e.promise().done(n.resolve).fail(n.reject).progress(n.notify) : n[a + "With"](this === r ? n.promise() : this, s ? [e] : arguments)
                                })
                            }), e = null
                        }).promise()
                    },
                    promise: function(e) {
                        return null != e ? b.extend(e, r) : r
                    }
                },
                i = {};
            return r.pipe = r.then, b.each(t, function(e, o) {
                var
                    a = o[2],
                    s = o[3];
                r[o[1]] = a.add, s && a.add(function() {
                    n = s
                }, t[1 ^ e][2].disable, t[2][2].lock), i[o[0]] = function() {
                    return i[o[0] + "With"](this === i ? r : this, arguments), this
                }, i[o[0] + "With"] = a.fireWith
            }), r.promise(i), e && e.call(i, i), i
        },
        when: function(e) {
            var
                t = 0,
                n = h.call(arguments),
                r = n.length,
                i = 1 !== r || e && b.isFunction(e.promise) ? r : 0,
                o = 1 === i ? e : b.Deferred(),
                a = function(e, t, n) {
                    return function(r) {
                        t[e] = this, n[e] = arguments.length > 1 ? h.call(arguments) : r, n === s ? o.notifyWith(t, n) : --i || o.resolveWith(t, n)
                    }
                },
                s, u, l;
            if (r > 1)
                for (s = Array(r), u = Array(r), l = Array(r); r > t; t++) n[t] && b.isFunction(n[t].promise) ? n[t].promise().done(a(t, l, n)).fail(o.reject).progress(a(t, u, s)) : --i;
            return i || o.resolveWith(l, n), o.promise()
        }
    }), b.support = function() {
        var
            t, n, r, a, s, u, l, c, p, f, d = o.createElement("div");
        if (d.setAttribute("className", "t"), d.innerHTML = "  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>", n = d.getElementsByTagName("*"), r = d.getElementsByTagName("a")[0], !n || !r || !n.length) return {};
        s = o.createElement("select"), l = s.appendChild(o.createElement("option")), a = d.getElementsByTagName("input")[0], r.style.cssText = "top:1px;float:left;opacity:.5", t = {
            getSetAttribute: "t" !== d.className,
            leadingWhitespace: 3 === d.firstChild.nodeType,
            tbody: !d.getElementsByTagName("tbody").length,
            htmlSerialize: !!d.getElementsByTagName("link").length,
            style: /top/.test(r.getAttribute("style")),
            hrefNormalized: "/a" === r.getAttribute("href"),
            opacity: /^0.5/.test(r.style.opacity),
            cssFloat: !!r.style.cssFloat,
            checkOn: !!a.value,
            optSelected: l.selected,
            enctype: !!o.createElement("form").enctype,
            html5Clone: "<:nav></:nav>" !== o.createElement("nav").cloneNode(!0).outerHTML,
            boxModel: "CSS1Compat" === o.compatMode,
            deleteExpando: !0,
            noCloneEvent: !0,
            inlineBlockNeedsLayout: !1,
            shrinkWrapBlocks: !1,
            reliableMarginRight: !0,
            boxSizingReliable: !0,
            pixelPosition: !1
        }, a.checked = !0, t.noCloneChecked = a.cloneNode(!0).checked, s.disabled = !0, t.optDisabled = !l.disabled;
        try {
            delete
            d.test
        } catch (h) {
            t.deleteExpando = !1
        }
        a = o.createElement("input"), a.setAttribute("value", ""), t.input = "" === a.getAttribute("value"), a.value = "t", a.setAttribute("type", "radio"), t.radioValue = "t" === a.value, a.setAttribute("checked", "t"), a.setAttribute("name", "t"), u = o.createDocumentFragment(), u.appendChild(a), t.appendChecked = a.checked, t.checkClone = u.cloneNode(!0).cloneNode(!0).lastChild.checked, d.attachEvent && (d.attachEvent("onclick", function() {
            t.noCloneEvent = !1
        }), d.cloneNode(!0).click());
        for (f in {
                submit: !0,
                change: !0,
                focusin: !0
            }) d.setAttribute(c = "on" + f, "t"), t[f + "Bubbles"] = c in
            e || d.attributes[c].expando === !1;
        return d.style.backgroundClip = "content-box", d.cloneNode(!0).style.backgroundClip = "", t.clearCloneStyle = "content-box" === d.style.backgroundClip, b(function() {
            var
                n, r, a, s = "padding:0;margin:0;border:0;display:block;box-sizing:content-box;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;",
                u = o.getElementsByTagName("body")[0];
            u && (n = o.createElement("div"), n.style.cssText = "border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px", u.appendChild(n).appendChild(d), d.innerHTML = "<table><tr><td></td><td>t</td></tr></table>", a = d.getElementsByTagName("td"), a[0].style.cssText = "padding:0;margin:0;border:0;display:none", p = 0 === a[0].offsetHeight, a[0].style.display = "", a[1].style.display = "none", t.reliableHiddenOffsets = p && 0 === a[0].offsetHeight, d.innerHTML = "", d.style.cssText = "box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;", t.boxSizing = 4 === d.offsetWidth, t.doesNotIncludeMarginInBodyOffset = 1 !== u.offsetTop, e.getComputedStyle && (t.pixelPosition = "1%" !== (e.getComputedStyle(d, null) || {}).top, t.boxSizingReliable = "4px" === (e.getComputedStyle(d, null) || {
                width: "4px"
            }).width, r = d.appendChild(o.createElement("div")), r.style.cssText = d.style.cssText = s, r.style.marginRight = r.style.width = "0", d.style.width = "1px", t.reliableMarginRight = !parseFloat((e.getComputedStyle(r, null) || {}).marginRight)), typeof d.style.zoom !== i && (d.innerHTML = "", d.style.cssText = s + "width:1px;padding:1px;display:inline;zoom:1", t.inlineBlockNeedsLayout = 3 === d.offsetWidth, d.style.display = "block", d.innerHTML = "<div></div>", d.firstChild.style.width = "5px", t.shrinkWrapBlocks = 3 !== d.offsetWidth, t.inlineBlockNeedsLayout && (u.style.zoom = 1)), u.removeChild(n), n = d = a = r = null)
        }), n = s = u = l = r = a = null, t
    }();
    var
        O = /(?:\{[\s\S]*\}|\[[\s\S]*\])$/,
        B = /([A-Z])/g;

    function
    P(e, n, r, i) {
        if (b.acceptData(e)) {
            var
                o, a, s = b.expando,
                u = "string" == typeof
            n, l = e.nodeType, p = l ? b.cache : e, f = l ? e[s] : e[s] && s;
            if (f && p[f] && (i || p[f].data) || !u || r !== t) return f || (l ? e[s] = f = c.pop() || b.guid++ : f = s), p[f] || (p[f] = {}, l || (p[f].toJSON = b.noop)), ("object" == typeof n || "function" == typeof n) && (i ? p[f] = b.extend(p[f], n) : p[f].data = b.extend(p[f].data, n)), o = p[f], i || (o.data || (o.data = {}), o = o.data), r !== t && (o[b.camelCase(n)] = r), u ? (a = o[n], null == a && (a = o[b.camelCase(n)])) : a = o, a
        }
    }

    function
    R(e, t, n) {
        if (b.acceptData(e)) {
            var
                r, i, o, a = e.nodeType,
                s = a ? b.cache : e,
                u = a ? e[b.expando] : b.expando;
            if (s[u]) {
                if (t && (o = n ? s[u] : s[u].data)) {
                    b.isArray(t) ? t = t.concat(b.map(t, b.camelCase)) : t in
                        o ? t = [t] : (t = b.camelCase(t), t = t in
                            o ? [t] : t.split(" "));
                    for (r = 0, i = t.length; i > r; r++) delete
                    o[t[r]];
                    if (!(n ? $ : b.isEmptyObject)(o)) return
                }(n || (delete s[u].data, $(s[u]))) && (a ? b.cleanData([e], !0) : b.support.deleteExpando || s != s.window ? delete s[u] : s[u] = null)
            }
        }
    }
    b.extend({
        cache: {},
        expando: "jQuery" + (p + Math.random()).replace(/\D/g, ""),
        noData: {
            embed: !0,
            object: "clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",
            applet: !0
        },
        hasData: function(e) {
            return e = e.nodeType ? b.cache[e[b.expando]] : e[b.expando], !!e && !$(e)
        },
        data: function(e, t, n) {
            return P(e, t, n)
        },
        removeData: function(e, t) {
            return R(e, t)
        },
        _data: function(e, t, n) {
            return P(e, t, n, !0)
        },
        _removeData: function(e, t) {
            return R(e, t, !0)
        },
        acceptData: function(e) {
            if (e.nodeType && 1 !== e.nodeType && 9 !== e.nodeType) return !1;
            var
                t = e.nodeName && b.noData[e.nodeName.toLowerCase()];
            return !t || t !== !0 && e.getAttribute("classid") === t
        }
    }), b.fn.extend({
        data: function(e, n) {
            var
                r, i, o = this[0],
                a = 0,
                s = null;
            if (e === t) {
                if (this.length && (s = b.data(o), 1 === o.nodeType && !b._data(o, "parsedAttrs"))) {
                    for (r = o.attributes; r.length > a; a++) i = r[a].name, i.indexOf("data-") || (i = b.camelCase(i.slice(5)), W(o, i, s[i]));
                    b._data(o, "parsedAttrs", !0)
                }
                return s
            }
            return "object" == typeof
            e ? this.each(function() {
                b.data(this, e)
            }) : b.access(this, function(n) {
                return n === t ? o ? W(o, e, b.data(o, e)) : null : (this.each(function() {
                    b.data(this, e, n)
                }), t)
            }, null, n, arguments.length > 1, null, !0)
        },
        removeData: function(e) {
            return this.each(function() {
                b.removeData(this, e)
            })
        }
    });

    function
    W(e, n, r) {
        if (r === t && 1 === e.nodeType) {
            var
                i = "data-" + n.replace(B, "-$1").toLowerCase();
            if (r = e.getAttribute(i), "string" == typeof r) {
                try {
                    r = "true" === r ? !0 : "false" === r ? !1 : "null" === r ? null : +r + "" === r ? +r : O.test(r) ? b.parseJSON(r) : r
                } catch (o) {}
                b.data(e, n, r)
            } else
                r = t
        }
        return r
    }

    function
    $(e) {
        var
            t;
        for (t in
            e)
            if (("data" !== t || !b.isEmptyObject(e[t])) && "toJSON" !== t) return !1;
        return !0
    }
    b.extend({
        queue: function(e, n, r) {
            var
                i;
            return e ? (n = (n || "fx") + "queue", i = b._data(e, n), r && (!i || b.isArray(r) ? i = b._data(e, n, b.makeArray(r)) : i.push(r)), i || []) : t
        },
        dequeue: function(e, t) {
            t = t || "fx";
            var
                n = b.queue(e, t),
                r = n.length,
                i = n.shift(),
                o = b._queueHooks(e, t),
                a = function() {
                    b.dequeue(e, t)
                };
            "inprogress" === i && (i = n.shift(), r--), o.cur = i, i && ("fx" === t && n.unshift("inprogress"), delete o.stop, i.call(e, a, o)), !r && o && o.empty.fire()
        },
        _queueHooks: function(e, t) {
            var
                n = t + "queueHooks";
            return b._data(e, n) || b._data(e, n, {
                empty: b.Callbacks("once memory").add(function() {
                    b._removeData(e, t + "queue"), b._removeData(e, n)
                })
            })
        }
    }), b.fn.extend({
        queue: function(e, n) {
            var
                r = 2;
            return "string" != typeof
            e && (n = e, e = "fx", r--), r > arguments.length ? b.queue(this[0], e) : n === t ? this : this.each(function() {
                var
                    t = b.queue(this, e, n);
                b._queueHooks(this, e), "fx" === e && "inprogress" !== t[0] && b.dequeue(this, e)
            })
        },
        dequeue: function(e) {
            return this.each(function() {
                b.dequeue(this, e)
            })
        },
        delay: function(e, t) {
            return e = b.fx ? b.fx.speeds[e] || e : e, t = t || "fx", this.queue(t, function(t, n) {
                var
                    r = setTimeout(t, e);
                n.stop = function() {
                    clearTimeout(r)
                }
            })
        },
        clearQueue: function(e) {
            return this.queue(e || "fx", [])
        },
        promise: function(e, n) {
            var
                r, i = 1,
                o = b.Deferred(),
                a = this,
                s = this.length,
                u = function() {
                    --i || o.resolveWith(a, [a])
                };
            "string" != typeof
            e && (n = e, e = t), e = e || "fx";
            while (s--) r = b._data(a[s], e + "queueHooks"), r && r.empty && (i++, r.empty.add(u));
            return u(), o.promise(n)
        }
    });
    var
        I, z, X = /[\t\r\n]/g,
        U = /\r/g,
        V = /^(?:input|select|textarea|button|object)$/i,
        Y = /^(?:a|area)$/i,
        J = /^(?:checked|selected|autofocus|autoplay|async|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped)$/i,
        G = /^(?:checked|selected)$/i,
        Q = b.support.getSetAttribute,
        K = b.support.input;
    b.fn.extend({
        attr: function(e, t) {
            return b.access(this, b.attr, e, t, arguments.length > 1)
        },
        removeAttr: function(e) {
            return this.each(function() {
                b.removeAttr(this, e)
            })
        },
        prop: function(e, t) {
            return b.access(this, b.prop, e, t, arguments.length > 1)
        },
        removeProp: function(e) {
            return e = b.propFix[e] || e, this.each(function() {
                try {
                    this[e] = t, delete
                    this[e]
                } catch (n) {}
            })
        },
        addClass: function(e) {
            var
                t, n, r, i, o, a = 0,
                s = this.length,
                u = "string" == typeof
            e && e;
            if (b.isFunction(e)) return this.each(function(t) {
                b(this).addClass(e.call(this, t, this.className))
            });
            if (u)
                for (t = (e || "").match(w) || []; s > a; a++)
                    if (n = this[a], r = 1 === n.nodeType && (n.className ? (" " + n.className + " ").replace(X, " ") : " ")) {
                        o = 0;
                        while (i = t[o++]) 0 > r.indexOf(" " + i + " ") && (r += i + " ");
                        n.className = b.trim(r)
                    }
            return this
        },
        removeClass: function(e) {
            var
                t, n, r, i, o, a = 0,
                s = this.length,
                u = 0 === arguments.length || "string" == typeof
            e && e;
            if (b.isFunction(e)) return this.each(function(t) {
                b(this).removeClass(e.call(this, t, this.className))
            });
            if (u)
                for (t = (e || "").match(w) || []; s > a; a++)
                    if (n = this[a], r = 1 === n.nodeType && (n.className ? (" " + n.className + " ").replace(X, " ") : "")) {
                        o = 0;
                        while (i = t[o++])
                            while (r.indexOf(" " + i + " ") >= 0) r = r.replace(" " + i + " ", " ");
                        n.className = e ? b.trim(r) : ""
                    }
            return this
        },
        toggleClass: function(e, t) {
            var
                n = typeof
            e, r = "boolean" == typeof
            t;
            return b.isFunction(e) ? this.each(function(n) {
                b(this).toggleClass(e.call(this, n, this.className, t), t)
            }) : this.each(function() {
                if ("string" === n) {
                    var
                        o, a = 0,
                        s = b(this),
                        u = t,
                        l = e.match(w) || [];
                    while (o = l[a++]) u = r ? u : !s.hasClass(o), s[u ? "addClass" : "removeClass"](o)
                } else(n === i || "boolean" === n) && (this.className && b._data(this, "__className__", this.className), this.className = this.className || e === !1 ? "" : b._data(this, "__className__") || "")
            })
        },
        hasClass: function(e) {
            var
                t = " " + e + " ",
                n = 0,
                r = this.length;
            for (; r > n; n++)
                if (1 === this[n].nodeType && (" " + this[n].className + " ").replace(X, " ").indexOf(t) >= 0) return !0;
            return !1
        },
        val: function(e) {
            var
                n, r, i, o = this[0]; {
                if (arguments.length) return i = b.isFunction(e), this.each(function(n) {
                    var
                        o, a = b(this);
                    1 === this.nodeType && (o = i ? e.call(this, n, a.val()) : e, null == o ? o = "" : "number" == typeof o ? o += "" : b.isArray(o) && (o = b.map(o, function(e) {
                            return null == e ? "" : e + ""
                        })), r = b.valHooks[this.type] || b.valHooks[this.nodeName.toLowerCase()], r && "set" in
                        r && r.set(this, o, "value") !== t || (this.value = o))
                });
                if (o) return r = b.valHooks[o.type] || b.valHooks[o.nodeName.toLowerCase()], r && "get" in
                    r && (n = r.get(o, "value")) !== t ? n : (n = o.value, "string" == typeof n ? n.replace(U, "") : null == n ? "" : n)
            }
        }
    }), b.extend({
        valHooks: {
            option: {
                get: function(e) {
                    var
                        t = e.attributes.value;
                    return !t || t.specified ? e.value : e.text
                }
            },
            select: {
                get: function(e) {
                    var
                        t, n, r = e.options,
                        i = e.selectedIndex,
                        o = "select-one" === e.type || 0 > i,
                        a = o ? null : [],
                        s = o ? i + 1 : r.length,
                        u = 0 > i ? s : o ? i : 0;
                    for (; s > u; u++)
                        if (n = r[u], !(!n.selected && u !== i || (b.support.optDisabled ? n.disabled : null !== n.getAttribute("disabled")) || n.parentNode.disabled && b.nodeName(n.parentNode, "optgroup"))) {
                            if (t = b(n).val(), o) return t;
                            a.push(t)
                        }
                    return a
                },
                set: function(e, t) {
                    var
                        n = b.makeArray(t);
                    return b(e).find("option").each(function() {
                        this.selected = b.inArray(b(this).val(), n) >= 0
                    }), n.length || (e.selectedIndex = -1), n
                }
            }
        },
        attr: function(e, n, r) {
            var
                o, a, s, u = e.nodeType;
            if (e && 3 !== u && 8 !== u && 2 !== u) return typeof
            e.getAttribute === i ? b.prop(e, n, r) : (a = 1 !== u || !b.isXMLDoc(e), a && (n = n.toLowerCase(), o = b.attrHooks[n] || (J.test(n) ? z : I)), r === t ? o && a && "get" in
                o && null !== (s = o.get(e, n)) ? s : (typeof e.getAttribute !== i && (s = e.getAttribute(n)), null == s ? t : s) : null !== r ? o && a && "set" in
                o && (s = o.set(e, r, n)) !== t ? s : (e.setAttribute(n, r + ""), r) : (b.removeAttr(e, n), t))
        },
        removeAttr: function(e, t) {
            var
                n, r, i = 0,
                o = t && t.match(w);
            if (o && 1 === e.nodeType)
                while (n = o[i++]) r = b.propFix[n] || n, J.test(n) ? !Q && G.test(n) ? e[b.camelCase("default-" + n)] = e[r] = !1 : e[r] = !1 : b.attr(e, n, ""), e.removeAttribute(Q ? n : r)
        },
        attrHooks: {
            type: {
                set: function(e, t) {
                    if (!b.support.radioValue && "radio" === t && b.nodeName(e, "input")) {
                        var
                            n = e.value;
                        return e.setAttribute("type", t), n && (e.value = n), t
                    }
                }
            }
        },
        propFix: {
            tabindex: "tabIndex",
            readonly: "readOnly",
            "for": "htmlFor",
            "class": "className",
            maxlength: "maxLength",
            cellspacing: "cellSpacing",
            cellpadding: "cellPadding",
            rowspan: "rowSpan",
            colspan: "colSpan",
            usemap: "useMap",
            frameborder: "frameBorder",
            contenteditable: "contentEditable"
        },
        prop: function(e, n, r) {
            var
                i, o, a, s = e.nodeType;
            if (e && 3 !== s && 8 !== s && 2 !== s) return a = 1 !== s || !b.isXMLDoc(e), a && (n = b.propFix[n] || n, o = b.propHooks[n]), r !== t ? o && "set" in
                o && (i = o.set(e, r, n)) !== t ? i : e[n] = r : o && "get" in
                o && null !== (i = o.get(e, n)) ? i : e[n]
        },
        propHooks: {
            tabIndex: {
                get: function(e) {
                    var
                        n = e.getAttributeNode("tabindex");
                    return n && n.specified ? parseInt(n.value, 10) : V.test(e.nodeName) || Y.test(e.nodeName) && e.href ? 0 : t
                }
            }
        }
    }), z = {
        get: function(e, n) {
            var
                r = b.prop(e, n),
                i = "boolean" == typeof
            r && e.getAttribute(n), o = "boolean" == typeof
            r ? K && Q ? null != i : G.test(n) ? e[b.camelCase("default-" + n)] : !!i : e.getAttributeNode(n);
            return o && o.value !== !1 ? n.toLowerCase() : t
        },
        set: function(e, t, n) {
            return t === !1 ? b.removeAttr(e, n) : K && Q || !G.test(n) ? e.setAttribute(!Q && b.propFix[n] || n, n) : e[b.camelCase("default-" + n)] = e[n] = !0, n
        }
    }, K && Q || (b.attrHooks.value = {
        get: function(e, n) {
            var
                r = e.getAttributeNode(n);
            return b.nodeName(e, "input") ? e.defaultValue : r && r.specified ? r.value : t
        },
        set: function(e, n, r) {
            return b.nodeName(e, "input") ? (e.defaultValue = n, t) : I && I.set(e, n, r)
        }
    }), Q || (I = b.valHooks.button = {
        get: function(e, n) {
            var
                r = e.getAttributeNode(n);
            return r && ("id" === n || "name" === n || "coords" === n ? "" !== r.value : r.specified) ? r.value : t
        },
        set: function(e, n, r) {
            var
                i = e.getAttributeNode(r);
            return i || e.setAttributeNode(i = e.ownerDocument.createAttribute(r)), i.value = n += "", "value" === r || n === e.getAttribute(r) ? n : t
        }
    }, b.attrHooks.contenteditable = {
        get: I.get,
        set: function(e, t, n) {
            I.set(e, "" === t ? !1 : t, n)
        }
    }, b.each(["width", "height"], function(e, n) {
        b.attrHooks[n] = b.extend(b.attrHooks[n], {
            set: function(e, r) {
                return "" === r ? (e.setAttribute(n, "auto"), r) : t
            }
        })
    })), b.support.hrefNormalized || (b.each(["href", "src", "width", "height"], function(e, n) {
        b.attrHooks[n] = b.extend(b.attrHooks[n], {
            get: function(e) {
                var
                    r = e.getAttribute(n, 2);
                return null == r ? t : r
            }
        })
    }), b.each(["href", "src"], function(e, t) {
        b.propHooks[t] = {
            get: function(e) {
                return e.getAttribute(t, 4)
            }
        }
    })), b.support.style || (b.attrHooks.style = {
        get: function(e) {
            return e.style.cssText || t
        },
        set: function(e, t) {
            return e.style.cssText = t + ""
        }
    }), b.support.optSelected || (b.propHooks.selected = b.extend(b.propHooks.selected, {
        get: function(e) {
            var
                t = e.parentNode;
            return t && (t.selectedIndex, t.parentNode && t.parentNode.selectedIndex), null
        }
    })), b.support.enctype || (b.propFix.enctype = "encoding"), b.support.checkOn || b.each(["radio", "checkbox"], function() {
        b.valHooks[this] = {
            get: function(e) {
                return null === e.getAttribute("value") ? "on" : e.value
            }
        }
    }), b.each(["radio", "checkbox"], function() {
        b.valHooks[this] = b.extend(b.valHooks[this], {
            set: function(e, n) {
                return b.isArray(n) ? e.checked = b.inArray(b(e).val(), n) >= 0 : t
            }
        })
    });
    var
        Z = /^(?:input|select|textarea)$/i,
        et = /^key/,
        tt = /^(?:mouse|contextmenu)|click/,
        nt = /^(?:focusinfocus|focusoutblur)$/,
        rt = /^([^.]*)(?:\.(.+)|)$/;

    function
    it() {
        return !0
    }

    function
    ot() {
        return !1
    }
    b.event = {
            global: {},
            add: function(e, n, r, o, a) {
                var
                    s, u, l, c, p, f, d, h, g, m, y, v = b._data(e);
                if (v) {
                    r.handler && (c = r, r = c.handler, a = c.selector), r.guid || (r.guid = b.guid++), (u = v.events) || (u = v.events = {}), (f = v.handle) || (f = v.handle = function(e) {
                        return typeof
                        b === i || e && b.event.triggered === e.type ? t : b.event.dispatch.apply(f.elem, arguments)
                    }, f.elem = e), n = (n || "").match(w) || [""], l = n.length;
                    while (l--) s = rt.exec(n[l]) || [], g = y = s[1], m = (s[2] || "").split(".").sort(), p = b.event.special[g] || {}, g = (a ? p.delegateType : p.bindType) || g, p = b.event.special[g] || {}, d = b.extend({
                        type: g,
                        origType: y,
                        data: o,
                        handler: r,
                        guid: r.guid,
                        selector: a,
                        needsContext: a && b.expr.match.needsContext.test(a),
                        namespace: m.join(".")
                    }, c), (h = u[g]) || (h = u[g] = [], h.delegateCount = 0, p.setup && p.setup.call(e, o, m, f) !== !1 || (e.addEventListener ? e.addEventListener(g, f, !1) : e.attachEvent && e.attachEvent("on" + g, f))), p.add && (p.add.call(e, d), d.handler.guid || (d.handler.guid = r.guid)), a ? h.splice(h.delegateCount++, 0, d) : h.push(d), b.event.global[g] = !0;
                    e = null
                }
            },
            remove: function(e, t, n, r, i) {
                var
                    o, a, s, u, l, c, p, f, d, h, g, m = b.hasData(e) && b._data(e);
                if (m && (c = m.events)) {
                    t = (t || "").match(w) || [""], l = t.length;
                    while (l--)
                        if (s = rt.exec(t[l]) || [], d = g = s[1], h = (s[2] || "").split(".").sort(), d) {
                            p = b.event.special[d] || {}, d = (r ? p.delegateType : p.bindType) || d, f = c[d] || [], s = s[2] && RegExp("(^|\\.)" + h.join("\\.(?:.*\\.|)") + "(\\.|$)"), u = o = f.length;
                            while (o--) a = f[o], !i && g !== a.origType || n && n.guid !== a.guid || s && !s.test(a.namespace) || r && r !== a.selector && ("**" !== r || !a.selector) || (f.splice(o, 1), a.selector && f.delegateCount--, p.remove && p.remove.call(e, a));
                            u && !f.length && (p.teardown && p.teardown.call(e, h, m.handle) !== !1 || b.removeEvent(e, d, m.handle), delete c[d])
                        } else
                            for (d in
                                c) b.event.remove(e, d + t[l], n, r, !0);
                    b.isEmptyObject(c) && (delete m.handle, b._removeData(e, "events"))
                }
            },
            trigger: function(n, r, i, a) {
                var
                    s, u, l, c, p, f, d, h = [i || o],
                    g = y.call(n, "type") ? n.type : n,
                    m = y.call(n, "namespace") ? n.namespace.split(".") : [];
                if (l = f = i = i || o, 3 !== i.nodeType && 8 !== i.nodeType && !nt.test(g + b.event.triggered) && (g.indexOf(".") >= 0 && (m = g.split("."), g = m.shift(), m.sort()), u = 0 > g.indexOf(":") && "on" + g, n = n[b.expando] ? n : new b.Event(g, "object" == typeof n && n), n.isTrigger = !0, n.namespace = m.join("."), n.namespace_re = n.namespace ? RegExp("(^|\\.)" + m.join("\\.(?:.*\\.|)") + "(\\.|$)") : null, n.result = t, n.target || (n.target = i), r = null == r ? [n] : b.makeArray(r, [n]), p = b.event.special[g] || {}, a || !p.trigger || p.trigger.apply(i, r) !== !1)) {
                    if (!a && !p.noBubble && !b.isWindow(i)) {
                        for (c = p.delegateType || g, nt.test(c + g) || (l = l.parentNode); l; l = l.parentNode) h.push(l), f = l;
                        f === (i.ownerDocument || o) && h.push(f.defaultView || f.parentWindow || e)
                    }
                    d = 0;
                    while ((l = h[d++]) && !n.isPropagationStopped()) n.type = d > 1 ? c : p.bindType || g, s = (b._data(l, "events") || {})[n.type] && b._data(l, "handle"), s && s.apply(l, r), s = u && l[u], s && b.acceptData(l) && s.apply && s.apply(l, r) === !1 && n.preventDefault();
                    if (n.type = g, !(a || n.isDefaultPrevented() || p._default && p._default.apply(i.ownerDocument, r) !== !1 || "click" === g && b.nodeName(i, "a") || !b.acceptData(i) || !u || !i[g] || b.isWindow(i))) {
                        f = i[u], f && (i[u] = null), b.event.triggered = g;
                        try {
                            i[g]()
                        } catch (v) {}
                        b.event.triggered = t, f && (i[u] = f)
                    }
                    return n.result
                }
            },
            dispatch: function(e) {
                e = b.event.fix(e);
                var
                    n, r, i, o, a, s = [],
                    u = h.call(arguments),
                    l = (b._data(this, "events") || {})[e.type] || [],
                    c = b.event.special[e.type] || {};
                if (u[0] = e, e.delegateTarget = this, !c.preDispatch || c.preDispatch.call(this, e) !== !1) {
                    s = b.event.handlers.call(this, e, l), n = 0;
                    while ((o = s[n++]) && !e.isPropagationStopped()) {
                        e.currentTarget = o.elem, a = 0;
                        while ((i = o.handlers[a++]) && !e.isImmediatePropagationStopped())(!e.namespace_re || e.namespace_re.test(i.namespace)) && (e.handleObj = i, e.data = i.data, r = ((b.event.special[i.origType] || {}).handle || i.handler).apply(o.elem, u), r !== t && (e.result = r) === !1 && (e.preventDefault(), e.stopPropagation()))
                    }
                    return c.postDispatch && c.postDispatch.call(this, e), e.result
                }
            },
            handlers: function(e, n) {
                var
                    r, i, o, a, s = [],
                    u = n.delegateCount,
                    l = e.target;
                if (u && l.nodeType && (!e.button || "click" !== e.type))
                    for (; l != this; l = l.parentNode || this)
                        if (1 === l.nodeType && (l.disabled !== !0 || "click" !== e.type)) {
                            for (o = [], a = 0; u > a; a++) i = n[a], r = i.selector + " ", o[r] === t && (o[r] = i.needsContext ? b(r, this).index(l) >= 0 : b.find(r, this, null, [l]).length), o[r] && o.push(i);
                            o.length && s.push({
                                elem: l,
                                handlers: o
                            })
                        }
                return n.length > u && s.push({
                    elem: this,
                    handlers: n.slice(u)
                }), s
            },
            fix: function(e) {
                if (e[b.expando]) return e;
                var
                    t, n, r, i = e.type,
                    a = e,
                    s = this.fixHooks[i];
                s || (this.fixHooks[i] = s = tt.test(i) ? this.mouseHooks : et.test(i) ? this.keyHooks : {}), r = s.props ? this.props.concat(s.props) : this.props, e = new
                b.Event(a), t = r.length;
                while (t--) n = r[t], e[n] = a[n];
                return e.target || (e.target = a.srcElement || o), 3 === e.target.nodeType && (e.target = e.target.parentNode), e.metaKey = !!e.metaKey, s.filter ? s.filter(e, a) : e
            },
            props: "altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),
            fixHooks: {},
            keyHooks: {
                props: "char charCode key keyCode".split(" "),
                filter: function(e, t) {
                    return null == e.which && (e.which = null != t.charCode ? t.charCode : t.keyCode), e
                }
            },
            mouseHooks: {
                props: "button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),
                filter: function(e, n) {
                    var
                        r, i, a, s = n.button,
                        u = n.fromElement;
                    return null == e.pageX && null != n.clientX && (i = e.target.ownerDocument || o, a = i.documentElement, r = i.body, e.pageX = n.clientX + (a && a.scrollLeft || r && r.scrollLeft || 0) - (a && a.clientLeft || r && r.clientLeft || 0), e.pageY = n.clientY + (a && a.scrollTop || r && r.scrollTop || 0) - (a && a.clientTop || r && r.clientTop || 0)), !e.relatedTarget && u && (e.relatedTarget = u === e.target ? n.toElement : u), e.which || s === t || (e.which = 1 & s ? 1 : 2 & s ? 3 : 4 & s ? 2 : 0), e
                }
            },
            special: {
                load: {
                    noBubble: !0
                },
                click: {
                    trigger: function() {
                        return b.nodeName(this, "input") && "checkbox" === this.type && this.click ? (this.click(), !1) : t
                    }
                },
                focus: {
                    trigger: function() {
                        if (this !== o.activeElement && this.focus) try {
                            return this.focus(), !1
                        } catch (e) {}
                    },
                    delegateType: "focusin"
                },
                blur: {
                    trigger: function() {
                        return this === o.activeElement && this.blur ? (this.blur(), !1) : t
                    },
                    delegateType: "focusout"
                },
                beforeunload: {
                    postDispatch: function(e) {
                        e.result !== t && (e.originalEvent.returnValue = e.result)
                    }
                }
            },
            simulate: function(e, t, n, r) {
                var
                    i = b.extend(new b.Event, n, {
                        type: e,
                        isSimulated: !0,
                        originalEvent: {}
                    });
                r ? b.event.trigger(i, null, t) : b.event.dispatch.call(t, i), i.isDefaultPrevented() && n.preventDefault()
            }
        }, b.removeEvent = o.removeEventListener ? function(e, t, n) {
            e.removeEventListener && e.removeEventListener(t, n, !1)
        } : function(e, t, n) {
            var
                r = "on" + t;
            e.detachEvent && (typeof e[r] === i && (e[r] = null), e.detachEvent(r, n))
        }, b.Event = function(e, n) {
            return this
            instanceof
            b.Event ? (e && e.type ? (this.originalEvent = e, this.type = e.type, this.isDefaultPrevented = e.defaultPrevented || e.returnValue === !1 || e.getPreventDefault && e.getPreventDefault() ? it : ot) : this.type = e, n && b.extend(this, n), this.timeStamp = e && e.timeStamp || b.now(), this[b.expando] = !0, t) : new
            b.Event(e, n)
        }, b.Event.prototype = {
            isDefaultPrevented: ot,
            isPropagationStopped: ot,
            isImmediatePropagationStopped: ot,
            preventDefault: function() {
                var
                    e = this.originalEvent;
                this.isDefaultPrevented = it, e && (e.preventDefault ? e.preventDefault() : e.returnValue = !1)
            },
            stopPropagation: function() {
                var
                    e = this.originalEvent;
                this.isPropagationStopped = it, e && (e.stopPropagation && e.stopPropagation(), e.cancelBubble = !0)
            },
            stopImmediatePropagation: function() {
                this.isImmediatePropagationStopped = it, this.stopPropagation()
            }
        }, b.each({
            mouseenter: "mouseover",
            mouseleave: "mouseout"
        }, function(e, t) {
            b.event.special[e] = {
                delegateType: t,
                bindType: t,
                handle: function(e) {
                    var
                        n, r = this,
                        i = e.relatedTarget,
                        o = e.handleObj;
                    return (!i || i !== r && !b.contains(r, i)) && (e.type = o.origType, n = o.handler.apply(this, arguments), e.type = t), n
                }
            }
        }), b.support.submitBubbles || (b.event.special.submit = {
            setup: function() {
                return b.nodeName(this, "form") ? !1 : (b.event.add(this, "click._submit keypress._submit", function(e) {
                    var
                        n = e.target,
                        r = b.nodeName(n, "input") || b.nodeName(n, "button") ? n.form : t;
                    r && !b._data(r, "submitBubbles") && (b.event.add(r, "submit._submit", function(e) {
                        e._submit_bubble = !0
                    }), b._data(r, "submitBubbles", !0))
                }), t)
            },
            postDispatch: function(e) {
                e._submit_bubble && (delete e._submit_bubble, this.parentNode && !e.isTrigger && b.event.simulate("submit", this.parentNode, e, !0))
            },
            teardown: function() {
                return b.nodeName(this, "form") ? !1 : (b.event.remove(this, "._submit"), t)
            }
        }), b.support.changeBubbles || (b.event.special.change = {
            setup: function() {
                return Z.test(this.nodeName) ? (("checkbox" === this.type || "radio" === this.type) && (b.event.add(this, "propertychange._change", function(e) {
                    "checked" === e.originalEvent.propertyName && (this._just_changed = !0)
                }), b.event.add(this, "click._change", function(e) {
                    this._just_changed && !e.isTrigger && (this._just_changed = !1), b.event.simulate("change", this, e, !0)
                })), !1) : (b.event.add(this, "beforeactivate._change", function(e) {
                    var
                        t = e.target;
                    Z.test(t.nodeName) && !b._data(t, "changeBubbles") && (b.event.add(t, "change._change", function(e) {
                        !this.parentNode || e.isSimulated || e.isTrigger || b.event.simulate("change", this.parentNode, e, !0)
                    }), b._data(t, "changeBubbles", !0))
                }), t)
            },
            handle: function(e) {
                var
                    n = e.target;
                return this !== n || e.isSimulated || e.isTrigger || "radio" !== n.type && "checkbox" !== n.type ? e.handleObj.handler.apply(this, arguments) : t
            },
            teardown: function() {
                return b.event.remove(this, "._change"), !Z.test(this.nodeName)
            }
        }), b.support.focusinBubbles || b.each({
            focus: "focusin",
            blur: "focusout"
        }, function(e, t) {
            var
                n = 0,
                r = function(e) {
                    b.event.simulate(t, e.target, b.event.fix(e), !0)
                };
            b.event.special[t] = {
                setup: function() {
                    0 === n++ && o.addEventListener(e, r, !0)
                },
                teardown: function() {
                    0 === --n && o.removeEventListener(e, r, !0)
                }
            }
        }), b.fn.extend({
            on: function(e, n, r, i, o) {
                var
                    a, s;
                if ("object" == typeof e) {
                    "string" != typeof
                    n && (r = r || n, n = t);
                    for (a in
                        e) this.on(a, n, r, e[a], o);
                    return this
                }
                if (null == r && null == i ? (i = n, r = n = t) : null == i && ("string" == typeof n ? (i = r, r = t) : (i = r, r = n, n = t)), i === !1) i = ot;
                else
                if (!i) return this;
                return 1 === o && (s = i, i = function(e) {
                    return b().off(e), s.apply(this, arguments)
                }, i.guid = s.guid || (s.guid = b.guid++)), this.each(function() {
                    b.event.add(this, e, i, r, n)
                })
            },
            one: function(e, t, n, r) {
                return this.on(e, t, n, r, 1)
            },
            off: function(e, n, r) {
                var
                    i, o;
                if (e && e.preventDefault && e.handleObj) return i = e.handleObj, b(e.delegateTarget).off(i.namespace ? i.origType + "." + i.namespace : i.origType, i.selector, i.handler), this;
                if ("object" == typeof e) {
                    for (o in
                        e) this.off(o, n, e[o]);
                    return this
                }
                return (n === !1 || "function" == typeof n) && (r = n, n = t), r === !1 && (r = ot), this.each(function() {
                    b.event.remove(this, e, r, n)
                })
            },
            bind: function(e, t, n) {
                return this.on(e, null, t, n)
            },
            unbind: function(e, t) {
                return this.off(e, null, t)
            },
            delegate: function(e, t, n, r) {
                return this.on(t, e, n, r)
            },
            undelegate: function(e, t, n) {
                return 1 === arguments.length ? this.off(e, "**") : this.off(t, e || "**", n)
            },
            trigger: function(e, t) {
                return this.each(function() {
                    b.event.trigger(e, t, this)
                })
            },
            triggerHandler: function(e, n) {
                var
                    r = this[0];
                return r ? b.event.trigger(e, n, r, !0) : t
            }
        }),
        function(e, t) {
            var
                n, r, i, o, a, s, u, l, c, p, f, d, h, g, m, y, v, x = "sizzle" + -new
            Date, w = e.document, T = {}, N = 0, C = 0, k = it(), E = it(), S = it(), A = typeof
            t, j = 1 << 31, D = [], L = D.pop, H = D.push, q = D.slice, M = D.indexOf || function(e) {
                var
                    t = 0,
                    n = this.length;
                for (; n > t; t++)
                    if (this[t] === e) return t;
                return -1
            }, _ = "[\\x20\\t\\r\\n\\f]", F = "(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+", O = F.replace("w", "w#"), B = "([*^$|!~]?=)", P = "\\[" + _ + "*(" + F + ")" + _ + "*(?:" + B + _ + "*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|(" + O + ")|)|)" + _ + "*\\]", R = ":(" + F + ")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|" + P.replace(3, 8) + ")*)|.*)\\)|)", W = RegExp("^" + _ + "+|((?:^|[^\\\\])(?:\\\\.)*)" + _ + "+$", "g"), $ = RegExp("^" + _ + "*," + _ + "*"), I = RegExp("^" + _ + "*([\\x20\\t\\r\\n\\f>+~])" + _ + "*"), z = RegExp(R), X = RegExp("^" + O + "$"), U = {
                ID: RegExp("^#(" + F + ")"),
                CLASS: RegExp("^\\.(" + F + ")"),
                NAME: RegExp("^\\[name=['\"]?(" + F + ")['\"]?\\]"),
                TAG: RegExp("^(" + F.replace("w", "w*") + ")"),
                ATTR: RegExp("^" + P),
                PSEUDO: RegExp("^" + R),
                CHILD: RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\(" + _ + "*(even|odd|(([+-]|)(\\d*)n|)" + _ + "*(?:([+-]|)" + _ + "*(\\d+)|))" + _ + "*\\)|)", "i"),
                needsContext: RegExp("^" + _ + "*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\(" + _ + "*((?:-\\d)?\\d*)" + _ + "*\\)|)(?=[^-]|$)", "i")
            }, V = /[\x20\t\r\n\f]*[+~]/, Y = /^[^{]+\{\s*\[native code/, J = /^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/, G = /^(?:input|select|textarea|button)$/i, Q = /^h\d$/i, K = /'|\\/g, Z = /\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g, et = /\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g, tt = function(e, t) {
                var
                    n = "0x" + t - 65536;
                return n !== n ? t : 0 > n ? String.fromCharCode(n + 65536) : String.fromCharCode(55296 | n >> 10, 56320 | 1023 & n)
            };
            try {
                q.call(w.documentElement.childNodes, 0)[0].nodeType
            } catch (nt) {
                q = function(e) {
                    var
                        t, n = [];
                    while (t = this[e++]) n.push(t);
                    return n
                }
            }

            function
            rt(e) {
                return Y.test(e + "")
            }

            function
            it() {
                var
                    e, t = [];
                return e = function(n, r) {
                    return t.push(n += " ") > i.cacheLength && delete
                    e[t.shift()], e[n] = r
                }
            }

            function
            ot(e) {
                return e[x] = !0, e
            }

            function
            at(e) {
                var
                    t = p.createElement("div");
                try {
                    return e(t)
                } catch (n) {
                    return !1
                } finally {
                    t = null
                }
            }

            function
            st(e, t, n, r) {
                var
                    i, o, a, s, u, l, f, g, m, v;
                if ((t ? t.ownerDocument || t : w) !== p && c(t), t = t || p, n = n || [], !e || "string" != typeof e) return n;
                if (1 !== (s = t.nodeType) && 9 !== s) return [];
                if (!d && !r) {
                    if (i = J.exec(e))
                        if (a = i[1]) {
                            if (9 === s) {
                                if (o = t.getElementById(a), !o || !o.parentNode) return n;
                                if (o.id === a) return n.push(o), n
                            } else
                            if (t.ownerDocument && (o = t.ownerDocument.getElementById(a)) && y(t, o) && o.id === a) return n.push(o), n
                        } else {
                            if (i[2]) return H.apply(n, q.call(t.getElementsByTagName(e), 0)), n;
                            if ((a = i[3]) && T.getByClassName && t.getElementsByClassName) return H.apply(n, q.call(t.getElementsByClassName(a), 0)), n
                        }
                    if (T.qsa && !h.test(e)) {
                        if (f = !0, g = x, m = t, v = 9 === s && e, 1 === s && "object" !== t.nodeName.toLowerCase()) {
                            l = ft(e), (f = t.getAttribute("id")) ? g = f.replace(K, "\\$&") : t.setAttribute("id", g), g = "[id='" + g + "'] ", u = l.length;
                            while (u--) l[u] = g + dt(l[u]);
                            m = V.test(e) && t.parentNode || t, v = l.join(",")
                        }
                        if (v) try {
                            return H.apply(n, q.call(m.querySelectorAll(v), 0)), n
                        } catch (b) {} finally {
                            f || t.removeAttribute("id")
                        }
                    }
                }
                return wt(e.replace(W, "$1"), t, n, r)
            }
            a = st.isXML = function(e) {
                var
                    t = e && (e.ownerDocument || e).documentElement;
                return t ? "HTML" !== t.nodeName : !1
            }, c = st.setDocument = function(e) {
                var
                    n = e ? e.ownerDocument || e : w;
                return n !== p && 9 === n.nodeType && n.documentElement ? (p = n, f = n.documentElement, d = a(n), T.tagNameNoComments = at(function(e) {
                    return e.appendChild(n.createComment("")), !e.getElementsByTagName("*").length
                }), T.attributes = at(function(e) {
                    e.innerHTML = "<select></select>";
                    var
                        t = typeof
                    e.lastChild.getAttribute("multiple");
                    return "boolean" !== t && "string" !== t
                }), T.getByClassName = at(function(e) {
                    return e.innerHTML = "<div class='hidden e'></div><div class='hidden'></div>", e.getElementsByClassName && e.getElementsByClassName("e").length ? (e.lastChild.className = "e", 2 === e.getElementsByClassName("e").length) : !1
                }), T.getByName = at(function(e) {
                    e.id = x + 0, e.innerHTML = "<a name='" + x + "'></a><div name='" + x + "'></div>", f.insertBefore(e, f.firstChild);
                    var
                        t = n.getElementsByName && n.getElementsByName(x).length === 2 + n.getElementsByName(x + 0).length;
                    return T.getIdNotName = !n.getElementById(x), f.removeChild(e), t
                }), i.attrHandle = at(function(e) {
                    return e.innerHTML = "<a href='#'></a>", e.firstChild && typeof
                    e.firstChild.getAttribute !== A && "#" === e.firstChild.getAttribute("href")
                }) ? {} : {
                    href: function(e) {
                        return e.getAttribute("href", 2)
                    },
                    type: function(e) {
                        return e.getAttribute("type")
                    }
                }, T.getIdNotName ? (i.find.ID = function(e, t) {
                    if (typeof t.getElementById !== A && !d) {
                        var
                            n = t.getElementById(e);
                        return n && n.parentNode ? [n] : []
                    }
                }, i.filter.ID = function(e) {
                    var
                        t = e.replace(et, tt);
                    return function(e) {
                        return e.getAttribute("id") === t
                    }
                }) : (i.find.ID = function(e, n) {
                    if (typeof n.getElementById !== A && !d) {
                        var
                            r = n.getElementById(e);
                        return r ? r.id === e || typeof
                        r.getAttributeNode !== A && r.getAttributeNode("id").value === e ? [r] : t: []
                    }
                }, i.filter.ID = function(e) {
                    var
                        t = e.replace(et, tt);
                    return function(e) {
                        var
                            n = typeof
                        e.getAttributeNode !== A && e.getAttributeNode("id");
                        return n && n.value === t
                    }
                }), i.find.TAG = T.tagNameNoComments ? function(e, n) {
                    return typeof
                    n.getElementsByTagName !== A ? n.getElementsByTagName(e) : t
                } : function(e, t) {
                    var
                        n, r = [],
                        i = 0,
                        o = t.getElementsByTagName(e);
                    if ("*" === e) {
                        while (n = o[i++]) 1 === n.nodeType && r.push(n);
                        return r
                    }
                    return o
                }, i.find.NAME = T.getByName && function(e, n) {
                    return typeof
                    n.getElementsByName !== A ? n.getElementsByName(name) : t
                }, i.find.CLASS = T.getByClassName && function(e, n) {
                    return typeof
                    n.getElementsByClassName === A || d ? t : n.getElementsByClassName(e)
                }, g = [], h = [":focus"], (T.qsa = rt(n.querySelectorAll)) && (at(function(e) {
                    e.innerHTML = "<select><option selected=''></option></select>", e.querySelectorAll("[selected]").length || h.push("\\[" + _ + "*(?:checked|disabled|ismap|multiple|readonly|selected|value)"), e.querySelectorAll(":checked").length || h.push(":checked")
                }), at(function(e) {
                    e.innerHTML = "<input type='hidden' i=''/>", e.querySelectorAll("[i^='']").length && h.push("[*^$]=" + _ + "*(?:\"\"|'')"), e.querySelectorAll(":enabled").length || h.push(":enabled", ":disabled"), e.querySelectorAll("*,:x"), h.push(",.*:")
                })), (T.matchesSelector = rt(m = f.matchesSelector || f.mozMatchesSelector || f.webkitMatchesSelector || f.oMatchesSelector || f.msMatchesSelector)) && at(function(e) {
                    T.disconnectedMatch = m.call(e, "div"), m.call(e, "[s!='']:x"), g.push("!=", R)
                }), h = RegExp(h.join("|")), g = RegExp(g.join("|")), y = rt(f.contains) || f.compareDocumentPosition ? function(e, t) {
                    var
                        n = 9 === e.nodeType ? e.documentElement : e,
                        r = t && t.parentNode;
                    return e === r || !(!r || 1 !== r.nodeType || !(n.contains ? n.contains(r) : e.compareDocumentPosition && 16 & e.compareDocumentPosition(r)))
                } : function(e, t) {
                    if (t)
                        while (t = t.parentNode)
                            if (t === e) return !0;
                    return !1
                }, v = f.compareDocumentPosition ? function(e, t) {
                    var
                        r;
                    return e === t ? (u = !0, 0) : (r = t.compareDocumentPosition && e.compareDocumentPosition && e.compareDocumentPosition(t)) ? 1 & r || e.parentNode && 11 === e.parentNode.nodeType ? e === n || y(w, e) ? -1 : t === n || y(w, t) ? 1 : 0 : 4 & r ? -1 : 1 : e.compareDocumentPosition ? -1 : 1
                } : function(e, t) {
                    var
                        r, i = 0,
                        o = e.parentNode,
                        a = t.parentNode,
                        s = [e],
                        l = [t];
                    if (e === t) return u = !0, 0;
                    if (!o || !a) return e === n ? -1 : t === n ? 1 : o ? -1 : a ? 1 : 0;
                    if (o === a) return ut(e, t);
                    r = e;
                    while (r = r.parentNode) s.unshift(r);
                    r = t;
                    while (r = r.parentNode) l.unshift(r);
                    while (s[i] === l[i]) i++;
                    return i ? ut(s[i], l[i]) : s[i] === w ? -1 : l[i] === w ? 1 : 0
                }, u = !1, [0, 0].sort(v), T.detectDuplicates = u, p) : p
            }, st.matches = function(e, t) {
                return st(e, null, null, t)
            }, st.matchesSelector = function(e, t) {
                if ((e.ownerDocument || e) !== p && c(e), t = t.replace(Z, "='$1']"), !(!T.matchesSelector || d || g && g.test(t) || h.test(t))) try {
                    var
                        n = m.call(e, t);
                    if (n || T.disconnectedMatch || e.document && 11 !== e.document.nodeType) return n
                } catch (r) {}
                return st(t, p, null, [e]).length > 0
            }, st.contains = function(e, t) {
                return (e.ownerDocument || e) !== p && c(e), y(e, t)
            }, st.attr = function(e, t) {
                var
                    n;
                return (e.ownerDocument || e) !== p && c(e), d || (t = t.toLowerCase()), (n = i.attrHandle[t]) ? n(e) : d || T.attributes ? e.getAttribute(t) : ((n = e.getAttributeNode(t)) || e.getAttribute(t)) && e[t] === !0 ? t : n && n.specified ? n.value : null
            }, st.error = function(e) {
                throw Error("Syntax error, unrecognized expression: " + e)
            }, st.uniqueSort = function(e) {
                var
                    t, n = [],
                    r = 1,
                    i = 0;
                if (u = !T.detectDuplicates, e.sort(v), u) {
                    for (; t = e[r]; r++) t === e[r - 1] && (i = n.push(r));
                    while (i--) e.splice(n[i], 1)
                }
                return e
            };

            function
            ut(e, t) {
                var
                    n = t && e,
                    r = n && (~t.sourceIndex || j) - (~e.sourceIndex || j);
                if (r) return r;
                if (n)
                    while (n = n.nextSibling)
                        if (n === t) return -1;
                return e ? 1 : -1
            }

            function
            lt(e) {
                return function(t) {
                    var
                        n = t.nodeName.toLowerCase();
                    return "input" === n && t.type === e
                }
            }

            function
            ct(e) {
                return function(t) {
                    var
                        n = t.nodeName.toLowerCase();
                    return ("input" === n || "button" === n) && t.type === e
                }
            }

            function
            pt(e) {
                return ot(function(t) {
                    return t = +t, ot(function(n, r) {
                        var
                            i, o = e([], n.length, t),
                            a = o.length;
                        while (a--) n[i = o[a]] && (n[i] = !(r[i] = n[i]))
                    })
                })
            }
            o = st.getText = function(e) {
                var
                    t, n = "",
                    r = 0,
                    i = e.nodeType;
                if (i) {
                    if (1 === i || 9 === i || 11 === i) {
                        if ("string" == typeof e.textContent) return e.textContent;
                        for (e = e.firstChild; e; e = e.nextSibling) n += o(e)
                    } else
                    if (3 === i || 4 === i) return e.nodeValue
                } else
                    for (; t = e[r]; r++) n += o(t);
                return n
            }, i = st.selectors = {
                cacheLength: 50,
                createPseudo: ot,
                match: U,
                find: {},
                relative: {
                    ">": {
                        dir: "parentNode",
                        first: !0
                    },
                    " ": {
                        dir: "parentNode"
                    },
                    "+": {
                        dir: "previousSibling",
                        first: !0
                    },
                    "~": {
                        dir: "previousSibling"
                    }
                },
                preFilter: {
                    ATTR: function(e) {
                        return e[1] = e[1].replace(et, tt), e[3] = (e[4] || e[5] || "").replace(et, tt), "~=" === e[2] && (e[3] = " " + e[3] + " "), e.slice(0, 4)
                    },
                    CHILD: function(e) {
                        return e[1] = e[1].toLowerCase(), "nth" === e[1].slice(0, 3) ? (e[3] || st.error(e[0]), e[4] = +(e[4] ? e[5] + (e[6] || 1) : 2 * ("even" === e[3] || "odd" === e[3])), e[5] = +(e[7] + e[8] || "odd" === e[3])) : e[3] && st.error(e[0]), e
                    },
                    PSEUDO: function(e) {
                        var
                            t, n = !e[5] && e[2];
                        return U.CHILD.test(e[0]) ? null : (e[4] ? e[2] = e[4] : n && z.test(n) && (t = ft(n, !0)) && (t = n.indexOf(")", n.length - t) - n.length) && (e[0] = e[0].slice(0, t), e[2] = n.slice(0, t)), e.slice(0, 3))
                    }
                },
                filter: {
                    TAG: function(e) {
                        return "*" === e ? function() {
                            return !0
                        } : (e = e.replace(et, tt).toLowerCase(), function(t) {
                            return t.nodeName && t.nodeName.toLowerCase() === e
                        })
                    },
                    CLASS: function(e) {
                        var
                            t = k[e + " "];
                        return t || (t = RegExp("(^|" + _ + ")" + e + "(" + _ + "|$)")) && k(e, function(e) {
                            return t.test(e.className || typeof e.getAttribute !== A && e.getAttribute("class") || "")
                        })
                    },
                    ATTR: function(e, t, n) {
                        return function(r) {
                            var
                                i = st.attr(r, e);
                            return null == i ? "!=" === t : t ? (i += "", "=" === t ? i === n : "!=" === t ? i !== n : "^=" === t ? n && 0 === i.indexOf(n) : "*=" === t ? n && i.indexOf(n) > -1 : "$=" === t ? n && i.slice(-n.length) === n : "~=" === t ? (" " + i + " ").indexOf(n) > -1 : "|=" === t ? i === n || i.slice(0, n.length + 1) === n + "-" : !1) : !0
                        }
                    },
                    CHILD: function(e, t, n, r, i) {
                        var
                            o = "nth" !== e.slice(0, 3),
                            a = "last" !== e.slice(-4),
                            s = "of-type" === t;
                        return 1 === r && 0 === i ? function(e) {
                            return !!e.parentNode
                        } : function(t, n, u) {
                            var
                                l, c, p, f, d, h, g = o !== a ? "nextSibling" : "previousSibling",
                                m = t.parentNode,
                                y = s && t.nodeName.toLowerCase(),
                                v = !u && !s;
                            if (m) {
                                if (o) {
                                    while (g) {
                                        p = t;
                                        while (p = p[g])
                                            if (s ? p.nodeName.toLowerCase() === y : 1 === p.nodeType) return !1;
                                        h = g = "only" === e && !h && "nextSibling"
                                    }
                                    return !0
                                }
                                if (h = [a ? m.firstChild : m.lastChild], a && v) {
                                    c = m[x] || (m[x] = {}), l = c[e] || [], d = l[0] === N && l[1], f = l[0] === N && l[2], p = d && m.childNodes[d];
                                    while (p = ++d && p && p[g] || (f = d = 0) || h.pop())
                                        if (1 === p.nodeType && ++f && p === t) {
                                            c[e] = [N, d, f];
                                            break
                                        }
                                } else
                                if (v && (l = (t[x] || (t[x] = {}))[e]) && l[0] === N) f = l[1];
                                else
                                    while (p = ++d && p && p[g] || (f = d = 0) || h.pop())
                                        if ((s ? p.nodeName.toLowerCase() === y : 1 === p.nodeType) && ++f && (v && ((p[x] || (p[x] = {}))[e] = [N, f]), p === t)) break; return f -= i, f === r || 0 === f % r && f / r >= 0
                            }
                        }
                    },
                    PSEUDO: function(e, t) {
                        var
                            n, r = i.pseudos[e] || i.setFilters[e.toLowerCase()] || st.error("unsupported pseudo: " + e);
                        return r[x] ? r(t) : r.length > 1 ? (n = [e, e, "", t], i.setFilters.hasOwnProperty(e.toLowerCase()) ? ot(function(e, n) {
                            var
                                i, o = r(e, t),
                                a = o.length;
                            while (a--) i = M.call(e, o[a]), e[i] = !(n[i] = o[a])
                        }) : function(e) {
                            return r(e, 0, n)
                        }) : r
                    }
                },
                pseudos: {
                    not: ot(function(e) {
                        var
                            t = [],
                            n = [],
                            r = s(e.replace(W, "$1"));
                        return r[x] ? ot(function(e, t, n, i) {
                            var
                                o, a = r(e, null, i, []),
                                s = e.length;
                            while (s--)(o = a[s]) && (e[s] = !(t[s] = o))
                        }) : function(e, i, o) {
                            return t[0] = e, r(t, null, o, n), !n.pop()
                        }
                    }),
                    has: ot(function(e) {
                        return function(t) {
                            return st(e, t).length > 0
                        }
                    }),
                    contains: ot(function(e) {
                        return function(t) {
                            return (t.textContent || t.innerText || o(t)).indexOf(e) > -1
                        }
                    }),
                    lang: ot(function(e) {
                        return X.test(e || "") || st.error("unsupported lang: " + e), e = e.replace(et, tt).toLowerCase(),
                            function(t) {
                                var
                                    n;
                                do
                                    if (n = d ? t.getAttribute("xml:lang") || t.getAttribute("lang") : t.lang) return n = n.toLowerCase(), n === e || 0 === n.indexOf(e + "-");
                                while ((t = t.parentNode) && 1 === t.nodeType);
                                return !1
                            }
                    }),
                    target: function(t) {
                        var
                            n = e.location && e.location.hash;
                        return n && n.slice(1) === t.id
                    },
                    root: function(e) {
                        return e === f
                    },
                    focus: function(e) {
                        return e === p.activeElement && (!p.hasFocus || p.hasFocus()) && !!(e.type || e.href || ~e.tabIndex)
                    },
                    enabled: function(e) {
                        return e.disabled === !1
                    },
                    disabled: function(e) {
                        return e.disabled === !0
                    },
                    checked: function(e) {
                        var
                            t = e.nodeName.toLowerCase();
                        return "input" === t && !!e.checked || "option" === t && !!e.selected
                    },
                    selected: function(e) {
                        return e.parentNode && e.parentNode.selectedIndex, e.selected === !0
                    },
                    empty: function(e) {
                        for (e = e.firstChild; e; e = e.nextSibling)
                            if (e.nodeName > "@" || 3 === e.nodeType || 4 === e.nodeType) return !1;
                        return !0
                    },
                    parent: function(e) {
                        return !i.pseudos.empty(e)
                    },
                    header: function(e) {
                        return Q.test(e.nodeName)
                    },
                    input: function(e) {
                        return G.test(e.nodeName)
                    },
                    button: function(e) {
                        var
                            t = e.nodeName.toLowerCase();
                        return "input" === t && "button" === e.type || "button" === t
                    },
                    text: function(e) {
                        var
                            t;
                        return "input" === e.nodeName.toLowerCase() && "text" === e.type && (null == (t = e.getAttribute("type")) || t.toLowerCase() === e.type)
                    },
                    first: pt(function() {
                        return [0]
                    }),
                    last: pt(function(e, t) {
                        return [t - 1]
                    }),
                    eq: pt(function(e, t, n) {
                        return [0 > n ? n + t : n]
                    }),
                    even: pt(function(e, t) {
                        var
                            n = 0;
                        for (; t > n; n += 2) e.push(n);
                        return e
                    }),
                    odd: pt(function(e, t) {
                        var
                            n = 1;
                        for (; t > n; n += 2) e.push(n);
                        return e
                    }),
                    lt: pt(function(e, t, n) {
                        var
                            r = 0 > n ? n + t : n;
                        for (; --r >= 0;) e.push(r);
                        return e
                    }),
                    gt: pt(function(e, t, n) {
                        var
                            r = 0 > n ? n + t : n;
                        for (; t > ++r;) e.push(r);
                        return e
                    })
                }
            };
            for (n in {
                    radio: !0,
                    checkbox: !0,
                    file: !0,
                    password: !0,
                    image: !0
                }) i.pseudos[n] = lt(n);
            for (n in {
                    submit: !0,
                    reset: !0
                }) i.pseudos[n] = ct(n);

            function
            ft(e, t) {
                var
                    n, r, o, a, s, u, l, c = E[e + " "];
                if (c) return t ? 0 : c.slice(0);
                s = e, u = [], l = i.preFilter;
                while (s) {
                    (!n || (r = $.exec(s))) && (r && (s = s.slice(r[0].length) || s), u.push(o = [])), n = !1, (r = I.exec(s)) && (n = r.shift(), o.push({
                        value: n,
                        type: r[0].replace(W, " ")
                    }), s = s.slice(n.length));
                    for (a in
                        i.filter) !(r = U[a].exec(s)) || l[a] && !(r = l[a](r)) || (n = r.shift(), o.push({
                        value: n,
                        type: a,
                        matches: r
                    }), s = s.slice(n.length));
                    if (!n) break
                }
                return t ? s.length : s ? st.error(e) : E(e, u).slice(0)
            }

            function
            dt(e) {
                var
                    t = 0,
                    n = e.length,
                    r = "";
                for (; n > t; t++) r += e[t].value;
                return r
            }

            function
            ht(e, t, n) {
                var
                    i = t.dir,
                    o = n && "parentNode" === i,
                    a = C++;
                return t.first ? function(t, n, r) {
                    while (t = t[i])
                        if (1 === t.nodeType || o) return e(t, n, r)
                } : function(t, n, s) {
                    var
                        u, l, c, p = N + " " + a;
                    if (s) {
                        while (t = t[i])
                            if ((1 === t.nodeType || o) && e(t, n, s)) return !0
                    } else
                        while (t = t[i])
                            if (1 === t.nodeType || o)
                                if (c = t[x] || (t[x] = {}), (l = c[i]) && l[0] === p) {
                                    if ((u = l[1]) === !0 || u === r) return u === !0
                                } else
                    if (l = c[i] = [p], l[1] = e(t, n, s) || r, l[1] === !0) return !0
                }
            }

            function
            gt(e) {
                return e.length > 1 ? function(t, n, r) {
                    var
                        i = e.length;
                    while (i--)
                        if (!e[i](t, n, r)) return !1;
                    return !0
                } : e[0]
            }

            function
            mt(e, t, n, r, i) {
                var
                    o, a = [],
                    s = 0,
                    u = e.length,
                    l = null != t;
                for (; u > s; s++)(o = e[s]) && (!n || n(o, r, i)) && (a.push(o), l && t.push(s));
                return a
            }

            function
            yt(e, t, n, r, i, o) {
                return r && !r[x] && (r = yt(r)), i && !i[x] && (i = yt(i, o)), ot(function(o, a, s, u) {
                    var
                        l, c, p, f = [],
                        d = [],
                        h = a.length,
                        g = o || xt(t || "*", s.nodeType ? [s] : s, []),
                        m = !e || !o && t ? g : mt(g, f, e, s, u),
                        y = n ? i || (o ? e : h || r) ? [] : a : m;
                    if (n && n(m, y, s, u), r) {
                        l = mt(y, d), r(l, [], s, u), c = l.length;
                        while (c--)(p = l[c]) && (y[d[c]] = !(m[d[c]] = p))
                    }
                    if (o) {
                        if (i || e) {
                            if (i) {
                                l = [], c = y.length;
                                while (c--)(p = y[c]) && l.push(m[c] = p);
                                i(null, y = [], l, u)
                            }
                            c = y.length;
                            while (c--)(p = y[c]) && (l = i ? M.call(o, p) : f[c]) > -1 && (o[l] = !(a[l] = p))
                        }
                    } else
                        y = mt(y === a ? y.splice(h, y.length) : y), i ? i(null, a, y, u) : H.apply(a, y)
                })
            }

            function
            vt(e) {
                var
                    t, n, r, o = e.length,
                    a = i.relative[e[0].type],
                    s = a || i.relative[" "],
                    u = a ? 1 : 0,
                    c = ht(function(e) {
                        return e === t
                    }, s, !0),
                    p = ht(function(e) {
                        return M.call(t, e) > -1
                    }, s, !0),
                    f = [function(e, n, r) {
                        return !a && (r || n !== l) || ((t = n).nodeType ? c(e, n, r) : p(e, n, r))
                    }];
                for (; o > u; u++)
                    if (n = i.relative[e[u].type]) f = [ht(gt(f), n)];
                    else {
                        if (n = i.filter[e[u].type].apply(null, e[u].matches), n[x]) {
                            for (r = ++u; o > r; r++)
                                if (i.relative[e[r].type]) break;
                            return yt(u > 1 && gt(f), u > 1 && dt(e.slice(0, u - 1)).replace(W, "$1"), n, r > u && vt(e.slice(u, r)), o > r && vt(e = e.slice(r)), o > r && dt(e))
                        }
                        f.push(n)
                    }
                return gt(f)
            }

            function
            bt(e, t) {
                var
                    n = 0,
                    o = t.length > 0,
                    a = e.length > 0,
                    s = function(s, u, c, f, d) {
                        var
                            h, g, m, y = [],
                            v = 0,
                            b = "0",
                            x = s && [],
                            w = null != d,
                            T = l,
                            C = s || a && i.find.TAG("*", d && u.parentNode || u),
                            k = N += null == T ? 1 : Math.random() || .1;
                        for (w && (l = u !== p && u, r = n); null != (h = C[b]); b++) {
                            if (a && h) {
                                g = 0;
                                while (m = e[g++])
                                    if (m(h, u, c)) {
                                        f.push(h);
                                        break
                                    }
                                w && (N = k, r = ++n)
                            }
                            o && ((h = !m && h) && v--, s && x.push(h))
                        }
                        if (v += b, o && b !== v) {
                            g = 0;
                            while (m = t[g++]) m(x, y, u, c);
                            if (s) {
                                if (v > 0)
                                    while (b--) x[b] || y[b] || (y[b] = L.call(f));
                                y = mt(y)
                            }
                            H.apply(f, y), w && !s && y.length > 0 && v + t.length > 1 && st.uniqueSort(f)
                        }
                        return w && (N = k, l = T), x
                    };
                return o ? ot(s) : s
            }
            s = st.compile = function(e, t) {
                var
                    n, r = [],
                    i = [],
                    o = S[e + " "];
                if (!o) {
                    t || (t = ft(e)), n = t.length;
                    while (n--) o = vt(t[n]), o[x] ? r.push(o) : i.push(o);
                    o = S(e, bt(i, r))
                }
                return o
            };

            function
            xt(e, t, n) {
                var
                    r = 0,
                    i = t.length;
                for (; i > r; r++) st(e, t[r], n);
                return n
            }

            function
            wt(e, t, n, r) {
                var
                    o, a, u, l, c, p = ft(e);
                if (!r && 1 === p.length) {
                    if (a = p[0] = p[0].slice(0), a.length > 2 && "ID" === (u = a[0]).type && 9 === t.nodeType && !d && i.relative[a[1].type]) {
                        if (t = i.find.ID(u.matches[0].replace(et, tt), t)[0], !t) return n;
                        e = e.slice(a.shift().value.length)
                    }
                    o = U.needsContext.test(e) ? 0 : a.length;
                    while (o--) {
                        if (u = a[o], i.relative[l = u.type]) break;
                        if ((c = i.find[l]) && (r = c(u.matches[0].replace(et, tt), V.test(a[0].type) && t.parentNode || t))) {
                            if (a.splice(o, 1), e = r.length && dt(a), !e) return H.apply(n, q.call(r, 0)), n;
                            break
                        }
                    }
                }
                return s(e, p)(r, t, d, n, V.test(e)), n
            }
            i.pseudos.nth = i.pseudos.eq;

            function
            Tt() {}
            i.filters = Tt.prototype = i.pseudos, i.setFilters = new
            Tt, c(), st.attr = b.attr, b.find = st, b.expr = st.selectors, b.expr[":"] = b.expr.pseudos, b.unique = st.uniqueSort, b.text = st.getText, b.isXMLDoc = st.isXML, b.contains = st.contains
        }(e);
    var
        at = /Until$/,
        st = /^(?:parents|prev(?:Until|All))/,
        ut = /^.[^:#\[\.,]*$/,
        lt = b.expr.match.needsContext,
        ct = {
            children: !0,
            contents: !0,
            next: !0,
            prev: !0
        };
    b.fn.extend({
        find: function(e) {
            var
                t, n, r, i = this.length;
            if ("string" != typeof e) return r = this, this.pushStack(b(e).filter(function() {
                for (t = 0; i > t; t++)
                    if (b.contains(r[t], this)) return !0
            }));
            for (n = [], t = 0; i > t; t++) b.find(e, this[t], n);
            return n = this.pushStack(i > 1 ? b.unique(n) : n), n.selector = (this.selector ? this.selector + " " : "") + e, n
        },
        has: function(e) {
            var
                t, n = b(e, this),
                r = n.length;
            return this.filter(function() {
                for (t = 0; r > t; t++)
                    if (b.contains(this, n[t])) return !0
            })
        },
        not: function(e) {
            return this.pushStack(ft(this, e, !1))
        },
        filter: function(e) {
            return this.pushStack(ft(this, e, !0))
        },
        is: function(e) {
            return !!e && ("string" == typeof e ? lt.test(e) ? b(e, this.context).index(this[0]) >= 0 : b.filter(e, this).length > 0 : this.filter(e).length > 0)
        },
        closest: function(e, t) {
            var
                n, r = 0,
                i = this.length,
                o = [],
                a = lt.test(e) || "string" != typeof
            e ? b(e, t || this.context) : 0;
            for (; i > r; r++) {
                n = this[r];
                while (n && n.ownerDocument && n !== t && 11 !== n.nodeType) {
                    if (a ? a.index(n) > -1 : b.find.matchesSelector(n, e)) {
                        o.push(n);
                        break
                    }
                    n = n.parentNode
                }
            }
            return this.pushStack(o.length > 1 ? b.unique(o) : o)
        },
        index: function(e) {
            return e ? "string" == typeof
            e ? b.inArray(this[0], b(e)) : b.inArray(e.jquery ? e[0] : e, this): this[0] && this[0].parentNode ? this.first().prevAll().length : -1
        },
        add: function(e, t) {
            var
                n = "string" == typeof
            e ? b(e, t) : b.makeArray(e && e.nodeType ? [e] : e), r = b.merge(this.get(), n);
            return this.pushStack(b.unique(r))
        },
        addBack: function(e) {
            return this.add(null == e ? this.prevObject : this.prevObject.filter(e))
        }
    }), b.fn.andSelf = b.fn.addBack;

    function
    pt(e, t) {
        do
            e = e[t]; while (e && 1 !== e.nodeType);
        return e
    }
    b.each({
        parent: function(e) {
            var
                t = e.parentNode;
            return t && 11 !== t.nodeType ? t : null
        },
        parents: function(e) {
            return b.dir(e, "parentNode")
        },
        parentsUntil: function(e, t, n) {
            return b.dir(e, "parentNode", n)
        },
        next: function(e) {
            return pt(e, "nextSibling")
        },
        prev: function(e) {
            return pt(e, "previousSibling")
        },
        nextAll: function(e) {
            return b.dir(e, "nextSibling")
        },
        prevAll: function(e) {
            return b.dir(e, "previousSibling")
        },
        nextUntil: function(e, t, n) {
            return b.dir(e, "nextSibling", n)
        },
        prevUntil: function(e, t, n) {
            return b.dir(e, "previousSibling", n)
        },
        siblings: function(e) {
            return b.sibling((e.parentNode || {}).firstChild, e)
        },
        children: function(e) {
            return b.sibling(e.firstChild)
        },
        contents: function(e) {
            return b.nodeName(e, "iframe") ? e.contentDocument || e.contentWindow.document : b.merge([], e.childNodes)
        }
    }, function(e, t) {
        b.fn[e] = function(n, r) {
            var
                i = b.map(this, t, n);
            return at.test(e) || (r = n), r && "string" == typeof
            r && (i = b.filter(r, i)), i = this.length > 1 && !ct[e] ? b.unique(i) : i, this.length > 1 && st.test(e) && (i = i.reverse()), this.pushStack(i)
        }
    }), b.extend({
        filter: function(e, t, n) {
            return n && (e = ":not(" + e + ")"), 1 === t.length ? b.find.matchesSelector(t[0], e) ? [t[0]] : [] : b.find.matches(e, t)
        },
        dir: function(e, n, r) {
            var
                i = [],
                o = e[n];
            while (o && 9 !== o.nodeType && (r === t || 1 !== o.nodeType || !b(o).is(r))) 1 === o.nodeType && i.push(o), o = o[n];
            return i
        },
        sibling: function(e, t) {
            var
                n = [];
            for (; e; e = e.nextSibling) 1 === e.nodeType && e !== t && n.push(e);
            return n
        }
    });

    function
    ft(e, t, n) {
        if (t = t || 0, b.isFunction(t)) return b.grep(e, function(e, r) {
            var
                i = !!t.call(e, r, e);
            return i === n
        });
        if (t.nodeType) return b.grep(e, function(e) {
            return e === t === n
        });
        if ("string" == typeof t) {
            var
                r = b.grep(e, function(e) {
                    return 1 === e.nodeType
                });
            if (ut.test(t)) return b.filter(t, r, !n);
            t = b.filter(t, r)
        }
        return b.grep(e, function(e) {
            return b.inArray(e, t) >= 0 === n
        })
    }

    function
    dt(e) {
        var
            t = ht.split("|"),
            n = e.createDocumentFragment();
        if (n.createElement)
            while (t.length) n.createElement(t.pop());
        return n
    }
    var
        ht = "abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",
        gt = / jQuery\d+="(?:null|\d+)"/g,
        mt = RegExp("<(?:" + ht + ")[\\s/>]", "i"),
        yt = /^\s+/,
        vt = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,
        bt = /<([\w:]+)/,
        xt = /<tbody/i,
        wt = /<|&#?\w+;/,
        Tt = /<(?:script|style|link)/i,
        Nt = /^(?:checkbox|radio)$/i,
        Ct = /checked\s*(?:[^=]|=\s*.checked.)/i,
        kt = /^$|\/(?:java|ecma)script/i,
        Et = /^true\/(.*)/,
        St = /^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,
        At = {
            option: [1, "<select multiple='multiple'>", "</select>"],
            legend: [1, "<fieldset>", "</fieldset>"],
            area: [1, "<map>", "</map>"],
            param: [1, "<object>", "</object>"],
            thead: [1, "<table>", "</table>"],
            tr: [2, "<table><tbody>", "</tbody></table>"],
            col: [2, "<table><tbody></tbody><colgroup>", "</colgroup></table>"],
            td: [3, "<table><tbody><tr>", "</tr></tbody></table>"],
            _default: b.support.htmlSerialize ? [0, "", ""] : [1, "X<div>", "</div>"]
        },
        jt = dt(o),
        Dt = jt.appendChild(o.createElement("div"));
    At.optgroup = At.option, At.tbody = At.tfoot = At.colgroup = At.caption = At.thead, At.th = At.td, b.fn.extend({
        text: function(e) {
            return b.access(this, function(e) {
                return e === t ? b.text(this) : this.empty().append((this[0] && this[0].ownerDocument || o).createTextNode(e))
            }, null, e, arguments.length)
        },
        wrapAll: function(e) {
            if (b.isFunction(e)) return this.each(function(t) {
                b(this).wrapAll(e.call(this, t))
            });
            if (this[0]) {
                var
                    t = b(e, this[0].ownerDocument).eq(0).clone(!0);
                this[0].parentNode && t.insertBefore(this[0]), t.map(function() {
                    var
                        e = this;
                    while (e.firstChild && 1 === e.firstChild.nodeType) e = e.firstChild;
                    return e
                }).append(this)
            }
            return this
        },
        wrapInner: function(e) {
            return b.isFunction(e) ? this.each(function(t) {
                b(this).wrapInner(e.call(this, t))
            }) : this.each(function() {
                var
                    t = b(this),
                    n = t.contents();
                n.length ? n.wrapAll(e) : t.append(e)
            })
        },
        wrap: function(e) {
            var
                t = b.isFunction(e);
            return this.each(function(n) {
                b(this).wrapAll(t ? e.call(this, n) : e)
            })
        },
        unwrap: function() {
            return this.parent().each(function() {
                b.nodeName(this, "body") || b(this).replaceWith(this.childNodes)
            }).end()
        },
        append: function() {
            return this.domManip(arguments, !0, function(e) {
                (1 === this.nodeType || 11 === this.nodeType || 9 === this.nodeType) && this.appendChild(e)
            })
        },
        prepend: function() {
            return this.domManip(arguments, !0, function(e) {
                (1 === this.nodeType || 11 === this.nodeType || 9 === this.nodeType) && this.insertBefore(e, this.firstChild)
            })
        },
        before: function() {
            return this.domManip(arguments, !1, function(e) {
                this.parentNode && this.parentNode.insertBefore(e, this)
            })
        },
        after: function() {
            return this.domManip(arguments, !1, function(e) {
                this.parentNode && this.parentNode.insertBefore(e, this.nextSibling)
            })
        },
        remove: function(e, t) {
            var
                n, r = 0;
            for (; null != (n = this[r]); r++)(!e || b.filter(e, [n]).length > 0) && (t || 1 !== n.nodeType || b.cleanData(Ot(n)), n.parentNode && (t && b.contains(n.ownerDocument, n) && Mt(Ot(n, "script")), n.parentNode.removeChild(n)));
            return this
        },
        empty: function() {
            var
                e, t = 0;
            for (; null != (e = this[t]); t++) {
                1 === e.nodeType && b.cleanData(Ot(e, !1));
                while (e.firstChild) e.removeChild(e.firstChild);
                e.options && b.nodeName(e, "select") && (e.options.length = 0)
            }
            return this
        },
        clone: function(e, t) {
            return e = null == e ? !1 : e, t = null == t ? e : t, this.map(function() {
                return b.clone(this, e, t)
            })
        },
        html: function(e) {
            return b.access(this, function(e) {
                var
                    n = this[0] || {},
                    r = 0,
                    i = this.length;
                if (e === t) return 1 === n.nodeType ? n.innerHTML.replace(gt, "") : t;
                if (!("string" != typeof e || Tt.test(e) || !b.support.htmlSerialize && mt.test(e) || !b.support.leadingWhitespace && yt.test(e) || At[(bt.exec(e) || ["", ""])[1].toLowerCase()])) {
                    e = e.replace(vt, "<$1></$2>");
                    try {
                        for (; i > r; r++) n = this[r] || {}, 1 === n.nodeType && (b.cleanData(Ot(n, !1)), n.innerHTML = e);
                        n = 0
                    } catch (o) {}
                }
                n && this.empty().append(e)
            }, null, e, arguments.length)
        },
        replaceWith: function(e) {
            var
                t = b.isFunction(e);
            return t || "string" == typeof
            e || (e = b(e).not(this).detach()), this.domManip([e], !0, function(e) {
                var
                    t = this.nextSibling,
                    n = this.parentNode;
                n && (b(this).remove(), n.insertBefore(e, t))
            })
        },
        detach: function(e) {
            return this.remove(e, !0)
        },
        domManip: function(e, n, r) {
            e = f.apply([], e);
            var
                i, o, a, s, u, l, c = 0,
                p = this.length,
                d = this,
                h = p - 1,
                g = e[0],
                m = b.isFunction(g);
            if (m || !(1 >= p || "string" != typeof g || b.support.checkClone) && Ct.test(g)) return this.each(function(i) {
                var
                    o = d.eq(i);
                m && (e[0] = g.call(this, i, n ? o.html() : t)), o.domManip(e, n, r)
            });
            if (p && (l = b.buildFragment(e, this[0].ownerDocument, !1, this), i = l.firstChild, 1 === l.childNodes.length && (l = i), i)) {
                for (n = n && b.nodeName(i, "tr"), s = b.map(Ot(l, "script"), Ht), a = s.length; p > c; c++) o = l, c !== h && (o = b.clone(o, !0, !0), a && b.merge(s, Ot(o, "script"))), r.call(n && b.nodeName(this[c], "table") ? Lt(this[c], "tbody") : this[c], o, c);
                if (a)
                    for (u = s[s.length - 1].ownerDocument, b.map(s, qt), c = 0; a > c; c++) o = s[c], kt.test(o.type || "") && !b._data(o, "globalEval") && b.contains(u, o) && (o.src ? b.ajax({
                        url: o.src,
                        type: "GET",
                        dataType: "script",
                        async: !1,
                        global: !1,
                        "throws": !0
                    }) : b.globalEval((o.text || o.textContent || o.innerHTML || "").replace(St, "")));
                l = i = null
            }
            return this
        }
    });

    function
    Lt(e, t) {
        return e.getElementsByTagName(t)[0] || e.appendChild(e.ownerDocument.createElement(t))
    }

    function
    Ht(e) {
        var
            t = e.getAttributeNode("type");
        return e.type = (t && t.specified) + "/" + e.type, e
    }

    function
    qt(e) {
        var
            t = Et.exec(e.type);
        return t ? e.type = t[1] : e.removeAttribute("type"), e
    }

    function
    Mt(e, t) {
        var
            n, r = 0;
        for (; null != (n = e[r]); r++) b._data(n, "globalEval", !t || b._data(t[r], "globalEval"))
    }

    function
    _t(e, t) {
        if (1 === t.nodeType && b.hasData(e)) {
            var
                n, r, i, o = b._data(e),
                a = b._data(t, o),
                s = o.events;
            if (s) {
                delete
                a.handle, a.events = {};
                for (n in
                    s)
                    for (r = 0, i = s[n].length; i > r; r++) b.event.add(t, n, s[n][r])
            }
            a.data && (a.data = b.extend({}, a.data))
        }
    }

    function
    Ft(e, t) {
        var
            n, r, i;
        if (1 === t.nodeType) {
            if (n = t.nodeName.toLowerCase(), !b.support.noCloneEvent && t[b.expando]) {
                i = b._data(t);
                for (r in
                    i.events) b.removeEvent(t, r, i.handle);
                t.removeAttribute(b.expando)
            }
            "script" === n && t.text !== e.text ? (Ht(t).text = e.text, qt(t)) : "object" === n ? (t.parentNode && (t.outerHTML = e.outerHTML), b.support.html5Clone && e.innerHTML && !b.trim(t.innerHTML) && (t.innerHTML = e.innerHTML)) : "input" === n && Nt.test(e.type) ? (t.defaultChecked = t.checked = e.checked, t.value !== e.value && (t.value = e.value)) : "option" === n ? t.defaultSelected = t.selected = e.defaultSelected : ("input" === n || "textarea" === n) && (t.defaultValue = e.defaultValue)
        }
    }
    b.each({
        appendTo: "append",
        prependTo: "prepend",
        insertBefore: "before",
        insertAfter: "after",
        replaceAll: "replaceWith"
    }, function(e, t) {
        b.fn[e] = function(e) {
            var
                n, r = 0,
                i = [],
                o = b(e),
                a = o.length - 1;
            for (; a >= r; r++) n = r === a ? this : this.clone(!0), b(o[r])[t](n), d.apply(i, n.get());
            return this.pushStack(i)
        }
    });

    function
    Ot(e, n) {
        var
            r, o, a = 0,
            s = typeof
        e.getElementsByTagName !== i ? e.getElementsByTagName(n || "*") : typeof
        e.querySelectorAll !== i ? e.querySelectorAll(n || "*") : t;
        if (!s)
            for (s = [], r = e.childNodes || e; null != (o = r[a]); a++) !n || b.nodeName(o, n) ? s.push(o) : b.merge(s, Ot(o, n));
        return n === t || n && b.nodeName(e, n) ? b.merge([e], s) : s
    }

    function
    Bt(e) {
        Nt.test(e.type) && (e.defaultChecked = e.checked)
    }
    b.extend({
        clone: function(e, t, n) {
            var
                r, i, o, a, s, u = b.contains(e.ownerDocument, e);
            if (b.support.html5Clone || b.isXMLDoc(e) || !mt.test("<" + e.nodeName + ">") ? o = e.cloneNode(!0) : (Dt.innerHTML = e.outerHTML, Dt.removeChild(o = Dt.firstChild)), !(b.support.noCloneEvent && b.support.noCloneChecked || 1 !== e.nodeType && 11 !== e.nodeType || b.isXMLDoc(e)))
                for (r = Ot(o), s = Ot(e), a = 0; null != (i = s[a]); ++a) r[a] && Ft(i, r[a]);
            if (t)
                if (n)
                    for (s = s || Ot(e), r = r || Ot(o), a = 0; null != (i = s[a]); a++) _t(i, r[a]);
                else
                    _t(e, o);
            return r = Ot(o, "script"), r.length > 0 && Mt(r, !u && Ot(e, "script")), r = s = i = null, o
        },
        buildFragment: function(e, t, n, r) {
            var
                i, o, a, s, u, l, c, p = e.length,
                f = dt(t),
                d = [],
                h = 0;
            for (; p > h; h++)
                if (o = e[h], o || 0 === o)
                    if ("object" === b.type(o)) b.merge(d, o.nodeType ? [o] : o);
                    else
            if (wt.test(o)) {
                s = s || f.appendChild(t.createElement("div")), u = (bt.exec(o) || ["", ""])[1].toLowerCase(), c = At[u] || At._default, s.innerHTML = c[1] + o.replace(vt, "<$1></$2>") + c[2], i = c[0];
                while (i--) s = s.lastChild;
                if (!b.support.leadingWhitespace && yt.test(o) && d.push(t.createTextNode(yt.exec(o)[0])), !b.support.tbody) {
                    o = "table" !== u || xt.test(o) ? "<table>" !== c[1] || xt.test(o) ? 0 : s : s.firstChild, i = o && o.childNodes.length;
                    while (i--) b.nodeName(l = o.childNodes[i], "tbody") && !l.childNodes.length && o.removeChild(l)
                }
                b.merge(d, s.childNodes), s.textContent = "";
                while (s.firstChild) s.removeChild(s.firstChild);
                s = f.lastChild
            } else
                d.push(t.createTextNode(o));
            s && f.removeChild(s), b.support.appendChecked || b.grep(Ot(d, "input"), Bt), h = 0;
            while (o = d[h++])
                if ((!r || -1 === b.inArray(o, r)) && (a = b.contains(o.ownerDocument, o), s = Ot(f.appendChild(o), "script"), a && Mt(s), n)) {
                    i = 0;
                    while (o = s[i++]) kt.test(o.type || "") && n.push(o)
                }
            return s = null, f
        },
        cleanData: function(e, t) {
            var
                n, r, o, a, s = 0,
                u = b.expando,
                l = b.cache,
                p = b.support.deleteExpando,
                f = b.event.special;
            for (; null != (n = e[s]); s++)
                if ((t || b.acceptData(n)) && (o = n[u], a = o && l[o])) {
                    if (a.events)
                        for (r in
                            a.events) f[r] ? b.event.remove(n, r) : b.removeEvent(n, r, a.handle);
                    l[o] && (delete l[o], p ? delete n[u] : typeof n.removeAttribute !== i ? n.removeAttribute(u) : n[u] = null, c.push(o))
                }
        }
    });
    var
        Pt, Rt, Wt, $t = /alpha\([^)]*\)/i,
        It = /opacity\s*=\s*([^)]*)/,
        zt = /^(top|right|bottom|left)$/,
        Xt = /^(none|table(?!-c[ea]).+)/,
        Ut = /^margin/,
        Vt = RegExp("^(" + x + ")(.*)$", "i"),
        Yt = RegExp("^(" + x + ")(?!px)[a-z%]+$", "i"),
        Jt = RegExp("^([+-])=(" + x + ")", "i"),
        Gt = {
            BODY: "block"
        },
        Qt = {
            position: "absolute",
            visibility: "hidden",
            display: "block"
        },
        Kt = {
            letterSpacing: 0,
            fontWeight: 400
        },
        Zt = ["Top", "Right", "Bottom", "Left"],
        en = ["Webkit", "O", "Moz", "ms"];

    function
    tn(e, t) {
        if (t in
            e) return t;
        var
            n = t.charAt(0).toUpperCase() + t.slice(1),
            r = t,
            i = en.length;
        while (i--)
            if (t = en[i] + n, t in
                e) return t;
        return r
    }

    function
    nn(e, t) {
        return e = t || e, "none" === b.css(e, "display") || !b.contains(e.ownerDocument, e)
    }

    function
    rn(e, t) {
        var
            n, r, i, o = [],
            a = 0,
            s = e.length;
        for (; s > a; a++) r = e[a], r.style && (o[a] = b._data(r, "olddisplay"), n = r.style.display, t ? (o[a] || "none" !== n || (r.style.display = ""), "" === r.style.display && nn(r) && (o[a] = b._data(r, "olddisplay", un(r.nodeName)))) : o[a] || (i = nn(r), (n && "none" !== n || !i) && b._data(r, "olddisplay", i ? n : b.css(r, "display"))));
        for (a = 0; s > a; a++) r = e[a], r.style && (t && "none" !== r.style.display && "" !== r.style.display || (r.style.display = t ? o[a] || "" : "none"));
        return e
    }
    b.fn.extend({
        css: function(e, n) {
            return b.access(this, function(e, n, r) {
                var
                    i, o, a = {},
                    s = 0;
                if (b.isArray(n)) {
                    for (o = Rt(e), i = n.length; i > s; s++) a[n[s]] = b.css(e, n[s], !1, o);
                    return a
                }
                return r !== t ? b.style(e, n, r) : b.css(e, n)
            }, e, n, arguments.length > 1)
        },
        show: function() {
            return rn(this, !0)
        },
        hide: function() {
            return rn(this)
        },
        toggle: function(e) {
            var
                t = "boolean" == typeof
            e;
            return this.each(function() {
                (t ? e : nn(this)) ? b(this).show(): b(this).hide()
            })
        }
    }), b.extend({
        cssHooks: {
            opacity: {
                get: function(e, t) {
                    if (t) {
                        var
                            n = Wt(e, "opacity");
                        return "" === n ? "1" : n
                    }
                }
            }
        },
        cssNumber: {
            columnCount: !0,
            fillOpacity: !0,
            fontWeight: !0,
            lineHeight: !0,
            opacity: !0,
            orphans: !0,
            widows: !0,
            zIndex: !0,
            zoom: !0
        },
        cssProps: {
            "float": b.support.cssFloat ? "cssFloat" : "styleFloat"
        },
        style: function(e, n, r, i) {
            if (e && 3 !== e.nodeType && 8 !== e.nodeType && e.style) {
                var
                    o, a, s, u = b.camelCase(n),
                    l = e.style;
                if (n = b.cssProps[u] || (b.cssProps[u] = tn(l, u)), s = b.cssHooks[n] || b.cssHooks[u], r === t) return s && "get" in
                    s && (o = s.get(e, !1, i)) !== t ? o : l[n];
                if (a = typeof r, "string" === a && (o = Jt.exec(r)) && (r = (o[1] + 1) * o[2] + parseFloat(b.css(e, n)), a = "number"), !(null == r || "number" === a && isNaN(r) || ("number" !== a || b.cssNumber[u] || (r += "px"), b.support.clearCloneStyle || "" !== r || 0 !== n.indexOf("background") || (l[n] = "inherit"), s && "set" in
                        s && (r = s.set(e, r, i)) === t))) try {
                    l[n] = r
                } catch (c) {}
            }
        },
        css: function(e, n, r, i) {
            var
                o, a, s, u = b.camelCase(n);
            return n = b.cssProps[u] || (b.cssProps[u] = tn(e.style, u)), s = b.cssHooks[n] || b.cssHooks[u], s && "get" in
                s && (a = s.get(e, !0, r)), a === t && (a = Wt(e, n, i)), "normal" === a && n in
                Kt && (a = Kt[n]), "" === r || r ? (o = parseFloat(a), r === !0 || b.isNumeric(o) ? o || 0 : a) : a
        },
        swap: function(e, t, n, r) {
            var
                i, o, a = {};
            for (o in
                t) a[o] = e.style[o], e.style[o] = t[o];
            i = n.apply(e, r || []);
            for (o in
                t) e.style[o] = a[o];
            return i
        }
    }), e.getComputedStyle ? (Rt = function(t) {
        return e.getComputedStyle(t, null)
    }, Wt = function(e, n, r) {
        var
            i, o, a, s = r || Rt(e),
            u = s ? s.getPropertyValue(n) || s[n] : t,
            l = e.style;
        return s && ("" !== u || b.contains(e.ownerDocument, e) || (u = b.style(e, n)), Yt.test(u) && Ut.test(n) && (i = l.width, o = l.minWidth, a = l.maxWidth, l.minWidth = l.maxWidth = l.width = u, u = s.width, l.width = i, l.minWidth = o, l.maxWidth = a)), u
    }) : o.documentElement.currentStyle && (Rt = function(e) {
        return e.currentStyle
    }, Wt = function(e, n, r) {
        var
            i, o, a, s = r || Rt(e),
            u = s ? s[n] : t,
            l = e.style;
        return null == u && l && l[n] && (u = l[n]), Yt.test(u) && !zt.test(n) && (i = l.left, o = e.runtimeStyle, a = o && o.left, a && (o.left = e.currentStyle.left), l.left = "fontSize" === n ? "1em" : u, u = l.pixelLeft + "px", l.left = i, a && (o.left = a)), "" === u ? "auto" : u
    });

    function
    on(e, t, n) {
        var
            r = Vt.exec(t);
        return r ? Math.max(0, r[1] - (n || 0)) + (r[2] || "px") : t
    }

    function
    an(e, t, n, r, i) {
        var
            o = n === (r ? "border" : "content") ? 4 : "width" === t ? 1 : 0,
            a = 0;
        for (; 4 > o; o += 2) "margin" === n && (a += b.css(e, n + Zt[o], !0, i)), r ? ("content" === n && (a -= b.css(e, "padding" + Zt[o], !0, i)), "margin" !== n && (a -= b.css(e, "border" + Zt[o] + "Width", !0, i))) : (a += b.css(e, "padding" + Zt[o], !0, i), "padding" !== n && (a += b.css(e, "border" + Zt[o] + "Width", !0, i)));
        return a
    }

    function
    sn(e, t, n) {
        var
            r = !0,
            i = "width" === t ? e.offsetWidth : e.offsetHeight,
            o = Rt(e),
            a = b.support.boxSizing && "border-box" === b.css(e, "boxSizing", !1, o);
        if (0 >= i || null == i) {
            if (i = Wt(e, t, o), (0 > i || null == i) && (i = e.style[t]), Yt.test(i)) return i;
            r = a && (b.support.boxSizingReliable || i === e.style[t]), i = parseFloat(i) || 0
        }
        return i + an(e, t, n || (a ? "border" : "content"), r, o) + "px"
    }

    function
    un(e) {
        var
            t = o,
            n = Gt[e];
        return n || (n = ln(e, t), "none" !== n && n || (Pt = (Pt || b("<iframe frameborder='0' width='0' height='0'/>").css("cssText", "display:block !important")).appendTo(t.documentElement), t = (Pt[0].contentWindow || Pt[0].contentDocument).document, t.write("<!doctype html><html><body>"), t.close(), n = ln(e, t), Pt.detach()), Gt[e] = n), n
    }

    function
    ln(e, t) {
        var
            n = b(t.createElement(e)).appendTo(t.body),
            r = b.css(n[0], "display");
        return n.remove(), r
    }
    b.each(["height", "width"], function(e, n) {
        b.cssHooks[n] = {
            get: function(e, r, i) {
                return r ? 0 === e.offsetWidth && Xt.test(b.css(e, "display")) ? b.swap(e, Qt, function() {
                    return sn(e, n, i)
                }) : sn(e, n, i) : t
            },
            set: function(e, t, r) {
                var
                    i = r && Rt(e);
                return on(e, t, r ? an(e, n, r, b.support.boxSizing && "border-box" === b.css(e, "boxSizing", !1, i), i) : 0)
            }
        }
    }), b.support.opacity || (b.cssHooks.opacity = {
        get: function(e, t) {
            return It.test((t && e.currentStyle ? e.currentStyle.filter : e.style.filter) || "") ? .01 * parseFloat(RegExp.$1) + "" : t ? "1" : ""
        },
        set: function(e, t) {
            var
                n = e.style,
                r = e.currentStyle,
                i = b.isNumeric(t) ? "alpha(opacity=" + 100 * t + ")" : "",
                o = r && r.filter || n.filter || "";
            n.zoom = 1, (t >= 1 || "" === t) && "" === b.trim(o.replace($t, "")) && n.removeAttribute && (n.removeAttribute("filter"), "" === t || r && !r.filter) || (n.filter = $t.test(o) ? o.replace($t, i) : o + " " + i)
        }
    }), b(function() {
        b.support.reliableMarginRight || (b.cssHooks.marginRight = {
            get: function(e, n) {
                return n ? b.swap(e, {
                    display: "inline-block"
                }, Wt, [e, "marginRight"]) : t
            }
        }), !b.support.pixelPosition && b.fn.position && b.each(["top", "left"], function(e, n) {
            b.cssHooks[n] = {
                get: function(e, r) {
                    return r ? (r = Wt(e, n), Yt.test(r) ? b(e).position()[n] + "px" : r) : t
                }
            }
        })
    }), b.expr && b.expr.filters && (b.expr.filters.hidden = function(e) {
        return 0 >= e.offsetWidth && 0 >= e.offsetHeight || !b.support.reliableHiddenOffsets && "none" === (e.style && e.style.display || b.css(e, "display"))
    }, b.expr.filters.visible = function(e) {
        return !b.expr.filters.hidden(e)
    }), b.each({
        margin: "",
        padding: "",
        border: "Width"
    }, function(e, t) {
        b.cssHooks[e + t] = {
            expand: function(n) {
                var
                    r = 0,
                    i = {},
                    o = "string" == typeof
                n ? n.split(" ") : [n];
                for (; 4 > r; r++) i[e + Zt[r] + t] = o[r] || o[r - 2] || o[0];
                return i
            }
        }, Ut.test(e) || (b.cssHooks[e + t].set = on)
    });
    var
        cn = /%20/g,
        pn = /\[\]$/,
        fn = /\r?\n/g,
        dn = /^(?:submit|button|image|reset|file)$/i,
        hn = /^(?:input|select|textarea|keygen)/i;
    b.fn.extend({
        serialize: function() {
            return b.param(this.serializeArray())
        },
        serializeArray: function() {
            return this.map(function() {
                var
                    e = b.prop(this, "elements");
                return e ? b.makeArray(e) : this
            }).filter(function() {
                var
                    e = this.type;
                return this.name && !b(this).is(":disabled") && hn.test(this.nodeName) && !dn.test(e) && (this.checked || !Nt.test(e))
            }).map(function(e, t) {
                var
                    n = b(this).val();
                return null == n ? null : b.isArray(n) ? b.map(n, function(e) {
                    return {
                        name: t.name,
                        value: e.replace(fn, "\r\n")
                    }
                }) : {
                    name: t.name,
                    value: n.replace(fn, "\r\n")
                }
            }).get()
        }
    }), b.param = function(e, n) {
        var
            r, i = [],
            o = function(e, t) {
                t = b.isFunction(t) ? t() : null == t ? "" : t, i[i.length] = encodeURIComponent(e) + "=" + encodeURIComponent(t)
            };
        if (n === t && (n = b.ajaxSettings && b.ajaxSettings.traditional), b.isArray(e) || e.jquery && !b.isPlainObject(e)) b.each(e, function() {
            o(this.name, this.value)
        });
        else
            for (r in
                e) gn(r, e[r], n, o);
        return i.join("&").replace(cn, "+")
    };

    function
    gn(e, t, n, r) {
        var
            i;
        if (b.isArray(t)) b.each(t, function(t, i) {
            n || pn.test(e) ? r(e, i) : gn(e + "[" + ("object" == typeof i ? t : "") + "]", i, n, r)
        });
        else
        if (n || "object" !== b.type(t)) r(e, t);
        else
            for (i in
                t) gn(e + "[" + i + "]", t[i], n, r)
    }
    b.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "), function(e, t) {
        b.fn[t] = function(e, n) {
            return arguments.length > 0 ? this.on(t, null, e, n) : this.trigger(t)
        }
    }), b.fn.hover = function(e, t) {
        return this.mouseenter(e).mouseleave(t || e)
    };
    var
        mn, yn, vn = b.now(),
        bn = /\?/,
        xn = /#.*$/,
        wn = /([?&])_=[^&]*/,
        Tn = /^(.*?):[ \t]*([^\r\n]*)\r?$/gm,
        Nn = /^(?:about|app|app-storage|.+-extension|file|res|widget):$/,
        Cn = /^(?:GET|HEAD)$/,
        kn = /^\/\//,
        En = /^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,
        Sn = b.fn.load,
        An = {},
        jn = {},
        Dn = "*/".concat("*");
    try {
        yn = a.href
    } catch (Ln) {
        yn = o.createElement("a"), yn.href = "", yn = yn.href
    }
    mn = En.exec(yn.toLowerCase()) || [];

    function
    Hn(e) {
        return function(t, n) {
            "string" != typeof
            t && (n = t, t = "*");
            var
                r, i = 0,
                o = t.toLowerCase().match(w) || [];
            if (b.isFunction(n))
                while (r = o[i++]) "+" === r[0] ? (r = r.slice(1) || "*", (e[r] = e[r] || []).unshift(n)) : (e[r] = e[r] || []).push(n)
        }
    }

    function
    qn(e, n, r, i) {
        var
            o = {},
            a = e === jn;

        function
        s(u) {
            var
                l;
            return o[u] = !0, b.each(e[u] || [], function(e, u) {
                var
                    c = u(n, r, i);
                return "string" != typeof
                c || a || o[c] ? a ? !(l = c) : t : (n.dataTypes.unshift(c), s(c), !1)
            }), l
        }
        return s(n.dataTypes[0]) || !o["*"] && s("*")
    }

    function
    Mn(e, n) {
        var
            r, i, o = b.ajaxSettings.flatOptions || {};
        for (i in
            n) n[i] !== t && ((o[i] ? e : r || (r = {}))[i] = n[i]);
        return r && b.extend(!0, e, r), e
    }
    b.fn.load = function(e, n, r) {
        if ("string" != typeof e && Sn) return Sn.apply(this, arguments);
        var
            i, o, a, s = this,
            u = e.indexOf(" ");
        return u >= 0 && (i = e.slice(u, e.length), e = e.slice(0, u)), b.isFunction(n) ? (r = n, n = t) : n && "object" == typeof
        n && (a = "POST"), s.length > 0 && b.ajax({
            url: e,
            type: a,
            dataType: "html",
            data: n
        }).done(function(e) {
            o = arguments, s.html(i ? b("<div>").append(b.parseHTML(e)).find(i) : e)
        }).complete(r && function(e, t) {
            s.each(r, o || [e.responseText, t, e])
        }), this
    }, b.each(["ajaxStart", "ajaxStop", "ajaxComplete", "ajaxError", "ajaxSuccess", "ajaxSend"], function(e, t) {
        b.fn[t] = function(e) {
            return this.on(t, e)
        }
    }), b.each(["get", "post"], function(e, n) {
        b[n] = function(e, r, i, o) {
            return b.isFunction(r) && (o = o || i, i = r, r = t), b.ajax({
                url: e,
                type: n,
                dataType: o,
                data: r,
                success: i
            })
        }
    }), b.extend({
        active: 0,
        lastModified: {},
        etag: {},
        ajaxSettings: {
            url: yn,
            type: "GET",
            isLocal: Nn.test(mn[1]),
            global: !0,
            processData: !0,
            async: !0,
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            accepts: {
                "*": Dn,
                text: "text/plain",
                html: "text/html",
                xml: "application/xml, text/xml",
                json: "application/json, text/javascript"
            },
            contents: {
                xml: /xml/,
                html: /html/,
                json: /json/
            },
            responseFields: {
                xml: "responseXML",
                text: "responseText"
            },
            converters: {
                "* text": e.String,
                "text html": !0,
                "text json": b.parseJSON,
                "text xml": b.parseXML
            },
            flatOptions: {
                url: !0,
                context: !0
            }
        },
        ajaxSetup: function(e, t) {
            return t ? Mn(Mn(e, b.ajaxSettings), t) : Mn(b.ajaxSettings, e)
        },
        ajaxPrefilter: Hn(An),
        ajaxTransport: Hn(jn),
        ajax: function(e, n) {
            "object" == typeof
            e && (n = e, e = t), n = n || {};
            var
                r, i, o, a, s, u, l, c, p = b.ajaxSetup({}, n),
                f = p.context || p,
                d = p.context && (f.nodeType || f.jquery) ? b(f) : b.event,
                h = b.Deferred(),
                g = b.Callbacks("once memory"),
                m = p.statusCode || {},
                y = {},
                v = {},
                x = 0,
                T = "canceled",
                N = {
                    readyState: 0,
                    getResponseHeader: function(e) {
                        var
                            t;
                        if (2 === x) {
                            if (!c) {
                                c = {};
                                while (t = Tn.exec(a)) c[t[1].toLowerCase()] = t[2]
                            }
                            t = c[e.toLowerCase()]
                        }
                        return null == t ? null : t
                    },
                    getAllResponseHeaders: function() {
                        return 2 === x ? a : null
                    },
                    setRequestHeader: function(e, t) {
                        var
                            n = e.toLowerCase();
                        return x || (e = v[n] = v[n] || e, y[e] = t), this
                    },
                    overrideMimeType: function(e) {
                        return x || (p.mimeType = e), this
                    },
                    statusCode: function(e) {
                        var
                            t;
                        if (e)
                            if (2 > x)
                                for (t in
                                    e) m[t] = [m[t], e[t]];
                            else
                                N.always(e[N.status]);
                        return this
                    },
                    abort: function(e) {
                        var
                            t = e || T;
                        return l && l.abort(t), k(0, t), this
                    }
                };
            if (h.promise(N).complete = g.add, N.success = N.done, N.error = N.fail, p.url = ((e || p.url || yn) + "").replace(xn, "").replace(kn, mn[1] + "//"), p.type = n.method || n.type || p.method || p.type, p.dataTypes = b.trim(p.dataType || "*").toLowerCase().match(w) || [""], null == p.crossDomain && (r = En.exec(p.url.toLowerCase()), p.crossDomain = !(!r || r[1] === mn[1] && r[2] === mn[2] && (r[3] || ("http:" === r[1] ? 80 : 443)) == (mn[3] || ("http:" === mn[1] ? 80 : 443)))), p.data && p.processData && "string" != typeof p.data && (p.data = b.param(p.data, p.traditional)), qn(An, p, n, N), 2 === x) return N;
            u = p.global, u && 0 === b.active++ && b.event.trigger("ajaxStart"), p.type = p.type.toUpperCase(), p.hasContent = !Cn.test(p.type), o = p.url, p.hasContent || (p.data && (o = p.url += (bn.test(o) ? "&" : "?") + p.data, delete p.data), p.cache === !1 && (p.url = wn.test(o) ? o.replace(wn, "$1_=" + vn++) : o + (bn.test(o) ? "&" : "?") + "_=" + vn++)), p.ifModified && (b.lastModified[o] && N.setRequestHeader("If-Modified-Since", b.lastModified[o]), b.etag[o] && N.setRequestHeader("If-None-Match", b.etag[o])), (p.data && p.hasContent && p.contentType !== !1 || n.contentType) && N.setRequestHeader("Content-Type", p.contentType), N.setRequestHeader("Accept", p.dataTypes[0] && p.accepts[p.dataTypes[0]] ? p.accepts[p.dataTypes[0]] + ("*" !== p.dataTypes[0] ? ", " + Dn + "; q=0.01" : "") : p.accepts["*"]);
            for (i in
                p.headers) N.setRequestHeader(i, p.headers[i]);
            if (p.beforeSend && (p.beforeSend.call(f, N, p) === !1 || 2 === x)) return N.abort();
            T = "abort";
            for (i in {
                    success: 1,
                    error: 1,
                    complete: 1
                }) N[i](p[i]);
            if (l = qn(jn, p, n, N)) {
                N.readyState = 1, u && d.trigger("ajaxSend", [N, p]), p.async && p.timeout > 0 && (s = setTimeout(function() {
                    N.abort("timeout")
                }, p.timeout));
                try {
                    x = 1, l.send(y, k)
                } catch (C) {
                    if (!(2 > x)) throw C;
                    k(-1, C)
                }
            } else
                k(-1, "No Transport");

            function
            k(e, n, r, i) {
                var
                    c, y, v, w, T, C = n;
                2 !== x && (x = 2, s && clearTimeout(s), l = t, a = i || "", N.readyState = e > 0 ? 4 : 0, r && (w = _n(p, N, r)), e >= 200 && 300 > e || 304 === e ? (p.ifModified && (T = N.getResponseHeader("Last-Modified"), T && (b.lastModified[o] = T), T = N.getResponseHeader("etag"), T && (b.etag[o] = T)), 204 === e ? (c = !0, C = "nocontent") : 304 === e ? (c = !0, C = "notmodified") : (c = Fn(p, w), C = c.state, y = c.data, v = c.error, c = !v)) : (v = C, (e || !C) && (C = "error", 0 > e && (e = 0))), N.status = e, N.statusText = (n || C) + "", c ? h.resolveWith(f, [y, C, N]) : h.rejectWith(f, [N, C, v]), N.statusCode(m), m = t, u && d.trigger(c ? "ajaxSuccess" : "ajaxError", [N, p, c ? y : v]), g.fireWith(f, [N, C]), u && (d.trigger("ajaxComplete", [N, p]), --b.active || b.event.trigger("ajaxStop")))
            }
            return N
        },
        getScript: function(e, n) {
            return b.get(e, t, n, "script")
        },
        getJSON: function(e, t, n) {
            return b.get(e, t, n, "json")
        }
    });

    function
    _n(e, n, r) {
        var
            i, o, a, s, u = e.contents,
            l = e.dataTypes,
            c = e.responseFields;
        for (s in
            c) s in
            r && (n[c[s]] = r[s]);
        while ("*" === l[0]) l.shift(), o === t && (o = e.mimeType || n.getResponseHeader("Content-Type"));
        if (o)
            for (s in
                u)
                if (u[s] && u[s].test(o)) {
                    l.unshift(s);
                    break
                }
        if (l[0] in
            r) a = l[0];
        else {
            for (s in
                r) {
                if (!l[0] || e.converters[s + " " + l[0]]) {
                    a = s;
                    break
                }
                i || (i = s)
            }
            a = a || i
        }
        return a ? (a !== l[0] && l.unshift(a), r[a]) : t
    }

    function
    Fn(e, t) {
        var
            n, r, i, o, a = {},
            s = 0,
            u = e.dataTypes.slice(),
            l = u[0];
        if (e.dataFilter && (t = e.dataFilter(t, e.dataType)), u[1])
            for (i in
                e.converters) a[i.toLowerCase()] = e.converters[i];
        for (; r = u[++s];)
            if ("*" !== r) {
                if ("*" !== l && l !== r) {
                    if (i = a[l + " " + r] || a["* " + r], !i)
                        for (n in
                            a)
                            if (o = n.split(" "), o[1] === r && (i = a[l + " " + o[0]] || a["* " + o[0]])) {
                                i === !0 ? i = a[n] : a[n] !== !0 && (r = o[0], u.splice(s--, 0, r));
                                break
                            }
                    if (i !== !0)
                        if (i && e["throws"]) t = i(t);
                        else
                            try {
                                t = i(t)
                            } catch (c) {
                                return {
                                    state: "parsererror",
                                    error: i ? c : "No conversion from " + l + " to " + r
                                }
                            }
                }
                l = r
            }
        return {
            state: "success",
            data: t
        }
    }
    b.ajaxSetup({
        accepts: {
            script: "text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"
        },
        contents: {
            script: /(?:java|ecma)script/
        },
        converters: {
            "text script": function(e) {
                return b.globalEval(e), e
            }
        }
    }), b.ajaxPrefilter("script", function(e) {
        e.cache === t && (e.cache = !1), e.crossDomain && (e.type = "GET", e.global = !1)
    }), b.ajaxTransport("script", function(e) {
        if (e.crossDomain) {
            var
                n, r = o.head || b("head")[0] || o.documentElement;
            return {
                send: function(t, i) {
                    n = o.createElement("script"), n.async = !0, e.scriptCharset && (n.charset = e.scriptCharset), n.src = e.url, n.onload = n.onreadystatechange = function(e, t) {
                        (t || !n.readyState || /loaded|complete/.test(n.readyState)) && (n.onload = n.onreadystatechange = null, n.parentNode && n.parentNode.removeChild(n), n = null, t || i(200, "success"))
                    }, r.insertBefore(n, r.firstChild)
                },
                abort: function() {
                    n && n.onload(t, !0)
                }
            }
        }
    });
    var
        On = [],
        Bn = /(=)\?(?=&|$)|\?\?/;
    b.ajaxSetup({
        jsonp: "callback",
        jsonpCallback: function() {
            var
                e = On.pop() || b.expando + "_" + vn++;
            return this[e] = !0, e
        }
    }), b.ajaxPrefilter("json jsonp", function(n, r, i) {
        var
            o, a, s, u = n.jsonp !== !1 && (Bn.test(n.url) ? "url" : "string" == typeof n.data && !(n.contentType || "").indexOf("application/x-www-form-urlencoded") && Bn.test(n.data) && "data");
        return u || "jsonp" === n.dataTypes[0] ? (o = n.jsonpCallback = b.isFunction(n.jsonpCallback) ? n.jsonpCallback() : n.jsonpCallback, u ? n[u] = n[u].replace(Bn, "$1" + o) : n.jsonp !== !1 && (n.url += (bn.test(n.url) ? "&" : "?") + n.jsonp + "=" + o), n.converters["script json"] = function() {
            return s || b.error(o + " was not called"), s[0]
        }, n.dataTypes[0] = "json", a = e[o], e[o] = function() {
            s = arguments
        }, i.always(function() {
            e[o] = a, n[o] && (n.jsonpCallback = r.jsonpCallback, On.push(o)), s && b.isFunction(a) && a(s[0]), s = a = t
        }), "script") : t
    });
    var
        Pn, Rn, Wn = 0,
        $n = e.ActiveXObject && function() {
            var
                e;
            for (e in
                Pn) Pn[e](t, !0)
        };

    function
    In() {
        try {
            return new
            e.XMLHttpRequest
        } catch (t) {}
    }

    function
    zn() {
        try {
            return new
            e.ActiveXObject("Microsoft.XMLHTTP")
        } catch (t) {}
    }
    b.ajaxSettings.xhr = e.ActiveXObject ? function() {
            return !this.isLocal && In() || zn()
        } : In, Rn = b.ajaxSettings.xhr(), b.support.cors = !!Rn && "withCredentials" in
        Rn, Rn = b.support.ajax = !!Rn, Rn && b.ajaxTransport(function(n) {
            if (!n.crossDomain || b.support.cors) {
                var
                    r;
                return {
                    send: function(i, o) {
                        var
                            a, s, u = n.xhr();
                        if (n.username ? u.open(n.type, n.url, n.async, n.username, n.password) : u.open(n.type, n.url, n.async), n.xhrFields)
                            for (s in
                                n.xhrFields) u[s] = n.xhrFields[s];
                        n.mimeType && u.overrideMimeType && u.overrideMimeType(n.mimeType), n.crossDomain || i["X-Requested-With"] || (i["X-Requested-With"] = "XMLHttpRequest");
                        try {
                            for (s in
                                i) u.setRequestHeader(s, i[s])
                        } catch (l) {}
                        u.send(n.hasContent && n.data || null), r = function(e, i) {
                            var
                                s, l, c, p;
                            try {
                                if (r && (i || 4 === u.readyState))
                                    if (r = t, a && (u.onreadystatechange = b.noop, $n && delete Pn[a]), i) 4 !== u.readyState && u.abort();
                                    else {
                                        p = {}, s = u.status, l = u.getAllResponseHeaders(), "string" == typeof
                                        u.responseText && (p.text = u.responseText);
                                        try {
                                            c = u.statusText
                                        } catch (f) {
                                            c = ""
                                        }
                                        s || !n.isLocal || n.crossDomain ? 1223 === s && (s = 204) : s = p.text ? 200 : 404
                                    }
                            } catch (d) {
                                i || o(-1, d)
                            }
                            p && o(s, c, p, l)
                        }, n.async ? 4 === u.readyState ? setTimeout(r) : (a = ++Wn, $n && (Pn || (Pn = {}, b(e).unload($n)), Pn[a] = r), u.onreadystatechange = r) : r()
                    },
                    abort: function() {
                        r && r(t, !0)
                    }
                }
            }
        });
    var
        Xn, Un, Vn = /^(?:toggle|show|hide)$/,
        Yn = RegExp("^(?:([+-])=|)(" + x + ")([a-z%]*)$", "i"),
        Jn = /queueHooks$/,
        Gn = [nr],
        Qn = {
            "*": [function(e, t) {
                var
                    n, r, i = this.createTween(e, t),
                    o = Yn.exec(t),
                    a = i.cur(),
                    s = +a || 0,
                    u = 1,
                    l = 20;
                if (o) {
                    if (n = +o[2], r = o[3] || (b.cssNumber[e] ? "" : "px"), "px" !== r && s) {
                        s = b.css(i.elem, e, !0) || n || 1;
                        do
                            u = u || ".5", s /= u, b.style(i.elem, e, s + r); while (u !== (u = i.cur() / a) && 1 !== u && --l)
                    }
                    i.unit = r, i.start = s, i.end = o[1] ? s + (o[1] + 1) * n : n
                }
                return i
            }]
        };

    function
    Kn() {
        return setTimeout(function() {
            Xn = t
        }), Xn = b.now()
    }

    function
    Zn(e, t) {
        b.each(t, function(t, n) {
            var
                r = (Qn[t] || []).concat(Qn["*"]),
                i = 0,
                o = r.length;
            for (; o > i; i++)
                if (r[i].call(e, t, n)) return
        })
    }

    function
    er(e, t, n) {
        var
            r, i, o = 0,
            a = Gn.length,
            s = b.Deferred().always(function() {
                delete
                u.elem
            }),
            u = function() {
                if (i) return !1;
                var
                    t = Xn || Kn(),
                    n = Math.max(0, l.startTime + l.duration - t),
                    r = n / l.duration || 0,
                    o = 1 - r,
                    a = 0,
                    u = l.tweens.length;
                for (; u > a; a++) l.tweens[a].run(o);
                return s.notifyWith(e, [l, o, n]), 1 > o && u ? n : (s.resolveWith(e, [l]), !1)
            },
            l = s.promise({
                elem: e,
                props: b.extend({}, t),
                opts: b.extend(!0, {
                    specialEasing: {}
                }, n),
                originalProperties: t,
                originalOptions: n,
                startTime: Xn || Kn(),
                duration: n.duration,
                tweens: [],
                createTween: function(t, n) {
                    var
                        r = b.Tween(e, l.opts, t, n, l.opts.specialEasing[t] || l.opts.easing);
                    return l.tweens.push(r), r
                },
                stop: function(t) {
                    var
                        n = 0,
                        r = t ? l.tweens.length : 0;
                    if (i) return this;
                    for (i = !0; r > n; n++) l.tweens[n].run(1);
                    return t ? s.resolveWith(e, [l, t]) : s.rejectWith(e, [l, t]), this
                }
            }),
            c = l.props;
        for (tr(c, l.opts.specialEasing); a > o; o++)
            if (r = Gn[o].call(l, e, c, l.opts)) return r;
        return Zn(l, c), b.isFunction(l.opts.start) && l.opts.start.call(e, l), b.fx.timer(b.extend(u, {
            elem: e,
            anim: l,
            queue: l.opts.queue
        })), l.progress(l.opts.progress).done(l.opts.done, l.opts.complete).fail(l.opts.fail).always(l.opts.always)
    }

    function
    tr(e, t) {
        var
            n, r, i, o, a;
        for (i in
            e)
            if (r = b.camelCase(i), o = t[r], n = e[i], b.isArray(n) && (o = n[1], n = e[i] = n[0]), i !== r && (e[r] = n, delete e[i]), a = b.cssHooks[r], a && "expand" in
                a) {
                n = a.expand(n), delete
                e[r];
                for (i in
                    n) i in
                    e || (e[i] = n[i], t[i] = o)
            } else
                t[r] = o
    }
    b.Animation = b.extend(er, {
        tweener: function(e, t) {
            b.isFunction(e) ? (t = e, e = ["*"]) : e = e.split(" ");
            var
                n, r = 0,
                i = e.length;
            for (; i > r; r++) n = e[r], Qn[n] = Qn[n] || [], Qn[n].unshift(t)
        },
        prefilter: function(e, t) {
            t ? Gn.unshift(e) : Gn.push(e)
        }
    });

    function
    nr(e, t, n) {
        var
            r, i, o, a, s, u, l, c, p, f = this,
            d = e.style,
            h = {},
            g = [],
            m = e.nodeType && nn(e);
        n.queue || (c = b._queueHooks(e, "fx"), null == c.unqueued && (c.unqueued = 0, p = c.empty.fire, c.empty.fire = function() {
            c.unqueued || p()
        }), c.unqueued++, f.always(function() {
            f.always(function() {
                c.unqueued--, b.queue(e, "fx").length || c.empty.fire()
            })
        })), 1 === e.nodeType && ("height" in
            t || "width" in
            t) && (n.overflow = [d.overflow, d.overflowX, d.overflowY], "inline" === b.css(e, "display") && "none" === b.css(e, "float") && (b.support.inlineBlockNeedsLayout && "inline" !== un(e.nodeName) ? d.zoom = 1 : d.display = "inline-block")), n.overflow && (d.overflow = "hidden", b.support.shrinkWrapBlocks || f.always(function() {
            d.overflow = n.overflow[0], d.overflowX = n.overflow[1], d.overflowY = n.overflow[2]
        }));
        for (i in
            t)
            if (a = t[i], Vn.exec(a)) {
                if (delete t[i], u = u || "toggle" === a, a === (m ? "hide" : "show")) continue;
                g.push(i)
            }
        if (o = g.length) {
            s = b._data(e, "fxshow") || b._data(e, "fxshow", {}), "hidden" in
                s && (m = s.hidden), u && (s.hidden = !m), m ? b(e).show() : f.done(function() {
                    b(e).hide()
                }), f.done(function() {
                    var
                        t;
                    b._removeData(e, "fxshow");
                    for (t in
                        h) b.style(e, t, h[t])
                });
            for (i = 0; o > i; i++) r = g[i], l = f.createTween(r, m ? s[r] : 0), h[r] = s[r] || b.style(e, r), r in
                s || (s[r] = l.start, m && (l.end = l.start, l.start = "width" === r || "height" === r ? 1 : 0))
        }
    }

    function
    rr(e, t, n, r, i) {
        return new
        rr.prototype.init(e, t, n, r, i)
    }
    b.Tween = rr, rr.prototype = {
        constructor: rr,
        init: function(e, t, n, r, i, o) {
            this.elem = e, this.prop = n, this.easing = i || "swing", this.options = t, this.start = this.now = this.cur(), this.end = r, this.unit = o || (b.cssNumber[n] ? "" : "px")
        },
        cur: function() {
            var
                e = rr.propHooks[this.prop];
            return e && e.get ? e.get(this) : rr.propHooks._default.get(this)
        },
        run: function(e) {
            var
                t, n = rr.propHooks[this.prop];
            return this.pos = t = this.options.duration ? b.easing[this.easing](e, this.options.duration * e, 0, 1, this.options.duration) : e, this.now = (this.end - this.start) * t + this.start, this.options.step && this.options.step.call(this.elem, this.now, this), n && n.set ? n.set(this) : rr.propHooks._default.set(this), this
        }
    }, rr.prototype.init.prototype = rr.prototype, rr.propHooks = {
        _default: {
            get: function(e) {
                var
                    t;
                return null == e.elem[e.prop] || e.elem.style && null != e.elem.style[e.prop] ? (t = b.css(e.elem, e.prop, ""), t && "auto" !== t ? t : 0) : e.elem[e.prop]
            },
            set: function(e) {
                b.fx.step[e.prop] ? b.fx.step[e.prop](e) : e.elem.style && (null != e.elem.style[b.cssProps[e.prop]] || b.cssHooks[e.prop]) ? b.style(e.elem, e.prop, e.now + e.unit) : e.elem[e.prop] = e.now
            }
        }
    }, rr.propHooks.scrollTop = rr.propHooks.scrollLeft = {
        set: function(e) {
            e.elem.nodeType && e.elem.parentNode && (e.elem[e.prop] = e.now)
        }
    }, b.each(["toggle", "show", "hide"], function(e, t) {
        var
            n = b.fn[t];
        b.fn[t] = function(e, r, i) {
            return null == e || "boolean" == typeof
            e ? n.apply(this, arguments) : this.animate(ir(t, !0), e, r, i)
        }
    }), b.fn.extend({
        fadeTo: function(e, t, n, r) {
            return this.filter(nn).css("opacity", 0).show().end().animate({
                opacity: t
            }, e, n, r)
        },
        animate: function(e, t, n, r) {
            var
                i = b.isEmptyObject(e),
                o = b.speed(t, n, r),
                a = function() {
                    var
                        t = er(this, b.extend({}, e), o);
                    a.finish = function() {
                        t.stop(!0)
                    }, (i || b._data(this, "finish")) && t.stop(!0)
                };
            return a.finish = a, i || o.queue === !1 ? this.each(a) : this.queue(o.queue, a)
        },
        stop: function(e, n, r) {
            var
                i = function(e) {
                    var
                        t = e.stop;
                    delete
                    e.stop, t(r)
                };
            return "string" != typeof
            e && (r = n, n = e, e = t), n && e !== !1 && this.queue(e || "fx", []), this.each(function() {
                var
                    t = !0,
                    n = null != e && e + "queueHooks",
                    o = b.timers,
                    a = b._data(this);
                if (n) a[n] && a[n].stop && i(a[n]);
                else
                    for (n in
                        a) a[n] && a[n].stop && Jn.test(n) && i(a[n]);
                for (n = o.length; n--;) o[n].elem !== this || null != e && o[n].queue !== e || (o[n].anim.stop(r), t = !1, o.splice(n, 1));
                (t || !r) && b.dequeue(this, e)
            })
        },
        finish: function(e) {
            return e !== !1 && (e = e || "fx"), this.each(function() {
                var
                    t, n = b._data(this),
                    r = n[e + "queue"],
                    i = n[e + "queueHooks"],
                    o = b.timers,
                    a = r ? r.length : 0;
                for (n.finish = !0, b.queue(this, e, []), i && i.cur && i.cur.finish && i.cur.finish.call(this), t = o.length; t--;) o[t].elem === this && o[t].queue === e && (o[t].anim.stop(!0), o.splice(t, 1));
                for (t = 0; a > t; t++) r[t] && r[t].finish && r[t].finish.call(this);
                delete
                n.finish
            })
        }
    });

    function
    ir(e, t) {
        var
            n, r = {
                height: e
            },
            i = 0;
        for (t = t ? 1 : 0; 4 > i; i += 2 - t) n = Zt[i], r["margin" + n] = r["padding" + n] = e;
        return t && (r.opacity = r.width = e), r
    }
    b.each({
        slideDown: ir("show"),
        slideUp: ir("hide"),
        slideToggle: ir("toggle"),
        fadeIn: {
            opacity: "show"
        },
        fadeOut: {
            opacity: "hide"
        },
        fadeToggle: {
            opacity: "toggle"
        }
    }, function(e, t) {
        b.fn[e] = function(e, n, r) {
            return this.animate(t, e, n, r)
        }
    }), b.speed = function(e, t, n) {
        var
            r = e && "object" == typeof
        e ? b.extend({}, e) : {
            complete: n || !n && t || b.isFunction(e) && e,
            duration: e,
            easing: n && t || t && !b.isFunction(t) && t
        };
        return r.duration = b.fx.off ? 0 : "number" == typeof
        r.duration ? r.duration : r.duration in
            b.fx.speeds ? b.fx.speeds[r.duration] : b.fx.speeds._default, (null == r.queue || r.queue === !0) && (r.queue = "fx"), r.old = r.complete, r.complete = function() {
                b.isFunction(r.old) && r.old.call(this), r.queue && b.dequeue(this, r.queue)
            }, r
    }, b.easing = {
        linear: function(e) {
            return e
        },
        swing: function(e) {
            return .5 - Math.cos(e * Math.PI) / 2
        }
    }, b.timers = [], b.fx = rr.prototype.init, b.fx.tick = function() {
        var
            e, n = b.timers,
            r = 0;
        for (Xn = b.now(); n.length > r; r++) e = n[r], e() || n[r] !== e || n.splice(r--, 1);
        n.length || b.fx.stop(), Xn = t
    }, b.fx.timer = function(e) {
        e() && b.timers.push(e) && b.fx.start()
    }, b.fx.interval = 13, b.fx.start = function() {
        Un || (Un = setInterval(b.fx.tick, b.fx.interval))
    }, b.fx.stop = function() {
        clearInterval(Un), Un = null
    }, b.fx.speeds = {
        slow: 600,
        fast: 200,
        _default: 400
    }, b.fx.step = {}, b.expr && b.expr.filters && (b.expr.filters.animated = function(e) {
        return b.grep(b.timers, function(t) {
            return e === t.elem
        }).length
    }), b.fn.offset = function(e) {
        if (arguments.length) return e === t ? this : this.each(function(t) {
            b.offset.setOffset(this, e, t)
        });
        var
            n, r, o = {
                top: 0,
                left: 0
            },
            a = this[0],
            s = a && a.ownerDocument;
        if (s) return n = s.documentElement, b.contains(n, a) ? (typeof a.getBoundingClientRect !== i && (o = a.getBoundingClientRect()), r = or(s), {
            top: o.top + (r.pageYOffset || n.scrollTop) - (n.clientTop || 0),
            left: o.left + (r.pageXOffset || n.scrollLeft) - (n.clientLeft || 0)
        }) : o
    }, b.offset = {
        setOffset: function(e, t, n) {
            var
                r = b.css(e, "position");
            "static" === r && (e.style.position = "relative");
            var
                i = b(e),
                o = i.offset(),
                a = b.css(e, "top"),
                s = b.css(e, "left"),
                u = ("absolute" === r || "fixed" === r) && b.inArray("auto", [a, s]) > -1,
                l = {},
                c = {},
                p, f;
            u ? (c = i.position(), p = c.top, f = c.left) : (p = parseFloat(a) || 0, f = parseFloat(s) || 0), b.isFunction(t) && (t = t.call(e, n, o)), null != t.top && (l.top = t.top - o.top + p), null != t.left && (l.left = t.left - o.left + f), "using" in
                t ? t.using.call(e, l) : i.css(l)
        }
    }, b.fn.extend({
        position: function() {
            if (this[0]) {
                var
                    e, t, n = {
                        top: 0,
                        left: 0
                    },
                    r = this[0];
                return "fixed" === b.css(r, "position") ? t = r.getBoundingClientRect() : (e = this.offsetParent(), t = this.offset(), b.nodeName(e[0], "html") || (n = e.offset()), n.top += b.css(e[0], "borderTopWidth", !0), n.left += b.css(e[0], "borderLeftWidth", !0)), {
                    top: t.top - n.top - b.css(r, "marginTop", !0),
                    left: t.left - n.left - b.css(r, "marginLeft", !0)
                }
            }
        },
        offsetParent: function() {
            return this.map(function() {
                var
                    e = this.offsetParent || o.documentElement;
                while (e && !b.nodeName(e, "html") && "static" === b.css(e, "position")) e = e.offsetParent;
                return e || o.documentElement
            })
        }
    }), b.each({
        scrollLeft: "pageXOffset",
        scrollTop: "pageYOffset"
    }, function(e, n) {
        var
            r = /Y/.test(n);
        b.fn[e] = function(i) {
            return b.access(this, function(e, i, o) {
                var
                    a = or(e);
                return o === t ? a ? n in
                    a ? a[n] : a.document.documentElement[i] : e[i] : (a ? a.scrollTo(r ? b(a).scrollLeft() : o, r ? o : b(a).scrollTop()) : e[i] = o, t)
            }, e, i, arguments.length, null)
        }
    });

    function
    or(e) {
        return b.isWindow(e) ? e : 9 === e.nodeType ? e.defaultView || e.parentWindow : !1
    }
    b.each({
        Height: "height",
        Width: "width"
    }, function(e, n) {
        b.each({
            padding: "inner" + e,
            content: n,
            "": "outer" + e
        }, function(r, i) {
            b.fn[i] = function(i, o) {
                var
                    a = arguments.length && (r || "boolean" != typeof i),
                    s = r || (i === !0 || o === !0 ? "margin" : "border");
                return b.access(this, function(n, r, i) {
                    var
                        o;
                    return b.isWindow(n) ? n.document.documentElement["client" + e] : 9 === n.nodeType ? (o = n.documentElement, Math.max(n.body["scroll" + e], o["scroll" + e], n.body["offset" + e], o["offset" + e], o["client" + e])) : i === t ? b.css(n, r, s) : b.style(n, r, i, s)
                }, n, a ? i : t, a, null)
            }
        })
    }), e.jQuery = e.$ = b, "function" == typeof
    define && define.amd && define.amd.jQuery && define("jquery", [], function() {
        return b
    })
})(window);
(function(factory) {
    if (typeof define === 'function' && define.amd) {
        define(['jquery'], factory);
    } else {
        factory(jQuery);
    }
}(function($) {
    var
        pluses = /\+/g;

    function
    encode(s) {
        return config.raw ? s : encodeURIComponent(s);
    }

    function
    decode(s) {
        return config.raw ? s : decodeURIComponent(s);
    }

    function
    stringifyCookieValue(value) {
        return encode(config.json ? JSON.stringify(value) : String(value));
    }

    function
    parseCookieValue(s) {
        if (s.indexOf('"') === 0) {
            s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, '\\');
        }
        try {
            s = decodeURIComponent(s.replace(pluses, ' '));
            return config.json ? JSON.parse(s) : s;
        } catch (e) {}
    }

    function
    read(s, converter) {
        var
            value = config.raw ? s : parseCookieValue(s);
        return $.isFunction(converter) ? converter(value) : value;
    }
    var
        config = $.cookie = function(key, value, options) {
            if (value !== undefined && !$.isFunction(value)) {
                options = $.extend({}, config.defaults, options);
                if (typeof options.expires === 'number') {
                    var
                        days = options.expires,
                        t = options.expires = new
                    Date();
                    t.setTime(+t + days * 864e+5);
                }
                return (document.cookie = [encode(key), '=', stringifyCookieValue(value), options.expires ? '; expires=' + options.expires.toUTCString() : '', options.path ? '; path=' + options.path : '', options.domain ? '; domain=' + options.domain : '', options.secure ? '; secure' : ''].join(''));
            }
            var
                result = key ? undefined : {};
            var
                cookies = document.cookie ? document.cookie.split('; ') : [];
            for (var
                    i = 0, l = cookies.length; i < l; i++) {
                var
                    parts = cookies[i].split('=');
                var
                    name = decode(parts.shift());
                var
                    cookie = parts.join('=');
                if (key && key === name) {
                    result = read(cookie, value);
                    break;
                }
                if (!key && (cookie = read(cookie)) !== undefined) {
                    result[name] = cookie;
                }
            }
            return result;
        };
    config.defaults = {};
    $.removeCookie = function(key, options) {
        if ($.cookie(key) === undefined) {
            return false;
        }
        $.cookie(key, '', $.extend({}, options, {
            expires: -1
        }));
        return !$.cookie(key);
    };
}));
(function() {
    var
        $, Analyze, Blender, Calculate, Caman, CamanParser, Canvas, Convert, Event, Fiber, Filter, IO, Image, Layer, Log, Module, Pixel, Plugin, Renderer, Root, Store, Util, fs, http, moduleKeywords, slice, vignetteFilters, __indexOf = [].indexOf || function(item) {
            for (var
                    i = 0, l = this.length; i < l; i++) {
                if (i in
                    this && this[i] === item) return i;
            }
            return -1;
        },
        __slice = [].slice,
        __hasProp = {}.hasOwnProperty,
        __bind = function(fn, me) {
            return function() {
                return fn.apply(me, arguments);
            };
        },
        __extends = function(child, parent) {
            for (var
                    key in
                    parent) {
                if (__hasProp.call(parent, key)) child[key] = parent[key];
            }

            function
            ctor() {
                this.constructor = child;
            }
            ctor.prototype = parent.prototype;
            child.prototype = new
            ctor();
            child.__super__ = parent.prototype;
            return child;
        };
    moduleKeywords = ['extended', 'included'];
    Module = (function() {
        function
        Module() {}
        Module["extends"] = function(obj) {
            var
                key, value, _ref;
            for (key in
                obj) {
                value = obj[key];
                if (__indexOf.call(moduleKeywords, key) < 0) {
                    this[key] = value;
                }
            }
            if ((_ref = obj.extended) != null) {
                _ref.apply(this);
            }
            return this;
        };
        Module.includes = function(obj) {
            var
                key, value, _ref;
            for (key in
                obj) {
                value = obj[key];
                if (__indexOf.call(moduleKeywords, key) < 0) {
                    this.prototype[key] = value;
                }
            }
            if ((_ref = obj.included) != null) {
                _ref.apply(this);
            }
            return this;
        };
        Module.delegate = function() {
            var
                args, source, target, _i, _len, _results;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            target = args.pop();
            _results = [];
            for (_i = 0, _len = args.length; _i < _len; _i++) {
                source = args[_i];
                _results.push(this.prototype[source] = target.prototype[source]);
            }
            return _results;
        };
        Module.aliasFunction = function(to, from) {
            var
                _this = this;
            return this.prototype[to] = function() {
                var
                    args;
                args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
                return _this.prototype[from].apply(_this, args);
            };
        };
        Module.aliasProperty = function(to, from) {
            return Object.defineProperty(this.prototype, to, {
                get: function() {
                    return this[from];
                },
                set: function(val) {
                    return this[from] = val;
                }
            });
        };
        Module.included = function(func) {
            return func.call(this, this.prototype);
        };
        return Module;
    })();
    slice = Array.prototype.slice;
    $ = function(sel, root) {
        if (root == null) {
            root = document;
        }
        if (typeof sel === "object" || (typeof exports !== "undefined" && exports !== null)) {
            return sel;
        }
        return root.querySelector(sel);
    };
    Util = (function() {
        function
        Util() {}
        Util.uniqid = (function() {
            var
                id;
            id = 0;
            return {
                get: function() {
                    return id++;
                }
            };
        })();
        Util.extend = function() {
            var
                copy, dest, obj, prop, src, _i, _len;
            obj = arguments[0], src = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
            dest = obj;
            for (_i = 0, _len = src.length; _i < _len; _i++) {
                copy = src[_i];
                for (prop in
                    copy) {
                    if (!__hasProp.call(copy, prop)) continue;
                    dest[prop] = copy[prop];
                }
            }
            return dest;
        };
        Util.clampRGB = function(val) {
            if (val < 0) {
                return 0;
            }
            if (val > 255) {
                return 255;
            }
            return val;
        };
        Util.copyAttributes = function(from, to, opts) {
            var
                attr, _i, _len, _ref, _ref1, _results;
            if (opts == null) {
                opts = {};
            }
            _ref = from.attributes;
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                attr = _ref[_i];
                if ((opts.except != null) && (_ref1 = attr.nodeName, __indexOf.call(opts.except, _ref1) >= 0)) {
                    continue;
                }
                _results.push(to.setAttribute(attr.nodeName, attr.nodeValue));
            }
            return _results;
        };
        Util.dataArray = function(length) {
            if (length == null) {
                length = 0;
            }
            if (Caman.NodeJS || (window.Uint8Array != null)) {
                return new
                Uint8Array(length);
            }
            return new
            Array(length);
        };
        return Util;
    })();
    if (typeof exports !== "undefined" && exports !== null) {
        Root = exports;
        Canvas = require('canvas');
        Image = Canvas.Image;
        Fiber = require('fibers');
        fs = require('fs');
        http = require('http');
    } else {
        Root = window;
    }
    Caman = (function(_super) {
        __extends(Caman, _super);
        Caman.version = {
            release: "4.1.2",
            date: "7/27/2013"
        };
        Caman.DEBUG = false;
        Caman.allowRevert = true;
        Caman.crossOrigin = "anonymous";
        Caman.remoteProxy = "";
        Caman.proxyParam = "camanProxyUrl";
        Caman.NodeJS = typeof
        exports !== "undefined" && exports !== null;
        Caman.autoload = !Caman.NodeJS;
        Caman.toString = function() {
            return "Version " + Caman.version.release + ", Released " + Caman.version.date;
        };
        Caman.getAttrId = function(canvas) {
            if (Caman.NodeJS) {
                return true;
            }
            if (typeof canvas === "string") {
                canvas = $(canvas);
            }
            if (!((canvas != null) && (canvas.getAttribute != null))) {
                return null;
            }
            return canvas.getAttribute('data-caman-id');
        };

        function
        Caman() {
            this.nodeFileReady = __bind(this.nodeFileReady, this);
            var
                args, callback, id, _this = this;
            if (arguments.length === 0) {
                throw "Invalid arguments";
            }
            if (this instanceof Caman) {
                this.finishInit = this.finishInit.bind(this);
                this.imageLoaded = this.imageLoaded.bind(this);
                args = arguments[0];
                if (!Caman.NodeJS) {
                    id = parseInt(Caman.getAttrId(args[0]), 10);
                    callback = typeof
                    args[1] === "function" ? args[1] : typeof
                    args[2] === "function" ? args[2] : function() {};
                    if (!isNaN(id) && Store.has(id)) {
                        return Store.execute(id, callback);
                    }
                }
                this.id = Util.uniqid.get();
                this.initializedPixelData = this.originalPixelData = null;
                this.cropCoordinates = {
                    x: 0,
                    y: 0
                };
                this.cropped = false;
                this.resized = false;
                this.pixelStack = [];
                this.layerStack = [];
                this.canvasQueue = [];
                this.currentLayer = null;
                this.scaled = false;
                this.analyze = new
                Analyze(this);
                this.renderer = new
                Renderer(this);
                this.domIsLoaded(function() {
                    _this.parseArguments(args);
                    return _this.setup();
                });
                return this;
            } else {
                return new
                Caman(arguments);
            }
        }
        Caman.prototype.domIsLoaded = function(cb) {
            var
                listener, _this = this;
            if (Caman.NodeJS) {
                return setTimeout(function() {
                    return cb.call(_this);
                }, 0);
            } else {
                if (document.readyState === "complete") {
                    Log.debug("DOM initialized");
                    return setTimeout(function() {
                        return cb.call(_this);
                    }, 0);
                } else {
                    listener = function() {
                        if (document.readyState === "complete") {
                            Log.debug("DOM initialized");
                            return cb.call(_this);
                        }
                    };
                    return document.addEventListener("readystatechange", listener, false);
                }
            }
        };
        Caman.prototype.parseArguments = function(args) {
            var
                key, val, _ref, _results;
            if (args.length === 0) {
                throw "Invalid arguments given";
            }
            this.initObj = null;
            this.initType = null;
            this.imageUrl = null;
            this.callback = function() {};
            this.setInitObject(args[0]);
            if (args.length === 1) {
                return;
            }
            switch (typeof args[1]) {
                case "string":
                    this.imageUrl = args[1];
                    break;
                case "function":
                    this.callback = args[1];
            }
            if (args.length === 2) {
                return;
            }
            this.callback = args[2];
            if (args.length === 4) {
                _ref = args[4];
                _results = [];
                for (key in
                    _ref) {
                    if (!__hasProp.call(_ref, key)) continue;
                    val = _ref[key];
                    _results.push(this.options[key] = val);
                }
                return _results;
            }
        };
        Caman.prototype.setInitObject = function(obj) {
            if (Caman.NodeJS) {
                this.initObj = obj;
                this.initType = 'node';
                return;
            }
            if (typeof obj === "object") {
                this.initObj = obj;
            } else {
                this.initObj = $(obj);
            }
            if (this.initObj == null) {
                throw "Could not find image or canvas for initialization.";
            }
            return this.initType = this.initObj.nodeName.toLowerCase();
        };
        Caman.prototype.setup = function() {
            switch (this.initType) {
                case "node":
                    return this.initNode();
                case "img":
                    return this.initImage();
                case "canvas":
                    return this.initCanvas();
            }
        };
        Caman.prototype.initNode = function() {
            Log.debug("Initializing for NodeJS");
            if (typeof this.initObj === "string" && this.initObj.match(/^https?:\/\//)) {
                return this.readFromHttp(this.initObj, this.nodeFileReady);
            } else
            if (typeof this.initObj === "string") {
                return fs.readFile(this.initObj, this.nodeFileReady);
            } else {
                return this.nodeFileReady(null, this.initObj);
            }
        };
        Caman.prototype.readFromHttp = function(url, callback) {
            var
                req;
            Log.debug("Fetching image from " + url);
            req = http.get(url, function(res) {
                var
                    buf;
                buf = '';
                res.setEncoding('binary');
                res.on('data', function(chunk) {
                    return buf += chunk;
                });
                return res.on('end', function() {
                    return callback(null, new Buffer(buf, 'binary'));
                });
            });
            return req.on('error', callback);
        };
        Caman.prototype.nodeFileReady = function(err, data) {
            if (err) {
                throw err;
            }
            this.image = new
            Image();
            this.image.src = data;
            Log.debug("Image loaded. Width = " + (this.imageWidth()) + ", Height = " + (this.imageHeight()));
            this.canvas = new
            Canvas(this.imageWidth(), this.imageHeight());
            return this.finishInit();
        };
        Caman.prototype.initImage = function() {
            this.image = this.initObj;
            this.canvas = document.createElement('canvas');
            this.context = this.canvas.getContext('2d');
            Util.copyAttributes(this.image, this.canvas, {
                except: ['src']
            });
            if (this.image.parentNode != null) {
                this.image.parentNode.replaceChild(this.canvas, this.image);
            }
            this.imageAdjustments();
            return this.waitForImageLoaded();
        };
        Caman.prototype.initCanvas = function() {
            this.canvas = this.initObj;
            this.context = this.canvas.getContext('2d');
            if (this.imageUrl != null) {
                this.image = document.createElement('img');
                this.image.src = this.imageUrl;
                this.imageAdjustments();
                return this.waitForImageLoaded();
            } else {
                return this.finishInit();
            }
        };
        Caman.prototype.imageAdjustments = function() {
            if (this.needsHiDPISwap()) {
                Log.debug(this.image.src, "->", this.hiDPIReplacement());
                this.swapped = true;
                this.image.src = this.hiDPIReplacement();
            }
            if (IO.isRemote(this.image)) {
                this.image.src = IO.proxyUrl(this.image.src);
                return Log.debug("Remote image detected, using URL = " + this.image.src);
            }
        };
        Caman.prototype.waitForImageLoaded = function() {
            if (this.isImageLoaded()) {
                return this.imageLoaded();
            } else {
                return this.image.onload = this.imageLoaded;
            }
        };
        Caman.prototype.isImageLoaded = function() {
            if (!this.image.complete) {
                return false;
            }
            if ((this.image.naturalWidth != null) && this.image.naturalWidth === 0) {
                return false;
            }
            return true;
        };
        Caman.prototype.imageWidth = function() {
            return this.image.width || this.image.naturalWidth;
        };
        Caman.prototype.imageHeight = function() {
            return this.image.height || this.image.naturalHeight;
        };
        Caman.prototype.imageLoaded = function() {
            Log.debug("Image loaded. Width = " + (this.imageWidth()) + ", Height = " + (this.imageHeight()));
            if (this.swapped) {
                this.canvas.width = this.imageWidth() / this.hiDPIRatio();
                this.canvas.height = this.imageHeight() / this.hiDPIRatio();
            } else {
                this.canvas.width = this.imageWidth();
                this.canvas.height = this.imageHeight();
            }
            return this.finishInit();
        };
        Caman.prototype.finishInit = function() {
            var
                i, pixel, _i, _len, _ref;
            if (this.context == null) {
                this.context = this.canvas.getContext('2d');
            }
            this.originalWidth = this.preScaledWidth = this.width = this.canvas.width;
            this.originalHeight = this.preScaledHeight = this.height = this.canvas.height;
            this.hiDPIAdjustments();
            if (!this.hasId()) {
                this.assignId();
            }
            if (this.image != null) {
                this.context.drawImage(this.image, 0, 0, this.imageWidth(), this.imageHeight(), 0, 0, this.preScaledWidth, this.preScaledHeight);
            }
            this.imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            this.pixelData = this.imageData.data;
            if (Caman.allowRevert) {
                this.initializedPixelData = Util.dataArray(this.pixelData.length);
                this.originalPixelData = Util.dataArray(this.pixelData.length);
                _ref = this.pixelData;
                for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
                    pixel = _ref[i];
                    this.initializedPixelData[i] = pixel;
                    this.originalPixelData[i] = pixel;
                }
            }
            this.dimensions = {
                width: this.canvas.width,
                height: this.canvas.height
            };
            if (!Caman.NodeJS) {
                Store.put(this.id, this);
            }
            this.callback.call(this, this);
            return this.callback = function() {};
        };
        Caman.prototype.reloadCanvasData = function() {
            this.imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            return this.pixelData = this.imageData.data;
        };
        Caman.prototype.resetOriginalPixelData = function() {
            var
                i, pixel, _i, _len, _ref, _results;
            if (!Caman.allowRevert) {
                throw "Revert disabled";
            }
            this.originalPixelData = Util.dataArray(this.pixelData.length);
            _ref = this.pixelData;
            _results = [];
            for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
                pixel = _ref[i];
                _results.push(this.originalPixelData[i] = pixel);
            }
            return _results;
        };
        Caman.prototype.hasId = function() {
            return Caman.getAttrId(this.canvas) != null;
        };
        Caman.prototype.assignId = function() {
            if (Caman.NodeJS || this.canvas.getAttribute('data-caman-id')) {
                return;
            }
            return this.canvas.setAttribute('data-caman-id', this.id);
        };
        Caman.prototype.hiDPIDisabled = function() {
            return this.canvas.getAttribute('data-caman-hidpi-disabled') !== null;
        };
        Caman.prototype.hiDPIAdjustments = function() {
            var
                ratio;
            if (Caman.NodeJS || !this.needsHiDPISwap()) {
                return;
            }
            ratio = this.hiDPIRatio();
            if (ratio !== 1) {
                Log.debug("HiDPI ratio = " + ratio);
                this.scaled = true;
                this.preScaledWidth = this.canvas.width;
                this.preScaledHeight = this.canvas.height;
                this.canvas.width = this.preScaledWidth * ratio;
                this.canvas.height = this.preScaledHeight * ratio;
                this.canvas.style.width = "" + this.preScaledWidth + "px";
                this.canvas.style.height = "" + this.preScaledHeight + "px";
                this.context.scale(ratio, ratio);
                this.width = this.originalWidth = this.canvas.width;
                return this.height = this.originalHeight = this.canvas.height;
            }
        };
        Caman.prototype.hiDPIRatio = function() {
            var
                backingStoreRatio, devicePixelRatio;
            devicePixelRatio = window.devicePixelRatio || 1;
            backingStoreRatio = this.context.webkitBackingStorePixelRatio || this.context.mozBackingStorePixelRatio || this.context.msBackingStorePixelRatio || this.context.oBackingStorePixelRatio || this.context.backingStorePixelRatio || 1;
            return devicePixelRatio / backingStoreRatio;
        };
        Caman.prototype.hiDPICapable = function() {
            return (window.devicePixelRatio != null) && window.devicePixelRatio !== 1;
        };
        Caman.prototype.needsHiDPISwap = function() {
            if (this.hiDPIDisabled() || !this.hiDPICapable()) {
                return false;
            }
            return this.hiDPIReplacement() !== null;
        };
        Caman.prototype.hiDPIReplacement = function() {
            if (this.image == null) {
                return null;
            }
            return this.image.getAttribute('data-caman-hidpi');
        };
        Caman.prototype.replaceCanvas = function(newCanvas) {
            var
                oldCanvas;
            oldCanvas = this.canvas;
            this.canvas = newCanvas;
            this.context = this.canvas.getContext('2d');
            if (!Caman.NodeJS) {
                oldCanvas.parentNode.replaceChild(this.canvas, oldCanvas);
            }
            this.width = this.canvas.width;
            this.height = this.canvas.height;
            this.reloadCanvasData();
            return this.dimensions = {
                width: this.canvas.width,
                height: this.canvas.height
            };
        };
        Caman.prototype.render = function(callback) {
            var
                _this = this;
            if (callback == null) {
                callback = function() {};
            }
            Event.trigger(this, "renderStart");
            return this.renderer.execute(function() {
                _this.context.putImageData(_this.imageData, 0, 0);
                return callback.call(_this);
            });
        };
        Caman.prototype.revert = function(updateContext) {
            var
                i, pixel, _i, _len, _ref;
            if (updateContext == null) {
                updateContext = true;
            }
            if (!Caman.allowRevert) {
                throw "Revert disabled";
            }
            _ref = this.originalVisiblePixels();
            for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
                pixel = _ref[i];
                this.pixelData[i] = pixel;
            }
            if (updateContext) {
                return this.context.putImageData(this.imageData, 0, 0);
            }
        };
        Caman.prototype.reset = function() {
            var
                canvas, ctx, i, imageData, pixel, pixelData, _i, _len, _ref;
            canvas = document.createElement('canvas');
            Util.copyAttributes(this.canvas, canvas);
            canvas.width = this.originalWidth;
            canvas.height = this.originalHeight;
            ctx = canvas.getContext('2d');
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            pixelData = imageData.data;
            _ref = this.initializedPixelData;
            for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
                pixel = _ref[i];
                pixelData[i] = pixel;
            }
            ctx.putImageData(imageData, 0, 0);
            this.cropCoordinates = {
                x: 0,
                y: 0
            };
            this.resized = false;
            return this.replaceCanvas(canvas);
        };
        Caman.prototype.originalVisiblePixels = function() {
            var
                canvas, coord, ctx, endX, endY, i, imageData, pixel, pixelData, pixels, scaledCanvas, startX, startY, width, _i, _j, _len, _ref, _ref1, _ref2, _ref3;
            if (!Caman.allowRevert) {
                throw "Revert disabled";
            }
            pixels = [];
            startX = this.cropCoordinates.x;
            endX = startX + this.width;
            startY = this.cropCoordinates.y;
            endY = startY + this.height;
            if (this.resized) {
                canvas = document.createElement('canvas');
                canvas.width = this.originalWidth;
                canvas.height = this.originalHeight;
                ctx = canvas.getContext('2d');
                imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                pixelData = imageData.data;
                _ref = this.originalPixelData;
                for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
                    pixel = _ref[i];
                    pixelData[i] = pixel;
                }
                ctx.putImageData(imageData, 0, 0);
                scaledCanvas = document.createElement('canvas');
                scaledCanvas.width = this.width;
                scaledCanvas.height = this.height;
                ctx = scaledCanvas.getContext('2d');
                ctx.drawImage(canvas, 0, 0, this.originalWidth, this.originalHeight, 0, 0, this.width, this.height);
                pixelData = ctx.getImageData(0, 0, this.width, this.height).data;
                width = this.width;
            } else {
                pixelData = this.originalPixelData;
                width = this.originalWidth;
            }
            for (i = _j = 0, _ref1 = pixelData.length; _j < _ref1; i = _j += 4) {
                coord = Pixel.locationToCoordinates(i, width);
                if (((startX <= (_ref2 = coord.x) && _ref2 < endX)) && ((startY <= (_ref3 = coord.y) && _ref3 < endY))) {
                    pixels.push(pixelData[i], pixelData[i + 1], pixelData[i + 2], pixelData[i + 3]);
                }
            }
            return pixels;
        };
        Caman.prototype.process = function(name, processFn) {
            this.renderer.add({
                type: Filter.Type.Single,
                name: name,
                processFn: processFn
            });
            return this;
        };
        Caman.prototype.processKernel = function(name, adjust, divisor, bias) {
            var
                i, _i, _ref;
            if (divisor == null) {
                divisor = null;
            }
            if (bias == null) {
                bias = 0;
            }
            if (divisor == null) {
                divisor = 0;
                for (i = _i = 0, _ref = adjust.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
                    divisor += adjust[i];
                }
            }
            this.renderer.add({
                type: Filter.Type.Kernel,
                name: name,
                adjust: adjust,
                divisor: divisor,
                bias: bias
            });
            return this;
        };
        Caman.prototype.processPlugin = function(plugin, args) {
            this.renderer.add({
                type: Filter.Type.Plugin,
                plugin: plugin,
                args: args
            });
            return this;
        };
        Caman.prototype.newLayer = function(callback) {
            var
                layer;
            layer = new
            Layer(this);
            this.canvasQueue.push(layer);
            this.renderer.add({
                type: Filter.Type.LayerDequeue
            });
            callback.call(layer);
            this.renderer.add({
                type: Filter.Type.LayerFinished
            });
            return this;
        };
        Caman.prototype.executeLayer = function(layer) {
            return this.pushContext(layer);
        };
        Caman.prototype.pushContext = function(layer) {
            this.layerStack.push(this.currentLayer);
            this.pixelStack.push(this.pixelData);
            this.currentLayer = layer;
            return this.pixelData = layer.pixelData;
        };
        Caman.prototype.popContext = function() {
            this.pixelData = this.pixelStack.pop();
            return this.currentLayer = this.layerStack.pop();
        };
        Caman.prototype.applyCurrentLayer = function() {
            return this.currentLayer.applyToParent();
        };
        return Caman;
    })(Module);
    Root.Caman = Caman;
    Caman.Analyze = (function() {
        function
        Analyze(c) {
            this.c = c;
        }
        Analyze.prototype.calculateLevels = function() {
            var
                i, levels, numPixels, _i, _j, _k, _ref;
            levels = {
                r: {},
                g: {},
                b: {}
            };
            for (i = _i = 0; _i <= 255; i = ++_i) {
                levels.r[i] = 0;
                levels.g[i] = 0;
                levels.b[i] = 0;
            }
            for (i = _j = 0, _ref = this.c.pixelData.length; _j < _ref; i = _j += 4) {
                levels.r[this.c.pixelData[i]]++;
                levels.g[this.c.pixelData[i + 1]]++;
                levels.b[this.c.pixelData[i + 2]]++;
            }
            numPixels = this.c.pixelData.length / 4;
            for (i = _k = 0; _k <= 255; i = ++_k) {
                levels.r[i] /= numPixels;
                levels.g[i] /= numPixels;
                levels.b[i] /= numPixels;
            }
            return levels;
        };
        return Analyze;
    })();
    Analyze = Caman.Analyze;
    Caman.DOMUpdated = function() {
        var
            img, imgs, parser, _i, _len, _results;
        imgs = document.querySelectorAll("img[data-caman]");
        if (!(imgs.length > 0)) {
            return;
        }
        _results = [];
        for (_i = 0, _len = imgs.length; _i < _len; _i++) {
            img = imgs[_i];
            _results.push(parser = new CamanParser(img, function() {
                this.parse();
                return this.execute();
            }));
        }
        return _results;
    };
    if (Caman.autoload) {
        (function() {
            if (document.readyState === "complete") {
                return Caman.DOMUpdated();
            } else {
                return document.addEventListener("DOMContentLoaded", Caman.DOMUpdated, false);
            }
        })();
    }
    CamanParser = (function() {
        var
            INST_REGEX;
        INST_REGEX = "(\\w+)\\((.*?)\\)";

        function
        CamanParser(ele, ready) {
            this.dataStr = ele.getAttribute('data-caman');
            this.caman = Caman(ele, ready.bind(this));
        }
        CamanParser.prototype.parse = function() {
            var
                args, e, filter, func, inst, instFunc, m, r, unparsedInstructions, _i, _len, _ref, _results;
            this.ele = this.caman.canvas;
            r = new
            RegExp(INST_REGEX, 'g');
            unparsedInstructions = this.dataStr.match(r);
            if (!(unparsedInstructions.length > 0)) {
                return;
            }
            r = new
            RegExp(INST_REGEX);
            _results = [];
            for (_i = 0, _len = unparsedInstructions.length; _i < _len; _i++) {
                inst = unparsedInstructions[_i];
                _ref = inst.match(r), m = _ref[0], filter = _ref[1], args = _ref[2];
                instFunc = new
                Function("return function() {        this." + filter + "(" + args + ");      };");
                try {
                    func = instFunc();
                    _results.push(func.call(this.caman));
                } catch (_error) {
                    e = _error;
                    _results.push(Log.debug(e));
                }
            }
            return _results;
        };
        CamanParser.prototype.execute = function() {
            var
                ele;
            ele = this.ele;
            return this.caman.render(function() {
                return ele.parentNode.replaceChild(this.toImage(), ele);
            });
        };
        return CamanParser;
    })();
    Caman.Blender = (function() {
        function
        Blender() {}
        Blender.blenders = {};
        Blender.register = function(name, func) {
            return this.blenders[name] = func;
        };
        Blender.execute = function(name, rgbaLayer, rgbaParent) {
            return this.blenders[name](rgbaLayer, rgbaParent);
        };
        return Blender;
    })();
    Blender = Caman.Blender;
    Caman.Calculate = (function() {
        function
        Calculate() {}
        Calculate.distance = function(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        };
        Calculate.randomRange = function(min, max, getFloat) {
            var
                rand;
            if (getFloat == null) {
                getFloat = false;
            }
            rand = min + (Math.random() * (max - min));
            if (getFloat) {
                return rand.toFixed(getFloat);
            } else {
                return Math.round(rand);
            }
        };
        Calculate.luminance = function(rgba) {
            return (0.299 * rgba.r) + (0.587 * rgba.g) + (0.114 * rgba.b);
        };
        Calculate.bezier = function(start, ctrl1, ctrl2, end, lowBound, highBound) {
            var
                bezier, clamp, controlPoints, endX, i, j, lerp, next, prev, t, _i, _j, _ref;
            if (lowBound == null) {
                lowBound = 0;
            }
            if (highBound == null) {
                highBound = 255;
            }
            if (start[0] instanceof Array) {
                controlPoints = start;
                lowBound = ctrl1;
                highBound = ctrl2;
            } else {
                controlPoints = [start, ctrl1, ctrl2, end];
            }
            if (controlPoints.length < 2) {
                throw "Invalid number of arguments to bezier";
            }
            bezier = {};
            lerp = function(a, b, t) {
                return a * (1 - t) + b * t;
            };
            clamp = function(a, min, max) {
                return Math.min(Math.max(a, min), max);
            };
            for (i = _i = 0; _i < 1000; i = ++_i) {
                t = i / 1000;
                prev = controlPoints;
                while (prev.length > 1) {
                    next = [];
                    for (j = _j = 0, _ref = prev.length - 2; 0 <= _ref ? _j <= _ref : _j >= _ref; j = 0 <= _ref ? ++_j : --_j) {
                        next.push([lerp(prev[j][0], prev[j + 1][0], t), lerp(prev[j][1], prev[j + 1][1], t)]);
                    }
                    prev = next;
                }
                bezier[Math.round(prev[0][0])] = Math.round(clamp(prev[0][1], lowBound, highBound));
            }
            endX = controlPoints[controlPoints.length - 1][0];
            bezier = Caman.Calculate.missingValues(bezier, endX);
            if (bezier[endX] == null) {
                bezier[endX] = bezier[endX - 1];
            }
            return bezier;
        };
        Calculate.hermite = function(controlPoints, lowBound, highBound) {
            var
                add, clamp, count, endX, fac0, fac1, fac2, fac3, i, j, lerp, m0, m1, mul, p, p0, p1, pointsPerSegment, pointsPerStep, pos, ret, sub, t, _i, _j, _ref, _this = this;
            if (controlPoints.length < 2) {
                throw "Invalid number of arguments to hermite";
            }
            ret = {};
            lerp = function(a, b, t) {
                return a * (1 - t) + b * t;
            };
            add = function(a, b, c, d) {
                return [a[0] + b[0] + c[0] + d[0], a[1] + b[1] + c[1] + d[1]];
            };
            mul = function(a, b) {
                return [a[0] * b[0], a[1] * b[1]];
            };
            sub = function(a, b) {
                return [a[0] - b[0], a[1] - b[1]];
            };
            clamp = function(a, min, max) {
                return Math.min(Math.max(a, min), max);
            };
            count = 0;
            for (i = _i = 0, _ref = controlPoints.length - 2; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
                p0 = controlPoints[i];
                p1 = controlPoints[i + 1];
                pointsPerSegment = p1[0] - p0[0];
                pointsPerStep = 1 / pointsPerSegment;
                if (i === controlPoints.length - 2) {
                    pointsPerStep = 1 / (pointsPerSegment - 1);
                }
                p = i > 0 ? controlPoints[i - 1] : p0;
                m0 = mul(sub(p1, p), [0.5, 0.5]);
                p = i < controlPoints.length - 2 ? controlPoints[i + 2] : p1;
                m1 = mul(sub(p, p0), [0.5, 0.5]);
                for (j = _j = 0; 0 <= pointsPerSegment ? _j <= pointsPerSegment : _j >= pointsPerSegment; j = 0 <= pointsPerSegment ? ++_j : --_j) {
                    t = j * pointsPerStep;
                    fac0 = 2.0 * t * t * t - 3.0 * t * t + 1.0;
                    fac1 = t * t * t - 2.0 * t * t + t;
                    fac2 = -2.0 * t * t * t + 3.0 * t * t;
                    fac3 = t * t * t - t * t;
                    pos = add(mul(p0, [fac0, fac0]), mul(m0, [fac1, fac1]), mul(p1, [fac2, fac2]), mul(m1, [fac3, fac3]));
                    ret[Math.round(pos[0])] = Math.round(clamp(pos[1], lowBound, highBound));
                    count += 1;
                }
            }
            endX = controlPoints[controlPoints.length - 1][0];
            ret = Caman.Calculate.missingValues(ret, endX);
            return ret;
        };
        Calculate.missingValues = function(values, endX) {
            var
                i, j, leftCoord, ret, rightCoord, _i, _j;
            if (Object.keys(values).length < endX + 1) {
                ret = {};
                for (i = _i = 0; 0 <= endX ? _i <= endX : _i >= endX; i = 0 <= endX ? ++_i : --_i) {
                    if (values[i] != null) {
                        ret[i] = values[i];
                    } else {
                        leftCoord = [i - 1, ret[i - 1]];
                        for (j = _j = i; i <= endX ? _j <= endX : _j >= endX; j = i <= endX ? ++_j : --_j) {
                            if (values[j] != null) {
                                rightCoord = [j, values[j]];
                                break;
                            }
                        }
                        ret[i] = leftCoord[1] + ((rightCoord[1] - leftCoord[1]) / (rightCoord[0] - leftCoord[0])) * (i - leftCoord[0]);
                    }
                }
                return ret;
            }
            return values;
        };
        return Calculate;
    })();
    Calculate = Caman.Calculate;
    Caman.Convert = (function() {
        function
        Convert() {}
        Convert.hexToRGB = function(hex) {
            var
                b, g, r;
            if (hex.charAt(0) === "#") {
                hex = hex.substr(1);
            }
            r = parseInt(hex.substr(0, 2), 16);
            g = parseInt(hex.substr(2, 2), 16);
            b = parseInt(hex.substr(4, 2), 16);
            return {
                r: r,
                g: g,
                b: b
            };
        };
        Convert.rgbToHSL = function(r, g, b) {
            var
                d, h, l, max, min, s;
            if (typeof r === "object") {
                g = r.g;
                b = r.b;
                r = r.r;
            }
            r /= 255;
            g /= 255;
            b /= 255;
            max = Math.max(r, g, b);
            min = Math.min(r, g, b);
            l = (max + min) / 2;
            if (max === min) {
                h = s = 0;
            } else {
                d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                h = (function() {
                    switch (max) {
                        case
                        r:
                            return (g - b) / d + (g < b ? 6 : 0);
                        case
                        g:
                            return (b - r) / d + 2;
                        case
                        b:
                            return (r - g) / d + 4;
                    }
                })();
                h /= 6;
            }
            return {
                h: h,
                s: s,
                l: l
            };
        };
        Convert.hslToRGB = function(h, s, l) {
            var
                b, g, p, q, r;
            if (typeof h === "object") {
                s = h.s;
                l = h.l;
                h = h.h;
            }
            if (s === 0) {
                r = g = b = l;
            } else {
                q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                p = 2 * l - q;
                r = this.hueToRGB(p, q, h + 1 / 3);
                g = this.hueToRGB(p, q, h);
                b = this.hueToRGB(p, q, h - 1 / 3);
            }
            return {
                r: r * 255,
                g: g * 255,
                b: b * 255
            };
        };
        Convert.hueToRGB = function(p, q, t) {
            if (t < 0) {
                t += 1;
            }
            if (t > 1) {
                t -= 1;
            }
            if (t < 1 / 6) {
                return p + (q - p) * 6 * t;
            }
            if (t < 1 / 2) {
                return q;
            }
            if (t < 2 / 3) {
                return p + (q - p) * (2 / 3 - t) * 6;
            }
            return p;
        };
        Convert.rgbToHSV = function(r, g, b) {
            var
                d, h, max, min, s, v;
            r /= 255;
            g /= 255;
            b /= 255;
            max = Math.max(r, g, b);
            min = Math.min(r, g, b);
            v = max;
            d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) {
                h = 0;
            } else {
                h = (function() {
                    switch (max) {
                        case
                        r:
                            return (g - b) / d + (g < b ? 6 : 0);
                        case
                        g:
                            return (b - r) / d + 2;
                        case
                        b:
                            return (r - g) / d + 4;
                    }
                })();
                h /= 6;
            }
            return {
                h: h,
                s: s,
                v: v
            };
        };
        Convert.hsvToRGB = function(h, s, v) {
            var
                b, f, g, i, p, q, r, t;
            i = Math.floor(h * 6);
            f = h * 6 - i;
            p = v * (1 - s);
            q = v * (1 - f * s);
            t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case
                0:
                    r = v;
                    g = t;
                    b = p;
                    break;
                case
                1:
                    r = q;
                    g = v;
                    b = p;
                    break;
                case
                2:
                    r = p;
                    g = v;
                    b = t;
                    break;
                case
                3:
                    r = p;
                    g = q;
                    b = v;
                    break;
                case
                4:
                    r = t;
                    g = p;
                    b = v;
                    break;
                case
                5:
                    r = v;
                    g = p;
                    b = q;
            }
            return {
                r: Math.floor(r * 255),
                g: Math.floor(g * 255),
                b: Math.floor(b * 255)
            };
        };
        Convert.rgbToXYZ = function(r, g, b) {
            var
                x, y, z;
            r /= 255;
            g /= 255;
            b /= 255;
            if (r > 0.04045) {
                r = Math.pow((r + 0.055) / 1.055, 2.4);
            } else {
                r /= 12.92;
            }
            if (g > 0.04045) {
                g = Math.pow((g + 0.055) / 1.055, 2.4);
            } else {
                g /= 12.92;
            }
            if (b > 0.04045) {
                b = Math.pow((b + 0.055) / 1.055, 2.4);
            } else {
                b /= 12.92;
            }
            x = r * 0.4124 + g * 0.3576 + b * 0.1805;
            y = r * 0.2126 + g * 0.7152 + b * 0.0722;
            z = r * 0.0193 + g * 0.1192 + b * 0.9505;
            return {
                x: x * 100,
                y: y * 100,
                z: z * 100
            };
        };
        Convert.xyzToRGB = function(x, y, z) {
            var
                b, g, r;
            x /= 100;
            y /= 100;
            z /= 100;
            r = (3.2406 * x) + (-1.5372 * y) + (-0.4986 * z);
            g = (-0.9689 * x) + (1.8758 * y) + (0.0415 * z);
            b = (0.0557 * x) + (-0.2040 * y) + (1.0570 * z);
            if (r > 0.0031308) {
                r = (1.055 * Math.pow(r, 0.4166666667)) - 0.055;
            } else {
                r *= 12.92;
            }
            if (g > 0.0031308) {
                g = (1.055 * Math.pow(g, 0.4166666667)) - 0.055;
            } else {
                g *= 12.92;
            }
            if (b > 0.0031308) {
                b = (1.055 * Math.pow(b, 0.4166666667)) - 0.055;
            } else {
                b *= 12.92;
            }
            return {
                r: r * 255,
                g: g * 255,
                b: b * 255
            };
        };
        Convert.xyzToLab = function(x, y, z) {
            var
                a, b, l, whiteX, whiteY, whiteZ;
            if (typeof x === "object") {
                y = x.y;
                z = x.z;
                x = x.x;
            }
            whiteX = 95.047;
            whiteY = 100.0;
            whiteZ = 108.883;
            x /= whiteX;
            y /= whiteY;
            z /= whiteZ;
            if (x > 0.008856451679) {
                x = Math.pow(x, 0.3333333333);
            } else {
                x = (7.787037037 * x) + 0.1379310345;
            }
            if (y > 0.008856451679) {
                y = Math.pow(y, 0.3333333333);
            } else {
                y = (7.787037037 * y) + 0.1379310345;
            }
            if (z > 0.008856451679) {
                z = Math.pow(z, 0.3333333333);
            } else {
                z = (7.787037037 * z) + 0.1379310345;
            }
            l = 116 * y - 16;
            a = 500 * (x - y);
            b = 200 * (y - z);
            return {
                l: l,
                a: a,
                b: b
            };
        };
        Convert.labToXYZ = function(l, a, b) {
            var
                x, y, z;
            if (typeof l === "object") {
                a = l.a;
                b = l.b;
                l = l.l;
            }
            y = (l + 16) / 116;
            x = y + (a / 500);
            z = y - (b / 200);
            if (x > 0.2068965517) {
                x = x * x * x;
            } else {
                x = 0.1284185493 * (x - 0.1379310345);
            }
            if (y > 0.2068965517) {
                y = y * y * y;
            } else {
                y = 0.1284185493 * (y - 0.1379310345);
            }
            if (z > 0.2068965517) {
                z = z * z * z;
            } else {
                z = 0.1284185493 * (z - 0.1379310345);
            }
            return {
                x: x * 95.047,
                y: y * 100.0,
                z: z * 108.883
            };
        };
        Convert.rgbToLab = function(r, g, b) {
            var
                xyz;
            if (typeof r === "object") {
                g = r.g;
                b = r.b;
                r = r.r;
            }
            xyz = this.rgbToXYZ(r, g, b);
            return this.xyzToLab(xyz);
        };
        Convert.labToRGB = function(l, a, b) {};
        return Convert;
    })();
    Convert = Caman.Convert;
    Caman.Event = (function() {
        function
        Event() {}
        Event.events = {};
        Event.types = ["processStart", "processComplete", "renderStart", "renderFinished", "blockStarted", "blockFinished"];
        Event.trigger = function(target, type, data) {
            var
                event, _i, _len, _ref, _results;
            if (data == null) {
                data = null;
            }
            if (this.events[type] && this.events[type].length) {
                _ref = this.events[type];
                _results = [];
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                    event = _ref[_i];
                    if (event.target === null || target.id === event.target.id) {
                        _results.push(event.fn.call(target, data));
                    } else {
                        _results.push(void 0);
                    }
                }
                return _results;
            }
        };
        Event.listen = function(target, type, fn) {
            var
                _fn, _type;
            if (typeof target === "string") {
                _type = target;
                _fn = type;
                target = null;
                type = _type;
                fn = _fn;
            }
            if (__indexOf.call(this.types, type) < 0) {
                return false;
            }
            if (!this.events[type]) {
                this.events[type] = [];
            }
            this.events[type].push({
                target: target,
                fn: fn
            });
            return true;
        };
        return Event;
    })();
    Event = Caman.Event;
    Caman.Filter = (function() {
        function
        Filter() {}
        Filter.Type = {
            Single: 1,
            Kernel: 2,
            LayerDequeue: 3,
            LayerFinished: 4,
            LoadOverlay: 5,
            Plugin: 6
        };
        Filter.register = function(name, filterFunc) {
            return Caman.prototype[name] = filterFunc;
        };
        return Filter;
    })();
    Filter = Caman.Filter;
    Caman.IO = (function() {
        function
        IO() {}
        IO.domainRegex = /(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/;
        IO.isRemote = function(img) {
            if (img == null) {
                return false;
            }
            if (this.corsEnabled(img)) {
                return false;
            }
            return this.isURLRemote(img.src);
        };
        IO.corsEnabled = function(img) {
            var
                _ref;
            return (img.crossOrigin != null) && ((_ref = img.crossOrigin.toLowerCase()) === 'anonymous' || _ref === 'use-credentials');
        };
        IO.isURLRemote = function(url) {
            var
                matches;
            matches = url.match(this.domainRegex);
            if (matches) {
                return matches[1] !== document.domain;
            } else {
                return false;
            }
        };
        IO.remoteCheck = function(src) {
            if (this.isURLRemote(src)) {
                if (!Caman.remoteProxy.length) {
                    Log.info("Attempting to load a remote image without a configured proxy. URL: " + src);
                } else {
                    if (Caman.isURLRemote(Caman.remoteProxy)) {
                        Log.info("Cannot use a remote proxy for loading images.");
                        return;
                    }
                    return this.proxyUrl(src);
                }
            }
        };
        IO.proxyUrl = function(src) {
            return "" + Caman.remoteProxy + "?" + Caman.proxyParam + "=" + (encodeURIComponent(src));
        };
        IO.useProxy = function(lang) {
            var
                langToExt;
            langToExt = {
                ruby: 'rb',
                python: 'py',
                perl: 'pl',
                javascript: 'js'
            };
            lang = lang.toLowerCase();
            if (langToExt[lang] != null) {
                lang = langToExt[lang];
            }
            return "proxies/caman_proxy." + lang;
        };
        return IO;
    })();
    Caman.prototype.save = function() {
        if (typeof exports !== "undefined" && exports !== null) {
            return this.nodeSave.apply(this, arguments);
        } else {
            return this.browserSave.apply(this, arguments);
        }
    };
    Caman.prototype.browserSave = function(type) {
        var
            image;
        if (type == null) {
            type = "png";
        }
        type = type.toLowerCase();
        image = this.toBase64(type).replace("image/" + type, "image/octet-stream");
        return document.location.href = image;
    };
    Caman.prototype.nodeSave = function(file, overwrite) {
        var
            e, stats;
        if (overwrite == null) {
            overwrite = true;
        }
        try {
            stats = fs.statSync(file);
            if (stats.isFile() && !overwrite) {
                return false;
            }
        } catch (_error) {
            e = _error;
            Log.debug("Creating output file " + file);
        }
        return fs.writeFile(file, this.canvas.toBuffer(), function() {
            return Log.debug("Finished writing to " + file);
        });
    };
    Caman.prototype.toImage = function(type) {
        var
            img;
        img = document.createElement('img');
        img.src = this.toBase64(type);
        img.width = this.dimensions.width;
        img.height = this.dimensions.height;
        if (window.devicePixelRatio) {
            img.width /= window.devicePixelRatio;
            img.height /= window.devicePixelRatio;
        }
        return img;
    };
    Caman.prototype.toBase64 = function(type) {
        if (type == null) {
            type = "png";
        }
        type = type.toLowerCase();
        return this.canvas.toDataURL("image/" + type);
    };
    IO = Caman.IO;
    Caman.Layer = (function() {
        function
        Layer(c) {
            this.c = c;
            this.filter = this.c;
            this.options = {
                blendingMode: 'normal',
                opacity: 1.0
            };
            this.layerID = Util.uniqid.get();
            this.canvas = typeof
            exports !== "undefined" && exports !== null ? new
            Canvas(): document.createElement('canvas');
            this.canvas.width = this.c.dimensions.width;
            this.canvas.height = this.c.dimensions.height;
            this.context = this.canvas.getContext('2d');
            this.context.createImageData(this.canvas.width, this.canvas.height);
            this.imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
            this.pixelData = this.imageData.data;
        }
        Layer.prototype.newLayer = function(cb) {
            return this.c.newLayer.call(this.c, cb);
        };
        Layer.prototype.setBlendingMode = function(mode) {
            this.options.blendingMode = mode;
            return this;
        };
        Layer.prototype.opacity = function(opacity) {
            this.options.opacity = opacity / 100;
            return this;
        };
        Layer.prototype.copyParent = function() {
            var
                i, parentData, _i, _ref;
            parentData = this.c.pixelData;
            for (i = _i = 0, _ref = this.c.pixelData.length; _i < _ref; i = _i += 4) {
                this.pixelData[i] = parentData[i];
                this.pixelData[i + 1] = parentData[i + 1];
                this.pixelData[i + 2] = parentData[i + 2];
                this.pixelData[i + 3] = parentData[i + 3];
            }
            return this;
        };
        Layer.prototype.fillColor = function() {
            return this.c.fillColor.apply(this.c, arguments);
        };
        Layer.prototype.overlayImage = function(image) {
            if (typeof image === "object") {
                image = image.src;
            } else
            if (typeof image === "string" && image[0] === "#") {
                image = $(image).src;
            }
            if (!image) {
                return this;
            }
            this.c.renderer.renderQueue.push({
                type: Filter.Type.LoadOverlay,
                src: image,
                layer: this
            });
            return this;
        };
        Layer.prototype.applyToParent = function() {
            var
                i, layerData, parentData, result, rgbaLayer, rgbaParent, _i, _ref, _results;
            parentData = this.c.pixelStack[this.c.pixelStack.length - 1];
            layerData = this.c.pixelData;
            _results = [];
            for (i = _i = 0, _ref = layerData.length; _i < _ref; i = _i += 4) {
                rgbaParent = {
                    r: parentData[i],
                    g: parentData[i + 1],
                    b: parentData[i + 2],
                    a: parentData[i + 3]
                };
                rgbaLayer = {
                    r: layerData[i],
                    g: layerData[i + 1],
                    b: layerData[i + 2],
                    a: layerData[i + 3]
                };
                result = Blender.execute(this.options.blendingMode, rgbaLayer, rgbaParent);
                result.r = Util.clampRGB(result.r);
                result.g = Util.clampRGB(result.g);
                result.b = Util.clampRGB(result.b);
                if (result.a == null) {
                    result.a = rgbaLayer.a;
                }
                parentData[i] = rgbaParent.r - ((rgbaParent.r - result.r) * (this.options.opacity * (result.a / 255)));
                parentData[i + 1] = rgbaParent.g - ((rgbaParent.g - result.g) * (this.options.opacity * (result.a / 255)));
                _results.push(parentData[i + 2] = rgbaParent.b - ((rgbaParent.b - result.b) * (this.options.opacity * (result.a / 255))));
            }
            return _results;
        };
        return Layer;
    })();
    Layer = Caman.Layer;
    Caman.Logger = (function() {
        function
        Logger() {
            var
                name, _i, _len, _ref;
            _ref = ['log', 'info', 'warn', 'error'];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                name = _ref[_i];
                this[name] = (function(name) {
                    return function() {
                        var
                            args, e;
                        args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
                        if (!Caman.DEBUG) {
                            return;
                        }
                        try {
                            return console[name].apply(console, args);
                        } catch (_error) {
                            e = _error;
                            return console[name](args);
                        }
                    };
                })(name);
            }
            this.debug = this.log;
        }
        return Logger;
    })();
    Log = new
    Caman.Logger();
    Caman.Pixel = (function() {
        Pixel.coordinatesToLocation = function(x, y, width) {
            return (y * width + x) * 4;
        };
        Pixel.locationToCoordinates = function(loc, width) {
            var
                x, y;
            y = Math.floor(loc / (width * 4));
            x = (loc % (width * 4)) / 4;
            return {
                x: x,
                y: y
            };
        };

        function
        Pixel(r, g, b, a, c) {
            this.r = r != null ? r : 0;
            this.g = g != null ? g : 0;
            this.b = b != null ? b : 0;
            this.a = a != null ? a : 255;
            this.c = c != null ? c : null;
            this.loc = 0;
        }
        Pixel.prototype.setContext = function(c) {
            return this.c = c;
        };
        Pixel.prototype.locationXY = function() {
            var
                x, y;
            if (this.c == null) {
                throw "Requires a CamanJS context";
            }
            y = this.c.dimensions.height - Math.floor(this.loc / (this.c.dimensions.width * 4));
            x = (this.loc % (this.c.dimensions.width * 4)) / 4;
            return {
                x: x,
                y: y
            };
        };
        Pixel.prototype.pixelAtLocation = function(loc) {
            if (this.c == null) {
                throw "Requires a CamanJS context";
            }
            return new
            Pixel(this.c.pixelData[loc], this.c.pixelData[loc + 1], this.c.pixelData[loc + 2], this.c.pixelData[loc + 3], this.c);
        };
        Pixel.prototype.getPixelRelative = function(horiz, vert) {
            var
                newLoc;
            if (this.c == null) {
                throw "Requires a CamanJS context";
            }
            newLoc = this.loc + (this.c.dimensions.width * 4 * (vert * -1)) + (4 * horiz);
            if (newLoc > this.c.pixelData.length || newLoc < 0) {
                return new
                Pixel(0, 0, 0, 255, this.c);
            }
            return this.pixelAtLocation(newLoc);
        };
        Pixel.prototype.putPixelRelative = function(horiz, vert, rgba) {
            var
                nowLoc;
            if (this.c == null) {
                throw "Requires a CamanJS context";
            }
            nowLoc = this.loc + (this.c.dimensions.width * 4 * (vert * -1)) + (4 * horiz);
            if (newLoc > this.c.pixelData.length || newLoc < 0) {
                return;
            }
            this.c.pixelData[newLoc] = rgba.r;
            this.c.pixelData[newLoc + 1] = rgba.g;
            this.c.pixelData[newLoc + 2] = rgba.b;
            this.c.pixelData[newLoc + 3] = rgba.a;
            return true;
        };
        Pixel.prototype.getPixel = function(x, y) {
            var
                loc;
            if (this.c == null) {
                throw "Requires a CamanJS context";
            }
            loc = this.coordinatesToLocation(x, y, this.width);
            return this.pixelAtLocation(loc);
        };
        Pixel.prototype.putPixel = function(x, y, rgba) {
            var
                loc;
            if (this.c == null) {
                throw "Requires a CamanJS context";
            }
            loc = this.coordinatesToLocation(x, y, this.width);
            this.c.pixelData[loc] = rgba.r;
            this.c.pixelData[loc + 1] = rgba.g;
            this.c.pixelData[loc + 2] = rgba.b;
            return this.c.pixelData[loc + 3] = rgba.a;
        };
        Pixel.prototype.toString = function() {
            return this.toKey();
        };
        Pixel.prototype.toHex = function(includeAlpha) {
            var
                hex;
            if (includeAlpha == null) {
                includeAlpha = false;
            }
            hex = '#' + this.r.toString(16) + this.g.toString(16) + this.b.toString(16);
            if (includeAlpha) {
                return hex + this.a.toString(16);
            } else {
                return hex;
            }
        };
        return Pixel;
    })();
    Pixel = Caman.Pixel;
    Caman.Plugin = (function() {
        function
        Plugin() {}
        Plugin.plugins = {};
        Plugin.register = function(name, plugin) {
            return this.plugins[name] = plugin;
        };
        Plugin.execute = function(context, name, args) {
            return this.plugins[name].apply(context, args);
        };
        return Plugin;
    })();
    Plugin = Caman.Plugin;
    Caman.Renderer = (function() {
        Renderer.Blocks = Caman.NodeJS ? require('os').cpus().length : 4;

        function
        Renderer(c) {
            this.c = c;
            this.processNext = __bind(this.processNext, this);
            this.renderQueue = [];
            this.modPixelData = null;
        }
        Renderer.prototype.add = function(job) {
            if (job == null) {
                return;
            }
            return this.renderQueue.push(job);
        };
        Renderer.prototype.processNext = function() {
            var
                layer;
            if (this.renderQueue.length === 0) {
                Event.trigger(this, "renderFinished");
                if (this.finishedFn != null) {
                    this.finishedFn.call(this.c);
                }
                return this;
            }
            this.currentJob = this.renderQueue.shift();
            switch (this.currentJob.type) {
                case
                Filter.Type.LayerDequeue:
                    layer = this.c.canvasQueue.shift();
                    this.c.executeLayer(layer);
                    return this.processNext();
                case
                Filter.Type.LayerFinished:
                    this.c.applyCurrentLayer();
                    this.c.popContext();
                    return this.processNext();
                case
                Filter.Type.LoadOverlay:
                    return this.loadOverlay(this.currentJob.layer, this.currentJob.src);
                case
                Filter.Type.Plugin:
                    return this.executePlugin();
                default:
                    return this.executeFilter();
            }
        };
        Renderer.prototype.execute = function(callback) {
            this.finishedFn = callback;
            this.modPixelData = Util.dataArray(this.c.pixelData.length);
            return this.processNext();
        };
        Renderer.prototype.eachBlock = function(fn) {
            var
                blockN, blockPixelLength, bnum, end, f, i, lastBlockN, n, start, _i, _ref, _results, _this = this;
            this.blocksDone = 0;
            n = this.c.pixelData.length;
            blockPixelLength = Math.floor((n / 4) / Renderer.Blocks);
            blockN = blockPixelLength * 4;
            lastBlockN = blockN + ((n / 4) % Renderer.Blocks) * 4;
            _results = [];
            for (i = _i = 0, _ref = Renderer.Blocks; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
                start = i * blockN;
                end = start + (i === Renderer.Blocks - 1 ? lastBlockN : blockN);
                if (Caman.NodeJS) {
                    f = Fiber(function() {
                        return fn.call(_this, i, start, end);
                    });
                    bnum = f.run();
                    _results.push(this.blockFinished(bnum));
                } else {
                    _results.push(setTimeout((function(i, start, end) {
                        return function() {
                            return fn.call(_this, i, start, end);
                        };
                    })(i, start, end), 0));
                }
            }
            return _results;
        };
        Renderer.prototype.executeFilter = function() {
            Event.trigger(this.c, "processStart", this.currentJob);
            if (this.currentJob.type === Filter.Type.Single) {
                return this.eachBlock(this.renderBlock);
            } else {
                return this.eachBlock(this.renderKernel);
            }
        };
        Renderer.prototype.executePlugin = function() {
            Log.debug("Executing plugin " + this.currentJob.plugin);
            Plugin.execute(this.c, this.currentJob.plugin, this.currentJob.args);
            Log.debug("Plugin " + this.currentJob.plugin + " finished!");
            return this.processNext();
        };
        Renderer.prototype.renderBlock = function(bnum, start, end) {
            var
                i, pixel, _i;
            Log.debug("Block #" + bnum + " - Filter: " + this.currentJob.name + ", Start: " + start + ", End: " + end);
            Event.trigger(this.c, "blockStarted", {
                blockNum: bnum,
                totalBlocks: Renderer.Blocks,
                startPixel: start,
                endPixel: end
            });
            pixel = new
            Pixel();
            pixel.setContext(this.c);
            for (i = _i = start; _i < end; i = _i += 4) {
                pixel.loc = i;
                pixel.r = this.c.pixelData[i];
                pixel.g = this.c.pixelData[i + 1];
                pixel.b = this.c.pixelData[i + 2];
                pixel.a = this.c.pixelData[i + 3];
                this.currentJob.processFn(pixel);
                this.c.pixelData[i] = Util.clampRGB(pixel.r);
                this.c.pixelData[i + 1] = Util.clampRGB(pixel.g);
                this.c.pixelData[i + 2] = Util.clampRGB(pixel.b);
                this.c.pixelData[i + 3] = Util.clampRGB(pixel.a);
            }
            if (Caman.NodeJS) {
                return Fiber["yield"](bnum);
            } else {
                return this.blockFinished(bnum);
            }
        };
        Renderer.prototype.renderKernel = function(bnum, start, end) {
            var
                adjust, adjustSize, bias, builder, builderIndex, divisor, i, j, k, kernel, n, name, p, pixel, res, _i, _j, _k;
            name = this.currentJob.name;
            bias = this.currentJob.bias;
            divisor = this.currentJob.divisor;
            n = this.c.pixelData.length;
            adjust = this.currentJob.adjust;
            adjustSize = Math.sqrt(adjust.length);
            kernel = [];
            Log.debug("Rendering kernel - Filter: " + this.currentJob.name);
            start = Math.max(start, this.c.dimensions.width * 4 * ((adjustSize - 1) / 2));
            end = Math.min(end, n - (this.c.dimensions.width * 4 * ((adjustSize - 1) / 2)));
            builder = (adjustSize - 1) / 2;
            pixel = new
            Pixel();
            pixel.setContext(this.c);
            for (i = _i = start; _i < end; i = _i += 4) {
                pixel.loc = i;
                builderIndex = 0;
                for (j = _j = -builder; - builder <= builder ? _j <= builder : _j >= builder; j = -builder <= builder ? ++_j : --_j) {
                    for (k = _k = builder; builder <= -builder ? _k <= -builder : _k >= -builder; k = builder <= -builder ? ++_k : --_k) {
                        p = pixel.getPixelRelative(j, k);
                        kernel[builderIndex * 3] = p.r;
                        kernel[builderIndex * 3 + 1] = p.g;
                        kernel[builderIndex * 3 + 2] = p.b;
                        builderIndex++;
                    }
                }
                res = this.processKernel(adjust, kernel, divisor, bias);
                this.modPixelData[i] = Util.clampRGB(res.r);
                this.modPixelData[i + 1] = Util.clampRGB(res.g);
                this.modPixelData[i + 2] = Util.clampRGB(res.b);
                this.modPixelData[i + 3] = this.c.pixelData[i + 3];
            }
            if (Caman.NodeJS) {
                return Fiber["yield"](bnum);
            } else {
                return this.blockFinished(bnum);
            }
        };
        Renderer.prototype.blockFinished = function(bnum) {
            var
                i, _i, _ref;
            if (bnum >= 0) {
                Log.debug("Block #" + bnum + " finished! Filter: " + this.currentJob.name);
            }
            this.blocksDone++;
            Event.trigger(this.c, "blockFinished", {
                blockNum: bnum,
                blocksFinished: this.blocksDone,
                totalBlocks: Renderer.Blocks
            });
            if (this.blocksDone === Renderer.Blocks) {
                if (this.currentJob.type === Filter.Type.Kernel) {
                    for (i = _i = 0, _ref = this.c.pixelData.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
                        this.c.pixelData[i] = this.modPixelData[i];
                    }
                }
                if (bnum >= 0) {
                    Log.debug("Filter " + this.currentJob.name + " finished!");
                }
                Event.trigger(this.c, "processComplete", this.currentJob);
                return this.processNext();
            }
        };
        Renderer.prototype.processKernel = function(adjust, kernel, divisor, bias) {
            var
                i, val, _i, _ref;
            val = {
                r: 0,
                g: 0,
                b: 0
            };
            for (i = _i = 0, _ref = adjust.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
                val.r += adjust[i] * kernel[i * 3];
                val.g += adjust[i] * kernel[i * 3 + 1];
                val.b += adjust[i] * kernel[i * 3 + 2];
            }
            val.r = (val.r / divisor) + bias;
            val.g = (val.g / divisor) + bias;
            val.b = (val.b / divisor) + bias;
            return val;
        };
        Renderer.prototype.loadOverlay = function(layer, src) {
            var
                img, proxyUrl, _this = this;
            img = document.createElement('img');
            img.onload = function() {
                layer.context.drawImage(img, 0, 0, _this.c.dimensions.width, _this.c.dimensions.height);
                layer.imageData = layer.context.getImageData(0, 0, _this.c.dimensions.width, _this.c.dimensions.height);
                layer.pixelData = layer.imageData.data;
                _this.c.pixelData = layer.pixelData;
                return _this.processNext();
            };
            proxyUrl = IO.remoteCheck(src);
            return img.src = proxyUrl != null ? proxyUrl : src;
        };
        return Renderer;
    })();
    Renderer = Caman.Renderer;
    Caman.Store = (function() {
        function
        Store() {}
        Store.items = {};
        Store.has = function(search) {
            return this.items[search] != null;
        };
        Store.get = function(search) {
            return this.items[search];
        };
        Store.put = function(name, obj) {
            return this.items[name] = obj;
        };
        Store.execute = function(search, callback) {
            var
                _this = this;
            setTimeout(function() {
                return callback.call(_this.get(search), _this.get(search));
            }, 0);
            return this.get(search);
        };
        Store.flush = function(name) {
            if (name == null) {
                name = false;
            }
            if (name) {
                return delete
                this.items[name];
            } else {
                return this.items = {};
            }
        };
        return Store;
    })();
    Store = Caman.Store;
    Blender.register("normal", function(rgbaLayer, rgbaParent) {
        return {
            r: rgbaLayer.r,
            g: rgbaLayer.g,
            b: rgbaLayer.b
        };
    });
    Blender.register("multiply", function(rgbaLayer, rgbaParent) {
        return {
            r: (rgbaLayer.r * rgbaParent.r) / 255,
            g: (rgbaLayer.g * rgbaParent.g) / 255,
            b: (rgbaLayer.b * rgbaParent.b) / 255
        };
    });
    Blender.register("screen", function(rgbaLayer, rgbaParent) {
        return {
            r: 255 - (((255 - rgbaLayer.r) * (255 - rgbaParent.r)) / 255),
            g: 255 - (((255 - rgbaLayer.g) * (255 - rgbaParent.g)) / 255),
            b: 255 - (((255 - rgbaLayer.b) * (255 - rgbaParent.b)) / 255)
        };
    });
    Blender.register("overlay", function(rgbaLayer, rgbaParent) {
        var
            result;
        result = {};
        result.r = rgbaParent.r > 128 ? 255 - 2 * (255 - rgbaLayer.r) * (255 - rgbaParent.r) / 255 : (rgbaParent.r * rgbaLayer.r * 2) / 255;
        result.g = rgbaParent.g > 128 ? 255 - 2 * (255 - rgbaLayer.g) * (255 - rgbaParent.g) / 255 : (rgbaParent.g * rgbaLayer.g * 2) / 255;
        result.b = rgbaParent.b > 128 ? 255 - 2 * (255 - rgbaLayer.b) * (255 - rgbaParent.b) / 255 : (rgbaParent.b * rgbaLayer.b * 2) / 255;
        return result;
    });
    Blender.register("difference", function(rgbaLayer, rgbaParent) {
        return {
            r: rgbaLayer.r - rgbaParent.r,
            g: rgbaLayer.g - rgbaParent.g,
            b: rgbaLayer.b - rgbaParent.b
        };
    });
    Blender.register("addition", function(rgbaLayer, rgbaParent) {
        return {
            r: rgbaParent.r + rgbaLayer.r,
            g: rgbaParent.g + rgbaLayer.g,
            b: rgbaParent.b + rgbaLayer.b
        };
    });
    Blender.register("exclusion", function(rgbaLayer, rgbaParent) {
        return {
            r: 128 - 2 * (rgbaParent.r - 128) * (rgbaLayer.r - 128) / 255,
            g: 128 - 2 * (rgbaParent.g - 128) * (rgbaLayer.g - 128) / 255,
            b: 128 - 2 * (rgbaParent.b - 128) * (rgbaLayer.b - 128) / 255
        };
    });
    Blender.register("softLight", function(rgbaLayer, rgbaParent) {
        var
            result;
        result = {};
        result.r = rgbaParent.r > 128 ? 255 - ((255 - rgbaParent.r) * (255 - (rgbaLayer.r - 128))) / 255 : (rgbaParent.r * (rgbaLayer.r + 128)) / 255;
        result.g = rgbaParent.g > 128 ? 255 - ((255 - rgbaParent.g) * (255 - (rgbaLayer.g - 128))) / 255 : (rgbaParent.g * (rgbaLayer.g + 128)) / 255;
        result.b = rgbaParent.b > 128 ? 255 - ((255 - rgbaParent.b) * (255 - (rgbaLayer.b - 128))) / 255 : (rgbaParent.b * (rgbaLayer.b + 128)) / 255;
        return result;
    });
    Blender.register("lighten", function(rgbaLayer, rgbaParent) {
        return {
            r: rgbaParent.r > rgbaLayer.r ? rgbaParent.r : rgbaLayer.r,
            g: rgbaParent.g > rgbaLayer.g ? rgbaParent.g : rgbaLayer.g,
            b: rgbaParent.b > rgbaLayer.b ? rgbaParent.b : rgbaLayer.b
        };
    });
    Blender.register("darken", function(rgbaLayer, rgbaParent) {
        return {
            r: rgbaParent.r > rgbaLayer.r ? rgbaLayer.r : rgbaParent.r,
            g: rgbaParent.g > rgbaLayer.g ? rgbaLayer.g : rgbaParent.g,
            b: rgbaParent.b > rgbaLayer.b ? rgbaLayer.b : rgbaParent.b
        };
    });
    Filter.register("fillColor", function() {
        var
            color;
        if (arguments.length === 1) {
            color = Convert.hexToRGB(arguments[0]);
        } else {
            color = {
                r: arguments[0],
                g: arguments[1],
                b: arguments[2]
            };
        }
        return this.process("fillColor", function(rgba) {
            rgba.r = color.r;
            rgba.g = color.g;
            rgba.b = color.b;
            rgba.a = 255;
            return rgba;
        });
    });
    Filter.register("brightness", function(adjust) {
        adjust = Math.floor(255 * (adjust / 100));
        return this.process("brightness", function(rgba) {
            rgba.r += adjust;
            rgba.g += adjust;
            rgba.b += adjust;
            return rgba;
        });
    });
    Filter.register("saturation", function(adjust) {
        adjust *= -0.01;
        return this.process("saturation", function(rgba) {
            var
                max;
            max = Math.max(rgba.r, rgba.g, rgba.b);
            if (rgba.r !== max) {
                rgba.r += (max - rgba.r) * adjust;
            }
            if (rgba.g !== max) {
                rgba.g += (max - rgba.g) * adjust;
            }
            if (rgba.b !== max) {
                rgba.b += (max - rgba.b) * adjust;
            }
            return rgba;
        });
    });
    Filter.register("vibrance", function(adjust) {
        adjust *= -1;
        return this.process("vibrance", function(rgba) {
            var
                amt, avg, max;
            max = Math.max(rgba.r, rgba.g, rgba.b);
            avg = (rgba.r + rgba.g + rgba.b) / 3;
            amt = ((Math.abs(max - avg) * 2 / 255) * adjust) / 100;
            if (rgba.r !== max) {
                rgba.r += (max - rgba.r) * amt;
            }
            if (rgba.g !== max) {
                rgba.g += (max - rgba.g) * amt;
            }
            if (rgba.b !== max) {
                rgba.b += (max - rgba.b) * amt;
            }
            return rgba;
        });
    });
    Filter.register("greyscale", function(adjust) {
        return this.process("greyscale", function(rgba) {
            var
                avg;
            avg = Calculate.luminance(rgba);
            rgba.r = avg;
            rgba.g = avg;
            rgba.b = avg;
            return rgba;
        });
    });
    Filter.register("contrast", function(adjust) {
        adjust = Math.pow((adjust + 100) / 100, 2);
        return this.process("contrast", function(rgba) {
            rgba.r /= 255;
            rgba.r -= 0.5;
            rgba.r *= adjust;
            rgba.r += 0.5;
            rgba.r *= 255;
            rgba.g /= 255;
            rgba.g -= 0.5;
            rgba.g *= adjust;
            rgba.g += 0.5;
            rgba.g *= 255;
            rgba.b /= 255;
            rgba.b -= 0.5;
            rgba.b *= adjust;
            rgba.b += 0.5;
            rgba.b *= 255;
            return rgba;
        });
    });
    Filter.register("hue", function(adjust) {
        return this.process("hue", function(rgba) {
            var
                b, g, h, hsv, r, _ref;
            hsv = Convert.rgbToHSV(rgba.r, rgba.g, rgba.b);
            h = hsv.h * 100;
            h += Math.abs(adjust);
            h = h % 100;
            h /= 100;
            hsv.h = h;
            _ref = Convert.hsvToRGB(hsv.h, hsv.s, hsv.v), r = _ref.r, g = _ref.g, b = _ref.b;
            rgba.r = r;
            rgba.g = g;
            rgba.b = b;
            return rgba;
        });
    });
    Filter.register("colorize", function() {
        var
            level, rgb;
        if (arguments.length === 2) {
            rgb = Convert.hexToRGB(arguments[0]);
            level = arguments[1];
        } else
        if (arguments.length === 4) {
            rgb = {
                r: arguments[0],
                g: arguments[1],
                b: arguments[2]
            };
            level = arguments[3];
        }
        return this.process("colorize", function(rgba) {
            rgba.r -= (rgba.r - rgb.r) * (level / 100);
            rgba.g -= (rgba.g - rgb.g) * (level / 100);
            rgba.b -= (rgba.b - rgb.b) * (level / 100);
            return rgba;
        });
    });
    Filter.register("invert", function() {
        return this.process("invert", function(rgba) {
            rgba.r = 255 - rgba.r;
            rgba.g = 255 - rgba.g;
            rgba.b = 255 - rgba.b;
            return rgba;
        });
    });
    Filter.register("sepia", function(adjust) {
        if (adjust == null) {
            adjust = 100;
        }
        adjust /= 100;
        return this.process("sepia", function(rgba) {
            rgba.r = Math.min(255, (rgba.r * (1 - (0.607 * adjust))) + (rgba.g * (0.769 * adjust)) + (rgba.b * (0.189 * adjust)));
            rgba.g = Math.min(255, (rgba.r * (0.349 * adjust)) + (rgba.g * (1 - (0.314 * adjust))) + (rgba.b * (0.168 * adjust)));
            rgba.b = Math.min(255, (rgba.r * (0.272 * adjust)) + (rgba.g * (0.534 * adjust)) + (rgba.b * (1 - (0.869 * adjust))));
            return rgba;
        });
    });
    Filter.register("gamma", function(adjust) {
        return this.process("gamma", function(rgba) {
            rgba.r = Math.pow(rgba.r / 255, adjust) * 255;
            rgba.g = Math.pow(rgba.g / 255, adjust) * 255;
            rgba.b = Math.pow(rgba.b / 255, adjust) * 255;
            return rgba;
        });
    });
    Filter.register("noise", function(adjust) {
        adjust = Math.abs(adjust) * 2.55;
        return this.process("noise", function(rgba) {
            var
                rand;
            rand = Calculate.randomRange(adjust * -1, adjust);
            rgba.r += rand;
            rgba.g += rand;
            rgba.b += rand;
            return rgba;
        });
    });
    Filter.register("clip", function(adjust) {
        adjust = Math.abs(adjust) * 2.55;
        return this.process("clip", function(rgba) {
            if (rgba.r > 255 - adjust) {
                rgba.r = 255;
            } else
            if (rgba.r < adjust) {
                rgba.r = 0;
            }
            if (rgba.g > 255 - adjust) {
                rgba.g = 255;
            } else
            if (rgba.g < adjust) {
                rgba.g = 0;
            }
            if (rgba.b > 255 - adjust) {
                rgba.b = 255;
            } else
            if (rgba.b < adjust) {
                rgba.b = 0;
            }
            return rgba;
        });
    });
    Filter.register("channels", function(options) {
        var
            chan, value;
        if (typeof options !== "object") {
            return this;
        }
        for (chan in
            options) {
            if (!__hasProp.call(options, chan)) continue;
            value = options[chan];
            if (value === 0) {
                delete
                options[chan];
                continue;
            }
            options[chan] /= 100;
        }
        if (options.length === 0) {
            return this;
        }
        return this.process("channels", function(rgba) {
            if (options.red != null) {
                if (options.red > 0) {
                    rgba.r += (255 - rgba.r) * options.red;
                } else {
                    rgba.r -= rgba.r * Math.abs(options.red);
                }
            }
            if (options.green != null) {
                if (options.green > 0) {
                    rgba.g += (255 - rgba.g) * options.green;
                } else {
                    rgba.g -= rgba.g * Math.abs(options.green);
                }
            }
            if (options.blue != null) {
                if (options.blue > 0) {
                    rgba.b += (255 - rgba.b) * options.blue;
                } else {
                    rgba.b -= rgba.b * Math.abs(options.blue);
                }
            }
            return rgba;
        });
    });
    Filter.register("curves", function() {
        var
            algo, bezier, chans, cps, end, i, last, start, _i, _j, _ref, _ref1;
        chans = arguments[0], cps = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
        last = cps[cps.length - 1];
        if (typeof last === "function") {
            algo = last;
            cps.pop();
        } else
        if (typeof last === "string") {
            algo = Calculate[last];
            cps.pop();
        } else {
            algo = Calculate.bezier;
        }
        if (typeof chans === "string") {
            chans = chans.split("");
        }
        if (chans[0] === "v") {
            chans = ['r', 'g', 'b'];
        }
        if (cps.length < 2) {
            throw "Invalid number of arguments to curves filter";
        }
        bezier = algo(cps, 0, 255);
        start = cps[0];
        if (start[0] > 0) {
            for (i = _i = 0, _ref = start[0]; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
                bezier[i] = start[1];
            }
        }
        end = cps[cps.length - 1];
        if (end[0] < 255) {
            for (i = _j = _ref1 = end[0]; _ref1 <= 255 ? _j <= 255 : _j >= 255; i = _ref1 <= 255 ? ++_j : --_j) {
                bezier[i] = end[1];
            }
        }
        return this.process("curves", function(rgba) {
            var
                _k, _ref2;
            for (i = _k = 0, _ref2 = chans.length; 0 <= _ref2 ? _k < _ref2 : _k > _ref2; i = 0 <= _ref2 ? ++_k : --_k) {
                rgba[chans[i]] = bezier[rgba[chans[i]]];
            }
            return rgba;
        });
    });
    Filter.register("exposure", function(adjust) {
        var
            ctrl1, ctrl2, p;
        p = Math.abs(adjust) / 100;
        ctrl1 = [0, 255 * p];
        ctrl2 = [255 - (255 * p), 255];
        if (adjust < 0) {
            ctrl1 = ctrl1.reverse();
            ctrl2 = ctrl2.reverse();
        }
        return this.curves('rgb', [0, 0], ctrl1, ctrl2, [255, 255]);
    });
    Caman.Plugin.register("crop", function(width, height, x, y) {
        var
            canvas, ctx;
        if (x == null) {
            x = 0;
        }
        if (y == null) {
            y = 0;
        }
        if (typeof exports !== "undefined" && exports !== null) {
            canvas = new
            Canvas(width, height);
        } else {
            canvas = document.createElement('canvas');
            Util.copyAttributes(this.canvas, canvas);
            canvas.width = width;
            canvas.height = height;
        }
        ctx = canvas.getContext('2d');
        ctx.drawImage(this.canvas, x, y, width, height, 0, 0, width, height);
        this.cropCoordinates = {
            x: x,
            y: y
        };
        this.cropped = true;
        return this.replaceCanvas(canvas);
    });
    Caman.Plugin.register("resize", function(newDims) {
        var
            canvas, ctx;
        if (newDims == null) {
            newDims = null;
        }
        if (newDims === null || ((newDims.width == null) && (newDims.height == null))) {
            Log.error("Invalid or missing dimensions given for resize");
            return;
        }
        if (newDims.width == null) {
            newDims.width = this.canvas.width * newDims.height / this.canvas.height;
        } else
        if (newDims.height == null) {
            newDims.height = this.canvas.height * newDims.width / this.canvas.width;
        }
        if (typeof exports !== "undefined" && exports !== null) {
            canvas = new
            Canvas(newDims.width, newDims.height);
        } else {
            canvas = document.createElement('canvas');
            Util.copyAttributes(this.canvas, canvas);
            canvas.width = newDims.width;
            canvas.height = newDims.height;
        }
        ctx = canvas.getContext('2d');
        ctx.drawImage(this.canvas, 0, 0, this.canvas.width, this.canvas.height, 0, 0, newDims.width, newDims.height);
        this.resized = true;
        return this.replaceCanvas(canvas);
    });
    Caman.Filter.register("crop", function() {
        return this.processPlugin("crop", Array.prototype.slice.call(arguments, 0));
    });
    Caman.Filter.register("resize", function() {
        return this.processPlugin("resize", Array.prototype.slice.call(arguments, 0));
    });
    Caman.Filter.register("boxBlur", function() {
        return this.processKernel("Box Blur", [1, 1, 1, 1, 1, 1, 1, 1, 1]);
    });
    Caman.Filter.register("heavyRadialBlur", function() {
        return this.processKernel("Heavy Radial Blur", [0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0]);
    });
    Caman.Filter.register("gaussianBlur", function() {
        return this.processKernel("Gaussian Blur", [1, 4, 6, 4, 1, 4, 16, 24, 16, 4, 6, 24, 36, 24, 6, 4, 16, 24, 16, 4, 1, 4, 6, 4, 1]);
    });
    Caman.Filter.register("motionBlur", function(degrees) {
        var
            kernel;
        if (degrees === 0 || degrees === 180) {
            kernel = [0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0];
        } else
        if ((degrees > 0 && degrees < 90) || (degrees > 180 && degrees < 270)) {
            kernel = [0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0];
        } else
        if (degrees === 90 || degrees === 270) {
            kernel = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        } else {
            kernel = [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1];
        }
        return this.processKernel("Motion Blur", kernel);
    });
    Caman.Filter.register("sharpen", function(amt) {
        if (amt == null) {
            amt = 100;
        }
        amt /= 100;
        return this.processKernel("Sharpen", [0, -amt, 0, -amt, 4 * amt + 1, -amt, 0, -amt, 0]);
    });
    vignetteFilters = {
        brightness: function(rgba, amt, opts) {
            rgba.r = rgba.r - (rgba.r * amt * opts.strength);
            rgba.g = rgba.g - (rgba.g * amt * opts.strength);
            rgba.b = rgba.b - (rgba.b * amt * opts.strength);
            return rgba;
        },
        gamma: function(rgba, amt, opts) {
            rgba.r = Math.pow(rgba.r / 255, Math.max(10 * amt * opts.strength, 1)) * 255;
            rgba.g = Math.pow(rgba.g / 255, Math.max(10 * amt * opts.strength, 1)) * 255;
            rgba.b = Math.pow(rgba.b / 255, Math.max(10 * amt * opts.strength, 1)) * 255;
            return rgba;
        },
        colorize: function(rgba, amt, opts) {
            rgba.r -= (rgba.r - opts.color.r) * amt;
            rgba.g -= (rgba.g - opts.color.g) * amt;
            rgba.b -= (rgba.b - opts.color.b) * amt;
            return rgba;
        }
    };
    Filter.register("vignette", function(size, strength) {
        var
            bezier, center, end, start;
        if (strength == null) {
            strength = 60;
        }
        if (typeof size === "string" && size.substr(-1) === "%") {
            if (this.dimensions.height > this.dimensions.width) {
                size = this.dimensions.width * (parseInt(size.substr(0, size.length - 1), 10) / 100);
            } else {
                size = this.dimensions.height * (parseInt(size.substr(0, size.length - 1), 10) / 100);
            }
        }
        strength /= 100;
        center = [this.dimensions.width / 2, this.dimensions.height / 2];
        start = Math.sqrt(Math.pow(center[0], 2) + Math.pow(center[1], 2));
        end = start - size;
        bezier = Calculate.bezier([0, 1], [30, 30], [70, 60], [100, 80]);
        return this.process("vignette", function(rgba) {
            var
                dist, div, loc;
            loc = rgba.locationXY();
            dist = Calculate.distance(loc.x, loc.y, center[0], center[1]);
            if (dist > end) {
                div = Math.max(1, (bezier[Math.round(((dist - end) / size) * 100)] / 10) * strength);
                rgba.r = Math.pow(rgba.r / 255, div) * 255;
                rgba.g = Math.pow(rgba.g / 255, div) * 255;
                rgba.b = Math.pow(rgba.b / 255, div) * 255;
            }
            return rgba;
        });
    });
    Filter.register("rectangularVignette", function(opts) {
        var
            defaults, dim, percent, size, _i, _len, _ref;
        defaults = {
            strength: 50,
            cornerRadius: 0,
            method: 'brightness',
            color: {
                r: 0,
                g: 0,
                b: 0
            }
        };
        opts = Util.extend(defaults, opts);
        if (!opts.size) {
            return this;
        } else
        if (typeof opts.size === "string") {
            percent = parseInt(opts.size, 10) / 100;
            opts.size = {
                width: this.dimensions.width * percent,
                height: this.dimensions.height * percent
            };
        } else
        if (typeof opts.size === "object") {
            _ref = ["width", "height"];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                dim = _ref[_i];
                if (typeof opts.size[dim] === "string") {
                    opts.size[dim] = this.dimensions[dim] * (parseInt(opts.size[dim], 10) / 100);
                }
            }
        } else
        if (opts.size === "number") {
            size = opts.size;
            opts.size = {
                width: size,
                height: size
            };
        }
        if (typeof opts.cornerRadius === "string") {
            opts.cornerRadius = (opts.size.width / 2) * (parseInt(opts.cornerRadius, 10) / 100);
        }
        opts.strength /= 100;
        opts.size.width = Math.floor(opts.size.width);
        opts.size.height = Math.floor(opts.size.height);
        opts.image = {
            width: this.dimensions.width,
            height: this.dimensions.height
        };
        if (opts.method === "colorize" && typeof opts.color === "string") {
            opts.color = Convert.hexToRGB(opts.color);
        }
        opts.coords = {
            left: (this.dimensions.width - opts.size.width) / 2,
            right: this.dimensions.width - opts.coords.left,
            bottom: (this.dimensions.height - opts.size.height) / 2,
            top: this.dimensions.height - opts.coords.bottom
        };
        opts.corners = [{
            x: opts.coords.left + opts.cornerRadius,
            y: opts.coords.top - opts.cornerRadius
        }, {
            x: opts.coords.right - opts.cornerRadius,
            y: opts.coords.top - opts.cornerRadius
        }, {
            x: opts.coords.right - opts.cornerRadius,
            y: opts.coords.bottom + opts.cornerRadius
        }, {
            x: opts.coords.left + opts.cornerRadius,
            y: opts.coords.bottom + opts.cornerRadius
        }];
        opts.maxDist = Calculate.distance(0, 0, opts.corners[3].x, opts.corners[3].y) - opts.cornerRadius;
        return this.process("rectangularVignette", function(rgba) {
            var
                amt, loc, radialDist;
            loc = rgba.locationXY();
            if ((loc.x > opts.corners[0].x && loc.x < opts.corners[1].x) && (loc.y > opts.coords.bottom && loc.y < opts.coords.top)) {
                return rgba;
            }
            if ((loc.x > opts.coords.left && loc.x < opts.coords.right) && (loc.y > opts.corners[3].y && loc.y < opts.corners[2].y)) {
                return rgba;
            }
            if (loc.x > opts.corners[0].x && loc.x < opts.corners[1].x && loc.y > opts.coords.top) {
                amt = (loc.y - opts.coords.top) / opts.maxDist;
            } else
            if (loc.y > opts.corners[2].y && loc.y < opts.corners[1].y && loc.x > opts.coords.right) {
                amt = (loc.x - opts.coords.right) / opts.maxDist;
            } else
            if (loc.x > opts.corners[0].x && loc.x < opts.corners[1].x && loc.y < opts.coords.bottom) {
                amt = (opts.coords.bottom - loc.y) / opts.maxDist;
            } else
            if (loc.y > opts.corners[2].y && loc.y < opts.corners[1].y && loc.x < opts.coords.left) {
                amt = (opts.coords.left - loc.x) / opts.maxDist;
            } else
            if (loc.x <= opts.corners[0].x && loc.y >= opts.corners[0].y) {
                radialDist = Caman.distance(loc.x, loc.y, opts.corners[0].x, opts.corners[0].y);
                amt = (radialDist - opts.cornerRadius) / opts.maxDist;
            } else
            if (loc.x >= opts.corners[1].x && loc.y >= opts.corners[1].y) {
                radialDist = Caman.distance(loc.x, loc.y, opts.corners[1].x, opts.corners[1].y);
                amt = (radialDist - opts.cornerRadius) / opts.maxDist;
            } else
            if (loc.x >= opts.corners[2].x && loc.y <= opts.corners[2].y) {
                radialDist = Caman.distance(loc.x, loc.y, opts.corners[2].x, opts.corners[2].y);
                amt = (radialDist - opts.cornerRadius) / opts.maxDist;
            } else
            if (loc.x <= opts.corners[3].x && loc.y <= opts.corners[3].y) {
                radialDist = Caman.distance(loc.x, loc.y, opts.corners[3].x, opts.corners[3].y);
                amt = (radialDist - opts.cornerRadius) / opts.maxDist;
            }
            if (amt < 0) {
                return rgba;
            }
            return vignetteFilters[opts.method](rgba, amt, opts);
        });
    });
    (function() {
        var
            BlurStack, getLinearGradientMap, getRadialGradientMap, mul_table, shg_table;
        mul_table = [512, 512, 456, 512, 328, 456, 335, 512, 405, 328, 271, 456, 388, 335, 292, 512, 454, 405, 364, 328, 298, 271, 496, 456, 420, 388, 360, 335, 312, 292, 273, 512, 482, 454, 428, 405, 383, 364, 345, 328, 312, 298, 284, 271, 259, 496, 475, 456, 437, 420, 404, 388, 374, 360, 347, 335, 323, 312, 302, 292, 282, 273, 265, 512, 497, 482, 468, 454, 441, 428, 417, 405, 394, 383, 373, 364, 354, 345, 337, 328, 320, 312, 305, 298, 291, 284, 278, 271, 265, 259, 507, 496, 485, 475, 465, 456, 446, 437, 428, 420, 412, 404, 396, 388, 381, 374, 367, 360, 354, 347, 341, 335, 329, 323, 318, 312, 307, 302, 297, 292, 287, 282, 278, 273, 269, 265, 261, 512, 505, 497, 489, 482, 475, 468, 461, 454, 447, 441, 435, 428, 422, 417, 411, 405, 399, 394, 389, 383, 378, 373, 368, 364, 359, 354, 350, 345, 341, 337, 332, 328, 324, 320, 316, 312, 309, 305, 301, 298, 294, 291, 287, 284, 281, 278, 274, 271, 268, 265, 262, 259, 257, 507, 501, 496, 491, 485, 480, 475, 470, 465, 460, 456, 451, 446, 442, 437, 433, 428, 424, 420, 416, 412, 408, 404, 400, 396, 392, 388, 385, 381, 377, 374, 370, 367, 363, 360, 357, 354, 350, 347, 344, 341, 338, 335, 332, 329, 326, 323, 320, 318, 315, 312, 310, 307, 304, 302, 299, 297, 294, 292, 289, 287, 285, 282, 280, 278, 275, 273, 271, 269, 267, 265, 263, 261, 259];
        shg_table = [9, 11, 12, 13, 13, 14, 14, 15, 15, 15, 15, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 18, 18, 18, 18, 18, 18, 18, 18, 18, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24];
        getLinearGradientMap = function(width, height, centerX, centerY, angle, length, mirrored) {
            var
                cnv, context, gradient, x1, x2, y1, y2;
            cnv = typeof
            exports !== "undefined" && exports !== null ? new
            Canvas(): document.createElement('canvas');
            cnv.width = width;
            cnv.height = height;
            x1 = centerX + Math.cos(angle) * length * 0.5;
            y1 = centerY + Math.sin(angle) * length * 0.5;
            x2 = centerX - Math.cos(angle) * length * 0.5;
            y2 = centerY - Math.sin(angle) * length * 0.5;
            context = cnv.getContext("2d");
            gradient = context.createLinearGradient(x1, y1, x2, y2);
            if (!mirrored) {
                gradient.addColorStop(0, "white");
                gradient.addColorStop(1, "black");
            } else {
                gradient.addColorStop(0, "white");
                gradient.addColorStop(0.5, "black");
                gradient.addColorStop(1, "white");
            }
            context.fillStyle = gradient;
            context.fillRect(0, 0, width, height);
            return context.getImageData(0, 0, width, height);
        };
        getRadialGradientMap = function(width, height, centerX, centerY, radius1, radius2) {
            var
                cnv, context, gradient;
            cnv = typeof
            exports !== "undefined" && exports !== null ? new
            Canvas(): document.createElement('canvas');
            cnv.width = width;
            cnv.height = height;
            context = cnv.getContext("2d");
            gradient = context.createRadialGradient(centerX, centerY, radius1, centerX, centerY, radius2);
            gradient.addColorStop(1, "white");
            gradient.addColorStop(0, "black");
            context.fillStyle = gradient;
            context.fillRect(0, 0, width, height);
            return context.getImageData(0, 0, width, height);
        };
        BlurStack = function() {
            this.r = 0;
            this.g = 0;
            this.b = 0;
            this.a = 0;
            return this.next = null;
        };
        Caman.Plugin.register("compoundBlur", function(radiusData, radius, increaseFactor, blurLevels) {
            var
                b_in_sum, b_out_sum, b_sum, blend, currentIndex, div, g_in_sum, g_out_sum, g_sum, height, heightMinus1, i, iblend, idx, imagePixels, index, iradius, lookupValue, mul_sum, p, pb, pg, pixels, pr, r_in_sum, r_out_sum, r_sum, radiusPixels, radiusPlus1, rbs, shg_sum, stack, stackEnd, stackIn, stackOut, stackStart, steps, sumFactor, w4, wh, wh4, width, widthMinus1, x, y, yi, yp, yw, _i, _j, _k, _l, _m, _n, _o, _p, _q, _r;
            width = this.dimensions.width;
            height = this.dimensions.height;
            imagePixels = this.pixelData;
            radiusPixels = radiusData.data;
            wh = width * height;
            wh4 = wh << 2;
            pixels = [];
            for (i = _i = 0; 0 <= wh4 ? _i < wh4 : _i > wh4; i = 0 <= wh4 ? ++_i : --_i) {
                pixels[i] = imagePixels[i];
            }
            currentIndex = 0;
            steps = blurLevels;
            blurLevels -= 1;
            while (steps-- >= 0) {
                iradius = (radius + 0.5) | 0;
                if (iradius === 0) {
                    continue;
                }
                if (iradius > 256) {
                    iradius = 256;
                }
                div = iradius + iradius + 1;
                w4 = width << 2;
                widthMinus1 = width - 1;
                heightMinus1 = height - 1;
                radiusPlus1 = iradius + 1;
                sumFactor = radiusPlus1 * (radiusPlus1 + 1) / 2;
                stackStart = new
                BlurStack();
                stackEnd = void
                0;
                stack = stackStart;
                for (i = _j = 1; 1 <= div ? _j < div : _j > div; i = 1 <= div ? ++_j : --_j) {
                    stack = stack.next = new
                    BlurStack();
                    if (i === radiusPlus1) {
                        stackEnd = stack;
                    }
                }
                stack.next = stackStart;
                stackIn = null;
                stackOut = null;
                yw = yi = 0;
                mul_sum = mul_table[iradius];
                shg_sum = shg_table[iradius];
                for (y = _k = 0; 0 <= height ? _k < height : _k > height; y = 0 <= height ? ++_k : --_k) {
                    r_in_sum = g_in_sum = b_in_sum = r_sum = g_sum = b_sum = 0;
                    r_out_sum = radiusPlus1 * (pr = pixels[yi]);
                    g_out_sum = radiusPlus1 * (pg = pixels[yi + 1]);
                    b_out_sum = radiusPlus1 * (pb = pixels[yi + 2]);
                    r_sum += sumFactor * pr;
                    g_sum += sumFactor * pg;
                    b_sum += sumFactor * pb;
                    stack = stackStart;
                    for (i = _l = 0; 0 <= radiusPlus1 ? _l < radiusPlus1 : _l > radiusPlus1; i = 0 <= radiusPlus1 ? ++_l : --_l) {
                        stack.r = pr;
                        stack.g = pg;
                        stack.b = pb;
                        stack = stack.next;
                    }
                    for (i = _m = 1; 1 <= radiusPlus1 ? _m < radiusPlus1 : _m > radiusPlus1; i = 1 <= radiusPlus1 ? ++_m : --_m) {
                        p = yi + ((widthMinus1 < i ? widthMinus1 : i) << 2);
                        r_sum += (stack.r = (pr = pixels[p])) * (rbs = radiusPlus1 - i);
                        g_sum += (stack.g = (pg = pixels[p + 1])) * rbs;
                        b_sum += (stack.b = (pb = pixels[p + 2])) * rbs;
                        r_in_sum += pr;
                        g_in_sum += pg;
                        b_in_sum += pb;
                        stack = stack.next;
                    }
                    stackIn = stackStart;
                    stackOut = stackEnd;
                    for (x = _n = 0; 0 <= width ? _n < width : _n > width; x = 0 <= width ? ++_n : --_n) {
                        pixels[yi] = (r_sum * mul_sum) >> shg_sum;
                        pixels[yi + 1] = (g_sum * mul_sum) >> shg_sum;
                        pixels[yi + 2] = (b_sum * mul_sum) >> shg_sum;
                        r_sum -= r_out_sum;
                        g_sum -= g_out_sum;
                        b_sum -= b_out_sum;
                        r_out_sum -= stackIn.r;
                        g_out_sum -= stackIn.g;
                        b_out_sum -= stackIn.b;
                        p = (yw + ((p = x + radiusPlus1) < widthMinus1 ? p : widthMinus1)) << 2;
                        r_in_sum += (stackIn.r = pixels[p]);
                        g_in_sum += (stackIn.g = pixels[p + 1]);
                        b_in_sum += (stackIn.b = pixels[p + 2]);
                        r_sum += r_in_sum;
                        g_sum += g_in_sum;
                        b_sum += b_in_sum;
                        stackIn = stackIn.next;
                        r_out_sum += (pr = stackOut.r);
                        g_out_sum += (pg = stackOut.g);
                        b_out_sum += (pb = stackOut.b);
                        r_in_sum -= pr;
                        g_in_sum -= pg;
                        b_in_sum -= pb;
                        stackOut = stackOut.next;
                        yi += 4;
                    }
                    yw += width;
                }
                for (x = _o = 0; 0 <= width ? _o < width : _o > width; x = 0 <= width ? ++_o : --_o) {
                    g_in_sum = b_in_sum = r_in_sum = g_sum = b_sum = r_sum = 0;
                    yi = x << 2;
                    r_out_sum = radiusPlus1 * (pr = pixels[yi]);
                    g_out_sum = radiusPlus1 * (pg = pixels[yi + 1]);
                    b_out_sum = radiusPlus1 * (pb = pixels[yi + 2]);
                    r_sum += sumFactor * pr;
                    g_sum += sumFactor * pg;
                    b_sum += sumFactor * pb;
                    stack = stackStart;
                    for (i = _p = 0; 0 <= radiusPlus1 ? _p < radiusPlus1 : _p > radiusPlus1; i = 0 <= radiusPlus1 ? ++_p : --_p) {
                        stack.r = pr;
                        stack.g = pg;
                        stack.b = pb;
                        stack = stack.next;
                    }
                    yp = width;
                    for (i = _q = 1; 1 <= radiusPlus1 ? _q < radiusPlus1 : _q > radiusPlus1; i = 1 <= radiusPlus1 ? ++_q : --_q) {
                        yi = (yp + x) << 2;
                        r_sum += (stack.r = (pr = pixels[yi])) * (rbs = radiusPlus1 - i);
                        g_sum += (stack.g = (pg = pixels[yi + 1])) * rbs;
                        b_sum += (stack.b = (pb = pixels[yi + 2])) * rbs;
                        r_in_sum += pr;
                        g_in_sum += pg;
                        b_in_sum += pb;
                        stack = stack.next;
                        if (i < heightMinus1) {
                            yp += width;
                        }
                    }
                    yi = x;
                    stackIn = stackStart;
                    stackOut = stackEnd;
                    for (y = _r = 0; 0 <= height ? _r < height : _r > height; y = 0 <= height ? ++_r : --_r) {
                        p = yi << 2;
                        pixels[p] = (r_sum * mul_sum) >> shg_sum;
                        pixels[p + 1] = (g_sum * mul_sum) >> shg_sum;
                        pixels[p + 2] = (b_sum * mul_sum) >> shg_sum;
                        r_sum -= r_out_sum;
                        g_sum -= g_out_sum;
                        b_sum -= b_out_sum;
                        r_out_sum -= stackIn.r;
                        g_out_sum -= stackIn.g;
                        b_out_sum -= stackIn.b;
                        p = (x + (((p = y + radiusPlus1) < heightMinus1 ? p : heightMinus1) * width)) << 2;
                        r_sum += (r_in_sum += (stackIn.r = pixels[p]));
                        g_sum += (g_in_sum += (stackIn.g = pixels[p + 1]));
                        b_sum += (b_in_sum += (stackIn.b = pixels[p + 2]));
                        stackIn = stackIn.next;
                        r_out_sum += (pr = stackOut.r);
                        g_out_sum += (pg = stackOut.g);
                        b_out_sum += (pb = stackOut.b);
                        r_in_sum -= pr;
                        g_in_sum -= pg;
                        b_in_sum -= pb;
                        stackOut = stackOut.next;
                        yi += width;
                    }
                }
                radius *= increaseFactor;
                i = wh;
                while (--i > -1) {
                    idx = i << 2;
                    lookupValue = (radiusPixels[idx + 2] & 0xff) / 255.0 * blurLevels;
                    index = lookupValue | 0;
                    if (index === currentIndex) {
                        blend = 256.0 * (lookupValue - (lookupValue | 0));
                        iblend = 256 - blend;
                        imagePixels[idx] = (imagePixels[idx] * iblend + pixels[idx] * blend) >> 8;
                        imagePixels[idx + 1] = (imagePixels[idx + 1] * iblend + pixels[idx + 1] * blend) >> 8;
                        imagePixels[idx + 2] = (imagePixels[idx + 2] * iblend + pixels[idx + 2] * blend) >> 8;
                    } else
                    if (index === currentIndex + 1) {
                        imagePixels[idx] = pixels[idx];
                        imagePixels[idx + 1] = pixels[idx + 1];
                        imagePixels[idx + 2] = pixels[idx + 2];
                    }
                }
                currentIndex++;
            }
            return this;
        });
        Caman.Filter.register("tiltShift", function(opts) {
            var
                defaults, gradient;
            defaults = {
                center: {
                    x: this.dimensions.width / 2,
                    y: this.dimensions.height / 2
                },
                angle: 45,
                focusWidth: 200,
                startRadius: 3,
                radiusFactor: 1.5,
                steps: 3
            };
            opts = Util.extend(defaults, opts);
            opts.angle *= Math.PI / 180;
            gradient = getLinearGradientMap(this.dimensions.width, this.dimensions.height, opts.center.x, opts.center.y, opts.angle, opts.focusWidth, true);
            return this.processPlugin("compoundBlur", [gradient, opts.startRadius, opts.radiusFactor, opts.steps]);
        });
        return Caman.Filter.register("radialBlur", function(opts) {
            var
                defaults, gradient, radius1, radius2;
            defaults = {
                size: 50,
                center: {
                    x: this.dimensions.width / 2,
                    y: this.dimensions.height / 2
                },
                startRadius: 3,
                radiusFactor: 1.5,
                steps: 3,
                radius: null
            };
            opts = Util.extend(defaults, opts);
            if (!opts.radius) {
                opts.radius = this.dimensions.width < this.dimensions.height ? this.dimensions.height : this.dimensions.width;
            }
            radius1 = (opts.radius / 2) - opts.size;
            radius2 = opts.radius / 2;
            gradient = getRadialGradientMap(this.dimensions.width, this.dimensions.height, opts.center.x, opts.center.y, radius1, radius2);
            return this.processPlugin("compoundBlur", [gradient, opts.startRadius, opts.radiusFactor, opts.steps]);
        });
    })();
    Caman.Filter.register("edgeEnhance", function() {
        return this.processKernel("Edge Enhance", [0, 0, 0, -1, 1, 0, 0, 0, 0]);
    });
    Caman.Filter.register("edgeDetect", function() {
        return this.processKernel("Edge Detect", [-1, -1, -1, -1, 8, -1, -1, -1, -1]);
    });
    Caman.Filter.register("emboss", function() {
        return this.processKernel("Emboss", [-2, -1, 0, -1, 1, 1, 0, 1, 2]);
    });
    Caman.Filter.register("posterize", function(adjust) {
        var
            numOfAreas, numOfValues;
        numOfAreas = 256 / adjust;
        numOfValues = 255 / (adjust - 1);
        return this.process("posterize", function(rgba) {
            rgba.r = Math.floor(Math.floor(rgba.r / numOfAreas) * numOfValues);
            rgba.g = Math.floor(Math.floor(rgba.g / numOfAreas) * numOfValues);
            rgba.b = Math.floor(Math.floor(rgba.b / numOfAreas) * numOfValues);
            return rgba;
        });
    });
    Caman.Filter.register("vintage", function(vignette) {
        if (vignette == null) {
            vignette = true;
        }
        this.greyscale();
        this.contrast(5);
        this.noise(3);
        this.sepia(100);
        this.channels({
            red: 8,
            blue: 2,
            green: 4
        });
        this.gamma(0.87);
        if (vignette) {
            return this.vignette("40%", 30);
        }
    });
    Caman.Filter.register("lomo", function(vignette) {
        if (vignette == null) {
            vignette = true;
        }
        this.brightness(15);
        this.exposure(15);
        this.curves('rgb', [0, 0], [200, 0], [155, 255], [255, 255]);
        this.saturation(-20);
        this.gamma(1.8);
        if (vignette) {
            this.vignette("50%", 60);
        }
        return this.brightness(5);
    });
    Caman.Filter.register("clarity", function(grey) {
        if (grey == null) {
            grey = false;
        }
        this.vibrance(20);
        this.curves('rgb', [5, 0], [130, 150], [190, 220], [250, 255]);
        this.sharpen(15);
        this.vignette("45%", 20);
        if (grey) {
            this.greyscale();
            this.contrast(4);
        }
        return this;
    });
    Caman.Filter.register("sinCity", function() {
        this.contrast(100);
        this.brightness(15);
        this.exposure(10);
        this.posterize(80);
        this.clip(30);
        return this.greyscale();
    });
    Caman.Filter.register("sunrise", function() {
        this.exposure(3.5);
        this.saturation(-5);
        this.vibrance(50);
        this.sepia(60);
        this.colorize("#e87b22", 10);
        this.channels({
            red: 8,
            blue: 8
        });
        this.contrast(5);
        this.gamma(1.2);
        return this.vignette("55%", 25);
    });
    Caman.Filter.register("crossProcess", function() {
        this.exposure(5);
        this.colorize("#e87b22", 4);
        this.sepia(20);
        this.channels({
            blue: 8,
            red: 3
        });
        this.curves('b', [0, 0], [100, 150], [180, 180], [255, 255]);
        this.contrast(15);
        this.vibrance(75);
        return this.gamma(1.6);
    });
    Caman.Filter.register("orangePeel", function() {
        this.curves('rgb', [0, 0], [100, 50], [140, 200], [255, 255]);
        this.vibrance(-30);
        this.saturation(-30);
        this.colorize('#ff9000', 30);
        this.contrast(-5);
        return this.gamma(1.4);
    });
    Caman.Filter.register("love", function() {
        this.brightness(5);
        this.exposure(8);
        this.contrast(4);
        this.colorize('#c42007', 30);
        this.vibrance(50);
        return this.gamma(1.3);
    });
    Caman.Filter.register("grungy", function() {
        this.gamma(1.5);
        this.clip(25);
        this.saturation(-60);
        this.contrast(5);
        this.noise(5);
        return this.vignette("50%", 30);
    });
    Caman.Filter.register("jarques", function() {
        this.saturation(-35);
        this.curves('b', [20, 0], [90, 120], [186, 144], [255, 230]);
        this.curves('r', [0, 0], [144, 90], [138, 120], [255, 255]);
        this.curves('g', [10, 0], [115, 105], [148, 100], [255, 248]);
        this.curves('rgb', [0, 0], [120, 100], [128, 140], [255, 255]);
        return this.sharpen(20);
    });
    Caman.Filter.register("pinhole", function() {
        this.greyscale();
        this.sepia(10);
        this.exposure(10);
        this.contrast(15);
        return this.vignette("60%", 35);
    });
    Caman.Filter.register("oldBoot", function() {
        this.saturation(-20);
        this.vibrance(-50);
        this.gamma(1.1);
        this.sepia(30);
        this.channels({
            red: -10,
            blue: 5
        });
        this.curves('rgb', [0, 0], [80, 50], [128, 230], [255, 255]);
        return this.vignette("60%", 30);
    });
    Caman.Filter.register("glowingSun", function(vignette) {
        if (vignette == null) {
            vignette = true;
        }
        this.brightness(10);
        this.newLayer(function() {
            this.setBlendingMode("multiply");
            this.opacity(80);
            this.copyParent();
            this.filter.gamma(0.8);
            this.filter.contrast(50);
            return this.filter.exposure(10);
        });
        this.newLayer(function() {
            this.setBlendingMode("softLight");
            this.opacity(80);
            return this.fillColor("#f49600");
        });
        this.exposure(20);
        this.gamma(0.8);
        if (vignette) {
            return this.vignette("45%", 20);
        }
    });
    Caman.Filter.register("hazyDays", function() {
        this.gamma(1.2);
        this.newLayer(function() {
            this.setBlendingMode("overlay");
            this.opacity(60);
            this.copyParent();
            this.filter.channels({
                red: 5
            });
            return this.filter.stackBlur(15);
        });
        this.newLayer(function() {
            this.setBlendingMode("addition");
            this.opacity(40);
            return this.fillColor("#6899ba");
        });
        this.newLayer(function() {
            this.setBlendingMode("multiply");
            this.opacity(35);
            this.copyParent();
            this.filter.brightness(40);
            this.filter.vibrance(40);
            this.filter.exposure(30);
            this.filter.contrast(15);
            this.filter.curves('r', [0, 40], [128, 128], [128, 128], [255, 215]);
            this.filter.curves('g', [0, 40], [128, 128], [128, 128], [255, 215]);
            this.filter.curves('b', [0, 40], [128, 128], [128, 128], [255, 215]);
            return this.filter.stackBlur(5);
        });
        this.curves('r', [20, 0], [128, 158], [128, 128], [235, 255]);
        this.curves('g', [20, 0], [128, 128], [128, 128], [235, 255]);
        this.curves('b', [20, 0], [128, 108], [128, 128], [235, 255]);
        return this.vignette("45%", 20);
    });
    Caman.Filter.register("herMajesty", function() {
        this.brightness(40);
        this.colorize("#ea1c5d", 10);
        this.curves('b', [0, 10], [128, 180], [190, 190], [255, 255]);
        this.newLayer(function() {
            this.setBlendingMode('overlay');
            this.opacity(50);
            this.copyParent();
            this.filter.gamma(0.7);
            return this.newLayer(function() {
                this.setBlendingMode('normal');
                this.opacity(60);
                return this.fillColor('#ea1c5d');
            });
        });
        this.newLayer(function() {
            this.setBlendingMode('multiply');
            this.opacity(60);
            this.copyParent();
            this.filter.saturation(50);
            this.filter.hue(90);
            return this.filter.contrast(10);
        });
        this.gamma(1.4);
        this.vibrance(-30);
        this.newLayer(function() {
            this.opacity(10);
            return this.fillColor('#e5f0ff');
        });
        return this;
    });
    Caman.Filter.register("nostalgia", function() {
        this.saturation(20);
        this.gamma(1.4);
        this.greyscale();
        this.contrast(5);
        this.sepia(100);
        this.channels({
            red: 8,
            blue: 2,
            green: 4
        });
        this.gamma(0.8);
        this.contrast(5);
        this.exposure(10);
        this.newLayer(function() {
            this.setBlendingMode('overlay');
            this.copyParent();
            this.opacity(55);
            return this.filter.stackBlur(10);
        });
        return this.vignette("50%", 30);
    });
    Caman.Filter.register("hemingway", function() {
        this.greyscale();
        this.contrast(10);
        this.gamma(0.9);
        this.newLayer(function() {
            this.setBlendingMode("multiply");
            this.opacity(40);
            this.copyParent();
            this.filter.exposure(15);
            this.filter.contrast(15);
            return this.filter.channels({
                green: 10,
                red: 5
            });
        });
        this.sepia(30);
        this.curves('rgb', [0, 10], [120, 90], [180, 200], [235, 255]);
        this.channels({
            red: 5,
            green: -2
        });
        return this.exposure(15);
    });
    Caman.Filter.register("concentrate", function() {
        this.sharpen(40);
        this.saturation(-50);
        this.channels({
            red: 3
        });
        this.newLayer(function() {
            this.setBlendingMode("multiply");
            this.opacity(80);
            this.copyParent();
            this.filter.sharpen(5);
            this.filter.contrast(50);
            this.filter.exposure(10);
            return this.filter.channels({
                blue: 5
            });
        });
        return this.brightness(10);
    });
    Caman.Plugin.register("rotate", function(degrees) {
        var
            angle, canvas, ctx, height, to_radians, width, x, y;
        angle = degrees % 360;
        if (angle === 0) {
            return this.dimensions = {
                width: this.canvas.width,
                height: this.canvas.height
            };
        }
        to_radians = Math.PI / 180;
        if (typeof exports !== "undefined" && exports !== null) {
            canvas = new
            Canvas();
        } else {
            canvas = document.createElement('canvas');
            Util.copyAttributes(this.canvas, canvas);
        }
        if (angle === 90 || angle === -270 || angle === 270 || angle === -90) {
            width = this.canvas.height;
            height = this.canvas.width;
            x = width / 2;
            y = height / 2;
        } else
        if (angle === 180) {
            width = this.canvas.width;
            height = this.canvas.height;
            x = width / 2;
            y = height / 2;
        } else {
            width = Math.sqrt(Math.pow(this.originalWidth, 2) + Math.pow(this.originalHeight, 2));
            height = width;
            x = this.canvas.height / 2;
            y = this.canvas.width / 2;
        }
        canvas.width = width;
        canvas.height = height;
        ctx = canvas.getContext('2d');
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle * to_radians);
        ctx.drawImage(this.canvas, -this.canvas.width / 2, -this.canvas.height / 2, this.canvas.width, this.canvas.height);
        ctx.restore();
        return this.replaceCanvas(canvas);
    });
    Caman.Filter.register("rotate", function() {
        return this.processPlugin("rotate", Array.prototype.slice.call(arguments, 0));
    });
    (function() {
        var
            BlurStack, mul_table, shg_table;
        mul_table = [512, 512, 456, 512, 328, 456, 335, 512, 405, 328, 271, 456, 388, 335, 292, 512, 454, 405, 364, 328, 298, 271, 496, 456, 420, 388, 360, 335, 312, 292, 273, 512, 482, 454, 428, 405, 383, 364, 345, 328, 312, 298, 284, 271, 259, 496, 475, 456, 437, 420, 404, 388, 374, 360, 347, 335, 323, 312, 302, 292, 282, 273, 265, 512, 497, 482, 468, 454, 441, 428, 417, 405, 394, 383, 373, 364, 354, 345, 337, 328, 320, 312, 305, 298, 291, 284, 278, 271, 265, 259, 507, 496, 485, 475, 465, 456, 446, 437, 428, 420, 412, 404, 396, 388, 381, 374, 367, 360, 354, 347, 341, 335, 329, 323, 318, 312, 307, 302, 297, 292, 287, 282, 278, 273, 269, 265, 261, 512, 505, 497, 489, 482, 475, 468, 461, 454, 447, 441, 435, 428, 422, 417, 411, 405, 399, 394, 389, 383, 378, 373, 368, 364, 359, 354, 350, 345, 341, 337, 332, 328, 324, 320, 316, 312, 309, 305, 301, 298, 294, 291, 287, 284, 281, 278, 274, 271, 268, 265, 262, 259, 257, 507, 501, 496, 491, 485, 480, 475, 470, 465, 460, 456, 451, 446, 442, 437, 433, 428, 424, 420, 416, 412, 408, 404, 400, 396, 392, 388, 385, 381, 377, 374, 370, 367, 363, 360, 357, 354, 350, 347, 344, 341, 338, 335, 332, 329, 326, 323, 320, 318, 315, 312, 310, 307, 304, 302, 299, 297, 294, 292, 289, 287, 285, 282, 280, 278, 275, 273, 271, 269, 267, 265, 263, 261, 259];
        shg_table = [9, 11, 12, 13, 13, 14, 14, 15, 15, 15, 15, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 18, 18, 18, 18, 18, 18, 18, 18, 18, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24];
        BlurStack = function() {
            this.r = 0;
            this.g = 0;
            this.b = 0;
            this.a = 0;
            return this.next = null;
        };
        Caman.Plugin.register("stackBlur", function(radius) {
            var
                b_in_sum, b_out_sum, b_sum, div, g_in_sum, g_out_sum, g_sum, height, heightMinus1, i, mul_sum, p, pb, pg, pixels, pr, r_in_sum, r_out_sum, r_sum, radiusPlus1, rbs, shg_sum, stack, stackEnd, stackIn, stackOut, stackStart, sumFactor, w4, width, widthMinus1, x, y, yi, yp, yw, _i, _j, _k, _l, _m, _n, _o, _p, _q;
            if (isNaN(radius) || radius < 1) {
                return;
            }
            radius |= 0;
            pixels = this.pixelData;
            width = this.dimensions.width;
            height = this.dimensions.height;
            div = radius + radius + 1;
            w4 = width << 2;
            widthMinus1 = width - 1;
            heightMinus1 = height - 1;
            radiusPlus1 = radius + 1;
            sumFactor = radiusPlus1 * (radiusPlus1 + 1) / 2;
            stackStart = new
            BlurStack();
            stack = stackStart;
            for (i = _i = 1; 1 <= div ? _i < div : _i > div; i = 1 <= div ? ++_i : --_i) {
                stack = stack.next = new
                BlurStack();
                if (i === radiusPlus1) {
                    stackEnd = stack;
                }
            }
            stack.next = stackStart;
            stackIn = null;
            stackOut = null;
            yw = yi = 0;
            mul_sum = mul_table[radius];
            shg_sum = shg_table[radius];
            for (y = _j = 0; 0 <= height ? _j < height : _j > height; y = 0 <= height ? ++_j : --_j) {
                r_in_sum = g_in_sum = b_in_sum = r_sum = g_sum = b_sum = 0;
                r_out_sum = radiusPlus1 * (pr = pixels[yi]);
                g_out_sum = radiusPlus1 * (pg = pixels[yi + 1]);
                b_out_sum = radiusPlus1 * (pb = pixels[yi + 2]);
                r_sum += sumFactor * pr;
                g_sum += sumFactor * pg;
                b_sum += sumFactor * pb;
                stack = stackStart;
                for (i = _k = 0; 0 <= radiusPlus1 ? _k < radiusPlus1 : _k > radiusPlus1; i = 0 <= radiusPlus1 ? ++_k : --_k) {
                    stack.r = pr;
                    stack.g = pg;
                    stack.b = pb;
                    stack = stack.next;
                }
                for (i = _l = 1; 1 <= radiusPlus1 ? _l < radiusPlus1 : _l > radiusPlus1; i = 1 <= radiusPlus1 ? ++_l : --_l) {
                    p = yi + ((widthMinus1 < i ? widthMinus1 : i) << 2);
                    r_sum += (stack.r = (pr = pixels[p])) * (rbs = radiusPlus1 - i);
                    g_sum += (stack.g = (pg = pixels[p + 1])) * rbs;
                    b_sum += (stack.b = (pb = pixels[p + 2])) * rbs;
                    r_in_sum += pr;
                    g_in_sum += pg;
                    b_in_sum += pb;
                    stack = stack.next;
                }
                stackIn = stackStart;
                stackOut = stackEnd;
                for (x = _m = 0; 0 <= width ? _m < width : _m > width; x = 0 <= width ? ++_m : --_m) {
                    pixels[yi] = (r_sum * mul_sum) >> shg_sum;
                    pixels[yi + 1] = (g_sum * mul_sum) >> shg_sum;
                    pixels[yi + 2] = (b_sum * mul_sum) >> shg_sum;
                    r_sum -= r_out_sum;
                    g_sum -= g_out_sum;
                    b_sum -= b_out_sum;
                    r_out_sum -= stackIn.r;
                    g_out_sum -= stackIn.g;
                    b_out_sum -= stackIn.b;
                    p = (yw + ((p = x + radius + 1) < widthMinus1 ? p : widthMinus1)) << 2;
                    r_in_sum += (stackIn.r = pixels[p]);
                    g_in_sum += (stackIn.g = pixels[p + 1]);
                    b_in_sum += (stackIn.b = pixels[p + 2]);
                    r_sum += r_in_sum;
                    g_sum += g_in_sum;
                    b_sum += b_in_sum;
                    stackIn = stackIn.next;
                    r_out_sum += (pr = stackOut.r);
                    g_out_sum += (pg = stackOut.g);
                    b_out_sum += (pb = stackOut.b);
                    r_in_sum -= pr;
                    g_in_sum -= pg;
                    b_in_sum -= pb;
                    stackOut = stackOut.next;
                    yi += 4;
                }
                yw += width;
            }
            for (x = _n = 0; 0 <= width ? _n < width : _n > width; x = 0 <= width ? ++_n : --_n) {
                g_in_sum = b_in_sum = r_in_sum = g_sum = b_sum = r_sum = 0;
                yi = x << 2;
                r_out_sum = radiusPlus1 * (pr = pixels[yi]);
                g_out_sum = radiusPlus1 * (pg = pixels[yi + 1]);
                b_out_sum = radiusPlus1 * (pb = pixels[yi + 2]);
                r_sum += sumFactor * pr;
                g_sum += sumFactor * pg;
                b_sum += sumFactor * pb;
                stack = stackStart;
                for (i = _o = 0; 0 <= radiusPlus1 ? _o < radiusPlus1 : _o > radiusPlus1; i = 0 <= radiusPlus1 ? ++_o : --_o) {
                    stack.r = pr;
                    stack.g = pg;
                    stack.b = pb;
                    stack = stack.next;
                }
                yp = width;
                for (i = _p = 1; 1 <= radius ? _p <= radius : _p >= radius; i = 1 <= radius ? ++_p : --_p) {
                    yi = (yp + x) << 2;
                    r_sum += (stack.r = (pr = pixels[yi])) * (rbs = radiusPlus1 - i);
                    g_sum += (stack.g = (pg = pixels[yi + 1])) * rbs;
                    b_sum += (stack.b = (pb = pixels[yi + 2])) * rbs;
                    r_in_sum += pr;
                    g_in_sum += pg;
                    b_in_sum += pb;
                    stack = stack.next;
                    if (i < heightMinus1) {
                        yp += width;
                    }
                }
                yi = x;
                stackIn = stackStart;
                stackOut = stackEnd;
                for (y = _q = 0; 0 <= height ? _q < height : _q > height; y = 0 <= height ? ++_q : --_q) {
                    p = yi << 2;
                    pixels[p] = (r_sum * mul_sum) >> shg_sum;
                    pixels[p + 1] = (g_sum * mul_sum) >> shg_sum;
                    pixels[p + 2] = (b_sum * mul_sum) >> shg_sum;
                    r_sum -= r_out_sum;
                    g_sum -= g_out_sum;
                    b_sum -= b_out_sum;
                    r_out_sum -= stackIn.r;
                    g_out_sum -= stackIn.g;
                    b_out_sum -= stackIn.b;
                    p = (x + (((p = y + radiusPlus1) < heightMinus1 ? p : heightMinus1) * width)) << 2;
                    r_sum += (r_in_sum += (stackIn.r = pixels[p]));
                    g_sum += (g_in_sum += (stackIn.g = pixels[p + 1]));
                    b_sum += (b_in_sum += (stackIn.b = pixels[p + 2]));
                    stackIn = stackIn.next;
                    r_out_sum += (pr = stackOut.r);
                    g_out_sum += (pg = stackOut.g);
                    b_out_sum += (pb = stackOut.b);
                    r_in_sum -= pr;
                    g_in_sum -= pg;
                    b_in_sum -= pb;
                    stackOut = stackOut.next;
                    yi += width;
                }
            }
            return this;
        });
        return Caman.Filter.register("stackBlur", function(radius) {
            return this.processPlugin("stackBlur", [radius]);
        });
    })();
    Caman.Filter.register("threshold", function(adjust) {
        return this.process("threshold", function(rgba) {
            var
                luminance;
            luminance = (0.2126 * rgba.r) + (0.7152 * rgba.g) + (0.0722 * rgba.b);
            if (luminance < adjust) {
                rgba.r = 0;
                rgba.g = 0;
                rgba.b = 0;
            } else {
                rgba.r = 255;
                rgba.g = 255;
                rgba.b = 255;
            }
            return rgba;
        });
    });
}).call(this);
(function($, window, document, undefined) {
    var
        $window = $(window);
    $.fn.lazyload = function(options) {
        var
            elements = this;
        var
            $container;
        var
            settings = {
                threshold: 0,
                failure_limit: 0,
                event: "scroll",
                effect: "show",
                container: window,
                data_attribute: "original",
                skip_invisible: true,
                appear: null,
                load: null,
                placeholder: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC"
            };

        function
        update() {
            var
                counter = 0;
            elements.each(function() {
                var
                    $this = $(this);
                if (settings.skip_invisible && !$this.is(":visible")) {
                    return;
                }
                if ($.abovethetop(this, settings) || $.leftofbegin(this, settings)) {} else
                if (!$.belowthefold(this, settings) && !$.rightoffold(this, settings)) {
                    $this.trigger("appear");
                    counter = 0;
                } else {
                    if (++counter > settings.failure_limit) {
                        return false;
                    }
                }
            });
        }
        if (options) {
            if (undefined !== options.failurelimit) {
                options.failure_limit = options.failurelimit;
                delete
                options.failurelimit;
            }
            if (undefined !== options.effectspeed) {
                options.effect_speed = options.effectspeed;
                delete
                options.effectspeed;
            }
            $.extend(settings, options);
        }
        $container = (settings.container === undefined || settings.container === window) ? $window : $(settings.container);
        if (0 === settings.event.indexOf("scroll")) {
            $container.bind(settings.event, function() {
                return update();
            });
        }
        this.each(function() {
            var
                self = this;
            var
                $self = $(self);
            self.loaded = false;
            if ($self.attr("src") === undefined || $self.attr("src") === false) {
                if ($self.is("img")) {
                    $self.attr("src", settings.placeholder);
                }
            }
            $self.one("appear", function() {
                if (!this.loaded) {
                    if (settings.appear) {
                        var
                            elements_left = elements.length;
                        settings.appear.call(self, elements_left, settings);
                    }
                    $("<img />").bind("load", function() {
                        var
                            original = $self.attr("data-" + settings.data_attribute);
                        $self.hide();
                        if ($self.is("img")) {
                            $self.attr("src", original);
                        } else {
                            $self.css("background-image", "url('" + original + "')");
                        }
                        $self[settings.effect](settings.effect_speed);
                        self.loaded = true;
                        var
                            temp = $.grep(elements, function(element) {
                                return !element.loaded;
                            });
                        elements = $(temp);
                        if (settings.load) {
                            var
                                elements_left = elements.length;
                            settings.load.call(self, elements_left, settings);
                        }
                    }).attr("src", $self.attr("data-" + settings.data_attribute));
                }
            });
            if (0 !== settings.event.indexOf("scroll")) {
                $self.bind(settings.event, function() {
                    if (!self.loaded) {
                        $self.trigger("appear");
                    }
                });
            }
        });
        $window.bind("resize", function() {
            update();
        });
        if ((/(?:iphone|ipod|ipad).*os 5/gi).test(navigator.appVersion)) {
            $window.bind("pageshow", function(event) {
                if (event.originalEvent && event.originalEvent.persisted) {
                    elements.each(function() {
                        $(this).trigger("appear");
                    });
                }
            });
        }
        $(document).ready(function() {
            update();
        });
        return this;
    };
    $.belowthefold = function(element, settings) {
        var
            fold;
        if (settings.container === undefined || settings.container === window) {
            fold = (window.innerHeight ? window.innerHeight : $window.height()) + $window.scrollTop();
        } else {
            fold = $(settings.container).offset().top + $(settings.container).height();
        }
        return fold <= $(element).offset().top - settings.threshold;
    };
    $.rightoffold = function(element, settings) {
        var
            fold;
        if (settings.container === undefined || settings.container === window) {
            fold = $window.width() + $window.scrollLeft();
        } else {
            fold = $(settings.container).offset().left + $(settings.container).width();
        }
        return fold <= $(element).offset().left - settings.threshold;
    };
    $.abovethetop = function(element, settings) {
        var
            fold;
        if (settings.container === undefined || settings.container === window) {
            fold = $window.scrollTop();
        } else {
            fold = $(settings.container).offset().top;
        }
        return fold >= $(element).offset().top + settings.threshold + $(element).height();
    };
    $.leftofbegin = function(element, settings) {
        var
            fold;
        if (settings.container === undefined || settings.container === window) {
            fold = $window.scrollLeft();
        } else {
            fold = $(settings.container).offset().left;
        }
        return fold >= $(element).offset().left + settings.threshold + $(element).width();
    };
    $.inviewport = function(element, settings) {
        return !$.rightoffold(element, settings) && !$.leftofbegin(element, settings) && !$.belowthefold(element, settings) && !$.abovethetop(element, settings);
    };
    $.extend($.expr[":"], {
        "below-the-fold": function(a) {
            return $.belowthefold(a, {
                threshold: 0
            });
        },
        "above-the-top": function(a) {
            return !$.belowthefold(a, {
                threshold: 0
            });
        },
        "right-of-screen": function(a) {
            return $.rightoffold(a, {
                threshold: 0
            });
        },
        "left-of-screen": function(a) {
            return !$.rightoffold(a, {
                threshold: 0
            });
        },
        "in-viewport": function(a) {
            return $.inviewport(a, {
                threshold: 0
            });
        },
        "above-the-fold": function(a) {
            return !$.belowthefold(a, {
                threshold: 0
            });
        },
        "right-of-fold": function(a) {
            return $.rightoffold(a, {
                threshold: 0
            });
        },
        "left-of-fold": function(a) {
            return !$.rightoffold(a, {
                threshold: 0
            });
        }
    });
})(jQuery, window, document);
(function($, document, Image, Array, Math, parseFloat, console, TRUE, FALSE, NULL, UNDEFINED) {
    var
        defaults, prefs, extendObject = $.extend,
        inArray = $.inArray,
        typeOf = $.type,
        isFunction = $.isFunction,
        isPlainObject = $.isPlainObject,
        PI = Math.PI,
        round = Math.round,
        abs = Math.abs,
        sin = Math.sin,
        cos = Math.cos,
        atan2 = Math.atan2,
        arraySlice = Array.prototype.slice,
        jQueryEventFix = $.event.fix,
        maps = {},
        caches = {
            dataCache: {},
            propCache: {},
            imageCache: {}
        },
        baseTransforms = {
            rotate: 0,
            scaleX: 1,
            scaleY: 1,
            translateX: 0,
            translateY: 0,
            masks: []
        },
        css = {};

    function
    jCanvasObject(args) {
        var
            params = this,
            propName;
        for (propName in
            args) {
            if (args.hasOwnProperty(propName)) {
                params[propName] = args[propName];
                if (params[propName] !== NULL && $.inArray(propName, numericProps) !== -1) {
                    params[propName] *= 1;
                }
            }
        }
        return params;
    }
    var
        jCanvas = {};
    jCanvas.events = {};
    jCanvas.eventHooks = {};
    jCanvas.future = {};

    function
    jCanvasDefaults() {
        extendObject(this, {
            align: 'center',
            arrowAngle: 90,
            arrowRadius: 0,
            autosave: TRUE,
            baseline: 'middle',
            bringToFront: FALSE,
            ccw: FALSE,
            closed: FALSE,
            compositing: 'source-over',
            concavity: 0,
            cornerRadius: 0,
            count: 1,
            cropFromCenter: TRUE,
            crossOrigin: '',
            cursors: NULL,
            disableEvents: FALSE,
            draggable: FALSE,
            dragGroups: NULL,
            groups: NULL,
            data: NULL,
            dx: NULL,
            dy: NULL,
            end: 360,
            eventX: NULL,
            eventY: NULL,
            fillStyle: 'transparent',
            fontStyle: 'normal',
            fontSize: '12pt',
            fontFamily: 'sans-serif',
            fromCenter: TRUE,
            height: NULL,
            imageSmoothing: TRUE,
            inDegrees: TRUE,
            index: NULL,
            lineHeight: 1,
            layer: FALSE,
            mask: FALSE,
            maxWidth: NULL,
            miterLimit: 10,
            name: NULL,
            opacity: 1,
            r1: NULL,
            r2: NULL,
            radius: 0,
            repeat: 'repeat',
            respectAlign: FALSE,
            rotate: 0,
            rounded: FALSE,
            scale: 1,
            scaleX: 1,
            scaleY: 1,
            shadowBlur: 0,
            shadowColor: 'transparent',
            shadowStroke: FALSE,
            shadowX: 0,
            shadowY: 0,
            sHeight: NULL,
            sides: 0,
            source: '',
            letterSpacing: NULL,
            spread: 0,
            start: 0,
            strokeCap: 'butt',
            strokeDash: NULL,
            strokeDashOffset: 0,
            strokeJoin: 'miter',
            strokeStyle: 'transparent',
            strokeWidth: 1,
            sWidth: NULL,
            sx: NULL,
            sy: NULL,
            text: '',
            translate: 0,
            translateX: 0,
            translateY: 0,
            type: NULL,
            visible: TRUE,
            width: NULL,
            x: 0,
            y: 0
        });
    }
    defaults = new
    jCanvasDefaults();

    function
    jCanvasPrefs() {}
    jCanvasPrefs.prototype = defaults;
    prefs = new
    jCanvasPrefs();
    jCanvasObject.prototype = prefs;
    var
        numericProps = ['arrowAngle', 'arrowRadius', 'concavity', 'cornerRadius', 'count', 'end', 'height', 'lineHeight', 'miterLimit', 'opacity', 'r1', 'r2', 'radius', 'rotate', 'scale', 'scaleX', 'scaleY', 'shadowBlur', 'shadowX', 'shadowY', 'sHeight', 'sides', 'spread', 'start', 'strokeWidth', 'sx', 'sy', 'translate', 'translateX', 'translateY', 'width', 'x', 'y'];

    function
    isString(operand) {
        return (typeOf(operand) === 'string');
    }

    function
    _getContext(canvas) {
        return (canvas && canvas.getContext ? canvas.getContext('2d') : NULL);
    }

    function
    _cloneTransforms(transforms) {
        transforms = extendObject({}, transforms);
        transforms.masks = transforms.masks.slice(0);
        return transforms;
    }

    function
    _saveCanvas(ctx, data) {
        var
            transforms;
        ctx.save();
        transforms = _cloneTransforms(data.transforms);
        data.savedTransforms.push(transforms);
    }

    function
    _restoreCanvas(ctx, data) {
        if (data.savedTransforms.length === 0) {
            data.transforms = _cloneTransforms(baseTransforms);
        } else {
            ctx.restore();
            data.transforms = data.savedTransforms.pop();
        }
    }

    function
    _setStyle(canvas, ctx, params, styleName) {
        if (params[styleName]) {
            if (isFunction(params[styleName])) {
                ctx[styleName] = params[styleName].call(canvas, params);
            } else {
                ctx[styleName] = params[styleName];
            }
        }
    }

    function
    _setGlobalProps(canvas, ctx, params) {
        _setStyle(canvas, ctx, params, 'fillStyle');
        _setStyle(canvas, ctx, params, 'strokeStyle');
        ctx.lineWidth = params.strokeWidth;
        if (params.rounded) {
            ctx.lineCap = ctx.lineJoin = 'round';
        } else {
            ctx.lineCap = params.strokeCap;
            ctx.lineJoin = params.strokeJoin;
            ctx.miterLimit = params.miterLimit;
        }
        if (params.strokeDash) {
            ctx.setLineDash(params.strokeDash);
            ctx.webkitLineDash = ctx.mozDash = params.strokeDash;
            ctx.lineDashOffset = ctx.webkitLineDashOffset = ctx.mozDashOffset = params.strokeDashOffset;
        }
        ctx.shadowOffsetX = params.shadowX;
        ctx.shadowOffsetY = params.shadowY;
        ctx.shadowBlur = params.shadowBlur;
        ctx.shadowColor = params.shadowColor;
        ctx.globalAlpha = params.opacity;
        ctx.globalCompositeOperation = params.compositing;
        if (params.imageSmoothing) {
            ctx.webkitImageSmoothingEnabled = ctx.mozImageSmoothingEnabled = params.imageSmoothing;
        }
    }

    function
    _enableMasking(ctx, data, params) {
        if (params.mask) {
            if (params.autosave) {
                _saveCanvas(ctx, data);
            }
            ctx.clip();
            data.transforms.masks.push(params._args);
        }
    }

    function
    _restoreTransform(ctx, params) {
        if (params._transformed) {
            ctx.restore();
        }
    }

    function
    _closePath(canvas, ctx, params) {
        var
            data;
        if (params.closed) {
            ctx.closePath();
        }
        if (params.shadowStroke && params.strokeWidth !== 0) {
            ctx.stroke();
            ctx.fill();
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.stroke();
        } else {
            ctx.fill();
            if (params.fillStyle !== 'transparent') {
                ctx.shadowColor = 'transparent';
            }
            if (params.strokeWidth !== 0) {
                ctx.stroke();
            }
        }
        if (!params.closed) {
            ctx.closePath();
        }
        _restoreTransform(ctx, params);
        if (params.mask) {
            data = _getCanvasData(canvas);
            _enableMasking(ctx, data, params);
        }
    }

    function
    _transformShape(canvas, ctx, params, width, height) {
        params._toRad = (params.inDegrees ? (PI / 180) : 1);
        params._transformed = TRUE;
        ctx.save();
        if (!params.fromCenter && !params._centered && width !== UNDEFINED) {
            if (height === UNDEFINED) {
                height = width;
            }
            params.x += width / 2;
            params.y += height / 2;
            params._centered = TRUE;
        }
        if (params.rotate) {
            _rotateCanvas(ctx, params, NULL);
        }
        if (params.scale !== 1 || params.scaleX !== 1 || params.scaleY !== 1) {
            _scaleCanvas(ctx, params, NULL);
        }
        if (params.translate || params.translateX || params.translateY) {
            _translateCanvas(ctx, params, NULL);
        }
    }
    jCanvas.extend = function
    extend(plugin) {
        if (plugin.name) {
            if (plugin.props) {
                extendObject(defaults, plugin.props);
            }
            $.fn[plugin.name] = function
            self(args) {
                var
                    $canvases = this,
                    canvas, e, ctx, params, layer;
                for (e = 0; e < $canvases.length; e += 1) {
                    canvas = $canvases[e];
                    ctx = _getContext(canvas);
                    if (ctx) {
                        params = new
                        jCanvasObject(args);
                        layer = _addLayer(canvas, params, args, self);
                        _setGlobalProps(canvas, ctx, params);
                        plugin.fn.call(canvas, ctx, params);
                    }
                }
                return $canvases;
            };
            if (plugin.type) {
                maps.drawings[plugin.type] = plugin.name;
            }
        }
        return $.fn[plugin.name];
    };

    function
    _getCanvasData(canvas) {
        var
            dataCache = caches.dataCache,
            data;
        if (dataCache._canvas === canvas && dataCache._data) {
            data = dataCache._data;
        } else {
            data = $.data(canvas, 'jCanvas');
            if (!data) {
                data = {
                    canvas: canvas,
                    layers: [],
                    layer: {
                        names: {},
                        groups: {}
                    },
                    eventHooks: {},
                    intersecting: [],
                    lastIntersected: NULL,
                    cursor: $(canvas).css('cursor'),
                    drag: {
                        layer: NULL,
                        dragging: FALSE
                    },
                    event: {
                        type: NULL,
                        x: NULL,
                        y: NULL
                    },
                    events: {},
                    transforms: _cloneTransforms(baseTransforms),
                    savedTransforms: [],
                    animating: FALSE,
                    animated: NULL,
                    pixelRatio: 1,
                    scaled: FALSE
                };
                $.data(canvas, 'jCanvas', data);
            }
            dataCache._canvas = canvas;
            dataCache._data = data;
        }
        return data;
    }

    function
    _addLayerEvents($canvas, data, layer) {
        var
            eventName;
        for (eventName in
            jCanvas.events) {
            if (jCanvas.events.hasOwnProperty(eventName)) {
                if (layer[eventName] || (layer.cursors && layer.cursors[eventName])) {
                    _addLayerEvent($canvas, data, layer, eventName);
                }
            }
        }
    }

    function
    _addLayerEvent($canvas, data, layer, eventName) {
        jCanvas.events[eventName]($canvas, data);
        layer._event = TRUE;
    }

    function
    _enableDrag($canvas, data, layer) {
        var
            dragHelperEvents, eventName, i;
        if (layer.draggable || layer.cursors) {
            dragHelperEvents = ['mousedown', 'mousemove', 'mouseup'];
            for (i = 0; i < dragHelperEvents.length; i += 1) {
                eventName = dragHelperEvents[i];
                _addLayerEvent($canvas, data, layer, eventName);
            }
            if (!data.events.mouseoutdrag) {
                $canvas.bind('mouseout.jCanvas', function() {
                    var
                        layer = data.drag.layer;
                    if (layer) {
                        data.drag = {};
                        _triggerLayerEvent($canvas, data, layer, 'dragcancel');
                        $canvas.drawLayers();
                    }
                });
                data.events.mouseoutdrag = TRUE;
            }
            layer._event = TRUE;
        }
    }

    function
    _updateLayerName($canvas, data, layer, props) {
        var
            nameMap = data.layer.names;
        if (!props) {
            props = layer;
        } else {
            if (props.name !== UNDEFINED && isString(layer.name) && layer.name !== props.name) {
                delete
                nameMap[layer.name];
            }
        }
        if (isString(props.name)) {
            nameMap[props.name] = layer;
        }
    }

    function
    _updateLayerGroups($canvas, data, layer, props) {
        var
            groupMap = data.layer.groups,
            group, groupName, g, index, l;
        if (!props) {
            props = layer;
        } else {
            if (props.groups !== UNDEFINED && layer.groups !== NULL) {
                for (g = 0; g < layer.groups.length; g += 1) {
                    groupName = layer.groups[g];
                    group = groupMap[groupName];
                    if (group) {
                        for (l = 0; l < group.length; l += 1) {
                            if (group[l] === layer) {
                                index = l;
                                group.splice(l, 1);
                                break;
                            }
                        }
                        if (group.length === 0) {
                            delete
                            groupMap[groupName];
                        }
                    }
                }
            }
        }
        if (props.groups !== UNDEFINED && props.groups !== NULL) {
            for (g = 0; g < props.groups.length; g += 1) {
                groupName = props.groups[g];
                group = groupMap[groupName];
                if (!group) {
                    group = groupMap[groupName] = [];
                    group.name = groupName;
                }
                if (index === UNDEFINED) {
                    index = group.length;
                }
                group.splice(index, 0, layer);
            }
        }
    }
    $.fn.getEventHooks = function
    getEventHooks() {
        var
            $canvases = this,
            canvas, data, eventHooks = {};
        if ($canvases.length !== 0) {
            canvas = $canvases[0];
            data = _getCanvasData(canvas);
            eventHooks = data.eventHooks;
        }
        return eventHooks;
    };
    $.fn.setEventHooks = function
    setEventHooks(eventHooks) {
        var
            $canvases = this,
            $canvas, e, data;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            data = _getCanvasData($canvases[e]);
            extendObject(data.eventHooks, eventHooks);
        }
        return $canvases;
    };
    $.fn.getLayers = function
    getLayers(callback) {
        var
            $canvases = this,
            canvas, data, layers, layer, l, matching = [];
        if ($canvases.length !== 0) {
            canvas = $canvases[0];
            data = _getCanvasData(canvas);
            layers = data.layers;
            if (isFunction(callback)) {
                for (l = 0; l < layers.length; l += 1) {
                    layer = layers[l];
                    if (callback.call(canvas, layer)) {
                        matching.push(layer);
                    }
                }
            } else {
                matching = layers;
            }
        }
        return matching;
    };
    $.fn.getLayer = function
    getLayer(layerId) {
        var
            $canvases = this,
            canvas, data, layers, layer, l, idType;
        if ($canvases.length !== 0) {
            canvas = $canvases[0];
            data = _getCanvasData(canvas);
            layers = data.layers;
            idType = typeOf(layerId);
            if (layerId && layerId.layer) {
                layer = layerId;
            } else
            if (idType === 'number') {
                if (layerId < 0) {
                    layerId = layers.length + layerId;
                }
                layer = layers[layerId];
            } else
            if (idType === 'regexp') {
                for (l = 0; l < layers.length; l += 1) {
                    if (isString(layers[l].name) && layers[l].name.match(layerId)) {
                        layer = layers[l];
                        break;
                    }
                }
            } else {
                layer = data.layer.names[layerId];
            }
        }
        return layer;
    };
    $.fn.getLayerGroup = function
    getLayerGroup(groupId) {
        var
            $canvases = this,
            canvas, data, groups, groupName, group, idType = typeOf(groupId);
        if ($canvases.length !== 0) {
            canvas = $canvases[0];
            if (idType === 'array') {
                group = groupId;
            } else
            if (idType === 'regexp') {
                data = _getCanvasData(canvas);
                groups = data.layer.groups;
                for (groupName in
                    groups) {
                    if (groupName.match(groupId)) {
                        group = groups[groupName];
                        break;
                    }
                }
            } else {
                data = _getCanvasData(canvas);
                group = data.layer.groups[groupId];
            }
        }
        return group;
    };
    $.fn.getLayerIndex = function
    getLayerIndex(layerId) {
        var
            $canvases = this,
            layers = $canvases.getLayers(),
            layer = $canvases.getLayer(layerId);
        return inArray(layer, layers);
    };
    $.fn.setLayer = function
    setLayer(layerId, props) {
        var
            $canvases = this,
            $canvas, e, data, layer, propName, propValue, propType;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            data = _getCanvasData($canvases[e]);
            layer = $($canvases[e]).getLayer(layerId);
            if (layer) {
                _updateLayerName($canvas, data, layer, props);
                _updateLayerGroups($canvas, data, layer, props);
                for (propName in
                    props) {
                    if (props.hasOwnProperty(propName)) {
                        propValue = props[propName];
                        propType = typeOf(propValue);
                        if (propType === 'object' && isPlainObject(propValue)) {
                            layer[propName] = extendObject({}, propValue);
                        } else
                        if (propType === 'array') {
                            layer[propName] = propValue.slice(0);
                        } else
                        if (propType === 'string') {
                            if (propValue.indexOf('+=') === 0) {
                                layer[propName] += parseFloat(propValue.substr(2));
                            } else
                            if (propValue.indexOf('-=') === 0) {
                                layer[propName] -= parseFloat(propValue.substr(2));
                            } else {
                                layer[propName] = propValue;
                            }
                        } else {
                            layer[propName] = propValue;
                        }
                    }
                }
                _addLayerEvents($canvas, data, layer);
                _enableDrag($canvas, data, layer);
                if ($.isEmptyObject(props) === FALSE) {
                    _triggerLayerEvent($canvas, data, layer, 'change', props);
                }
            }
        }
        return $canvases;
    };
    $.fn.setLayers = function
    setLayers(props, callback) {
        var
            $canvases = this,
            $canvas, e, layers, l;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            layers = $canvas.getLayers(callback);
            for (l = 0; l < layers.length; l += 1) {
                $canvas.setLayer(layers[l], props);
            }
        }
        return $canvases;
    };
    $.fn.setLayerGroup = function
    setLayerGroup(groupId, props) {
        var
            $canvases = this,
            $canvas, e, group, l;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            group = $canvas.getLayerGroup(groupId);
            if (group) {
                for (l = 0; l < group.length; l += 1) {
                    $canvas.setLayer(group[l], props);
                }
            }
        }
        return $canvases;
    };
    $.fn.moveLayer = function
    moveLayer(layerId, index) {
        var
            $canvases = this,
            $canvas, e, data, layers, layer;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            data = _getCanvasData($canvases[e]);
            layers = data.layers;
            layer = $canvas.getLayer(layerId);
            if (layer) {
                layer.index = inArray(layer, layers);
                layers.splice(layer.index, 1);
                layers.splice(index, 0, layer);
                if (index < 0) {
                    index = layers.length + index;
                }
                layer.index = index;
                _triggerLayerEvent($canvas, data, layer, 'move');
            }
        }
        return $canvases;
    };
    $.fn.removeLayer = function
    removeLayer(layerId) {
        var
            $canvases = this,
            $canvas, e, data, layers, layer;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            data = _getCanvasData($canvases[e]);
            layers = $canvas.getLayers();
            layer = $canvas.getLayer(layerId);
            if (layer) {
                layer.index = inArray(layer, layers);
                layers.splice(layer.index, 1);
                _updateLayerName($canvas, data, layer, {
                    name: NULL
                });
                _updateLayerGroups($canvas, data, layer, {
                    groups: NULL
                });
                _triggerLayerEvent($canvas, data, layer, 'remove');
            }
        }
        return $canvases;
    };
    $.fn.removeLayers = function
    removeLayers(callback) {
        var
            $canvases = this,
            $canvas, e, data, layers, layer, l;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            data = _getCanvasData($canvases[e]);
            layers = $canvas.getLayers(callback);
            for (l = 0; l < layers.length; l += 1) {
                layer = layers[l];
                $canvas.removeLayer(layer);
                l -= 1;
            }
            data.layer.names = {};
            data.layer.groups = {};
        }
        return $canvases;
    };
    $.fn.removeLayerGroup = function
    removeLayerGroup(groupId) {
        var
            $canvases = this,
            $canvas, e, data, layers, group, l;
        if (groupId !== UNDEFINED) {
            for (e = 0; e < $canvases.length; e += 1) {
                $canvas = $($canvases[e]);
                data = _getCanvasData($canvases[e]);
                layers = $canvas.getLayers();
                group = $canvas.getLayerGroup(groupId);
                if (group) {
                    group = group.slice(0);
                    for (l = 0; l < group.length; l += 1) {
                        $canvas.removeLayer(group[l]);
                    }
                }
            }
        }
        return $canvases;
    };
    $.fn.addLayerToGroup = function
    addLayerToGroup(layerId, groupName) {
        var
            $canvases = this,
            $canvas, e, layer, groups = [groupName];
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            layer = $canvas.getLayer(layerId);
            if (layer.groups) {
                groups = layer.groups.slice(0);
                if (inArray(groupName, layer.groups) === -1) {
                    groups.push(groupName);
                }
            }
            $canvas.setLayer(layer, {
                groups: groups
            });
        }
        return $canvases;
    };
    $.fn.removeLayerFromGroup = function
    removeLayerFromGroup(layerId, groupName) {
        var
            $canvases = this,
            $canvas, e, layer, groups = [],
            index;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            layer = $canvas.getLayer(layerId);
            if (layer.groups) {
                index = inArray(groupName, layer.groups);
                if (index !== -1) {
                    groups = layer.groups.slice(0);
                    groups.splice(index, 1);
                    $canvas.setLayer(layer, {
                        groups: groups
                    });
                }
            }
        }
        return $canvases;
    };

    function
    _getIntersectingLayer(data) {
        var
            layer, i, mask, m;
        layer = NULL;
        for (i = data.intersecting.length - 1; i >= 0; i -= 1) {
            layer = data.intersecting[i];
            if (layer._masks) {
                for (m = layer._masks.length - 1; m >= 0; m -= 1) {
                    mask = layer._masks[m];
                    if (!mask.intersects) {
                        layer.intersects = FALSE;
                        break;
                    }
                }
                if (layer.intersects) {
                    break;
                }
            }
        }
        return layer;
    }

    function
    _drawLayer($canvas, ctx, layer, nextLayerIndex) {
        if (layer && layer.visible && layer._method) {
            if (nextLayerIndex) {
                layer._next = nextLayerIndex;
            } else {
                layer._next = NULL;
            }
            layer._method.call($canvas, layer);
        }
    }

    function
    _handleLayerDrag($canvas, data, eventType) {
        var
            layers, layer, l, drag, dragGroups, group, groupName, g, newX, newY;
        drag = data.drag;
        layer = drag.layer;
        dragGroups = (layer && layer.dragGroups) || [];
        layers = data.layers;
        if (eventType === 'mousemove' || eventType === 'touchmove') {
            if (!drag.dragging) {
                drag.dragging = TRUE;
                layer.dragging = TRUE;
                if (layer.bringToFront) {
                    layers.splice(layer.index, 1);
                    layer.index = layers.push(layer);
                }
                layer._startX = layer.x;
                layer._startY = layer.y;
                layer._endX = layer._eventX;
                layer._endY = layer._eventY;
                _triggerLayerEvent($canvas, data, layer, 'dragstart');
            }
            if (drag.dragging) {
                newX = layer._eventX - (layer._endX - layer._startX);
                newY = layer._eventY - (layer._endY - layer._startY);
                layer.dx = newX - layer.x;
                layer.dy = newY - layer.y;
                layer.x = newX;
                layer.y = newY;
                _triggerLayerEvent($canvas, data, layer, 'drag');
                for (g = 0; g < dragGroups.length; g += 1) {
                    groupName = dragGroups[g];
                    group = data.layer.groups[groupName];
                    if (layer.groups && group) {
                        for (l = 0; l < group.length; l += 1) {
                            if (group[l] !== layer) {
                                group[l].x += layer.dx;
                                group[l].y += layer.dy;
                            }
                        }
                    }
                }
            }
        } else
        if (eventType === 'mouseup' || eventType === 'touchend') {
            if (drag.dragging) {
                layer.dragging = FALSE;
                drag.dragging = FALSE;
                _triggerLayerEvent($canvas, data, layer, 'dragstop');
            }
            data.drag = {};
        }
    }
    css.cursors = ['grab', 'grabbing', 'zoom-in', 'zoom-out'];
    css.prefix = (function() {
        var
            styles = getComputedStyle(document.documentElement, ''),
            pre = (arraySlice.call(styles).join('').match(/-( moz|webkit|ms )-/) || (styles.OLink === '' && ['', 'o']))[1];
        return '-' + pre + '-';
    })();

    function
    _setCursor($canvas, layer, eventType) {
        var
            cursor;
        if (layer.cursors) {
            cursor = layer.cursors[eventType];
        }
        if ($.inArray(cursor, css.cursors) !== -1) {
            cursor = css.prefix + cursor;
        }
        if (cursor) {
            $canvas.css({
                cursor: cursor
            });
        }
    }

    function
    _resetCursor($canvas, data) {
        $canvas.css({
            cursor: data.cursor
        });
    }

    function
    _runEventCallback($canvas, layer, eventType, callbacks, arg) {
        if (callbacks[eventType] && layer._running && !layer._running[eventType]) {
            layer._running[eventType] = TRUE;
            callbacks[eventType].call($canvas[0], layer, arg);
            layer._running[eventType] = FALSE;
        }
    }

    function
    _triggerLayerEvent($canvas, data, layer, eventType, arg) {
        if (!layer.disableEvents) {
            if (eventType !== 'mouseout') {
                _setCursor($canvas, layer, eventType);
            }
            _runEventCallback($canvas, layer, eventType, layer, arg);
            _runEventCallback($canvas, layer, eventType, data.eventHooks, arg);
            _runEventCallback($canvas, layer, eventType, jCanvas.eventHooks, arg);
        }
    }
    $.fn.triggerLayerEvent = function(layer, eventType) {
        var
            $canvases = this,
            $canvas, e, data;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            data = _getCanvasData($canvases[e]);
            layer = $canvas.getLayer(layer);
            if (layer) {
                _triggerLayerEvent($canvas, data, layer, eventType);
            }
        }
        return $canvases;
    };
    $.fn.drawLayer = function
    drawLayer(layerId) {
        var
            $canvases = this,
            e, ctx, $canvas, layer;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            ctx = _getContext($canvases[e]);
            layer = $canvas.getLayer(layerId);
            _drawLayer($canvas, ctx, layer);
        }
        return $canvases;
    };
    $.fn.drawLayers = function
    drawLayers(args) {
        var
            $canvases = this,
            $canvas, e, ctx, params = extendObject({}, args),
            layers, layer, lastLayer, l, lastIndex, data, eventCache, eventType, isImageLayer;
        if (!params.index) {
            params.index = 0;
        }
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            ctx = _getContext($canvases[e]);
            if (ctx) {
                data = _getCanvasData($canvases[e]);
                if (params.clear !== FALSE) {
                    $canvas.clearCanvas();
                }
                layers = data.layers;
                for (l = params.index; l < layers.length; l += 1) {
                    layer = layers[l];
                    layer.index = l;
                    if (params.resetFire) {
                        layer._fired = FALSE;
                    }
                    _drawLayer($canvas, ctx, layer, l + 1);
                    layer._masks = data.transforms.masks.slice(0);
                    if (layer._method === $.fn.drawImage && layer.visible) {
                        isImageLayer = true;
                        break;
                    }
                }
                if (isImageLayer) {
                    break;
                }
                lastIndex = l;
                layer = _getIntersectingLayer(data);
                eventCache = data.event;
                eventType = eventCache.type;
                if (data.drag.layer) {
                    _handleLayerDrag($canvas, data, eventType);
                }
                lastLayer = data.lastIntersected;
                if (lastLayer !== NULL && layer !== lastLayer && lastLayer._hovered && !lastLayer._fired && !data.drag.dragging) {
                    data.lastIntersected = NULL;
                    lastLayer._fired = TRUE;
                    lastLayer._hovered = FALSE;
                    _triggerLayerEvent($canvas, data, lastLayer, 'mouseout');
                    _resetCursor($canvas, data);
                }
                if (layer) {
                    if (!layer[eventType]) {
                        eventType = _getMouseEventName(eventType);
                    }
                    if (layer._event && layer.intersects) {
                        data.lastIntersected = layer;
                        if ((layer.mouseover || layer.mouseout || layer.cursors) && !data.drag.dragging) {
                            if (!layer._hovered && !layer._fired) {
                                layer._fired = TRUE;
                                layer._hovered = TRUE;
                                _triggerLayerEvent($canvas, data, layer, 'mouseover');
                            }
                        }
                        if (!layer._fired) {
                            layer._fired = TRUE;
                            eventCache.type = NULL;
                            _triggerLayerEvent($canvas, data, layer, eventType);
                        }
                        if (layer.draggable && !layer.disableEvents && (eventType === 'mousedown' || eventType === 'touchstart')) {
                            data.drag.layer = layer;
                        }
                    }
                }
                if (layer === NULL && !data.drag.dragging) {
                    _resetCursor($canvas, data);
                }
                if (lastIndex === layers.length) {
                    data.intersecting.length = 0;
                    data.transforms = _cloneTransforms(baseTransforms);
                    data.savedTransforms.length = 0;
                }
            }
        }
        return $canvases;
    };

    function
    _addLayer(canvas, params, args, method) {
        var
            $canvas, data, layers, layer = (params._layer ? args : params);
        params._args = args;
        if (params.draggable || params.dragGroups) {
            params.layer = TRUE;
            params.draggable = TRUE;
        }
        if (method) {
            params._method = method;
        } else
        if (params.method) {
            params._method = $.fn[params.method];
        } else
        if (params.type) {
            params._method = $.fn[maps.drawings[params.type]];
        } else {
            params._method = function() {};
        }
        if (params.layer && !params._layer) {
            $canvas = $(canvas);
            data = _getCanvasData(canvas);
            layers = data.layers;
            if (layer.name === NULL || (isString(layer.name) && data.layer.names[layer.name] === UNDEFINED)) {
                layer = new
                jCanvasObject(params);
                layer.canvas = canvas;
                layer.$canvas = $(canvas);
                layer.layer = TRUE;
                layer._layer = TRUE;
                layer._running = {};
                if (layer.data !== NULL) {
                    layer.data = extendObject({}, layer.data);
                } else {
                    layer.data = {};
                }
                if (layer.groups !== NULL) {
                    layer.groups = layer.groups.slice(0);
                } else {
                    layer.groups = [];
                }
                _updateLayerName($canvas, data, layer);
                _updateLayerGroups($canvas, data, layer);
                _addLayerEvents($canvas, data, layer);
                _enableDrag($canvas, data, layer);
                params._event = layer._event;
                if (layer._method === $.fn.drawText) {
                    $canvas.measureText(layer);
                }
                if (layer.index === NULL) {
                    layer.index = layers.length;
                }
                layers.splice(layer.index, 0, layer);
                params._args = layer;
                _triggerLayerEvent($canvas, data, layer, 'add');
            }
        }
        return layer;
    }
    $.fn.addLayer = function
    addLayer(args) {
        var
            $canvases = this,
            e, ctx, params;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                params.layer = TRUE;
                _addLayer($canvases[e], params, args);
            }
        }
        return $canvases;
    };
    css.props = ['width', 'height', 'opacity', 'lineHeight'];
    css.propsObj = {};

    function
    _showProps(obj) {
        var
            cssProp, p;
        for (p = 0; p < css.props.length; p += 1) {
            cssProp = css.props[p];
            obj[cssProp] = obj['_' + cssProp];
        }
    }

    function
    _hideProps(obj, reset) {
        var
            cssProp, p;
        for (p = 0; p < css.props.length; p += 1) {
            cssProp = css.props[p];
            if (obj[cssProp] !== UNDEFINED) {
                obj['_' + cssProp] = obj[cssProp];
                css.propsObj[cssProp] = TRUE;
                if (reset) {
                    delete
                    obj[cssProp];
                }
            }
        }
    }

    function
    _parseEndValues(canvas, layer, endValues) {
        var
            propName, propValue, subPropName, subPropValue;
        for (propName in
            endValues) {
            if (endValues.hasOwnProperty(propName)) {
                propValue = endValues[propName];
                if (isFunction(propValue)) {
                    endValues[propName] = propValue.call(canvas, layer, propName);
                }
                if (typeOf(propValue) === 'object' && isPlainObject(propValue)) {
                    for (subPropName in
                        propValue) {
                        if (propValue.hasOwnProperty(subPropName)) {
                            subPropValue = propValue[subPropName];
                            if (layer[propName] !== UNDEFINED) {
                                layer[propName + '.' + subPropName] = layer[propName][subPropName];
                                endValues[propName + '.' + subPropName] = subPropValue;
                            }
                        }
                    }
                    delete
                    endValues[propName];
                }
            }
        }
        return endValues;
    }

    function
    _removeSubPropAliases(layer) {
        var
            propName;
        for (propName in
            layer) {
            if (layer.hasOwnProperty(propName)) {
                if (propName.indexOf('.') !== -1) {
                    delete
                    layer[propName];
                }
            }
        }
    }

    function
    _colorToRgbArray(color) {
        var
            originalColor, elem, rgb = [],
            multiple = 1;
        if (color.match(/^([a-z]+|#[0-9a-f]+)$/gi)) {
            if (color === 'transparent') {
                color = 'rgba( 0,0,0,0 )';
            }
            elem = document.head;
            originalColor = elem.style.color;
            elem.style.color = color;
            color = $.css(elem, 'color');
            elem.style.color = originalColor;
        }
        if (color.match(/^rgb/gi)) {
            rgb = color.match(/(\d+(\.\d+)?)/gi);
            if (color.match(/%/gi)) {
                multiple = 2.55;
            }
            rgb[0] *= multiple;
            rgb[1] *= multiple;
            rgb[2] *= multiple;
            if (rgb[3] !== UNDEFINED) {
                rgb[3] = parseFloat(rgb[3]);
            } else {
                rgb[3] = 1;
            }
        }
        return rgb;
    }

    function
    _animateColor(fx) {
        var
            n = 3,
            i;
        if (typeOf(fx.start) !== 'array') {
            fx.start = _colorToRgbArray(fx.start);
            fx.end = _colorToRgbArray(fx.end);
        }
        fx.now = [];
        if (fx.start[3] !== 1 || fx.end[3] !== 1) {
            n = 4;
        }
        for (i = 0; i < n; i += 1) {
            fx.now[i] = fx.start[i] + (fx.end[i] - fx.start[i]) * fx.pos;
            if (i < 3) {
                fx.now[i] = round(fx.now[i]);
            }
        }
        if (fx.start[3] !== 1 || fx.end[3] !== 1) {
            fx.now = 'rgba( ' + fx.now.join(',') + ' )';
        } else {
            fx.now.slice(0, 3);
            fx.now = 'rgb( ' + fx.now.join(',') + ' )';
        }
        if (fx.elem.nodeName) {
            fx.elem.style[fx.prop] = fx.now;
        } else {
            fx.elem[fx.prop] = fx.now;
        }
    }
    $.fn.animateLayer = function
    animateLayer() {
        var
            $canvases = this,
            $canvas, e, ctx, args = arraySlice.call(arguments, 0),
            data, layer, props;
        if (typeOf(args[2]) === 'object') {
            args.splice(2, 0, args[2].duration || NULL);
            args.splice(3, 0, args[3].easing || NULL);
            args.splice(4, 0, args[4].complete || NULL);
            args.splice(5, 0, args[5].step || NULL);
        } else {
            if (args[2] === UNDEFINED) {
                args.splice(2, 0, NULL);
                args.splice(3, 0, NULL);
                args.splice(4, 0, NULL);
            } else
            if (isFunction(args[2])) {
                args.splice(2, 0, NULL);
                args.splice(3, 0, NULL);
            }
            if (args[3] === UNDEFINED) {
                args[3] = NULL;
                args.splice(4, 0, NULL);
            } else
            if (isFunction(args[3])) {
                args.splice(3, 0, NULL);
            }
        }

        function
        complete($canvas, data, layer) {
            return function() {
                _showProps(layer);
                _removeSubPropAliases(layer);
                if (!data.animating || data.animated === layer) {
                    $canvas.drawLayers();
                }
                layer._animating = FALSE;
                data.animating = FALSE;
                data.animated = NULL;
                if (args[4]) {
                    args[4].call($canvas[0], layer);
                }
                _triggerLayerEvent($canvas, data, layer, 'animateend');
            };
        }

        function
        step($canvas, data, layer) {
            return function(now, fx) {
                var
                    parts, propName, subPropName, hidden = false;
                if (fx.prop[0] === '_') {
                    hidden = true;
                    fx.prop = fx.prop.replace('_', '');
                    layer[fx.prop] = layer['_' + fx.prop];
                }
                if (fx.prop.indexOf('.') !== -1) {
                    parts = fx.prop.split('.');
                    propName = parts[0];
                    subPropName = parts[1];
                    if (layer[propName]) {
                        layer[propName][subPropName] = fx.now;
                    }
                }
                if (layer._pos !== fx.pos) {
                    layer._pos = fx.pos;
                    if (!layer._animating && !data.animating) {
                        layer._animating = TRUE;
                        data.animating = TRUE;
                        data.animated = layer;
                    }
                    if (!data.animating || data.animated === layer) {
                        $canvas.drawLayers();
                    }
                }
                if (args[5]) {
                    args[5].call($canvas[0], now, fx, layer);
                }
                _triggerLayerEvent($canvas, data, layer, 'animate', fx);
                if (hidden) {
                    fx.prop = '_' + fx.prop;
                }
            };
        }
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            ctx = _getContext($canvases[e]);
            if (ctx) {
                data = _getCanvasData($canvases[e]);
                layer = $canvas.getLayer(args[0]);
                if (layer && layer._method !== $.fn.draw) {
                    props = extendObject({}, args[1]);
                    props = _parseEndValues($canvases[e], layer, props);
                    _hideProps(props, TRUE);
                    _hideProps(layer);
                    layer.style = css.propsObj;
                    $(layer).animate(props, {
                        duration: args[2],
                        easing: ($.easing[args[3]] ? args[3] : NULL),
                        complete: complete($canvas, data, layer),
                        step: step($canvas, data, layer)
                    });
                    _triggerLayerEvent($canvas, data, layer, 'animatestart');
                }
            }
        }
        return $canvases;
    };
    $.fn.animateLayerGroup = function
    animateLayerGroup(groupId) {
        var
            $canvases = this,
            $canvas, e, args = arraySlice.call(arguments, 0),
            group, l;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            group = $canvas.getLayerGroup(groupId);
            if (group) {
                for (l = 0; l < group.length; l += 1) {
                    args[0] = group[l];
                    $canvas.animateLayer.apply($canvas, args);
                }
            }
        }
        return $canvases;
    };
    $.fn.delayLayer = function
    delayLayer(layerId, duration) {
        var
            $canvases = this,
            $canvas, e, data, layer;
        duration = duration || 0;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            data = _getCanvasData($canvases[e]);
            layer = $canvas.getLayer(layerId);
            if (layer) {
                $(layer).delay(duration);
                _triggerLayerEvent($canvas, data, layer, 'delay');
            }
        }
        return $canvases;
    };
    $.fn.delayLayerGroup = function
    delayLayerGroup(groupId, duration) {
        var
            $canvases = this,
            $canvas, e, group, layer, l;
        duration = duration || 0;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            group = $canvas.getLayerGroup(groupId);
            if (group) {
                for (l = 0; l < group.length; l += 1) {
                    layer = group[l];
                    $canvas.delayLayer(layer, duration);
                }
            }
        }
        return $canvases;
    };
    $.fn.stopLayer = function
    stopLayer(layerId, clearQueue) {
        var
            $canvases = this,
            $canvas, e, data, layer;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            data = _getCanvasData($canvases[e]);
            layer = $canvas.getLayer(layerId);
            if (layer) {
                $(layer).stop(clearQueue);
                _triggerLayerEvent($canvas, data, layer, 'stop');
            }
        }
        return $canvases;
    };
    $.fn.stopLayerGroup = function
    stopLayerGroup(groupId, clearQueue) {
        var
            $canvases = this,
            $canvas, e, group, layer, l;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            group = $canvas.getLayerGroup(groupId);
            if (group) {
                for (l = 0; l < group.length; l += 1) {
                    layer = group[l];
                    $canvas.stopLayer(layer, clearQueue);
                }
            }
        }
        return $canvases;
    };

    function
    _supportColorProps(props) {
        var
            p;
        for (p = 0; p < props.length; p += 1) {
            $.fx.step[props[p]] = _animateColor;
        }
    }
    _supportColorProps(['color', 'backgroundColor', 'borderColor', 'borderTopColor', 'borderRightColor', 'borderBottomColor', 'borderLeftColor', 'fillStyle', 'outlineColor', 'strokeStyle', 'shadowColor']);
    maps.touchEvents = {
        'mousedown': 'touchstart',
        'mouseup': 'touchend',
        'mousemove': 'touchmove'
    };
    maps.mouseEvents = {
        'touchstart': 'mousedown',
        'touchend': 'mouseup',
        'touchmove': 'mousemove'
    };

    function
    _getTouchEventName(eventName) {
        if (maps.touchEvents[eventName]) {
            eventName = maps.touchEvents[eventName];
        }
        return eventName;
    }

    function
    _getMouseEventName(eventName) {
        if (maps.mouseEvents[eventName]) {
            eventName = maps.mouseEvents[eventName];
        }
        return eventName;
    }

    function
    _createEvent(eventName) {
        jCanvas.events[eventName] = function($canvas, data) {
            var
                helperEventName, touchEventName, eventCache;
            eventCache = data.event;
            helperEventName = (eventName === 'mouseover' || eventName === 'mouseout') ? 'mousemove' : eventName;
            touchEventName = _getTouchEventName(helperEventName);

            function
            eventCallback(event) {
                eventCache.x = event.offsetX;
                eventCache.y = event.offsetY;
                eventCache.type = helperEventName;
                eventCache.event = event;
                $canvas.drawLayers({
                    resetFire: TRUE
                });
                event.preventDefault();
            }
            if (!data.events[helperEventName]) {
                if (touchEventName !== helperEventName) {
                    $canvas.bind(helperEventName + '.jCanvas ' + touchEventName + '.jCanvas', eventCallback);
                } else {
                    $canvas.bind(helperEventName + '.jCanvas', eventCallback);
                }
                data.events[helperEventName] = TRUE;
            }
        };
    }

    function
    _createEvents(eventNames) {
        var
            n;
        for (n = 0; n < eventNames.length; n += 1) {
            _createEvent(eventNames[n]);
        }
    }
    _createEvents(['click', 'dblclick', 'mousedown', 'mouseup', 'mousemove', 'mouseover', 'mouseout', 'touchstart', 'touchmove', 'touchend']);

    function
    _detectEvents(canvas, ctx, params) {
        var
            layer, data, eventCache, intersects, transforms, x, y, angle;
        layer = params._args;
        if (layer) {
            data = _getCanvasData(canvas);
            eventCache = data.event;
            if (eventCache.x !== NULL && eventCache.y !== NULL) {
                x = eventCache.x * data.pixelRatio;
                y = eventCache.y * data.pixelRatio;
                intersects = ctx.isPointInPath(x, y) || (ctx.isPointInStroke && ctx.isPointInStroke(x, y));
            }
            transforms = data.transforms;
            layer.eventX = layer.mouseX = eventCache.x;
            layer.eventY = layer.mouseY = eventCache.y;
            layer.event = eventCache.event;
            angle = data.transforms.rotate;
            x = layer.eventX;
            y = layer.eventY;
            if (angle !== 0) {
                layer._eventX = (x * cos(-angle)) - (y * sin(-angle));
                layer._eventY = (y * cos(-angle)) + (x * sin(-angle));
            } else {
                layer._eventX = x;
                layer._eventY = y;
            }
            layer._eventX /= transforms.scaleX;
            layer._eventY /= transforms.scaleY;
            if (intersects) {
                data.intersecting.push(layer);
            }
            layer.intersects = intersects;
        }
    }
    $.event.fix = function(event) {
        var
            offset, originalEvent, touches;
        event = jQueryEventFix.call($.event, event);
        originalEvent = event.originalEvent;
        if (originalEvent) {
            touches = originalEvent.changedTouches;
            if (event.pageX !== UNDEFINED && event.offsetX === UNDEFINED) {
                offset = $(event.currentTarget).offset();
                if (offset) {
                    event.offsetX = event.pageX - offset.left;
                    event.offsetY = event.pageY - offset.top;
                }
            } else
            if (touches) {
                offset = $(event.currentTarget).offset();
                if (offset) {
                    event.offsetX = touches[0].pageX - offset.left;
                    event.offsetY = touches[0].pageY - offset.top;
                }
            }
        }
        return event;
    };
    maps.drawings = {
        'arc': 'drawArc',
        'bezier': 'drawBezier',
        'ellipse': 'drawEllipse',
        'function': 'draw',
        'image': 'drawImage',
        'line': 'drawLine',
        'path': 'drawPath',
        'polygon': 'drawPolygon',
        'slice': 'drawSlice',
        'quadratic': 'drawQuadratic',
        'rectangle': 'drawRect',
        'text': 'drawText',
        'vector': 'drawVector',
        'save': 'saveCanvas',
        'restore': 'restoreCanvas',
        'rotate': 'rotateCanvas',
        'scale': 'scaleCanvas',
        'translate': 'translateCanvas'
    };
    $.fn.draw = function
    draw(args) {
        var
            $canvases = this,
            $canvas, e, ctx, params = new
        jCanvasObject(args), layer;
        if (maps.drawings[params.type] && params.type !== 'function') {
            $canvases[maps.drawings[params.type]](args);
        } else {
            for (e = 0; e < $canvases.length; e += 1) {
                $canvas = $($canvases[e]);
                ctx = _getContext($canvases[e]);
                if (ctx) {
                    params = new
                    jCanvasObject(args);
                    layer = _addLayer($canvases[e], params, args, draw);
                    if (params.visible) {
                        if (params.fn) {
                            params.fn.call($canvases[e], ctx, params);
                        }
                    }
                }
            }
        }
        return $canvases;
    };
    $.fn.clearCanvas = function
    clearCanvas(args) {
        var
            $canvases = this,
            e, ctx, params = new
        jCanvasObject(args), layer;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                if (params.width === NULL || params.height === NULL) {
                    ctx.save();
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                    ctx.clearRect(0, 0, $canvases[e].width, $canvases[e].height);
                    ctx.restore();
                } else {
                    layer = _addLayer($canvases[e], params, args, clearCanvas);
                    _transformShape($canvases[e], ctx, params, params.width, params.height);
                    ctx.clearRect(params.x - (params.width / 2), params.y - (params.height / 2), params.width, params.height);
                    _restoreTransform(ctx, params);
                }
            }
        }
        return $canvases;
    };
    $.fn.saveCanvas = function
    saveCanvas(args) {
        var
            $canvases = this,
            e, ctx, params, layer, data, i;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                data = _getCanvasData($canvases[e]);
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, saveCanvas);
                for (i = 0; i < params.count; i += 1) {
                    _saveCanvas(ctx, data);
                }
            }
        }
        return $canvases;
    };
    $.fn.restoreCanvas = function
    restoreCanvas(args) {
        var
            $canvases = this,
            e, ctx, params, layer, data, i;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                data = _getCanvasData($canvases[e]);
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, restoreCanvas);
                for (i = 0; i < params.count; i += 1) {
                    _restoreCanvas(ctx, data);
                }
            }
        }
        return $canvases;
    };

    function
    _rotateCanvas(ctx, params, transforms) {
        params._toRad = (params.inDegrees ? (PI / 180) : 1);
        ctx.translate(params.x, params.y);
        ctx.rotate(params.rotate * params._toRad);
        ctx.translate(-params.x, -params.y);
        if (transforms) {
            transforms.rotate += (params.rotate * params._toRad);
        }
    }

    function
    _scaleCanvas(ctx, params, transforms) {
        if (params.scale !== 1) {
            params.scaleX = params.scaleY = params.scale;
        }
        ctx.translate(params.x, params.y);
        ctx.scale(params.scaleX, params.scaleY);
        ctx.translate(-params.x, -params.y);
        if (transforms) {
            transforms.scaleX *= params.scaleX;
            transforms.scaleY *= params.scaleY;
        }
    }

    function
    _translateCanvas(ctx, params, transforms) {
        if (params.translate) {
            params.translateX = params.translateY = params.translate;
        }
        ctx.translate(params.translateX, params.translateY);
        if (transforms) {
            transforms.translateX += params.translateX;
            transforms.translateY += params.translateY;
        }
    }
    $.fn.rotateCanvas = function
    rotateCanvas(args) {
        var
            $canvases = this,
            e, ctx, params, layer, data;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                data = _getCanvasData($canvases[e]);
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, rotateCanvas);
                if (params.autosave) {
                    _saveCanvas(ctx, data);
                }
                _rotateCanvas(ctx, params, data.transforms);
            }
        }
        return $canvases;
    };
    $.fn.scaleCanvas = function
    scaleCanvas(args) {
        var
            $canvases = this,
            e, ctx, params, layer, data;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                data = _getCanvasData($canvases[e]);
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, scaleCanvas);
                if (params.autosave) {
                    _saveCanvas(ctx, data);
                }
                _scaleCanvas(ctx, params, data.transforms);
            }
        }
        return $canvases;
    };
    $.fn.translateCanvas = function
    translateCanvas(args) {
        var
            $canvases = this,
            e, ctx, params, layer, data;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                data = _getCanvasData($canvases[e]);
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, translateCanvas);
                if (params.autosave) {
                    _saveCanvas(ctx, data);
                }
                _translateCanvas(ctx, params, data.transforms);
            }
        }
        return $canvases;
    };
    $.fn.drawRect = function
    drawRect(args) {
        var
            $canvases = this,
            e, ctx, params, layer, x1, y1, x2, y2, r, temp;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawRect);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params, params.width, params.height);
                    ctx.beginPath();
                    if (params.width && params.height) {
                        x1 = params.x - (params.width / 2);
                        y1 = params.y - (params.height / 2);
                        r = abs(params.cornerRadius);
                        if (r) {
                            x2 = params.x + (params.width / 2);
                            y2 = params.y + (params.height / 2);
                            if (params.width < 0) {
                                temp = x1;
                                x1 = x2;
                                x2 = temp;
                            }
                            if (params.height < 0) {
                                temp = y1;
                                y1 = y2;
                                y2 = temp;
                            }
                            if ((x2 - x1) - (2 * r) < 0) {
                                r = (x2 - x1) / 2;
                            }
                            if ((y2 - y1) - (2 * r) < 0) {
                                r = (y2 - y1) / 2;
                            }
                            ctx.moveTo(x1 + r, y1);
                            ctx.lineTo(x2 - r, y1);
                            ctx.arc(x2 - r, y1 + r, r, 3 * PI / 2, PI * 2, FALSE);
                            ctx.lineTo(x2, y2 - r);
                            ctx.arc(x2 - r, y2 - r, r, 0, PI / 2, FALSE);
                            ctx.lineTo(x1 + r, y2);
                            ctx.arc(x1 + r, y2 - r, r, PI / 2, PI, FALSE);
                            ctx.lineTo(x1, y1 + r);
                            ctx.arc(x1 + r, y1 + r, r, PI, 3 * PI / 2, FALSE);
                            params.closed = TRUE;
                        } else {
                            ctx.rect(x1, y1, params.width, params.height);
                        }
                    }
                    _detectEvents($canvases[e], ctx, params);
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };

    function
    _getCoterminal(angle) {
        while (angle < 0) {
            angle += (2 * PI);
        }
        return angle;
    }

    function
    _getArcX(params, angle) {
        return params.x + (params.radius * cos(angle));
    }

    function
    _getArcY(params, angle) {
        return params.y + (params.radius * sin(angle));
    }

    function
    _drawArc(canvas, ctx, params, path) {
        var
            x1, y1, x2, y2, x3, y3, x4, y4, offsetX, offsetY, diff;
        if (params === path) {
            offsetX = 0;
            offsetY = 0;
        } else {
            offsetX = params.x;
            offsetY = params.y;
        }
        if (!path.inDegrees && path.end === 360) {
            path.end = PI * 2;
        }
        path.start *= params._toRad;
        path.end *= params._toRad;
        path.start -= (PI / 2);
        path.end -= (PI / 2);
        diff = PI / 180 * 1;
        if (path.ccw) {
            diff *= -1;
        }
        x1 = _getArcX(path, path.start + diff);
        y1 = _getArcY(path, path.start + diff);
        x2 = _getArcX(path, path.start);
        y2 = _getArcY(path, path.start);
        _addStartArrow(canvas, ctx, params, path, x1, y1, x2, y2);
        ctx.arc(path.x + offsetX, path.y + offsetY, path.radius, path.start, path.end, path.ccw);
        x3 = _getArcX(path, path.end + diff);
        y3 = _getArcY(path, path.end + diff);
        x4 = _getArcX(path, path.end);
        y4 = _getArcY(path, path.end);
        _addEndArrow(canvas, ctx, params, path, x4, y4, x3, y3);
    }
    $.fn.drawArc = function
    drawArc(args) {
        var
            $canvases = this,
            e, ctx, params, layer;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawArc);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params, params.radius * 2);
                    ctx.beginPath();
                    _drawArc($canvases[e], ctx, params, params);
                    _detectEvents($canvases[e], ctx, params);
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };
    $.fn.drawEllipse = function
    drawEllipse(args) {
        var
            $canvases = this,
            e, ctx, params, layer, controlW, controlH;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawEllipse);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params, params.width, params.height);
                    controlW = params.width * (4 / 3);
                    controlH = params.height;
                    ctx.beginPath();
                    ctx.moveTo(params.x, params.y - (controlH / 2));
                    ctx.bezierCurveTo(params.x - (controlW / 2), params.y - (controlH / 2), params.x - (controlW / 2), params.y + (controlH / 2), params.x, params.y + (controlH / 2));
                    ctx.bezierCurveTo(params.x + (controlW / 2), params.y + (controlH / 2), params.x + (controlW / 2), params.y - (controlH / 2), params.x, params.y - (controlH / 2));
                    _detectEvents($canvases[e], ctx, params);
                    params.closed = TRUE;
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };
    $.fn.drawPolygon = function
    drawPolygon(args) {
        var
            $canvases = this,
            e, ctx, params, layer, theta, dtheta, hdtheta, apothem, x, y, i;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawPolygon);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params, params.radius * 2);
                    dtheta = (2 * PI) / params.sides;
                    hdtheta = dtheta / 2;
                    theta = hdtheta + (PI / 2);
                    apothem = params.radius * cos(hdtheta);
                    ctx.beginPath();
                    for (i = 0; i < params.sides; i += 1) {
                        x = params.x + (params.radius * cos(theta));
                        y = params.y + (params.radius * sin(theta));
                        ctx.lineTo(x, y);
                        if (params.concavity) {
                            x = params.x + ((apothem + (-apothem * params.concavity)) * cos(theta + hdtheta));
                            y = params.y + ((apothem + (-apothem * params.concavity)) * sin(theta + hdtheta));
                            ctx.lineTo(x, y);
                        }
                        theta += dtheta;
                    }
                    _detectEvents($canvases[e], ctx, params);
                    params.closed = TRUE;
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };
    $.fn.drawSlice = function
    drawSlice(args) {
        var
            $canvases = this,
            $canvas, e, ctx, params, layer, angle, dx, dy;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawSlice);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params, params.radius * 2);
                    params.start *= params._toRad;
                    params.end *= params._toRad;
                    params.start -= (PI / 2);
                    params.end -= (PI / 2);
                    params.start = _getCoterminal(params.start);
                    params.end = _getCoterminal(params.end);
                    if (params.end < params.start) {
                        params.end += (2 * PI);
                    }
                    angle = ((params.start + params.end) / 2);
                    dx = (params.radius * params.spread * cos(angle));
                    dy = (params.radius * params.spread * sin(angle));
                    params.x += dx;
                    params.y += dy;
                    ctx.beginPath();
                    ctx.arc(params.x, params.y, params.radius, params.start, params.end, params.ccw);
                    ctx.lineTo(params.x, params.y);
                    _detectEvents($canvases[e], ctx, params);
                    params.closed = TRUE;
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };

    function
    _addArrow(canvas, ctx, params, path, x1, y1, x2, y2) {
        var
            leftX, leftY, rightX, rightY, offsetX, offsetY, angle;
        if (path.arrowRadius && !params.closed) {
            angle = atan2((y2 - y1), (x2 - x1));
            angle -= PI;
            offsetX = (params.strokeWidth * cos(angle));
            offsetY = (params.strokeWidth * sin(angle));
            leftX = x2 + (path.arrowRadius * cos(angle + (path.arrowAngle / 2)));
            leftY = y2 + (path.arrowRadius * sin(angle + (path.arrowAngle / 2)));
            rightX = x2 + (path.arrowRadius * cos(angle - (path.arrowAngle / 2)));
            rightY = y2 + (path.arrowRadius * sin(angle - (path.arrowAngle / 2)));
            ctx.moveTo(leftX - offsetX, leftY - offsetY);
            ctx.lineTo(x2 - offsetX, y2 - offsetY);
            ctx.lineTo(rightX - offsetX, rightY - offsetY);
            ctx.moveTo(x2 - offsetX, y2 - offsetY);
            ctx.lineTo(x2 + offsetX, y2 + offsetY);
            ctx.moveTo(x2, y2);
        }
    }

    function
    _addStartArrow(canvas, ctx, params, path, x1, y1, x2, y2) {
        if (!path._arrowAngleConverted) {
            path.arrowAngle *= params._toRad;
            path._arrowAngleConverted = TRUE;
        }
        if (path.startArrow) {
            _addArrow(canvas, ctx, params, path, x1, y1, x2, y2);
        }
    }

    function
    _addEndArrow(canvas, ctx, params, path, x1, y1, x2, y2) {
        if (!path._arrowAngleConverted) {
            path.arrowAngle *= params._toRad;
            path._arrowAngleConverted = TRUE;
        }
        if (path.endArrow) {
            _addArrow(canvas, ctx, params, path, x1, y1, x2, y2);
        }
    }

    function
    _drawLine(canvas, ctx, params, path) {
        var
            l, lx, ly;
        l = 2;
        _addStartArrow(canvas, ctx, params, path, path.x2 + params.x, path.y2 + params.y, path.x1 + params.x, path.y1 + params.y);
        if (path.x1 !== UNDEFINED && path.y1 !== UNDEFINED) {
            ctx.moveTo(path.x1 + params.x, path.y1 + params.y);
        }
        while (TRUE) {
            lx = path['x' + l];
            ly = path['y' + l];
            if (lx !== UNDEFINED && ly !== UNDEFINED) {
                ctx.lineTo(lx + params.x, ly + params.y);
                l += 1;
            } else {
                break;
            }
        }
        l -= 1;
        _addEndArrow(canvas, ctx, params, path, path['x' + (l - 1)] + params.x, path['y' + (l - 1)] + params.y, path['x' + l] + params.x, path['y' + l] + params.y);
    }
    $.fn.drawLine = function
    drawLine(args) {
        var
            $canvases = this,
            e, ctx, params, layer;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawLine);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params);
                    ctx.beginPath();
                    _drawLine($canvases[e], ctx, params, params);
                    _detectEvents($canvases[e], ctx, params);
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };

    function
    _drawQuadratic(canvas, ctx, params, path) {
        var
            l, lx, ly, lcx, lcy;
        l = 2;
        _addStartArrow(canvas, ctx, params, path, path.cx1 + params.x, path.cy1 + params.y, path.x1 + params.x, path.y1 + params.y);
        if (path.x1 !== UNDEFINED && path.y1 !== UNDEFINED) {
            ctx.moveTo(path.x1 + params.x, path.y1 + params.y);
        }
        while (TRUE) {
            lx = path['x' + l];
            ly = path['y' + l];
            lcx = path['cx' + (l - 1)];
            lcy = path['cy' + (l - 1)];
            if (lx !== UNDEFINED && ly !== UNDEFINED && lcx !== UNDEFINED && lcy !== UNDEFINED) {
                ctx.quadraticCurveTo(lcx + params.x, lcy + params.y, lx + params.x, ly + params.y);
                l += 1;
            } else {
                break;
            }
        }
        l -= 1;
        _addEndArrow(canvas, ctx, params, path, path['cx' + (l - 1)] + params.x, path['cy' + (l - 1)] + params.y, path['x' + l] + params.x, path['y' + l] + params.y);
    }
    $.fn.drawQuadratic = function
    drawQuadratic(args) {
        var
            $canvases = this,
            e, ctx, params, layer;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawQuadratic);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params);
                    ctx.beginPath();
                    _drawQuadratic($canvases[e], ctx, params, params);
                    _detectEvents($canvases[e], ctx, params);
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };

    function
    _drawBezier(canvas, ctx, params, path) {
        var
            l, lc, lx, ly, lcx1, lcy1, lcx2, lcy2;
        l = 2;
        lc = 1;
        _addStartArrow(canvas, ctx, params, path, path.cx1 + params.x, path.cy1 + params.y, path.x1 + params.x, path.y1 + params.y);
        if (path.x1 !== UNDEFINED && path.y1 !== UNDEFINED) {
            ctx.moveTo(path.x1 + params.x, path.y1 + params.y);
        }
        while (TRUE) {
            lx = path['x' + l];
            ly = path['y' + l];
            lcx1 = path['cx' + lc];
            lcy1 = path['cy' + lc];
            lcx2 = path['cx' + (lc + 1)];
            lcy2 = path['cy' + (lc + 1)];
            if (lx !== UNDEFINED && ly !== UNDEFINED && lcx1 !== UNDEFINED && lcy1 !== UNDEFINED && lcx2 !== UNDEFINED && lcy2 !== UNDEFINED) {
                ctx.bezierCurveTo(lcx1 + params.x, lcy1 + params.y, lcx2 + params.x, lcy2 + params.y, lx + params.x, ly + params.y);
                l += 1;
                lc += 2;
            } else {
                break;
            }
        }
        l -= 1;
        lc -= 2;
        _addEndArrow(canvas, ctx, params, path, path['cx' + (lc + 1)] + params.x, path['cy' + (lc + 1)] + params.y, path['x' + l] + params.x, path['y' + l] + params.y);
    }
    $.fn.drawBezier = function
    drawBezier(args) {
        var
            $canvases = this,
            e, ctx, params, layer;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawBezier);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params);
                    ctx.beginPath();
                    _drawBezier($canvases[e], ctx, params, params);
                    _detectEvents($canvases[e], ctx, params);
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };

    function
    _getVectorX(params, angle, length) {
        angle *= params._toRad;
        angle -= (PI / 2);
        return (length * cos(angle));
    }

    function
    _getVectorY(params, angle, length) {
        angle *= params._toRad;
        angle -= (PI / 2);
        return (length * sin(angle));
    }

    function
    _drawVector(canvas, ctx, params, path) {
        var
            l, angle, length, offsetX, offsetY, x, y, x2, y2, x3, y3, x4, y4;
        if (params === path) {
            offsetX = 0;
            offsetY = 0;
        } else {
            offsetX = params.x;
            offsetY = params.y;
        }
        l = 1;
        x = x2 = x3 = x4 = path.x + offsetX;
        y = y2 = y3 = y4 = path.y + offsetY;
        _addStartArrow(canvas, ctx, params, path, x + _getVectorX(params, path.a1, path.l1), y + _getVectorY(params, path.a1, path.l1), x, y);
        if (path.x !== UNDEFINED && path.y !== UNDEFINED) {
            ctx.moveTo(x, y);
        }
        while (TRUE) {
            angle = path['a' + l];
            length = path['l' + l];
            if (angle !== UNDEFINED && length !== UNDEFINED) {
                x3 = x4;
                y3 = y4;
                x4 += _getVectorX(params, angle, length);
                y4 += _getVectorY(params, angle, length);
                if (l === 1) {
                    x2 = x4;
                    y2 = y4;
                }
                ctx.lineTo(x4, y4);
                l += 1;
            } else {
                break;
            }
        }
        _addEndArrow(canvas, ctx, params, path, x3, y3, x4, y4);
    }
    $.fn.drawVector = function
    drawVector(args) {
        var
            $canvases = this,
            e, ctx, params, layer;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawVector);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params);
                    ctx.beginPath();
                    _drawVector($canvases[e], ctx, params, params);
                    _detectEvents($canvases[e], ctx, params);
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };
    $.fn.drawPath = function
    drawPath(args) {
        var
            $canvases = this,
            e, ctx, params, layer, l, lp;
        for (e = 0; e < $canvases.length; e += 1) {
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawPath);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    _transformShape($canvases[e], ctx, params);
                    ctx.beginPath();
                    l = 1;
                    while (TRUE) {
                        lp = params['p' + l];
                        if (lp !== UNDEFINED) {
                            lp = new
                            jCanvasObject(lp);
                            if (lp.type === 'line') {
                                _drawLine($canvases[e], ctx, params, lp);
                            } else
                            if (lp.type === 'quadratic') {
                                _drawQuadratic($canvases[e], ctx, params, lp);
                            } else
                            if (lp.type === 'bezier') {
                                _drawBezier($canvases[e], ctx, params, lp);
                            } else
                            if (lp.type === 'vector') {
                                _drawVector($canvases[e], ctx, params, lp);
                            } else
                            if (lp.type === 'arc') {
                                _drawArc($canvases[e], ctx, params, lp);
                            }
                            l += 1;
                        } else {
                            break;
                        }
                    }
                    _detectEvents($canvases[e], ctx, params);
                    _closePath($canvases[e], ctx, params);
                }
            }
        }
        return $canvases;
    };

    function
    _setCanvasFont(canvas, ctx, params) {
        if (!isNaN(Number(params.fontSize))) {
            params.fontSize += 'px';
        }
        ctx.font = params.fontStyle + ' ' + params.fontSize + ' ' + params.fontFamily;
    }

    function
    _measureText(canvas, ctx, params, lines) {
        var
            originalSize, curWidth, l, propCache = caches.propCache;
        if (propCache.text === params.text && propCache.fontStyle === params.fontStyle && propCache.fontSize === params.fontSize && propCache.fontFamily === params.fontFamily && propCache.maxWidth === params.maxWidth && propCache.lineHeight === params.lineHeight) {
            params.width = propCache.width;
            params.height = propCache.height;
        } else {
            params.width = ctx.measureText(lines[0]).width;
            for (l = 1; l < lines.length; l += 1) {
                curWidth = ctx.measureText(lines[l]).width;
                if (curWidth > params.width) {
                    params.width = curWidth;
                }
            }
            originalSize = canvas.style.fontSize;
            canvas.style.fontSize = params.fontSize;
            params.height = parseFloat($.css(canvas, 'fontSize')) * lines.length * params.lineHeight;
            canvas.style.fontSize = originalSize;
        }
    }

    function
    _wrapText(ctx, params) {
        var
            allText = params.text,
            maxWidth = params.maxWidth,
            manualLines = allText.split('\n'),
            allLines = [],
            lines, line, l, text, words, w;
        for (l = 0; l < manualLines.length; l += 1) {
            text = manualLines[l];
            words = text.split(' ');
            lines = [];
            line = '';
            if (words.length === 1 || ctx.measureText(text).width < maxWidth) {
                lines = [text];
            } else {
                for (w = 0; w < words.length; w += 1) {
                    if (ctx.measureText(line + words[w]).width > maxWidth) {
                        if (line !== '') {
                            lines.push(line);
                        }
                        line = '';
                    }
                    line += words[w];
                    if (w !== (words.length - 1)) {
                        line += ' ';
                    }
                }
                lines.push(line);
            }
            allLines = allLines.concat(lines.join('\n').replace(/( (\n))|( $)/gi, '$2').split('\n'));
        }
        return allLines;
    }
    $.fn.drawText = function
    drawText(args) {
        var
            $canvases = this,
            $canvas, e, ctx, params, layer, lines, line, l, fontSize, constantCloseness = 500,
            nchars, ch, c, x, y;
        for (e = 0; e < $canvases.length; e += 1) {
            $canvas = $($canvases[e]);
            ctx = _getContext($canvases[e]);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawText);
                if (params.visible) {
                    _setGlobalProps($canvases[e], ctx, params);
                    ctx.textBaseline = params.baseline;
                    ctx.textAlign = params.align;
                    _setCanvasFont($canvases[e], ctx, params);
                    if (params.maxWidth !== NULL) {
                        lines = _wrapText(ctx, params);
                    } else {
                        lines = params.text.toString().split('\n');
                    }
                    _measureText($canvases[e], ctx, params, lines);
                    if (layer) {
                        layer.width = params.width;
                        layer.height = params.height;
                    }
                    _transformShape($canvases[e], ctx, params, params.width, params.height);
                    x = params.x;
                    if (params.align === 'left') {
                        if (params.respectAlign) {
                            params.x += params.width / 2;
                        } else {
                            x -= params.width / 2;
                        }
                    } else
                    if (params.align === 'right') {
                        if (params.respectAlign) {
                            params.x -= params.width / 2;
                        } else {
                            x += params.width / 2;
                        }
                    }
                    if (params.radius) {
                        fontSize = parseFloat(params.fontSize);
                        if (params.letterSpacing === NULL) {
                            params.letterSpacing = fontSize / constantCloseness;
                        }
                        for (l = 0; l < lines.length; l += 1) {
                            ctx.save();
                            ctx.translate(params.x, params.y);
                            line = lines[l];
                            nchars = line.length;
                            ctx.rotate(-(PI * params.letterSpacing * (nchars - 1)) / 2);
                            for (c = 0; c < nchars; c += 1) {
                                ch = line[c];
                                if (c !== 0) {
                                    ctx.rotate(PI * params.letterSpacing);
                                }
                                ctx.save();
                                ctx.translate(0, -params.radius);
                                ctx.fillText(ch, 0, 0);
                                ctx.restore();
                            }
                            params.radius -= fontSize;
                            params.letterSpacing += fontSize / (constantCloseness * 2 * PI);
                            ctx.restore();
                        }
                    } else {
                        for (l = 0; l < lines.length; l += 1) {
                            line = lines[l];
                            y = params.y + (l * params.height / lines.length) - ((lines.length - 1) * params.height / lines.length) / 2;
                            ctx.shadowColor = params.shadowColor;
                            if (params.strokeWidth !== 0) {
                                ctx.strokeText(line, x, y);
                            }
                            ctx.fillText(line, x, y);
                            if (params.fillStyle !== 'transparent') {
                                ctx.shadowColor = 'transparent';
                            }
                        }
                    }
                    y = 0;
                    if (params.baseline === 'top') {
                        y += params.height / 2;
                    } else
                    if (params.baseline === 'bottom') {
                        y -= params.height / 2;
                    }
                    if (params._event) {
                        ctx.beginPath();
                        ctx.rect(params.x - params.width / 2, params.y - params.height / 2 + y, params.width, params.height);
                        _detectEvents($canvases[e], ctx, params);
                        ctx.closePath();
                    }
                    _restoreTransform(ctx, params);
                }
            }
        }
        caches.propCache = params;
        return $canvases;
    };
    $.fn.measureText = function
    measureText(args) {
        var
            $canvases = this,
            ctx, params, lines;
        params = $canvases.getLayer(args);
        if (!params || (params && !params._layer)) {
            params = new
            jCanvasObject(args);
        }
        ctx = _getContext($canvases[0]);
        if (ctx) {
            _setCanvasFont($canvases[0], ctx, params);
            lines = _wrapText(ctx, params);
            _measureText($canvases[0], ctx, params, lines);
        }
        return params;
    };
    $.fn.drawImage = function
    drawImage(args) {
        var
            $canvases = this,
            canvas, e, ctx, data, params, layer, img, imgCtx, source, imageCache = caches.imageCache;

        function
        draw(canvas, ctx, data, params, layer) {
            _setGlobalProps(canvas, ctx, params);
            if (params.width === NULL && params.sWidth === NULL) {
                params.width = params.sWidth = img.width;
            }
            if (params.height === NULL && params.sHeight === NULL) {
                params.height = params.sHeight = img.height;
            }
            if (layer) {
                layer.width = params.width;
                layer.height = params.height;
            }
            if (params.sWidth !== NULL && params.sHeight !== NULL && params.sx !== NULL && params.sy !== NULL) {
                if (params.width === NULL) {
                    params.width = params.sWidth;
                }
                if (params.height === NULL) {
                    params.height = params.sHeight;
                }
                if (!params.cropFromCenter) {
                    params.sx += params.sWidth / 2;
                    params.sy += params.sHeight / 2;
                }
                if ((params.sy - (params.sHeight / 2)) < 0) {
                    params.sy = (params.sHeight / 2);
                }
                if ((params.sy + (params.sHeight / 2)) > img.height) {
                    params.sy = img.height - (params.sHeight / 2);
                }
                if ((params.sx - (params.sWidth / 2)) < 0) {
                    params.sx = (params.sWidth / 2);
                }
                if ((params.sx + (params.sWidth / 2)) > img.width) {
                    params.sx = img.width - (params.sWidth / 2);
                }
                _transformShape(canvas, ctx, params, params.width, params.height);
                ctx.drawImage(img, params.sx - params.sWidth / 2, params.sy - params.sHeight / 2, params.sWidth, params.sHeight, params.x - params.width / 2, params.y - params.height / 2, params.width, params.height);
            } else {
                _transformShape(canvas, ctx, params, params.width, params.height);
                ctx.drawImage(img, params.x - params.width / 2, params.y - params.height / 2, params.width, params.height);
            }
            ctx.beginPath();
            ctx.rect(params.x - params.width / 2, params.y - params.height / 2, params.width, params.height);
            _detectEvents(canvas, ctx, params);
            ctx.closePath();
            _restoreTransform(ctx, params);
            _enableMasking(ctx, data, params);
        }

        function
        onload(canvas, ctx, data, params, layer) {
            return function() {
                var
                    $canvas = $(canvas);
                draw(canvas, ctx, data, params, layer);
                if (params.layer) {
                    _triggerLayerEvent($canvas, data, layer, 'load');
                } else
                if (params.load) {
                    params.load.call($canvas[0], layer);
                }
                if (params.layer) {
                    layer._masks = data.transforms.masks.slice(0);
                    if (params._next) {
                        $canvas.drawLayers({
                            clear: FALSE,
                            resetFire: TRUE,
                            index: params._next
                        });
                    }
                }
            };
        }
        for (e = 0; e < $canvases.length; e += 1) {
            canvas = $canvases[e];
            ctx = _getContext($canvases[e]);
            if (ctx) {
                data = _getCanvasData($canvases[e]);
                params = new
                jCanvasObject(args);
                layer = _addLayer($canvases[e], params, args, drawImage);
                if (params.visible) {
                    source = params.source;
                    imgCtx = source.getContext;
                    if (source.src || imgCtx) {
                        img = source;
                    } else
                    if (source) {
                        if (imageCache[source] && imageCache[source].complete) {
                            img = imageCache[source];
                        } else {
                            img = new
                            Image();
                            img.crossOrigin = params.crossOrigin;
                            img.src = source;
                            imageCache[source] = img;
                        }
                    }
                    if (img) {
                        if (img.complete || imgCtx) {
                            onload(canvas, ctx, data, params, layer)();
                        } else {
                            img.onload = onload(canvas, ctx, data, params, layer);
                            img.src = img.src;
                        }
                    }
                }
            }
        }
        return $canvases;
    };
    $.fn.createPattern = function
    createPattern(args) {
        var
            $canvases = this,
            ctx, params, img, imgCtx, pattern, source;

        function
        onload() {
            pattern = ctx.createPattern(img, params.repeat);
            if (params.load) {
                params.load.call($canvases[0], pattern);
            }
        }
        ctx = _getContext($canvases[0]);
        if (ctx) {
            params = new
            jCanvasObject(args);
            source = params.source;
            if (isFunction(source)) {
                img = $('<canvas />')[0];
                img.width = params.width;
                img.height = params.height;
                imgCtx = _getContext(img);
                source.call(img, imgCtx);
                onload();
            } else {
                imgCtx = source.getContext;
                if (source.src || imgCtx) {
                    img = source;
                } else {
                    img = new
                    Image();
                    img.crossOrigin = params.crossOrigin;
                    img.src = source;
                }
                if (img.complete || imgCtx) {
                    onload();
                } else {
                    img.onload = onload();
                    img.src = img.src;
                }
            }
        } else {
            pattern = NULL;
        }
        return pattern;
    };
    $.fn.createGradient = function
    createGradient(args) {
        var
            $canvases = this,
            ctx, params, gradient, stops = [],
            nstops, start, end, i, a, n, p;
        params = new
        jCanvasObject(args);
        ctx = _getContext($canvases[0]);
        if (ctx) {
            params.x1 = params.x1 || 0;
            params.y1 = params.y1 || 0;
            params.x2 = params.x2 || 0;
            params.y2 = params.y2 || 0;
            if (params.r1 !== NULL && params.r2 !== NULL) {
                gradient = ctx.createRadialGradient(params.x1, params.y1, params.r1, params.x2, params.y2, params.r2);
            } else {
                gradient = ctx.createLinearGradient(params.x1, params.y1, params.x2, params.y2);
            }
            for (i = 1; params['c' + i] !== UNDEFINED; i += 1) {
                if (params['s' + i] !== UNDEFINED) {
                    stops.push(params['s' + i]);
                } else {
                    stops.push(NULL);
                }
            }
            nstops = stops.length;
            if (stops[0] === NULL) {
                stops[0] = 0;
            }
            if (stops[nstops - 1] === NULL) {
                stops[nstops - 1] = 1;
            }
            for (i = 0; i < nstops; i += 1) {
                if (stops[i] !== NULL) {
                    n = 1;
                    p = 0;
                    start = stops[i];
                    for (a = (i + 1); a < nstops; a += 1) {
                        if (stops[a] !== NULL) {
                            end = stops[a];
                            break;
                        } else {
                            n += 1;
                        }
                    }
                    if (start > end) {
                        stops[a] = stops[i];
                    }
                } else
                if (stops[i] === NULL) {
                    p += 1;
                    stops[i] = start + (p * ((end - start) / n));
                }
                gradient.addColorStop(stops[i], params['c' + (i + 1)]);
            }
        } else {
            gradient = NULL;
        }
        return gradient;
    };
    $.fn.setPixels = function
    setPixels(args) {
        var
            $canvases = this,
            canvas, e, ctx, params, layer, px, imgData, data, i, len;
        for (e = 0; e < $canvases.length; e += 1) {
            canvas = $canvases[e];
            ctx = _getContext(canvas);
            if (ctx) {
                params = new
                jCanvasObject(args);
                layer = _addLayer(canvas, params, args, setPixels);
                _transformShape($canvases[e], ctx, params, params.width, params.height);
                if (params.width === NULL || params.height === NULL) {
                    params.width = canvas.width;
                    params.height = canvas.height;
                    params.x = params.width / 2;
                    params.y = params.height / 2;
                }
                if (params.width !== 0 && params.height !== 0) {
                    imgData = ctx.getImageData(params.x - (params.width / 2), params.y - (params.height / 2), params.width, params.height);
                    data = imgData.data;
                    len = data.length;
                    if (params.each) {
                        for (i = 0; i < len; i += 4) {
                            px = {
                                r: data[i],
                                g: data[i + 1],
                                b: data[i + 2],
                                a: data[i + 3]
                            };
                            params.each.call(canvas, px, params);
                            data[i] = px.r;
                            data[i + 1] = px.g;
                            data[i + 2] = px.b;
                            data[i + 3] = px.a;
                        }
                    }
                    ctx.putImageData(imgData, params.x - (params.width / 2), params.y - (params.height / 2));
                    ctx.restore();
                }
            }
        }
        return $canvases;
    };
    $.fn.getCanvasImage = function
    getCanvasImage(type, quality) {
        var
            $canvases = this,
            canvas, dataURL = NULL;
        if ($canvases.length !== 0) {
            canvas = $canvases[0];
            if (canvas.toDataURL) {
                if (quality === UNDEFINED) {
                    quality = 1;
                }
                dataURL = canvas.toDataURL('image/' + type, quality);
            }
        }
        return dataURL;
    };
    $.fn.detectPixelRatio = function
    detectPixelRatio(callback) {
        var
            $canvases = this,
            $canvas, canvas, e, ctx, devicePixelRatio, backingStoreRatio, ratio, oldWidth, oldHeight, data;
        for (e = 0; e < $canvases.length; e += 1) {
            canvas = $canvases[e];
            $canvas = $($canvases[e]);
            ctx = _getContext(canvas);
            data = _getCanvasData($canvases[e]);
            if (!data.scaled) {
                devicePixelRatio = window.devicePixelRatio || 1;
                backingStoreRatio = ctx.webkitBackingStorePixelRatio || ctx.mozBackingStorePixelRatio || ctx.msBackingStorePixelRatio || ctx.oBackingStorePixelRatio || ctx.backingStorePixelRatio || 1;
                ratio = devicePixelRatio / backingStoreRatio;
                if (ratio !== 1) {
                    oldWidth = canvas.width;
                    oldHeight = canvas.height;
                    canvas.width = oldWidth * ratio;
                    canvas.height = oldHeight * ratio;
                    canvas.style.width = oldWidth + 'px';
                    canvas.style.height = oldHeight + 'px';
                    ctx.scale(ratio, ratio);
                }
                data.pixelRatio = ratio;
                data.scaled = TRUE;
                if (callback) {
                    callback.call(canvas, ratio);
                }
            }
        }
        return $canvases;
    };
    jCanvas.clearCache = function
    clearCache() {
        var
            cacheName;
        for (cacheName in
            caches) {
            if (caches.hasOwnProperty(cacheName)) {
                caches[cacheName] = {};
            }
        }
    };
    $.support.canvas = ($('<canvas />')[0].getContext !== UNDEFINED);
    extendObject(jCanvas, {
        defaults: defaults,
        prefs: prefs,
        setGlobalProps: _setGlobalProps,
        transformShape: _transformShape,
        detectEvents: _detectEvents,
        closePath: _closePath,
        setCanvasFont: _setCanvasFont,
        measureText: _measureText
    });
    $.jCanvas = jCanvas;
    $.jCanvasObject = jCanvasObject;
}(jQuery, document, Image, Array, Math, parseFloat, console, true, false, null));
if (!jQuery) throw new
Error("Bootstrap requires jQuery"); + function(a) {
    "use strict";

    function
    b() {
        var
            a = document.createElement("bootstrap"),
            b = {
                WebkitTransition: "webkitTransitionEnd",
                MozTransition: "transitionend",
                OTransition: "oTransitionEnd otransitionend",
                transition: "transitionend"
            };
        for (var
                c in
                b)
            if (void 0 !== a.style[c]) return {
                end: b[c]
            }
    }
    a.fn.emulateTransitionEnd = function(b) {
        var
            c = !1,
            d = this;
        a(this).one(a.support.transition.end, function() {
            c = !0
        });
        var
            e = function() {
                c || a(d).trigger(a.support.transition.end)
            };
        return setTimeout(e, b), this
    }, a(function() {
        a.support.transition = b()
    })
}(window.jQuery), + function(a) {
    "use strict";
    var
        b = '[data-dismiss="alert"]',
        c = function(c) {
            a(c).on("click", b, this.close)
        };
    c.prototype.close = function(b) {
        function
        c() {
            f.trigger("closed.bs.alert").remove()
        }
        var
            d = a(this),
            e = d.attr("data-target");
        e || (e = d.attr("href"), e = e && e.replace(/.*(?=#[^\s]*$)/, ""));
        var
            f = a(e);
        b && b.preventDefault(), f.length || (f = d.hasClass("alert") ? d : d.parent()), f.trigger(b = a.Event("close.bs.alert")), b.isDefaultPrevented() || (f.removeClass("in"), a.support.transition && f.hasClass("fade") ? f.one(a.support.transition.end, c).emulateTransitionEnd(150) : c())
    };
    var
        d = a.fn.alert;
    a.fn.alert = function(b) {
        return this.each(function() {
            var
                d = a(this),
                e = d.data("bs.alert");
            e || d.data("bs.alert", e = new c(this)), "string" == typeof
            b && e[b].call(d)
        })
    }, a.fn.alert.Constructor = c, a.fn.alert.noConflict = function() {
        return a.fn.alert = d, this
    }, a(document).on("click.bs.alert.data-api", b, c.prototype.close)
}(window.jQuery), + function(a) {
    "use strict";
    var
        b = function(c, d) {
            this.$element = a(c), this.options = a.extend({}, b.DEFAULTS, d)
        };
    b.DEFAULTS = {
        loadingText: "loading..."
    }, b.prototype.setState = function(a) {
        var
            b = "disabled",
            c = this.$element,
            d = c.is("input") ? "val" : "html",
            e = c.data();
        a += "Text", e.resetText || c.data("resetText", c[d]()), c[d](e[a] || this.options[a]), setTimeout(function() {
            "loadingText" == a ? c.addClass(b).attr(b, b) : c.removeClass(b).removeAttr(b)
        }, 0)
    }, b.prototype.toggle = function() {
        var
            a = this.$element.closest('[data-toggle="buttons"]');
        if (a.length) {
            var
                b = this.$element.find("input").prop("checked", !this.$element.hasClass("active")).trigger("change");
            "radio" === b.prop("type") && a.find(".active").removeClass("active")
        }
        this.$element.toggleClass("active")
    };
    var
        c = a.fn.button;
    a.fn.button = function(c) {
        return this.each(function() {
            var
                d = a(this),
                e = d.data("bs.button"),
                f = "object" == typeof
            c && c;
            e || d.data("bs.button", e = new b(this, f)), "toggle" == c ? e.toggle() : c && e.setState(c)
        })
    }, a.fn.button.Constructor = b, a.fn.button.noConflict = function() {
        return a.fn.button = c, this
    }, a(document).on("click.bs.button.data-api", "[data-toggle^=button]", function(b) {
        var
            c = a(b.target);
        c.hasClass("btn") || (c = c.closest(".btn")), c.button("toggle"), b.preventDefault()
    })
}(window.jQuery), + function(a) {
    "use strict";
    var
        b = function(b, c) {
            this.$element = a(b), this.$indicators = this.$element.find(".carousel-indicators"), this.options = c, this.paused = this.sliding = this.interval = this.$active = this.$items = null, "hover" == this.options.pause && this.$element.on("mouseenter", a.proxy(this.pause, this)).on("mouseleave", a.proxy(this.cycle, this))
        };
    b.DEFAULTS = {
        interval: 5e3,
        pause: "hover",
        wrap: !0
    }, b.prototype.cycle = function(b) {
        return b || (this.paused = !1), this.interval && clearInterval(this.interval), this.options.interval && !this.paused && (this.interval = setInterval(a.proxy(this.next, this), this.options.interval)), this
    }, b.prototype.getActiveIndex = function() {
        return this.$active = this.$element.find(".item.active"), this.$items = this.$active.parent().children(), this.$items.index(this.$active)
    }, b.prototype.to = function(b) {
        var
            c = this,
            d = this.getActiveIndex();
        return b > this.$items.length - 1 || 0 > b ? void
        0: this.sliding ? this.$element.one("slid", function() {
            c.to(b)
        }) : d == b ? this.pause().cycle() : this.slide(b > d ? "next" : "prev", a(this.$items[b]))
    }, b.prototype.pause = function(b) {
        return b || (this.paused = !0), this.$element.find(".next, .prev").length && a.support.transition.end && (this.$element.trigger(a.support.transition.end), this.cycle(!0)), this.interval = clearInterval(this.interval), this
    }, b.prototype.next = function() {
        return this.sliding ? void
        0: this.slide("next")
    }, b.prototype.prev = function() {
        return this.sliding ? void
        0: this.slide("prev")
    }, b.prototype.slide = function(b, c) {
        var
            d = this.$element.find(".item.active"),
            e = c || d[b](),
            f = this.interval,
            g = "next" == b ? "left" : "right",
            h = "next" == b ? "first" : "last",
            i = this;
        if (!e.length) {
            if (!this.options.wrap) return;
            e = this.$element.find(".item")[h]()
        }
        this.sliding = !0, f && this.pause();
        var
            j = a.Event("slide.bs.carousel", {
                relatedTarget: e[0],
                direction: g
            });
        if (!e.hasClass("active")) {
            if (this.$indicators.length && (this.$indicators.find(".active").removeClass("active"), this.$element.one("slid", function() {
                    var
                        b = a(i.$indicators.children()[i.getActiveIndex()]);
                    b && b.addClass("active")
                })), a.support.transition && this.$element.hasClass("slide")) {
                if (this.$element.trigger(j), j.isDefaultPrevented()) return;
                e.addClass(b), e[0].offsetWidth, d.addClass(g), e.addClass(g), d.one(a.support.transition.end, function() {
                    e.removeClass([b, g].join(" ")).addClass("active"), d.removeClass(["active", g].join(" ")), i.sliding = !1, setTimeout(function() {
                        i.$element.trigger("slid")
                    }, 0)
                }).emulateTransitionEnd(600)
            } else {
                if (this.$element.trigger(j), j.isDefaultPrevented()) return;
                d.removeClass("active"), e.addClass("active"), this.sliding = !1, this.$element.trigger("slid")
            }
            return f && this.cycle(), this
        }
    };
    var
        c = a.fn.carousel;
    a.fn.carousel = function(c) {
        return this.each(function() {
            var
                d = a(this),
                e = d.data("bs.carousel"),
                f = a.extend({}, b.DEFAULTS, d.data(), "object" == typeof c && c),
                g = "string" == typeof
            c ? c : f.slide;
            e || d.data("bs.carousel", e = new b(this, f)), "number" == typeof
            c ? e.to(c) : g ? e[g]() : f.interval && e.pause().cycle()
        })
    }, a.fn.carousel.Constructor = b, a.fn.carousel.noConflict = function() {
        return a.fn.carousel = c, this
    }, a(document).on("click.bs.carousel.data-api", "[data-slide], [data-slide-to]", function(b) {
        var
            c, d = a(this),
            e = a(d.attr("data-target") || (c = d.attr("href")) && c.replace(/.*(?=#[^\s]+$)/, "")),
            f = a.extend({}, e.data(), d.data()),
            g = d.attr("data-slide-to");
        g && (f.interval = !1), e.carousel(f), (g = d.attr("data-slide-to")) && e.data("bs.carousel").to(g), b.preventDefault()
    }), a(window).on("load", function() {
        a('[data-ride="carousel"]').each(function() {
            var
                b = a(this);
            b.carousel(b.data())
        })
    })
}(window.jQuery), + function(a) {
    "use strict";
    var
        b = function(c, d) {
            this.$element = a(c), this.options = a.extend({}, b.DEFAULTS, d), this.transitioning = null, this.options.parent && (this.$parent = a(this.options.parent)), this.options.toggle && this.toggle()
        };
    b.DEFAULTS = {
        toggle: !0
    }, b.prototype.dimension = function() {
        var
            a = this.$element.hasClass("width");
        return a ? "width" : "height"
    }, b.prototype.show = function() {
        if (!this.transitioning && !this.$element.hasClass("in")) {
            var
                b = a.Event("show.bs.collapse");
            if (this.$element.trigger(b), !b.isDefaultPrevented()) {
                var
                    c = this.$parent && this.$parent.find("> .panel > .in");
                if (c && c.length) {
                    var
                        d = c.data("bs.collapse");
                    if (d && d.transitioning) return;
                    c.collapse("hide"), d || c.data("bs.collapse", null)
                }
                var
                    e = this.dimension();
                this.$element.removeClass("collapse").addClass("collapsing")[e](0), this.transitioning = 1;
                var
                    f = function() {
                        this.$element.removeClass("collapsing").addClass("in")[e]("auto"), this.transitioning = 0, this.$element.trigger("shown.bs.collapse")
                    };
                if (!a.support.transition) return f.call(this);
                var
                    g = a.camelCase(["scroll", e].join("-"));
                this.$element.one(a.support.transition.end, a.proxy(f, this)).emulateTransitionEnd(350)[e](this.$element[0][g])
            }
        }
    }, b.prototype.hide = function() {
        if (!this.transitioning && this.$element.hasClass("in")) {
            var
                b = a.Event("hide.bs.collapse");
            if (this.$element.trigger(b), !b.isDefaultPrevented()) {
                var
                    c = this.dimension();
                this.$element[c](this.$element[c]())[0].offsetHeight, this.$element.addClass("collapsing").removeClass("collapse").removeClass("in"), this.transitioning = 1;
                var
                    d = function() {
                        this.transitioning = 0, this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")
                    };
                return a.support.transition ? (this.$element[c](0).one(a.support.transition.end, a.proxy(d, this)).emulateTransitionEnd(350), void 0) : d.call(this)
            }
        }
    }, b.prototype.toggle = function() {
        this[this.$element.hasClass("in") ? "hide" : "show"]()
    };
    var
        c = a.fn.collapse;
    a.fn.collapse = function(c) {
        return this.each(function() {
            var
                d = a(this),
                e = d.data("bs.collapse"),
                f = a.extend({}, b.DEFAULTS, d.data(), "object" == typeof c && c);
            e || d.data("bs.collapse", e = new b(this, f)), "string" == typeof
            c && e[c]()
        })
    }, a.fn.collapse.Constructor = b, a.fn.collapse.noConflict = function() {
        return a.fn.collapse = c, this
    }, a(document).on("click.bs.collapse.data-api", "[data-toggle=collapse]", function(b) {
        var
            c, d = a(this),
            e = d.attr("data-target") || b.preventDefault() || (c = d.attr("href")) && c.replace(/.*(?=#[^\s]+$)/, ""),
            f = a(e),
            g = f.data("bs.collapse"),
            h = g ? "toggle" : d.data(),
            i = d.attr("data-parent"),
            j = i && a(i);
        g && g.transitioning || (j && j.find('[data-toggle=collapse][data-parent="' + i + '"]').not(d).addClass("collapsed"), d[f.hasClass("in") ? "addClass" : "removeClass"]("collapsed")), f.collapse(h)
    })
}(window.jQuery), + function(a) {
    "use strict";

    function
    b() {
        a(d).remove(), a(e).each(function(b) {
            var
                d = c(a(this));
            d.hasClass("open") && (d.trigger(b = a.Event("hide.bs.dropdown")), b.isDefaultPrevented() || d.removeClass("open").trigger("hidden.bs.dropdown"))
        })
    }

    function
    c(b) {
        var
            c = b.attr("data-target");
        c || (c = b.attr("href"), c = c && /#/.test(c) && c.replace(/.*(?=#[^\s]*$)/, ""));
        var
            d = c && a(c);
        return d && d.length ? d : b.parent()
    }
    var
        d = ".dropdown-backdrop",
        e = "[data-toggle=dropdown]",
        f = function(b) {
            a(b).on("click.bs.dropdown", this.toggle)
        };
    f.prototype.toggle = function(d) {
        var
            e = a(this);
        if (!e.is(".disabled, :disabled")) {
            var
                f = c(e),
                g = f.hasClass("open");
            if (b(), !g) {
                if ("ontouchstart" in
                    document.documentElement && !f.closest(".navbar-nav").length && a('<div class="dropdown-backdrop"/>').insertAfter(a(this)).on("click", b), f.trigger(d = a.Event("show.bs.dropdown")), d.isDefaultPrevented()) return;
                f.toggleClass("open").trigger("shown.bs.dropdown"), e.focus()
            }
            return !1
        }
    }, f.prototype.keydown = function(b) {
        if (/(38|40|27)/.test(b.keyCode)) {
            var
                d = a(this);
            if (b.preventDefault(), b.stopPropagation(), !d.is(".disabled, :disabled")) {
                var
                    f = c(d),
                    g = f.hasClass("open");
                if (!g || g && 27 == b.keyCode) return 27 == b.which && f.find(e).focus(), d.click();
                var
                    h = a("[role=menu] li:not(.divider):visible a", f);
                if (h.length) {
                    var
                        i = h.index(h.filter(":focus"));
                    38 == b.keyCode && i > 0 && i--, 40 == b.keyCode && i < h.length - 1 && i++, ~i || (i = 0), h.eq(i).focus()
                }
            }
        }
    };
    var
        g = a.fn.dropdown;
    a.fn.dropdown = function(b) {
        return this.each(function() {
            var
                c = a(this),
                d = c.data("dropdown");
            d || c.data("dropdown", d = new f(this)), "string" == typeof
            b && d[b].call(c)
        })
    }, a.fn.dropdown.Constructor = f, a.fn.dropdown.noConflict = function() {
        return a.fn.dropdown = g, this
    }, a(document).on("click.bs.dropdown.data-api", b).on("click.bs.dropdown.data-api", ".dropdown form", function(a) {
        a.stopPropagation()
    }).on("click.bs.dropdown.data-api", e, f.prototype.toggle).on("keydown.bs.dropdown.data-api", e + ", [role=menu]", f.prototype.keydown)
}(window.jQuery), + function(a) {
    "use strict";
    var
        b = function(b, c) {
            this.options = c, this.$element = a(b), this.$backdrop = this.isShown = null, this.options.remote && this.$element.load(this.options.remote)
        };
    b.DEFAULTS = {
        backdrop: !0,
        keyboard: !0,
        show: !0
    }, b.prototype.toggle = function(a) {
        return this[this.isShown ? "hide" : "show"](a)
    }, b.prototype.show = function(b) {
        var
            c = this,
            d = a.Event("show.bs.modal", {
                relatedTarget: b
            });
        this.$element.trigger(d), this.isShown || d.isDefaultPrevented() || (this.isShown = !0, this.escape(), this.$element.on("click.dismiss.modal", '[data-dismiss="modal"]', a.proxy(this.hide, this)), this.backdrop(function() {
            var
                d = a.support.transition && c.$element.hasClass("fade");
            c.$element.parent().length || c.$element.appendTo(document.body), c.$element.show(), d && c.$element[0].offsetWidth, c.$element.addClass("in").attr("aria-hidden", !1), c.enforceFocus();
            var
                e = a.Event("shown.bs.modal", {
                    relatedTarget: b
                });
            d ? c.$element.find(".modal-dialog").one(a.support.transition.end, function() {
                c.$element.focus().trigger(e)
            }).emulateTransitionEnd(300) : c.$element.focus().trigger(e)
        }))
    }, b.prototype.hide = function(b) {
        b && b.preventDefault(), b = a.Event("hide.bs.modal"), this.$element.trigger(b), this.isShown && !b.isDefaultPrevented() && (this.isShown = !1, this.escape(), a(document).off("focusin.bs.modal"), this.$element.removeClass("in").attr("aria-hidden", !0).off("click.dismiss.modal"), a.support.transition && this.$element.hasClass("fade") ? this.$element.one(a.support.transition.end, a.proxy(this.hideModal, this)).emulateTransitionEnd(300) : this.hideModal())
    }, b.prototype.enforceFocus = function() {
        a(document).off("focusin.bs.modal").on("focusin.bs.modal", a.proxy(function(a) {
            this.$element[0] === a.target || this.$element.has(a.target).length || this.$element.focus()
        }, this))
    }, b.prototype.escape = function() {
        this.isShown && this.options.keyboard ? this.$element.on("keyup.dismiss.bs.modal", a.proxy(function(a) {
            27 == a.which && this.hide()
        }, this)) : this.isShown || this.$element.off("keyup.dismiss.bs.modal")
    }, b.prototype.hideModal = function() {
        var
            a = this;
        this.$element.hide(), this.backdrop(function() {
            a.removeBackdrop(), a.$element.trigger("hidden.bs.modal")
        })
    }, b.prototype.removeBackdrop = function() {
        this.$backdrop && this.$backdrop.remove(), this.$backdrop = null
    }, b.prototype.backdrop = function(b) {
        var
            c = this.$element.hasClass("fade") ? "fade" : "";
        if (this.isShown && this.options.backdrop) {
            var
                d = a.support.transition && c;
            if (this.$backdrop = a('<div class="modal-backdrop ' + c + '" />').appendTo(document.body), this.$element.on("click.dismiss.modal", a.proxy(function(a) {
                    a.target === a.currentTarget && ("static" == this.options.backdrop ? this.$element[0].focus.call(this.$element[0]) : this.hide.call(this))
                }, this)), d && this.$backdrop[0].offsetWidth, this.$backdrop.addClass("in"), !b) return;
            d ? this.$backdrop.one(a.support.transition.end, b).emulateTransitionEnd(150) : b()
        } else !this.isShown && this.$backdrop ? (this.$backdrop.removeClass("in"), a.support.transition && this.$element.hasClass("fade") ? this.$backdrop.one(a.support.transition.end, b).emulateTransitionEnd(150) : b()) : b && b()
    };
    var
        c = a.fn.modal;
    a.fn.modal = function(c, d) {
        return this.each(function() {
            var
                e = a(this),
                f = e.data("bs.modal"),
                g = a.extend({}, b.DEFAULTS, e.data(), "object" == typeof c && c);
            f || e.data("bs.modal", f = new b(this, g)), "string" == typeof
            c ? f[c](d) : g.show && f.show(d)
        })
    }, a.fn.modal.Constructor = b, a.fn.modal.noConflict = function() {
        return a.fn.modal = c, this
    }, a(document).on("click.bs.modal.data-api", '[data-toggle="modal"]', function(b) {
        var
            c = a(this),
            d = c.attr("href"),
            e = a(c.attr("data-target") || d && d.replace(/.*(?=#[^\s]+$)/, "")),
            f = e.data("modal") ? "toggle" : a.extend({
                remote: !/#/.test(d) && d
            }, e.data(), c.data());
        b.preventDefault(), e.modal(f, this).one("hide", function() {
            c.is(":visible") && c.focus()
        })
    }), a(document).on("show.bs.modal", ".modal", function() {
        a(document.body).addClass("modal-open")
    }).on("hidden.bs.modal", ".modal", function() {
        a(document.body).removeClass("modal-open")
    })
}(window.jQuery), + function(a) {
    "use strict";
    var
        b = function(a, b) {
            this.type = this.options = this.enabled = this.timeout = this.hoverState = this.$element = null, this.init("tooltip", a, b)
        };
    b.DEFAULTS = {
        animation: !0,
        placement: "top",
        selector: !1,
        template: '<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',
        trigger: "hover focus",
        title: "",
        delay: 0,
        html: !1,
        container: !1
    }, b.prototype.init = function(b, c, d) {
        this.enabled = !0, this.type = b, this.$element = a(c), this.options = this.getOptions(d);
        for (var
                e = this.options.trigger.split(" "), f = e.length; f--;) {
            var
                g = e[f];
            if ("click" == g) this.$element.on("click." + this.type, this.options.selector, a.proxy(this.toggle, this));
            else
            if ("manual" != g) {
                var
                    h = "hover" == g ? "mouseenter" : "focus",
                    i = "hover" == g ? "mouseleave" : "blur";
                this.$element.on(h + "." + this.type, this.options.selector, a.proxy(this.enter, this)), this.$element.on(i + "." + this.type, this.options.selector, a.proxy(this.leave, this))
            }
        }
        this.options.selector ? this._options = a.extend({}, this.options, {
            trigger: "manual",
            selector: ""
        }) : this.fixTitle()
    }, b.prototype.getDefaults = function() {
        return b.DEFAULTS
    }, b.prototype.getOptions = function(b) {
        return b = a.extend({}, this.getDefaults(), this.$element.data(), b), b.delay && "number" == typeof
        b.delay && (b.delay = {
            show: b.delay,
            hide: b.delay
        }), b
    }, b.prototype.getDelegateOptions = function() {
        var
            b = {},
            c = this.getDefaults();
        return this._options && a.each(this._options, function(a, d) {
            c[a] != d && (b[a] = d)
        }), b
    }, b.prototype.enter = function(b) {
        var
            c = b
        instanceof
        this.constructor ? b : a(b.currentTarget)[this.type](this.getDelegateOptions()).data("bs." + this.type);
        return clearTimeout(c.timeout), c.hoverState = "in", c.options.delay && c.options.delay.show ? (c.timeout = setTimeout(function() {
            "in" == c.hoverState && c.show()
        }, c.options.delay.show), void 0) : c.show()
    }, b.prototype.leave = function(b) {
        var
            c = b
        instanceof
        this.constructor ? b : a(b.currentTarget)[this.type](this.getDelegateOptions()).data("bs." + this.type);
        return clearTimeout(c.timeout), c.hoverState = "out", c.options.delay && c.options.delay.hide ? (c.timeout = setTimeout(function() {
            "out" == c.hoverState && c.hide()
        }, c.options.delay.hide), void 0) : c.hide()
    }, b.prototype.show = function() {
        var
            b = a.Event("show.bs." + this.type);
        if (this.hasContent() && this.enabled) {
            if (this.$element.trigger(b), b.isDefaultPrevented()) return;
            var
                c = this.tip();
            this.setContent(), this.options.animation && c.addClass("fade");
            var
                d = "function" == typeof
            this.options.placement ? this.options.placement.call(this, c[0], this.$element[0]) : this.options.placement, e = /\s?auto?\s?/i, f = e.test(d);
            f && (d = d.replace(e, "") || "top"), c.detach().css({
                top: 0,
                left: 0,
                display: "block"
            }).addClass(d), this.options.container ? c.appendTo(this.options.container) : c.insertAfter(this.$element);
            var
                g = this.getPosition(),
                h = c[0].offsetWidth,
                i = c[0].offsetHeight;
            if (f) {
                var
                    j = this.$element.parent(),
                    k = d,
                    l = document.documentElement.scrollTop || document.body.scrollTop,
                    m = "body" == this.options.container ? window.innerWidth : j.outerWidth(),
                    n = "body" == this.options.container ? window.innerHeight : j.outerHeight(),
                    o = "body" == this.options.container ? 0 : j.offset().left;
                d = "bottom" == d && g.top + g.height + i - l > n ? "top" : "top" == d && g.top - l - i < 0 ? "bottom" : "right" == d && g.right + h > m ? "left" : "left" == d && g.left - h < o ? "right" : d, c.removeClass(k).addClass(d)
            }
            var
                p = this.getCalculatedOffset(d, g, h, i);
            this.applyPlacement(p, d), this.$element.trigger("shown.bs." + this.type)
        }
    }, b.prototype.applyPlacement = function(a, b) {
        var
            c, d = this.tip(),
            e = d[0].offsetWidth,
            f = d[0].offsetHeight,
            g = parseInt(d.css("margin-top"), 10),
            h = parseInt(d.css("margin-left"), 10);
        isNaN(g) && (g = 0), isNaN(h) && (h = 0), a.top = a.top + g, a.left = a.left + h, d.offset(a).addClass("in");
        var
            i = d[0].offsetWidth,
            j = d[0].offsetHeight;
        if ("top" == b && j != f && (c = !0, a.top = a.top + f - j), /bottom|top/.test(b)) {
            var
                k = 0;
            a.left < 0 && (k = -2 * a.left, a.left = 0, d.offset(a), i = d[0].offsetWidth, j = d[0].offsetHeight), this.replaceArrow(k - e + i, i, "left")
        } else
            this.replaceArrow(j - f, j, "top");
        c && d.offset(a)
    }, b.prototype.replaceArrow = function(a, b, c) {
        this.arrow().css(c, a ? 50 * (1 - a / b) + "%" : "")
    }, b.prototype.setContent = function() {
        var
            a = this.tip(),
            b = this.getTitle();
        a.find(".tooltip-inner")[this.options.html ? "html" : "text"](b), a.removeClass("fade in top bottom left right")
    }, b.prototype.hide = function() {
        function
        b() {
            "in" != c.hoverState && d.detach()
        }
        var
            c = this,
            d = this.tip(),
            e = a.Event("hide.bs." + this.type);
        return this.$element.trigger(e), e.isDefaultPrevented() ? void
        0: (d.removeClass("in"), a.support.transition && this.$tip.hasClass("fade") ? d.one(a.support.transition.end, b).emulateTransitionEnd(150) : b(), this.$element.trigger("hidden.bs." + this.type), this)
    }, b.prototype.fixTitle = function() {
        var
            a = this.$element;
        (a.attr("title") || "string" != typeof a.attr("data-original-title")) && a.attr("data-original-title", a.attr("title") || "").attr("title", "")
    }, b.prototype.hasContent = function() {
        return this.getTitle()
    }, b.prototype.getPosition = function() {
        var
            b = this.$element[0];
        return a.extend({}, "function" == typeof b.getBoundingClientRect ? b.getBoundingClientRect() : {
            width: b.offsetWidth,
            height: b.offsetHeight
        }, this.$element.offset())
    }, b.prototype.getCalculatedOffset = function(a, b, c, d) {
        return "bottom" == a ? {
            top: b.top + b.height,
            left: b.left + b.width / 2 - c / 2
        } : "top" == a ? {
            top: b.top - d,
            left: b.left + b.width / 2 - c / 2
        } : "left" == a ? {
            top: b.top + b.height / 2 - d / 2,
            left: b.left - c
        } : {
            top: b.top + b.height / 2 - d / 2,
            left: b.left + b.width
        }
    }, b.prototype.getTitle = function() {
        var
            a, b = this.$element,
            c = this.options;
        return a = b.attr("data-original-title") || ("function" == typeof c.title ? c.title.call(b[0]) : c.title)
    }, b.prototype.tip = function() {
        return this.$tip = this.$tip || a(this.options.template)
    }, b.prototype.arrow = function() {
        return this.$arrow = this.$arrow || this.tip().find(".tooltip-arrow")
    }, b.prototype.validate = function() {
        this.$element[0].parentNode || (this.hide(), this.$element = null, this.options = null)
    }, b.prototype.enable = function() {
        this.enabled = !0
    }, b.prototype.disable = function() {
        this.enabled = !1
    }, b.prototype.toggleEnabled = function() {
        this.enabled = !this.enabled
    }, b.prototype.toggle = function(b) {
        var
            c = b ? a(b.currentTarget)[this.type](this.getDelegateOptions()).data("bs." + this.type) : this;
        c.tip().hasClass("in") ? c.leave(c) : c.enter(c)
    }, b.prototype.destroy = function() {
        this.hide().$element.off("." + this.type).removeData("bs." + this.type)
    };
    var
        c = a.fn.tooltip;
    a.fn.tooltip = function(c) {
        return this.each(function() {
            var
                d = a(this),
                e = d.data("bs.tooltip"),
                f = "object" == typeof
            c && c;
            e || d.data("bs.tooltip", e = new b(this, f)), "string" == typeof
            c && e[c]()
        })
    }, a.fn.tooltip.Constructor = b, a.fn.tooltip.noConflict = function() {
        return a.fn.tooltip = c, this
    }
}(window.jQuery), + function(a) {
    "use strict";
    var
        b = function(a, b) {
            this.init("popover", a, b)
        };
    if (!a.fn.tooltip) throw new
    Error("Popover requires tooltip.js");
    b.DEFAULTS = a.extend({}, a.fn.tooltip.Constructor.DEFAULTS, {
        placement: "right",
        trigger: "click",
        content: "",
        template: '<div class="popover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'
    }), b.prototype = a.extend({}, a.fn.tooltip.Constructor.prototype), b.prototype.constructor = b, b.prototype.getDefaults = function() {
        return b.DEFAULTS
    }, b.prototype.setContent = function() {
        var
            a = this.tip(),
            b = this.getTitle(),
            c = this.getContent();
        a.find(".popover-title")[this.options.html ? "html" : "text"](b), a.find(".popover-content")[this.options.html ? "html" : "text"](c), a.removeClass("fade top bottom left right in"), a.find(".popover-title").html() || a.find(".popover-title").hide()
    }, b.prototype.hasContent = function() {
        return this.getTitle() || this.getContent()
    }, b.prototype.getContent = function() {
        var
            a = this.$element,
            b = this.options;
        return a.attr("data-content") || ("function" == typeof b.content ? b.content.call(a[0]) : b.content)
    }, b.prototype.arrow = function() {
        return this.$arrow = this.$arrow || this.tip().find(".arrow")
    }, b.prototype.tip = function() {
        return this.$tip || (this.$tip = a(this.options.template)), this.$tip
    };
    var
        c = a.fn.popover;
    a.fn.popover = function(c) {
        return this.each(function() {
            var
                d = a(this),
                e = d.data("bs.popover"),
                f = "object" == typeof
            c && c;
            e || d.data("bs.popover", e = new b(this, f)), "string" == typeof
            c && e[c]()
        })
    }, a.fn.popover.Constructor = b, a.fn.popover.noConflict = function() {
        return a.fn.popover = c, this
    }
}(window.jQuery), + function(a) {
    "use strict";

    function
    b(c, d) {
        var
            e, f = a.proxy(this.process, this);
        this.$element = a(c).is("body") ? a(window) : a(c), this.$body = a("body"), this.$scrollElement = this.$element.on("scroll.bs.scroll-spy.data-api", f), this.options = a.extend({}, b.DEFAULTS, d), this.selector = (this.options.target || (e = a(c).attr("href")) && e.replace(/.*(?=#[^\s]+$)/, "") || "") + " .nav li > a", this.offsets = a([]), this.targets = a([]), this.activeTarget = null, this.refresh(), this.process()
    }
    b.DEFAULTS = {
        offset: 10
    }, b.prototype.refresh = function() {
        var
            b = this.$element[0] == window ? "offset" : "position";
        this.offsets = a([]), this.targets = a([]);
        var
            c = this;
        this.$body.find(this.selector).map(function() {
            var
                d = a(this),
                e = d.data("target") || d.attr("href"),
                f = /^#\w/.test(e) && a(e);
            return f && f.length && [
                [f[b]().top + (!a.isWindow(c.$scrollElement.get(0)) && c.$scrollElement.scrollTop()), e]
            ] || null
        }).sort(function(a, b) {
            return a[0] - b[0]
        }).each(function() {
            c.offsets.push(this[0]), c.targets.push(this[1])
        })
    }, b.prototype.process = function() {
        var
            a, b = this.$scrollElement.scrollTop() + this.options.offset,
            c = this.$scrollElement[0].scrollHeight || this.$body[0].scrollHeight,
            d = c - this.$scrollElement.height(),
            e = this.offsets,
            f = this.targets,
            g = this.activeTarget;
        if (b >= d) return g != (a = f.last()[0]) && this.activate(a);
        for (a = e.length; a--;) g != f[a] && b >= e[a] && (!e[a + 1] || b <= e[a + 1]) && this.activate(f[a])
    }, b.prototype.activate = function(b) {
        this.activeTarget = b, a(this.selector).parents(".active").removeClass("active");
        var
            c = this.selector + '[data-target="' + b + '"],' + this.selector + '[href="' + b + '"]',
            d = a(c).parents("li").addClass("active");
        d.parent(".dropdown-menu").length && (d = d.closest("li.dropdown").addClass("active")), d.trigger("activate")
    };
    var
        c = a.fn.scrollspy;
    a.fn.scrollspy = function(c) {
        return this.each(function() {
            var
                d = a(this),
                e = d.data("bs.scrollspy"),
                f = "object" == typeof
            c && c;
            e || d.data("bs.scrollspy", e = new b(this, f)), "string" == typeof
            c && e[c]()
        })
    }, a.fn.scrollspy.Constructor = b, a.fn.scrollspy.noConflict = function() {
        return a.fn.scrollspy = c, this
    }, a(window).on("load", function() {
        a('[data-spy="scroll"]').each(function() {
            var
                b = a(this);
            b.scrollspy(b.data())
        })
    })
}(window.jQuery), + function(a) {
    "use strict";
    var
        b = function(b) {
            this.element = a(b)
        };
    b.prototype.show = function() {
        var
            b = this.element,
            c = b.closest("ul:not(.dropdown-menu)"),
            d = b.attr("data-target");
        if (d || (d = b.attr("href"), d = d && d.replace(/.*(?=#[^\s]*$)/, "")), !b.parent("li").hasClass("active")) {
            var
                e = c.find(".active:last a")[0],
                f = a.Event("show.bs.tab", {
                    relatedTarget: e
                });
            if (b.trigger(f), !f.isDefaultPrevented()) {
                var
                    g = a(d);
                this.activate(b.parent("li"), c), this.activate(g, g.parent(), function() {
                    b.trigger({
                        type: "shown.bs.tab",
                        relatedTarget: e
                    })
                })
            }
        }
    }, b.prototype.activate = function(b, c, d) {
        function
        e() {
            f.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"), b.addClass("active"), g ? (b[0].offsetWidth, b.addClass("in")) : b.removeClass("fade"), b.parent(".dropdown-menu") && b.closest("li.dropdown").addClass("active"), d && d()
        }
        var
            f = c.find("> .active"),
            g = d && a.support.transition && f.hasClass("fade");
        g ? f.one(a.support.transition.end, e).emulateTransitionEnd(150) : e(), f.removeClass("in")
    };
    var
        c = a.fn.tab;
    a.fn.tab = function(c) {
        return this.each(function() {
            var
                d = a(this),
                e = d.data("bs.tab");
            e || d.data("bs.tab", e = new b(this)), "string" == typeof
            c && e[c]()
        })
    }, a.fn.tab.Constructor = b, a.fn.tab.noConflict = function() {
        return a.fn.tab = c, this
    }, a(document).on("click.bs.tab.data-api", '[data-toggle="tab"], [data-toggle="pill"]', function(b) {
        b.preventDefault(), a(this).tab("show")
    })
}(window.jQuery), + function(a) {
    "use strict";
    var
        b = function(c, d) {
            this.options = a.extend({}, b.DEFAULTS, d), this.$window = a(window).on("scroll.bs.affix.data-api", a.proxy(this.checkPosition, this)).on("click.bs.affix.data-api", a.proxy(this.checkPositionWithEventLoop, this)), this.$element = a(c), this.affixed = this.unpin = null, this.checkPosition()
        };
    b.RESET = "affix affix-top affix-bottom", b.DEFAULTS = {
        offset: 0
    }, b.prototype.checkPositionWithEventLoop = function() {
        setTimeout(a.proxy(this.checkPosition, this), 1)
    }, b.prototype.checkPosition = function() {
        if (this.$element.is(":visible")) {
            var
                c = a(document).height(),
                d = this.$window.scrollTop(),
                e = this.$element.offset(),
                f = this.options.offset,
                g = f.top,
                h = f.bottom;
            "object" != typeof
            f && (h = g = f), "function" == typeof
            g && (g = f.top()), "function" == typeof
            h && (h = f.bottom());
            var
                i = null != this.unpin && d + this.unpin <= e.top ? !1 : null != h && e.top + this.$element.height() >= c - h ? "bottom" : null != g && g >= d ? "top" : !1;
            this.affixed !== i && (this.unpin && this.$element.css("top", ""), this.affixed = i, this.unpin = "bottom" == i ? e.top - d : null, this.$element.removeClass(b.RESET).addClass("affix" + (i ? "-" + i : "")), "bottom" == i && this.$element.offset({
                top: document.body.offsetHeight - h - this.$element.height()
            }))
        }
    };
    var
        c = a.fn.affix;
    a.fn.affix = function(c) {
        return this.each(function() {
            var
                d = a(this),
                e = d.data("bs.affix"),
                f = "object" == typeof
            c && c;
            e || d.data("bs.affix", e = new b(this, f)), "string" == typeof
            c && e[c]()
        })
    }, a.fn.affix.Constructor = b, a.fn.affix.noConflict = function() {
        return a.fn.affix = c, this
    }, a(window).on("load", function() {
        a('[data-spy="affix"]').each(function() {
            var
                b = a(this),
                c = b.data();
            c.offset = c.offset || {}, c.offsetBottom && (c.offset.bottom = c.offsetBottom), c.offsetTop && (c.offset.top = c.offsetTop), b.affix(c)
        })
    })
}(window.jQuery);
(function($) {
    'use strict';
    $.expr[':'].icontains = function(obj, index, meta) {
        return icontains($(obj).text(), meta[3]);
    };
    $.expr[':'].aicontains = function(obj, index, meta) {
        return icontains($(obj).data('normalizedText') || $(obj).text(), meta[3]);
    };

    function
    icontains(haystack, needle) {
        return haystack.toUpperCase().indexOf(needle.toUpperCase()) > -1;
    }

    function
    normalizeToBase(text) {
        var
            rExps = [{
                re: /[\xC0-\xC6]/g,
                ch: "A"
            }, {
                re: /[\xE0-\xE6]/g,
                ch: "a"
            }, {
                re: /[\xC8-\xCB]/g,
                ch: "E"
            }, {
                re: /[\xE8-\xEB]/g,
                ch: "e"
            }, {
                re: /[\xCC-\xCF]/g,
                ch: "I"
            }, {
                re: /[\xEC-\xEF]/g,
                ch: "i"
            }, {
                re: /[\xD2-\xD6]/g,
                ch: "O"
            }, {
                re: /[\xF2-\xF6]/g,
                ch: "o"
            }, {
                re: /[\xD9-\xDC]/g,
                ch: "U"
            }, {
                re: /[\xF9-\xFC]/g,
                ch: "u"
            }, {
                re: /[\xC7-\xE7]/g,
                ch: "c"
            }, {
                re: /[\xD1]/g,
                ch: "N"
            }, {
                re: /[\xF1]/g,
                ch: "n"
            }];
        $.each(rExps, function() {
            text = text.replace(this.re, this.ch);
        });
        return text;
    }
    var
        Selectpicker = function(element, options, e) {
            if (e) {
                e.stopPropagation();
                e.preventDefault();
            }
            this.$element = $(element);
            this.$newElement = null;
            this.$button = null;
            this.$menu = null;
            this.$lis = null;
            this.options = options;
            if (this.options.title === null) {
                this.options.title = this.$element.attr('title');
            }
            this.val = Selectpicker.prototype.val;
            this.render = Selectpicker.prototype.render;
            this.refresh = Selectpicker.prototype.refresh;
            this.setStyle = Selectpicker.prototype.setStyle;
            this.selectAll = Selectpicker.prototype.selectAll;
            this.deselectAll = Selectpicker.prototype.deselectAll;
            this.destroy = Selectpicker.prototype.remove;
            this.remove = Selectpicker.prototype.remove;
            this.show = Selectpicker.prototype.show;
            this.hide = Selectpicker.prototype.hide;
            this.init();
        };
    Selectpicker.VERSION = '1.6.2';
    Selectpicker.DEFAULTS = {
        noneSelectedText: 'Nothing selected',
        noneResultsText: 'No results match',
        countSelectedText: function(numSelected, numTotal) {
            return (numSelected == 1) ? "{0} item selected" : "{0} items selected";
        },
        maxOptionsText: function(numAll, numGroup) {
            var
                arr = [];
            arr[0] = (numAll == 1) ? 'Limit reached ({n} item max)' : 'Limit reached ({n} items max)';
            arr[1] = (numGroup == 1) ? 'Group limit reached ({n} item max)' : 'Group limit reached ({n} items max)';
            return arr;
        },
        selectAllText: 'Select All',
        deselectAllText: 'Deselect All',
        multipleSeparator: ', ',
        style: 'btn-default',
        size: 'auto',
        title: null,
        selectedTextFormat: 'values',
        width: false,
        container: false,
        hideDisabled: false,
        showSubtext: false,
        showIcon: true,
        showContent: true,
        dropupAuto: true,
        header: false,
        liveSearch: false,
        actionsBox: false,
        iconBase: 'glyphicon',
        tickIcon: 'glyphicon-ok',
        maxOptions: false,
        mobile: false,
        selectOnTab: false,
        dropdownAlignRight: false,
        searchAccentInsensitive: false
    };
    Selectpicker.prototype = {
        constructor: Selectpicker,
        init: function() {
            var
                that = this,
                id = this.$element.attr('id');
            this.$element.hide();
            this.multiple = this.$element.prop('multiple');
            this.autofocus = this.$element.prop('autofocus');
            this.$newElement = this.createView();
            this.$element.after(this.$newElement);
            this.$menu = this.$newElement.find('> .dropdown-menu');
            this.$button = this.$newElement.find('> button');
            this.$searchbox = this.$newElement.find('input');
            if (this.options.dropdownAlignRight) this.$menu.addClass('dropdown-menu-right');
            if (typeof id !== 'undefined') {
                this.$button.attr('data-id', id);
                $('label[for="' + id + '"]').click(function(e) {
                    e.preventDefault();
                    that.$button.focus();
                });
            }
            this.checkDisabled();
            this.clickListener();
            if (this.options.liveSearch) this.liveSearchListener();
            this.render();
            this.liHeight();
            this.setStyle();
            this.setWidth();
            if (this.options.container) this.selectPosition();
            this.$menu.data('this', this);
            this.$newElement.data('this', this);
            if (this.options.mobile) this.mobile();
        },
        createDropdown: function() {
            var
                multiple = this.multiple ? ' show-tick' : '',
                inputGroup = this.$element.parent().hasClass('input-group') ? ' input-group-btn' : '',
                autofocus = this.autofocus ? ' autofocus' : '',
                btnSize = this.$element.parents().hasClass('form-group-lg') ? ' btn-lg' : (this.$element.parents().hasClass('form-group-sm') ? ' btn-sm' : '');
            var
                header = this.options.header ? '<div class="popover-title"><button type="button" class="close" aria-hidden="true">&times;</button>' + this.options.header + '</div>' : '';
            var
                searchbox = this.options.liveSearch ? '<div class="bs-searchbox"><input type="text" class="input-block-level form-control" autocomplete="off" /></div>' : '';
            var
                actionsbox = this.options.actionsBox ? '<div class="bs-actionsbox">' + '<div class="btn-group btn-block">' + '<button class="actions-btn bs-select-all btn btn-sm btn-default">' + this.options.selectAllText + '</button>' + '<button class="actions-btn bs-deselect-all btn btn-sm btn-default">' + this.options.deselectAllText + '</button>' + '</div>' + '</div>' : '';
            var
                drop = '<div class="btn-group bootstrap-select' + multiple + inputGroup + '">' + '<button type="button" class="btn dropdown-toggle selectpicker' + btnSize + '" data-toggle="dropdown"' + autofocus + '>' + '<span class="filter-option pull-left"></span>&nbsp;' + '<span class="caret"></span>' + '</button>' + '<div class="dropdown-menu open">' + header + searchbox + actionsbox + '<ul class="dropdown-menu inner selectpicker" role="menu">' + '</ul>' + '</div>' + '</div>';
            return $(drop);
        },
        createView: function() {
            var
                $drop = this.createDropdown();
            var
                $li = this.createLi();
            $drop.find('ul').append($li);
            return $drop;
        },
        reloadLi: function() {
            this.destroyLi();
            var
                $li = this.createLi();
            this.$menu.find('ul').append($li);
        },
        destroyLi: function() {
            this.$menu.find('li').remove();
        },
        createLi: function() {
            var
                that = this,
                _li = [],
                optID = 0;
            var
                generateLI = function(content, index, classes) {
                    return '<li' + (typeof classes !== 'undefined' ? ' class="' + classes + '"' : '') + (typeof index !== 'undefined' | null === index ? ' data-original-index="' + index + '"' : '') + '>' + content + '</li>';
                };
            var
                generateA = function(text, classes, inline, optgroup) {
                    var
                        normText = normalizeToBase($.trim($("<div/>").html(text).text()).replace(/\s\s+/g, ' '));
                    return '<a tabindex="0"' + (typeof classes !== 'undefined' ? ' class="' + classes + '"' : '') + (typeof inline !== 'undefined' ? ' style="' + inline + '"' : '') + (typeof optgroup !== 'undefined' ? 'data-optgroup="' + optgroup + '"' : '') + ' data-normalized-text="' + normText + '"' + '>' + text + '<span class="' + that.options.iconBase + ' ' + that.options.tickIcon + ' check-mark"></span>' + '</a>';
                };
            this.$element.find('option').each(function() {
                var
                    $this = $(this);
                var
                    optionClass = $this.attr('class') || '',
                    inline = $this.attr('style'),
                    text = $this.data('content') ? $this.data('content') : $this.html(),
                    subtext = typeof
                $this.data('subtext') !== 'undefined' ? '<small class="muted text-muted">' + $this.data('subtext') + '</small>' : '', icon = typeof
                $this.data('icon') !== 'undefined' ? '<span class="' + that.options.iconBase + ' ' + $this.data('icon') + '"></span> ' : '', isDisabled = $this.is(':disabled') || $this.parent().is(':disabled'), index = $this[0].index;
                if (icon !== '' && isDisabled) {
                    icon = '<span>' + icon + '</span>';
                }
                if (!$this.data('content')) {
                    text = icon + '<span class="text">' + text + subtext + '</span>';
                }
                if (that.options.hideDisabled && isDisabled) {
                    return;
                }
                if ($this.parent().is('optgroup') && $this.data('divider') !== true) {
                    if ($this.index() === 0) {
                        optID += 1;
                        var
                            label = $this.parent().attr('label');
                        var
                            labelSubtext = typeof
                        $this.parent().data('subtext') !== 'undefined' ? '<small class="muted text-muted">' + $this.parent().data('subtext') + '</small>' : '';
                        var
                            labelIcon = $this.parent().data('icon') ? '<span class="' + that.options.iconBase + ' ' + $this.parent().data('icon') + '"></span> ' : '';
                        label = labelIcon + '<span class="text">' + label + labelSubtext + '</span>';
                        if (index !== 0 && _li.length > 0) {
                            _li.push(generateLI('', null, 'divider'));
                        }
                        _li.push(generateLI(label, null, 'dropdown-header'));
                    }
                    _li.push(generateLI(generateA(text, 'opt ' + optionClass, inline, optID), index));
                } else
                if ($this.data('divider') === true) {
                    _li.push(generateLI('', index, 'divider'));
                } else
                if ($this.data('hidden') === true) {
                    _li.push(generateLI(generateA(text, optionClass, inline), index, 'hide is-hidden'));
                } else {
                    _li.push(generateLI(generateA(text, optionClass, inline), index));
                }
            });
            if (!this.multiple && this.$element.find('option:selected').length === 0 && !this.options.title) {
                this.$element.find('option').eq(0).prop('selected', true).attr('selected', 'selected');
            }
            return $(_li.join(''));
        },
        findLis: function() {
            if (this.$lis == null) this.$lis = this.$menu.find('li');
            return this.$lis;
        },
        render: function(updateLi) {
            var
                that = this;
            if (updateLi !== false) {
                this.$element.find('option').each(function(index) {
                    that.setDisabled(index, $(this).is(':disabled') || $(this).parent().is(':disabled'));
                    that.setSelected(index, $(this).is(':selected'));
                });
            }
            this.tabIndex();
            var
                notDisabled = this.options.hideDisabled ? ':not([disabled])' : '';
            var
                selectedItems = this.$element.find('option:selected' + notDisabled).map(function() {
                    var
                        $this = $(this);
                    var
                        icon = $this.data('icon') && that.options.showIcon ? '<i class="' + that.options.iconBase + ' ' + $this.data('icon') + '"></i> ' : '';
                    var
                        subtext;
                    if (that.options.showSubtext && $this.attr('data-subtext') && !that.multiple) {
                        subtext = ' <small class="muted text-muted">' + $this.data('subtext') + '</small>';
                    } else {
                        subtext = '';
                    }
                    if ($this.data('content') && that.options.showContent) {
                        return $this.data('content');
                    } else
                    if (typeof $this.attr('title') !== 'undefined') {
                        return $this.attr('title');
                    } else {
                        return icon + $this.html() + subtext;
                    }
                }).toArray();
            var
                title = !this.multiple ? selectedItems[0] : selectedItems.join(this.options.multipleSeparator);
            if (this.multiple && this.options.selectedTextFormat.indexOf('count') > -1) {
                var
                    max = this.options.selectedTextFormat.split('>');
                if ((max.length > 1 && selectedItems.length > max[1]) || (max.length == 1 && selectedItems.length >= 2)) {
                    notDisabled = this.options.hideDisabled ? ', [disabled]' : '';
                    var
                        totalCount = this.$element.find('option').not('[data-divider="true"], [data-hidden="true"]' + notDisabled).length,
                        tr8nText = (typeof this.options.countSelectedText === 'function') ? this.options.countSelectedText(selectedItems.length, totalCount) : this.options.countSelectedText;
                    title = tr8nText.replace('{0}', selectedItems.length.toString()).replace('{1}', totalCount.toString());
                }
            }
            this.options.title = this.$element.attr('title');
            if (this.options.selectedTextFormat == 'static') {
                title = this.options.title;
            }
            if (!title) {
                title = typeof
                this.options.title !== 'undefined' ? this.options.title : this.options.noneSelectedText;
            }
            this.$button.attr('title', $.trim($("<div/>").html(title).text()).replace(/\s\s+/g, ' '));
            this.$newElement.find('.filter-option').html(title);
        },
        setStyle: function(style, status) {
            if (this.$element.attr('class')) {
                this.$newElement.addClass(this.$element.attr('class').replace(/selectpicker|mobile-device|validate\[.*\]/gi, ''));
            }
            var
                buttonClass = style ? style : this.options.style;
            if (status == 'add') {
                this.$button.addClass(buttonClass);
            } else
            if (status == 'remove') {
                this.$button.removeClass(buttonClass);
            } else {
                this.$button.removeClass(this.options.style);
                this.$button.addClass(buttonClass);
            }
        },
        liHeight: function() {
            if (this.options.size === false) return;
            var
                $selectClone = this.$menu.parent().clone().find('> .dropdown-toggle').prop('autofocus', false).end().appendTo('body'),
                $menuClone = $selectClone.addClass('open').find('> .dropdown-menu'),
                liHeight = $menuClone.find('li').not('.divider').not('.dropdown-header').filter(':visible').children('a').outerHeight(),
                headerHeight = this.options.header ? $menuClone.find('.popover-title').outerHeight() : 0,
                searchHeight = this.options.liveSearch ? $menuClone.find('.bs-searchbox').outerHeight() : 0,
                actionsHeight = this.options.actionsBox ? $menuClone.find('.bs-actionsbox').outerHeight() : 0;
            $selectClone.remove();
            this.$newElement.data('liHeight', liHeight).data('headerHeight', headerHeight).data('searchHeight', searchHeight).data('actionsHeight', actionsHeight);
        },
        setSize: function() {
            this.findLis();
            var
                that = this,
                menu = this.$menu,
                menuInner = menu.find('.inner'),
                selectHeight = this.$newElement.outerHeight(),
                liHeight = this.$newElement.data('liHeight'),
                headerHeight = this.$newElement.data('headerHeight'),
                searchHeight = this.$newElement.data('searchHeight'),
                actionsHeight = this.$newElement.data('actionsHeight'),
                divHeight = this.$lis.filter('.divider').outerHeight(true),
                menuPadding = parseInt(menu.css('padding-top')) + parseInt(menu.css('padding-bottom')) + parseInt(menu.css('border-top-width')) + parseInt(menu.css('border-bottom-width')),
                notDisabled = this.options.hideDisabled ? ', .disabled' : '',
                $window = $(window),
                menuExtras = menuPadding + parseInt(menu.css('margin-top')) + parseInt(menu.css('margin-bottom')) + 2,
                menuHeight, selectOffsetTop, selectOffsetBot, posVert = function() {
                    selectOffsetTop = that.$newElement.offset().top - $window.scrollTop();
                    selectOffsetBot = $window.height() - selectOffsetTop - selectHeight;
                };
            posVert();
            if (this.options.header) menu.css('padding-top', 0);
            if (this.options.size == 'auto') {
                var
                    getSize = function() {
                        var
                            minHeight, lisVis = that.$lis.not('.hide');
                        posVert();
                        menuHeight = selectOffsetBot - menuExtras;
                        if (that.options.dropupAuto) {
                            that.$newElement.toggleClass('dropup', (selectOffsetTop > selectOffsetBot) && ((menuHeight - menuExtras) < menu.height()));
                        }
                        if (that.$newElement.hasClass('dropup')) {
                            menuHeight = selectOffsetTop - menuExtras;
                        }
                        if ((lisVis.length + lisVis.filter('.dropdown-header').length) > 3) {
                            minHeight = liHeight * 3 + menuExtras - 2;
                        } else {
                            minHeight = 0;
                        }
                        menu.css({
                            'max-height': menuHeight + 'px',
                            'overflow': 'hidden',
                            'min-height': minHeight + headerHeight + searchHeight + actionsHeight + 'px'
                        });
                        menuInner.css({
                            'max-height': menuHeight - headerHeight - searchHeight - actionsHeight - menuPadding + 'px',
                            'overflow-y': 'auto',
                            'min-height': Math.max(minHeight - menuPadding, 0) + 'px'
                        });
                    };
                getSize();
                this.$searchbox.off('input.getSize propertychange.getSize').on('input.getSize propertychange.getSize', getSize);
                $(window).off('resize.getSize').on('resize.getSize', getSize);
                $(window).off('scroll.getSize').on('scroll.getSize', getSize);
            } else
            if (this.options.size && this.options.size != 'auto' && menu.find('li' + notDisabled).length > this.options.size) {
                var
                    optIndex = this.$lis.not('.divider' + notDisabled).find(' > *').slice(0, this.options.size).last().parent().index();
                var
                    divLength = this.$lis.slice(0, optIndex + 1).filter('.divider').length;
                menuHeight = liHeight * this.options.size + divLength * divHeight + menuPadding;
                if (that.options.dropupAuto) {
                    this.$newElement.toggleClass('dropup', (selectOffsetTop > selectOffsetBot) && (menuHeight < menu.height()));
                }
                menu.css({
                    'max-height': menuHeight + headerHeight + searchHeight + actionsHeight + 'px',
                    'overflow': 'hidden'
                });
                menuInner.css({
                    'max-height': menuHeight - menuPadding + 'px',
                    'overflow-y': 'auto'
                });
            }
        },
        setWidth: function() {
            if (this.options.width == 'auto') {
                this.$menu.css('min-width', '0');
                var
                    selectClone = this.$newElement.clone().appendTo('body');
                var
                    ulWidth = selectClone.find('> .dropdown-menu').css('width');
                var
                    btnWidth = selectClone.css('width', 'auto').find('> button').css('width');
                selectClone.remove();
                this.$newElement.css('width', Math.max(parseInt(ulWidth), parseInt(btnWidth)) + 'px');
            } else
            if (this.options.width == 'fit') {
                this.$menu.css('min-width', '');
                this.$newElement.css('width', '').addClass('fit-width');
            } else
            if (this.options.width) {
                this.$menu.css('min-width', '');
                this.$newElement.css('width', this.options.width);
            } else {
                this.$menu.css('min-width', '');
                this.$newElement.css('width', '');
            }
            if (this.$newElement.hasClass('fit-width') && this.options.width !== 'fit') {
                this.$newElement.removeClass('fit-width');
            }
        },
        selectPosition: function() {
            var
                that = this,
                drop = '<div />',
                $drop = $(drop),
                pos, actualHeight, getPlacement = function($element) {
                    $drop.addClass($element.attr('class').replace(/form-control/gi, '')).toggleClass('dropup', $element.hasClass('dropup'));
                    pos = $element.offset();
                    actualHeight = $element.hasClass('dropup') ? 0 : $element[0].offsetHeight;
                    $drop.css({
                        'top': pos.top + actualHeight,
                        'left': pos.left,
                        'width': $element[0].offsetWidth,
                        'position': 'absolute'
                    });
                };
            this.$newElement.on('click', function() {
                if (that.isDisabled()) {
                    return;
                }
                getPlacement($(this));
                $drop.appendTo(that.options.container);
                $drop.toggleClass('open', !$(this).hasClass('open'));
                $drop.append(that.$menu);
            });
            $(window).resize(function() {
                getPlacement(that.$newElement);
            });
            $(window).on('scroll', function() {
                getPlacement(that.$newElement);
            });
            $('html').on('click', function(e) {
                if ($(e.target).closest(that.$newElement).length < 1) {
                    $drop.removeClass('open');
                }
            });
        },
        setSelected: function(index, selected) {
            this.findLis();
            this.$lis.filter('[data-original-index="' + index + '"]').toggleClass('selected', selected);
        },
        setDisabled: function(index, disabled) {
            this.findLis();
            if (disabled) {
                this.$lis.filter('[data-original-index="' + index + '"]').addClass('disabled').find('a').attr('href', '#').attr('tabindex', -1);
            } else {
                this.$lis.filter('[data-original-index="' + index + '"]').removeClass('disabled').find('a').removeAttr('href').attr('tabindex', 0);
            }
        },
        isDisabled: function() {
            return this.$element.is(':disabled');
        },
        checkDisabled: function() {
            var
                that = this;
            if (this.isDisabled()) {
                this.$button.addClass('disabled').attr('tabindex', -1);
            } else {
                if (this.$button.hasClass('disabled')) {
                    this.$button.removeClass('disabled');
                }
                if (this.$button.attr('tabindex') == -1) {
                    if (!this.$element.data('tabindex')) this.$button.removeAttr('tabindex');
                }
            }
            this.$button.click(function() {
                return !that.isDisabled();
            });
        },
        tabIndex: function() {
            if (this.$element.is('[tabindex]')) {
                this.$element.data('tabindex', this.$element.attr('tabindex'));
                this.$button.attr('tabindex', this.$element.data('tabindex'));
            }
        },
        clickListener: function() {
            var
                that = this;
            this.$newElement.on('touchstart.dropdown', '.dropdown-menu', function(e) {
                e.stopPropagation();
            });
            this.$newElement.on('click', function() {
                that.setSize();
                if (!that.options.liveSearch && !that.multiple) {
                    setTimeout(function() {
                        that.$menu.find('.selected a').focus();
                    }, 10);
                }
            });
            this.$menu.on('click', 'li a', function(e) {
                var
                    $this = $(this),
                    clickedIndex = $this.parent().data('originalIndex'),
                    prevValue = that.$element.val(),
                    prevIndex = that.$element.prop('selectedIndex');
                if (that.multiple) {
                    e.stopPropagation();
                }
                e.preventDefault();
                if (!that.isDisabled() && !$this.parent().hasClass('disabled')) {
                    var
                        $options = that.$element.find('option'),
                        $option = $options.eq(clickedIndex),
                        state = $option.prop('selected'),
                        $optgroup = $option.parent('optgroup'),
                        maxOptions = that.options.maxOptions,
                        maxOptionsGrp = $optgroup.data('maxOptions') || false;
                    if (!that.multiple) {
                        $options.prop('selected', false);
                        $option.prop('selected', true);
                        that.$menu.find('.selected').removeClass('selected');
                        that.setSelected(clickedIndex, true);
                    } else {
                        $option.prop('selected', !state);
                        that.setSelected(clickedIndex, !state);
                        $this.blur();
                        if ((maxOptions !== false) || (maxOptionsGrp !== false)) {
                            var
                                maxReached = maxOptions < $options.filter(':selected').length,
                                maxReachedGrp = maxOptionsGrp < $optgroup.find('option:selected').length;
                            if ((maxOptions && maxReached) || (maxOptionsGrp && maxReachedGrp)) {
                                if (maxOptions && maxOptions == 1) {
                                    $options.prop('selected', false);
                                    $option.prop('selected', true);
                                    that.$menu.find('.selected').removeClass('selected');
                                    that.setSelected(clickedIndex, true);
                                } else
                                if (maxOptionsGrp && maxOptionsGrp == 1) {
                                    $optgroup.find('option:selected').prop('selected', false);
                                    $option.prop('selected', true);
                                    var
                                        optgroupID = $this.data('optgroup');
                                    that.$menu.find('.selected').has('a[data-optgroup="' + optgroupID + '"]').removeClass('selected');
                                    that.setSelected(clickedIndex, true);
                                } else {
                                    var
                                        maxOptionsArr = (typeof that.options.maxOptionsText === 'function') ? that.options.maxOptionsText(maxOptions, maxOptionsGrp) : that.options.maxOptionsText,
                                        maxTxt = maxOptionsArr[0].replace('{n}', maxOptions),
                                        maxTxtGrp = maxOptionsArr[1].replace('{n}', maxOptionsGrp),
                                        $notify = $('<div class="notify"></div>');
                                    if (maxOptionsArr[2]) {
                                        maxTxt = maxTxt.replace('{var}', maxOptionsArr[2][maxOptions > 1 ? 0 : 1]);
                                        maxTxtGrp = maxTxtGrp.replace('{var}', maxOptionsArr[2][maxOptionsGrp > 1 ? 0 : 1]);
                                    }
                                    $option.prop('selected', false);
                                    that.$menu.append($notify);
                                    if (maxOptions && maxReached) {
                                        $notify.append($('<div>' + maxTxt + '</div>'));
                                        that.$element.trigger('maxReached.bs.select');
                                    }
                                    if (maxOptionsGrp && maxReachedGrp) {
                                        $notify.append($('<div>' + maxTxtGrp + '</div>'));
                                        that.$element.trigger('maxReachedGrp.bs.select');
                                    }
                                    setTimeout(function() {
                                        that.setSelected(clickedIndex, false);
                                    }, 10);
                                    $notify.delay(750).fadeOut(300, function() {
                                        $(this).remove();
                                    });
                                }
                            }
                        }
                    }
                    if (!that.multiple) {
                        that.$button.focus();
                    } else
                    if (that.options.liveSearch) {
                        that.$searchbox.focus();
                    }
                    if ((prevValue != that.$element.val() && that.multiple) || (prevIndex != that.$element.prop('selectedIndex') && !that.multiple)) {
                        that.$element.change();
                    }
                }
            });
            this.$menu.on('click', 'li.disabled a, .popover-title, .popover-title :not(.close)', function(e) {
                if (e.target == this) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!that.options.liveSearch) {
                        that.$button.focus();
                    } else {
                        that.$searchbox.focus();
                    }
                }
            });
            this.$menu.on('click', 'li.divider, li.dropdown-header', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!that.options.liveSearch) {
                    that.$button.focus();
                } else {
                    that.$searchbox.focus();
                }
            });
            this.$menu.on('click', '.popover-title .close', function() {
                that.$button.focus();
            });
            this.$searchbox.on('click', function(e) {
                e.stopPropagation();
            });
            this.$menu.on('click', '.actions-btn', function(e) {
                if (that.options.liveSearch) {
                    that.$searchbox.focus();
                } else {
                    that.$button.focus();
                }
                e.preventDefault();
                e.stopPropagation();
                if ($(this).is('.bs-select-all')) {
                    that.selectAll();
                } else {
                    that.deselectAll();
                }
                that.$element.change();
            });
            this.$element.change(function() {
                that.render(false);
            });
        },
        liveSearchListener: function() {
            var
                that = this,
                no_results = $('<li class="no-results"></li>');
            this.$newElement.on('click.dropdown.data-api', function() {
                that.$menu.find('.active').removeClass('active');
                if (!!that.$searchbox.val()) {
                    that.$searchbox.val('');
                    that.$lis.not('.is-hidden').removeClass('hide');
                    if (!!no_results.parent().length) no_results.remove();
                }
                if (!that.multiple) that.$menu.find('.selected').addClass('active');
                setTimeout(function() {
                    that.$searchbox.focus();
                }, 10);
            });
            this.$searchbox.on('input propertychange', function() {
                if (that.$searchbox.val()) {
                    if (that.options.searchAccentInsensitive) {
                        that.$lis.not('.is-hidden').removeClass('hide').find('a').not(':aicontains(' + normalizeToBase(that.$searchbox.val()) + ')').parent().addClass('hide');
                    } else {
                        that.$lis.not('.is-hidden').removeClass('hide').find('a').not(':icontains(' + that.$searchbox.val() + ')').parent().addClass('hide');
                    }
                    if (!that.$menu.find('li').filter(':visible:not(.no-results)').length) {
                        if (!!no_results.parent().length) no_results.remove();
                        no_results.html(that.options.noneResultsText + ' "' + that.$searchbox.val() + '"').show();
                        that.$menu.find('li').last().after(no_results);
                    } else
                    if (!!no_results.parent().length) {
                        no_results.remove();
                    }
                } else {
                    that.$lis.not('.is-hidden').removeClass('hide');
                    if (!!no_results.parent().length) no_results.remove();
                }
                that.$menu.find('li.active').removeClass('active');
                that.$menu.find('li').filter(':visible:not(.divider)').eq(0).addClass('active').find('a').focus();
                $(this).focus();
            });
        },
        val: function(value) {
            if (typeof value !== 'undefined') {
                this.$element.val(value);
                this.render();
                return this.$element;
            } else {
                return this.$element.val();
            }
        },
        selectAll: function() {
            this.findLis();
            this.$lis.not('.divider').not('.disabled').not('.selected').filter(':visible').find('a').click();
        },
        deselectAll: function() {
            this.findLis();
            this.$lis.not('.divider').not('.disabled').filter('.selected').filter(':visible').find('a').click();
        },
        keydown: function(e) {
            var
                $this = $(this),
                $parent = ($this.is('input')) ? $this.parent().parent() : $this.parent(),
                $items, that = $parent.data('this'),
                index, next, first, last, prev, nextPrev, prevIndex, isActive, keyCodeMap = {
                    32: ' ',
                    48: '0',
                    49: '1',
                    50: '2',
                    51: '3',
                    52: '4',
                    53: '5',
                    54: '6',
                    55: '7',
                    56: '8',
                    57: '9',
                    59: ';',
                    65: 'a',
                    66: 'b',
                    67: 'c',
                    68: 'd',
                    69: 'e',
                    70: 'f',
                    71: 'g',
                    72: 'h',
                    73: 'i',
                    74: 'j',
                    75: 'k',
                    76: 'l',
                    77: 'm',
                    78: 'n',
                    79: 'o',
                    80: 'p',
                    81: 'q',
                    82: 'r',
                    83: 's',
                    84: 't',
                    85: 'u',
                    86: 'v',
                    87: 'w',
                    88: 'x',
                    89: 'y',
                    90: 'z',
                    96: '0',
                    97: '1',
                    98: '2',
                    99: '3',
                    100: '4',
                    101: '5',
                    102: '6',
                    103: '7',
                    104: '8',
                    105: '9'
                };
            if (that.options.liveSearch) $parent = $this.parent().parent();
            if (that.options.container) $parent = that.$menu;
            $items = $('[role=menu] li a', $parent);
            isActive = that.$menu.parent().hasClass('open');
            if (!isActive && /([0-9]|[A-z])/.test(String.fromCharCode(e.keyCode))) {
                if (!that.options.container) {
                    that.setSize();
                    that.$menu.parent().addClass('open');
                    isActive = true;
                } else {
                    that.$newElement.trigger('click');
                }
                that.$searchbox.focus();
            }
            if (that.options.liveSearch) {
                if (/(^9$|27)/.test(e.keyCode.toString(10)) && isActive && that.$menu.find('.active').length === 0) {
                    e.preventDefault();
                    that.$menu.parent().removeClass('open');
                    that.$button.focus();
                }
                $items = $('[role=menu] li:not(.divider):not(.dropdown-header):visible', $parent);
                if (!$this.val() && !/(38|40)/.test(e.keyCode.toString(10))) {
                    if ($items.filter('.active').length === 0) {
                        if (that.options.searchAccentInsensitive) {
                            $items = that.$newElement.find('li').filter(':aicontains(' + normalizeToBase(keyCodeMap[e.keyCode]) + ')');
                        } else {
                            $items = that.$newElement.find('li').filter(':icontains(' + keyCodeMap[e.keyCode] + ')');
                        }
                    }
                }
            }
            if (!$items.length) return;
            if (/(38|40)/.test(e.keyCode.toString(10))) {
                index = $items.index($items.filter(':focus'));
                first = $items.parent(':not(.disabled):visible').first().index();
                last = $items.parent(':not(.disabled):visible').last().index();
                next = $items.eq(index).parent().nextAll(':not(.disabled):visible').eq(0).index();
                prev = $items.eq(index).parent().prevAll(':not(.disabled):visible').eq(0).index();
                nextPrev = $items.eq(next).parent().prevAll(':not(.disabled):visible').eq(0).index();
                if (that.options.liveSearch) {
                    $items.each(function(i) {
                        if ($(this).is(':not(.disabled)')) {
                            $(this).data('index', i);
                        }
                    });
                    index = $items.index($items.filter('.active'));
                    first = $items.filter(':not(.disabled):visible').first().data('index');
                    last = $items.filter(':not(.disabled):visible').last().data('index');
                    next = $items.eq(index).nextAll(':not(.disabled):visible').eq(0).data('index');
                    prev = $items.eq(index).prevAll(':not(.disabled):visible').eq(0).data('index');
                    nextPrev = $items.eq(next).prevAll(':not(.disabled):visible').eq(0).data('index');
                }
                prevIndex = $this.data('prevIndex');
                if (e.keyCode == 38) {
                    if (that.options.liveSearch) index -= 1;
                    if (index != nextPrev && index > prev) index = prev;
                    if (index < first) index = first;
                    if (index == prevIndex) index = last;
                }
                if (e.keyCode == 40) {
                    if (that.options.liveSearch) index += 1;
                    if (index == -1) index = 0;
                    if (index != nextPrev && index < next) index = next;
                    if (index > last) index = last;
                    if (index == prevIndex) index = first;
                }
                $this.data('prevIndex', index);
                if (!that.options.liveSearch) {
                    $items.eq(index).focus();
                } else {
                    e.preventDefault();
                    if (!$this.is('.dropdown-toggle')) {
                        $items.removeClass('active');
                        $items.eq(index).addClass('active').find('a').focus();
                        $this.focus();
                    }
                }
            } else
            if (!$this.is('input')) {
                var
                    keyIndex = [],
                    count, prevKey;
                $items.each(function() {
                    if ($(this).parent().is(':not(.disabled)')) {
                        if ($.trim($(this).text().toLowerCase()).substring(0, 1) == keyCodeMap[e.keyCode]) {
                            keyIndex.push($(this).parent().index());
                        }
                    }
                });
                count = $(document).data('keycount');
                count++;
                $(document).data('keycount', count);
                prevKey = $.trim($(':focus').text().toLowerCase()).substring(0, 1);
                if (prevKey != keyCodeMap[e.keyCode]) {
                    count = 1;
                    $(document).data('keycount', count);
                } else
                if (count >= keyIndex.length) {
                    $(document).data('keycount', 0);
                    if (count > keyIndex.length) count = 1;
                }
                $items.eq(keyIndex[count - 1]).focus();
            }
            if ((/(13|32)/.test(e.keyCode.toString(10)) || (/(^9$)/.test(e.keyCode.toString(10)) && that.options.selectOnTab)) && isActive) {
                if (!/(32)/.test(e.keyCode.toString(10))) e.preventDefault();
                if (!that.options.liveSearch) {
                    $(':focus').click();
                } else
                if (!/(32)/.test(e.keyCode.toString(10))) {
                    that.$menu.find('.active a').click();
                    $this.focus();
                }
                $(document).data('keycount', 0);
            }
            if ((/(^9$|27)/.test(e.keyCode.toString(10)) && isActive && (that.multiple || that.options.liveSearch)) || (/(27)/.test(e.keyCode.toString(10)) && !isActive)) {
                that.$menu.parent().removeClass('open');
                that.$button.focus();
            }
        },
        mobile: function() {
            this.$element.addClass('mobile-device').appendTo(this.$newElement);
            if (this.options.container) this.$menu.hide();
        },
        refresh: function() {
            this.$lis = null;
            this.reloadLi();
            this.render();
            this.setWidth();
            this.setStyle();
            this.checkDisabled();
            this.liHeight();
        },
        update: function() {
            this.reloadLi();
            this.setWidth();
            this.setStyle();
            this.checkDisabled();
            this.liHeight();
        },
        hide: function() {
            this.$newElement.hide();
        },
        show: function() {
            this.$newElement.show();
        },
        remove: function() {
            this.$newElement.remove();
            this.$element.remove();
        }
    };

    function
    Plugin(option, event) {
        var
            args = arguments;
        var
            _option = option,
            option = args[0],
            event = args[1];
        [].shift.apply(args);
        if (typeof option == 'undefined') {
            option = _option;
        }
        var
            value;
        var
            chain = this.each(function() {
                var
                    $this = $(this);
                if ($this.is('select')) {
                    var
                        data = $this.data('selectpicker'),
                        options = typeof
                    option == 'object' && option;
                    if (!data) {
                        var
                            config = $.extend({}, Selectpicker.DEFAULTS, $.fn.selectpicker.defaults || {}, $this.data(), options);
                        $this.data('selectpicker', (data = new Selectpicker(this, config, event)));
                    } else
                    if (options) {
                        for (var
                                i in
                                options) {
                            if (options.hasOwnProperty(i)) {
                                data.options[i] = options[i];
                            }
                        }
                    }
                    if (typeof option == 'string') {
                        if (data[option] instanceof Function) {
                            value = data[option].apply(data, args);
                        } else {
                            value = data.options[option];
                        }
                    }
                }
            });
        if (typeof value !== 'undefined') {
            return value;
        } else {
            return chain;
        }
    }
    var
        old = $.fn.selectpicker;
    $.fn.selectpicker = Plugin;
    $.fn.selectpicker.Constructor = Selectpicker;
    $.fn.selectpicker.noConflict = function() {
        $.fn.selectpicker = old;
        return this;
    };
    $(document).data('keycount', 0).on('keydown', '.bootstrap-select [data-toggle=dropdown], .bootstrap-select [role=menu], .bs-searchbox input', Selectpicker.prototype.keydown).on('focusin.modal', '.bootstrap-select [data-toggle=dropdown], .bootstrap-select [role=menu], .bs-searchbox input', function(e) {
        e.stopPropagation();
    });
    $(window).on('load.bs.select.data-api', function() {
        $('.selectpicker').each(function() {
            var
                $selectpicker = $(this);
            Plugin.call($selectpicker, $selectpicker.data());
        })
    });
})(jQuery);;
(function(f, h, $) {
    var
        a = 'placeholder' in
        h.createElement('input'),
        d = 'placeholder' in
        h.createElement('textarea'),
        i = $.fn,
        c = $.valHooks,
        k, j;
    if (a && d) {
        j = i.placeholder = function() {
            return this
        };
        j.input = j.textarea = true
    } else {
        j = i.placeholder = function() {
            var
                l = this;
            l.filter((a ? 'textarea' : ':input') + '[placeholder]').not('.placeholder').bind({
                'focus.placeholder': b,
                'blur.placeholder': e
            }).data('placeholder-enabled', true).trigger('blur.placeholder');
            return l
        };
        j.input = a;
        j.textarea = d;
        k = {
            get: function(m) {
                var
                    l = $(m);
                return l.data('placeholder-enabled') && l.hasClass('placeholder') ? '' : m.value
            },
            set: function(m, n) {
                var
                    l = $(m);
                if (!l.data('placeholder-enabled')) {
                    return m.value = n
                }
                if (n == '') {
                    m.value = n;
                    if (m != h.activeElement) {
                        e.call(m)
                    }
                } else {
                    if (l.hasClass('placeholder')) {
                        b.call(m, true, n) || (m.value = n)
                    } else {
                        m.value = n
                    }
                }
                return l
            }
        };
        a || (c.input = k);
        d || (c.textarea = k);
        $(function() {
            $(h).delegate('form', 'submit.placeholder', function() {
                var
                    l = $('.placeholder', this).each(b);
                setTimeout(function() {
                    l.each(e)
                }, 10)
            })
        });
        $(f).bind('beforeunload.placeholder', function() {
            $('.placeholder').each(function() {
                this.value = ''
            })
        })
    }

    function
    g(m) {
        var
            l = {},
            n = /^jQuery\d+$/;
        $.each(m.attributes, function(p, o) {
            if (o.specified && !n.test(o.name)) {
                l[o.name] = o.value
            }
        });
        return l
    }

    function
    b(m, n) {
        var
            l = this,
            o = $(l);
        if (l.value == o.attr('placeholder') && o.hasClass('placeholder')) {
            if (o.data('placeholder-password')) {
                o = o.hide().next().show().attr('id', o.removeAttr('id').data('placeholder-id'));
                if (m === true) {
                    return o[0].value = n
                }
                o.focus()
            } else {
                l.value = '';
                o.removeClass('placeholder');
                l == h.activeElement && l.select()
            }
        }
    }

    function
    e() {
        var
            q, l = this,
            p = $(l),
            m = p,
            o = this.id;
        if (l.value == '') {
            if (l.type == 'password') {
                if (!p.data('placeholder-textinput')) {
                    try {
                        q = p.clone().attr({
                            type: 'text'
                        })
                    } catch (n) {
                        q = $('<input>').attr($.extend(g(this), {
                            type: 'text'
                        }))
                    }
                    q.removeAttr('name').data({
                        'placeholder-password': true,
                        'placeholder-id': o
                    }).bind('focus.placeholder', b);
                    p.data({
                        'placeholder-textinput': q,
                        'placeholder-id': o
                    }).before(q)
                }
                p = p.removeAttr('id').hide().prev().attr('id', o).show()
            }
            p.addClass('placeholder');
            p[0].value = p.attr('placeholder')
        } else {
            p.removeClass('placeholder')
        }
    }
}(this, document, jQuery));
(function() {
    var
        $, cardFromNumber, cardFromType, cards, defaultFormat, formatBackCardNumber, formatBackExpiry, formatCardNumber, formatExpiry, formatForwardExpiry, formatForwardSlash, hasTextSelected, luhnCheck, reFormatCardNumber, restrictCVC, restrictCardNumber, restrictExpiry, restrictNumeric, setCardType, __slice = [].slice,
        __indexOf = [].indexOf || function(item) {
            for (var
                    i = 0, l = this.length; i < l; i++) {
                if (i in
                    this && this[i] === item) return i;
            }
            return -1;
        },
        _this = this;
    $ = jQuery;
    $.payment = {};
    $.payment.fn = {};
    $.fn.payment = function() {
        var
            args, method;
        method = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
        return $.payment.fn[method].apply(this, args);
    };
    defaultFormat = /(\d{1,4})/g;
    cards = [{
        type: 'maestro',
        pattern: /^(5018|5020|5038|6304|6759|676[1-3])/,
        format: defaultFormat,
        length: [12, 13, 14, 15, 16, 17, 18, 19],
        cvcLength: [3],
        luhn: true
    }, {
        type: 'dinersclub',
        pattern: /^(36|38|30[0-5])/,
        format: defaultFormat,
        length: [14],
        cvcLength: [3],
        luhn: true
    }, {
        type: 'laser',
        pattern: /^(6706|6771|6709)/,
        format: defaultFormat,
        length: [16, 17, 18, 19],
        cvcLength: [3],
        luhn: true
    }, {
        type: 'jcb',
        pattern: /^35/,
        format: defaultFormat,
        length: [16],
        cvcLength: [3],
        luhn: true
    }, {
        type: 'unionpay',
        pattern: /^62/,
        format: defaultFormat,
        length: [16, 17, 18, 19],
        cvcLength: [3],
        luhn: false
    }, {
        type: 'discover',
        pattern: /^(6011|65|64[4-9]|622)/,
        format: defaultFormat,
        length: [16],
        cvcLength: [3],
        luhn: true
    }, {
        type: 'mastercard',
        pattern: /^5[1-5]/,
        format: defaultFormat,
        length: [16],
        cvcLength: [3],
        luhn: true
    }, {
        type: 'amex',
        pattern: /^3[47]/,
        format: /(\d{1,4})(\d{1,6})?(\d{1,5})?/,
        length: [15],
        cvcLength: [3, 4],
        luhn: true
    }, {
        type: 'visa',
        pattern: /^4/,
        format: defaultFormat,
        length: [13, 14, 15, 16],
        cvcLength: [3],
        luhn: true
    }];
    cardFromNumber = function(num) {
        var
            card, _i, _len;
        num = (num + '').replace(/\D/g, '');
        for (_i = 0, _len = cards.length; _i < _len; _i++) {
            card = cards[_i];
            if (card.pattern.test(num)) {
                return card;
            }
        }
    };
    cardFromType = function(type) {
        var
            card, _i, _len;
        for (_i = 0, _len = cards.length; _i < _len; _i++) {
            card = cards[_i];
            if (card.type === type) {
                return card;
            }
        }
    };
    luhnCheck = function(num) {
        var
            digit, digits, odd, sum, _i, _len;
        odd = true;
        sum = 0;
        digits = (num + '').split('').reverse();
        for (_i = 0, _len = digits.length; _i < _len; _i++) {
            digit = digits[_i];
            digit = parseInt(digit, 10);
            if ((odd = !odd)) {
                digit *= 2;
            }
            if (digit > 9) {
                digit -= 9;
            }
            sum += digit;
        }
        return sum % 10 === 0;
    };
    hasTextSelected = function($target) {
        var
            _ref;
        if (($target.prop('selectionStart') != null) && $target.prop('selectionStart') !== $target.prop('selectionEnd')) {
            return true;
        }
        if (typeof document !== "undefined" && document !== null ? (_ref = document.selection) != null ? typeof _ref.createRange === "function" ? _ref.createRange().text : void 0 : void 0 : void 0) {
            return true;
        }
        return false;
    };
    reFormatCardNumber = function(e) {
        var
            _this = this;
        return setTimeout(function() {
            var
                $target, value;
            $target = $(e.currentTarget);
            value = $target.val();
            value = $.payment.formatCardNumber(value);
            return $target.val(value);
        });
    };
    formatCardNumber = function(e) {
        var
            $target, card, digit, length, re, upperLength, value;
        digit = String.fromCharCode(e.which);
        if (!/^\d+$/.test(digit)) {
            return;
        }
        $target = $(e.currentTarget);
        value = $target.val();
        card = cardFromNumber(value + digit);
        length = (value.replace(/\D/g, '') + digit).length;
        upperLength = 16;
        if (card) {
            upperLength = card.length[card.length.length - 1];
        }
        if (length >= upperLength) {
            return;
        }
        if (($target.prop('selectionStart') != null) && $target.prop('selectionStart') !== value.length) {
            return;
        }
        if (card && card.type === 'amex') {
            re = /^(\d{4}|\d{4}\s\d{6})$/;
        } else {
            re = /(?:^|\s)(\d{4})$/;
        }
        if (re.test(value)) {
            e.preventDefault();
            return $target.val(value + ' ' + digit);
        } else
        if (re.test(value + digit)) {
            e.preventDefault();
            return $target.val(value + digit + ' ');
        }
    };
    formatBackCardNumber = function(e) {
        var
            $target, value;
        $target = $(e.currentTarget);
        value = $target.val();
        if (e.meta) {
            return;
        }
        if (e.which !== 8) {
            return;
        }
        if (($target.prop('selectionStart') != null) && $target.prop('selectionStart') !== value.length) {
            return;
        }
        if (/\d\s$/.test(value)) {
            e.preventDefault();
            return $target.val(value.replace(/\d\s$/, ''));
        } else
        if (/\s\d?$/.test(value)) {
            e.preventDefault();
            return $target.val(value.replace(/\s\d?$/, ''));
        }
    };
    formatExpiry = function(e) {
        var
            $target, digit, val;
        digit = String.fromCharCode(e.which);
        if (!/^\d+$/.test(digit)) {
            return;
        }
        $target = $(e.currentTarget);
        val = $target.val() + digit;
        if (/^\d$/.test(val) && (val !== '0' && val !== '1')) {
            e.preventDefault();
            return $target.val("0" + val + " / ");
        } else
        if (/^\d\d$/.test(val)) {
            e.preventDefault();
            return $target.val("" + val + " / ");
        }
    };
    formatForwardExpiry = function(e) {
        var
            $target, digit, val;
        digit = String.fromCharCode(e.which);
        if (!/^\d+$/.test(digit)) {
            return;
        }
        $target = $(e.currentTarget);
        val = $target.val();
        if (/^\d\d$/.test(val)) {
            return $target.val("" + val + " / ");
        }
    };
    formatForwardSlash = function(e) {
        var
            $target, slash, val;
        slash = String.fromCharCode(e.which);
        if (slash !== '/') {
            return;
        }
        $target = $(e.currentTarget);
        val = $target.val();
        if (/^\d$/.test(val) && val !== '0') {
            return $target.val("0" + val + " / ");
        }
    };
    formatBackExpiry = function(e) {
        var
            $target, value;
        if (e.meta) {
            return;
        }
        $target = $(e.currentTarget);
        value = $target.val();
        if (e.which !== 8) {
            return;
        }
        if (($target.prop('selectionStart') != null) && $target.prop('selectionStart') !== value.length) {
            return;
        }
        if (/\d(\s|\/)+$/.test(value)) {
            e.preventDefault();
            return $target.val(value.replace(/\d(\s|\/)*$/, ''));
        } else
        if (/\s\/\s?\d?$/.test(value)) {
            e.preventDefault();
            return $target.val(value.replace(/\s\/\s?\d?$/, ''));
        }
    };
    restrictNumeric = function(e) {
        var
            input;
        if (e.metaKey || e.ctrlKey) {
            return true;
        }
        if (e.which === 32) {
            return false;
        }
        if (e.which === 0) {
            return true;
        }
        if (e.which < 33) {
            return true;
        }
        input = String.fromCharCode(e.which);
        return !!/[\d\s]/.test(input);
    };
    restrictCardNumber = function(e) {
        var
            $target, card, digit, value;
        $target = $(e.currentTarget);
        digit = String.fromCharCode(e.which);
        if (!/^\d+$/.test(digit)) {
            return;
        }
        if (hasTextSelected($target)) {
            return;
        }
        value = ($target.val() + digit).replace(/\D/g, '');
        card = cardFromNumber(value);
        if (card) {
            return value.length <= card.length[card.length.length - 1];
        } else {
            return value.length <= 16;
        }
    };
    restrictExpiry = function(e) {
        var
            $target, digit, value;
        $target = $(e.currentTarget);
        digit = String.fromCharCode(e.which);
        if (!/^\d+$/.test(digit)) {
            return;
        }
        if (hasTextSelected($target)) {
            return;
        }
        value = $target.val() + digit;
        value = value.replace(/\D/g, '');
        if (value.length > 6) {
            return false;
        }
    };
    restrictCVC = function(e) {
        var
            $target, digit, val;
        $target = $(e.currentTarget);
        digit = String.fromCharCode(e.which);
        if (!/^\d+$/.test(digit)) {
            return;
        }
        val = $target.val() + digit;
        return val.length <= 4;
    };
    setCardType = function(e) {
        var
            $target, allTypes, card, cardType, val;
        $target = $(e.currentTarget);
        val = $target.val();
        cardType = $.payment.cardType(val) || 'unknown';
        if (!$target.hasClass(cardType)) {
            allTypes = (function() {
                var
                    _i, _len, _results;
                _results = [];
                for (_i = 0, _len = cards.length; _i < _len; _i++) {
                    card = cards[_i];
                    _results.push(card.type);
                }
                return _results;
            })();
            $target.removeClass('unknown');
            $target.removeClass(allTypes.join(' '));
            $target.addClass(cardType);
            $target.toggleClass('identified', cardType !== 'unknown');
            return $target.trigger('payment.cardType', cardType);
        }
    };
    $.payment.fn.formatCardCVC = function() {
        this.payment('restrictNumeric');
        this.on('keypress', restrictCVC);
        return this;
    };
    $.payment.fn.formatCardExpiry = function() {
        this.payment('restrictNumeric');
        this.on('keypress', restrictExpiry);
        this.on('keypress', formatExpiry);
        this.on('keypress', formatForwardSlash);
        this.on('keypress', formatForwardExpiry);
        this.on('keydown', formatBackExpiry);
        return this;
    };
    $.payment.fn.formatCardNumber = function() {
        this.payment('restrictNumeric');
        this.on('keypress', restrictCardNumber);
        this.on('keypress', formatCardNumber);
        this.on('keydown', formatBackCardNumber);
        this.on('keyup', setCardType);
        this.on('paste', reFormatCardNumber);
        return this;
    };
    $.payment.fn.restrictNumeric = function() {
        this.on('keypress', restrictNumeric);
        return this;
    };
    $.payment.fn.cardExpiryVal = function() {
        return $.payment.cardExpiryVal($(this).val());
    };
    $.payment.cardExpiryVal = function(value) {
        var
            month, prefix, year, _ref;
        value = value.replace(/\s/g, '');
        _ref = value.split('/', 2), month = _ref[0], year = _ref[1];
        if ((year != null ? year.length : void 0) === 2 && /^\d+$/.test(year)) {
            prefix = (new Date).getFullYear();
            prefix = prefix.toString().slice(0, 2);
            year = prefix + year;
        }
        month = parseInt(month, 10);
        year = parseInt(year, 10);
        return {
            month: month,
            year: year
        };
    };
    $.payment.validateCardNumber = function(num) {
        var
            card, _ref;
        num = (num + '').replace(/\s+|-/g, '');
        if (!/^\d+$/.test(num)) {
            return false;
        }
        card = cardFromNumber(num);
        if (!card) {
            return false;
        }
        return (_ref = num.length, __indexOf.call(card.length, _ref) >= 0) && (card.luhn === false || luhnCheck(num));
    };
    $.payment.validateCardExpiry = function(month, year) {
        var
            currentTime, expiry, prefix, _ref;
        if (typeof month === 'object' && 'month' in
            month) {
            _ref = month, month = _ref.month, year = _ref.year;
        }
        if (!(month && year)) {
            return false;
        }
        month = $.trim(month);
        year = $.trim(year);
        if (!/^\d+$/.test(month)) {
            return false;
        }
        if (!/^\d+$/.test(year)) {
            return false;
        }
        if (!(parseInt(month, 10) <= 12)) {
            return false;
        }
        if (year.length === 2) {
            prefix = (new Date).getFullYear();
            prefix = prefix.toString().slice(0, 2);
            year = prefix + year;
        }
        expiry = new
        Date(year, month);
        currentTime = new
        Date;
        expiry.setMonth(expiry.getMonth() - 1);
        expiry.setMonth(expiry.getMonth() + 1, 1);
        return expiry > currentTime;
    };
    $.payment.validateCardCVC = function(cvc, type) {
        var
            _ref, _ref1;
        cvc = $.trim(cvc);
        if (!/^\d+$/.test(cvc)) {
            return false;
        }
        if (type) {
            return _ref = cvc.length, __indexOf.call((_ref1 = cardFromType(type)) != null ? _ref1.cvcLength : void 0, _ref) >= 0;
        } else {
            return cvc.length >= 3 && cvc.length <= 4;
        }
    };
    $.payment.cardType = function(num) {
        var
            _ref;
        if (!num) {
            return null;
        }
        return ((_ref = cardFromNumber(num)) != null ? _ref.type : void 0) || null;
    };
    $.payment.formatCardNumber = function(num) {
        var
            card, groups, upperLength, _ref;
        card = cardFromNumber(num);
        if (!card) {
            return num;
        }
        upperLength = card.length[card.length.length - 1];
        num = num.replace(/\D/g, '');
        num = num.slice(0, +upperLength + 1 || 9e9);
        if (card.format.global) {
            return (_ref = num.match(card.format)) != null ? _ref.join(' ') : void
            0;
        } else {
            groups = card.format.exec(num);
            if (groups != null) {
                groups.shift();
            }
            return groups != null ? groups.join(' ') : void
            0;
        }
    };
}).call(this);
(function() {
    var
        root = this;
    var
        previousUnderscore = root._;
    var
        breaker = {};
    var
        ArrayProto = Array.prototype,
        ObjProto = Object.prototype,
        FuncProto = Function.prototype;
    var
        push = ArrayProto.push,
        slice = ArrayProto.slice,
        concat = ArrayProto.concat,
        toString = ObjProto.toString,
        hasOwnProperty = ObjProto.hasOwnProperty;
    var
        nativeForEach = ArrayProto.forEach,
        nativeMap = ArrayProto.map,
        nativeReduce = ArrayProto.reduce,
        nativeReduceRight = ArrayProto.reduceRight,
        nativeFilter = ArrayProto.filter,
        nativeEvery = ArrayProto.every,
        nativeSome = ArrayProto.some,
        nativeIndexOf = ArrayProto.indexOf,
        nativeLastIndexOf = ArrayProto.lastIndexOf,
        nativeIsArray = Array.isArray,
        nativeKeys = Object.keys,
        nativeBind = FuncProto.bind;
    var
        _ = function(obj) {
            if (obj instanceof _) return obj;
            if (!(this instanceof _)) return new
            _(obj);
            this._wrapped = obj;
        };
    if (typeof exports !== 'undefined') {
        if (typeof module !== 'undefined' && module.exports) {
            exports = module.exports = _;
        }
        exports._ = _;
    } else {
        root._ = _;
    }
    _.VERSION = '1.5.2';
    var
        each = _.each = _.forEach = function(obj, iterator, context) {
            if (obj == null) return;
            if (nativeForEach && obj.forEach === nativeForEach) {
                obj.forEach(iterator, context);
            } else
            if (obj.length === +obj.length) {
                for (var
                        i = 0, length = obj.length; i < length; i++) {
                    if (iterator.call(context, obj[i], i, obj) === breaker) return;
                }
            } else {
                var
                    keys = _.keys(obj);
                for (var
                        i = 0, length = keys.length; i < length; i++) {
                    if (iterator.call(context, obj[keys[i]], keys[i], obj) === breaker) return;
                }
            }
        };
    _.map = _.collect = function(obj, iterator, context) {
        var
            results = [];
        if (obj == null) return results;
        if (nativeMap && obj.map === nativeMap) return obj.map(iterator, context);
        each(obj, function(value, index, list) {
            results.push(iterator.call(context, value, index, list));
        });
        return results;
    };
    var
        reduceError = 'Reduce of empty array with no initial value';
    _.reduce = _.foldl = _.inject = function(obj, iterator, memo, context) {
        var
            initial = arguments.length > 2;
        if (obj == null) obj = [];
        if (nativeReduce && obj.reduce === nativeReduce) {
            if (context) iterator = _.bind(iterator, context);
            return initial ? obj.reduce(iterator, memo) : obj.reduce(iterator);
        }
        each(obj, function(value, index, list) {
            if (!initial) {
                memo = value;
                initial = true;
            } else {
                memo = iterator.call(context, memo, value, index, list);
            }
        });
        if (!initial) throw new
        TypeError(reduceError);
        return memo;
    };
    _.reduceRight = _.foldr = function(obj, iterator, memo, context) {
        var
            initial = arguments.length > 2;
        if (obj == null) obj = [];
        if (nativeReduceRight && obj.reduceRight === nativeReduceRight) {
            if (context) iterator = _.bind(iterator, context);
            return initial ? obj.reduceRight(iterator, memo) : obj.reduceRight(iterator);
        }
        var
            length = obj.length;
        if (length !== +length) {
            var
                keys = _.keys(obj);
            length = keys.length;
        }
        each(obj, function(value, index, list) {
            index = keys ? keys[--length] : --length;
            if (!initial) {
                memo = obj[index];
                initial = true;
            } else {
                memo = iterator.call(context, memo, obj[index], index, list);
            }
        });
        if (!initial) throw new
        TypeError(reduceError);
        return memo;
    };
    _.find = _.detect = function(obj, iterator, context) {
        var
            result;
        any(obj, function(value, index, list) {
            if (iterator.call(context, value, index, list)) {
                result = value;
                return true;
            }
        });
        return result;
    };
    _.filter = _.select = function(obj, iterator, context) {
        var
            results = [];
        if (obj == null) return results;
        if (nativeFilter && obj.filter === nativeFilter) return obj.filter(iterator, context);
        each(obj, function(value, index, list) {
            if (iterator.call(context, value, index, list)) results.push(value);
        });
        return results;
    };
    _.reject = function(obj, iterator, context) {
        return _.filter(obj, function(value, index, list) {
            return !iterator.call(context, value, index, list);
        }, context);
    };
    _.every = _.all = function(obj, iterator, context) {
        iterator || (iterator = _.identity);
        var
            result = true;
        if (obj == null) return result;
        if (nativeEvery && obj.every === nativeEvery) return obj.every(iterator, context);
        each(obj, function(value, index, list) {
            if (!(result = result && iterator.call(context, value, index, list))) return breaker;
        });
        return !!result;
    };
    var
        any = _.some = _.any = function(obj, iterator, context) {
            iterator || (iterator = _.identity);
            var
                result = false;
            if (obj == null) return result;
            if (nativeSome && obj.some === nativeSome) return obj.some(iterator, context);
            each(obj, function(value, index, list) {
                if (result || (result = iterator.call(context, value, index, list))) return breaker;
            });
            return !!result;
        };
    _.contains = _.include = function(obj, target) {
        if (obj == null) return false;
        if (nativeIndexOf && obj.indexOf === nativeIndexOf) return obj.indexOf(target) != -1;
        return any(obj, function(value) {
            return value === target;
        });
    };
    _.invoke = function(obj, method) {
        var
            args = slice.call(arguments, 2);
        var
            isFunc = _.isFunction(method);
        return _.map(obj, function(value) {
            return (isFunc ? method : value[method]).apply(value, args);
        });
    };
    _.pluck = function(obj, key) {
        return _.map(obj, function(value) {
            return value[key];
        });
    };
    _.where = function(obj, attrs, first) {
        if (_.isEmpty(attrs)) return first ? void
        0: [];
        return _[first ? 'find' : 'filter'](obj, function(value) {
            for (var
                    key in
                    attrs) {
                if (attrs[key] !== value[key]) return false;
            }
            return true;
        });
    };
    _.findWhere = function(obj, attrs) {
        return _.where(obj, attrs, true);
    };
    _.max = function(obj, iterator, context) {
        if (!iterator && _.isArray(obj) && obj[0] === +obj[0] && obj.length < 65535) {
            return Math.max.apply(Math, obj);
        }
        if (!iterator && _.isEmpty(obj)) return -Infinity;
        var
            result = {
                computed: -Infinity,
                value: -Infinity
            };
        each(obj, function(value, index, list) {
            var
                computed = iterator ? iterator.call(context, value, index, list) : value;
            computed > result.computed && (result = {
                value: value,
                computed: computed
            });
        });
        return result.value;
    };
    _.min = function(obj, iterator, context) {
        if (!iterator && _.isArray(obj) && obj[0] === +obj[0] && obj.length < 65535) {
            return Math.min.apply(Math, obj);
        }
        if (!iterator && _.isEmpty(obj)) return Infinity;
        var
            result = {
                computed: Infinity,
                value: Infinity
            };
        each(obj, function(value, index, list) {
            var
                computed = iterator ? iterator.call(context, value, index, list) : value;
            computed < result.computed && (result = {
                value: value,
                computed: computed
            });
        });
        return result.value;
    };
    _.shuffle = function(obj) {
        var
            rand;
        var
            index = 0;
        var
            shuffled = [];
        each(obj, function(value) {
            rand = _.random(index++);
            shuffled[index - 1] = shuffled[rand];
            shuffled[rand] = value;
        });
        return shuffled;
    };
    _.sample = function(obj, n, guard) {
        if (n == null || guard) {
            if (obj.length !== +obj.length) obj = _.values(obj);
            return obj[_.random(obj.length - 1)];
        }
        return _.shuffle(obj).slice(0, Math.max(0, n));
    };
    var
        lookupIterator = function(value) {
            return _.isFunction(value) ? value : function(obj) {
                return obj[value];
            };
        };
    _.sortBy = function(obj, value, context) {
        var
            iterator = lookupIterator(value);
        return _.pluck(_.map(obj, function(value, index, list) {
            return {
                value: value,
                index: index,
                criteria: iterator.call(context, value, index, list)
            };
        }).sort(function(left, right) {
            var
                a = left.criteria;
            var
                b = right.criteria;
            if (a !== b) {
                if (a > b || a === void 0) return 1;
                if (a < b || b === void 0) return -1;
            }
            return left.index - right.index;
        }), 'value');
    };
    var
        group = function(behavior) {
            return function(obj, value, context) {
                var
                    result = {};
                var
                    iterator = value == null ? _.identity : lookupIterator(value);
                each(obj, function(value, index) {
                    var
                        key = iterator.call(context, value, index, obj);
                    behavior(result, key, value);
                });
                return result;
            };
        };
    _.groupBy = group(function(result, key, value) {
        (_.has(result, key) ? result[key] : (result[key] = [])).push(value);
    });
    _.indexBy = group(function(result, key, value) {
        result[key] = value;
    });
    _.countBy = group(function(result, key) {
        _.has(result, key) ? result[key]++ : result[key] = 1;
    });
    _.sortedIndex = function(array, obj, iterator, context) {
        iterator = iterator == null ? _.identity : lookupIterator(iterator);
        var
            value = iterator.call(context, obj);
        var
            low = 0,
            high = array.length;
        while (low < high) {
            var
                mid = (low + high) >>> 1;
            iterator.call(context, array[mid]) < value ? low = mid + 1 : high = mid;
        }
        return low;
    };
    _.toArray = function(obj) {
        if (!obj) return [];
        if (_.isArray(obj)) return slice.call(obj);
        if (obj.length === +obj.length) return _.map(obj, _.identity);
        return _.values(obj);
    };
    _.size = function(obj) {
        if (obj == null) return 0;
        return (obj.length === +obj.length) ? obj.length : _.keys(obj).length;
    };
    _.first = _.head = _.take = function(array, n, guard) {
        if (array == null) return void
        0;
        return (n == null) || guard ? array[0] : slice.call(array, 0, n);
    };
    _.initial = function(array, n, guard) {
        return slice.call(array, 0, array.length - ((n == null) || guard ? 1 : n));
    };
    _.last = function(array, n, guard) {
        if (array == null) return void
        0;
        if ((n == null) || guard) {
            return array[array.length - 1];
        } else {
            return slice.call(array, Math.max(array.length - n, 0));
        }
    };
    _.rest = _.tail = _.drop = function(array, n, guard) {
        return slice.call(array, (n == null) || guard ? 1 : n);
    };
    _.compact = function(array) {
        return _.filter(array, _.identity);
    };
    var
        flatten = function(input, shallow, output) {
            if (shallow && _.every(input, _.isArray)) {
                return concat.apply(output, input);
            }
            each(input, function(value) {
                if (_.isArray(value) || _.isArguments(value)) {
                    shallow ? push.apply(output, value) : flatten(value, shallow, output);
                } else {
                    output.push(value);
                }
            });
            return output;
        };
    _.flatten = function(array, shallow) {
        return flatten(array, shallow, []);
    };
    _.without = function(array) {
        return _.difference(array, slice.call(arguments, 1));
    };
    _.uniq = _.unique = function(array, isSorted, iterator, context) {
        if (_.isFunction(isSorted)) {
            context = iterator;
            iterator = isSorted;
            isSorted = false;
        }
        var
            initial = iterator ? _.map(array, iterator, context) : array;
        var
            results = [];
        var
            seen = [];
        each(initial, function(value, index) {
            if (isSorted ? (!index || seen[seen.length - 1] !== value) : !_.contains(seen, value)) {
                seen.push(value);
                results.push(array[index]);
            }
        });
        return results;
    };
    _.union = function() {
        return _.uniq(_.flatten(arguments, true));
    };
    _.intersection = function(array) {
        var
            rest = slice.call(arguments, 1);
        return _.filter(_.uniq(array), function(item) {
            return _.every(rest, function(other) {
                return _.indexOf(other, item) >= 0;
            });
        });
    };
    _.difference = function(array) {
        var
            rest = concat.apply(ArrayProto, slice.call(arguments, 1));
        return _.filter(array, function(value) {
            return !_.contains(rest, value);
        });
    };
    _.zip = function() {
        var
            length = _.max(_.pluck(arguments, "length").concat(0));
        var
            results = new
        Array(length);
        for (var
                i = 0; i < length; i++) {
            results[i] = _.pluck(arguments, '' + i);
        }
        return results;
    };
    _.object = function(list, values) {
        if (list == null) return {};
        var
            result = {};
        for (var
                i = 0, length = list.length; i < length; i++) {
            if (values) {
                result[list[i]] = values[i];
            } else {
                result[list[i][0]] = list[i][1];
            }
        }
        return result;
    };
    _.indexOf = function(array, item, isSorted) {
        if (array == null) return -1;
        var
            i = 0,
            length = array.length;
        if (isSorted) {
            if (typeof isSorted == 'number') {
                i = (isSorted < 0 ? Math.max(0, length + isSorted) : isSorted);
            } else {
                i = _.sortedIndex(array, item);
                return array[i] === item ? i : -1;
            }
        }
        if (nativeIndexOf && array.indexOf === nativeIndexOf) return array.indexOf(item, isSorted);
        for (; i < length; i++)
            if (array[i] === item) return i;
        return -1;
    };
    _.lastIndexOf = function(array, item, from) {
        if (array == null) return -1;
        var
            hasIndex = from != null;
        if (nativeLastIndexOf && array.lastIndexOf === nativeLastIndexOf) {
            return hasIndex ? array.lastIndexOf(item, from) : array.lastIndexOf(item);
        }
        var
            i = (hasIndex ? from : array.length);
        while (i--)
            if (array[i] === item) return i;
        return -1;
    };
    _.range = function(start, stop, step) {
        if (arguments.length <= 1) {
            stop = start || 0;
            start = 0;
        }
        step = arguments[2] || 1;
        var
            length = Math.max(Math.ceil((stop - start) / step), 0);
        var
            idx = 0;
        var
            range = new
        Array(length);
        while (idx < length) {
            range[idx++] = start;
            start += step;
        }
        return range;
    };
    var
        ctor = function() {};
    _.bind = function(func, context) {
        var
            args, bound;
        if (nativeBind && func.bind === nativeBind) return nativeBind.apply(func, slice.call(arguments, 1));
        if (!_.isFunction(func)) throw new
        TypeError;
        args = slice.call(arguments, 2);
        return bound = function() {
            if (!(this instanceof bound)) return func.apply(context, args.concat(slice.call(arguments)));
            ctor.prototype = func.prototype;
            var
                self = new
            ctor;
            ctor.prototype = null;
            var
                result = func.apply(self, args.concat(slice.call(arguments)));
            if (Object(result) === result) return result;
            return self;
        };
    };
    _.partial = function(func) {
        var
            args = slice.call(arguments, 1);
        return function() {
            return func.apply(this, args.concat(slice.call(arguments)));
        };
    };
    _.bindAll = function(obj) {
        var
            funcs = slice.call(arguments, 1);
        if (funcs.length === 0) throw new
        Error("bindAll must be passed function names");
        each(funcs, function(f) {
            obj[f] = _.bind(obj[f], obj);
        });
        return obj;
    };
    _.memoize = function(func, hasher) {
        var
            memo = {};
        hasher || (hasher = _.identity);
        return function() {
            var
                key = hasher.apply(this, arguments);
            return _.has(memo, key) ? memo[key] : (memo[key] = func.apply(this, arguments));
        };
    };
    _.delay = function(func, wait) {
        var
            args = slice.call(arguments, 2);
        return setTimeout(function() {
            return func.apply(null, args);
        }, wait);
    };
    _.defer = function(func) {
        return _.delay.apply(_, [func, 1].concat(slice.call(arguments, 1)));
    };
    _.throttle = function(func, wait, options) {
        var
            context, args, result;
        var
            timeout = null;
        var
            previous = 0;
        options || (options = {});
        var
            later = function() {
                previous = options.leading === false ? 0 : new
                Date;
                timeout = null;
                result = func.apply(context, args);
            };
        return function() {
            var
                now = new
            Date;
            if (!previous && options.leading === false) previous = now;
            var
                remaining = wait - (now - previous);
            context = this;
            args = arguments;
            if (remaining <= 0) {
                clearTimeout(timeout);
                timeout = null;
                previous = now;
                result = func.apply(context, args);
            } else
            if (!timeout && options.trailing !== false) {
                timeout = setTimeout(later, remaining);
            }
            return result;
        };
    };
    _.debounce = function(func, wait, immediate) {
        var
            timeout, args, context, timestamp, result;
        return function() {
            context = this;
            args = arguments;
            timestamp = new
            Date();
            var
                later = function() {
                    var
                        last = (new Date()) - timestamp;
                    if (last < wait) {
                        timeout = setTimeout(later, wait - last);
                    } else {
                        timeout = null;
                        if (!immediate) result = func.apply(context, args);
                    }
                };
            var
                callNow = immediate && !timeout;
            if (!timeout) {
                timeout = setTimeout(later, wait);
            }
            if (callNow) result = func.apply(context, args);
            return result;
        };
    };
    _.once = function(func) {
        var
            ran = false,
            memo;
        return function() {
            if (ran) return memo;
            ran = true;
            memo = func.apply(this, arguments);
            func = null;
            return memo;
        };
    };
    _.wrap = function(func, wrapper) {
        return function() {
            var
                args = [func];
            push.apply(args, arguments);
            return wrapper.apply(this, args);
        };
    };
    _.compose = function() {
        var
            funcs = arguments;
        return function() {
            var
                args = arguments;
            for (var
                    i = funcs.length - 1; i >= 0; i--) {
                args = [funcs[i].apply(this, args)];
            }
            return args[0];
        };
    };
    _.after = function(times, func) {
        return function() {
            if (--times < 1) {
                return func.apply(this, arguments);
            }
        };
    };
    _.keys = nativeKeys || function(obj) {
        if (obj !== Object(obj)) throw new
        TypeError('Invalid object');
        var
            keys = [];
        for (var
                key in
                obj)
            if (_.has(obj, key)) keys.push(key);
        return keys;
    };
    _.values = function(obj) {
        var
            keys = _.keys(obj);
        var
            length = keys.length;
        var
            values = new
        Array(length);
        for (var
                i = 0; i < length; i++) {
            values[i] = obj[keys[i]];
        }
        return values;
    };
    _.pairs = function(obj) {
        var
            keys = _.keys(obj);
        var
            length = keys.length;
        var
            pairs = new
        Array(length);
        for (var
                i = 0; i < length; i++) {
            pairs[i] = [keys[i], obj[keys[i]]];
        }
        return pairs;
    };
    _.invert = function(obj) {
        var
            result = {};
        var
            keys = _.keys(obj);
        for (var
                i = 0, length = keys.length; i < length; i++) {
            result[obj[keys[i]]] = keys[i];
        }
        return result;
    };
    _.functions = _.methods = function(obj) {
        var
            names = [];
        for (var
                key in
                obj) {
            if (_.isFunction(obj[key])) names.push(key);
        }
        return names.sort();
    };
    _.extend = function(obj) {
        each(slice.call(arguments, 1), function(source) {
            if (source) {
                for (var
                        prop in
                        source) {
                    obj[prop] = source[prop];
                }
            }
        });
        return obj;
    };
    _.pick = function(obj) {
        var
            copy = {};
        var
            keys = concat.apply(ArrayProto, slice.call(arguments, 1));
        each(keys, function(key) {
            if (key in
                obj) copy[key] = obj[key];
        });
        return copy;
    };
    _.omit = function(obj) {
        var
            copy = {};
        var
            keys = concat.apply(ArrayProto, slice.call(arguments, 1));
        for (var
                key in
                obj) {
            if (!_.contains(keys, key)) copy[key] = obj[key];
        }
        return copy;
    };
    _.defaults = function(obj) {
        each(slice.call(arguments, 1), function(source) {
            if (source) {
                for (var
                        prop in
                        source) {
                    if (obj[prop] === void 0) obj[prop] = source[prop];
                }
            }
        });
        return obj;
    };
    _.clone = function(obj) {
        if (!_.isObject(obj)) return obj;
        return _.isArray(obj) ? obj.slice() : _.extend({}, obj);
    };
    _.tap = function(obj, interceptor) {
        interceptor(obj);
        return obj;
    };
    var
        eq = function(a, b, aStack, bStack) {
            if (a === b) return a !== 0 || 1 / a == 1 / b;
            if (a == null || b == null) return a === b;
            if (a instanceof _) a = a._wrapped;
            if (b instanceof _) b = b._wrapped;
            var
                className = toString.call(a);
            if (className != toString.call(b)) return false;
            switch (className) {
                case '[object String]':
                    return a == String(b);
                case '[object Number]':
                    return a != +a ? b != +b : (a == 0 ? 1 / a == 1 / b : a == +b);
                case '[object Date]':
                case '[object Boolean]':
                    return +a == +b;
                case '[object RegExp]':
                    return a.source == b.source && a.global == b.global && a.multiline == b.multiline && a.ignoreCase == b.ignoreCase;
            }
            if (typeof a != 'object' || typeof b != 'object') return false;
            var
                length = aStack.length;
            while (length--) {
                if (aStack[length] == a) return bStack[length] == b;
            }
            var
                aCtor = a.constructor,
                bCtor = b.constructor;
            if (aCtor !== bCtor && !(_.isFunction(aCtor) && (aCtor instanceof aCtor) && _.isFunction(bCtor) && (bCtor instanceof bCtor))) {
                return false;
            }
            aStack.push(a);
            bStack.push(b);
            var
                size = 0,
                result = true;
            if (className == '[object Array]') {
                size = a.length;
                result = size == b.length;
                if (result) {
                    while (size--) {
                        if (!(result = eq(a[size], b[size], aStack, bStack))) break;
                    }
                }
            } else {
                for (var
                        key in
                        a) {
                    if (_.has(a, key)) {
                        size++;
                        if (!(result = _.has(b, key) && eq(a[key], b[key], aStack, bStack))) break;
                    }
                }
                if (result) {
                    for (key in
                        b) {
                        if (_.has(b, key) && !(size--)) break;
                    }
                    result = !size;
                }
            }
            aStack.pop();
            bStack.pop();
            return result;
        };
    _.isEqual = function(a, b) {
        return eq(a, b, [], []);
    };
    _.isEmpty = function(obj) {
        if (obj == null) return true;
        if (_.isArray(obj) || _.isString(obj)) return obj.length === 0;
        for (var
                key in
                obj)
            if (_.has(obj, key)) return false;
        return true;
    };
    _.isElement = function(obj) {
        return !!(obj && obj.nodeType === 1);
    };
    _.isArray = nativeIsArray || function(obj) {
        return toString.call(obj) == '[object Array]';
    };
    _.isObject = function(obj) {
        return obj === Object(obj);
    };
    each(['Arguments', 'Function', 'String', 'Number', 'Date', 'RegExp'], function(name) {
        _['is' + name] = function(obj) {
            return toString.call(obj) == '[object ' + name + ']';
        };
    });
    if (!_.isArguments(arguments)) {
        _.isArguments = function(obj) {
            return !!(obj && _.has(obj, 'callee'));
        };
    }
    if (typeof(/./) !== 'function') {
        _.isFunction = function(obj) {
            return typeof
            obj === 'function';
        };
    }
    _.isFinite = function(obj) {
        return isFinite(obj) && !isNaN(parseFloat(obj));
    };
    _.isNaN = function(obj) {
        return _.isNumber(obj) && obj != +obj;
    };
    _.isBoolean = function(obj) {
        return obj === true || obj === false || toString.call(obj) == '[object Boolean]';
    };
    _.isNull = function(obj) {
        return obj === null;
    };
    _.isUndefined = function(obj) {
        return obj === void
        0;
    };
    _.has = function(obj, key) {
        return hasOwnProperty.call(obj, key);
    };
    _.noConflict = function() {
        root._ = previousUnderscore;
        return this;
    };
    _.identity = function(value) {
        return value;
    };
    _.times = function(n, iterator, context) {
        var
            accum = Array(Math.max(0, n));
        for (var
                i = 0; i < n; i++) accum[i] = iterator.call(context, i);
        return accum;
    };
    _.random = function(min, max) {
        if (max == null) {
            max = min;
            min = 0;
        }
        return min + Math.floor(Math.random() * (max - min + 1));
    };
    var
        entityMap = {
            escape: {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#x27;'
            }
        };
    entityMap.unescape = _.invert(entityMap.escape);
    var
        entityRegexes = {
            escape: new
            RegExp('[' + _.keys(entityMap.escape).join('') + ']', 'g'),
            unescape: new
            RegExp('(' + _.keys(entityMap.unescape).join('|') + ')', 'g')
        };
    _.each(['escape', 'unescape'], function(method) {
        _[method] = function(string) {
            if (string == null) return '';
            return ('' + string).replace(entityRegexes[method], function(match) {
                return entityMap[method][match];
            });
        };
    });
    _.result = function(object, property) {
        if (object == null) return void
        0;
        var
            value = object[property];
        return _.isFunction(value) ? value.call(object) : value;
    };
    _.mixin = function(obj) {
        each(_.functions(obj), function(name) {
            var
                func = _[name] = obj[name];
            _.prototype[name] = function() {
                var
                    args = [this._wrapped];
                push.apply(args, arguments);
                return result.call(this, func.apply(_, args));
            };
        });
    };
    var
        idCounter = 0;
    _.uniqueId = function(prefix) {
        var
            id = ++idCounter + '';
        return prefix ? prefix + id : id;
    };
    _.templateSettings = {
        evaluate: /<%([\s\S]+?)%>/g,
        interpolate: /<%=([\s\S]+?)%>/g,
        escape: /<%-([\s\S]+?)%>/g
    };
    var
        noMatch = /(.)^/;
    var
        escapes = {
            "'": "'",
            '\\': '\\',
            '\r': 'r',
            '\n': 'n',
            '\t': 't',
            '\u2028': 'u2028',
            '\u2029': 'u2029'
        };
    var
        escaper = /\\|'|\r|\n|\t|\u2028|\u2029/g;
    _.template = function(text, data, settings) {
        var
            render;
        settings = _.defaults({}, settings, _.templateSettings);
        var
            matcher = new
        RegExp([(settings.escape || noMatch).source, (settings.interpolate || noMatch).source, (settings.evaluate || noMatch).source].join('|') + '|$', 'g');
        var
            index = 0;
        var
            source = "__p+='";
        text.replace(matcher, function(match, escape, interpolate, evaluate, offset) {
            source += text.slice(index, offset).replace(escaper, function(match) {
                return '\\' + escapes[match];
            });
            if (escape) {
                source += "'+\n((__t=(" + escape + "))==null?'':_.escape(__t))+\n'";
            }
            if (interpolate) {
                source += "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'";
            }
            if (evaluate) {
                source += "';\n" + evaluate + "\n__p+='";
            }
            index = offset + match.length;
            return match;
        });
        source += "';\n";
        if (!settings.variable) source = 'with(obj||{}){\n' + source + '}\n';
        source = "var __t,__p='',__j=Array.prototype.join," + "print=function(){__p+=__j.call(arguments,'');};\n" + source + "return __p;\n";
        try {
            render = new
            Function(settings.variable || 'obj', '_', source);
        } catch (e) {
            e.source = source;
            throw e;
        }
        if (data) return render(data, _);
        var
            template = function(data) {
                return render.call(this, data, _);
            };
        template.source = 'function(' + (settings.variable || 'obj') + '){\n' + source + '}';
        return template;
    };
    _.chain = function(obj) {
        return _(obj).chain();
    };
    var
        result = function(obj) {
            return this._chain ? _(obj).chain() : obj;
        };
    _.mixin(_);
    each(['pop', 'push', 'reverse', 'shift', 'sort', 'splice', 'unshift'], function(name) {
        var
            method = ArrayProto[name];
        _.prototype[name] = function() {
            var
                obj = this._wrapped;
            method.apply(obj, arguments);
            if ((name == 'shift' || name == 'splice') && obj.length === 0) delete
            obj[0];
            return result.call(this, obj);
        };
    });
    each(['concat', 'join', 'slice'], function(name) {
        var
            method = ArrayProto[name];
        _.prototype[name] = function() {
            return result.call(this, method.apply(this._wrapped, arguments));
        };
    });
    _.extend(_.prototype, {
        chain: function() {
            this._chain = true;
            return this;
        },
        value: function() {
            return this._wrapped;
        }
    });
}).call(this);
if (jQuery)(function($) {
    $.minicolors = {
        defaults: {
            animationSpeed: 50,
            animationEasing: 'swing',
            change: null,
            changeDelay: 0,
            control: 'hue',
            defaultValue: '',
            hide: null,
            hideSpeed: 100,
            inline: false,
            letterCase: 'lowercase',
            opacity: false,
            position: 'bottom left',
            show: null,
            showSpeed: 100,
            theme: 'default'
        }
    };
    $.extend($.fn, {
        minicolors: function(method, data) {
            switch (method) {
                case 'destroy':
                    $(this).each(function() {
                        destroy($(this));
                    });
                    return $(this);
                case 'hide':
                    hide();
                    return $(this);
                case 'opacity':
                    if (data === undefined) {
                        return $(this).attr('data-opacity');
                    } else {
                        $(this).each(function() {
                            updateFromInput($(this).attr('data-opacity', data));
                        });
                    }
                    return $(this);
                case 'rgbObject':
                    return rgbObject($(this), method === 'rgbaObject');
                case 'rgbString':
                case 'rgbaString':
                    return rgbString($(this), method === 'rgbaString');
                case 'settings':
                    if (data === undefined) {
                        return $(this).data('minicolors-settings');
                    } else {
                        $(this).each(function() {
                            var
                                settings = $(this).data('minicolors-settings') || {};
                            destroy($(this));
                            $(this).minicolors($.extend(true, settings, data));
                        });
                    }
                    return $(this);
                case 'show':
                    show($(this).eq(0));
                    return $(this);
                case 'value':
                    if (data === undefined) {
                        return $(this).val();
                    } else {
                        $(this).each(function() {
                            updateFromInput($(this).val(data));
                        });
                    }
                    return $(this);
                default:
                    if (method !== 'create') data = method;
                    $(this).each(function() {
                        init($(this), data);
                    });
                    return $(this);
            }
        }
    });

    function
    init(input, settings) {
        var
            minicolors = $('<div class="minicolors" />'),
            defaults = $.minicolors.defaults;
        if (input.data('minicolors-initialized')) return;
        settings = $.extend(true, {}, defaults, settings);
        minicolors.addClass('minicolors-theme-' + settings.theme).toggleClass('minicolors-with-opacity', settings.opacity);
        if (settings.position !== undefined) {
            $.each(settings.position.split(' '), function() {
                minicolors.addClass('minicolors-position-' + this);
            });
        }
        input.addClass('minicolors-input').data('minicolors-initialized', true).data('minicolors-settings', settings).prop('size', 7).wrap(minicolors).after('<div class="minicolors-panel minicolors-slider-' + settings.control + '">' + '<div class="minicolors-slider">' + '<div class="minicolors-picker"></div>' + '</div>' + '<div class="minicolors-opacity-slider">' + '<div class="minicolors-picker"></div>' + '</div>' + '<div class="minicolors-grid">' + '<div class="minicolors-grid-inner"></div>' + '<div class="minicolors-picker"><div></div></div>' + '</div>' + '</div>');
        if (!settings.inline) {
            input.after('<span class="minicolors-swatch"><span class="minicolors-swatch-color"></span></span>');
            input.next('.minicolors-swatch').on('click', function(event) {
                event.preventDefault();
                input.focus();
            });
        }
        input.parent().find('.minicolors-panel').on('selectstart', function() {
            return false;
        }).end();
        if (settings.inline) input.parent().addClass('minicolors-inline');
        updateFromInput(input, false);
        input.data('minicolors-lastChange', {
            hex: input.val(),
            opacity: input.attr('data-opacity')
        });
    }

    function
    destroy(input) {
        var
            minicolors = input.parent();
        input.removeData('minicolors-initialized').removeData('minicolors-settings').removeProp('size').removeClass('minicolors-input');
        minicolors.before(input).remove();
    }

    function
    show(input) {
        var
            minicolors = input.parent(),
            panel = minicolors.find('.minicolors-panel'),
            settings = input.data('minicolors-settings');
        if (!input.data('minicolors-initialized') || input.prop('disabled') || minicolors.hasClass('minicolors-inline') || minicolors.hasClass('minicolors-focus')) return;
        hide();
        minicolors.addClass('minicolors-focus');
        panel.stop(true, true).fadeIn(settings.showSpeed, function() {
            if (settings.show) settings.show.call(input.get(0));
        });
    }

    function
    hide() {
        $('.minicolors-input').each(function() {
            var
                input = $(this),
                settings = input.data('minicolors-settings'),
                minicolors = input.parent();
            if (settings.inline) return;
            minicolors.find('.minicolors-panel').fadeOut(settings.hideSpeed, function() {
                if (minicolors.hasClass('minicolors-focus')) {
                    if (settings.hide) settings.hide.call(input.get(0));
                }
                minicolors.removeClass('minicolors-focus');
            });
        });
    }

    function
    move(target, event, animate) {
        var
            input = target.parents('.minicolors').find('.minicolors-input'),
            settings = input.data('minicolors-settings'),
            picker = target.find('[class$=-picker]'),
            offsetX = target.offset().left,
            offsetY = target.offset().top,
            x = Math.round(event.pageX - offsetX),
            y = Math.round(event.pageY - offsetY),
            duration = animate ? settings.animationSpeed : 0,
            wx, wy, r, phi;
        if (event.originalEvent.changedTouches) {
            x = event.originalEvent.changedTouches[0].pageX - offsetX;
            y = event.originalEvent.changedTouches[0].pageY - offsetY;
        }
        if (x < 0) x = 0;
        if (y < 0) y = 0;
        if (x > target.width()) x = target.width();
        if (y > target.height()) y = target.height();
        if (target.parent().is('.minicolors-slider-wheel') && picker.parent().is('.minicolors-grid')) {
            wx = 75 - x;
            wy = 75 - y;
            r = Math.sqrt(wx * wx + wy * wy);
            phi = Math.atan2(wy, wx);
            if (phi < 0) phi += Math.PI * 2;
            if (r > 75) {
                r = 75;
                x = 75 - (75 * Math.cos(phi));
                y = 75 - (75 * Math.sin(phi));
            }
            x = Math.round(x);
            y = Math.round(y);
        }
        if (target.is('.minicolors-grid')) {
            picker.stop(true).animate({
                top: y + 'px',
                left: x + 'px'
            }, duration, settings.animationEasing, function() {
                updateFromControl(input, target);
            });
        } else {
            picker.stop(true).animate({
                top: y + 'px'
            }, duration, settings.animationEasing, function() {
                updateFromControl(input, target);
            });
        }
    }

    function
    updateFromControl(input, target) {
        function
        getCoords(picker, container) {
            var
                left, top;
            if (!picker.length || !container) return null;
            left = picker.offset().left;
            top = picker.offset().top;
            return {
                x: left - container.offset().left + (picker.outerWidth() / 2),
                y: top - container.offset().top + (picker.outerHeight() / 2)
            };
        }
        var
            hue, saturation, brightness, x, y, r, phi, hex = input.val(),
            opacity = input.attr('data-opacity'),
            minicolors = input.parent(),
            settings = input.data('minicolors-settings'),
            swatch = minicolors.find('.minicolors-swatch'),
            grid = minicolors.find('.minicolors-grid'),
            slider = minicolors.find('.minicolors-slider'),
            opacitySlider = minicolors.find('.minicolors-opacity-slider'),
            gridPicker = grid.find('[class$=-picker]'),
            sliderPicker = slider.find('[class$=-picker]'),
            opacityPicker = opacitySlider.find('[class$=-picker]'),
            gridPos = getCoords(gridPicker, grid),
            sliderPos = getCoords(sliderPicker, slider),
            opacityPos = getCoords(opacityPicker, opacitySlider);
        if (target.is('.minicolors-grid, .minicolors-slider')) {
            switch (settings.control) {
                case 'wheel':
                    x = (grid.width() / 2) - gridPos.x;
                    y = (grid.height() / 2) - gridPos.y;
                    r = Math.sqrt(x * x + y * y);
                    phi = Math.atan2(y, x);
                    if (phi < 0) phi += Math.PI * 2;
                    if (r > 75) {
                        r = 75;
                        gridPos.x = 69 - (75 * Math.cos(phi));
                        gridPos.y = 69 - (75 * Math.sin(phi));
                    }
                    saturation = keepWithin(r / 0.75, 0, 100);
                    hue = keepWithin(phi * 180 / Math.PI, 0, 360);
                    brightness = keepWithin(100 - Math.floor(sliderPos.y * (100 / slider.height())), 0, 100);
                    hex = hsb2hex({
                        h: hue,
                        s: saturation,
                        b: brightness
                    });
                    slider.css('backgroundColor', hsb2hex({
                        h: hue,
                        s: saturation,
                        b: 100
                    }));
                    break;
                case 'saturation':
                    hue = keepWithin(parseInt(gridPos.x * (360 / grid.width()), 10), 0, 360);
                    saturation = keepWithin(100 - Math.floor(sliderPos.y * (100 / slider.height())), 0, 100);
                    brightness = keepWithin(100 - Math.floor(gridPos.y * (100 / grid.height())), 0, 100);
                    hex = hsb2hex({
                        h: hue,
                        s: saturation,
                        b: brightness
                    });
                    slider.css('backgroundColor', hsb2hex({
                        h: hue,
                        s: 100,
                        b: brightness
                    }));
                    minicolors.find('.minicolors-grid-inner').css('opacity', saturation / 100);
                    break;
                case 'brightness':
                    hue = keepWithin(parseInt(gridPos.x * (360 / grid.width()), 10), 0, 360);
                    saturation = keepWithin(100 - Math.floor(gridPos.y * (100 / grid.height())), 0, 100);
                    brightness = keepWithin(100 - Math.floor(sliderPos.y * (100 / slider.height())), 0, 100);
                    hex = hsb2hex({
                        h: hue,
                        s: saturation,
                        b: brightness
                    });
                    slider.css('backgroundColor', hsb2hex({
                        h: hue,
                        s: saturation,
                        b: 100
                    }));
                    minicolors.find('.minicolors-grid-inner').css('opacity', 1 - (brightness / 100));
                    break;
                default:
                    hue = keepWithin(360 - parseInt(sliderPos.y * (360 / slider.height()), 10), 0, 360);
                    saturation = keepWithin(Math.floor(gridPos.x * (100 / grid.width())), 0, 100);
                    brightness = keepWithin(100 - Math.floor(gridPos.y * (100 / grid.height())), 0, 100);
                    hex = hsb2hex({
                        h: hue,
                        s: saturation,
                        b: brightness
                    });
                    grid.css('backgroundColor', hsb2hex({
                        h: hue,
                        s: 100,
                        b: 100
                    }));
                    break;
            }
            input.val(convertCase(hex, settings.letterCase));
        }
        if (target.is('.minicolors-opacity-slider')) {
            if (settings.opacity) {
                opacity = parseFloat(1 - (opacityPos.y / opacitySlider.height())).toFixed(2);
            } else {
                opacity = 1;
            }
            if (settings.opacity) input.attr('data-opacity', opacity);
        }
        swatch.find('SPAN').css({
            backgroundColor: hex,
            opacity: opacity
        });
        doChange(input, hex, opacity);
    }

    function
    updateFromInput(input, preserveInputValue) {
        var
            hex, hsb, opacity, x, y, r, phi, minicolors = input.parent(),
            settings = input.data('minicolors-settings'),
            swatch = minicolors.find('.minicolors-swatch'),
            grid = minicolors.find('.minicolors-grid'),
            slider = minicolors.find('.minicolors-slider'),
            opacitySlider = minicolors.find('.minicolors-opacity-slider'),
            gridPicker = grid.find('[class$=-picker]'),
            sliderPicker = slider.find('[class$=-picker]'),
            opacityPicker = opacitySlider.find('[class$=-picker]');
        hex = convertCase(parseHex(input.val(), true), settings.letterCase);
        if (!hex) {
            hex = convertCase(parseHex(settings.defaultValue, true), settings.letterCase);
        }
        hsb = hex2hsb(hex);
        if (!preserveInputValue) input.val(hex);
        if (settings.opacity) {
            opacity = input.attr('data-opacity') === '' ? 1 : keepWithin(parseFloat(input.attr('data-opacity')).toFixed(2), 0, 1);
            if (isNaN(opacity)) opacity = 1;
            input.attr('data-opacity', opacity);
            swatch.find('SPAN').css('opacity', opacity);
            y = keepWithin(opacitySlider.height() - (opacitySlider.height() * opacity), 0, opacitySlider.height());
            opacityPicker.css('top', y + 'px');
        }
        swatch.find('SPAN').css('backgroundColor', hex);
        switch (settings.control) {
            case 'wheel':
                r = keepWithin(Math.ceil(hsb.s * 0.75), 0, grid.height() / 2);
                phi = hsb.h * Math.PI / 180;
                x = keepWithin(75 - Math.cos(phi) * r, 0, grid.width());
                y = keepWithin(75 - Math.sin(phi) * r, 0, grid.height());
                gridPicker.css({
                    top: y + 'px',
                    left: x + 'px'
                });
                y = 150 - (hsb.b / (100 / grid.height()));
                if (hex === '') y = 0;
                sliderPicker.css('top', y + 'px');
                slider.css('backgroundColor', hsb2hex({
                    h: hsb.h,
                    s: hsb.s,
                    b: 100
                }));
                break;
            case 'saturation':
                x = keepWithin((5 * hsb.h) / 12, 0, 150);
                y = keepWithin(grid.height() - Math.ceil(hsb.b / (100 / grid.height())), 0, grid.height());
                gridPicker.css({
                    top: y + 'px',
                    left: x + 'px'
                });
                y = keepWithin(slider.height() - (hsb.s * (slider.height() / 100)), 0, slider.height());
                sliderPicker.css('top', y + 'px');
                slider.css('backgroundColor', hsb2hex({
                    h: hsb.h,
                    s: 100,
                    b: hsb.b
                }));
                minicolors.find('.minicolors-grid-inner').css('opacity', hsb.s / 100);
                break;
            case 'brightness':
                x = keepWithin((5 * hsb.h) / 12, 0, 150);
                y = keepWithin(grid.height() - Math.ceil(hsb.s / (100 / grid.height())), 0, grid.height());
                gridPicker.css({
                    top: y + 'px',
                    left: x + 'px'
                });
                y = keepWithin(slider.height() - (hsb.b * (slider.height() / 100)), 0, slider.height());
                sliderPicker.css('top', y + 'px');
                slider.css('backgroundColor', hsb2hex({
                    h: hsb.h,
                    s: hsb.s,
                    b: 100
                }));
                minicolors.find('.minicolors-grid-inner').css('opacity', 1 - (hsb.b / 100));
                break;
            default:
                x = keepWithin(Math.ceil(hsb.s / (100 / grid.width())), 0, grid.width());
                y = keepWithin(grid.height() - Math.ceil(hsb.b / (100 / grid.height())), 0, grid.height());
                gridPicker.css({
                    top: y + 'px',
                    left: x + 'px'
                });
                y = keepWithin(slider.height() - (hsb.h / (360 / slider.height())), 0, slider.height());
                sliderPicker.css('top', y + 'px');
                grid.css('backgroundColor', hsb2hex({
                    h: hsb.h,
                    s: 100,
                    b: 100
                }));
                break;
        }
    }

    function
    doChange(input, hex, opacity) {
        var
            settings = input.data('minicolors-settings'),
            lastChange = input.data('minicolors-lastChange');
        if (lastChange.hex !== hex || lastChange.opacity !== opacity) {
            input.data('minicolors-lastChange', {
                hex: hex,
                opacity: opacity
            });
            if (settings.change) {
                if (settings.changeDelay) {
                    clearTimeout(input.data('minicolors-changeTimeout'));
                    input.data('minicolors-changeTimeout', setTimeout(function() {
                        settings.change.call(input.get(0), hex, opacity);
                    }, settings.changeDelay));
                } else {
                    settings.change.call(input.get(0), hex, opacity);
                }
            }
            input.trigger('change').trigger('input');
        }
    }

    function
    rgbObject(input) {
        var
            hex = parseHex($(input).val(), true),
            rgb = hex2rgb(hex),
            opacity = $(input).attr('data-opacity');
        if (!rgb) return null;
        if (opacity !== undefined) $.extend(rgb, {
            a: parseFloat(opacity)
        });
        return rgb;
    }

    function
    rgbString(input, alpha) {
        var
            hex = parseHex($(input).val(), true),
            rgb = hex2rgb(hex),
            opacity = $(input).attr('data-opacity');
        if (!rgb) return null;
        if (opacity === undefined) opacity = 1;
        if (alpha) {
            return 'rgba(' + rgb.r + ', ' + rgb.g + ', ' + rgb.b + ', ' + parseFloat(opacity) + ')';
        } else {
            return 'rgb(' + rgb.r + ', ' + rgb.g + ', ' + rgb.b + ')';
        }
    }

    function
    convertCase(string, letterCase) {
        return letterCase === 'uppercase' ? string.toUpperCase() : string.toLowerCase();
    }

    function
    parseHex(string, expand) {
        string = string.replace(/[^A-F0-9]/ig, '');
        if (string.length !== 3 && string.length !== 6) return '';
        if (string.length === 3 && expand) {
            string = string[0] + string[0] + string[1] + string[1] + string[2] + string[2];
        }
        return '#' + string;
    }

    function
    keepWithin(value, min, max) {
        if (value < min) value = min;
        if (value > max) value = max;
        return value;
    }

    function
    hsb2rgb(hsb) {
        var
            rgb = {};
        var
            h = Math.round(hsb.h);
        var
            s = Math.round(hsb.s * 255 / 100);
        var
            v = Math.round(hsb.b * 255 / 100);
        if (s === 0) {
            rgb.r = rgb.g = rgb.b = v;
        } else {
            var
                t1 = v;
            var
                t2 = (255 - s) * v / 255;
            var
                t3 = (t1 - t2) * (h % 60) / 60;
            if (h === 360) h = 0;
            if (h < 60) {
                rgb.r = t1;
                rgb.b = t2;
                rgb.g = t2 + t3;
            } else
            if (h < 120) {
                rgb.g = t1;
                rgb.b = t2;
                rgb.r = t1 - t3;
            } else
            if (h < 180) {
                rgb.g = t1;
                rgb.r = t2;
                rgb.b = t2 + t3;
            } else
            if (h < 240) {
                rgb.b = t1;
                rgb.r = t2;
                rgb.g = t1 - t3;
            } else
            if (h < 300) {
                rgb.b = t1;
                rgb.g = t2;
                rgb.r = t2 + t3;
            } else
            if (h < 360) {
                rgb.r = t1;
                rgb.g = t2;
                rgb.b = t1 - t3;
            } else {
                rgb.r = 0;
                rgb.g = 0;
                rgb.b = 0;
            }
        }
        return {
            r: Math.round(rgb.r),
            g: Math.round(rgb.g),
            b: Math.round(rgb.b)
        };
    }

    function
    rgb2hex(rgb) {
        var
            hex = [rgb.r.toString(16), rgb.g.toString(16), rgb.b.toString(16)];
        $.each(hex, function(nr, val) {
            if (val.length === 1) hex[nr] = '0' + val;
        });
        return '#' + hex.join('');
    }

    function
    hsb2hex(hsb) {
        return rgb2hex(hsb2rgb(hsb));
    }

    function
    hex2hsb(hex) {
        var
            hsb = rgb2hsb(hex2rgb(hex));
        if (hsb.s === 0) hsb.h = 360;
        return hsb;
    }

    function
    rgb2hsb(rgb) {
        var
            hsb = {
                h: 0,
                s: 0,
                b: 0
            };
        var
            min = Math.min(rgb.r, rgb.g, rgb.b);
        var
            max = Math.max(rgb.r, rgb.g, rgb.b);
        var
            delta = max - min;
        hsb.b = max;
        hsb.s = max !== 0 ? 255 * delta / max : 0;
        if (hsb.s !== 0) {
            if (rgb.r === max) {
                hsb.h = (rgb.g - rgb.b) / delta;
            } else
            if (rgb.g === max) {
                hsb.h = 2 + (rgb.b - rgb.r) / delta;
            } else {
                hsb.h = 4 + (rgb.r - rgb.g) / delta;
            }
        } else {
            hsb.h = -1;
        }
        hsb.h *= 60;
        if (hsb.h < 0) {
            hsb.h += 360;
        }
        hsb.s *= 100 / 255;
        hsb.b *= 100 / 255;
        return hsb;
    }

    function
    hex2rgb(hex) {
        hex = parseInt(((hex.indexOf('#') > -1) ? hex.substring(1) : hex), 16);
        return {
            r: hex >> 16,
            g: (hex & 0x00FF00) >> 8,
            b: (hex & 0x0000FF)
        };
    }
    $(document).on('mousedown.minicolors touchstart.minicolors', function(event) {
        if (!$(event.target).parents().add(event.target).hasClass('minicolors')) {
            hide();
        }
    }).on('mousedown.minicolors touchstart.minicolors', '.minicolors-grid, .minicolors-slider, .minicolors-opacity-slider', function(event) {
        var
            target = $(this);
        event.preventDefault();
        $(document).data('minicolors-target', target);
        move(target, event, true);
    }).on('mousemove.minicolors touchmove.minicolors', function(event) {
        var
            target = $(document).data('minicolors-target');
        if (target) move(target, event);
    }).on('mouseup.minicolors touchend.minicolors', function() {
        $(this).removeData('minicolors-target');
    }).on('mousedown.minicolors touchstart.minicolors', '.minicolors-swatch', function(event) {
        var
            input = $(this).parent().find('.minicolors-input');
        event.preventDefault();
        show(input);
    }).on('focus.minicolors', '.minicolors-input', function() {
        var
            input = $(this);
        if (!input.data('minicolors-initialized')) return;
        show(input);
    }).on('blur.minicolors', '.minicolors-input', function() {
        var
            input = $(this),
            settings = input.data('minicolors-settings');
        if (!input.data('minicolors-initialized')) return;
        input.val(parseHex(input.val(), true));
        if (input.val() === '') input.val(parseHex(settings.defaultValue, true));
        input.val(convertCase(input.val(), settings.letterCase));
    }).on('keydown.minicolors', '.minicolors-input', function(event) {
        var
            input = $(this);
        if (!input.data('minicolors-initialized')) return;
        switch (event.keyCode) {
            case
            9:
                hide();
                break;
            case
            13:
            case
            27:
                hide();
                input.blur();
                break;
        }
    }).on('keyup.minicolors', '.minicolors-input', function() {
        var
            input = $(this);
        if (!input.data('minicolors-initialized')) return;
        updateFromInput(input, true);
    }).on('paste.minicolors', '.minicolors-input', function() {
        var
            input = $(this);
        if (!input.data('minicolors-initialized')) return;
        setTimeout(function() {
            updateFromInput(input, true);
        }, 1);
    });
})(jQuery);
! function($) {
    "use strict";
    $.fn['bootstrapSwitch'] = function(method) {
        var
            inputSelector = 'input[type!="hidden"]';
        var
            methods = {
                init: function() {
                    return this.each(function() {
                        var
                            $element = $(this),
                            $div, $switchLeft, $switchRight, $label, $form = $element.closest('form'),
                            myClasses = "",
                            classes = $element.attr('class'),
                            color, moving, onLabel = "ON",
                            offLabel = "OFF",
                            icon = false,
                            textLabel = false;
                        $.each(['switch-mini', 'switch-small', 'switch-large'], function(i, el) {
                            if (classes.indexOf(el) >= 0) myClasses = el
                        });
                        $element.addClass('has-switch');
                        if ($element.data('on') !== undefined) color = "switch-" + $element.data('on');
                        if ($element.data('on-label') !== undefined) onLabel = $element.data('on-label');
                        if ($element.data('off-label') !== undefined) offLabel = $element.data('off-label');
                        if ($element.data('label-icon') !== undefined) icon = $element.data('label-icon');
                        if ($element.data('text-label') !== undefined) textLabel = $element.data('text-label');
                        $switchLeft = $('<span>').addClass("switch-left").addClass(myClasses).addClass(color).html(onLabel);
                        color = '';
                        if ($element.data('off') !== undefined) color = "switch-" + $element.data('off');
                        $switchRight = $('<span>').addClass("switch-right").addClass(myClasses).addClass(color).html(offLabel);
                        $label = $('<label>').html("&nbsp;").addClass(myClasses).attr('for', $element.find(inputSelector).attr('id'));
                        if (icon) {
                            $label.html('<i class="icon ' + icon + '"></i>')
                        }
                        if (textLabel) {
                            $label.html('' + textLabel + '')
                        }
                        $div = $element.find(inputSelector).wrap($('<div>')).parent().data('animated', false);
                        if ($element.data('animated') !== false) $div.addClass('switch-animate').data('animated', true);
                        $div.append($switchLeft).append($label).append($switchRight);
                        $element.find('>div').addClass($element.find(inputSelector).is(':checked') ? 'switch-on' : 'switch-off');
                        if ($element.find(inputSelector).is(':disabled')) $(this).addClass('deactivate');
                        var
                            changeStatus = function($this) {
                                if ($element.parent('label').is('.label-change-switch')) {} else {
                                    $this.siblings('label').trigger('mousedown').trigger('mouseup').trigger('click')
                                }
                            };
                        $element.on('keydown', function(e) {
                            if (e.keyCode === 32) {
                                e.stopImmediatePropagation();
                                e.preventDefault();
                                changeStatus($(e.target).find('span:first'))
                            }
                        });
                        $switchLeft.on('click', function(e) {
                            changeStatus($(this))
                        });
                        $switchRight.on('click', function(e) {
                            changeStatus($(this))
                        });
                        $element.find(inputSelector).on('change', function(e, skipOnChange) {
                            var
                                $this = $(this),
                                $element = $this.parent(),
                                thisState = $this.is(':checked'),
                                state = $element.is('.switch-off');
                            e.preventDefault();
                            $element.css('left', '');
                            if (state === thisState) {
                                if (thisState) $element.removeClass('switch-off').addClass('switch-on');
                                else
                                    $element.removeClass('switch-on').addClass('switch-off');
                                if ($element.data('animated') !== false) $element.addClass("switch-animate");
                                if (typeof skipOnChange === 'boolean' && skipOnChange) return;
                                $element.parent().trigger('switch-change', {
                                    'el': $this,
                                    'value': thisState
                                })
                            }
                        });
                        $element.find('label').on('mousedown touchstart', function(e) {
                            var
                                $this = $(this);
                            moving = false;
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            $this.closest('div').removeClass('switch-animate');
                            if ($this.closest('.has-switch').is('.deactivate')) {
                                $this.unbind('click')
                            } else
                            if ($this.closest('.switch-on').parent().is('.radio-no-uncheck')) {
                                $this.unbind('click')
                            } else {
                                $this.on('mousemove touchmove', function(e) {
                                    var
                                        $element = $(this).closest('.make-switch'),
                                        relativeX = (e.pageX || e.originalEvent.targetTouches[0].pageX) - $element.offset().left,
                                        percent = (relativeX / $element.width()) * 100,
                                        left = 25,
                                        right = 75;
                                    moving = true;
                                    if (percent < left) percent = left;
                                    else
                                    if (percent > right) percent = right;
                                    $element.find('>div').css('left', (percent - right) + "%")
                                });
                                $this.on('click touchend', function(e) {
                                    var
                                        $this = $(this),
                                        $target = $(e.target),
                                        $myRadioCheckBox = $target.siblings('input');
                                    e.stopImmediatePropagation();
                                    e.preventDefault();
                                    $this.unbind('mouseleave');
                                    if (moving) $myRadioCheckBox.prop('checked', !(parseInt($this.parent().css('left')) < -25));
                                    else
                                        $myRadioCheckBox.prop("checked", !$myRadioCheckBox.is(":checked"));
                                    moving = false;
                                    $myRadioCheckBox.trigger('change')
                                });
                                $this.on('mouseleave', function(e) {
                                    var
                                        $this = $(this),
                                        $myInputBox = $this.siblings('input');
                                    e.preventDefault();
                                    e.stopImmediatePropagation();
                                    $this.unbind('mouseleave');
                                    $this.trigger('mouseup');
                                    $myInputBox.prop('checked', !(parseInt($this.parent().css('left')) < -25)).trigger('change')
                                });
                                $this.on('mouseup', function(e) {
                                    e.stopImmediatePropagation();
                                    e.preventDefault();
                                    $(this).unbind('mousemove')
                                })
                            }
                        });
                        if ($form.data('bootstrapSwitch') !== 'injected') {
                            $form.bind('reset', function() {
                                setTimeout(function() {
                                    $form.find('.make-switch').each(function() {
                                        var
                                            $input = $(this).find(inputSelector);
                                        $input.prop('checked', $input.is(':checked')).trigger('change')
                                    })
                                }, 1)
                            });
                            $form.data('bootstrapSwitch', 'injected')
                        }
                    })
                },
                toggleActivation: function() {
                    var
                        $this = $(this);
                    $this.toggleClass('deactivate');
                    $this.find(inputSelector).prop('disabled', $this.is('.deactivate'))
                },
                isActive: function() {
                    return !$(this).hasClass('deactivate')
                },
                setActive: function(active) {
                    var
                        $this = $(this);
                    if (active) {
                        $this.removeClass('deactivate');
                        $this.find(inputSelector).removeAttr('disabled')
                    } else {
                        $this.addClass('deactivate');
                        $this.find(inputSelector).attr('disabled', 'disabled')
                    }
                },
                toggleState: function(skipOnChange) {
                    var
                        $input = $(this).find(':checkbox');
                    $input.prop('checked', !$input.is(':checked')).trigger('change', skipOnChange)
                },
                toggleRadioState: function(skipOnChange) {
                    var
                        $radioinput = $(this).find(':radio');
                    $radioinput.not(':checked').prop('checked', !$radioinput.is(':checked')).trigger('change', skipOnChange)
                },
                toggleRadioStateAllowUncheck: function(uncheck, skipOnChange) {
                    var
                        $radioinput = $(this).find(':radio');
                    if (uncheck) {
                        $radioinput.not(':checked').trigger('change', skipOnChange)
                    } else {
                        $radioinput.not(':checked').prop('checked', !$radioinput.is(':checked')).trigger('change', skipOnChange)
                    }
                },
                setState: function(value, skipOnChange) {
                    $(this).find(inputSelector).prop('checked', value).trigger('change', skipOnChange)
                },
                setOnLabel: function(value) {
                    var
                        $switchLeft = $(this).find(".switch-left");
                    $switchLeft.html(value)
                },
                setOffLabel: function(value) {
                    var
                        $switchRight = $(this).find(".switch-right");
                    $switchRight.html(value)
                },
                setOnClass: function(value) {
                    var
                        $switchLeft = $(this).find(".switch-left");
                    var
                        color = '';
                    if (value !== undefined) {
                        if ($(this).attr('data-on') !== undefined) {
                            color = "switch-" + $(this).attr('data-on')
                        }
                        $switchLeft.removeClass(color);
                        color = "switch-" + value;
                        $switchLeft.addClass(color)
                    }
                },
                setOffClass: function(value) {
                    var
                        $switchRight = $(this).find(".switch-right");
                    var
                        color = '';
                    if (value !== undefined) {
                        if ($(this).attr('data-off') !== undefined) {
                            color = "switch-" + $(this).attr('data-off')
                        }
                        $switchRight.removeClass(color);
                        color = "switch-" + value;
                        $switchRight.addClass(color)
                    }
                },
                setAnimated: function(value) {
                    var
                        $element = $(this).find(inputSelector).parent();
                    if (value === undefined) value = false;
                    $element.data('animated', value);
                    $element.attr('data-animated', value);
                    if ($element.data('animated') !== false) {
                        $element.addClass("switch-animate")
                    } else {
                        $element.removeClass("switch-animate")
                    }
                },
                setSizeClass: function(value) {
                    var
                        $element = $(this);
                    var
                        $switchLeft = $element.find(".switch-left");
                    var
                        $switchRight = $element.find(".switch-right");
                    var
                        $label = $element.find("label");
                    $.each(['switch-mini', 'switch-small', 'switch-large'], function(i, el) {
                        if (el !== value) {
                            $switchLeft.removeClass(el);
                            $switchRight.removeClass(el);
                            $label.removeClass(el)
                        } else {
                            $switchLeft.addClass(el);
                            $switchRight.addClass(el);
                            $label.addClass(el)
                        }
                    })
                },
                status: function() {
                    return $(this).find(inputSelector).is(':checked')
                },
                destroy: function() {
                    var
                        $element = $(this),
                        $div = $element.find('div'),
                        $form = $element.closest('form'),
                        $inputbox;
                    $div.find(':not(input)').remove();
                    $inputbox = $div.children();
                    $inputbox.unwrap().unwrap();
                    $inputbox.unbind('change');
                    if ($form) {
                        $form.unbind('reset');
                        $form.removeData('bootstrapSwitch')
                    }
                    return $inputbox
                }
            };
        if (methods[method]) return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
        else
        if (typeof method === 'object' || !method) return methods.init.apply(this, arguments);
        else
            $.error('Method ' + method + ' does not exist!')
    }
}(jQuery);
(function($) {
    $(function() {
        $('.make-switch')['bootstrapSwitch']()
    })
})(jQuery);
(function() {
    function
    normalize360(v) {
        v = v % 360;
        return v < 0 ? 360 + v : v
    }

    function
    unsigned(i) {
        return i >>> 0
    }

    function
    trimLc(s) {
        return s.replace(/^\s+/, "").replace(/\s+$/, "").toLowerCase()
    }

    function
    slice(obj, index) {
        return Array.prototype.slice.call(obj, index)
    }

    function
    append(arr, value) {
        arr.push(value);
        return arr
    }

    function
    clamp(x, a, b) {
        return !(x > a) ? a : !(x < b) ? b : x
    }

    function
    mix(x, y, a) {
        return (1 - a) * x + a * y
    }

    function
    f2b(f) {
        f = Math.round(255 * f);
        if (!(f > 0)) return 0;
        else
        if (!(f < 255)) return 255;
        else
            return f & 255
    }

    function
    b2f(b) {
        return b / 255
    }

    function
    rgbToHsl(r, g, b) {
        var
            max = Math.max(r, g, b),
            min = Math.min(r, g, b);
        var
            h, s, l = (max + min) / 2;
        if (max == min) {
            h = s = 0
        } else {
            var
                d = max - min;
            s = l > .5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
                case
                r:
                    h = (g - b) / d + (g < b ? 6 : 0);
                    break;
                case
                g:
                    h = (b - r) / d + 2;
                    break;
                case
                b:
                    h = (r - g) / d + 4;
                    break
            }
            h /= 6
        }
        return [h, s, l]
    }

    function
    hslToRgb(h, s, l) {
        var
            r, g, b;
        if (s == 0) {
            r = g = b = l
        } else {
            function
            hue2rgb(p, q, t) {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1 / 6) return p + (q - p) * 6 * t;
                if (t < 1 / 2) return q;
                if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                return p
            }
            var
                q = l < .5 ? l * (1 + s) : l + s - l * s;
            var
                p = 2 * l - q;
            r = hue2rgb(p, q, h + 1 / 3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1 / 3)
        }
        return [r, g, b]
    }

    function
    hex4ToRgba(color) {
        var
            rgba = [parseInt(color.substr(1, 1), 16), parseInt(color.substr(2, 1), 16), parseInt(color.substr(3, 1), 16), 1];
        for (var
                i = 0; i < 3; ++i) rgba[i] = (rgba[i] * 16 + rgba[i]) / 255;
        return rgba
    }

    function
    hex7ToRgba(color) {
        return [parseInt(color.substr(1, 2), 16) / 255, parseInt(color.substr(3, 2), 16) / 255, parseInt(color.substr(5, 2), 16) / 255, 1]
    }
    var
        namedColors = {
            aliceblue: [240, 248, 255],
            antiquewhite: [250, 235, 215],
            aqua: [0, 255, 255],
            aquamarine: [127, 255, 212],
            azure: [240, 255, 255],
            beige: [245, 245, 220],
            bisque: [255, 228, 196],
            black: [0, 0, 0],
            blanchedalmond: [255, 235, 205],
            blue: [0, 0, 255],
            blueviolet: [138, 43, 226],
            brown: [165, 42, 42],
            burlywood: [222, 184, 135],
            cadetblue: [95, 158, 160],
            chartreuse: [127, 255, 0],
            chocolate: [210, 105, 30],
            coral: [255, 127, 80],
            cornflowerblue: [100, 149, 237],
            cornsilk: [255, 248, 220],
            crimson: [220, 20, 60],
            cyan: [0, 255, 255],
            darkblue: [0, 0, 139],
            darkcyan: [0, 139, 139],
            darkgoldenrod: [184, 134, 11],
            darkgray: [169, 169, 169],
            darkgreen: [0, 100, 0],
            darkgrey: [169, 169, 169],
            darkkhaki: [189, 183, 107],
            darkmagenta: [139, 0, 139],
            darkolivegreen: [85, 107, 47],
            darkorange: [255, 140, 0],
            darkorchid: [153, 50, 204],
            darkred: [139, 0, 0],
            darksalmon: [233, 150, 122],
            darkseagreen: [143, 188, 143],
            darkslateblue: [72, 61, 139],
            darkslategray: [47, 79, 79],
            darkslategrey: [47, 79, 79],
            darkturquoise: [0, 206, 209],
            darkviolet: [148, 0, 211],
            deeppink: [255, 20, 147],
            deepskyblue: [0, 191, 255],
            dimgray: [105, 105, 105],
            dimgrey: [105, 105, 105],
            dodgerblue: [30, 144, 255],
            firebrick: [178, 34, 34],
            floralwhite: [255, 250, 240],
            forestgreen: [34, 139, 34],
            fuchsia: [255, 0, 255],
            gainsboro: [220, 220, 220],
            ghostwhite: [248, 248, 255],
            gold: [255, 215, 0],
            goldenrod: [218, 165, 32],
            gray: [128, 128, 128],
            green: [0, 128, 0],
            greenyellow: [173, 255, 47],
            grey: [128, 128, 128],
            honeydew: [240, 255, 240],
            hotpink: [255, 105, 180],
            indianred: [205, 92, 92],
            indigo: [75, 0, 130],
            ivory: [255, 255, 240],
            khaki: [240, 230, 140],
            lavender: [230, 230, 250],
            lavenderblush: [255, 240, 245],
            lawngreen: [124, 252, 0],
            lemonchiffon: [255, 250, 205],
            lightblue: [173, 216, 230],
            lightcoral: [240, 128, 128],
            lightcyan: [224, 255, 255],
            lightgoldenrodyellow: [250, 250, 210],
            lightgray: [211, 211, 211],
            lightgreen: [144, 238, 144],
            lightgrey: [211, 211, 211],
            lightpink: [255, 182, 193],
            lightsalmon: [255, 160, 122],
            lightseagreen: [32, 178, 170],
            lightskyblue: [135, 206, 250],
            lightslategray: [119, 136, 153],
            lightslategrey: [119, 136, 153],
            lightsteelblue: [176, 196, 222],
            lightyellow: [255, 255, 224],
            lime: [0, 255, 0],
            limegreen: [50, 205, 50],
            linen: [250, 240, 230],
            magenta: [255, 0, 255],
            maroon: [128, 0, 0],
            mediumaquamarine: [102, 205, 170],
            mediumblue: [0, 0, 205],
            mediumorchid: [186, 85, 211],
            mediumpurple: [147, 112, 216],
            mediumseagreen: [60, 179, 113],
            mediumslateblue: [123, 104, 238],
            mediumspringgreen: [0, 250, 154],
            mediumturquoise: [72, 209, 204],
            mediumvioletred: [199, 21, 133],
            midnightblue: [25, 25, 112],
            mintcream: [245, 255, 250],
            mistyrose: [255, 228, 225],
            moccasin: [255, 228, 181],
            navajowhite: [255, 222, 173],
            navy: [0, 0, 128],
            oldlace: [253, 245, 230],
            olive: [128, 128, 0],
            olivedrab: [107, 142, 35],
            orange: [255, 165, 0],
            orangered: [255, 69, 0],
            orchid: [218, 112, 214],
            palegoldenrod: [238, 232, 170],
            palegreen: [152, 251, 152],
            paleturquoise: [175, 238, 238],
            palevioletred: [216, 112, 147],
            papayawhip: [255, 239, 213],
            peachpuff: [255, 218, 185],
            peru: [205, 133, 63],
            pink: [255, 192, 203],
            plum: [221, 160, 221],
            powderblue: [176, 224, 230],
            purple: [128, 0, 128],
            red: [255, 0, 0],
            rosybrown: [188, 143, 143],
            royalblue: [65, 105, 225],
            saddlebrown: [139, 69, 19],
            salmon: [250, 128, 114],
            sandybrown: [244, 164, 96],
            seagreen: [46, 139, 87],
            seashell: [255, 245, 238],
            sienna: [160, 82, 45],
            silver: [192, 192, 192],
            skyblue: [135, 206, 235],
            slateblue: [106, 90, 205],
            slategray: [112, 128, 144],
            slategrey: [112, 128, 144],
            snow: [255, 250, 250],
            springgreen: [0, 255, 127],
            steelblue: [70, 130, 180],
            tan: [210, 180, 140],
            teal: [0, 128, 128],
            thistle: [216, 191, 216],
            tomato: [255, 99, 71],
            turquoise: [64, 224, 208],
            violet: [238, 130, 238],
            wheat: [245, 222, 179],
            white: [255, 255, 255],
            whitesmoke: [245, 245, 245],
            yellow: [255, 255, 0],
            yellowgreen: [154, 205, 50]
        };

    function
    rgbaToHsva(rgba) {
        var
            r = rgba[0];
        var
            g = rgba[1];
        var
            b = rgba[2];
        var
            min = Math.min(Math.min(r, g), b),
            max = Math.max(Math.max(r, g), b),
            delta = max - min;
        var
            value = max;
        var
            saturation, hue;
        if (max == min) {
            hue = 0
        } else
        if (max == r) {
            hue = 60 * ((g - b) / (max - min)) % 360
        } else
        if (max == g) {
            hue = 60 * ((b - r) / (max - min)) + 120
        } else
        if (max == b) {
            hue = 60 * ((r - g) / (max - min)) + 240
        }
        if (hue < 0) {
            hue += 360
        }
        if (max == 0) {
            saturation = 0
        } else {
            saturation = 1 - min / max
        }
        return [Math.round(hue), Math.round(saturation * 100), Math.round(value * 100), rgba[3]]
    }

    function
    hsvaToRgba(hsva) {
        var
            h = normalize360(hsva[0]);
        var
            s = hsva[1];
        var
            v = hsva[2];
        var
            s = s / 100;
        var
            v = v / 100;
        var
            hi = Math.floor(h / 60 % 6);
        var
            f = h / 60 - hi;
        var
            p = v * (1 - s);
        var
            q = v * (1 - f * s);
        var
            t = v * (1 - (1 - f) * s);
        var
            rgb = [];
        switch (hi) {
            case
            0:
                rgb = [v, t, p];
                break;
            case
            1:
                rgb = [q, v, p];
                break;
            case
            2:
                rgb = [p, v, t];
                break;
            case
            3:
                rgb = [p, q, v];
                break;
            case
            4:
                rgb = [t, p, v];
                break;
            case
            5:
                rgb = [v, p, q];
                break
        }
        return [rgb[0], rgb[1], rgb[2], hsva[3]]
    }

    function
    rgbaToHsl(c) {
        var
            hsl = rgbToHsl(c[0], c[1], c[2]);
        hsl[0] = normalize360(Math.floor(hsl[0] * 360));
        hsl[1] = Math.floor(hsl[1] * 100);
        hsl[2] = Math.floor(hsl[2] * 100);
        return hsl
    }

    function
    rgbaToHsla(c) {
        var
            hsl = rgbaToHsl(c);
        hsl.push(c[3]);
        return hsl
    }

    function
    hslToRgba(c) {
        var
            h = parseFloat(c[0]) / 360;
        var
            s = parseFloat(c[1]) / 100;
        var
            l = parseFloat(c[2]) / 100;
        var
            rgb = hslToRgb(h, s, l);
        return [rgb[0], rgb[1], rgb[2], 1]
    }

    function
    hslaToRgba(c) {
        var
            h = parseFloat(c[0]) / 360;
        var
            s = parseFloat(c[1]) / 100;
        var
            l = parseFloat(c[2]) / 100;
        var
            rgb = hslToRgb(h, s, l);
        return [rgb[0], rgb[1], rgb[2], parseFloat(c[3])]
    }
    var
        parse = {
            byteOrPercent: function(s) {
                var
                    m;
                if (typeof s == "string" && (m = s.match(/^([0-9]+)%$/))) return Math.floor(parseFloat(m[1]) * 255 / 100);
                else
                    return parseFloat(s)
            },
            floatOrPercent: function(s) {
                var
                    m;
                if (typeof s == "string" && (m = s.match(/^([0-9]+)%$/))) return parseFloat(m[1]) / 100;
                else
                    return parseFloat(s)
            },
            numberOrPercent: function(s, scale) {
                var
                    m;
                if (typeof s == "string" && (m = s.match(/^([0-9]+)%$/))) return parseFloat(m[1]) / 100 * scale;
                else
                    return parseFloat(s)
            },
            rgba: function(v) {
                for (var
                        i = 0; i < 3; ++i) v[i] = b2f(parse.byteOrPercent(v[i]));
                v[3] = parse.floatOrPercent(v[i]);
                return new
                Color(v)
            },
            rgba8: function(v) {
                return new
                Color([b2f(parse.byteOrPercent(v[0])), b2f(parse.byteOrPercent(v[1])), b2f(parse.byteOrPercent(v[2])), b2f(parse.byteOrPercent(v[3]))])
            },
            float3: function(v) {
                for (var
                        i = 0; i < 3; ++i) v[i] = parse.floatOrPercent(v[i]);
                v[3] = 1;
                return new
                Color(v)
            },
            float4: function(v) {
                for (var
                        i = 0; i < 3; ++i) v[i] = parse.floatOrPercent(v[i]);
                v[3] = parse.floatOrPercent(v[i]);
                return new
                Color(v)
            },
            hsla: function(v) {
                v[0] = parse.numberOrPercent(v[0], 360);
                v[1] = parse.numberOrPercent(v[1], 100);
                v[2] = parse.numberOrPercent(v[2], 100);
                v[3] = parse.numberOrPercent(v[3], 1);
                return new
                Color(hslaToRgba(v))
            },
            hsva: function(v) {
                v[0] = normalize360(parseFloat(v[0]));
                v[1] = Math.max(0, Math.min(100, parseFloat(v[1])));
                v[2] = Math.max(0, Math.min(100, parseFloat(v[2])));
                v[3] = parse.floatOrPercent(v[3]);
                return new
                Color(hsvaToRgba(v))
            }
        };
    var
        supportedFormats = {
            keyword: {},
            hex3: {},
            hex7: {},
            rgb: {
                parse: function(v) {
                    v = v.slice(0);
                    v.push(1);
                    return parse.rgba(v)
                }
            },
            rgba: {
                parse: parse.rgba
            },
            hsl: {
                parse: function(v) {
                    v = v.slice(0);
                    v.push(1);
                    return parse.hsla(v)
                }
            },
            hsla: {
                parse: parse.hsla
            },
            hsv: {
                parse: function(v) {
                    v = v.slice(0);
                    v.push(1);
                    return parse.hsva(v)
                }
            },
            hsva: {
                parse: parse.hsva
            },
            rgb8: {
                parse: function(v) {
                    v = v.slice(0);
                    v.push(1);
                    return parse.rgba(v)
                }
            },
            rgba8: {
                parse: function(v) {
                    return parse.rgba8(v)
                }
            },
            packed_rgba: {
                parse: function(v) {
                    v = [v >> 24 & 255, v >> 16 & 255, v >> 8 & 255, (v & 255) / 255];
                    return parse.rgba(v)
                },
                output: function(v) {
                    return unsigned(f2b(v[0]) << 24 | f2b(v[1]) << 16 | f2b(v[2]) << 8 | f2b(v[3]))
                }
            },
            packed_argb: {
                parse: function(v) {
                    v = [v >> 16 & 255, v >> 8 & 255, v >> 0 & 255, (v >> 24 & 255) / 255];
                    return parse.rgba(v)
                },
                output: function(v) {
                    return unsigned(f2b(v[3]) << 24 | f2b(v[0]) << 16 | f2b(v[1]) << 8 | f2b(v[2]))
                }
            },
            float3: {
                parse: parse.float3
            },
            float4: {
                parse: parse.float4
            }
        };

    function
    Color(value) {
        this._value = value
    }
    var
        color = function() {
            var
                match = null;
            if (arguments[0] instanceof Color) {
                return new
                Color(arguments[0]._value)
            } else
            if (typeof arguments[0] == "string") {
                var
                    first = arguments[0][0];
                if (first == "#") {
                    if (match = arguments[0].match(/^#([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])$/i)) {
                        return new
                        Color(hex4ToRgba(match[0]))
                    } else
                    if (match = arguments[0].match(/^#([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])$/i)) {
                        return new
                        Color(hex7ToRgba(match[0]))
                    }
                } else
                if (match = supportedFormats[arguments[0].toLowerCase()]) {
                    if (arguments.length == 2) return match.parse(arguments[1]);
                    else
                        return match.parse(slice(arguments, 1))
                } else
                if (match = arguments[0].match(/^\s*([A-Z][A-Z0-9_]+)\s*\(\s*([\-0-9A-FX]+)\s*\)\s*$/i)) {
                    var
                        format = supportedFormats[match[1].toLowerCase()];
                    return format.parse(match[2])
                } else
                if (match = arguments[0].match(/^\s*([A-Z][A-Z0-9]+)\s*\(\s*([0-9\.]+%?)\s*,\s*([0-9\.]+%?)\s*,\s*([0-9\.]+%?)\s*(,\s*([0-9\.]+%?)\s*)?\)\s*$/i)) {
                    var
                        format = supportedFormats[match[1].toLowerCase()];
                    if (match[5] === undefined) {
                        var
                            v = [match[2], match[3], match[4]];
                        return format.parse(v)
                    } else {
                        var
                            v = [match[2], match[3], match[4], match[6]];
                        return format.parse(v)
                    }
                } else
                if (arguments.length == 1 && (match = namedColors[trimLc(arguments[0])])) {
                    var
                        v = match;
                    return new
                    Color([b2f(v[0]), b2f(v[1]), b2f(v[2]), 1])
                }
            }
            throw "Could not parse color '" + arguments[0] + "'"
        };
    var
        fixed = {
            white: color("white"),
            black: color("black"),
            gray: color("gray")
        };

    function
    modifyComponent(index, arg) {
        if (arg == undefined) return f2b(this._value[index]);
        var
            v = slice(this._value, 0);
        if (typeof arg == "string") {
            var
                m;
            if (m = arg.match(/^([+\-\\*]=?)([0-9.]+)/)) {
                var
                    op = m[1];
                var
                    offset = parseFloat(m[2]);
                switch (op[0]) {
                    case "+":
                        v[index] += offset / 255;
                        break;
                    case "-":
                        v[index] -= offset / 255;
                        break;
                    case "*":
                        v[index] *= offset;
                        break
                }
                if (op[1] == "=") {
                    this._value = v;
                    return this
                } else
                    return new
                Color(v)
            }
        } else {
            var
                clone = this.clone();
            clone._value[index] = arg;
            return clone
        }
    }

    function
    modifyHsva(i) {
        return function() {
            function
            change(obj, op, value) {
                value = parseFloat(value);
                var
                    hsva = rgbaToHsva(obj._value);
                var
                    c = 0;
                switch (op) {
                    case "=":
                        hsva[i] = value;
                        c = 1;
                        break;
                    case "+":
                        hsva[i] += value;
                        c = 1;
                        break;
                    case "+=":
                        hsva[i] += value;
                        break;
                    case "-":
                        hsva[i] -= value;
                        c = 1;
                        break;
                    case "-=":
                        hsva[i] -= value;
                        break;
                    case "*":
                        hsva[i] *= value;
                        c = 1;
                        break;
                    case "*=":
                        hsva[i] *= value;
                        break;
                    default:
                        throw "Bad op " + op
                }
                if (i == 0) hsva[i] = normalize360(hsva[i]);
                else
                if (i == 1 || i == 2) {
                    if (hsva[i] < 0) hsva[i] = 0;
                    else
                    if (hsva[i] > 99) hsva[i] = 99
                }
                if (c) obj = obj.clone();
                obj._value = hsvaToRgba(hsva);
                return obj
            }
            if (arguments.length == 0) return rgbaToHsva(this._value)[i];
            else
            if (arguments.length == 1) {
                var
                    m;
                if (typeof arguments[0] == "string" && (m = arguments[0].match(/^([\+\-\*]=?)([0-9.]+)/))) return change(this, m[1], m[2]);
                else
                    return change(this, "=", arguments[0])
            } else
            if (arguments.length == 2) return change(this, arguments[0], arguments[1])
        }
    }
    var
        methods = {
            clone: function() {
                return new
                Color(this._value.slice(0))
            },
            html: function() {
                var
                    self = this;
                var
                    v = this._value;
                var
                    _fmt = {
                        hex3: function() {
                            return self.hex3()
                        },
                        hex6: function() {
                            return self.hex6()
                        },
                        rgb: function() {
                            return "rgb(" + self.rgb().join(",") + ")"
                        },
                        rgba: function() {
                            return "rgba(" + self.rgba().join(",") + ")"
                        },
                        hsl: function() {
                            return "hsl(" + rgbaToHsl(v).join(",") + ")"
                        },
                        hsla: function() {
                            return "hsla(" + rgbaToHsla(v).join(",") + ")"
                        },
                        keyword: function() {
                            var
                                dist = 3 * 255 * 255 + 1;
                            var
                                keyword;
                            for (name in
                                namedColors) {
                                var
                                    c = namedColors[name];
                                var
                                    d = 0;
                                for (var
                                        i = 0; i < 3; ++i) {
                                    var
                                        t = v[i] - b2f(c[i]);
                                    d += t * t
                                }
                                if (d < dist) {
                                    keyword = name;
                                    dist = d
                                }
                            }
                            return keyword
                        }
                    };
                var
                    type = arguments[0] || "rgba";
                return _fmt[type]()
            },
            red: function() {
                return modifyComponent.call(this, 0, arguments[0])
            },
            green: function() {
                return modifyComponent.call(this, 1, arguments[0])
            },
            blue: function() {
                return modifyComponent.call(this, 2, arguments[0])
            },
            alpha: function() {
                if (arguments.length == 1) {
                    c = this.clone();
                    c._value[3] = parse.floatOrPercent(arguments[0]);
                    return c
                } else
                    return this._value[3]
            },
            alpha8: function() {
                if (arguments.length == 1) {
                    c = this.clone();
                    c._value[3] = parse.byteOrPercent(arguments[0]) / 255;
                    return c
                } else
                    return Math.floor(this._value[3] * 255)
            },
            grayvalue: function() {
                var
                    c = this._value;
                return (c[0] + c[1] + c[2]) / 3
            },
            grayvalue8: function() {
                return f2b(this.grayvalue())
            },
            luminance: function() {
                var
                    c = this._value;
                return c[0] * .2126 + c[1] * .7152 + c[2] * .0722
            },
            luminance8: function() {
                return f2b(this.luminance())
            },
            hsv: function() {
                return rgbaToHsva(this._value).slice(0, 3)
            },
            hsva: function() {
                return rgbaToHsva(this._value)
            },
            packed_rgba: function() {
                return supportedFormats.packed_rgba.output(this._value)
            },
            packed_argb: function() {
                return supportedFormats.packed_argb.output(this._value)
            },
            hue: modifyHsva(0),
            saturation: modifyHsva(1),
            value: modifyHsva(2),
            clamp: function() {
                var
                    v = this._value;
                return new
                Color([clamp(v[0], 0, 1), clamp(v[1], 0, 1), clamp(v[2], 0, 1), clamp(v[3], 0, 1)])
            },
            blend: function(colorToBlend, amount) {
                if (typeof amount !== "number") amount = parse.floatOrPercent(amount);
                var
                    c = this;
                var
                    c2 = color(colorToBlend);
                return new
                Color([mix(c._value[0], c2._value[0], amount), mix(c._value[1], c2._value[1], amount), mix(c._value[2], c2._value[2], amount), mix(c._value[3], c2._value[3], amount)])
            },
            add: function(d) {
                var
                    u = this._value;
                var
                    v = color(d)._value;
                return new
                Color([u[0] + v[0] * v[3], u[1] + v[1] * v[3], u[2] + v[2] * v[3], u[3]])
            },
            inc: function(d) {
                var
                    u = this._value;
                var
                    v = color(d)._value;
                u[0] += v[0] * v[3];
                u[1] += v[1] * v[3];
                u[2] += v[2] * v[3];
                return this
            },
            dec: function(d) {
                var
                    u = this._value;
                var
                    v = color(d)._value;
                u[0] -= v[0] * v[3];
                u[1] -= v[1] * v[3];
                u[2] -= v[2] * v[3];
                return this
            },
            subtract: function(d) {
                var
                    u = this._value;
                var
                    v = color(d)._value;
                return new
                Color([u[0] - v[0] * v[3], u[1] - v[1] * v[3], u[2] - v[2] * v[3], u[3]])
            },
            multiply: function(d) {
                var
                    u = this._value;
                var
                    v = color(d)._value;
                return new
                Color([u[0] * v[0], u[1] * v[1], u[2] * v[2], u[3] * v[3]])
            },
            scale: function(d) {
                var
                    u = this._value;
                return new
                Color([u[0] * d, u[1] * d, u[2] * d, u[3]])
            },
            xor: function(d) {
                var
                    u = this.rgba8();
                var
                    v = color(d).rgba8();
                return color("rgba8", u[0] ^ v[0], u[1] ^ v[1], u[2] ^ v[2], u[3])
            },
            tint: function(amount) {
                return this.blend(fixed.white, amount)
            },
            shade: function(amount) {
                return this.blend(fixed.black, amount)
            },
            tone: function(amount) {
                return this.blend(fixed.gray, amount)
            },
            complement: function() {
                var
                    hsva = this.hsva();
                hsva[0] = normalize360(hsva[0] + 180);
                return new
                Color(hsvaToRgba(hsva))
            },
            triad: function() {
                return [new
                    Color(this._value), this.hue("+120"), this.hue("+240")
                ]
            },
            hueSet: function() {
                var
                    h = 0;
                var
                    set = [];
                for (var
                        s = 100; s >= 30; s -= 35)
                    for (var
                            v = 100; v >= 30; v -= 35) set.push(this.hue("+", h).saturation(s).value(v));
                return set
            },
            hueRange: function(range, count) {
                var
                    base = this.hue();
                var
                    set = [];
                for (var
                        i = 0; i < count; ++i) {
                    var
                        h = base + 2 * (i / (count - 1) - .5) * range;
                    set.push(this.hue("=", h))
                }
                return set
            },
            contrastWhiteBlack: function() {
                return this.value() < 50 ? color("white") : color("black")
            },
            contrastGray: function() {
                var
                    hsva = this.hsva();
                var
                    value = hsva[2] < 30 ? hsva[2] + 20 : hsva[2] - 20;
                return new
                Color(hsvaToRgba([hsva[0], 0, value, hsva[3]]))
            },
            hex3: function() {
                function
                hex(d, max) {
                    return Math.min(Math.round(f2b(d) / 16), 15).toString(16)
                }
                return "#" + hex(this._value[0]) + hex(this._value[1]) + hex(this._value[2])
            },
            hex6: function() {
                function
                hex(d, max) {
                    var
                        h = f2b(d).toString(16);
                    return h.length < 2 ? "0" + h : h
                }
                return "#" + hex(this._value[0]) + hex(this._value[1]) + hex(this._value[2])
            },
            rgb: function() {
                var
                    v = this._value;
                return [f2b(v[0]), f2b(v[1]), f2b(v[2])]
            },
            rgba: function() {
                var
                    v = this._value;
                return [f2b(v[0]), f2b(v[1]), f2b(v[2]), v[3]]
            },
            rgb8: function() {
                var
                    v = this._value;
                return [f2b(v[0]), f2b(v[1]), f2b(v[2])]
            },
            rgba8: function() {
                var
                    v = this._value;
                return [f2b(v[0]), f2b(v[1]), f2b(v[2]), this.alpha8()]
            },
            float3: function() {
                return [this._value[0], this._value[1], this._value[2]]
            },
            float4: function() {
                return [this._value[0], this._value[1], this._value[2], this._value[3]]
            }
        };
    methods["sub"] = methods["subtract"];
    methods["mul"] = methods["multiply"];
    for (var
            name in
            methods) Color.prototype[name] = methods[name];
    color.float3 = function(r, g, b) {
        return new
        Color([r, g, b, 1])
    };
    color.float4 = function(r, g, b, a) {
        return new
        Color([r, g, b, a])
    };
    color.version = "0.2.4";
    color.Color = Color;
    if (typeof module !== "undefined" && module.exports) {
        module.exports = color
    } else
    if (typeof window !== "undefined") {
        window.pusher = window.pusher || {};
        window.pusher.color = color
    } else
    if (typeof self != "undefined") {
        self.pusher = self.pusher || {};
        self.pusher.color = color
    }
})();
(function(name, definition, context) {
    if (typeof context['module'] !== 'undefined' && context['module']['exports']) context['module']['exports'] = definition();
    else
    if (typeof context['define'] !== 'undefined' && context['define'] === 'function' && context['define']['amd']) define(name, definition);
    else
        context[name] = definition();
})('query', function() {
    var
        $self = {};
    $self.store = {};
    $self.decodeStore = {};
    $self.built = false;
    $self.queryString = undefined;
    $self.re = /([^&=]+)=?([^&]*)/g;
    $self.m = null;
    $self.getQueryString = function() {
        var
            search = window.location.search.substring(1);
        var
            hash = window.location.hash.split("?");
        hash.shift();
        return (search && search !== "") ? search : (hash.length > 0) ? hash.join("?") : undefined;
    };
    $self.decode = function(str) {
        if (!$self.decodeStore[str]) $self.decodeStore[str] = decodeURIComponent(str.replace(/\+/g, ' '));
        return $self.decodeStore[str];
    };
    $self.get = function(name, rebuild) {
        name = String(name).replace(/[.*+?|()\[\]{}\\]/g, '\\$&');
        return $self.parse({
            name: name,
            rebuild: rebuild
        });
    };
    $self.parse = function(opts) {
        if (!$self.built || opts.rebuild) {
            $self.queryString = typeof
            opts.query === 'string' ? opts.query : $self.getQueryString();
            if (typeof $self.queryString === 'string' && $self.queryString.length > 0) {
                var
                    index, aname, pname, $key, $value, $decodeKey, $decodeValue;
                if ($self.queryString[0] === "?") $self.queryString = $self.queryString.substring(1);
                $self.store = {};
                $self.decodeStore = {};
                while ($self.m = $self.re.exec($self.queryString)) {
                    $key = $self.m[1];
                    $value = $self.m[2];
                    $decodeKey = $self.decode($key);
                    $decodeValue = $self.decode($value);
                    if ($self.m[1].indexOf("[") === -1)
                        if (!($decodeKey in
                                $self.store)) $self.store[$decodeKey] = $decodeValue;
                        else
                    if (typeof $self.store[$decodeKey] !== 'object') $self.store[$decodeKey] = [$self.store[$decodeKey], $decodeValue];
                    else
                        Array.prototype.push.call($self.store[$decodeKey], $decodeValue);
                    else {
                        index = $key.indexOf("[");
                        aname = $self.decode($key.slice(index + 1, $key.indexOf("]", index)));
                        pname = $self.decode($key.slice(0, index));
                        if (typeof $self.store[pname] !== "object") {
                            $self.store[pname] = {};
                            $self.store[pname].length = 0;
                        }
                        if (aname) $self.store[pname][aname] = $decodeValue;
                        else
                            Array.prototype.push.call($self.store[pname], $decodeValue);
                    }
                }
            } else
                return undefined;
            $self.built = true;
        }
        return opts.name ? ((opts.name in
            $self.store) ? $self.store[opts.name] : undefined) : $self.store;
    };
    return $self;
}, this);
(function(a) {
    function
    b() {
        return {
            empty: !1,
            unusedTokens: [],
            unusedInput: [],
            overflow: -2,
            charsLeftOver: 0,
            nullInput: !1,
            invalidMonth: null,
            invalidFormat: !1,
            userInvalidated: !1,
            iso: !1
        }
    }

    function
    c(a, b) {
        function
        c() {
            ib.suppressDeprecationWarnings === !1 && "undefined" != typeof
            console && console.warn && console.warn("Deprecation warning: " + a)
        }
        var
            d = !0;
        return i(function() {
            return d && (c(), d = !1), b.apply(this, arguments)
        }, b)
    }

    function
    d(a, b) {
        return function(c) {
            return l(a.call(this, c), b)
        }
    }

    function
    e(a, b) {
        return function(c) {
            return this.lang().ordinal(a.call(this, c), b)
        }
    }

    function
    f() {}

    function
    g(a) {
        y(a), i(this, a)
    }

    function
    h(a) {
        var
            b = r(a),
            c = b.year || 0,
            d = b.quarter || 0,
            e = b.month || 0,
            f = b.week || 0,
            g = b.day || 0,
            h = b.hour || 0,
            i = b.minute || 0,
            j = b.second || 0,
            k = b.millisecond || 0;
        this._milliseconds = +k + 1e3 * j + 6e4 * i + 36e5 * h, this._days = +g + 7 * f, this._months = +e + 3 * d + 12 * c, this._data = {}, this._bubble()
    }

    function
    i(a, b) {
        for (var
                c in
                b) b.hasOwnProperty(c) && (a[c] = b[c]);
        return b.hasOwnProperty("toString") && (a.toString = b.toString), b.hasOwnProperty("valueOf") && (a.valueOf = b.valueOf), a
    }

    function
    j(a) {
        var
            b, c = {};
        for (b in
            a) a.hasOwnProperty(b) && wb.hasOwnProperty(b) && (c[b] = a[b]);
        return c
    }

    function
    k(a) {
        return 0 > a ? Math.ceil(a) : Math.floor(a)
    }

    function
    l(a, b, c) {
        for (var
                d = "" + Math.abs(a), e = a >= 0; d.length < b;) d = "0" + d;
        return (e ? c ? "+" : "" : "-") + d
    }

    function
    m(a, b, c, d) {
        var
            e = b._milliseconds,
            f = b._days,
            g = b._months;
        d = null == d ? !0 : d, e && a._d.setTime(+a._d + e * c), f && db(a, "Date", cb(a, "Date") + f * c), g && bb(a, cb(a, "Month") + g * c), d && ib.updateOffset(a, f || g)
    }

    function
    n(a) {
        return "[object Array]" === Object.prototype.toString.call(a)
    }

    function
    o(a) {
        return "[object Date]" === Object.prototype.toString.call(a) || a
        instanceof
        Date
    }

    function
    p(a, b, c) {
        var
            d, e = Math.min(a.length, b.length),
            f = Math.abs(a.length - b.length),
            g = 0;
        for (d = 0; e > d; d++)(c && a[d] !== b[d] || !c && t(a[d]) !== t(b[d])) && g++;
        return g + f
    }

    function
    q(a) {
        if (a) {
            var
                b = a.toLowerCase().replace(/(.)s$/, "$1");
            a = Zb[a] || $b[b] || b
        }
        return a
    }

    function
    r(a) {
        var
            b, c, d = {};
        for (c in
            a) a.hasOwnProperty(c) && (b = q(c), b && (d[b] = a[c]));
        return d
    }

    function
    s(b) {
        var
            c, d;
        if (0 === b.indexOf("week")) c = 7, d = "day";
        else {
            if (0 !== b.indexOf("month")) return;
            c = 12, d = "month"
        }
        ib[b] = function(e, f) {
            var
                g, h, i = ib.fn._lang[b],
                j = [];
            if ("number" == typeof e && (f = e, e = a), h = function(a) {
                    var
                        b = ib().utc().set(d, a);
                    return i.call(ib.fn._lang, b, e || "")
                }, null != f) return h(f);
            for (g = 0; c > g; g++) j.push(h(g));
            return j
        }
    }

    function
    t(a) {
        var
            b = +a,
            c = 0;
        return 0 !== b && isFinite(b) && (c = b >= 0 ? Math.floor(b) : Math.ceil(b)), c
    }

    function
    u(a, b) {
        return new
        Date(Date.UTC(a, b + 1, 0)).getUTCDate()
    }

    function
    v(a, b, c) {
        return $(ib([a, 11, 31 + b - c]), b, c).week
    }

    function
    w(a) {
        return x(a) ? 366 : 365
    }

    function
    x(a) {
        return a % 4 === 0 && a % 100 !== 0 || a % 400 === 0
    }

    function
    y(a) {
        var
            b;
        a._a && -2 === a._pf.overflow && (b = a._a[pb] < 0 || a._a[pb] > 11 ? pb : a._a[qb] < 1 || a._a[qb] > u(a._a[ob], a._a[pb]) ? qb : a._a[rb] < 0 || a._a[rb] > 23 ? rb : a._a[sb] < 0 || a._a[sb] > 59 ? sb : a._a[tb] < 0 || a._a[tb] > 59 ? tb : a._a[ub] < 0 || a._a[ub] > 999 ? ub : -1, a._pf._overflowDayOfYear && (ob > b || b > qb) && (b = qb), a._pf.overflow = b)
    }

    function
    z(a) {
        return null == a._isValid && (a._isValid = !isNaN(a._d.getTime()) && a._pf.overflow < 0 && !a._pf.empty && !a._pf.invalidMonth && !a._pf.nullInput && !a._pf.invalidFormat && !a._pf.userInvalidated, a._strict && (a._isValid = a._isValid && 0 === a._pf.charsLeftOver && 0 === a._pf.unusedTokens.length)), a._isValid
    }

    function
    A(a) {
        return a ? a.toLowerCase().replace("_", "-") : a
    }

    function
    B(a, b) {
        return b._isUTC ? ib(a).zone(b._offset || 0) : ib(a).local()
    }

    function
    C(a, b) {
        return b.abbr = a, vb[a] || (vb[a] = new f), vb[a].set(b), vb[a]
    }

    function
    D(a) {
        delete
        vb[a]
    }

    function
    E(a) {
        var
            b, c, d, e, f = 0,
            g = function(a) {
                if (!vb[a] && xb) try {
                    require("./lang/" + a)
                } catch (b) {}
                return vb[a]
            };
        if (!a) return ib.fn._lang;
        if (!n(a)) {
            if (c = g(a)) return c;
            a = [a]
        }
        for (; f < a.length;) {
            for (e = A(a[f]).split("-"), b = e.length, d = A(a[f + 1]), d = d ? d.split("-") : null; b > 0;) {
                if (c = g(e.slice(0, b).join("-"))) return c;
                if (d && d.length >= b && p(e, d, !0) >= b - 1) break;
                b--
            }
            f++
        }
        return ib.fn._lang
    }

    function
    F(a) {
        return a.match(/\[[\s\S]/) ? a.replace(/^\[|\]$/g, "") : a.replace(/\\/g, "")
    }

    function
    G(a) {
        var
            b, c, d = a.match(Bb);
        for (b = 0, c = d.length; c > b; b++) d[b] = cc[d[b]] ? cc[d[b]] : F(d[b]);
        return function(e) {
            var
                f = "";
            for (b = 0; c > b; b++) f += d[b] instanceof
            Function ? d[b].call(e, a) : d[b];
            return f
        }
    }

    function
    H(a, b) {
        return a.isValid() ? (b = I(b, a.lang()), _b[b] || (_b[b] = G(b)), _b[b](a)) : a.lang().invalidDate()
    }

    function
    I(a, b) {
        function
        c(a) {
            return b.longDateFormat(a) || a
        }
        var
            d = 5;
        for (Cb.lastIndex = 0; d >= 0 && Cb.test(a);) a = a.replace(Cb, c), Cb.lastIndex = 0, d -= 1;
        return a
    }

    function
    J(a, b) {
        var
            c, d = b._strict;
        switch (a) {
            case "Q":
                return Nb;
            case "DDDD":
                return Pb;
            case "YYYY":
            case "GGGG":
            case "gggg":
                return d ? Qb : Fb;
            case "Y":
            case "G":
            case "g":
                return Sb;
            case "YYYYYY":
            case "YYYYY":
            case "GGGGG":
            case "ggggg":
                return d ? Rb : Gb;
            case "S":
                if (d) return Nb;
            case "SS":
                if (d) return Ob;
            case "SSS":
                if (d) return Pb;
            case "DDD":
                return Eb;
            case "MMM":
            case "MMMM":
            case "dd":
            case "ddd":
            case "dddd":
                return Ib;
            case "a":
            case "A":
                return E(b._l)._meridiemParse;
            case "X":
                return Lb;
            case "Z":
            case "ZZ":
                return Jb;
            case "T":
                return Kb;
            case "SSSS":
                return Hb;
            case "MM":
            case "DD":
            case "YY":
            case "GG":
            case "gg":
            case "HH":
            case "hh":
            case "mm":
            case "ss":
            case "ww":
            case "WW":
                return d ? Ob : Db;
            case "M":
            case "D":
            case "d":
            case "H":
            case "h":
            case "m":
            case "s":
            case "w":
            case "W":
            case "e":
            case "E":
                return Db;
            case "Do":
                return Mb;
            default:
                return c = new
                RegExp(R(Q(a.replace("\\", "")), "i"))
        }
    }

    function
    K(a) {
        a = a || "";
        var
            b = a.match(Jb) || [],
            c = b[b.length - 1] || [],
            d = (c + "").match(Xb) || ["-", 0, 0],
            e = +(60 * d[1]) + t(d[2]);
        return "+" === d[0] ? -e : e
    }

    function
    L(a, b, c) {
        var
            d, e = c._a;
        switch (a) {
            case "Q":
                null != b && (e[pb] = 3 * (t(b) - 1));
                break;
            case "M":
            case "MM":
                null != b && (e[pb] = t(b) - 1);
                break;
            case "MMM":
            case "MMMM":
                d = E(c._l).monthsParse(b), null != d ? e[pb] = d : c._pf.invalidMonth = b;
                break;
            case "D":
            case "DD":
                null != b && (e[qb] = t(b));
                break;
            case "Do":
                null != b && (e[qb] = t(parseInt(b, 10)));
                break;
            case "DDD":
            case "DDDD":
                null != b && (c._dayOfYear = t(b));
                break;
            case "YY":
                e[ob] = ib.parseTwoDigitYear(b);
                break;
            case "YYYY":
            case "YYYYY":
            case "YYYYYY":
                e[ob] = t(b);
                break;
            case "a":
            case "A":
                c._isPm = E(c._l).isPM(b);
                break;
            case "H":
            case "HH":
            case "h":
            case "hh":
                e[rb] = t(b);
                break;
            case "m":
            case "mm":
                e[sb] = t(b);
                break;
            case "s":
            case "ss":
                e[tb] = t(b);
                break;
            case "S":
            case "SS":
            case "SSS":
            case "SSSS":
                e[ub] = t(1e3 * ("0." + b));
                break;
            case "X":
                c._d = new
                Date(1e3 * parseFloat(b));
                break;
            case "Z":
            case "ZZ":
                c._useUTC = !0, c._tzm = K(b);
                break;
            case "w":
            case "ww":
            case "W":
            case "WW":
            case "d":
            case "dd":
            case "ddd":
            case "dddd":
            case "e":
            case "E":
                a = a.substr(0, 1);
            case "gg":
            case "gggg":
            case "GG":
            case "GGGG":
            case "GGGGG":
                a = a.substr(0, 2), b && (c._w = c._w || {}, c._w[a] = b)
        }
    }

    function
    M(a) {
        var
            b, c, d, e, f, g, h, i, j, k, l = [];
        if (!a._d) {
            for (d = O(a), a._w && null == a._a[qb] && null == a._a[pb] && (f = function(b) {
                    var
                        c = parseInt(b, 10);
                    return b ? b.length < 3 ? c > 68 ? 1900 + c : 2e3 + c : c : null == a._a[ob] ? ib().weekYear() : a._a[ob]
                }, g = a._w, null != g.GG || null != g.W || null != g.E ? h = _(f(g.GG), g.W || 1, g.E, 4, 1) : (i = E(a._l), j = null != g.d ? X(g.d, i) : null != g.e ? parseInt(g.e, 10) + i._week.dow : 0, k = parseInt(g.w, 10) || 1, null != g.d && j < i._week.dow && k++, h = _(f(g.gg), k, j, i._week.doy, i._week.dow)), a._a[ob] = h.year, a._dayOfYear = h.dayOfYear), a._dayOfYear && (e = null == a._a[ob] ? d[ob] : a._a[ob], a._dayOfYear > w(e) && (a._pf._overflowDayOfYear = !0), c = W(e, 0, a._dayOfYear), a._a[pb] = c.getUTCMonth(), a._a[qb] = c.getUTCDate()), b = 0; 3 > b && null == a._a[b]; ++b) a._a[b] = l[b] = d[b];
            for (; 7 > b; b++) a._a[b] = l[b] = null == a._a[b] ? 2 === b ? 1 : 0 : a._a[b];
            l[rb] += t((a._tzm || 0) / 60), l[sb] += t((a._tzm || 0) % 60), a._d = (a._useUTC ? W : V).apply(null, l)
        }
    }

    function
    N(a) {
        var
            b;
        a._d || (b = r(a._i), a._a = [b.year, b.month, b.day, b.hour, b.minute, b.second, b.millisecond], M(a))
    }

    function
    O(a) {
        var
            b = new
        Date;
        return a._useUTC ? [b.getUTCFullYear(), b.getUTCMonth(), b.getUTCDate()] : [b.getFullYear(), b.getMonth(), b.getDate()]
    }

    function
    P(a) {
        a._a = [], a._pf.empty = !0;
        var
            b, c, d, e, f, g = E(a._l),
            h = "" + a._i,
            i = h.length,
            j = 0;
        for (d = I(a._f, g).match(Bb) || [], b = 0; b < d.length; b++) e = d[b], c = (h.match(J(e, a)) || [])[0], c && (f = h.substr(0, h.indexOf(c)), f.length > 0 && a._pf.unusedInput.push(f), h = h.slice(h.indexOf(c) + c.length), j += c.length), cc[e] ? (c ? a._pf.empty = !1 : a._pf.unusedTokens.push(e), L(e, c, a)) : a._strict && !c && a._pf.unusedTokens.push(e);
        a._pf.charsLeftOver = i - j, h.length > 0 && a._pf.unusedInput.push(h), a._isPm && a._a[rb] < 12 && (a._a[rb] += 12), a._isPm === !1 && 12 === a._a[rb] && (a._a[rb] = 0), M(a), y(a)
    }

    function
    Q(a) {
        return a.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g, function(a, b, c, d, e) {
            return b || c || d || e
        })
    }

    function
    R(a) {
        return a.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&")
    }

    function
    S(a) {
        var
            c, d, e, f, g;
        if (0 === a._f.length) return a._pf.invalidFormat = !0, void(a._d = new Date(0 / 0));
        for (f = 0; f < a._f.length; f++) g = 0, c = i({}, a), c._pf = b(), c._f = a._f[f], P(c), z(c) && (g += c._pf.charsLeftOver, g += 10 * c._pf.unusedTokens.length, c._pf.score = g, (null == e || e > g) && (e = g, d = c));
        i(a, d || c)
    }

    function
    T(a) {
        var
            b, c, d = a._i,
            e = Tb.exec(d);
        if (e) {
            for (a._pf.iso = !0, b = 0, c = Vb.length; c > b; b++)
                if (Vb[b][1].exec(d)) {
                    a._f = Vb[b][0] + (e[6] || " ");
                    break
                }
            for (b = 0, c = Wb.length; c > b; b++)
                if (Wb[b][1].exec(d)) {
                    a._f += Wb[b][0];
                    break
                }
            d.match(Jb) && (a._f += "Z"), P(a)
        } else
            ib.createFromInputFallback(a)
    }

    function
    U(b) {
        var
            c = b._i,
            d = yb.exec(c);
        c === a ? b._d = new
        Date: d ? b._d = new
        Date(+d[1]): "string" == typeof
        c ? T(b) : n(c) ? (b._a = c.slice(0), M(b)) : o(c) ? b._d = new
        Date(+c): "object" == typeof
        c ? N(b) : "number" == typeof
        c ? b._d = new
        Date(c): ib.createFromInputFallback(b)
    }

    function
    V(a, b, c, d, e, f, g) {
        var
            h = new
        Date(a, b, c, d, e, f, g);
        return 1970 > a && h.setFullYear(a), h
    }

    function
    W(a) {
        var
            b = new
        Date(Date.UTC.apply(null, arguments));
        return 1970 > a && b.setUTCFullYear(a), b
    }

    function
    X(a, b) {
        if ("string" == typeof a)
            if (isNaN(a)) {
                if (a = b.weekdaysParse(a), "number" != typeof a) return null
            } else
                a = parseInt(a, 10);
        return a
    }

    function
    Y(a, b, c, d, e) {
        return e.relativeTime(b || 1, !!c, a, d)
    }

    function
    Z(a, b, c) {
        var
            d = nb(Math.abs(a) / 1e3),
            e = nb(d / 60),
            f = nb(e / 60),
            g = nb(f / 24),
            h = nb(g / 365),
            i = 45 > d && ["s", d] || 1 === e && ["m"] || 45 > e && ["mm", e] || 1 === f && ["h"] || 22 > f && ["hh", f] || 1 === g && ["d"] || 25 >= g && ["dd", g] || 45 >= g && ["M"] || 345 > g && ["MM", nb(g / 30)] || 1 === h && ["y"] || ["yy", h];
        return i[2] = b, i[3] = a > 0, i[4] = c, Y.apply({}, i)
    }

    function
    $(a, b, c) {
        var
            d, e = c - b,
            f = c - a.day();
        return f > e && (f -= 7), e - 7 > f && (f += 7), d = ib(a).add("d", f), {
            week: Math.ceil(d.dayOfYear() / 7),
            year: d.year()
        }
    }

    function
    _(a, b, c, d, e) {
        var
            f, g, h = W(a, 0, 1).getUTCDay();
        return c = null != c ? c : e, f = e - h + (h > d ? 7 : 0) - (e > h ? 7 : 0), g = 7 * (b - 1) + (c - e) + f + 1, {
            year: g > 0 ? a : a - 1,
            dayOfYear: g > 0 ? g : w(a - 1) + g
        }
    }

    function
    ab(b) {
        var
            c = b._i,
            d = b._f;
        return null === c || d === a && "" === c ? ib.invalid({
            nullInput: !0
        }) : ("string" == typeof c && (b._i = c = E().preparse(c)), ib.isMoment(c) ? (b = j(c), b._d = new Date(+c._d)) : d ? n(d) ? S(b) : P(b) : U(b), new g(b))
    }

    function
    bb(a, b) {
        var
            c;
        return "string" == typeof
        b && (b = a.lang().monthsParse(b), "number" != typeof b) ? a : (c = Math.min(a.date(), u(a.year(), b)), a._d["set" + (a._isUTC ? "UTC" : "") + "Month"](b, c), a)
    }

    function
    cb(a, b) {
        return a._d["get" + (a._isUTC ? "UTC" : "") + b]()
    }

    function
    db(a, b, c) {
        return "Month" === b ? bb(a, c) : a._d["set" + (a._isUTC ? "UTC" : "") + b](c)
    }

    function
    eb(a, b) {
        return function(c) {
            return null != c ? (db(this, a, c), ib.updateOffset(this, b), this) : cb(this, a)
        }
    }

    function
    fb(a) {
        ib.duration.fn[a] = function() {
            return this._data[a]
        }
    }

    function
    gb(a, b) {
        ib.duration.fn["as" + a] = function() {
            return +this / b
        }
    }

    function
    hb(a) {
        "undefined" == typeof
        ender && (jb = mb.moment, mb.moment = a ? c("Accessing Moment through the global scope is deprecated, and will be removed in an upcoming release.", ib) : ib)
    }
    for (var
            ib, jb, kb, lb = "2.6.0", mb = "undefined" != typeof
        global ? global : this, nb = Math.round, ob = 0, pb = 1, qb = 2, rb = 3, sb = 4, tb = 5, ub = 6, vb = {}, wb = {
            _isAMomentObject: null,
            _i: null,
            _f: null,
            _l: null,
            _strict: null,
            _isUTC: null,
            _offset: null,
            _pf: null,
            _lang: null
        }, xb = "undefined" != typeof module && module.exports, yb = /^\/?Date\((\-?\d+)/i, zb = /(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/, Ab = /^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/, Bb = /(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g, Cb = /(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g, Db = /\d\d?/, Eb = /\d{1,3}/, Fb = /\d{1,4}/, Gb = /[+\-]?\d{1,6}/, Hb = /\d+/, Ib = /[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i, Jb = /Z|[\+\-]\d\d:?\d\d/gi, Kb = /T/i, Lb = /[\+\-]?\d+(\.\d{1,3})?/, Mb = /\d{1,2}/, Nb = /\d/, Ob = /\d\d/, Pb = /\d{3}/, Qb = /\d{4}/, Rb = /[+-]?\d{6}/, Sb = /[+-]?\d+/, Tb = /^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/, Ub = "YYYY-MM-DDTHH:mm:ssZ", Vb = [
            ["YYYYYY-MM-DD", /[+-]\d{6}-\d{2}-\d{2}/],
            ["YYYY-MM-DD", /\d{4}-\d{2}-\d{2}/],
            ["GGGG-[W]WW-E", /\d{4}-W\d{2}-\d/],
            ["GGGG-[W]WW", /\d{4}-W\d{2}/],
            ["YYYY-DDD", /\d{4}-\d{3}/]
        ], Wb = [
            ["HH:mm:ss.SSSS", /(T| )\d\d:\d\d:\d\d\.\d+/],
            ["HH:mm:ss", /(T| )\d\d:\d\d:\d\d/],
            ["HH:mm", /(T| )\d\d:\d\d/],
            ["HH", /(T| )\d\d/]
        ], Xb = /([\+\-]|\d\d)/gi, Yb = ("Date|Hours|Minutes|Seconds|Milliseconds".split("|"), {
            Milliseconds: 1,
            Seconds: 1e3,
            Minutes: 6e4,
            Hours: 36e5,
            Days: 864e5,
            Months: 2592e6,
            Years: 31536e6
        }), Zb = {
            ms: "millisecond",
            s: "second",
            m: "minute",
            h: "hour",
            d: "day",
            D: "date",
            w: "week",
            W: "isoWeek",
            M: "month",
            Q: "quarter",
            y: "year",
            DDD: "dayOfYear",
            e: "weekday",
            E: "isoWeekday",
            gg: "weekYear",
            GG: "isoWeekYear"
        }, $b = {
            dayofyear: "dayOfYear",
            isoweekday: "isoWeekday",
            isoweek: "isoWeek",
            weekyear: "weekYear",
            isoweekyear: "isoWeekYear"
        }, _b = {}, ac = "DDD w W M D d".split(" "), bc = "M D H h m s w W".split(" "), cc = {
            M: function() {
                return this.month() + 1
            },
            MMM: function(a) {
                return this.lang().monthsShort(this, a)
            },
            MMMM: function(a) {
                return this.lang().months(this, a)
            },
            D: function() {
                return this.date()
            },
            DDD: function() {
                return this.dayOfYear()
            },
            d: function() {
                return this.day()
            },
            dd: function(a) {
                return this.lang().weekdaysMin(this, a)
            },
            ddd: function(a) {
                return this.lang().weekdaysShort(this, a)
            },
            dddd: function(a) {
                return this.lang().weekdays(this, a)
            },
            w: function() {
                return this.week()
            },
            W: function() {
                return this.isoWeek()
            },
            YY: function() {
                return l(this.year() % 100, 2)
            },
            YYYY: function() {
                return l(this.year(), 4)
            },
            YYYYY: function() {
                return l(this.year(), 5)
            },
            YYYYYY: function() {
                var
                    a = this.year(),
                    b = a >= 0 ? "+" : "-";
                return b + l(Math.abs(a), 6)
            },
            gg: function() {
                return l(this.weekYear() % 100, 2)
            },
            gggg: function() {
                return l(this.weekYear(), 4)
            },
            ggggg: function() {
                return l(this.weekYear(), 5)
            },
            GG: function() {
                return l(this.isoWeekYear() % 100, 2)
            },
            GGGG: function() {
                return l(this.isoWeekYear(), 4)
            },
            GGGGG: function() {
                return l(this.isoWeekYear(), 5)
            },
            e: function() {
                return this.weekday()
            },
            E: function() {
                return this.isoWeekday()
            },
            a: function() {
                return this.lang().meridiem(this.hours(), this.minutes(), !0)
            },
            A: function() {
                return this.lang().meridiem(this.hours(), this.minutes(), !1)
            },
            H: function() {
                return this.hours()
            },
            h: function() {
                return this.hours() % 12 || 12
            },
            m: function() {
                return this.minutes()
            },
            s: function() {
                return this.seconds()
            },
            S: function() {
                return t(this.milliseconds() / 100)
            },
            SS: function() {
                return l(t(this.milliseconds() / 10), 2)
            },
            SSS: function() {
                return l(this.milliseconds(), 3)
            },
            SSSS: function() {
                return l(this.milliseconds(), 3)
            },
            Z: function() {
                var
                    a = -this.zone(),
                    b = "+";
                return 0 > a && (a = -a, b = "-"), b + l(t(a / 60), 2) + ":" + l(t(a) % 60, 2)
            },
            ZZ: function() {
                var
                    a = -this.zone(),
                    b = "+";
                return 0 > a && (a = -a, b = "-"), b + l(t(a / 60), 2) + l(t(a) % 60, 2)
            },
            z: function() {
                return this.zoneAbbr()
            },
            zz: function() {
                return this.zoneName()
            },
            X: function() {
                return this.unix()
            },
            Q: function() {
                return this.quarter()
            }
        }, dc = ["months", "monthsShort", "weekdays", "weekdaysShort", "weekdaysMin"]; ac.length;) kb = ac.pop(), cc[kb + "o"] = e(cc[kb], kb);
    for (; bc.length;) kb = bc.pop(), cc[kb + kb] = d(cc[kb], 2);
    for (cc.DDDD = d(cc.DDD, 3), i(f.prototype, {
            set: function(a) {
                var
                    b, c;
                for (c in
                    a) b = a[c], "function" == typeof
                b ? this[c] = b : this["_" + c] = b
            },
            _months: "January_February_March_April_May_June_July_August_September_October_November_December".split("_"),
            months: function(a) {
                return this._months[a.month()]
            },
            _monthsShort: "Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),
            monthsShort: function(a) {
                return this._monthsShort[a.month()]
            },
            monthsParse: function(a) {
                var
                    b, c, d;
                for (this._monthsParse || (this._monthsParse = []), b = 0; 12 > b; b++)
                    if (this._monthsParse[b] || (c = ib.utc([2e3, b]), d = "^" + this.months(c, "") + "|^" + this.monthsShort(c, ""), this._monthsParse[b] = new RegExp(d.replace(".", ""), "i")), this._monthsParse[b].test(a)) return b
            },
            _weekdays: "Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),
            weekdays: function(a) {
                return this._weekdays[a.day()]
            },
            _weekdaysShort: "Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),
            weekdaysShort: function(a) {
                return this._weekdaysShort[a.day()]
            },
            _weekdaysMin: "Su_Mo_Tu_We_Th_Fr_Sa".split("_"),
            weekdaysMin: function(a) {
                return this._weekdaysMin[a.day()]
            },
            weekdaysParse: function(a) {
                var
                    b, c, d;
                for (this._weekdaysParse || (this._weekdaysParse = []), b = 0; 7 > b; b++)
                    if (this._weekdaysParse[b] || (c = ib([2e3, 1]).day(b), d = "^" + this.weekdays(c, "") + "|^" + this.weekdaysShort(c, "") + "|^" + this.weekdaysMin(c, ""), this._weekdaysParse[b] = new RegExp(d.replace(".", ""), "i")), this._weekdaysParse[b].test(a)) return b
            },
            _longDateFormat: {
                LT: "h:mm A",
                L: "MM/DD/YYYY",
                LL: "MMMM D YYYY",
                LLL: "MMMM D YYYY LT",
                LLLL: "dddd, MMMM D YYYY LT"
            },
            longDateFormat: function(a) {
                var
                    b = this._longDateFormat[a];
                return !b && this._longDateFormat[a.toUpperCase()] && (b = this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g, function(a) {
                    return a.slice(1)
                }), this._longDateFormat[a] = b), b
            },
            isPM: function(a) {
                return "p" === (a + "").toLowerCase().charAt(0)
            },
            _meridiemParse: /[ap]\.?m?\.?/i,
            meridiem: function(a, b, c) {
                return a > 11 ? c ? "pm" : "PM" : c ? "am" : "AM"
            },
            _calendar: {
                sameDay: "[Today at] LT",
                nextDay: "[Tomorrow at] LT",
                nextWeek: "dddd [at] LT",
                lastDay: "[Yesterday at] LT",
                lastWeek: "[Last] dddd [at] LT",
                sameElse: "L"
            },
            calendar: function(a, b) {
                var
                    c = this._calendar[a];
                return "function" == typeof
                c ? c.apply(b) : c
            },
            _relativeTime: {
                future: "in %s",
                past: "%s ago",
                s: "a few seconds",
                m: "a minute",
                mm: "%d minutes",
                h: "an hour",
                hh: "%d hours",
                d: "a day",
                dd: "%d days",
                M: "a month",
                MM: "%d months",
                y: "a year",
                yy: "%d years"
            },
            relativeTime: function(a, b, c, d) {
                var
                    e = this._relativeTime[c];
                return "function" == typeof
                e ? e(a, b, c, d) : e.replace(/%d/i, a)
            },
            pastFuture: function(a, b) {
                var
                    c = this._relativeTime[a > 0 ? "future" : "past"];
                return "function" == typeof
                c ? c(b) : c.replace(/%s/i, b)
            },
            ordinal: function(a) {
                return this._ordinal.replace("%d", a)
            },
            _ordinal: "%d",
            preparse: function(a) {
                return a
            },
            postformat: function(a) {
                return a
            },
            week: function(a) {
                return $(a, this._week.dow, this._week.doy).week
            },
            _week: {
                dow: 0,
                doy: 6
            },
            _invalidDate: "Invalid date",
            invalidDate: function() {
                return this._invalidDate
            }
        }), ib = function(c, d, e, f) {
            var
                g;
            return "boolean" == typeof
            e && (f = e, e = a), g = {}, g._isAMomentObject = !0, g._i = c, g._f = d, g._l = e, g._strict = f, g._isUTC = !1, g._pf = b(), ab(g)
        }, ib.suppressDeprecationWarnings = !1, ib.createFromInputFallback = c("moment construction falls back to js Date. This is discouraged and will be removed in upcoming major release. Please refer to https://github.com/moment/moment/issues/1407 for more info.", function(a) {
            a._d = new
            Date(a._i)
        }), ib.utc = function(c, d, e, f) {
            var
                g;
            return "boolean" == typeof
            e && (f = e, e = a), g = {}, g._isAMomentObject = !0, g._useUTC = !0, g._isUTC = !0, g._l = e, g._i = c, g._f = d, g._strict = f, g._pf = b(), ab(g).utc()
        }, ib.unix = function(a) {
            return ib(1e3 * a)
        }, ib.duration = function(a, b) {
            var
                c, d, e, f = a,
                g = null;
            return ib.isDuration(a) ? f = {
                ms: a._milliseconds,
                d: a._days,
                M: a._months
            } : "number" == typeof
            a ? (f = {}, b ? f[b] = a : f.milliseconds = a) : (g = zb.exec(a)) ? (c = "-" === g[1] ? -1 : 1, f = {
                y: 0,
                d: t(g[qb]) * c,
                h: t(g[rb]) * c,
                m: t(g[sb]) * c,
                s: t(g[tb]) * c,
                ms: t(g[ub]) * c
            }) : (g = Ab.exec(a)) && (c = "-" === g[1] ? -1 : 1, e = function(a) {
                var
                    b = a && parseFloat(a.replace(",", "."));
                return (isNaN(b) ? 0 : b) * c
            }, f = {
                y: e(g[2]),
                M: e(g[3]),
                d: e(g[4]),
                h: e(g[5]),
                m: e(g[6]),
                s: e(g[7]),
                w: e(g[8])
            }), d = new
            h(f), ib.isDuration(a) && a.hasOwnProperty("_lang") && (d._lang = a._lang), d
        }, ib.version = lb, ib.defaultFormat = Ub, ib.momentProperties = wb, ib.updateOffset = function() {}, ib.lang = function(a, b) {
            var
                c;
            return a ? (b ? C(A(a), b) : null === b ? (D(a), a = "en") : vb[a] || E(a), c = ib.duration.fn._lang = ib.fn._lang = E(a), c._abbr) : ib.fn._lang._abbr
        }, ib.langData = function(a) {
            return a && a._lang && a._lang._abbr && (a = a._lang._abbr), E(a)
        }, ib.isMoment = function(a) {
            return a
            instanceof
            g || null != a && a.hasOwnProperty("_isAMomentObject")
        }, ib.isDuration = function(a) {
            return a
            instanceof
            h
        }, kb = dc.length - 1; kb >= 0; --kb) s(dc[kb]);
    ib.normalizeUnits = function(a) {
        return q(a)
    }, ib.invalid = function(a) {
        var
            b = ib.utc(0 / 0);
        return null != a ? i(b._pf, a) : b._pf.userInvalidated = !0, b
    }, ib.parseZone = function() {
        return ib.apply(null, arguments).parseZone()
    }, ib.parseTwoDigitYear = function(a) {
        return t(a) + (t(a) > 68 ? 1900 : 2e3)
    }, i(ib.fn = g.prototype, {
        clone: function() {
            return ib(this)
        },
        valueOf: function() {
            return +this._d + 6e4 * (this._offset || 0)
        },
        unix: function() {
            return Math.floor(+this / 1e3)
        },
        toString: function() {
            return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")
        },
        toDate: function() {
            return this._offset ? new
            Date(+this): this._d
        },
        toISOString: function() {
            var
                a = ib(this).utc();
            return 0 < a.year() && a.year() <= 9999 ? H(a, "YYYY-MM-DD[T]HH:mm:ss.SSS[Z]") : H(a, "YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")
        },
        toArray: function() {
            var
                a = this;
            return [a.year(), a.month(), a.date(), a.hours(), a.minutes(), a.seconds(), a.milliseconds()]
        },
        isValid: function() {
            return z(this)
        },
        isDSTShifted: function() {
            return this._a ? this.isValid() && p(this._a, (this._isUTC ? ib.utc(this._a) : ib(this._a)).toArray()) > 0 : !1
        },
        parsingFlags: function() {
            return i({}, this._pf)
        },
        invalidAt: function() {
            return this._pf.overflow
        },
        utc: function() {
            return this.zone(0)
        },
        local: function() {
            return this.zone(0), this._isUTC = !1, this
        },
        format: function(a) {
            var
                b = H(this, a || ib.defaultFormat);
            return this.lang().postformat(b)
        },
        add: function(a, b) {
            var
                c;
            return c = "string" == typeof
            a ? ib.duration(+b, a) : ib.duration(a, b), m(this, c, 1), this
        },
        subtract: function(a, b) {
            var
                c;
            return c = "string" == typeof
            a ? ib.duration(+b, a) : ib.duration(a, b), m(this, c, -1), this
        },
        diff: function(a, b, c) {
            var
                d, e, f = B(a, this),
                g = 6e4 * (this.zone() - f.zone());
            return b = q(b), "year" === b || "month" === b ? (d = 432e5 * (this.daysInMonth() + f.daysInMonth()), e = 12 * (this.year() - f.year()) + (this.month() - f.month()), e += (this - ib(this).startOf("month") - (f - ib(f).startOf("month"))) / d, e -= 6e4 * (this.zone() - ib(this).startOf("month").zone() - (f.zone() - ib(f).startOf("month").zone())) / d, "year" === b && (e /= 12)) : (d = this - f, e = "second" === b ? d / 1e3 : "minute" === b ? d / 6e4 : "hour" === b ? d / 36e5 : "day" === b ? (d - g) / 864e5 : "week" === b ? (d - g) / 6048e5 : d), c ? e : k(e)
        },
        from: function(a, b) {
            return ib.duration(this.diff(a)).lang(this.lang()._abbr).humanize(!b)
        },
        fromNow: function(a) {
            return this.from(ib(), a)
        },
        calendar: function() {
            var
                a = B(ib(), this).startOf("day"),
                b = this.diff(a, "days", !0),
                c = -6 > b ? "sameElse" : -1 > b ? "lastWeek" : 0 > b ? "lastDay" : 1 > b ? "sameDay" : 2 > b ? "nextDay" : 7 > b ? "nextWeek" : "sameElse";
            return this.format(this.lang().calendar(c, this))
        },
        isLeapYear: function() {
            return x(this.year())
        },
        isDST: function() {
            return this.zone() < this.clone().month(0).zone() || this.zone() < this.clone().month(5).zone()
        },
        day: function(a) {
            var
                b = this._isUTC ? this._d.getUTCDay() : this._d.getDay();
            return null != a ? (a = X(a, this.lang()), this.add({
                d: a - b
            })) : b
        },
        month: eb("Month", !0),
        startOf: function(a) {
            switch (a = q(a)) {
                case "year":
                    this.month(0);
                case "quarter":
                case "month":
                    this.date(1);
                case "week":
                case "isoWeek":
                case "day":
                    this.hours(0);
                case "hour":
                    this.minutes(0);
                case "minute":
                    this.seconds(0);
                case "second":
                    this.milliseconds(0)
            }
            return "week" === a ? this.weekday(0) : "isoWeek" === a && this.isoWeekday(1), "quarter" === a && this.month(3 * Math.floor(this.month() / 3)), this
        },
        endOf: function(a) {
            return a = q(a), this.startOf(a).add("isoWeek" === a ? "week" : a, 1).subtract("ms", 1)
        },
        isAfter: function(a, b) {
            return b = "undefined" != typeof
            b ? b : "millisecond", +this.clone().startOf(b) > +ib(a).startOf(b)
        },
        isBefore: function(a, b) {
            return b = "undefined" != typeof
            b ? b : "millisecond", +this.clone().startOf(b) < +ib(a).startOf(b)
        },
        isSame: function(a, b) {
            return b = b || "ms", +this.clone().startOf(b) === +B(a, this).startOf(b)
        },
        min: function(a) {
            return a = ib.apply(null, arguments), this > a ? this : a
        },
        max: function(a) {
            return a = ib.apply(null, arguments), a > this ? this : a
        },
        zone: function(a, b) {
            var
                c = this._offset || 0;
            return null == a ? this._isUTC ? c : this._d.getTimezoneOffset() : ("string" == typeof a && (a = K(a)), Math.abs(a) < 16 && (a = 60 * a), this._offset = a, this._isUTC = !0, c !== a && (!b || this._changeInProgress ? m(this, ib.duration(c - a, "m"), 1, !1) : this._changeInProgress || (this._changeInProgress = !0, ib.updateOffset(this, !0), this._changeInProgress = null)), this)
        },
        zoneAbbr: function() {
            return this._isUTC ? "UTC" : ""
        },
        zoneName: function() {
            return this._isUTC ? "Coordinated Universal Time" : ""
        },
        parseZone: function() {
            return this._tzm ? this.zone(this._tzm) : "string" == typeof
            this._i && this.zone(this._i), this
        },
        hasAlignedHourOffset: function(a) {
            return a = a ? ib(a).zone() : 0, (this.zone() - a) % 60 === 0
        },
        daysInMonth: function() {
            return u(this.year(), this.month())
        },
        dayOfYear: function(a) {
            var
                b = nb((ib(this).startOf("day") - ib(this).startOf("year")) / 864e5) + 1;
            return null == a ? b : this.add("d", a - b)
        },
        quarter: function(a) {
            return null == a ? Math.ceil((this.month() + 1) / 3) : this.month(3 * (a - 1) + this.month() % 3)
        },
        weekYear: function(a) {
            var
                b = $(this, this.lang()._week.dow, this.lang()._week.doy).year;
            return null == a ? b : this.add("y", a - b)
        },
        isoWeekYear: function(a) {
            var
                b = $(this, 1, 4).year;
            return null == a ? b : this.add("y", a - b)
        },
        week: function(a) {
            var
                b = this.lang().week(this);
            return null == a ? b : this.add("d", 7 * (a - b))
        },
        isoWeek: function(a) {
            var
                b = $(this, 1, 4).week;
            return null == a ? b : this.add("d", 7 * (a - b))
        },
        weekday: function(a) {
            var
                b = (this.day() + 7 - this.lang()._week.dow) % 7;
            return null == a ? b : this.add("d", a - b)
        },
        isoWeekday: function(a) {
            return null == a ? this.day() || 7 : this.day(this.day() % 7 ? a : a - 7)
        },
        isoWeeksInYear: function() {
            return v(this.year(), 1, 4)
        },
        weeksInYear: function() {
            var
                a = this._lang._week;
            return v(this.year(), a.dow, a.doy)
        },
        get: function(a) {
            return a = q(a), this[a]()
        },
        set: function(a, b) {
            return a = q(a), "function" == typeof
            this[a] && this[a](b), this
        },
        lang: function(b) {
            return b === a ? this._lang : (this._lang = E(b), this)
        }
    }), ib.fn.millisecond = ib.fn.milliseconds = eb("Milliseconds", !1), ib.fn.second = ib.fn.seconds = eb("Seconds", !1), ib.fn.minute = ib.fn.minutes = eb("Minutes", !1), ib.fn.hour = ib.fn.hours = eb("Hours", !0), ib.fn.date = eb("Date", !0), ib.fn.dates = c("dates accessor is deprecated. Use date instead.", eb("Date", !0)), ib.fn.year = eb("FullYear", !0), ib.fn.years = c("years accessor is deprecated. Use year instead.", eb("FullYear", !0)), ib.fn.days = ib.fn.day, ib.fn.months = ib.fn.month, ib.fn.weeks = ib.fn.week, ib.fn.isoWeeks = ib.fn.isoWeek, ib.fn.quarters = ib.fn.quarter, ib.fn.toJSON = ib.fn.toISOString, i(ib.duration.fn = h.prototype, {
        _bubble: function() {
            var
                a, b, c, d, e = this._milliseconds,
                f = this._days,
                g = this._months,
                h = this._data;
            h.milliseconds = e % 1e3, a = k(e / 1e3), h.seconds = a % 60, b = k(a / 60), h.minutes = b % 60, c = k(b / 60), h.hours = c % 24, f += k(c / 24), h.days = f % 30, g += k(f / 30), h.months = g % 12, d = k(g / 12), h.years = d
        },
        weeks: function() {
            return k(this.days() / 7)
        },
        valueOf: function() {
            return this._milliseconds + 864e5 * this._days + this._months % 12 * 2592e6 + 31536e6 * t(this._months / 12)
        },
        humanize: function(a) {
            var
                b = +this,
                c = Z(b, !a, this.lang());
            return a && (c = this.lang().pastFuture(b, c)), this.lang().postformat(c)
        },
        add: function(a, b) {
            var
                c = ib.duration(a, b);
            return this._milliseconds += c._milliseconds, this._days += c._days, this._months += c._months, this._bubble(), this
        },
        subtract: function(a, b) {
            var
                c = ib.duration(a, b);
            return this._milliseconds -= c._milliseconds, this._days -= c._days, this._months -= c._months, this._bubble(), this
        },
        get: function(a) {
            return a = q(a), this[a.toLowerCase() + "s"]()
        },
        as: function(a) {
            return a = q(a), this["as" + a.charAt(0).toUpperCase() + a.slice(1) + "s"]()
        },
        lang: ib.fn.lang,
        toIsoString: function() {
            var
                a = Math.abs(this.years()),
                b = Math.abs(this.months()),
                c = Math.abs(this.days()),
                d = Math.abs(this.hours()),
                e = Math.abs(this.minutes()),
                f = Math.abs(this.seconds() + this.milliseconds() / 1e3);
            return this.asSeconds() ? (this.asSeconds() < 0 ? "-" : "") + "P" + (a ? a + "Y" : "") + (b ? b + "M" : "") + (c ? c + "D" : "") + (d || e || f ? "T" : "") + (d ? d + "H" : "") + (e ? e + "M" : "") + (f ? f + "S" : "") : "P0D"
        }
    });
    for (kb in
        Yb) Yb.hasOwnProperty(kb) && (gb(kb, Yb[kb]), fb(kb.toLowerCase()));
    gb("Weeks", 6048e5), ib.duration.fn.asMonths = function() {
        return (+this - 31536e6 * this.years()) / 2592e6 + 12 * this.years()
    }, ib.lang("en", {
        ordinal: function(a) {
            var
                b = a % 10,
                c = 1 === t(a % 100 / 10) ? "th" : 1 === b ? "st" : 2 === b ? "nd" : 3 === b ? "rd" : "th";
            return a + c
        }
    }), xb ? module.exports = ib : "function" == typeof
    define && define.amd ? (define("moment", function(a, b, c) {
        return c.config && c.config() && c.config().noGlobal === !0 && (mb.moment = jb), ib
    }), hb(!0)) : hb()
}).call(this);;
(function(factory) {
    if (typeof define === 'function' && define.amd) {
        define(['jquery', 'moment'], factory);
    } else {
        if (!jQuery) {
            throw 'bootstrap-datetimepicker requires jQuery to be loaded first';
        } else
        if (!moment) {
            throw 'bootstrap-datetimepicker requires moment.js to be loaded first';
        } else {
            factory(jQuery, moment);
        }
    }
}(function($, moment) {
    if (typeof moment === 'undefined') {
        alert("momentjs is requried");
        throw new
        Error('momentjs is required');
    };
    var
        dpgId = 0,
        pMoment = moment,
        DateTimePicker = function(element, options) {
            var
                defaults = {
                    pickDate: true,
                    pickTime: true,
                    useMinutes: true,
                    useSeconds: false,
                    useCurrent: true,
                    minuteStepping: 1,
                    minDate: new
                    pMoment({
                        y: 1900
                    }),
                    maxDate: new
                    pMoment().add(100, "y"),
                    showToday: true,
                    collapse: true,
                    language: "en",
                    defaultDate: "",
                    disabledDates: false,
                    enabledDates: false,
                    icons: {},
                    useStrict: false,
                    direction: "auto",
                    sideBySide: false,
                    daysOfWeekDisabled: false
                },
                icons = {
                    time: 'glyphicon glyphicon-time',
                    date: 'glyphicon glyphicon-calendar',
                    up: 'glyphicon glyphicon-chevron-up',
                    down: 'glyphicon glyphicon-chevron-down'
                },
                picker = this,
                init = function() {
                    var
                        icon = false,
                        i, dDate, longDateFormat;
                    picker.options = $.extend({}, defaults, options);
                    picker.options.icons = $.extend({}, icons, picker.options.icons);
                    picker.element = $(element);
                    dataToOptions();
                    if (!(picker.options.pickTime || picker.options.pickDate)) throw new
                    Error('Must choose at least one picker');
                    picker.id = dpgId++;
                    pMoment.lang(picker.options.language);
                    picker.date = pMoment();
                    picker.unset = false;
                    picker.isInput = picker.element.is('input');
                    picker.component = false;
                    if (picker.element.hasClass('input-group')) {
                        if (picker.element.find('.datepickerbutton').size() == 0) {
                            picker.component = picker.element.find("[class^='input-group-']");
                        } else {
                            picker.component = picker.element.find('.datepickerbutton');
                        }
                    }
                    picker.format = picker.options.format;
                    longDateFormat = pMoment()._lang._longDateFormat;
                    if (!picker.format) {
                        picker.format = (picker.options.pickDate ? longDateFormat.L : '');
                        if (picker.options.pickDate && picker.options.pickTime) picker.format += ' ';
                        picker.format += (picker.options.pickTime ? longDateFormat.LT : '');
                        if (picker.options.useSeconds) {
                            if (~longDateFormat.LT.indexOf(' A')) {
                                picker.format = picker.format.split(" A")[0] + ":ss A";
                            } else {
                                picker.format += ':ss';
                            }
                        }
                    }
                    picker.use24hours = picker.format.toLowerCase().indexOf("a") < 1;
                    if (picker.component) icon = picker.component.find('span');
                    if (picker.options.pickTime) {
                        if (icon) icon.addClass(picker.options.icons.time);
                    }
                    if (picker.options.pickDate) {
                        if (icon) {
                            icon.removeClass(picker.options.icons.time);
                            icon.addClass(picker.options.icons.date);
                        }
                    }
                    picker.widget = $(getTemplate()).appendTo('body');
                    if (picker.options.useSeconds && !picker.use24hours) {
                        picker.widget.width(300);
                    }
                    picker.minViewMode = picker.options.minViewMode || 0;
                    if (typeof picker.minViewMode === 'string') {
                        switch (picker.minViewMode) {
                            case 'months':
                                picker.minViewMode = 1;
                                break;
                            case 'years':
                                picker.minViewMode = 2;
                                break;
                            default:
                                picker.minViewMode = 0;
                                break;
                        }
                    }
                    picker.viewMode = picker.options.viewMode || 0;
                    if (typeof picker.viewMode === 'string') {
                        switch (picker.viewMode) {
                            case 'months':
                                picker.viewMode = 1;
                                break;
                            case 'years':
                                picker.viewMode = 2;
                                break;
                            default:
                                picker.viewMode = 0;
                                break;
                        }
                    }
                    picker.options.disabledDates = indexGivenDates(picker.options.disabledDates);
                    picker.options.enabledDates = indexGivenDates(picker.options.enabledDates);
                    picker.startViewMode = picker.viewMode;
                    picker.setMinDate(picker.options.minDate);
                    picker.setMaxDate(picker.options.maxDate);
                    fillDow();
                    fillMonths();
                    fillHours();
                    fillMinutes();
                    fillSeconds();
                    update();
                    showMode();
                    attachDatePickerEvents();
                    if (picker.options.defaultDate !== "" && getPickerInput().val() == "") picker.setValue(picker.options.defaultDate);
                    if (picker.options.minuteStepping !== 1) {
                        var
                            rInterval = picker.options.minuteStepping;
                        picker.date.minutes((Math.round(picker.date.minutes() / rInterval) * rInterval) % 60).seconds(0);
                    }
                },
                getPickerInput = function() {
                    if (picker.isInput) {
                        return picker.element;
                    } else {
                        return dateStr = picker.element.find('input');
                    }
                },
                dataToOptions = function() {
                    var
                        eData
                    if (picker.element.is('input')) {
                        eData = picker.element.data();
                    } else {
                        eData = picker.element.data();
                    }
                    if (eData.dateFormat !== undefined) picker.options.format = eData.dateFormat;
                    if (eData.datePickdate !== undefined) picker.options.pickDate = eData.datePickdate;
                    if (eData.datePicktime !== undefined) picker.options.pickTime = eData.datePicktime;
                    if (eData.dateUseminutes !== undefined) picker.options.useMinutes = eData.dateUseminutes;
                    if (eData.dateUseseconds !== undefined) picker.options.useSeconds = eData.dateUseseconds;
                    if (eData.dateUsecurrent !== undefined) picker.options.useCurrent = eData.dateUsecurrent;
                    if (eData.dateMinutestepping !== undefined) picker.options.minuteStepping = eData.dateMinutestepping;
                    if (eData.dateMindate !== undefined) picker.options.minDate = eData.dateMindate;
                    if (eData.dateMaxdate !== undefined) picker.options.maxDate = eData.dateMaxdate;
                    if (eData.dateShowtoday !== undefined) picker.options.showToday = eData.dateShowtoday;
                    if (eData.dateCollapse !== undefined) picker.options.collapse = eData.dateCollapse;
                    if (eData.dateLanguage !== undefined) picker.options.language = eData.dateLanguage;
                    if (eData.dateDefaultdate !== undefined) picker.options.defaultDate = eData.dateDefaultdate;
                    if (eData.dateDisableddates !== undefined) picker.options.disabledDates = eData.dateDisableddates;
                    if (eData.dateEnableddates !== undefined) picker.options.enabledDates = eData.dateEnableddates;
                    if (eData.dateIcons !== undefined) picker.options.icons = eData.dateIcons;
                    if (eData.dateUsestrict !== undefined) picker.options.useStrict = eData.dateUsestrict;
                    if (eData.dateDirection !== undefined) picker.options.direction = eData.dateDirection;
                    if (eData.dateSidebyside !== undefined) picker.options.sideBySide = eData.dateSidebyside;
                },
                place = function() {
                    var
                        position = 'absolute',
                        offset = picker.component ? picker.component.offset() : picker.element.offset(),
                        $window = $(window);
                    picker.width = picker.component ? picker.component.outerWidth() : picker.element.outerWidth();
                    offset.top = offset.top + picker.element.outerHeight();
                    var
                        placePosition;
                    if (picker.options.direction === 'up') {
                        placePosition = 'top'
                    } else
                    if (picker.options.direction === 'bottom') {
                        placePosition = 'bottom'
                    } else
                    if (picker.options.direction === 'auto') {
                        if (offset.top + picker.widget.height() > $window.height() + $window.scrollTop() && picker.widget.height() + picker.element.outerHeight() < offset.top) {
                            placePosition = 'top';
                        } else {
                            placePosition = 'bottom';
                        }
                    };
                    if (placePosition === 'top') {
                        offset.top -= picker.widget.height() + picker.element.outerHeight() + 15;
                        picker.widget.addClass('top').removeClass('bottom');
                    } else {
                        offset.top += 1;
                        picker.widget.addClass('bottom').removeClass('top');
                    }
                    if (picker.options.width !== undefined) {
                        picker.widget.width(picker.options.width);
                    }
                    if (picker.options.orientation === 'left') {
                        picker.widget.addClass('left-oriented');
                        offset.left = offset.left - picker.widget.width() + 20;
                    }
                    if (isInFixed()) {
                        position = 'fixed';
                        offset.top -= $window.scrollTop();
                        offset.left -= $window.scrollLeft();
                    }
                    if ($window.width() < offset.left + picker.widget.outerWidth()) {
                        offset.right = $window.width() - offset.left - picker.width;
                        offset.left = 'auto';
                        picker.widget.addClass('pull-right');
                    } else {
                        offset.right = 'auto';
                        picker.widget.removeClass('pull-right');
                    }
                    picker.widget.css({
                        position: position,
                        top: offset.top,
                        left: offset.left,
                        right: offset.right
                    });
                },
                notifyChange = function(oldDate, eventType) {
                    if (pMoment(picker.date).isSame(pMoment(oldDate))) return;
                    picker.element.trigger({
                        type: 'dp.change',
                        date: pMoment(picker.date),
                        oldDate: pMoment(oldDate)
                    });
                    if (eventType !== 'change') picker.element.change();
                },
                notifyError = function(date) {
                    picker.element.trigger({
                        type: 'dp.error',
                        date: pMoment(date)
                    });
                },
                update = function(newDate) {
                    pMoment.lang(picker.options.language);
                    var
                        dateStr = newDate;
                    if (!dateStr) {
                        dateStr = getPickerInput().val();
                        if (dateStr) picker.date = pMoment(dateStr, picker.format, picker.options.useStrict);
                        if (!picker.date) picker.date = pMoment();
                    }
                    picker.viewDate = pMoment(picker.date).startOf("month");
                    fillDate();
                    fillTime();
                },
                fillDow = function() {
                    pMoment.lang(picker.options.language);
                    var
                        html = $('<tr>'),
                        weekdaysMin = pMoment.weekdaysMin(),
                        i;
                    if (pMoment()._lang._week.dow == 0) {
                        for (i = 0; i < 7; i++) {
                            html.append('<th class="dow">' + weekdaysMin[i] + '</th>');
                        }
                    } else {
                        for (i = 1; i < 8; i++) {
                            if (i == 7) {
                                html.append('<th class="dow">' + weekdaysMin[0] + '</th>');
                            } else {
                                html.append('<th class="dow">' + weekdaysMin[i] + '</th>');
                            }
                        }
                    }
                    picker.widget.find('.datepicker-days thead').append(html);
                },
                fillMonths = function() {
                    pMoment.lang(picker.options.language);
                    var
                        html = '',
                        i = 0,
                        monthsShort = pMoment.monthsShort();
                    while (i < 12) {
                        html += '<span class="month">' + monthsShort[i++] + '</span>';
                    }
                    picker.widget.find('.datepicker-months td').append(html);
                },
                fillDate = function() {
                    pMoment.lang(picker.options.language);
                    var
                        year = picker.viewDate.year(),
                        month = picker.viewDate.month(),
                        startYear = picker.options.minDate.year(),
                        startMonth = picker.options.minDate.month(),
                        endYear = picker.options.maxDate.year(),
                        endMonth = picker.options.maxDate.month(),
                        prevMonth, nextMonth, html = [],
                        row, clsName, i, days, yearCont, currentYear, months = pMoment.months();
                    picker.widget.find('.datepicker-days').find('.disabled').removeClass('disabled');
                    picker.widget.find('.datepicker-months').find('.disabled').removeClass('disabled');
                    picker.widget.find('.datepicker-years').find('.disabled').removeClass('disabled');
                    picker.widget.find('.datepicker-days th:eq(1)').text(months[month] + ' ' + year);
                    prevMonth = pMoment(picker.viewDate).subtract("months", 1);
                    days = prevMonth.daysInMonth();
                    prevMonth.date(days).startOf('week');
                    if ((year == startYear && month <= startMonth) || year < startYear) {
                        picker.widget.find('.datepicker-days th:eq(0)').addClass('disabled');
                    }
                    if ((year == endYear && month >= endMonth) || year > endYear) {
                        picker.widget.find('.datepicker-days th:eq(2)').addClass('disabled');
                    }
                    nextMonth = pMoment(prevMonth).add(42, "d");
                    while (prevMonth.isBefore(nextMonth)) {
                        if (prevMonth.weekday() === pMoment().startOf('week').weekday()) {
                            row = $('<tr>');
                            html.push(row);
                        }
                        clsName = '';
                        if (prevMonth.year() < year || (prevMonth.year() == year && prevMonth.month() < month)) {
                            clsName += ' old';
                        } else
                        if (prevMonth.year() > year || (prevMonth.year() == year && prevMonth.month() > month)) {
                            clsName += ' new';
                        }
                        if (prevMonth.isSame(pMoment({
                                y: picker.date.year(),
                                M: picker.date.month(),
                                d: picker.date.date()
                            }))) {
                            clsName += ' active';
                        }
                        if (isInDisableDates(prevMonth) || !isInEnableDates(prevMonth)) {
                            clsName += ' disabled';
                        }
                        if (picker.options.showToday === true) {
                            if (prevMonth.isSame(pMoment(), 'day')) {
                                clsName += ' today';
                            }
                        }
                        if (picker.options.daysOfWeekDisabled) {
                            for (i in
                                picker.options.daysOfWeekDisabled) {
                                if (prevMonth.day() == picker.options.daysOfWeekDisabled[i]) {
                                    clsName += ' disabled';
                                    break;
                                }
                            }
                        }
                        row.append('<td class="day' + clsName + '">' + prevMonth.date() + '</td>');
                        prevMonth.add(1, "d");
                    }
                    picker.widget.find('.datepicker-days tbody').empty().append(html);
                    currentYear = picker.date.year(), months = picker.widget.find('.datepicker-months').find('th:eq(1)').text(year).end().find('span').removeClass('active');
                    if (currentYear === year) {
                        months.eq(picker.date.month()).addClass('active');
                    }
                    if (currentYear - 1 < startYear) {
                        picker.widget.find('.datepicker-months th:eq(0)').addClass('disabled');
                    }
                    if (currentYear + 1 > endYear) {
                        picker.widget.find('.datepicker-months th:eq(2)').addClass('disabled');
                    }
                    for (i = 0; i < 12; i++) {
                        if ((year == startYear && startMonth > i) || (year < startYear)) {
                            $(months[i]).addClass('disabled');
                        } else
                        if ((year == endYear && endMonth < i) || (year > endYear)) {
                            $(months[i]).addClass('disabled');
                        }
                    }
                    html = '';
                    year = parseInt(year / 10, 10) * 10;
                    yearCont = picker.widget.find('.datepicker-years').find('th:eq(1)').text(year + '-' + (year + 9)).end().find('td');
                    picker.widget.find('.datepicker-years').find('th').removeClass('disabled');
                    if (startYear > year) {
                        picker.widget.find('.datepicker-years').find('th:eq(0)').addClass('disabled');
                    }
                    if (endYear < year + 9) {
                        picker.widget.find('.datepicker-years').find('th:eq(2)').addClass('disabled');
                    }
                    year -= 1;
                    for (i = -1; i < 11; i++) {
                        html += '<span class="year' + (i === -1 || i === 10 ? ' old' : '') + (currentYear === year ? ' active' : '') + ((year < startYear || year > endYear) ? ' disabled' : '') + '">' + year + '</span>';
                        year += 1;
                    }
                    yearCont.html(html);
                },
                fillHours = function() {
                    pMoment.lang(picker.options.language);
                    var
                        table = picker.widget.find('.timepicker .timepicker-hours table'),
                        html = '',
                        current, i, j;
                    table.parent().hide();
                    if (picker.use24hours) {
                        current = 0;
                        for (i = 0; i < 6; i += 1) {
                            html += '<tr>';
                            for (j = 0; j < 4; j += 1) {
                                html += '<td class="hour">' + padLeft(current.toString()) + '</td>';
                                current++;
                            }
                            html += '</tr>';
                        }
                    } else {
                        current = 1;
                        for (i = 0; i < 3; i += 1) {
                            html += '<tr>';
                            for (j = 0; j < 4; j += 1) {
                                html += '<td class="hour">' + padLeft(current.toString()) + '</td>';
                                current++;
                            }
                            html += '</tr>';
                        }
                    }
                    table.html(html);
                },
                fillMinutes = function() {
                    var
                        table = picker.widget.find('.timepicker .timepicker-minutes table'),
                        html = '',
                        current = 0,
                        i, j, step = picker.options.minuteStepping;
                    table.parent().hide();
                    if (step == 1) step = 5;
                    for (i = 0; i < Math.ceil(60 / step / 4); i++) {
                        html += '<tr>';
                        for (j = 0; j < 4; j += 1) {
                            if (current < 60) {
                                html += '<td class="minute">' + padLeft(current.toString()) + '</td>';
                                current += step;
                            } else {
                                html += '<td></td>';
                            }
                        }
                        html += '</tr>';
                    }
                    table.html(html);
                },
                fillSeconds = function() {
                    var
                        table = picker.widget.find('.timepicker .timepicker-seconds table'),
                        html = '',
                        current = 0,
                        i, j;
                    table.parent().hide();
                    for (i = 0; i < 3; i++) {
                        html += '<tr>';
                        for (j = 0; j < 4; j += 1) {
                            html += '<td class="second">' + padLeft(current.toString()) + '</td>';
                            current += 5;
                        }
                        html += '</tr>';
                    }
                    table.html(html);
                },
                fillTime = function() {
                    if (!picker.date) return;
                    var
                        timeComponents = picker.widget.find('.timepicker span[data-time-component]'),
                        hour = picker.date.hours(),
                        period = 'AM';
                    if (!picker.use24hours) {
                        if (hour >= 12) period = 'PM';
                        if (hour === 0) hour = 12;
                        else
                        if (hour != 12) hour = hour % 12;
                        picker.widget.find('.timepicker [data-action=togglePeriod]').text(period);
                    }
                    timeComponents.filter('[data-time-component=hours]').text(padLeft(hour));
                    timeComponents.filter('[data-time-component=minutes]').text(padLeft(picker.date.minutes()));
                    timeComponents.filter('[data-time-component=seconds]').text(padLeft(picker.date.second()));
                },
                click = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    picker.unset = false;
                    var
                        target = $(e.target).closest('span, td, th'),
                        month, year, step, day, oldDate = pMoment(picker.date);
                    if (target.length === 1) {
                        if (!target.is('.disabled')) {
                            switch (target[0].nodeName.toLowerCase()) {
                                case 'th':
                                    switch (target[0].className) {
                                        case 'switch':
                                            showMode(1);
                                            break;
                                        case 'prev':
                                        case 'next':
                                            step = dpGlobal.modes[picker.viewMode].navStep;
                                            if (target[0].className === 'prev') step = step * -1;
                                            picker.viewDate.add(step, dpGlobal.modes[picker.viewMode].navFnc);
                                            fillDate();
                                            break;
                                    }
                                    break;
                                case 'span':
                                    if (target.is('.month')) {
                                        month = target.parent().find('span').index(target);
                                        picker.viewDate.month(month);
                                    } else {
                                        year = parseInt(target.text(), 10) || 0;
                                        picker.viewDate.year(year);
                                    }
                                    if (picker.viewMode === picker.minViewMode) {
                                        picker.date = pMoment({
                                            y: picker.viewDate.year(),
                                            M: picker.viewDate.month(),
                                            d: picker.viewDate.date(),
                                            h: picker.date.hours(),
                                            m: picker.date.minutes(),
                                            s: picker.date.seconds()
                                        });
                                        notifyChange(oldDate, e.type);
                                        set();
                                    }
                                    showMode(-1);
                                    fillDate();
                                    break;
                                case 'td':
                                    if (target.is('.day')) {
                                        day = parseInt(target.text(), 10) || 1;
                                        month = picker.viewDate.month();
                                        year = picker.viewDate.year();
                                        if (target.is('.old')) {
                                            if (month === 0) {
                                                month = 11;
                                                year -= 1;
                                            } else {
                                                month -= 1;
                                            }
                                        } else
                                        if (target.is('.new')) {
                                            if (month == 11) {
                                                month = 0;
                                                year += 1;
                                            } else {
                                                month += 1;
                                            }
                                        }
                                        picker.date = pMoment({
                                            y: year,
                                            M: month,
                                            d: day,
                                            h: picker.date.hours(),
                                            m: picker.date.minutes(),
                                            s: picker.date.seconds()
                                        });
                                        picker.viewDate = pMoment({
                                            y: year,
                                            M: month,
                                            d: Math.min(28, day)
                                        });
                                        fillDate();
                                        set();
                                        notifyChange(oldDate, e.type);
                                    }
                                    break;
                            }
                        }
                    }
                },
                actions = {
                    incrementHours: function() {
                        checkDate("add", "hours", 1);
                    },
                    incrementMinutes: function() {
                        checkDate("add", "minutes", picker.options.minuteStepping);
                    },
                    incrementSeconds: function() {
                        checkDate("add", "seconds", 1);
                    },
                    decrementHours: function() {
                        checkDate("subtract", "hours", 1);
                    },
                    decrementMinutes: function() {
                        checkDate("subtract", "minutes", picker.options.minuteStepping);
                    },
                    decrementSeconds: function() {
                        checkDate("subtract", "seconds", 1);
                    },
                    togglePeriod: function() {
                        var
                            hour = picker.date.hours();
                        if (hour >= 12) hour -= 12;
                        else
                            hour += 12;
                        picker.date.hours(hour);
                    },
                    showPicker: function() {
                        picker.widget.find('.timepicker > div:not(.timepicker-picker)').hide();
                        picker.widget.find('.timepicker .timepicker-picker').show();
                    },
                    showHours: function() {
                        picker.widget.find('.timepicker .timepicker-picker').hide();
                        picker.widget.find('.timepicker .timepicker-hours').show();
                    },
                    showMinutes: function() {
                        picker.widget.find('.timepicker .timepicker-picker').hide();
                        picker.widget.find('.timepicker .timepicker-minutes').show();
                    },
                    showSeconds: function() {
                        picker.widget.find('.timepicker .timepicker-picker').hide();
                        picker.widget.find('.timepicker .timepicker-seconds').show();
                    },
                    selectHour: function(e) {
                        var
                            period = picker.widget.find('.timepicker [data-action=togglePeriod]').text(),
                            hour = parseInt($(e.target).text(), 10);
                        if (period == "PM") hour += 12
                        picker.date.hours(hour);
                        actions.showPicker.call(picker);
                    },
                    selectMinute: function(e) {
                        picker.date.minutes(parseInt($(e.target).text(), 10));
                        actions.showPicker.call(picker);
                    },
                    selectSecond: function(e) {
                        picker.date.seconds(parseInt($(e.target).text(), 10));
                        actions.showPicker.call(picker);
                    }
                },
                doAction = function(e) {
                    var
                        oldDate = pMoment(picker.date),
                        action = $(e.currentTarget).data('action'),
                        rv = actions[action].apply(picker, arguments);
                    stopEvent(e);
                    if (!picker.date) picker.date = pMoment({
                        y: 1970
                    });
                    set();
                    fillTime();
                    notifyChange(oldDate, e.type);
                    return rv;
                },
                stopEvent = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                },
                change = function(e) {
                    pMoment.lang(picker.options.language);
                    var
                        input = $(e.target),
                        oldDate = pMoment(picker.date),
                        newDate = pMoment(input.val(), picker.format, picker.options.useStrict);
                    if (newDate.isValid() && !isInDisableDates(newDate) && isInEnableDates(newDate)) {
                        update();
                        picker.setValue(newDate);
                        notifyChange(oldDate, e.type);
                        set();
                    } else {
                        picker.viewDate = oldDate;
                        notifyChange(oldDate, e.type);
                        notifyError(newDate);
                        picker.unset = true;
                    }
                },
                showMode = function(dir) {
                    if (dir) {
                        picker.viewMode = Math.max(picker.minViewMode, Math.min(2, picker.viewMode + dir));
                    }
                    var
                        f = dpGlobal.modes[picker.viewMode].clsName;
                    picker.widget.find('.datepicker > div').hide().filter('.datepicker-' + dpGlobal.modes[picker.viewMode].clsName).show();
                },
                attachDatePickerEvents = function() {
                    var
                        $this, $parent, expanded, closed, collapseData;
                    picker.widget.on('click', '.datepicker *', $.proxy(click, this));
                    picker.widget.on('click', '[data-action]', $.proxy(doAction, this));
                    picker.widget.on('mousedown', $.proxy(stopEvent, this));
                    if (picker.options.pickDate && picker.options.pickTime) {
                        picker.widget.on('click.togglePicker', '.accordion-toggle', function(e) {
                            e.stopPropagation();
                            $this = $(this);
                            $parent = $this.closest('ul');
                            expanded = $parent.find('.in');
                            closed = $parent.find('.collapse:not(.in)');
                            if (expanded && expanded.length) {
                                collapseData = expanded.data('collapse');
                                if (collapseData && collapseData.date - transitioning) return;
                                expanded.collapse('hide');
                                closed.collapse('show');
                                $this.find('span').toggleClass(picker.options.icons.time + ' ' + picker.options.icons.date);
                                picker.element.find('.input-group-addon span').toggleClass(picker.options.icons.time + ' ' + picker.options.icons.date);
                            }
                        });
                    }
                    if (picker.isInput) {
                        picker.element.on({
                            'focus': $.proxy(picker.show, this),
                            'change': $.proxy(change, this),
                            'blur': $.proxy(picker.hide, this)
                        });
                    } else {
                        picker.element.on({
                            'change': $.proxy(change, this)
                        }, 'input');
                        if (picker.component) {
                            picker.component.on('click', $.proxy(picker.show, this));
                        } else {
                            picker.element.on('click', $.proxy(picker.show, this));
                        }
                    }
                },
                attachDatePickerGlobalEvents = function() {
                    $(window).on('resize.datetimepicker' + picker.id, $.proxy(place, this));
                    if (!picker.isInput) {
                        $(document).on('mousedown.datetimepicker' + picker.id, $.proxy(picker.hide, this));
                    }
                },
                detachDatePickerEvents = function() {
                    picker.widget.off('click', '.datepicker *', picker.click);
                    picker.widget.off('click', '[data-action]');
                    picker.widget.off('mousedown', picker.stopEvent);
                    if (picker.options.pickDate && picker.options.pickTime) {
                        picker.widget.off('click.togglePicker');
                    }
                    if (picker.isInput) {
                        picker.element.off({
                            'focus': picker.show,
                            'change': picker.change
                        });
                    } else {
                        picker.element.off({
                            'change': picker.change
                        }, 'input');
                        if (picker.component) {
                            picker.component.off('click', picker.show);
                        } else {
                            picker.element.off('click', picker.show);
                        }
                    }
                },
                detachDatePickerGlobalEvents = function() {
                    $(window).off('resize.datetimepicker' + picker.id);
                    if (!picker.isInput) {
                        $(document).off('mousedown.datetimepicker' + picker.id);
                    }
                },
                isInFixed = function() {
                    if (picker.element) {
                        var
                            parents = picker.element.parents(),
                            inFixed = false,
                            i;
                        for (i = 0; i < parents.length; i++) {
                            if ($(parents[i]).css('position') == 'fixed') {
                                inFixed = true;
                                break;
                            }
                        };
                        return inFixed;
                    } else {
                        return false;
                    }
                },
                set = function() {
                    pMoment.lang(picker.options.language);
                    var
                        formatted = '',
                        input;
                    if (!picker.unset) formatted = pMoment(picker.date).format(picker.format);
                    getPickerInput().val(formatted);
                    picker.element.data('date', formatted);
                    if (!picker.options.pickTime) picker.hide();
                },
                checkDate = function(direction, unit, amount) {
                    pMoment.lang(picker.options.language);
                    var
                        newDate;
                    if (direction == "add") {
                        newDate = pMoment(picker.date);
                        if (newDate.hours() == 23) newDate.add(amount, unit);
                        newDate.add(amount, unit);
                    } else {
                        newDate = pMoment(picker.date).subtract(amount, unit);
                    }
                    if (isInDisableDates(pMoment(newDate.subtract(amount, unit))) || isInDisableDates(newDate)) {
                        notifyError(newDate.format(picker.format));
                        return;
                    }
                    if (direction == "add") {
                        picker.date.add(amount, unit);
                    } else {
                        picker.date.subtract(amount, unit);
                    }
                    picker.unset = false;
                },
                isInDisableDates = function(date) {
                    pMoment.lang(picker.options.language);
                    if (date.isAfter(picker.options.maxDate) || date.isBefore(picker.options.minDate)) return true;
                    if (picker.options.disabledDates === false) {
                        return false;
                    }
                    return picker.options.disabledDates[pMoment(date).format("YYYY-MM-DD")] === true;
                },
                isInEnableDates = function(date) {
                    pMoment.lang(picker.options.language);
                    if (picker.options.enabledDates === false) {
                        return true;
                    }
                    return picker.options.enabledDates[pMoment(date).format("YYYY-MM-DD")] === true;
                },
                indexGivenDates = function(givenDatesArray) {
                    var
                        givenDatesIndexed = {};
                    var
                        givenDatesCount = 0;
                    for (i = 0; i < givenDatesArray.length; i++) {
                        dDate = pMoment(givenDatesArray[i]);
                        if (dDate.isValid()) {
                            givenDatesIndexed[dDate.format("YYYY-MM-DD")] = true;
                            givenDatesCount++;
                        }
                    }
                    if (givenDatesCount > 0) {
                        return givenDatesIndexed;
                    }
                    return false;
                },
                padLeft = function(string) {
                    string = string.toString();
                    if (string.length >= 2) return string;
                    else
                        return '0' + string;
                },
                getTemplate = function() {
                    if (picker.options.pickDate && picker.options.pickTime) {
                        var
                            ret = '';
                        ret = '<div class="bootstrap-datetimepicker-widget' + (picker.options.sideBySide ? ' timepicker-sbs' : '') + ' dropdown-menu" style="z-index:9999 !important;">';
                        if (picker.options.sideBySide) {
                            ret += '<div class="row">' + '<div class="col-sm-6 datepicker">' + dpGlobal.template + '</div>' + '<div class="col-sm-6 timepicker">' + tpGlobal.getTemplate() + '</div>' + '</div>';
                        } else {
                            ret += '<ul class="list-unstyled">' + '<li' + (picker.options.collapse ? ' class="collapse in"' : '') + '>' + '<div class="datepicker">' + dpGlobal.template + '</div>' + '</li>' + '<li class="picker-switch accordion-toggle"><a class="btn" style="width:100%"><span class="' + picker.options.icons.time + '"></span></a></li>' + '<li' + (picker.options.collapse ? ' class="collapse"' : '') + '>' + '<div class="timepicker">' + tpGlobal.getTemplate() + '</div>' + '</li>' + '</ul>';
                        }
                        ret += '</div>';
                        return ret;
                    } else
                    if (picker.options.pickTime) {
                        return ('<div class="bootstrap-datetimepicker-widget dropdown-menu">' + '<div class="timepicker">' + tpGlobal.getTemplate() + '</div>' + '</div>');
                    } else {
                        return ('<div class="bootstrap-datetimepicker-widget dropdown-menu">' + '<div class="datepicker">' + dpGlobal.template + '</div>' + '</div>');
                    }
                },
                dpGlobal = {
                    modes: [{
                        clsName: 'days',
                        navFnc: 'month',
                        navStep: 1
                    }, {
                        clsName: 'months',
                        navFnc: 'year',
                        navStep: 1
                    }, {
                        clsName: 'years',
                        navFnc: 'year',
                        navStep: 10
                    }],
                    headTemplate: '<thead>' + '<tr>' + '<th class="prev">&lsaquo;</th><th colspan="5" class="switch"></th><th class="next">&rsaquo;</th>' + '</tr>' + '</thead>',
                    contTemplate: '<tbody><tr><td colspan="7"></td></tr></tbody>'
                },
                tpGlobal = {
                    hourTemplate: '<span data-action="showHours"   data-time-component="hours"   class="timepicker-hour"></span>',
                    minuteTemplate: '<span data-action="showMinutes" data-time-component="minutes" class="timepicker-minute"></span>',
                    secondTemplate: '<span data-action="showSeconds"  data-time-component="seconds" class="timepicker-second"></span>'
                };
            dpGlobal.template = '<div class="datepicker-days">' + '<table class="table-condensed">' + dpGlobal.headTemplate + '<tbody></tbody></table>' + '</div>' + '<div class="datepicker-months">' + '<table class="table-condensed">' + dpGlobal.headTemplate + dpGlobal.contTemplate + '</table>' + '</div>' + '<div class="datepicker-years">' + '<table class="table-condensed">' + dpGlobal.headTemplate + dpGlobal.contTemplate + '</table>' + '</div>';
            tpGlobal.getTemplate = function() {
                return ('<div class="timepicker-picker">' + '<table class="table-condensed">' + '<tr>' + '<td><a href="#" class="btn" data-action="incrementHours"><span class="' + picker.options.icons.up + '"></span></a></td>' + '<td class="separator"></td>' + '<td>' + (picker.options.useMinutes ? '<a href="#" class="btn" data-action="incrementMinutes"><span class="' + picker.options.icons.up + '"></span></a>' : '') + '</td>' + (picker.options.useSeconds ? '<td class="separator"></td><td><a href="#" class="btn" data-action="incrementSeconds"><span class="' + picker.options.icons.up + '"></span></a></td>' : '') + (picker.use24hours ? '' : '<td class="separator"></td>') + '</tr>' + '<tr>' + '<td>' + tpGlobal.hourTemplate + '</td> ' + '<td class="separator">:</td>' + '<td>' + (picker.options.useMinutes ? tpGlobal.minuteTemplate : '<span class="timepicker-minute">00</span>') + '</td> ' + (picker.options.useSeconds ? '<td class="separator">:</td><td>' + tpGlobal.secondTemplate + '</td>' : '') + (picker.use24hours ? '' : '<td class="separator"></td>' + '<td><button type="button" class="btn btn-primary" data-action="togglePeriod"></button></td>') + '</tr>' + '<tr>' + '<td><a href="#" class="btn" data-action="decrementHours"><span class="' + picker.options.icons.down + '"></span></a></td>' + '<td class="separator"></td>' + '<td>' + (picker.options.useMinutes ? '<a href="#" class="btn" data-action="decrementMinutes"><span class="' + picker.options.icons.down + '"></span></a>' : '') + '</td>' + (picker.options.useSeconds ? '<td class="separator"></td><td><a href="#" class="btn" data-action="decrementSeconds"><span class="' + picker.options.icons.down + '"></span></a></td>' : '') + (picker.use24hours ? '' : '<td class="separator"></td>') + '</tr>' + '</table>' + '</div>' + '<div class="timepicker-hours" data-action="selectHour">' + '<table class="table-condensed"></table>' + '</div>' + '<div class="timepicker-minutes" data-action="selectMinute">' + '<table class="table-condensed"></table>' + '</div>' + (picker.options.useSeconds ? '<div class="timepicker-seconds" data-action="selectSecond"><table class="table-condensed"></table></div>' : ''));
            };
            picker.destroy = function() {
                detachDatePickerEvents();
                detachDatePickerGlobalEvents();
                picker.widget.remove();
                picker.element.removeData('DateTimePicker');
                if (picker.component) picker.component.removeData('DateTimePicker');
            };
            picker.show = function(e) {
                if (picker.options.useCurrent) {
                    if (getPickerInput().val() == '') {
                        if (picker.options.minuteStepping !== 1) {
                            var
                                mDate = pMoment(),
                                rInterval = picker.options.minuteStepping;
                            mDate.minutes((Math.round(mDate.minutes() / rInterval) * rInterval) % 60).seconds(0);
                            picker.setValue(mDate.format(picker.format))
                        } else {
                            picker.setValue(pMoment().format(picker.format))
                        }
                    };
                }
                picker.widget.show();
                picker.height = picker.component ? picker.component.outerHeight() : picker.element.outerHeight();
                place();
                picker.element.trigger({
                    type: 'dp.show',
                    date: pMoment(picker.date)
                });
                attachDatePickerGlobalEvents();
                if (e) {
                    stopEvent(e);
                }
            }, picker.disable = function() {
                var
                    input = picker.element.find('input');
                if (input.prop('disabled')) return;
                input.prop('disabled', true);
                detachDatePickerEvents();
            }, picker.enable = function() {
                var
                    input = picker.element.find('input');
                if (!input.prop('disabled')) return;
                input.prop('disabled', false);
                attachDatePickerEvents();
            }, picker.hide = function(event) {
                if (event && $(event.target).is(picker.element.attr("id"))) return;
                var
                    collapse = picker.widget.find('.collapse'),
                    i, collapseData;
                for (i = 0; i < collapse.length; i++) {
                    collapseData = collapse.eq(i).data('collapse');
                    if (collapseData && collapseData.date - transitioning) return;
                }
                picker.widget.hide();
                picker.viewMode = picker.startViewMode;
                showMode();
                picker.element.trigger({
                    type: 'dp.hide',
                    date: pMoment(picker.date)
                });
                detachDatePickerGlobalEvents();
            }, picker.setValue = function(newDate) {
                pMoment.lang(picker.options.language);
                if (!newDate) {
                    picker.unset = true;
                    set();
                } else {
                    picker.unset = false;
                }
                if (!pMoment.isMoment(newDate)) newDate = pMoment(newDate, picker.format);
                if (newDate.isValid()) {
                    picker.date = newDate;
                    set();
                    picker.viewDate = pMoment({
                        y: picker.date.year(),
                        M: picker.date.month()
                    });
                    fillDate();
                    fillTime();
                } else {
                    notifyError(newDate);
                }
            }, picker.getDate = function() {
                if (picker.unset) return null;
                return picker.date;
            }, picker.setDate = function(date) {
                var
                    oldDate = pMoment(picker.date);
                if (!date) {
                    picker.setValue(null);
                } else {
                    picker.setValue(date);
                }
                notifyChange(oldDate, "function");
            }, picker.setDisabledDates = function(dates) {
                picker.options.disabledDates = indexGivenDates(dates);
                if (picker.viewDate) update();
            }, picker.setEnabledDates = function(dates) {
                picker.options.enabledDates = indexGivenDates(dates);
                if (picker.viewDate) update();
            }, picker.setMaxDate = function(date) {
                if (date == undefined) return;
                picker.options.maxDate = pMoment(date);
                if (picker.viewDate) update();
            }, picker.setMinDate = function(date) {
                if (date == undefined) return;
                picker.options.minDate = pMoment(date);
                if (picker.viewDate) update();
            };
            init();
        };
    $.fn.datetimepicker = function(options) {
        return this.each(function() {
            var
                $this = $(this),
                data = $this.data('DateTimePicker');
            if (!data) $this.data('DateTimePicker', new DateTimePicker(this, options));
        });
    };
}));
! function($) {
    var
        Slider = function(element, options) {
            this.element = $(element);
            this.picker = $('<div class="slider">' + '<div class="slider-track">' + '<div class="slider-selection"></div>' + '<div class="slider-handle"></div>' + '<div class="slider-handle"></div>' + '</div>' + '<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>' + '</div>').insertBefore(this.element).append(this.element);
            this.id = this.element.data('slider-id') || options.id;
            if (this.id) {
                this.picker[0].id = this.id;
            }
            if (typeof Modernizr !== 'undefined' && Modernizr.touch) {
                this.touchCapable = true;
            }
            var
                tooltip = this.element.data('slider-tooltip') || options.tooltip;
            this.tooltip = this.picker.find('.tooltip');
            this.tooltipInner = this.tooltip.find('div.tooltip-inner');
            this.orientation = this.element.data('slider-orientation') || options.orientation;
            switch (this.orientation) {
                case 'vertical':
                    this.picker.addClass('slider-vertical');
                    this.stylePos = 'top';
                    this.mousePos = 'pageY';
                    this.sizePos = 'offsetHeight';
                    this.tooltip.addClass('right')[0].style.left = '100%';
                    break;
                default:
                    this.picker.addClass('slider-horizontal').css('width', this.element.outerWidth());
                    this.orientation = 'horizontal';
                    this.stylePos = 'left';
                    this.mousePos = 'pageX';
                    this.sizePos = 'offsetWidth';
                    this.tooltip.addClass('top')[0].style.top = -this.tooltip.outerHeight() - 14 + 'px';
                    break;
            }
            this.min = this.element.data('slider-min') || options.min;
            this.max = this.element.data('slider-max') || options.max;
            this.step = this.element.data('slider-step') || options.step;
            this.value = this.element.data('slider-value') || options.value;
            if (this.value[1]) {
                this.range = true;
            }
            this.selection = this.element.data('slider-selection') || options.selection;
            this.selectionEl = this.picker.find('.slider-selection');
            if (this.selection === 'none') {
                this.selectionEl.addClass('hide');
            }
            this.selectionElStyle = this.selectionEl[0].style;
            this.handle1 = this.picker.find('.slider-handle:first');
            this.handle1Stype = this.handle1[0].style;
            this.handle2 = this.picker.find('.slider-handle:last');
            this.handle2Stype = this.handle2[0].style;
            var
                handle = this.element.data('slider-handle') || options.handle;
            switch (handle) {
                case 'round':
                    this.handle1.addClass('round');
                    this.handle2.addClass('round');
                    break;
                case 'triangle':
                    this.handle1.addClass('triangle');
                    this.handle2.addClass('triangle');
                    break;
            }
            if (this.range) {
                this.value[0] = Math.max(this.min, Math.min(this.max, this.value[0]));
                this.value[1] = Math.max(this.min, Math.min(this.max, this.value[1]));
            } else {
                this.value = [Math.max(this.min, Math.min(this.max, this.value))];
                this.handle2.addClass('hide');
                if (this.selection == 'after') {
                    this.value[1] = this.max;
                } else {
                    this.value[1] = this.min;
                }
            }
            this.diff = this.max - this.min;
            this.percentage = [(this.value[0] - this.min) * 100 / this.diff, (this.value[1] - this.min) * 100 / this.diff, this.step * 100 / this.diff];
            this.offset = this.picker.offset();
            this.size = this.picker[0][this.sizePos];
            this.formater = options.formater;
            this.layout();
            if (this.touchCapable) {
                this.picker.on({
                    touchstart: $.proxy(this.mousedown, this)
                });
            } else {
                this.picker.on({
                    mousedown: $.proxy(this.mousedown, this)
                });
            }
            if (tooltip === 'show') {
                this.picker.on({
                    mouseenter: $.proxy(this.showTooltip, this),
                    mouseleave: $.proxy(this.hideTooltip, this)
                });
            } else {
                this.tooltip.addClass('hide');
            }
        };
    Slider.prototype = {
        constructor: Slider,
        over: false,
        inDrag: false,
        showTooltip: function() {
            this.tooltip.addClass('in');
            this.over = true;
        },
        hideTooltip: function() {
            if (this.inDrag === false) {
                this.tooltip.removeClass('in');
            }
            this.over = false;
        },
        layout: function() {
            this.handle1Stype[this.stylePos] = this.percentage[0] + '%';
            this.handle2Stype[this.stylePos] = this.percentage[1] + '%';
            if (this.orientation == 'vertical') {
                this.selectionElStyle.top = Math.min(this.percentage[0], this.percentage[1]) + '%';
                this.selectionElStyle.height = Math.abs(this.percentage[0] - this.percentage[1]) + '%';
            } else {
                this.selectionElStyle.left = Math.min(this.percentage[0], this.percentage[1]) + '%';
                this.selectionElStyle.width = Math.abs(this.percentage[0] - this.percentage[1]) + '%';
            }
            if (this.range) {
                this.tooltipInner.text(this.formater(this.value[0]) + ' : ' + this.formater(this.value[1]));
                this.tooltip[0].style[this.stylePos] = this.size * (this.percentage[0] + (this.percentage[1] - this.percentage[0]) / 2) / 100 - (this.orientation === 'vertical' ? this.tooltip.outerHeight() / 2 : this.tooltip.outerWidth() / 2) + 'px';
            } else {
                this.tooltipInner.text(this.formater(this.value[0]));
                this.tooltip[0].style[this.stylePos] = this.size * this.percentage[0] / 100 - (this.orientation === 'vertical' ? this.tooltip.outerHeight() / 2 : this.tooltip.outerWidth() / 2) + 'px';
            }
        },
        mousedown: function(ev) {
            if (this.touchCapable && ev.type === 'touchstart') {
                ev = ev.originalEvent;
            }
            this.offset = this.picker.offset();
            this.size = this.picker[0][this.sizePos];
            var
                percentage = this.getPercentage(ev);
            if (this.range) {
                var
                    diff1 = Math.abs(this.percentage[0] - percentage);
                var
                    diff2 = Math.abs(this.percentage[1] - percentage);
                this.dragged = (diff1 < diff2) ? 0 : 1;
            } else {
                this.dragged = 0;
            }
            this.percentage[this.dragged] = percentage;
            this.layout();
            if (this.touchCapable) {
                $(document).on({
                    touchmove: $.proxy(this.mousemove, this),
                    touchend: $.proxy(this.mouseup, this)
                });
            } else {
                $(document).on({
                    mousemove: $.proxy(this.mousemove, this),
                    mouseup: $.proxy(this.mouseup, this)
                });
            }
            this.inDrag = true;
            var
                val = this.calculateValue();
            this.element.trigger({
                type: 'slideStart',
                value: val
            }).trigger({
                type: 'slide',
                value: val
            });
            return false;
        },
        mousemove: function(ev) {
            if (this.touchCapable && ev.type === 'touchmove') {
                ev = ev.originalEvent;
            }
            var
                percentage = this.getPercentage(ev);
            if (this.range) {
                if (this.dragged === 0 && this.percentage[1] < percentage) {
                    this.percentage[0] = this.percentage[1];
                    this.dragged = 1;
                } else
                if (this.dragged === 1 && this.percentage[0] > percentage) {
                    this.percentage[1] = this.percentage[0];
                    this.dragged = 0;
                }
            }
            this.percentage[this.dragged] = percentage;
            this.layout();
            var
                val = this.calculateValue();
            this.element.trigger({
                type: 'slide',
                value: val
            }).data('value', val).prop('value', val);
            return false;
        },
        mouseup: function(ev) {
            if (this.touchCapable) {
                $(document).off({
                    touchmove: this.mousemove,
                    touchend: this.mouseup
                });
            } else {
                $(document).off({
                    mousemove: this.mousemove,
                    mouseup: this.mouseup
                });
            }
            this.inDrag = false;
            if (this.over == false) {
                this.hideTooltip();
            }
            this.element;
            var
                val = this.calculateValue();
            this.element.trigger({
                type: 'slideStop',
                value: val
            }).data('value', val).prop('value', val);
            return false;
        },
        calculateValue: function() {
            var
                val;
            if (this.range) {
                val = [(this.min + Math.round((this.diff * this.percentage[0] / 100) / this.step) * this.step), (this.min + Math.round((this.diff * this.percentage[1] / 100) / this.step) * this.step)];
                this.value = val;
            } else {
                val = (this.min + Math.round((this.diff * this.percentage[0] / 100) / this.step) * this.step);
                this.value = [val, this.value[1]];
            }
            return val;
        },
        getPercentage: function(ev) {
            if (this.touchCapable) {
                ev = ev.touches[0];
            }
            var
                percentage = (ev[this.mousePos] - this.offset[this.stylePos]) * 100 / this.size;
            percentage = Math.round(percentage / this.percentage[2]) * this.percentage[2];
            return Math.max(0, Math.min(100, percentage));
        },
        getValue: function() {
            if (this.range) {
                return this.value;
            }
            return this.value[0];
        },
        setValue: function(val) {
            this.value = val;
            if (this.range) {
                this.value[0] = Math.max(this.min, Math.min(this.max, this.value[0]));
                this.value[1] = Math.max(this.min, Math.min(this.max, this.value[1]));
            } else {
                this.value = [Math.max(this.min, Math.min(this.max, this.value))];
                this.handle2.addClass('hide');
                if (this.selection == 'after') {
                    this.value[1] = this.max;
                } else {
                    this.value[1] = this.min;
                }
            }
            this.diff = this.max - this.min;
            this.percentage = [(this.value[0] - this.min) * 100 / this.diff, (this.value[1] - this.min) * 100 / this.diff, this.step * 100 / this.diff];
            this.layout();
        }
    };
    $.fn.slider = function(option, val) {
        return this.each(function() {
            var
                $this = $(this),
                data = $this.data('slider'),
                options = typeof
            option === 'object' && option;
            if (!data) {
                $this.data('slider', (data = new Slider(this, $.extend({}, $.fn.slider.defaults, options))));
            }
            if (typeof option == 'string') {
                data[option](val);
            }
        })
    };
    $.fn.slider.defaults = {
        min: 0,
        max: 10,
        step: 1,
        orientation: 'horizontal',
        value: 5,
        selection: 'before',
        tooltip: 'show',
        handle: 'round',
        formater: function(value) {
            return value;
        }
    };
    $.fn.slider.Constructor = Slider;
}(window.jQuery);
(function($) {
    var
        chop = /(\s*\S+|\s)$/;
    $.truncate = function(html, options) {
        return $('<div></div>').append(html).truncate(options).html();
    };
    $.fn.truncate = function(options) {
        if ($.isNumeric(options)) options = {
            length: options
        };
        var
            o = $.extend({}, $.truncate.defaults, options);
        return this.each(function() {
            var
                self = $(this);
            if (o.noBreaks) self.find('br').replaceWith(' ');
            var
                text = self.text();
            var
                excess = text.length - o.length;
            if (o.stripTags) self.text(text);
            if (o.words && excess > 0) {
                excess = text.length - text.slice(0, o.length).replace(chop, '').length - 1;
            }
            if (excess < 0 || !excess && !o.truncated) return;
            $.each(self.contents().get().reverse(), function(i, el) {
                var
                    $el = $(el);
                var
                    text = $el.text();
                var
                    length = text.length;
                if (length <= excess) {
                    o.truncated = true;
                    excess -= length;
                    $el.remove();
                    return;
                }
                if (el.nodeType === 3) {
                    $(el.splitText(length - excess - 1)).replaceWith(o.ellipsis);
                    return false;
                }
                $el.truncate($.extend(o, {
                    length: length - excess
                }));
                return false;
            });
        });
    };
    $.truncate.defaults = {
        stripTags: false,
        words: false,
        noBreaks: false,
        length: Infinity,
        ellipsis: '\u2026'
    };
})(jQuery);
var
    Drawing = Class.extend({
        _jCanvasLayer: null,
        _layer: null,
        init: function(layer) {
            this._layer = layer;
        },
        bringToFront: function() {
            var
                canvasElement = App().getCanvas().getElement(),
                jCanvasLayers = canvasElement.getLayers(),
                jCanvasLayerIndex = canvasElement.getLayerIndex(this._jCanvasLayer);
            if (jCanvasLayerIndex !== -1) {
                jCanvasLayers.splice(jCanvasLayerIndex, 1);
                jCanvasLayers.push(this._jCanvasLayer);
                canvasElement.drawLayers();
            }
        },
        draw: function() {
            this._jCanvasLayer = App().getCanvas().getElement().getLayer(-1);
        },
        getDimensions: function() {
            return {
                height: this._layer.getStyle('height'),
                width: this._layer.getStyle('width')
            };
        },
        getJCanvasLayer: function() {
            return this._jCanvasLayer;
        },
        getXPosition: function() {
            var
                dimensions = this.getDimensions(),
                canvasWidth = App().getCanvas().getElement().attr('width');
            if (this._layer.getStyle('x') === 'center') {
                return Math.floor((canvasWidth - dimensions.width) / 2);
            }
            if (this._layer.getStyle('x') === 'left') {
                return 0;
            }
            if (this._layer.getStyle('x') === 'right') {
                return canvasWidth - dimensions.width;
            }
            if (this._layer.getStyle('x').toStr().indexOf('%') >= 0) {
                var
                    rounded = Math.round(canvasWidth * this._layer.getStyle('x').toFloat() * 100 / 100) / 100;
                return rounded;
            }
            return this._layer.getStyle('x');
        },
        getYPosition: function() {
            var
                dimensions = this.getDimensions(),
                canvasHeight = App().getCanvas().getElement().attr('height');
            if (this._layer.getStyle('y') === 'center') {
                return Math.floor((canvasHeight - dimensions.height) / 2);
            }
            if (this._layer.getStyle('y') === 'top') {
                return 0;
            }
            if (this._layer.getStyle('y') === 'bottom') {
                return canvasHeight - dimensions.height;
            }
            if (this._layer.getStyle('y').toStr().indexOf('%') >= 0) {
                var
                    rounded = Math.round(canvasHeight * this._layer.getStyle('y').toFloat() * 100 / 100) / 100;
                return rounded;
            }
            return this._layer.getStyle('y');
        },
        refreshStyle: function(name) {
            var
                changed = {};
            changed[name] = this._layer.getStyle(name);
            App().getCanvas().getElement().setLayer(this._jCanvasLayer, changed).drawLayers();
        },
        refreshStyles: function(styles) {
            var
                changed = {},
                possible = this._layer.getStyles();
            $(styles).each(function(key, val) {
                if (typeof possible[val] !== 'undefined') {
                    changed[val] = possible[val];
                }
            });
            App().getCanvas().getElement().setLayer(this._jCanvasLayer, changed).drawLayers();
        },
        removeFromCanvas: function() {
            this._layer.setStyle('visible', false);
            this.refreshStyle('visible');
            var
                canvasElement = App().getCanvas().getElement();
            canvasElement.removeLayer(this._jCanvasLayer);
            canvasElement.drawLayers();
        },
        sendToBack: function() {
            var
                canvasElement = App().getCanvas().getElement(),
                jCanvasLayers = canvasElement.getLayers(),
                jCanvasLayerIndex = canvasElement.getLayerIndex(this._jCanvasLayer);
            jCanvasLayers.splice(jCanvasLayerIndex, 1);
            jCanvasLayers.unshift(this._jCanvasLayer);
            canvasElement.drawLayers();
        }
    });
var
    ImageDrawing = Drawing.extend({
        _rawImageData: null,
        _rawImageString: '',
        init: function(imageLayer) {
            this._super(imageLayer);
        },
        _getFilteredRawImage: function(callback) {
            var
                filters = this._layer.getProperty('filters');
            if (filters.length === 0) {
                callback(this._rawImageString);
            } else {
                var
                    _this = this,
                    canvas = document.createElement('canvas'),
                    context = canvas.getContext('2d'),
                    img = (new Image());
                img.onload = function() {
                    canvas.width = _this._rawImageData.width;
                    canvas.height = _this._rawImageData.height;
                    context.drawImage(img, 0, 0);
                    var
                        jCanvasElement = $(canvas);
                    var
                        clone = jQuery.extend(true, [], filters),
                        filterObj, renderer = function() {
                            if (clone.length === 0) {
                                var
                                    canvasImage;
                                canvasImage = jCanvasElement.getCanvasImage('png');
                                callback(canvasImage);
                            } else {
                                filterObj = clone.shift();
                                (new Filter(jCanvasElement, filterObj.type, filterObj.properties)).render(renderer);
                            }
                        };
                    renderer();
                };
                img.src = this._rawImageString;
            }
        },
        _loadRawImage: function(callback) {
            var
                _this = this,
                rawDataLoading = function(img) {
                    var
                        canvas = document.createElement('canvas'),
                        context = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0);
                    _this._rawImageString = canvas.toDataURL();
                    _this._rawImageData = context.getImageData(0, 0, img.width, img.height);
                    callback();
                };
            if (App().isIe() === false && App().isSafari5x() === false) {
                var
                    img = (new Image());
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    rawDataLoading(img)
                };
                img.onerror = function(event) {
                    App().showErrorModal('Please try again later', 'u3i1', 'Temporary issue');
                };
                img.src = this._layer.getProperty('resizedSrc');
            } else {
                App().trackView('/app/proxy');
                App().mpTrackEvent('Image proxy request made');
                jQuery.post('/proxy', {
                    url: encodeURIComponent(this._layer.getProperty('resizedSrc')),
                    csrfToken: Sai.get('csrfToken')
                }, function(response) {
                    if (response.success === true) {
                        var
                            img = (new Image());
                        img.onload = function() {
                            rawDataLoading(img);
                        };
                        img.src = response.data.encoded;
                    } else {
                        if (App().siteHasBeenLocked(response)) {
                            App().showLockedModal();
                        } else {
                            App().showErrorModal('Please try another browser', response.failedRules[0].error.reference);
                        }
                    }
                }, 'json').fail(function() {
                    App().showErrorModal('Please try another browser', '7lj1');
                });
            }
        },
        draw: function(callback) {
            var
                parent = this._super,
                _this = this,
                click = function(jCanvasLayer) {
                    if (Sai.get('publisher') === false) {
                        if (App().userIsPro() === false) {
                            if (_this._layer.getProperties().isWatermark) {
                                App().showUpsellModal('watermark');
                            }
                        }
                    }
                },
                styles = jQuery.extend(true, {}, this._layer.getStyles(), {
                    click: click,
                    layer: true,
                    fromCenter: false,
                    x: this.getXPosition(),
                    y: this.getYPosition()
                });
            var
                properties = this._layer.getProperties();
            if (Sai.get('publisher') === false && properties.isWatermark) {
                styles.cursors = {
                    mouseover: 'move',
                    mousedown: 'move',
                    mouseup: 'move'
                };
            }
            this._loadRawImage(function() {
                _this._getFilteredRawImage(function(data) {
                    var
                        img = (new Image());
                    img.onload = function() {
                        styles.source = img;
                        App().getCanvas().getElement().drawImage(styles);
                        jQuery.proxy(parent, _this)();
                        callback();
                    };
                    img.src = data;
                });
            });
        },
        makeDraggable: function() {
            var
                _this = this,
                dragCallback = function(jCanvasLayer) {
                    _this._layer.setRelativePosition();
                    App().getImageDocument().getWatermarkLayer().saveSettings();
                },
                dragProperties = {
                    cursors: {
                        mouseover: 'move',
                        mousedown: 'move',
                        mouseup: 'move'
                    },
                    draggable: true,
                    dragstop: dragCallback,
                    dragcancel: dragCallback
                };
            App().getCanvas().getElement().setLayer(this._jCanvasLayer, dragProperties).drawLayers();
        },
        refreshImage: function(reloadRawImageData, callback) {
            var
                _this = this,
                refreshFunction = function() {
                    _this._getFilteredRawImage(function(data) {
                        var
                            img = (new Image());
                        img.onload = function() {
                            App().getCanvas().getElement().setLayer(_this._jCanvasLayer, {
                                source: img
                            }).drawLayers();
                            callback && callback();
                        };
                        img.src = data;
                    });
                };
            if (reloadRawImageData === true) {
                this._loadRawImage(refreshFunction);
            } else {
                refreshFunction();
            }
        }
    });
var
    RectangleDrawing = Drawing.extend({
        init: function(rectangleLayer) {
            this._super(rectangleLayer)
        },
        draw: function() {
            var
                defaultProperties = jQuery.extend(true, {}, this._layer.getStyles(), {
                    layer: true,
                    fromCenter: false
                });
            App().getCanvas().getElement().drawRect(defaultProperties);
            this._super();
        }
    });
var
    PlaneRectangleDrawing = RectangleDrawing.extend({
        _paddingRatio: 0.2,
        _maxPadding: 16,
        init: function(rectangleLayer) {
            this._super(rectangleLayer)
        },
        redraw: function() {
            var
                fillStyle = this._layer.getTextLayer().getProperty('plane'),
                textDrawing = this._layer.getTextLayer().getDrawing(),
                height = textDrawing.getDimensions().height * (1 + this._paddingRatio * 2),
                y = textDrawing.getJCanvasLayer().y - (height * this._paddingRatio / (1 + this._paddingRatio * 2)),
                width = App().getMaximumCanvasDimensions().width;
            if (App().isGhost() === true) {
                width = App().getImageDocument().getBackgroundLayer().getStyle('width');
            }
            this._layer.setStyle('height', height);
            this._layer.setStyle('y', y);
            this._layer.setStyle('width', width);
            this.refreshStyle('height');
            this.refreshStyle('y');
            this.refreshStyle('width');
        }
    });
var
    OverlayRectangleDrawing = RectangleDrawing.extend({
        init: function(overlayRectangleLayer) {
            this._super(overlayRectangleLayer)
        },
        _alignInstagramOverlayRectangle: function() {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                width = backgroundLayer.getStyle('width'),
                height = backgroundLayer.getStyle('height');
            if (width !== height) {
                if (width > height) {
                    var
                        cutWidth = Math.ceil((width - height) / 2);
                    if (this._layer.getProperty('order') === 1) {
                        this._layer.setStyle('height', height);
                        this._layer.setStyle('width', cutWidth);
                        this._layer.setStyle('x', 0);
                        this._layer.setStyle('y', 0);
                        this.refreshStyles(['height', 'width', 'x', 'y']);
                    } else {
                        this._layer.setStyle('height', height);
                        this._layer.setStyle('width', cutWidth);
                        this._layer.setStyle('x', width - cutWidth);
                        this._layer.setStyle('y', 0);
                        this.refreshStyles(['height', 'width', 'x', 'y']);
                    }
                } else {
                    var
                        overlayHeight = Math.ceil((height - width) / 2);
                    if (this._layer.getProperty('order') === 1) {
                        this._layer.setStyle('height', overlayHeight);
                        this._layer.setStyle('width', width);
                        this._layer.setStyle('x', 0);
                        this._layer.setStyle('y', 0);
                        this.refreshStyles(['height', 'width', 'x', 'y']);
                    } else {
                        this._layer.setStyle('height', overlayHeight);
                        this._layer.setStyle('width', width);
                        this._layer.setStyle('x', 0);
                        this._layer.setStyle('y', height - overlayHeight);
                        this.refreshStyles(['height', 'width', 'x', 'y']);
                    }
                }
            } else {
                this._layer.setStyle('visible', false);
                this.refreshStyle('visible');
            }
        },
        _alignTwitterOverlayRectangle: function() {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                width = backgroundLayer.getStyle('width'),
                height = backgroundLayer.getStyle('height');
            var
                ratio = width / 526,
                secretSauce = 100 / 48,
                offset = Math.round(((height / ratio) - 263) / secretSauce),
                previewHeight = 260 * ratio;
            if (this._layer.getProperty('order') === 1) {
                offset = (offset + 1) * ratio;
                var
                    overlayHeight = offset;
                this._layer.setStyle('height', overlayHeight);
                this._layer.setStyle('width', width);
                this.refreshStyles(['height', 'width']);
            } else {
                offset = (offset) * ratio;
                var
                    overlayHeight = offset + height - offset * 2 - previewHeight;
                this._layer.setStyle('height', overlayHeight);
                this._layer.setStyle('width', width);
                this._layer.setStyle('y', height - overlayHeight);
                this.refreshStyles(['height', 'width', 'y']);
            }
        },
        align: function() {
            if (this._layer.getProperty('type') === 'instagramOverlayRectangle') {
                this._alignInstagramOverlayRectangle();
            } else
            if (this._layer.getProperty('type') === 'twitterOverlayRectangle') {
                this._alignTwitterOverlayRectangle();
            }
        }
    });
var
    RuleRectangleDrawing = RectangleDrawing.extend({
        init: function(ruleRectangleLayer) {
            this._super(ruleRectangleLayer)
        },
        _alignHorizontal: function() {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                width = backgroundLayer.getStyle('width'),
                height = backgroundLayer.getStyle('height');
            this._layer.setStyle('y', Math.ceil((height - 1) / 2));
            this._layer.setStyle('width', width);
            this.refreshStyle('y');
            this.refreshStyle('width');
        },
        _alignVertical: function() {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                width = backgroundLayer.getStyle('width'),
                height = backgroundLayer.getStyle('height');
            this._layer.setStyle('x', Math.ceil((width - 1) / 2));
            this._layer.setStyle('height', height);
            this.refreshStyle('x');
            this.refreshStyle('height');
        },
        align: function() {
            if (this._layer.getProperty('type') === 'verticalRuleRectangle') {
                this._alignVertical();
            } else
            if (this._layer.getProperty('type') === 'horizontalRuleRectangle') {
                this._alignHorizontal();
            }
        }
    });
var
    TextDrawing = Drawing.extend({
        _centerSnapRatio: 0.035,
        _plane: null,
        init: function(textLayer) {
            this._super(textLayer);
        },
        _snapToCenter: function() {
            var
                jCanvasLayer = this._layer.getDrawing().getJCanvasLayer(),
                x = jCanvasLayer.x,
                y = jCanvasLayer.y,
                width = jCanvasLayer.width,
                height = jCanvasLayer.height,
                threshold = this._centerSnapRatio,
                xFromCenter = Math.ceil(x + width / 2),
                yFromCenter = Math.ceil(y + height / 2);
            var
                imageDocument = App().getImageDocument(),
                verticalRuleRectangleLayer = imageDocument.getVerticalRuleRectangleLayer(),
                horizontalRuleRectangleLayer = imageDocument.getHorizontalRuleRectangleLayer(),
                verticalRuleX = verticalRuleRectangleLayer.getStyle('x'),
                horizontalRuleY = horizontalRuleRectangleLayer.getStyle('y');
            if (xFromCenter > verticalRuleX * (1 - threshold) && xFromCenter < verticalRuleX * (1 + threshold)) {
                verticalRuleRectangleLayer.show();
                this._layer.setStyle('x', Math.ceil(verticalRuleX - width / 2));
                this.refreshStyle('x');
            } else {
                verticalRuleRectangleLayer.hide();
            }
            if (yFromCenter > horizontalRuleY * (1 - threshold) && yFromCenter < horizontalRuleY * (1 + threshold)) {
                horizontalRuleRectangleLayer.show();
                this._layer.setStyle('y', Math.ceil(horizontalRuleY - height / 2));
                this.refreshStyle('y');
            } else {
                horizontalRuleRectangleLayer.hide();
            }
        },
        addPlane: function(hex) {
            var
                dimensions = App().getMaximumCanvasDimensions();
            var
                planeProperties = {
                    isBackground: false,
                    isPlane: true,
                    type: 'rectangle',
                    filters: [],
                    styles: {
                        fillStyle: hex,
                        height: 0,
                        width: dimensions.width,
                        x: 0,
                        y: 0
                    }
                };
            this._plane = (new PlaneRectangleLayer(planeProperties, this._layer));
            this._plane.getDrawing().draw();
            this._plane.getDrawing().redraw();
            this.bringToFront();
            App().getImageDocument().getWatermarkLayer().getDrawing().bringToFront();
        },
        draw: function() {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                backgroundLayerWidth = backgroundLayer.getStyle('width');
            var
                _this = this,
                dragCallback = function(jCanvasLayer) {
                    _this._plane && _this._plane.getDrawing().redraw();
                    _this._snapToCenter();
                },
                dragStartCallback = function(jCanvasLayer) {},
                dragStopCallback = function(jCanvasLayer) {
                    _this._layer.setRelativePosition();
                    var
                        imageDocument = App().getImageDocument(),
                        verticalRuleRectangleLayer = imageDocument.getVerticalRuleRectangleLayer(),
                        horizontalRuleRectangleLayer = imageDocument.getHorizontalRuleRectangleLayer();
                    verticalRuleRectangleLayer.hide();
                    horizontalRuleRectangleLayer.hide();
                },
                dblclick = function(jCanvasLayer) {
                    App().showTextTab();
                    _this._layer.getControl().getElement().find('textarea').select().focus();
                },
                styles = jQuery.extend(true, {}, this._layer.getStyles(), {
                    maxWidth: Math.floor(App().getTextMaxWidthRatio() * backgroundLayerWidth),
                    cursors: {
                        mouseover: 'move',
                        mousedown: 'move',
                        mouseup: 'move'
                    },
                    fromCenter: false,
                    layer: true,
                    draggable: true,
                    lineHeight: App().getDefaultLineHeight(),
                    shadowStroke: true,
                    shadowX: 1,
                    shadowY: 1,
                    x: this.getXPosition(),
                    y: this.getYPosition(),
                    dblclick: dblclick,
                    drag: dragCallback,
                    dragstart: dragStartCallback,
                    dragstop: dragStopCallback,
                    dragcancel: dragStopCallback
                });
            App().getCanvas().getElement().drawText(styles);
            this._super();
            var
                properties = this._layer.getProperties();
            if (typeof properties.plane !== 'undefined') {
                this.addPlane(properties.plane);
            }
        },
        getDimensions: function() {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                width = backgroundLayer.getStyle('width'),
                styles = jQuery.extend(true, {}, this._layer.getStyles(), {
                    maxWidth: Math.floor(App().getTextMaxWidthRatio() * width),
                    lineHeight: App().getDefaultLineHeight(),
                    shadowStroke: true,
                    shadowX: 1,
                    shadowY: 1,
                    x: 0,
                    y: 0
                }),
                measuredStyles = App().getCanvas().getElement().measureText(styles);
            return {
                height: Math.floor(measuredStyles.height),
                width: Math.floor(measuredStyles.width)
            };
        },
        getPlane: function() {
            return this._plane;
        },
        refreshStyle: function(name) {
            this._super(name);
            this._plane && this._plane.getDrawing().redraw();
        },
        refreshStyles: function(styles) {
            this._super(styles);
            this._plane && this._plane.getDrawing().redraw();
        },
        removePlane: function() {
            App().getCanvas().getElement().removeLayer(this._plane.getDrawing().getJCanvasLayer()).drawLayers();
            delete
            this['_plane'];
        }
    });
var
    Filter = Class.extend({
        jCanvasElement: null,
        properties: {},
        type: null,
        init: function(jCanvasElement, type, properties) {
            this._jCanvasElement = jCanvasElement;
            this._type = type;
            this._properties = properties;
        },
        _renderGreyscale: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.greyscale();
                this.render(callback);
            });
        },
        _renderGrungy: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.grungy();
                this.render(callback);
            });
        },
        _renderGlowingSun: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.glowingSun();
                this.render(callback);
            });
        },
        _renderVintage: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.vintage();
                this.render(callback);
            });
        },
        _renderPosterize: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.posterize(90);
                this.render(callback);
            });
        },
        _renderClarity: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.clarity();
                this.render(callback);
            });
        },
        _renderSinCity: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.sinCity();
                this.render(callback);
            });
        },
        _renderHazyDays: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.hazyDays();
                this.render(callback);
            });
        },
        _renderHemingway: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.hemingway();
                this.render(callback);
            });
        },
        _renderConcentrate: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.concentrate();
                this.render(callback);
            });
        },
        _renderOrangePeel: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.orangePeel();
                this.render(callback);
            });
        },
        _renderLomo: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.lomo();
                this.render(callback);
            });
        },
        _renderLove: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.love();
                this.render(callback);
            });
        },
        _renderSunrise: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.sunrise();
                this.render(callback);
            });
        },
        _renderOpacity: function(callback, strength) {
            Caman(this._jCanvasElement[0], function() {
                this.colorize('#ffffff', 100 - strength);
                this.render(function() {
                    callback();
                });
            });
        },
        _renderInverse: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.invert();
                this.render(callback);
            });
        },
        _renderSepia: function(callback) {
            Caman(this._jCanvasElement[0], function() {
                this.sepia(75);
                this.render(callback);
            });
        },
        _renderColorize: function(callback, color, strength) {
            Caman(this._jCanvasElement[0], function() {
                this.colorize(color, strength);
                this.render(function() {
                    callback();
                });
            });
        },
        _renderBlur: function(callback, strength) {
            var
                CanvasImage = function(element, image) {
                    this.image = image;
                    this.element = element;
                    this.element.width = this.image.width;
                    this.element.height = this.image.height;
                    this.context = this.element.getContext('2d');
                    this.context.drawImage(this.image, 0, 0);
                };
            CanvasImage.prototype = {
                blur: function(strength) {
                    this.context.globalAlpha = 0.5;
                    for (var
                            y = -strength; y <= strength; y += 2) {
                        for (var
                                x = -strength; x <= strength; x += 2) {
                            this.context.drawImage(this.element, x, y);
                            if (x >= 0 && y >= 0) {
                                this.context.drawImage(this.element, -(x - 1), -(y - 1));
                            }
                        }
                    }
                    this.context.globalAlpha = 1.0;
                }
            };
            var
                img = (new Image()),
                canvasImage;
            img.src = this._jCanvasElement.getCanvasImage();
            canvasImage = (new CanvasImage(this._jCanvasElement[0], img));
            canvasImage.blur(strength);
            callback();
        },
        render: function(callback) {
            if (this._type === 'blur') {
                if (this._properties.strength.toInt() !== 0) {
                    this._renderBlur(callback, this._properties.strength);
                }
            } else
            if (this._type === 'colorize') {
                this._renderColorize(callback, this._properties.color, this._properties.strength);
            } else
            if (this._type === 'darken') {
                this._renderColorize(callback, '#000000', this._properties.strength);
            } else
            if (this._type === 'greyscale') {
                this._renderGreyscale(callback);
            } else
            if (this._type === 'opacity') {
                this._renderOpacity(callback, this._properties.strength);
            } else
            if (this._type === 'sepia') {
                this._renderSepia(callback);
            } else
            if (this._type === 'grungy') {
                this._renderGrungy(callback);
            } else
            if (this._type === 'glowingSun') {
                this._renderGlowingSun(callback);
            } else
            if (this._type === 'inverse') {
                this._renderInverse(callback);
            } else
            if (this._type === 'lomo') {
                this._renderLomo(callback);
            } else
            if (this._type === 'vintage') {
                this._renderVintage(callback);
            } else
            if (this._type === 'posterize') {
                this._renderPosterize(callback);
            } else
            if (this._type === 'clarity') {
                this._renderClarity(callback);
            } else
            if (this._type === 'sinCity') {
                this._renderSinCity(callback);
            } else
            if (this._type === 'orangePeel') {
                this._renderOrangePeel(callback);
            } else
            if (this._type === 'hazyDays') {
                this._renderHazyDays(callback);
            } else
            if (this._type === 'hemingway') {
                this._renderHemingway(callback);
            } else
            if (this._type === 'concentrate') {
                this._renderConcentrate(callback);
            } else
            if (this._type === 'sunrise') {
                this._renderSunrise(callback);
            } else
            if (this._type === 'love') {
                this._renderLove(callback);
            }
        }
    });
var
    Ghost = Class.extend({
        _imageLayers: [],
        _maximumDimension: 1089,
        init: function(callback) {
            this._imageLayers = [];
            var
                clone = $('body').first().clone(),
                previousPageView = Sai.getPageView(),
                previousImageDocumentJson = App().getImageDocument().exportToJson(true),
                ghostPageView = (new AppView(clone, true));
            ghostPageView.setImageDocumentJson(previousImageDocumentJson);
            Sai.setPageView(ghostPageView);
            this._convert(previousImageDocumentJson, function() {
                ghostPageView.go(function() {
                    callback && callback(ghostPageView.getImageDocument().exportToImageString());
                    Sai.setPageView(previousPageView);
                });
            });
        },
        _getResizeRatio: function() {
            if (this._imageLayers.length === 0) {
                var
                    backgroundLayerWidth = App().getImageDocument().getBackgroundLayer().getStyle('width').toInt();
                return this._maximumDimension / backgroundLayerWidth;
            }
            var
                _this = this,
                ratios = [];
            $(this._imageLayers).each(function(index, imageLayer) {
                ratios.push(imageLayer.width / imageLayer.layer.styles.width.toInt());
            });
            ratios.push(this._maximumDimension / App().getImageDocument().getBackgroundLayer().getStyle('width').toInt());
            return Math.min.apply(Math, ratios);
        },
        _loadImages: function(callback, offset) {
            offset = typeof
            offset === 'undefined' ? 0 : offset;
            if (offset === this._imageLayers.length) {
                callback();
            } else {
                var
                    imageLayer = this._imageLayers[offset],
                    imageSrc = imageLayer.layer.sourceSrc,
                    imageObj = (new Image()),
                    _this = this,
                    internal = function() {
                        imageLayer.width = imageObj.width;
                        imageLayer.height = imageObj.height;
                        _this._loadImages(callback, offset + 1);
                    };
                imageObj.onload = internal;
                imageObj.src = imageSrc;
            }
        },
        _getResizedSrc: function(layer, resizeRatio) {
            if (layer.sourceSrc.indexOf('cloudinary') !== -1) {
                return App().getCloudinaryUrl(layer.sourceSrc, {
                    width: layer.originalWidth.toInt() * resizeRatio,
                    height: layer.originalHeight.toInt() * resizeRatio,
                    fit: 'lfill'
                }, true);
            } else
            if (layer.sourceSrc.indexOf('api/file/') !== -1) {
                return App().getFilepickerUrl(layer.sourceSrc, {
                    width: layer.originalWidth.toInt() * resizeRatio,
                    height: layer.originalHeight.toInt() * resizeRatio
                });
            }
            return layer.resizedSrc;
        },
        _resizeImageDocumentJson: function(imageDocumentJson, resizeRatio) {
            var
                _this = this;
            $(imageDocumentJson.layers).each(function(index, layer) {
                if (layer.isBackground === true) {
                    layer.originalHeight = layer.styles.height;
                    layer.originalWidth = layer.styles.width;
                    layer.styles.height *= resizeRatio;
                    layer.styles.width *= resizeRatio;
                    layer.styles.visible = true;
                    if (layer.type === 'image') {
                        layer.resizedSrc = _this._getResizedSrc(layer, resizeRatio);
                    }
                    delete
                    layer.originalHeight;
                    delete
                    layer.originalWidth;
                } else
                if (layer.isWatermark === true) {
                    layer.originalHeight = layer.styles.height;
                    layer.originalWidth = layer.styles.width;
                    layer.styles.height *= resizeRatio;
                    layer.styles.width *= resizeRatio;
                    layer.resizedSrc = _this._getResizedSrc(layer, resizeRatio);
                    delete
                    layer.originalHeight;
                    delete
                    layer.originalWidth;
                } else
                if (layer.type === 'text') {
                    layer.styles.fontSize = (layer.styles.fontSize.toInt() * resizeRatio) + 'px';
                    if (typeof layer.styles.strokeWidth !== 'undefined') {
                        layer.styles.strokeWidth = Math.round(layer.styles.strokeWidth.toInt() * resizeRatio * 0.75 * 10) / 10;
                    }
                }
            });
        },
        _convert: function(imageDocumentJson, callback) {
            var
                _this = this;
            $(imageDocumentJson.layers).each(function(index, layer) {
                if (layer.isWatermark === true) {
                    if (layer.styles.visible === true) {
                        _this._imageLayers.push({
                            layer: layer
                        });
                    }
                } else
                if (layer.isBackground === true && layer.type === 'image') {
                    _this._imageLayers.push({
                        layer: layer
                    });
                }
            });
            this._loadImages(function() {
                var
                    resizeRatio = _this._getResizeRatio();
                if (resizeRatio !== 1) {
                    _this._resizeImageDocumentJson(imageDocumentJson, resizeRatio);
                }
                callback();
            });
        }
    });
var
    ImageDocument = Class.extend({
        _layers: [],
        init: function(imageDocumentJson) {
            this._layers = [];
            var
                _this = this;
            $(imageDocumentJson.layers).each(function(index, properties) {
                var
                    layer;
                if (properties.type === 'text') {
                    layer = (new TextLayer(properties));
                } else
                if (properties.type === 'rectangle') {
                    layer = (new RectangleLayer(properties));
                } else
                if (properties.type === 'image') {
                    if (properties.isWatermark === true) {
                        layer = (new WatermarkLayer(properties));
                    } else {
                        layer = (new ImageLayer(properties));
                    }
                }
                _this._layers.push(layer);
            });
            this._addHorizontalRuleRectangleLayer();
            this._addVerticalRuleRectangleLayer();
            this._addTwitterOverlayRectangleLayers();
            this._addInstagramOverlayRectangleLayers();
        },
        _addHorizontalRuleRectangleLayer: function(layer) {
            var
                layer = (new RuleRectangleLayer({
                    isBackground: false,
                    type: 'horizontalRuleRectangle',
                    styles: {
                        visible: false,
                        fillStyle: 'rgba(171, 227, 246, .75)',
                        height: 1,
                        width: 0,
                        x: 0,
                        y: 0
                    }
                }));
            this._layers.push(layer);
        },
        _addInstagramOverlayRectangleLayers: function(layer) {
            var
                layer = (new OverlayRectangleLayer({
                    isBackground: false,
                    type: 'instagramOverlayRectangle',
                    order: 1,
                    styles: {
                        visible: false,
                        fillStyle: 'rgba(255, 255, 255, .5)',
                        height: 0,
                        width: 0,
                        x: 0,
                        y: 0
                    }
                }));
            this._layers.push(layer);
            layer = (new OverlayRectangleLayer({
                isBackground: false,
                order: 2,
                type: 'instagramOverlayRectangle',
                styles: {
                    visible: false,
                    fillStyle: 'rgba(255, 255, 255, .5)',
                    height: 0,
                    width: 0,
                    x: 0,
                    y: 0
                }
            }));
            this._layers.push(layer);
        },
        _addTwitterOverlayRectangleLayers: function(layer) {
            var
                layer = (new OverlayRectangleLayer({
                    isBackground: false,
                    type: 'twitterOverlayRectangle',
                    order: 1,
                    styles: {
                        visible: false,
                        fillStyle: 'rgba(255, 255, 255, .5)',
                        height: 0,
                        width: 0,
                        x: 0,
                        y: 0
                    }
                }));
            this._layers.push(layer);
            layer = (new OverlayRectangleLayer({
                isBackground: false,
                type: 'twitterOverlayRectangle',
                order: 2,
                styles: {
                    visible: false,
                    fillStyle: 'rgba(255, 255, 255, .5)',
                    height: 0,
                    width: 0,
                    x: 0,
                    y: 0
                }
            }));
            this._layers.push(layer);
        },
        _addVerticalRuleRectangleLayer: function(layer) {
            var
                layer = (new RuleRectangleLayer({
                    isBackground: false,
                    type: 'verticalRuleRectangle',
                    order: 2,
                    styles: {
                        visible: false,
                        fillStyle: 'rgba(171, 227, 246, .75)',
                        height: 0,
                        width: 1,
                        x: 0,
                        y: 0
                    }
                }));
            this._layers.push(layer);
        },
        addEmptyTextLayer: function() {
            var
                textLayers = this.getTextLayers(),
                lastTextLayer = textLayers[textLayers.length - 1];
            var
                y = Math.min((55 + ((textLayers.length - 1) * 7)), 85),
                properties = {
                    styles: jQuery.extend(true, {}, lastTextLayer.getStyles(), {
                        'align': 'center',
                        'text': 'Add more text here',
                        'x': 'center',
                        'y': (y) + '%'
                    }),
                    type: 'text'
                };
            if (typeof lastTextLayer.getProperty('plane') !== 'undefined') {
                properties.plane = lastTextLayer.getProperty('plane');
            }
            var
                layer = (new TextLayer(properties));
            this._layers.push(layer);
            return layer;
        },
        addLayer: function(layer) {
            this._layers.push(layer);
        },
        exportToImageString: function() {
            var
                visibleLayers = this.hideOverlayRectangleLayers();
            var
                $canvas = App().getCanvas().getElement(),
                jpegExportData = $canvas.getCanvasImage('jpeg', 1),
                pngExportData = $canvas.getCanvasImage('png');
            this.showLayers(visibleLayers);
            if (App().isGhost() === true) {
                Sai.set('hdImageDimensions', {
                    x: $canvas.attr('width').toInt(),
                    y: $canvas.attr('height').toInt()
                });
            } else {
                Sai.set('lowImageDimensions', {
                    x: $canvas.attr('width').toInt(),
                    y: $canvas.attr('height').toInt()
                });
            }
            if (Sai.get('config').defaults.autoDetectImageFormat === true) {
                var
                    jpegLength = Math.round((jpegExportData.length - 'data:image/jpeg;base64,'.length) * (3 / 4)),
                    pngLength = Math.round((pngExportData.length - 'data:image/png;base64,'.length) * (3 / 4));
                if (jpegLength < pngLength) {
                    return jpegExportData;
                }
                return pngExportData;
            }
            if (Sai.get('config').defaults.imageOutputFormat === 'image/jpeg') {
                return jpegExportData;
            }
            return pngExportData;
        },
        exportToJson: function(includeWatermarkLayer) {
            includeWatermarkLayer = typeof
            includeWatermarkLayer === 'undefined' ? false : includeWatermarkLayer;
            var
                layers = this._layers,
                toExport = [],
                clone, watermarkLayer = this.getWatermarkLayer();
            $(layers).each(function(index, layer) {
                if (layer !== watermarkLayer || includeWatermarkLayer === true) {
                    if (layer.constructor !== RuleRectangleLayer && layer.constructor !== OverlayRectangleLayer) {
                        clone = jQuery.extend(true, {}, layer.getProperties());
                        toExport.push(clone);
                    }
                }
            });
            return {
                layers: toExport
            };
        },
        exportToJsonString: function() {
            return JSON.stringify(this.exportToJson());
        },
        getActiveFonts: function() {
            var
                textLayers = this.getTextLayers(),
                fontFamilies = App().getFontFamilies(),
                active = [];
            $(textLayers).each(function(index, layer) {
                var
                    fontFamily = layer.getStyle('fontFamily');
                $(fontFamilies).each(function(index, font) {
                    if (fontFamily === font.name) {
                        active.push(font);
                    }
                });
            });
            return active;
        },
        getBackgroundLayer: function() {
            var
                backgroundLayer;
            $(this._layers).each(function(index, layer) {
                if (layer.getProperty('isBackground') === true) {
                    backgroundLayer = layer;
                }
            });
            return backgroundLayer;
        },
        getHorizontalRuleRectangleLayer: function() {
            var
                found = [];
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === RuleRectangleLayer && layer.getProperty('type') === 'horizontalRuleRectangle') {
                    found.push(layer);
                }
            });
            return found[0];
        },
        getImageLayers: function() {
            var
                found = [];
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === ImageLayer || layer.constructor === WatermarkLayer) {
                    found.push(layer);
                }
            });
            return found;
        },
        getInstagramOverlayRectangleLayers: function() {
            var
                found = [];
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === OverlayRectangleLayer && layer.getProperty('type') === 'instagramOverlayRectangle') {
                    found.push(layer);
                }
            });
            return found;
        },
        getRectangleLayers: function() {
            var
                found = [];
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === RectangleLayer) {
                    found.push(layer);
                }
            });
            return found;
        },
        getTextLayers: function() {
            var
                found = [];
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === TextLayer) {
                    found.push(layer);
                }
            });
            return found;
        },
        getTwitterOverlayRectangleLayers: function() {
            var
                found = [];
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === OverlayRectangleLayer && layer.getProperty('type') === 'twitterOverlayRectangle') {
                    found.push(layer);
                }
            });
            return found;
        },
        getVerticalRuleRectangleLayer: function() {
            var
                found = [];
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === RuleRectangleLayer && layer.getProperty('type') === 'verticalRuleRectangle') {
                    found.push(layer);
                }
            });
            return found[0];
        },
        getWatermarkLayer: function() {
            var
                watermarkLayer;
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === WatermarkLayer) {
                    watermarkLayer = layer;
                }
            });
            return watermarkLayer;
        },
        hideOverlayRectangleLayers: function() {
            var
                visibleLayers = [];
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === OverlayRectangleLayer) {
                    if (layer.getStyle('visible') === true) {
                        visibleLayers.push(layer);
                        layer.setStyle('visible', false);
                        layer.getDrawing().refreshStyle('visible');
                    }
                }
            });
            return visibleLayers;
        },
        removeLayer: function(layerToBeRemoved) {
            var
                _this = this;
            $(this._layers).each(function(index, layer) {
                if (layer === layerToBeRemoved) {
                    _this._layers.splice(index, 1);
                }
            });
        },
        showInstragramOverlayRectangleLayers: function() {
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === OverlayRectangleLayer && layer.getProperty('type') === 'instagramOverlayRectangle') {
                    layer.setStyle('visible', true);
                    layer.getDrawing().refreshStyle('visible');
                }
            });
        },
        showLayers: function(layers) {
            $(layers).each(function(index, layer) {
                layer.setStyle('visible', true);
                layer.getDrawing().refreshStyle('visible');
            });
        },
        showTwitterOverlayRectangleLayers: function() {
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === OverlayRectangleLayer && layer.getProperty('type') === 'twitterOverlayRectangle') {
                    layer.setStyle('visible', true);
                    layer.getDrawing().refreshStyle('visible');
                }
            });
        },
        showRules: function() {
            var
                watermarkLayer;
            $(this._layers).each(function(index, layer) {
                if (layer.constructor === WatermarkLayer) {
                    watermarkLayer = layer;
                }
            });
            return watermarkLayer;
        }
    });
var
    Layer = Class.extend({
        _drawing: null,
        _properties: null,
        init: function(properties) {
            this._properties = properties;
        },
        getDrawing: function() {
            return this._drawing;
        },
        getProperties: function() {
            return this._properties;
        },
        getProperty: function(name) {
            return this._properties[name];
        },
        getStyle: function(name) {
            return this._properties.styles[name];
        },
        getStyles: function() {
            return this._properties.styles;
        },
        containsManuallyUploadedBackgroundImage: function() {
            if (typeof this._properties.wasManuallyUploaded === 'undefined') {
                return false;
            }
            return this._properties.wasManuallyUploaded === true;
        },
        removeFromImageDocument: function() {
            App().getImageDocument().removeLayer(this);
        },
        setRelativePosition: function() {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                bgWidth = backgroundLayer.getStyle('width'),
                bgHeight = backgroundLayer.getStyle('height'),
                x = this._drawing.getJCanvasLayer().x,
                y = this._drawing.getJCanvasLayer().y,
                relativeX = Math.round((x / bgWidth) * 100 * 100) / 100,
                relativeY = Math.round((y / bgHeight) * 100 * 100) / 100;
            this.setStyle('x', relativeX + '%');
            this.setStyle('y', relativeY + '%');
        },
        setProperty: function(name, value) {
            this._properties[name] = value;
        },
        setStyle: function(name, value) {
            this._properties.styles[name] = value;
        },
        setStyles: function(styles) {
            this._properties.styles = jQuery.extend(this._properties.styles, styles);
        },
        removeStyle: function(name, value) {
            this._properties.styles[name] = value;
        },
        removeProperty: function(name) {
            delete
            this._properties[name];
        }
    });
var
    ImageLayer = Layer.extend({
        init: function(properties) {
            this._super(properties);
            this._drawing = (new ImageDrawing(this));
        },
        addFilter: function(filterObj) {
            this._properties.filters.push(filterObj);

            function
            compare(a, b) {
                if (a.type < b.type) {
                    return -1;
                }
                if (a.type > b.type) {
                    return 1;
                }
                return 0;
            }
            this._properties.filters.sort(compare);
            this._drawing.refreshImage(false);
        },
        getFilter: function(filterType) {
            var
                _this = this,
                returnableFilter = false;
            $(this._properties.filters).each(function(index, filter) {
                if (filter.type === filterType) {
                    returnableFilter = filter;
                }
            });
            return returnableFilter;
        },
        getFilters: function() {
            return this._properties.filters;
        },
        removeFilter: function(filterType) {
            var
                _this = this;
            $(this._properties.filters).each(function(index, filter) {
                if (filter.type === filterType) {
                    _this._properties.filters.splice(index, 1);
                }
            });
            this._drawing.refreshImage(false);
        },
        removeFilters: function() {
            this._properties.filters = [];
            this._drawing.refreshImage(false);
        },
        setFilter: function(newFilterObj) {
            var
                filterObj = this.getFilter(newFilterObj.type);
            if (filterObj === false) {
                this.addFilter(newFilterObj);
            } else {
                filterObj.properties = newFilterObj.properties;
                this._drawing.refreshImage(false);
            }
        }
    });
var
    RectangleLayer = Layer.extend({
        init: function(properties) {
            this._super(properties);
            this._drawing = (new RectangleDrawing(this));
        }
    });
var
    OverlayRectangleLayer = RectangleLayer.extend({
        init: function(properties) {
            this._super(properties);
            this._drawing = (new OverlayRectangleDrawing(this));
        },
        hide: function() {
            this.setStyle('visible', false);
            this._drawing.refreshStyle('visible');
        },
        show: function() {
            this.setStyle('visible', true);
            this._drawing.refreshStyle('visible');
        }
    });
var
    PlaneRectangleLayer = RectangleLayer.extend({
        _textLayer: null,
        init: function(properties, textLayer) {
            this._textLayer = textLayer;
            this._super(properties);
            this._drawing = (new PlaneRectangleDrawing(this));
        },
        getTextLayer: function() {
            return this._textLayer;
        }
    });
var
    RuleRectangleLayer = RectangleLayer.extend({
        init: function(properties) {
            this._super(properties);
            this._drawing = (new RuleRectangleDrawing(this));
        },
        hide: function() {
            this.setStyle('visible', false);
            this._drawing.refreshStyle('visible');
        },
        show: function() {
            this.setStyle('visible', true);
            this._drawing.refreshStyle('visible');
        }
    });
var
    TextLayer = Layer.extend({
        _control: null,
        init: function(properties) {
            this._super(properties);
            this._drawing = (new TextDrawing(this));
        },
        drawControl: function() {
            var
                publisherUxConfig = App().getPublisherUxConfig(),
                isEditable = true;
            if (publisherUxConfig !== null) {
                isEditable = publisherUxConfig.get('text', 'edit');
            }
            var
                html = _.template(App().getTemplate('controls', 'text'), {
                    isReadonly: !isEditable,
                    fontFamilies: App().getFontFamilies(),
                    properties: this._properties,
                    styles: this._properties.styles
                });
            var
                controlElement = $(jQuery.parseHTML(html.trim()));
            App().getElement().find('div#settings div.textTab div.controls').append(controlElement);
            this._control = (new TextControlView(controlElement, this));
        },
        getControl: function() {
            return this._control;
        },
        getPlane: function() {
            return this._drawing.getPlane();
        }
    });
var
    WatermarkLayer = ImageLayer.extend({
        _saveTimer: null,
        init: function(properties) {
            this._super(properties);
        },
        hide: function(saveSettings) {
            this.setStyle('visible', false);
            this._drawing.refreshStyle('visible');
            if (typeof saveSettings === 'undefined' || saveSettings === true) {
                this.saveSettings();
            }
        },
        saveSettings: function() {
            var
                _this = this;
            clearTimeout(this._saveTimer);
            this._saveTimer = setTimeout(function() {
                var
                    watermarkJson = _this.getProperties(),
                    data = {
                        csrfToken: Sai.get('csrfToken'),
                        watermarkJson: JSON.stringify(watermarkJson)
                    };
                jQuery.post('/users/updateWatermark', data, function(response) {
                    if (response.success === true) {
                        Sai.set('loggedInUser', response.data.user);
                    } else {
                        if (App().siteHasBeenLocked(response)) {
                            App().showLockedModal();
                        } else {
                            App().showErrorModal(false, response.failedRules[0].error.reference);
                        }
                    }
                }, 'json').fail(function() {
                    App().showErrorModal(false, '41jk');
                });
            }, App().getTimeout('watermarkAutoSaveDelay'));
        },
        show: function(saveSettings) {
            this.setStyle('visible', true);
            this._drawing.refreshStyle('visible');
            if (typeof saveSettings === 'undefined' || saveSettings === true) {
                this.saveSettings();
            }
        }
    });
var
    PublisherUxConfig = Class.extend({
        _config: null,
        _defaults: {
            background: {
                color: true,
                filters: true,
                image: false,
                tab: true
            },
            templates: false,
            text: {
                add: false,
                align: true,
                color: true,
                draggable: true,
                edit: false,
                font: true,
                remove: false,
                size: true,
                stroke: true,
                style: true
            },
            resizing: false,
            watermark: {
                draggable: false
            }
        },
        init: function(config) {
            this.setAll(config);
        },
        get: function() {
            var
                args = arguments,
                ref = this._config;
            $(args).each(function(index, arg) {
                ref = ref[arg];
            });
            return ref;
        },
        getAll: function() {
            return this._config;
        },
        setAll: function(config) {
            this._config = jQuery.extend(true, {}, this._defaults, config);
        }
    });
var
    StyleBlock = Class.extend({
        _rules: [],
        init: function() {},
        _addRule: function(selector, property, value) {
            this._rules.push(selector + '{' + property + ':' + value + ';}');
        },
        _addRules: function(selector, styles) {
            var
                _this = this;
            jQuery.each(styles, function(index, style) {
                _this._addRule(selector, index, style);
            });
        },
        insert: function() {
            var
                headElement = document.getElementsByTagName('head')[0],
                styleElement = document.createElement('style'),
                css = this._rules.join(' ');
            styleElement.type = 'text/css';
            if (styleElement.styleSheet) {
                styleElement.styleSheet.cssText = css;
            } else {
                styleElement.appendChild(document.createTextNode(css));
            }
            headElement.appendChild(styleElement);
        }
    });
var
    ConfigStyleBlock = StyleBlock.extend({
        init: function(config) {
            this._config = config;
            this._process();
        },
        _hideBackground: function() {
            this._addRules('*[data-scope~="background"]', {
                display: 'none !important'
            });
        },
        _hideBackgroundColor: function() {
            this._addRules('*[data-scope~="backgroundColor"]', {
                display: 'none !important'
            });
        },
        _hideBackgroundImage: function() {
            this._addRules('*[data-scope~="backgroundImage"]', {
                display: 'none !important'
            });
        },
        _hideFiltersTab: function() {
            this._addRules('*[data-scope~="filtersTab"]', {
                display: 'none !important'
            });
        },
        _hideBackgroundTab: function() {
            this._addRules('*[data-scope~="backgroundTab"]', {
                display: 'none !important'
            });
        },
        _hideResizing: function() {
            this._addRules('*[data-scope~="resizing"]', {
                display: 'none !important'
            });
        },
        _hideStrokeColor: function() {
            this._addRules('*[data-scope~="strokeColor"]', {
                display: 'none !important'
            });
        },
        _hideTemplatesTab: function() {
            this._addRules('*[data-scope~="templatesTab"]', {
                display: 'none !important'
            });
        },
        _hideTextAddition: function() {
            this._addRules('*[data-scope~="textAddition"]', {
                display: 'none !important'
            });
        },
        _hideTextAlignment: function() {
            this._addRules('*[data-scope~="textAlignment"]', {
                display: 'none !important'
            });
        },
        _hideTextColor: function() {
            this._addRules('*[data-scope~="textColor"]', {
                display: 'none !important'
            });
        },
        _hideTextFont: function() {
            this._addRules('*[data-scope~="textFont"]', {
                display: 'none !important'
            });
        },
        _hideTextRemoval: function() {
            this._addRules('*[data-scope~="textRemoval"]', {
                display: 'none !important'
            });
        },
        _hideTextSize: function() {
            this._addRules('*[data-scope~="textSize"]', {
                display: 'none !important'
            });
        },
        _hideTextStyles: function() {
            this._addRules('*[data-scope~="textStyles"]', {
                display: 'none !important'
            });
        },
        _hideWatermarkTab: function() {
            this._addRules('*[data-scope~="watermarkTab"]', {
                display: 'none !important'
            });
        },
        _process: function() {
            if (this._config.background.color === false) {
                this._hideBackgroundColor();
            }
            if (this._config.resizing === false) {
                this._hideResizing();
            }
            if (this._config.background.image === false) {
                this._hideBackgroundImage();
            }
            if (this._config.background.color === false && this._config.background.image === false) {
                this._hideBackground();
            }
            if (this._config.background.filters === false) {
                this._hideFiltersTab();
            }
            if (this._config.background.tab === false) {
                this._hideBackgroundTab();
            }
            if (this._config.templates === false) {
                this._hideTemplatesTab();
            }
            this._hideWatermarkTab();
            if (this._config.text.add === false) {
                this._hideTextAddition();
            }
            if (this._config.text.align === false) {
                this._hideTextAlignment();
            }
            if (this._config.text.color === false) {
                this._hideTextColor();
            }
            if (this._config.text.stroke === false) {
                this._hideStrokeColor();
            }
            if (this._config.text.font === false) {
                this._hideTextFont();
            }
            if (this._config.text.remove === false) {
                this._hideTextRemoval();
            }
            if (this._config.text.size === false) {
                this._hideTextSize();
            }
            if (this._config.text.style === false) {
                this._hideTextStyles();
            }
        }
    });
var
    View = Class.extend({
        _element: null,
        _tooltipContainer: null,
        init: function(element) {
            this._element = element;
            this._addTooltips();
            this._addChromeAppInstallEvents();
            this._addChromeExtensionInstallEvents();
        },
        _addChromeAppInstallEvents: function() {
            var
                _this = this;
            this._element.find('.cws-app-install').click(function(event) {
                event.preventDefault();
                _this._installChromeApp();
            });
        },
        _addChromeExtensionInstallEvents: function() {
            var
                _this = this;
            this._element.find('.cws-extension-install').click(function(event) {
                event.preventDefault();
                _this._installChromeExtension();
            });
        },
        _addScrollOverflowEvent: function($elements) {
            $elements.bind('mousewheel DOMMouseScroll', function(event) {
                var
                    height = $(this).outerHeight(),
                    scrollHeight = $(this).get(0).scrollHeight;
                var
                    original = event.originalEvent,
                    delta = original.wheelDelta || (0 - original.detail);
                if (delta < 0) {
                    if (this.scrollTop === (scrollHeight - height)) {
                        event.preventDefault();
                    }
                } else
                if (delta > 0) {
                    if (this.scrollTop === 0) {
                        event.preventDefault();
                    }
                }
            });
        },
        _addTooltips: function() {
            var
                container, _this = this;
            this._element.find('[data-toggle="tooltip"]').each(function(index, element) {
                container = _this._tooltipContainer || 'body';
                if ($(element).attr('data-container')) {
                    container = $(element).attr('data-container');
                }
                $(element).tooltip({
                    container: container
                });
            });
        },
        _chromeAppInstallCallback: function() {},
        _chromeExtensionInstallCallback: function() {},
        _installChromeApp: function() {
            var
                _this = this,
                $appLink = $('#chrome-webstore-app');
            chrome.webstore.install($appLink.attr('href'), function() {}, function() {});
        },
        _installChromeExtension: function() {
            var
                _this = this,
                $extensionLink = $('#chrome-webstore-extension');
            chrome.webstore.install($extensionLink.attr('href'), function() {
                location.href = '/welcome';
            }, function() {});
        },
        _removeTooltips: function() {
            this._element.find('[data-toggle="tooltip"]').tooltip('destroy');
        },
        getElement: function() {
            return this._element;
        }
    });
var
    AdminTabView = View.extend({
        _categoriesTab: null,
        _currentTab: 'dashboard',
        _couponsTab: null,
        _imagesTab: null,
        _photosTab: null,
        _usersTab: null,
        init: function(element) {
            this._super(element);
            this._addTabToggleEvents();
            this._categoriesTab = (new AdminCategoriesTabView(this._element.find('.adminCategoriesTab')));
            this._couponsTab = (new AdminCouponsTabView(this._element.find('.adminCouponsTab')));
            this._usersTab = (new AdminUsersTabView(this._element.find('.adminUsersTab')));
            this._imagesTab = (new AdminImagesTabView(this._element.find('.adminImagesTab')));
            this._photosTab = (new AdminPhotosTabView(this._element.find('.adminPhotosTab')));
        },
        _addTabToggleEvents: function() {
            var
                _this = this;
            this._element.find('ul.secondaryTabs li a').click(function(event) {
                event.preventDefault();
                var
                    href = $(this).attr('href'),
                    tabName = href.replace('#', '');
                _this._currentTab = tabName;
                _this.showCurrentTab();
            });
        },
        showCategoriesTab: function() {
            this._currentTab = 'categories';
            this._element.find('ul.secondaryTabs li.active').removeClass('active');
            this._element.find('ul.secondaryTabs li.categories').addClass('active');
            this._element.find('div.secondaryTabContent > div').addClass('hidden');
            this._element.find('div.secondaryTabContent > div.adminCategoriesTab').removeClass('hidden');
            this._categoriesTab.load('/categories');
        },
        showDashboardTab: function() {
            this._currentTab = 'dashboard';
            this._element.find('ul.secondaryTabs li.active').removeClass('active');
            this._element.find('ul.secondaryTabs li.dashboard').addClass('active');
            this._element.find('div.secondaryTabContent > div').addClass('hidden');
            this._element.find('div.secondaryTabContent > div.dashboardTab').removeClass('hidden');
        },
        showCouponsTab: function() {
            this._currentTab = 'coupons';
            this._element.find('ul.secondaryTabs li.active').removeClass('active');
            this._element.find('ul.secondaryTabs li.coupons').addClass('active');
            this._element.find('div.secondaryTabContent > div').addClass('hidden');
            this._element.find('div.secondaryTabContent > div.adminCouponsTab').removeClass('hidden');
            var
                clauses = [
                    ['wasAutoGenerated', '0']
                ],
                path = '/coupons?clauses=' + encodeURIComponent(JSON.stringify(clauses));
            this._couponsTab.load(path);
        },
        showCurrentTab: function() {
            var
                capitalized = this._currentTab.charAt(0).toUpperCase() + this._currentTab.slice(1),
                functionName = 'show' + (capitalized) + 'Tab';
            this[functionName]();
        },
        showImagesTab: function() {
            this._currentTab = 'images';
            this._element.find('ul.secondaryTabs li.active').removeClass('active');
            this._element.find('ul.secondaryTabs li.images').addClass('active');
            this._element.find('div.secondaryTabContent > div').addClass('hidden');
            this._element.find('div.secondaryTabContent > div.adminImagesTab').removeClass('hidden');
            this._imagesTab.load('/images');
        },
        showPhotosTab: function() {
            this._currentTab = 'photos';
            this._element.find('ul.secondaryTabs li.active').removeClass('active');
            this._element.find('ul.secondaryTabs li.photos').addClass('active');
            this._element.find('div.secondaryTabContent > div').addClass('hidden');
            this._element.find('div.secondaryTabContent > div.adminPhotosTab').removeClass('hidden');
            this._photosTab.load('/photos');
        },
        showUsersTab: function() {
            this._currentTab = 'users';
            this._element.find('ul.secondaryTabs li.active').removeClass('active');
            this._element.find('ul.secondaryTabs li.users').addClass('active');
            this._element.find('div.secondaryTabContent > div').addClass('hidden');
            this._element.find('div.secondaryTabContent > div.adminUsersTab').removeClass('hidden');
            this._usersTab.load('/users');
        }
    });
var
    AdminImagesTabView = View.extend({
        _loadedPath: null,
        init: function(element) {
            this._super(element);
        },
        _addInteractionEvents: function() {
            this._setupToggler();
            this._element.find('a.flagLink').click(function(event) {
                event.preventDefault();
                var
                    hasBeenFlagged = 1;
                if ($(this).closest('li.image').hasClass('hasBeenFlagged') === true) {
                    hasBeenFlagged = 0;
                }
                var
                    imageId = $(this).closest('li.image').attr('data-image-id');
                $(this).closest('li.image').toggleClass('hasBeenFlagged');
                $(this).find('span.copy').text('Unflag');
                if (hasBeenFlagged === 0) {
                    $(this).find('span.copy').text('Flag');
                }
                jQuery.post('/images/' + (imageId), {
                    data: {
                        hasBeenFlagged: hasBeenFlagged
                    },
                    csrfToken: Sai.get('csrfToken')
                }, function(response) {
                    if (response.success === true) {} else {
                        if (App().siteHasBeenLocked(response)) {
                            App().showLockedModal();
                        } else {
                            App().showErrorModal(false, response.failedRules[0].error.reference);
                        }
                    }
                }, 'json').fail(function() {
                    App().showErrorModal(false, 'mb1k');
                });
            });
        },
        _addPaginationEvents: function() {
            var
                _this = this;
            this._element.find('.pagination a').click(function(event) {
                event.preventDefault();
                var
                    href = $(this).attr('href');
                if (href !== '#') {
                    _this.load(href);
                }
            });
        },
        _setupToggler: function() {
            var
                _this = this,
                $switch = this._element.find('.switch');
            $switch.bootstrapSwitch();
            $switch.on('switch-change', function(event, data) {
                if (data.value === true) {
                    var
                        clauses = [
                            ['u.isPro', 1, false],
                            ['u.isAdmin', 0, false]
                        ],
                        path = '/images?clauses=' + encodeURIComponent(JSON.stringify(clauses));
                    _this.load(path);
                } else {
                    _this.load('/images');
                }
            });
        },
        load: function(path, callback) {
            this._removeTooltips();
            var
                _this = this;
            jQuery.get(path, {}, function(response) {
                _this._element.empty();
                if (response.success === true) {
                    var
                        html = _.template(App().getTemplate('admin', 'images'), {
                            showingOnlyPro: response.data.showingOnlyPro,
                            total: response.data.total,
                            images: response.data.images,
                            pagination: response.data.pagination
                        }),
                        elements = $(jQuery.parseHTML(html.trim()));
                    (new View(elements));
                    _this._element.append(elements);
                    _this._addInteractionEvents();
                    _this._addPaginationEvents();
                    callback && callback();
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        App().showErrorModal(false, response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                App().showErrorModal(false, 'b901');
            });
        }
    });
var
    AdminPhotosTabView = View.extend({
        _loadedPath: null,
        init: function(element) {
            this._super(element);
        },
        _addPhotoUploadEvent: function() {
            var
                _this = this;
            this._element.find('.cta a').click(function(event) {
                event.preventDefault();
                App().showFilepicker(function(inkBlobs) {
                    var
                        total = inkBlobs.length,
                        iteration = 1,
                        recursiveFn = function(inkBlobs) {
                            if (inkBlobs.length > 0) {
                                var
                                    copy = 'Processing file ' + (iteration) + ' of ' + (total);
                                ++iteration;
                                App().getElement().find('#busyModal .copy').text(copy);
                                var
                                    InkBlob = inkBlobs.shift(),
                                    key = InkBlob.url.split('/').pop(),
                                    sourceSrc = 'https://' + (Sai.get('config').cloudfront.filepicker) + '/api/file/' + (key);
                                jQuery.post('/photos', {
                                    filePickerKey: InkBlob.url.split('/').pop(),
                                    csrfToken: Sai.get('csrfToken')
                                }, function(response) {
                                    if (response.success === true) {
                                        recursiveFn(inkBlobs);
                                    } else {
                                        if (App().siteHasBeenLocked(response)) {
                                            App().showLockedModal();
                                        } else {
                                            App().showErrorModal(false, response.failedRules[0].error.reference);
                                        }
                                    }
                                }, 'json').fail(function() {
                                    App().showErrorModal(false, '6j3z');
                                });
                            } else {
                                _this.load('/photos');
                                App().closeBusyModal();
                            }
                        };
                    recursiveFn(inkBlobs);
                }, true);
            });
        },
        _addInteractionEvents: function() {
            var
                _this = this;
            this._element.find('a.editLink').click(function(event) {
                event.preventDefault();
                var
                    photoId = $(this).closest('li.photo').attr('data-photo-id');
                App().showPhotoEditModal(photoId, function(photoObj) {
                    App().closePhotoEditModal();
                    _this.load(_this._loadedPath);
                });
            });
            this._element.find('a.deleteLink').click(function(event) {
                event.preventDefault();
                if (prompt('Type DELETE-YES-DELETE to delete this photo') === 'DELETE-YES-DELETE') {
                    var
                        photoId = $(this).closest('li.photo').attr('data-photo-id');
                    jQuery.post('/photos/' + (photoId), {
                        data: {
                            status: 'closed'
                        },
                        csrfToken: Sai.get('csrfToken')
                    }, function(response) {
                        if (response.success === true) {
                            _this.load(_this._loadedPath);
                        } else {
                            if (App().siteHasBeenLocked(response)) {
                                App().showLockedModal();
                            } else {
                                App().showErrorModal(false, response.failedRules[0].error.reference);
                            }
                        }
                    }, 'json').fail(function() {
                        App().showErrorModal(false, '6pn3');
                    });
                }
            });
        },
        _addPaginationEvents: function() {
            var
                _this = this;
            this._element.find('.pagination a').click(function(event) {
                event.preventDefault();
                var
                    href = $(this).attr('href');
                if (href !== '#') {
                    _this.load(href);
                }
            });
        },
        load: function(path) {
            this._removeTooltips();
            this._loadedPath = path;
            var
                _this = this;
            jQuery.get(path, {}, function(response) {
                _this._element.empty();
                if (response.success === true) {
                    var
                        html = _.template(App().getTemplate('admin', 'photos'), {
                            total: response.data.total,
                            photos: response.data.photos,
                            pagination: response.data.pagination
                        }),
                        elements = $(jQuery.parseHTML(html.trim()));
                    (new View(elements));
                    _this._element.append(elements);
                    _this._addPhotoUploadEvent();
                    _this._addInteractionEvents();
                    _this._addPaginationEvents();
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        App().showErrorModal(false, response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                App().showErrorModal(false, '0nm1');
            });
        }
    });
var
    AdminUsersTabView = View.extend({
        _loadedPath: null,
        init: function(element) {
            this._super(element);
        },
        _formatEpochs: function() {
            moment.lang('en', {
                calendar: {
                    lastDay: '[Yday; ] LT',
                    sameDay: 'LT',
                    lastWeek: 'ddd[;] LT',
                    sameElse: 'L'
                }
            });
            this._element.find('li.record .registered, li.record .lastActive').each(function(index, element) {
                var
                    epoch = $(element).text().toInt();
                if (epoch !== 0) {
                    $(element).text(moment(epoch * 1000).calendar());
                }
            });
        },
        _addInteractionEvents: function() {
            var
                _this = this;
            this._element.find('.switch').bootstrapSwitch();
            this._element.find('.switch').on('switch-change', function(event, data) {
                var
                    val = 0;
                if (data.value === true) {
                    val = 1;
                }
                var
                    userId = $(this).closest('li.record').attr('data-user-id');
                jQuery.post('/users/' + (userId), {
                    data: {
                        isPro: val
                    },
                    csrfToken: Sai.get('csrfToken')
                }, function(response) {
                    if (response.success === true) {} else {
                        if (App().siteHasBeenLocked(response)) {
                            App().showLockedModal();
                        } else {
                            App().showErrorModal(false, response.failedRules[0].error.reference);
                        }
                    }
                }, 'json').fail(function() {
                    App().showErrorModal(false, '85b1');
                });
            });
            this._element.find('div.email a').popover();
            this._element.find('div.email a').click(function(event) {
                event.preventDefault();
            });
            this._element.find('div.email a').on('shown.bs.popover', function() {
                var
                    $search = _this._element.find('input[name="search"]');
                $search.focus();
                _this._element.find('form[name="search"]').submit(function(event) {
                    event.preventDefault();
                    var
                        clauses = [
                            ['email', 'LIKE', '%' + $(this).find('input[name="search"]').val() + '%']
                        ],
                        path = '/users?clauses=' + encodeURIComponent(JSON.stringify(clauses));
                    _this.load(path);
                });
            });
            this._element.find('.cancelSubscriptionLink').click(function(event) {
                event.preventDefault();
                if (prompt('Type CANCEL-YES-CANCEL to cancel this subscription') === 'CANCEL-YES-CANCEL') {
                    var
                        userId = $(this).closest('li.record').attr('data-user-id');
                    App().showBusyModal('cancellingSubscription');
                    jQuery.post('/users/' + (userId) + '/cancel', {
                        data: {},
                        csrfToken: Sai.get('csrfToken')
                    }, function(response) {
                        App().closeBusyModal();
                        if (response.success === true) {
                            App().trackEvent('User', 'cancelled', 'adminUsersTab', undefined, true);
                            _this.load(_this._loadedPath);
                        } else {
                            if (App().siteHasBeenLocked(response)) {
                                App().showLockedModal();
                            } else {
                                App().showErrorModal(false, response.failedRules[0].error.reference);
                            }
                        }
                    }, 'json').fail(function() {
                        App().showErrorModal(false, '9zgj');
                    });
                }
            });
            this._element.find('.impersonateLink').click(function(event) {
                event.preventDefault();
                var
                    userId = $(this).closest('li.record').attr('data-user-id');
                jQuery.post('/users/' + (userId) + '/impersonate', {
                    csrfToken: Sai.get('csrfToken')
                }, function(response) {
                    if (response.success === true) {
                        location.reload();
                    } else {
                        if (App().siteHasBeenLocked(response)) {
                            App().showLockedModal();
                        } else {
                            App().showErrorModal(false, response.failedRules[0].error.reference);
                        }
                    }
                }, 'json').fail(function() {
                    App().showErrorModal(false, '75b1');
                });
            });
        },
        _addPaginationEvents: function() {
            var
                _this = this;
            this._element.find('.pagination a').click(function(event) {
                event.preventDefault();
                var
                    href = $(this).attr('href');
                if (href !== '#') {
                    _this.load(href);
                }
            });
        },
        load: function(path) {
            this._removeTooltips();
            this._loadedPath = path;
            var
                _this = this;
            jQuery.get(path, {}, function(response) {
                _this._element.empty();
                if (response.success === true) {
                    var
                        html = _.template(App().getTemplate('admin', 'users'), {
                            users: response.data.users,
                            pagination: response.data.pagination
                        }),
                        elements = $(jQuery.parseHTML(html.trim()));
                    (new View(elements));
                    _this._element.append(elements);
                    _this._addPaginationEvents();
                    _this._addInteractionEvents();
                    _this._formatEpochs();
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        App().showErrorModal(false, response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                App().showErrorModal(false, 'ox81');
            });
        }
    });
var
    AdminCouponsTabView = View.extend({
        _loadedPath: null,
        init: function(element) {
            this._super(element);
        },
        _formatEpochs: function() {
            moment.lang('en', {
                calendar: {
                    lastDay: '[Yday @] LT',
                    sameDay: '[Today @] LT',
                    nextDay: '[Tomorrow @] LT',
                    lastWeek: '[Last] ddd [@] LT',
                    nextWeek: 'ddd [@] LT',
                    sameElse: 'L @ LT'
                }
            });
            this._element.find('li.record .redemptionLimit span.stamp').each(function(index, element) {
                var
                    epoch = $(element).text().toInt();
                if (epoch !== 0) {
                    $(element).text(moment(epoch * 1000).calendar());
                }
            });
        },
        _addInteractionEvents: function() {
            var
                _this = this;
            this._element.find('.switch').bootstrapSwitch();
            this._element.find('.switch').on('switch-change', function(event, data) {
                var
                    val = 0;
                if (data.value === true) {
                    val = 1;
                }
                var
                    couponId = $(this).closest('li.record').attr('data-coupon-id');
                jQuery.post('/coupons/' + (couponId), {
                    data: {
                        isTurnedOn: val
                    },
                    csrfToken: Sai.get('csrfToken')
                }, function(response) {
                    if (response.success === true) {} else {
                        if (App().siteHasBeenLocked(response)) {
                            App().showLockedModal();
                        } else {
                            App().showErrorModal(false, response.failedRules[0].error.reference);
                        }
                    }
                }, 'json').fail(function() {
                    App().showErrorModal(false, '85b1');
                });
            });
            this._element.find('.deleteCouponLink').click(function(event) {
                event.preventDefault();
                if (prompt('Type DELETE-YES-DELETE to delete this coupon') === 'DELETE-YES-DELETE') {
                    var
                        couponId = $(this).closest('li.record').attr('data-coupon-id');
                    App().showBusyModal('cancellingSubscription');
                    jQuery.post('/coupons/' + (couponId) + '/delete', {
                        data: {},
                        csrfToken: Sai.get('csrfToken')
                    }, function(response) {
                        App().closeBusyModal();
                        if (response.success === true) {
                            _this.load(_this._loadedPath);
                        } else {
                            if (App().siteHasBeenLocked(response)) {
                                App().showLockedModal();
                            } else {
                                App().showErrorModal(false, response.failedRules[0].error.reference);
                            }
                        }
                    }, 'json').fail(function() {
                        App().showErrorModal(false, '9zgp');
                    });
                }
            });
            this._element.find('div.code a').popover();
            this._element.find('div.code a').click(function(event) {
                event.preventDefault();
            });
            this._element.find('div.code a').on('shown.bs.popover', function() {
                var
                    $search = _this._element.find('input[name="search"]');
                $search.focus();
                _this._element.find('form[name="search"]').submit(function(event) {
                    event.preventDefault();
                    var
                        clauses = [
                            ['wasAutoGenerated', '0'],
                            ['code', 'LIKE', '%' + $(this).find('input[name="search"]').val() + '%']
                        ],
                        path = '/coupons?clauses=' + encodeURIComponent(JSON.stringify(clauses));
                    _this.load(path);
                });
            });
            this._element.find('.newCouponBtn').click(function(event) {
                event.preventDefault();
                App().showCouponModal(function(couponObj) {
                    App().closeCouponModal();
                    var
                        clauses = [
                            ['wasAutoGenerated', '0']
                        ],
                        path = '/coupons?clauses=' + encodeURIComponent(JSON.stringify(clauses));
                    _this.load(path);
                });
            });
        },
        _addPaginationEvents: function() {
            var
                _this = this;
            this._element.find('.pagination a').click(function(event) {
                event.preventDefault();
                var
                    href = $(this).attr('href');
                if (href !== '#') {
                    _this.load(href);
                }
            });
        },
        load: function(path) {
            this._removeTooltips();
            this._loadedPath = path;
            var
                _this = this;
            jQuery.get(path, {}, function(response) {
                _this._element.empty();
                if (response.success === true) {
                    var
                        html = _.template(App().getTemplate('admin', 'coupons'), {
                            coupons: response.data.coupons,
                            pagination: response.data.pagination
                        }),
                        elements = $(jQuery.parseHTML(html.trim()));
                    (new View(elements));
                    _this._element.append(elements);
                    _this._addPaginationEvents();
                    _this._addInteractionEvents();
                    _this._formatEpochs();
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        App().showErrorModal(false, response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                App().showErrorModal(false, 'sx81');
            });
        }
    });
var
    AdminCategoriesTabView = View.extend({
        _loadedPath: null,
        init: function(element) {
            this._super(element);
        },
        _addInteractionEvents: function() {
            var
                _this = this;
            this._element.find('.deleteCategoryLink').click(function(event) {
                event.preventDefault();
                if (prompt('Type DELETE-YES-DELETE to delete this category') === 'DELETE-YES-DELETE') {
                    var
                        categoryId = $(this).closest('li.record').attr('data-category-id');
                    App().showBusyModal('cancellingSubscription');
                    jQuery.post('/categories/' + (categoryId) + '/delete', {
                        data: {},
                        csrfToken: Sai.get('csrfToken')
                    }, function(response) {
                        App().closeBusyModal();
                        if (response.success === true) {
                            _this.load(_this._loadedPath);
                        } else {
                            if (App().siteHasBeenLocked(response)) {
                                App().showLockedModal();
                            } else {
                                App().showErrorModal(false, response.failedRules[0].error.reference);
                            }
                        }
                    }, 'json').fail(function() {
                        App().showErrorModal(false, '9zgp');
                    });
                }
            });
            this._element.find('.newCategoryBtn').click(function(event) {
                event.preventDefault();
                App().showCategoryModal(function(categoryObj) {
                    App().closeCategoryModal();
                    var
                        path = '/categories?clauses=' + encodeURIComponent(JSON.stringify([]));
                    _this.load(path);
                });
            });
        },
        _addPaginationEvents: function() {
            var
                _this = this;
            this._element.find('.pagination a').click(function(event) {
                event.preventDefault();
                var
                    href = $(this).attr('href');
                if (href !== '#') {
                    _this.load(href);
                }
            });
        },
        load: function(path) {
            this._removeTooltips();
            this._loadedPath = path;
            var
                _this = this;
            jQuery.get(path, {}, function(response) {
                _this._element.empty();
                if (response.success === true) {
                    var
                        html = _.template(App().getTemplate('admin', 'categories'), {
                            categories: response.data.categories,
                            pagination: response.data.pagination
                        }),
                        elements = $(jQuery.parseHTML(html.trim()));
                    (new View(elements));
                    _this._element.append(elements);
                    _this._addPaginationEvents();
                    _this._addInteractionEvents();
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        App().showErrorModal(false, response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                App().showErrorModal(false, 'sxb1');
            });
        }
    });
var
    CanvasView = View.extend({
        _grids: {
            vertical: null,
            horizontal: null
        },
        init: function(element) {
            this._super(element);
        },
        _drawGrid: function() {
            this._grid = {
                vertical: $('<div class="verticalGrid hidden"></div>'),
                horizontal: $('<div class="horizontalGrid hidden"></div>')
            };
            App().getElement().find('#preview').append(this._grid.vertical, this._grid.horizontal);
        },
        _drawNextImageLayer: function(layers, callback) {
            if (layers.length === 0) {
                callback();
            } else {
                var
                    layer = layers.shift(),
                    _this = this,
                    internal = function() {
                        _this._drawNextImageLayer(layers, callback);
                    };
                layer.getDrawing().draw(internal);
            }
        },
        _repositionTextLayers: function() {
            var
                layers = App().getImageDocument().getTextLayers();
            $(layers).each(function(index, layer) {
                layer.setStyle('x', layer.getDrawing().getXPosition());
                layer.setStyle('y', layer.getDrawing().getYPosition());
                layer.getDrawing().refreshStyle('x');
                layer.getDrawing().refreshStyle('y');
                layer.setRelativePosition();
            });
        },
        _repositionWatermark: function() {
            var
                layer = App().getImageDocument().getWatermarkLayer();
            layer.setStyle('x', layer.getDrawing().getXPosition());
            layer.setStyle('y', layer.getDrawing().getYPosition());
            layer.getDrawing().refreshStyle('x');
            layer.getDrawing().refreshStyle('y');
            layer.setRelativePosition();
        },
        _resizeTextLayers: function() {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                width = backgroundLayer.getStyle('width'),
                layers = App().getImageDocument().getTextLayers();
            $(layers).each(function(index, layer) {
                layer.setStyle('maxWidth', Math.floor(App().getTextMaxWidthRatio() * width));
                layer.getDrawing().refreshStyle('maxWidth');
            });
        },
        alignInstagramOverlayRectangleLayers: function() {
            var
                imageDocument = App().getImageDocument(),
                instagramOverlayRectangleLayers = imageDocument.getInstagramOverlayRectangleLayers();
            instagramOverlayRectangleLayers[0].getDrawing().align();
            instagramOverlayRectangleLayers[1].getDrawing().align();
        },
        alignMargins: function() {
            var
                containerHeight = App().getElement().find('#preview').css('height').toInt(),
                half = Math.round((containerHeight - this._element.css('height').toInt()) / 2);
            this._element.css('margin-top', half);
        },
        alignRuleRectangleLayers: function() {
            var
                imageDocument = App().getImageDocument(),
                verticalRuleRectangleLayer = imageDocument.getVerticalRuleRectangleLayer(),
                horizontalRuleRectangleLayer = imageDocument.getHorizontalRuleRectangleLayer();
            verticalRuleRectangleLayer.getDrawing().align();
            horizontalRuleRectangleLayer.getDrawing().align();
        },
        alignTwitterOverlayRectangleLayers: function() {
            var
                imageDocument = App().getImageDocument(),
                twitterOverlayRectangleLayers = imageDocument.getTwitterOverlayRectangleLayers();
            twitterOverlayRectangleLayers[0].getDrawing().align();
            twitterOverlayRectangleLayers[1].getDrawing().align();
        },
        drawBackgroundLayer: function(callback) {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer();
            if (backgroundLayer.constructor === RectangleLayer) {
                backgroundLayer.getDrawing().draw();
                callback();
            } else
            if (backgroundLayer.constructor === ImageLayer) {
                backgroundLayer.getDrawing().draw(callback);
            }
        },
        drawImageLayers: function(callback) {
            var
                imageDocument = App().getImageDocument(),
                layers = imageDocument.getImageLayers(),
                backgroundLayer = imageDocument.getBackgroundLayer();
            $(layers).each(function(index, layer) {
                if (layer === backgroundLayer) {
                    layers.splice(index, 1);
                }
            });
            this._drawNextImageLayer(layers, callback);
        },
        drawInstagramOverlayRectangleLayers: function() {
            var
                imageDocument = App().getImageDocument(),
                instagramOverlayRectangleLayers = imageDocument.getInstagramOverlayRectangleLayers();
            instagramOverlayRectangleLayers[0].getDrawing().draw();
            instagramOverlayRectangleLayers[1].getDrawing().draw();
        },
        drawRectangleLayers: function() {
            var
                imageDocument = App().getImageDocument(),
                rectanglelayers = imageDocument.getRectangleLayers(),
                backgroundLayer = imageDocument.getBackgroundLayer();
            $(rectanglelayers).each(function(index, layer) {
                if (layer !== backgroundLayer) {
                    layer.getDrawing().draw();
                }
            });
        },
        drawRuleRectangleLayers: function() {
            var
                imageDocument = App().getImageDocument(),
                verticalRuleRectangleLayer = imageDocument.getVerticalRuleRectangleLayer(),
                horizontalRuleRectangleLayer = imageDocument.getHorizontalRuleRectangleLayer();
            verticalRuleRectangleLayer.getDrawing().draw();
            horizontalRuleRectangleLayer.getDrawing().draw();
        },
        drawTextLayers: function() {
            var
                layers = App().getImageDocument().getTextLayers();
            $(layers).each(function(index, layer) {
                layer.getDrawing().draw();
            });
        },
        drawTwitterOverlayRectangleLayers: function() {
            var
                imageDocument = App().getImageDocument(),
                twitterOverlayRectangleLayers = imageDocument.getTwitterOverlayRectangleLayers();
            twitterOverlayRectangleLayers[0].getDrawing().draw();
            twitterOverlayRectangleLayers[1].getDrawing().draw();
        },
        getTwitterImageVerticalOffset: function() {},
        resize: function() {
            var
                backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                width = backgroundLayer.getStyle('width'),
                height = backgroundLayer.getStyle('height');
            this._element.attr('width', width);
            this._element.attr('height', height);
            this._resizeTextLayers();
            this._repositionTextLayers();
            this._repositionWatermark();
            this._element.drawLayers();
            this.alignRuleRectangleLayers();
            this.alignTwitterOverlayRectangleLayers();
            this.alignInstagramOverlayRectangleLayers();
            this.alignMargins();
            if (App().userIsPro() === false) {
                App().usingReservedPhoto(App().isUsingReservedPhoto());
                App().usingReservedFont(App().isUsingReservedFont());
                App().usingReservedTemplate(App().isUsingReservedTemplate());
            }
        }
    });
var
    BackgroundControlView = View.extend({
        _colorPicker: null,
        init: function(element) {
            this._super(element);
            this._setupFillStyleEvent();
            this._setupSourceEvent();
            this._element.find('input.minicolors-input').minicolors();
        },
        _setupFillStyleEvent: function() {
            var
                _this = this;
            this._colorPicker = (new ColorPickerView(this._element.find('input[name="fillStyle"]'), {
                placement: 'bottom',
                title: 'Background Color',
                selected: function(hex) {
                    var
                        backgroundLayer = App().getImageDocument().getBackgroundLayer();
                    if (backgroundLayer.constructor === ImageLayer) {
                        backgroundLayer.removeFromImageDocument();
                        backgroundLayer.getDrawing().removeFromCanvas();
                        var
                            maximumCanvasDimensions = App().getMaximumCanvasDimensions(),
                            properties = {
                                isBackground: true,
                                type: 'rectangle',
                                filters: [],
                                styles: {
                                    fillStyle: hex,
                                    height: maximumCanvasDimensions.height,
                                    width: maximumCanvasDimensions.width,
                                    x: 0,
                                    y: 0
                                }
                            },
                            newLayer = (new RectangleLayer(properties));
                        App().getImageDocument().addLayer(newLayer);
                        newLayer.getDrawing().draw();
                        newLayer.getDrawing().sendToBack();
//                        App().getFiltersTab().disable();
  //                      App().getFiltersTab().reset();
                        App().getCanvas().resize();
                    } else {
                        backgroundLayer.setStyle('fillStyle', hex);
                        backgroundLayer.getDrawing().refreshStyle('fillStyle');
                    }
                    App().usingReservedPhoto(false);
                    App().usingReservedTemplate(false);
                }
            }));
        },
        _setupSourceEvent: function() {
            var
                showFilepicker = Sai.get('config').defaults.showFilepicker;
            if (showFilepicker === false) {
                this._element.find('a.filepickerButton').popover({
                    placement: 'bottom',
                    content: 'Currently disabled due to a technical issue. We\'re actively working to resolve the issue. Thanks for your patience!',
                    trigger: 'hover',
                    container: '#background'
                });
            }
            this._element.find('a.filepickerButton').click(function(event) {
                event.preventDefault();
                var
                    isNewTabInChrome = Sai.get('config').referer !== false && Sai.get('config').referer.indexOf('_/chrome/newtab') !== -1;
                if (isNewTabInChrome) {
                    App().showAlertModal('filepickerUnavailable');
                } else {
                    if (showFilepicker === true) {
                        App().trackEvent('BackgroundImage', 'shown', 'backgroundControl');
                        App().mpTrackEvent('Filepicker shown', {
                            _source: 'Background control'
                        });
                        App().showFilepicker(function(sourceSrc, InkBlob) {
                            App().trackEvent('BackgroundImage', 'picked', 'backgroundControl');
                            App().mpTrackEvent('Background image uploaded', {
                                _source: 'Background control'
                            });
                            App().resetSize();
                            App().usingReservedPhoto(false);
                            App().usingReservedTemplate(false);
                            App().drawFPImageAsBackgroundLayer(sourceSrc, 'max', function() {
                                App().getImageDocument().getBackgroundLayer().setProperty('wasManuallyUploaded', true);
                            });
                            if (App().userIsLoggedIn() === true) {
                                App().trackUpload(sourceSrc, function(uploadObj) {
                                    var
                                        uploads = Sai.get('uploads');
                                    uploads.unshift(uploadObj);
                                    Sai.set('uploads', uploads);
                                    App().getBackgroundTab().drawUploadsResourceTab();
                                });
                            }
                        }, false);
                    }
                }
            });
        }
    });
var
    TextControlView = View.extend({
        _alwaysShadow: false,
        _colorPickers: {
            fillStyle: null,
            plane: null,
            strokeStyle: null
        },
        _textLayer: null,
        init: function(element, textLayer) {
            if (App().isFirefox() === true) {
                this._alwaysShadow = true;
            }
            this._super(element);
            this._textLayer = textLayer;
            this._colorPickers = {
                fillStyle: null,
                plane: null,
                strokeStyle: null
            };
            this._element.find('select').selectpicker({
                container: 'body'
            });
            this._setupAlignEvents();
            this._setupFillStyleEvent();
            this._setupPlaneFillStyleEvent();
            this._setupStrokeStyleEvent();
            this._setupFontFamilyDropdown();
            this._setupFontFamilyEvent();
            this._setupFontSizeEvent();
            this._setupFontStyleEvents();
            this._setupTextEvent();
            this._setupRemoveEvent();
            this._updateFontStyleElements(this._element.find('[name="fontFamily"]').val());
        },
        _getContrastingColor: function(color) {
            var
                colorObj = pusher.color(color);
            return colorObj.contrastWhiteBlack().alpha(0.25).html();
        },
        _setStrokeWidth: function() {
            var
                fontSize = this._textLayer.getStyle('fontSize').toInt(),
                strokeWidth;
            if (fontSize < 20) {
                strokeWidth = 3;
            } else
            if (fontSize < 30) {
                strokeWidth = 4;
            } else
            if (fontSize < 40) {
                strokeWidth = 5;
            } else
            if (fontSize < 50) {
                strokeWidth = 6;
            } else {
                strokeWidth = 7;
            }
            this._textLayer.setStyle('strokeWidth', strokeWidth);
            this._textLayer.setStyle('rounded', true);
        },
        _setupAlignEvents: function() {
            var
                _this = this;
            this._element.find('input[name="align"]').change(function() {
                var
                    align = $(this).val();
                _this._textLayer.setStyle('align', align);
                _this._textLayer.getDrawing().refreshStyle('align');
                App().trackEvent('Text', 'aligned', align);
                App().mpTrackEvent('Text aligned', {
                    _align: align
                });
            });
        },
        _setShadowColor: function() {
            var
                shadowColor = this._getContrastingColor(this._textLayer.getStyle('fillStyle'));
            if (this._alwaysShadow === true || (typeof this._textLayer.getStyle('strokeWidth') !== 'undefined' && this._textLayer.getStyle('strokeWidth').toInt() > 0)) {
                shadowColor = 'rgba(0,0,0,0)';
            }
            this._textLayer.setStyle('shadowColor', shadowColor);
            this._textLayer.getDrawing().refreshStyle('shadowColor');
        },
        _setFillStyle: function(hex) {
            this._textLayer.setStyle('fillStyle', hex);
            this._textLayer.getDrawing().refreshStyle('fillStyle');
            this._setShadowColor();
        },
        _setStrokeStyle: function(hex) {
            this._textLayer.setStyle('strokeStyle', hex);
            this._setStrokeWidth();
            this._textLayer.getDrawing().refreshStyles(['fillStyle', 'strokeStyle', 'strokeWidth', 'rounded']);
            this._element.find('.strokeWrapper .icon-remove').removeClass('hidden');
            this._setShadowColor();
        },
        _setupFillStyleEvent: function() {
            var
                _this = this,
                placement = 'bottom';
            if (App().getElement().find('textarea[name="text"]').length > 1) {}
            this._colorPickers.fillStyle = (new ColorPickerView(this._element.find('input[name="fillStyle"]'), {
                container: App().getElement(),
                placement: placement,
                title: 'Color',
                selected: function(hex) {
                    _this._setFillStyle(hex);
                }
            }));
        },
        _setupPlaneFillStyleEvent: function() {
            var
                _this = this;
            var
                placement = 'bottom';
            if (App().getElement().find('textarea[name="text"]').length > 1) {}
            this._colorPickers.plane = (new ColorPickerView(this._element.find('input[name="planeFillStyle"]'), {
                container: App().getElement(),
                placement: placement,
                title: 'Box',
                selected: function(hex) {
                    if (typeof _this._textLayer.getProperty('plane') === 'undefined') {
                        _this._textLayer.getDrawing().addPlane(hex);
                    }
                    _this._textLayer.setProperty('plane', hex);
                    _this._textLayer.getPlane().setStyle('fillStyle', hex);
                    _this._textLayer.getPlane().getDrawing().refreshStyle('fillStyle');
                    _this._textLayer.getPlane().getDrawing().redraw();
                    _this._element.find('.planeWrapper .icon-remove').removeClass('hidden');
                }
            }));
            this._element.find('.planeWrapper a.icon-remove').click(function(event) {
                event.preventDefault();
                _this._element.find('.planeWrapper .icon-remove').addClass('hidden');
                _this._element.find('input[name="planeFillStyle"]').val('');
                _this._textLayer.getDrawing().removePlane();
                _this._textLayer.removeProperty('plane');
                _this._element.find('.planeWrapper .swatch .inner').css({
                    backgroundColor: ''
                });
            });
        },
        _setupStrokeStyleEvent: function() {
            var
                _this = this;
            var
                placement = 'bottom';
            if (App().getElement().find('textarea[name="text"]').length > 1) {}
            this._colorPickers.strokeStyle = (new ColorPickerView(this._element.find('input[name="strokeStyle"]'), {
                container: App().getElement(),
                placement: placement,
                title: 'Outline',
                selected: function(hex) {
                    _this._setStrokeStyle(hex);
                }
            }));
            this._element.find('.strokeWrapper a.icon-remove').click(function(event) {
                event.preventDefault();
                _this._element.find('.strokeWrapper .icon-remove').addClass('hidden');
                _this._element.find('input[name="strokeStyle"]').val('');
                _this._textLayer.setStyle('strokeWidth', 0);
                _this._textLayer.getDrawing().refreshStyles(['fillStyle', 'strokeStyle', 'strokeWidth', 'rounded']);
                _this._element.find('.strokeWrapper .swatch .inner').css({
                    backgroundColor: ''
                });
                _this._setShadowColor();
            });
        },
        _setupFontFamilyDropdown: function() {
            var
                _this = this,
                element = this._element.find('*[name="fontFamily"]').first(),
                options = element.find('option'),
                dropdownElement = element.next().find('.dropdown-menu');
            options.each(function(optionIndex, optionElement) {
                optionElement = $(optionElement);
                var
                    fontFamily = optionElement.attr('data-fontfamily'),
                    relativeElement = dropdownElement.find('li[data-original-index="' + (optionIndex) + '"]');
                relativeElement.css('font-family', fontFamily);
            });
        },
        _updateFontStyleElements: function(fontFamily) {
            var
                fontFamilies = App().getFontFamilies(),
                selectedFontFamilyObj;
            $(fontFamilies).each(function(index, fontFamilyObj) {
                if (fontFamilyObj.name === fontFamily) {
                    selectedFontFamilyObj = fontFamilyObj;
                }
            });
            var
                _this = this,
                boldElement = _this._element.find('input[name="bold"]'),
                italicElement = _this._element.find('input[name="italic"]');
            boldElement.parent().addClass('disabled');
            italicElement.parent().addClass('disabled');
            if (selectedFontFamilyObj.bold === true) {
                boldElement.parent().removeClass('disabled');
            }
            if (selectedFontFamilyObj.italic === true) {
                italicElement.parent().removeClass('disabled');
            }
            if (boldElement.is(':checked') && boldElement.parent().hasClass('disabled')) {
                boldElement.attr('checked', false);
                boldElement.parent().removeClass('active');
                this._textLayer.setStyle('fontStyle', 'normal');
                this._textLayer.getDrawing().refreshStyle('fontStyle');
            } else
            if (italicElement.is(':checked') && italicElement.parent().hasClass('disabled')) {
                italicElement.attr('checked', false);
                italicElement.parent().removeClass('active');
                this._textLayer.setStyle('fontStyle', 'normal');
                this._textLayer.getDrawing().refreshStyle('fontStyle');
            }
        },
        _setupFontFamilyEvent: function() {
            var
                _this = this,
                $fontFamily = this._element.find('select[name="fontFamily"]');
            $fontFamily.change(function() {
                var
                    fontFamily = $(this).val();
                App().trackEvent('Text', 'fontFamily', fontFamily);
                App().mpTrackEvent('Text font changed', {
                    _fontFamily: fontFamily
                });
                _this._updateFontStyleElements(fontFamily);
                _this._textLayer.setStyle('fontFamily', fontFamily);
                _this._textLayer.getDrawing().refreshStyle('fontFamily');
                App().getElement().find('#createImageBtn').first().focus();
                App().getElement().find('#createImageBtn').first().blur();
            });
            $fontFamily.data().selectpicker.$newElement.click(function(event) {
                App().loadWebFonts(App().getFontFamilies());
            });
            var
                _this = this;
            $fontFamily.data().selectpicker.$newElement.find('li').mouseover(function(event) {
                var
                    position = $(this).index(),
                    font = $fontFamily.find('option')[position],
                    fontFamily = $(font).attr('data-fontfamily');
                _this._updateFontStyleElements(fontFamily);
                _this._textLayer.setStyle('fontFamily', fontFamily);
                _this._textLayer.getDrawing().refreshStyle('fontFamily');
            });
        },
        _setupFontSizeEvent: function() {
            var
                _this = this,
                sliderElement = this._element.find('input[name="fontSize"]');
            sliderElement.slider();
            sliderElement.on('slide', function(event) {
                var
                    sliderValue = event.value,
                    strokeWidth = _this._textLayer.getStyle('strokeWidth'),
                    strokeStyle = _this._textLayer.getStyle('strokeStyle');
                _this._textLayer.setStyle('fontSize', (sliderValue + 'px'));
                if (typeof strokeWidth !== 'undefined' && strokeWidth.toInt() !== 0 && typeof strokeStyle !== 'undefined') {
                    _this._setStrokeWidth();
                }
                _this._textLayer.getDrawing().refreshStyles(['fontSize', 'fillStyle', 'strokeStyle', 'strokeWidth', 'rounded']);
            });
        },
        _setupFontStyleEvents: function() {
            var
                _this = this,
                boldElement = _this._element.find('input[name="bold"]'),
                italicElement = _this._element.find('input[name="italic"]');
            boldElement.change(function(event) {
                if ($(this).parent().hasClass('disabled') === false) {
                    var
                        fontStyle = 'normal';
                    $(this).parent().toggleClass('active');
                    if ($(this).is(':checked') === true) {
                        fontStyle = 'bold';
                        italicElement.attr('checked', false);
                        italicElement.parent().removeClass('active');
                        App().trackEvent('Text', 'bolded');
                        App().mpTrackEvent('Text bolded');
                    }
                    _this._textLayer.setStyle('fontStyle', fontStyle);
                    _this._textLayer.getDrawing().refreshStyle('fontStyle');
                } else {
                    $(this).attr('checked', false);
                }
            });
            italicElement.change(function(event) {
                if ($(this).parent().hasClass('disabled') === false) {
                    var
                        fontStyle = 'normal';
                    $(this).parent().toggleClass('active');
                    if ($(this).is(':checked') === true) {
                        fontStyle = 'italic';
                        boldElement.attr('checked', false);
                        boldElement.parent().removeClass('active');
                        App().trackEvent('Text', 'italicized');
                        App().mpTrackEvent('Text italicized');
                    }
                    _this._textLayer.setStyle('fontStyle', fontStyle);
                    _this._textLayer.getDrawing().refreshStyle('fontStyle');
                } else {
                    $(this).attr('checked', false);
                }
            });
        },
        _setupRemoveEvent: function() {
            var
                _this = this;
            this._element.find('.remove, .removeTextCta').click(function(event) {
                event.preventDefault();
                _this._textLayer.removeFromImageDocument();
                _this._textLayer.getDrawing().removeFromCanvas();
                _this.removeFromControls();
            });
        },
        _setupTextEvent: function() {
            var
                _this = this;
            this._element.find('textarea').bind('input propertychange', function() {
                var
                    text = $(this).val();
                _this._textLayer.setStyle('text', text);
                _this._textLayer.getDrawing().refreshStyle('text');
            });
        },
        getColorPickers: function() {
            return this._colorPickers;
        },
        removeFromControls: function() {
            this._element.remove();
            if (this._textLayer.getPlane() !== null) {
                this._textLayer.getDrawing().removePlane();
            }
            App().getTextTab().update();
        }
    });
var
    FiltersTabView = View.extend({
        init: function(element) {
            this._super(element);
            this._element.find('input.minicolors-input').minicolors();
            this._setupCamanJsEvents();
            this._setupBlurEvent();
            this._setupColorizeEvents();
            this._setupDarkenEvent();
            this._setupOpacityEvent();
            var
                showFilepicker = Sai.get('config').defaults.showFilepicker;
            if (showFilepicker === false) {
                this._element.find('a.uploadBtn').popover({
                    placement: 'bottom',
                    content: 'Currently disabled due to a technical issue. We\'re actively working to resolve the issue. Thanks for your patience!',
                    trigger: 'hover'
                });
            }
            this._element.find('a.uploadBtn').click(function(event) {
                event.preventDefault();
                var
                    isNewTabInChrome = Sai.get('config').referer !== false && Sai.get('config').referer.indexOf('_/chrome/newtab') !== -1;
                if (isNewTabInChrome) {
                    App().showAlertModal('filepickerUnavailable');
                } else {
                    if (showFilepicker === true) {
                        App().trackEvent('BackgroundImage', 'clicked', 'filtersTab');
                        App().mpTrackEvent('Filepicker shown', {
                            _source: 'Filters tab'
                        });
                        App().showFilepicker(function(sourceSrc, InkBlob) {
                            App().trackEvent('BackgroundImage', 'picked', 'filtersTab');
                            App().mpTrackEvent('Background image uploaded', {
                                _source: 'Filters tab'
                            });
                            App().resetSize();
                            App().usingReservedPhoto(false);
                            App().usingReservedTemplate(false);
                            App().drawFPImageAsBackgroundLayer(sourceSrc, 'max', function() {
                                App().getImageDocument().getBackgroundLayer().setProperty('wasManuallyUploaded', true);
                            });
                            if (App().userIsLoggedIn() === true) {
                                App().trackUpload(sourceSrc, function(uploadObj) {
                                    var
                                        uploads = Sai.get('uploads');
                                    uploads.unshift(uploadObj);
                                    Sai.set('uploads', uploads);
                                    App().getBackgroundTab().drawUploadsResourceTab();
                                });
                            }
                        }, false);
                    }
                }
            });
        },
        _removeFilters: function(exception) {
            var
                $checkboxes = this._element.find('.btn.btn-default.btn-sm input[type="checkbox"]');
            $checkboxes.attr('checked', false);
            $checkboxes.parents().removeClass('active');
        },
        _setupCamanJsEvents: function() {
            var
                _this = this;
            this._element.find('div.camanJsFilter input[type="checkbox"]').change(function() {
                var
                    authd = App().userIsPro() == true || $(this).closest('.camanJsFilter').attr('data-filter-isfree') === 'true' || Sai.get('publisher') !== false;
                if (authd) {
                    var
                        backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                        filterType = $(this).closest('.camanJsFilter').attr('data-camanjsfilter');
                    if ($(this).is(':checked')) {
                        App().trackEvent('Filter', filterType, 'backgroundImage');
                        _this._removeFilters(this);
                        backgroundLayer.removeFilters();
                        backgroundLayer.addFilter({
                            type: filterType,
                            properties: {}
                        });
                    } else {
                        backgroundLayer.removeFilter(filterType);
                    }
                } else {
                    var
                        _this2 = this;
                    setTimeout(function() {
                        $(_this2).attr('checked', false);
                        $(_this2).parent().removeClass('active');
                    }, 0);
                    App().showUpsellModal('filters');
                }
            });
        },
        _setupBlurEvent: function() {
            var
                _this = this,
                checkboxElement = this._element.find('input[name="blur"]'),
                strengthElement = this._element.find('input[name="blurStrength"]');
            checkboxElement.change(function() {
                var
                    backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                    filterObj = backgroundLayer.getFilter('blur');
                if (filterObj === false) {
                    App().trackEvent('Filter', 'blur', 'backgroundImage');
                    _this._removeFilters(this);
                    backgroundLayer.removeFilters();
                    backgroundLayer.addFilter({
                        type: 'blur',
                        properties: {
                            strength: strengthElement.val().toInt()
                        }
                    });
                } else {
                    backgroundLayer.removeFilter('blur');
                }
            });
            strengthElement.slider();
            strengthElement.parent().mousedown(function() {
                checkboxElement.prop('checked', true);
                checkboxElement.parent().addClass('active');
            });
            strengthElement.on('slideStop', function(event) {
                var
                    backgroundLayer = App().getImageDocument().getBackgroundLayer();
                if (backgroundLayer.getFilter('blur') === false) {
                    App().trackEvent('Filter', 'blur', 'backgroundImage');
                }
                backgroundLayer.setFilter({
                    type: 'blur',
                    properties: {
                        strength: event.value.toInt()
                    }
                });
            });
        },
        _setupColorizeEvents: function() {
            var
                _this = this,
                checkboxElement = this._element.find('input[name="colorize"]'),
                colorElement = this._element.find('input[name="colorizeColor"]'),
                strengthElement = this._element.find('input[name="colorizeStrength"]');
            checkboxElement.change(function() {
                var
                    backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                    filterObj = backgroundLayer.getFilter('colorize');
                if (filterObj === false) {
                    App().trackEvent('Filter', 'colorize', 'backgroundImage');
                    _this._removeFilters(this);
                    backgroundLayer.removeFilters();
                    backgroundLayer.addFilter({
                        type: 'colorize',
                        properties: {
                            strength: strengthElement.val().toInt(),
                            color: colorElement.val()
                        }
                    });
                } else {
                    backgroundLayer.removeFilter('colorize');
                }
            });
            strengthElement.slider();
            var
                buttonActiveFunction = function() {
                    checkboxElement.prop('checked', true);
                    checkboxElement.parent().addClass('active');
                };
            strengthElement.parent().mousedown(buttonActiveFunction);
            strengthElement.on('slideStop', function(event) {
                var
                    backgroundLayer = App().getImageDocument().getBackgroundLayer();
                if (backgroundLayer.getFilter('colorize') === false) {
                    App().trackEvent('Filter', 'colorize', 'backgroundImage');
                }
                backgroundLayer.setFilter({
                    type: 'colorize',
                    properties: {
                        strength: event.value.toInt(),
                        color: colorElement.val()
                    }
                });
            });
            $(colorElement).minicolors('settings', {
                changeDelay: 100,
                change: function(hex) {
                    var
                        backgroundLayer = App().getImageDocument().getBackgroundLayer();
                    buttonActiveFunction();
                    if (backgroundLayer.getFilter('colorize') === false) {
                        App().trackEvent('Filter', 'colorize', 'backgroundImage');
                    }
                    backgroundLayer.setFilter({
                        type: 'colorize',
                        properties: {
                            strength: strengthElement.val().toInt(),
                            color: colorElement.val()
                        }
                    });
                }
            });
        },
        _setupDarkenEvent: function() {
            var
                _this = this,
                checkboxElement = this._element.find('input[name="darken"]');
            checkboxElement.change(function() {
                var
                    backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                    filterObj = backgroundLayer.getFilter('darken'),
                    darkenStrength = 50;
                darkenStrength = 100 - darkenStrength;
                if (filterObj === false) {
                    App().trackEvent('Filter', 'darken', 'backgroundImage');
                    _this._removeFilters(this);
                    backgroundLayer.removeFilters();
                    backgroundLayer.addFilter({
                        type: 'darken',
                        properties: {
                            strength: darkenStrength
                        }
                    });
                } else {
                    backgroundLayer.removeFilter('darken');
                }
            });
        },
        _setupOpacityEvent: function() {
            var
                _this = this,
                checkboxElement = this._element.find('input[name="opacity"]'),
                strengthElement = this._element.find('input[name="opacityStrength"]');
            checkboxElement.change(function() {
                var
                    backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                    filterObj = backgroundLayer.getFilter('opacity'),
                    opacityStrength = strengthElement.val().toInt();
                opacityStrength = 100 - opacityStrength;
                if (filterObj === false) {
                    App().trackEvent('Filter', 'opacity', 'backgroundImage');
                    _this._removeFilters(this);
                    backgroundLayer.removeFilters();
                    backgroundLayer.addFilter({
                        type: 'opacity',
                        properties: {
                            strength: opacityStrength
                        }
                    });
                } else {
                    backgroundLayer.removeFilter('opacity');
                }
            });
            strengthElement.slider();
            strengthElement.parent().mousedown(function() {
                checkboxElement.prop('checked', true);
                checkboxElement.parent().addClass('active');
            });
            strengthElement.on('slideStop', function(event) {
                var
                    backgroundLayer = App().getImageDocument().getBackgroundLayer(),
                    opacityStrength = event.value.toInt();
                opacityStrength = 100 - opacityStrength;
                if (backgroundLayer.getFilter('opacity') === false) {
                    App().trackEvent('Filter', 'opacity', 'backgroundImage');
                }
                backgroundLayer.setFilter({
                    type: 'opacity',
                    properties: {
                        strength: opacityStrength
                    }
                });
            });
        },
        disable: function() {
            this._element.addClass('disabledState');
        },
        enable: function() {
            this._element.removeClass('disabledState');
        },
        reset: function() {
            this._element.find('div.filter > div.btn-group > label').removeClass('active');
            this._element.find('div.filter > input[type="checkbox"]').attr('checked', false);
        }
    });
var
    FormView = View.extend({
        _callback: null,
        _enabled: true,
        _prereq: null,
        init: function(element, callback, prereq, timeout) {
            this._super(element);
            this._callback = callback;
            this._prereq = prereq;
            if (window.App) {
                this._timeout = App().getTimeout('submittingForm');
            }
            if (typeof timeout !== 'undefined') {
                this._timeout = timeout;
            }
            this._addFormEvents();
            this._element.find('select').selectpicker();
            this._element.find('[placeholder]').placeholder();
        },
        _addFormEvents: function() {
            var
                _this = this;
            this._element.find('input').keypress(function(event) {
                if (event.which === 13) {
                    event.preventDefault();
                    _this._submit();
                }
            });
            this._element.find('*[data-submit="true"]').click(function(event) {
                event.preventDefault();
                _this._submit();
            });
            this._element.submit(function(event) {
                event.preventDefault();
                _this._submit();
            });
        },
        _submit: function() {
            if (this._enabled === true) {
                this.disable();
                var
                    _this = this,
                    callback = function() {
                        _this.clearSuccess();
                        _this.clearErrors();
                        var
                            method = _this._element.attr('method');
                        jQuery[method](_this._element.attr('action'), _this._element.serializeObject(), jQuery.proxy(_this._submitCallback, _this), 'json').fail(function() {
                            App().showErrorModal('Please try again', 'vn7A');
                        });
                    };
                if (typeof this._prereq !== 'undefined') {
                    this._prereq(callback);
                } else {
                    callback();
                }
            }
        },
        _handleError: function(error) {
            if (error.reference) {
                App().trackEvent('Form', 'error', error.reference.toInt());
                App().mpTrackEvent('Form error', {
                    _error: error.reference.toInt()
                });
            }
            var
                input = error.input;
            if (typeof error.input === 'string') {
                input = this._element.find('input[name="' + (error.input) + '"]');
            }
            input.addClass('error');
            var
                calloutElement = this._element.find('.callout.errors');
            calloutElement.find('p').html(error.message);
            calloutElement.removeClass('hidden');
            input.focus();
        },
        _submitCallback: function(response) {
            var
                _this = this;
            setTimeout(function() {
                if (response.success === false) {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        var
                            error = response.failedRules[0].error;
                        _this.enable();
                        if (error.input) {
                            _this._handleError(error);
                        } else {
                            if (typeof error.message === 'undefined') {
                                App().showErrorModal(false, error.reference);
                            } else {
                                _this._handleError({
                                    message: error.message,
                                    input: _this._element.find('input[type="text"],input[type="password"]').first()
                                });
                            }
                        }
                    }
                } else {
                    _this._callback(response);
                }
            }, this._timeout);
        },
        clearErrors: function() {
            this._element.find('input.error').removeClass('error');
            this._element.find('div.callout.errors').addClass('hidden');
        },
        clearSuccess: function() {
            this._element.find('div.callout.success').addClass('hidden');
        },
        disable: function() {
            this._element.addClass('loading');
            this._enabled = false;
            var
                selector = 'input[type="password"], ' + 'input[type="email"], ' + 'select, ' + 'div.bootstrap-select button.btn, ' + 'input[type="text"]';
            this._element.find(selector).blur();
            this._element.find(selector).attr('readonly', true);
        },
        enable: function() {
            this._element.removeClass('loading');
            this._enabled = true;
            var
                selector = 'input[type="password"], ' + 'input[type="email"], ' + 'select, ' + 'div.bootstrap-select button.btn, ' + 'input[type="text"]';
            this._element.find(selector).attr('readonly', false);
        },
        isEnabled: function() {
            return this._enabled === true;
        }
    });
var
    CreditCardFormView = FormView.extend({
        _processingCallbacks: {
            start: function() {},
            end: function() {}
        },
        init: function(element, callback, processingCallbacks) {
            this._super(element, callback);
            if (processingCallbacks) {
                this._processingCallbacks = processingCallbacks;
            }
            this._addCreditCardNumberChangeEvent();
            this._element.find('#cardNumber').payment('formatCardNumber');
            this._element.find('input[data-stripe="cvc"]').payment('formatCardCVC');
        },
        _setFullName: function() {
            var
                concatenated = (this._element.find('[name="firstName"]').val()) + ' ' + (this._element.find('[name="lastName"]').val());
            this._element.find('[data-stripe="name"]').val(concatenated);
        },
        _addCreditCardNumberChangeEvent: function() {
            this._element.find('#cardNumber').keyup(function(event) {
                var
                    cardNumberElement = $(this),
                    cardNumber = cardNumberElement.val(),
                    cardType = Stripe.card.cardType(cardNumber);
                cardNumberElement.removeClass('visa');
                cardNumberElement.removeClass('mc');
                cardNumberElement.removeClass('amex');
                if (cardType === 'Visa') {
                    cardNumberElement.addClass('visa');
                } else
                if (cardType === 'MasterCard') {
                    cardNumberElement.addClass('mc');
                } else
                if (cardType === 'American Express') {
                    cardNumberElement.addClass('amex');
                }
            });
        },
        _submit: function() {
            if (this._enabled === true) {
                this.disable();
                this._setFullName();
                this.clearSuccess();
                this.clearErrors();
                var
                    cardNumberElement = this._element.find('input#cardNumber'),
                    cardNumber = cardNumberElement.val();
                if (this._supportedCreditCard(cardNumber) === false) {
                    this.enable();
                    this._handleError({
                        message: 'Please enter a Visa, Mastercard or American Express ' + 'credit card number',
                        input: cardNumberElement
                    });
                } else {
                    Stripe.createToken(this._element, jQuery.proxy(this._submitCallback, this));
                }
            }
        },
        _submitCallback: function(httpStatusCode, response) {
            var
                _this = this;
            setTimeout(function() {
                if (httpStatusCode === 200) {
                    var
                        timeout = setTimeout(_this._processingCallbacks.start, App().getTimeout('ccProcessingStateDelay'));
                    var
                        postData = _this._element.serializeObject();
                    postData.stripeToken = response.id;
                    jQuery.post(_this._element.attr('action'), postData, function(response) {
                        clearTimeout(timeout);
                        _this._processingCallbacks.end();
                        if (response.success === false) {
                            if (App().siteHasBeenLocked(response)) {
                                App().showLockedModal();
                            } else {
                                var
                                    error = response.failedRules[0].error;
                                _this.enable();
                                if (error.input) {
                                    _this._handleError(error);
                                } else {
                                    if (typeof error.message === 'undefined') {
                                        App().showErrorModal('Your card was *not* charged.' + '<br />Please contact ' + 'hello@shareasimage.com', error.reference);
                                    } else {
                                        var
                                            optLabel = '{null}.';
                                        if (error.type) {
                                            optLabel = (error.type) + '.';
                                        }
                                        if (error.param) {
                                            optLabel += (error.param) + '.';
                                        } else {
                                            optLabel += '{null}.';
                                        }
                                        if (error.code) {
                                            optLabel += (error.code);
                                        } else {
                                            optLabel += '{null}';
                                        }
                                        App().trackEvent('CreditCardForm', 'error', (optLabel));
                                        App().mpTrackEvent('Credit card form submission error', {
                                            _error: (optLabel)
                                        });
                                        _this._handleError({
                                            message: error.message,
                                            input: _this._element.find('#cardNumber')
                                        });
                                    }
                                }
                            }
                        } else {
                            _this._callback(response);
                        }
                    }, 'json').fail(function() {
                        App().showErrorModal('Your card was *not* charged.<br />Please ' + 'contact hello@shareasimage.com', '687X');
                    });
                } else {
                    var
                        cardNumberElement = _this._element.find('input#cardNumber'),
                        cvcElement = _this._element.find('[data-stripe="cvc"]'),
                        monthElement = _this._element.find('[data-stripe="exp-month"]'),
                        yearElement = _this._element.find('[data-stripe="exp-year"]'),
                        error = response.error,
                        inputElement = cardNumberElement;
                    if (error.param === 'cvc') {
                        inputElement = cvcElement;
                    } else
                    if (error.param === 'exp_month') {
                        inputElement = monthElement.next().find('button').first();
                    } else
                    if (error.param === 'exp_year') {
                        inputElement = yearElement.next().find('button').first();
                    }
                    var
                        optLabel = '{null}.';
                    if (error.type) {
                        optLabel = (error.type) + '.';
                    }
                    if (error.param) {
                        optLabel += (error.param) + '.';
                    } else {
                        optLabel += '{null}.';
                    }
                    if (error.code) {
                        optLabel += (error.code);
                    } else {
                        optLabel += '{null}';
                    }
                    App().trackEvent('CreditCardForm', 'error', (optLabel));
                    App().mpTrackEvent('Credit card form submission error', {
                        _error: (optLabel)
                    });
                    _this._handleError({
                        message: response.error.message,
                        input: inputElement
                    });
                    _this.enable();
                }
            }, App().getTimeout('submittingForm'));
        },
        _supportedCreditCard: function(cardNumber) {
            var
                acceptable = ['Visa', 'MasterCard', 'American Express'],
                cardType = Stripe.card.cardType(cardNumber);
            if (jQuery.inArray(cardType, acceptable) === -1) {
                return false;
            }
            return true;
        }
    });
var
    ColorPickerView = View.extend({
        _popupHideCallback: null,
        _swatch: null,
        init: function(element, options) {
            this._super(element);
            this._options = options;
            this._drawSupportingMarkup();
            this._addEvents();
        },
        _drawSupportingMarkup: function() {
            this._swatch = $('<div class="swatch"></div>');
            var
                $backdrop = $('<div class="backdrop"></div>'),
                $inner = $('<div class="inner"></div>');
            $inner.css({
                backgroundColor: this._element.val()
            });
            this._swatch.append($backdrop);
            this._swatch.append($inner);
            this._swatch.insertAfter(this._element);
            this._element.addClass('hidden');
        },
        _addEvents: function() {
            var
                _this = this,
                currentHex = this._element.val();
            this._swatch.popover({
                html: true,
                container: this._options.container,
                animation: false,
                trigger: 'manual',
                placement: this._options.placement,
                content: '<input type="text" class="form-control" data-inline="true" value="' + (currentHex) + '" />'
            }).on('click', function(event) {
                $(this).popover('toggle');
            }).on('hidden.bs.popover', function(event) {
                var
                    $popover = _this._swatch.data('bs.popover').$tip;
                $popover.parent().find('.popover:not(.in)').hide().detach();
                _this._swatch.data('bs.popover').hoverState = 'out';
            }).on('shown.bs.popover', function(event) {
                var
                    $popover = _this._swatch.data('bs.popover').$tip,
                    $input = $popover.find('input[data-inline="true"]');
                $popover.addClass('colorPickerPopover');
                $input.minicolors({
                    inline: true
                });
                $input.minicolors('value', _this._element.val());
                var
                    $panel = $popover.find('.minicolors-panel');
                $input.insertAfter($panel);
                $input.on('input', function(event) {
                    var
                        hex = $(this).val();
                    if (!hex.match(/^\#/)) {
                        hex = '#' + (hex);
                    }
                    if (hex.length === 4) {
                        hex = '#' + (hex[1] + '' + hex[1]) + (hex[2] + '' + hex[2]) + (hex[3] + '' + hex[3]);
                    }
                    if (/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(hex)) {
                        _this._options.selected(hex);
                        _this._element.val(hex);
                        _this._swatch.find('.inner').css({
                            backgroundColor: hex
                        });
                    }
                });
            });
            this.addPopupHideCallback();
        },
        addPopupHideCallback: function() {
            var
                _this = this;
            this._popupHideCallback = function(event) {
                var
                    $target = $(event.target);
                if (($target[0] === _this._swatch[0]) === false && ($target[0] === _this._swatch.find('.inner')[0]) === false) {
                    if ($target.closest('.colorPickerPopover').length === 0) {
                        if (typeof _this._swatch.data('bs.popover') !== 'undefined') {
                            if (_this._swatch.data('bs.popover').hoverState === 'in') {
                                _this._swatch.popover('hide');
                            }
                        } else {
                            _this.removePopupHideCallback();
                        }
                    }
                }
            };
            App().getElement().click(this._popupHideCallback);
        },
        getSwatch: function() {
            return this._swatch;
        },
        removePopupHideCallback: function() {
            App().getElement().unbind('click', this._popupHideCallback);
        }
    });
var
    BackgroundTabView = View.extend({
        init: function(element) {
            this._super(element);
            this._addLazyLoadEvents();
            this._addCategoryChangeEvents();
            this._addResourceTabEvents();
            this._setupDropdown();
            this._setupPhotoEvents();
            this._setupSourceEvent();
            this.changeCategories(0);
            this.drawUploadsResourceTab();
            this._addLoginButtonEvent();
            this._addRegisterButtonEvent();
            this._addScrollOverflowEvent(this._element.find('.photos'));
        },
        _addCategoryChangeEvents: function() {
            var
                _this = this;
            this._element.find('select').change(function(event) {
                _this.changeCategories($(this).val().toInt());
                App().getElement().find('#createImageBtn').first().focus();
                App().getElement().find('#createImageBtn').first().blur();
                App().trackEvent('BackgroundTab', 'categoryChange');
                App().mpTrackEvent('Background category changed');
            });
        },
        _addLazyLoadEvents: function() {
            this._element.find('.lazy').lazyload({
                container: this._element.find('.photos')
            });
        },
        _addLoginButtonEvent: function() {
            var
                _this = this;
            this._element.find('.loginBtn').click(function(event) {
                event.preventDefault();
                App().showConnectModal('login', 'register');
            });
        },
        _addRegisterButtonEvent: function() {
            var
                _this = this;
            this._element.find('.registerBtn').click(function(event) {
                event.preventDefault();
                App().showConnectModal('register', 'register');
            });
        },
        _addResourceTabEvents: function() {
            var
                _this = this;
            this._element.find('.resourceTabs a').click(function(event) {
                event.preventDefault();
                var
                    tab = $(this).attr('data-tab');
                _this._element.find('.resourceTabs a').removeClass('active');
                _this._element.find('.resourceTabContents > div').addClass('hidden');
                $(this).addClass('active');
                _this._element.find('.resourceTabContents > div[data-tab="' + (tab) + '"]').removeClass('hidden');
            });
        },
        _setupDropdown: function() {
            this._element.find('select').selectpicker({
                container: 'body'
            });
            var
                _this = this,
                element = this._element.find('*[name="categories"]').first(),
                options = element.find('option'),
                dropdownElement = element.next().find('.dropdown-menu');
            dropdownElement.addClass('categoryDropdown');
            options.each(function(optionIndex, optionElement) {
                optionElement = $(optionElement);
                var
                    count = optionElement.attr('data-count'),
                    relativeElement = dropdownElement.find('li[data-original-index="' + (optionIndex) + '"] .text'),
                    $sup = $('<span class="catCount">').html(count);
                relativeElement.prepend($sup);
            });
        },
        _setupPhotoEvents: function() {
            var
                _this = this;
            this._element.find('.photosResourceTabContent .photo a.preview').click(function(event) {
                event.preventDefault();
                var
                    hasPhotoPermissions = App().userIsPro() == true || $(this).parent().attr('data-image-isfree') === 'true' || Sai.get('publisher') !== false;
                var
                    photoSwitchCallback = function(anchor) {
                        App().addToCallStack();
                        App().usingReservedPhoto(!hasPhotoPermissions);
                        App().usingReservedTemplate(false);
                        var
                            sourceSrc = $(anchor).parent().attr('data-image-cloudinaryurl');
                        App().drawCloudinaryImageAsBackgroundLayer(sourceSrc, function() {}, 'lfill', false);
                    };
                var
                    anchor = this;
                if (App().getImageDocument().getBackgroundLayer().containsManuallyUploadedBackgroundImage() === true) {
                    App().showConfirmModal('backgroundImageChange', function(event) {
                        event.preventDefault();
                        App().closeConfirmModal();
                        photoSwitchCallback(anchor);
                    }, function(event) {
                        event.preventDefault();
                        App().closeConfirmModal();
                    });
                } else {
                    photoSwitchCallback(anchor);
                }
            });
        },
        _setupSourceEvent: function() {
            var
                showFilepicker = Sai.get('config').defaults.showFilepicker;
            if (showFilepicker === false) {
                this._element.find('a.uploadBtn').popover({
                    placement: 'bottom',
                    content: 'Currently disabled due to a technical issue. We\'re actively working to resolve the issue. Thanks for your patience!',
                    trigger: 'hover'
                });
            }
            this._element.find('a.uploadBtn').click(function(event) {
                event.preventDefault();
                var
                    isNewTabInChrome = Sai.get('config').referer !== false && Sai.get('config').referer.indexOf('_/chrome/newtab') !== -1;
                if (isNewTabInChrome) {
                    App().showAlertModal('filepickerUnavailable');
                } else {
                    if (showFilepicker === true) {
                        App().trackEvent('BackgroundImage', 'clicked', 'backgroundTab');
                        App().mpTrackEvent('Filepicker shown', {
                            _source: 'Background tab'
                        });
                        App().showFilepicker(function(sourceSrc, InkBlob) {
                            App().trackEvent('BackgroundImage', 'picked', 'backgroundTab');
                            App().mpTrackEvent('Background image uploaded', {
                                _source: 'Background tab'
                            });
                            App().resetSize();
                            App().usingReservedPhoto(false);
                            App().usingReservedTemplate(false);
                            App().drawFPImageAsBackgroundLayer(sourceSrc, 'max', function() {
                                App().getImageDocument().getBackgroundLayer().setProperty('wasManuallyUploaded', true);
                            });
                            if (App().userIsLoggedIn() === true) {
                                App().trackUpload(sourceSrc, function(uploadObj) {
                                    var
                                        uploads = Sai.get('uploads');
                                    uploads.unshift(uploadObj);
                                    Sai.set('uploads', uploads);
                                    App().getBackgroundTab().drawUploadsResourceTab();
                                });
                            }
                        }, false);
                    }
                }
            });
        },
        changeCategories: function(categoryId) {
            this._element.find('.photosResourceTabContent .photo').removeClass('hidden');
            this._element.find('.proPhotosSection .photoList').prepend(this._element.find('.freePhotosSection .photoList .photo'));
            this._element.find('.proPhotosSection .photoList .photo').attr('data-image-isfree', 'false');
            var
                $firstFourProPhotos = this._element.find('.photosResourceTabContent .photo').slice(0, 4);
            if (categoryId !== 0) {
                var
                    $all = this._element.find('.photosResourceTabContent .photo[data-categories~="' + (categoryId) + '"]');
                this._element.find('.photosResourceTabContent .photo').addClass('hidden');
                $all.removeClass('hidden');
                this._element.find('.photosResourceTabContent .photos').trigger('scroll');
                $firstFourProPhotos = $all.slice(0, 4);
            }
            var
                authd = App().userIsPro() == true || Sai.get('publisher') !== false;
            if (!authd) {
                this._element.find('.freePhotosSection .photoList').prepend($firstFourProPhotos);
                $firstFourProPhotos.attr('data-image-isfree', 'true');
            }
            this._element.find('.photosResourceTabContent .photos').animate({
                scrollTop: 0
            }, 'slow');
        },
        drawUploadsResourceTab: function() {
            this._element.find('.uploadsResourceTabContent .photoList .photo').remove();
            var
                uploads = Sai.get('uploads'),
                $uploads = [],
                $div, $anchor, $delete, _this = this,
                path;
            this._element.find('.connectPrompt').addClass('hidden');
            this._element.find('.uploadPrompt').addClass('hidden');
            if (App().userIsLoggedIn() === false) {
                this._element.find('.connectPrompt').removeClass('hidden');
            } else {
                if (uploads.length === 0) {
                    this._element.find('.uploadPrompt').removeClass('hidden');
                }
            }
            $(uploads).each(function(index, upload) {
                if (upload.url.match('cloudinary') === null) {
                    path = App().getFilepickerUrl(upload.url, {
                        width: 56,
                        height: 44
                    });
                } else {
                    path = App().getCloudinaryUrl(upload.url, {
                        width: 56,
                        height: 44,
                        fit: 'lfill'
                    }, true);
                }
                $div = $('<div>');
                $div.attr('class', 'photo pull-left');
                $div.attr('data-image-url', upload.url);
                $anchor = $('<a>');
                $anchor.attr('href', '#');
                $anchor.attr('class', 'preview');
                $anchor.append('<div class="overlay"></div>');
                $anchor.append('<div class="icon"><div class="icon-plus"></div></div>');
                $anchor.append('<img class="lazy" src="' + (path) + '" alt="" title="" width="65" height="52" />');
                $delete = $('<a>');
                $delete.attr('href', '#');
                $delete.attr('data-uploadId', upload.id);
                $delete.attr('class', 'remove');
                $delete.html('x');
                $div.append($anchor);
                $div.append($delete);
                $uploads.push($div);
                $anchor.click(function(event) {
                    event.preventDefault();
                    App().addToCallStack();
                    App().resetSize();
                    var
                        sourceSrc = $(this).parent().attr('data-image-url');
                    if (upload.url.match('cloudinary') === null) {
                        App().drawFPImageAsBackgroundLayer(sourceSrc, 'max', function() {});
                    } else {
                        App().drawCloudinaryImageAsBackgroundLayer(sourceSrc, function() {}, 'lfill', false);
                    }
                });
                $delete.click(function(event) {
                    event.preventDefault();
                    if (confirm('Are you sure you want to delete this upload?') === true) {
                        var
                            data = {
                                csrfToken: Sai.get('csrfToken')
                            };
                        jQuery.post('/uploads/' + $(this).attr('data-uploadId') + '/delete', data, function(response) {
                            if (response.success === true) {
                                Sai.set('uploads', response.data.uploads);
                                _this.drawUploadsResourceTab();
                            } else {
                                if (App().siteHasBeenLocked(response)) {
                                    App().showLockedModal();
                                } else {
                                    App().showErrorModal(false, response.failedRules[0].error.reference);
                                }
                            }
                        }, 'json').fail(function() {
                            App().showErrorModal(false, 'a3uj');
                        });
                    }
                });
            });
            this._element.find('.uploadsResourceTabContent .photoList').append($uploads);
        },
        refreshCategory: function() {
            var
                categoryId = this._element.find('select').val().toInt();
            this.changeCategories(categoryId);
            this._element.find('.photosResourceTabContent .photos').addClass('authd');
            this._element.find('.uploadsResourceTabContent .photos').addClass('authd');
            this._element.find('.photosResourceTabContent .photos').trigger('scroll');
        }
    });
var
    TemplatesTabView = View.extend({
        init: function(element) {
            this._super(element);
            this._addResourceTabEvents();
            this._setupTemplateEvents();
            this.drawUserResourceTab();
            this._addLoginButtonEvent();
            this._addRegisterButtonEvent();
            this._addScrollOverflowEvent(this._element.find('.templates'));
        },
        _addLoginButtonEvent: function() {
            var
                _this = this;
            this._element.find('.loginBtn').click(function(event) {
                event.preventDefault();
                App().showConnectModal('login', 'register');
            });
        },
        _addRegisterButtonEvent: function() {
            var
                _this = this;
            this._element.find('.registerBtn').click(function(event) {
                event.preventDefault();
                App().showConnectModal('register', 'register');
            });
        },
        _addResourceTabEvents: function() {
            var
                _this = this;
            this._element.find('.resourceTabs a').click(function(event) {
                event.preventDefault();
                var
                    tab = $(this).attr('data-tab');
                _this._element.find('.resourceTabs a').removeClass('active');
                _this._element.find('.resourceTabContents > div').addClass('hidden');
                $(this).addClass('active');
                _this._element.find('.resourceTabContents > div[data-tab="' + (tab) + '"]').removeClass('hidden');
            });
        },
        _setupTemplateEvents: function() {
            var
                _this = this;
            this._element.find('.globalResourceTabContent .template a.preview').click(function(event) {
                event.preventDefault();
                var
                    hasTemplatePermissions = App().userIsPro() == true || $(this).parent().attr('data-image-isfree') === 'true' || Sai.get('publisher') !== false;
                var
                    templateSwitchCallback = function(anchor) {
                        App().addToCallStack();
                        App().usingReservedTemplate(!hasTemplatePermissions);
                        App().resetSize();
                        var
                            templates = Sai.get('templates'),
                            imageId = $(anchor).attr('data-imageId').toInt(),
                            imageObj;
                        $(templates).each(function(index, templateObj) {
                            if (templateObj.id.toInt() === imageId) {
                                imageObj = templateObj;
                            }
                        });
                        App().remixImage(imageObj, 'loadingTemplate', function() {}, true);
                    };
                var
                    anchor = this;
                if (App().getImageDocument().getBackgroundLayer().containsManuallyUploadedBackgroundImage() === true) {
                    App().showConfirmModal('backgroundImageChange', function(event) {
                        event.preventDefault();
                        App().closeConfirmModal();
                        templateSwitchCallback(anchor);
                    }, function(event) {
                        event.preventDefault();
                        App().closeConfirmModal();
                    });
                } else {
                    templateSwitchCallback(anchor);
                }
            });
        },
        drawUserResourceTab: function() {
            this._element.find('.userResourceTabContent .templateList .template').remove();
            var
                userTemplates = Sai.get('userTemplates'),
                $userTemplates = [],
                $div, $anchor, $delete, _this = this,
                path;
            this._element.find('.emptyState').addClass('hidden');
            this._element.find('.connectPrompt').addClass('hidden');
            if (App().userIsLoggedIn() === false) {
                this._element.find('.connectPrompt').removeClass('hidden');
            } else {
                if (userTemplates.length === 0) {
                    this._element.find('.emptyState').removeClass('hidden');
                }
            }
            $(userTemplates).each(function(index, image) {
                $div = $('<div>');
                $div.attr('class', 'template pull-left');
                $anchor = $('<a>');
                $anchor.attr('href', '#');
                $anchor.attr('class', 'preview');
                $anchor.attr('data-imageId', image.id);
                $anchor.append('<div class="overlay"></div>');
                $anchor.append('<div class="icon"><div class="icon-plus"></div></div>');
                $anchor.append('<div class="actual" style="background-image: url(\'' + (image.cloudfrontUrl) + '\');"></div>');
                $delete = $('<a>');
                $delete.attr('href', '#');
                $delete.attr('class', 'remove');
                $delete.attr('data-imageId', image.id);
                $delete.html('x');
                $div.append($anchor);
                $div.append($delete);
                $userTemplates.push($div);
                $anchor.click(function(event) {
                    event.preventDefault();
                    App().addToCallStack();
                    var
                        templates = Sai.get('userTemplates'),
                        imageId = $(this).attr('data-imageId').toInt(),
                        imageObj;
                    $(templates).each(function(index, templateObj) {
                        if (templateObj.id.toInt() === imageId) {
                            imageObj = templateObj;
                        }
                    });
                    App().remixImage(imageObj, 'loadingTemplate', function() {
                        _this.showUserTemplatesTab();
                    }, true);
                });
                $delete.click(function(event) {
                    event.preventDefault();
                    if (confirm('Are you sure you want to delete this template?') === true) {
                        var
                            data = {
                                csrfToken: Sai.get('csrfToken'),
                                userTemplating: 1,
                                data: {
                                    isUserTemplate: 0
                                }
                            };
                        jQuery.post('/images/' + $(this).attr('data-imageId'), data, function(response) {
                            if (response.success === true) {
                                Sai.set('userTemplates', response.data.user.templates);
                                _this.drawUserResourceTab();
                            } else {
                                if (App().siteHasBeenLocked(response)) {
                                    App().showLockedModal();
                                } else {
                                    App().showErrorModal(false, response.failedRules[0].error.reference);
                                }
                            }
                        }, 'json').fail(function() {
                            App().showErrorModal(false, 'a3qj');
                        });
                    }
                });
            });
            this._element.find('.userResourceTabContent .templateList').append($userTemplates);
        },
        showUserTemplatesTab: function() {
            this._element.find('.resourceTabs a').removeClass('active');
            this._element.find('.resourceTabContents > div').addClass('hidden');
            this._element.find('.resourceTabs a[data-tab="user"]').addClass('active');
            this._element.find('.resourceTabContents > div[data-tab="user"]').removeClass('hidden');
        }
    });
var
    FooterView = View.extend({
        init: function(element) {
            this._super(element);
            this._addMyAccountButtonEvent();
            this._addMyImagesButtonEvent();
            this._addReferralEvent();
            this._addLoginButtonEvent();
            this._addSignUpButtonEvent();
            this._addUpgradeButtonEvent();
            this._addPublisherBrandEvent();
        },
        _addLoginButtonEvent: function() {
            this._element.find('a.loginLink').click(function(event) {
                event.preventDefault();
                App().showConnectModal('login', 'register');
            });
        },
        _addReferralEvent: function() {
            this._element.find('div.referral a').click(function(event) {
                event.preventDefault();
                App().showReferralModal();
            });
        },
        _addSignUpButtonEvent: function() {
            this._element.find('a.registerLink').click(function(event) {
                event.preventDefault();
                App().showConnectModal('register', 'register');
            });
        },
        _addMyAccountButtonEvent: function() {
            this._element.find('a.myAccountLink').click(function(event) {
                event.preventDefault();
                if (Sai.get('loggedInUser') !== false) {
                    App().showAccountModal();
                } else {
                    App().showConnectModal('register', 'register');
                    App().setConnectCallback(function() {
                        App().showAccountModal();
                    });
                }
            });
        },
        _addMyImagesButtonEvent: function() {
            this._element.find('a.myImagesLink').click(function(event) {
                event.preventDefault();
                if (Sai.get('loggedInUser') !== false) {
                    App().showImagesModal();
                } else {
                    App().showConnectModal('register', 'register');
                    App().setConnectCallback(function() {
                        App().showImagesModal();
                    });
                }
            });
        },
        _addPublisherBrandEvent: function() {
            this._element.find('> div.publisher > a').click(function(event) {
                App().trackEvent('Referral', 'homepage', 'footer');
                App().mpTrackEvent('Footer sticker clicked', {
                    _source: 'publisher'
                });
            });
        },
        _addUpgradeButtonEvent: function() {
            var
                _this = this;
            this._element.find('a.proCta').click(function(event) {
                event.preventDefault();
                App().trackEvent('UpgradeModal', 'shown', 'footer');
                App().mpTrackEvent('Upgrade button clicked', {
                    _source: 'Footer'
                });
                App().showAppropriateUpgradeStep('upgrade');
            });
        },
        hide: function() {
            if (Sai.get('publisher') === false) {
                this._element.addClass('hiding');
            }
        },
        show: function() {
            this._element.removeClass('hiding');
        },
        update: function() {
            var
                config = Sai.get('config'),
                userObj = Sai.get('loggedInUser'),
                publisherObj = Sai.get('publisher');
            this._element.removeClass('freeUserState');
            this._element.removeClass('publisherState');
            this._element.removeClass('proUserState');
            if (publisherObj !== false) {
                this._element.addClass('publisherState');
            } else
            if (userObj !== false && userObj.isPro.toInt() === 1) {
                this._element.addClass('proUserState');
            } else {
                this._element.addClass('freeUserState');
            }
            this._element.removeClass('guestState');
            if (userObj === false) {
                this._element.addClass('guestState');
            }
            if (userObj !== false) {
                var
                    rate = (userObj.rate / 100);
                this._element.find('span.rate').text(rate);
                var
                    frequencyShorthand = 'mo';
                if (userObj.frequency === 'yearly') {
                    rate = (userObj.yearlyRate / 12 / 100);
                }
                this._element.find('span.rate').text(rate);
                this._element.find('span.frequencyShorthand').text(frequencyShorthand);
            }
            if (userObj !== false && userObj.isAdmin.toInt() === 1) {
                this._element.find('.accountType strong').text('Admin');
            }
        }
    });
var
    ModalView = View.extend({
        init: function(element) {
            this._super(element);
            this._addCloseEvents();
        },
        _addCloseEvents: function() {
            var
                _this = this;
            this._element.find('.closeModalSource').click(function(event) {
                event.preventDefault();
                _this.close();
            });
        },
        _addTooltips: function() {
            this._element.find('[data-toggle="tooltip"]').tooltip({
                container: this._element
            });
        },
        close: function() {
            this._element.remove();
            var
                openModals = App().getOpenModals(),
                _this = this;
            $(openModals).each(function(index, modalView) {
                if (modalView === _this) {
                    openModals.splice(index, 1);
                }
            });
            App().getFooter().show();
        }
    });
var
    SpecialModalView = ModalView.extend({
        init: function(element) {
            this._super(element);
        },
        close: function() {
            this._element.remove();
            var
                openModals = App().getOpenModals(),
                _this = this;
            $(openModals).each(function(index, modalView) {
                if (modalView === _this) {
                    openModals.splice(index, 1);
                }
            });
            if (App().getOpenModals().length === 0) {
                App().getFooter().show();
            }
        }
    });
var
    AccountModalView = ModalView.extend({
        _adminTabView: null,
        _currentTab: 'personal',
        _forms: {},
        _socialTabView: null,
        init: function(element) {
            this._super(element);
            this._addTabToggleEvents();
            this._setupForms();
            this._setupSocialTabView();
            this._addLogoutEvent();
            this._addReferralEvent();
            this._element.find('.billingHistoryButton').click(function(event) {
                event.preventDefault();
                var
                    handler = AccountDock.configure({
                        key: 'ad_acco_139681d65a312760',
                        customer: Sai.get('loggedInUser').stripeCustomerId
                    });
                handler.open({
                    container: 'window'
                });
            });
            var
                user = Sai.get('loggedInUser');
            if (user !== false && user.isAdmin.toInt() === 1) {
                this._currentTab = 'admin';
                this._element.find('ul.tabs li.admin').removeClass('hidden');
                this._adminTabView = (new AdminTabView(this._element.find('div.adminTab'))).showCurrentTab();
            }
            if (App().useSmartShare() === true) {
                this._element.find('ul.tabs li.social').removeClass('hidden');
            }
        },
        _addLogoutEvent: function() {
            var
                _this = this;
            this._element.find('a.logoutLink').click(function(event) {
                event.preventDefault();
                App().showBusyModal('loggingOut');
                setTimeout(function() {
                    jQuery.post('/users/logout', {
                        csrfToken: Sai.get('csrfToken')
                    }, function(response) {
                        if (response.success === true) {
                            location.reload();
                        }
                    }, 'json').fail(function() {
                        App().showErrorModal('Problems logging out', '74n2');
                    });
                }, App().getTimeout('loggingOut'));
            });
        },
        _addReferralEvent: function() {
            this._element.find('a.referralAnchor').click(function(event) {
                event.preventDefault();
                App().showReferralModal();
            });
        },
        _addTabToggleEvents: function() {
            var
                _this = this;
            this._element.find('ul.primaryTabs li a').click(function(event) {
                event.preventDefault();
                var
                    href = $(this).attr('href'),
                    tabName = href.replace('#', '');
                _this._currentTab = tabName;
                _this.showCurrentTab();
            });
        },
        _setupForms: function() {
            var
                _this = this;
            this._forms = {
                password: (new FormView(this._element.find('div.passwordTab form'), function(response) {
                    if (response.success === true) {
                        Sai.set('loggedInUser', response.data.user);
                        this._element.find('div.callout.errors').addClass('hidden');
                        this._element.find('div.callout.success').removeClass('hidden');
                        this._element.find('input[name="password"]').val('');
                        this._element.find('input[name="passwordConfirmation"]').val('');
                        this.enable();
                    }
                })),
                personal: (new FormView(this._element.find('div.personalTab form'), function(response) {
                    if (response.success === true) {
                        Sai.set('loggedInUser', response.data.user);
                        App().updateUserMpPeopleData();
                        this._element.find('div.callout.errors').addClass('hidden');
                        this._element.find('div.callout.success').removeClass('hidden');
                        this.enable();
                    }
                })),
                payment: (new CreditCardFormView(this._element.find('div.paymentTab form'), function(response) {
                    if (response.success === true) {
                        this._element.find('input#cardNumber').val('');
                        this._element.find('input[data-stripe="cvc"]').val('');
                        Sai.set('loggedInUser', response.data.user);
                        this._element.find('div.callout.errors').addClass('hidden');
                        this._element.find('div.callout.success').removeClass('hidden');
                        this.enable();
                    }
                }))
            };
            this._element.find('.switch').bootstrapSwitch();
        },
        _setupSocialTabView: function() {
            this._socialTabView = (new AccountSocialTabView(this._element.find('.socialTab')));
        },
        showAdminTab: function() {
            this._currentTab = 'admin';
            this._element.find('ul.primaryTabs li.active').removeClass('active');
            this._element.find('ul.primaryTabs li.admin').addClass('active');
            this._element.find('div.primaryTabContent > div').addClass('hidden');
            this._element.find('div.primaryTabContent > div.adminTab').removeClass('hidden');
        },
        showCurrentTab: function() {
            var
                capitalized = this._currentTab.charAt(0).toUpperCase() + this._currentTab.slice(1),
                functionName = 'show' + (capitalized) + 'Tab';
            this[functionName]();
        },
        showEmbedTab: function() {
            this._currentTab = 'embed';
            this._element.find('ul.primaryTabs li.active').removeClass('active');
            this._element.find('ul.primaryTabs li.embed').addClass('active');
            this._element.find('div.primaryTabContent > div').addClass('hidden');
            this._element.find('div.primaryTabContent > div.embedTab').removeClass('hidden');
            App().trackView('/app/account/embed');
            App().mpTrackEvent('Embed tab shown');
        },
        showPasswordTab: function() {
            this._currentTab = 'password';
            this._element.find('ul.primaryTabs li.active').removeClass('active');
            this._element.find('ul.primaryTabs li.password').addClass('active');
            this._element.find('div.primaryTabContent > div').addClass('hidden');
            this._element.find('div.primaryTabContent > div.passwordTab').removeClass('hidden');
            this._forms.password._element.find('input[type!="hidden"]').first().nonIeFocus();
            this._forms.password.clearSuccess();
            App().trackView('/app/account/password');
            App().mpTrackEvent('Password tab shown');
        },
        showPersonalTab: function() {
            this._currentTab = 'personal';
            this._element.find('ul.primaryTabs li.active').removeClass('active');
            this._element.find('ul.primaryTabs li.personal').addClass('active');
            this._element.find('div.primaryTabContent > div').addClass('hidden');
            this._element.find('div.primaryTabContent > div.personalTab').removeClass('hidden');
            this._forms.personal._element.find('input[type!="hidden"]').first().nonIeFocus();
            this._forms.personal.clearSuccess();
            App().trackView('/app/account/personal');
            App().mpTrackEvent('Personal tab shown');
        },
        showPaymentTab: function() {
            this._currentTab = 'payment';
            this._element.find('ul.primaryTabs li.active').removeClass('active');
            this._element.find('ul.primaryTabs li.payment').addClass('active');
            this._element.find('div.primaryTabContent > div').addClass('hidden');
            this._element.find('div.primaryTabContent > div.paymentTab').removeClass('hidden');
            this._forms.payment._element.find('input[type!="hidden"]').first().nonIeFocus();
            App().trackView('/app/account/payment');
            App().mpTrackEvent('Payment tab shown');
        },
        showSocialTab: function() {
            this._currentTab = 'social';
            this._element.find('ul.primaryTabs li.active').removeClass('active');
            this._element.find('ul.primaryTabs li.social').addClass('active');
            this._element.find('div.primaryTabContent > div').addClass('hidden');
            this._element.find('div.primaryTabContent > div.socialTab').removeClass('hidden');
            App().trackView('/app/account/social');
            App().mpTrackEvent('Social tab shown');
        },
        showTab: function(tabName) {
            var
                capitalized = tabName.charAt(0).toUpperCase() + tabName.slice(1),
                functionName = 'show' + (capitalized) + 'Tab';
            this[functionName]();
        }
    });
var
    AccountSocialTabView = View.extend({
        init: function(element) {
            this._super(element);
            this._addFacebookConnectEvents();
            this._addFacebookDisconnectEvent();
            this._addTwitterConnectEvents();
            this._addTwitterDisconnectEvent();
        },
        _addFacebookConnectEvents: function() {
            var
                _this = this;
            this._element.find('div.network.facebook a.cta.facebook').click(function(event) {
                event.preventDefault();
                if (Sai.get('config').defaults.facebookActive === false) {
                    App().showAlertModal('facebookInactive');
                } else {
                    var
                        permissions = App().getRequiredFacebookPermissions();
                    FB.login(jQuery.proxy(_this._facebookConnectCallback, _this), {
                        scope: permissions.join(','),
                        enable_profile_selector: true
                    });
                }
            });
        },
        _addFacebookDisconnectEvent: function() {
            var
                _this = this;
            this._element.find('div.network.facebook a.disconnect').click(function(event) {
                event.preventDefault();
                _this._removeTooltips();
                App().showBusyModal('disconnectingConnection');
                var
                    $connection = $(this).closest('.connection'),
                    connectionId = $connection.attr('data-connectionid'),
                    path = '/connections/' + (connectionId) + '/disconnect';
                jQuery.post(path, {
                    csrfToken: Sai.get('csrfToken')
                }, function(response) {
                    Sai.set('loggedInUser', response.data.user);
                    setTimeout(function() {
                        App().closeOpenModals();
                        App().showAccountModal('social');
                    }, App().getTimeout('disconnectingConnection'));
                }, 'json');
            });
        },
        _addTwitterConnectEvents: function() {
            var
                _this = this;
            window.twitterConnectCallback = function(response) {
                _this._twitterConnectCallback(response);
            };
            this._element.find('div.network.twitter a.cta.twitter').click(function(event) {
                event.preventDefault();
                if (Sai.get('config').defaults.twitterActive === false) {
                    App().showAlertModal('twitterInactive');
                } else {
                    window.open('/twitter/redirect', 'Twitter Connect', 'width=640, height=420');
                }
            });
        },
        _addTwitterDisconnectEvent: function() {
            var
                _this = this;
            this._element.find('div.network.twitter a.disconnect').click(function(event) {
                event.preventDefault();
                _this._removeTooltips();
                App().showBusyModal('disconnectingConnection');
                var
                    $connection = $(this).closest('.connection'),
                    connectionId = $connection.attr('data-connectionid'),
                    path = '/connections/' + (connectionId) + '/disconnect';
                jQuery.post(path, {
                    csrfToken: Sai.get('csrfToken')
                }, function(response) {
                    Sai.set('loggedInUser', response.data.user);
                    setTimeout(function() {
                        App().closeOpenModals();
                        App().showAccountModal('social');
                    }, App().getTimeout('disconnectingConnection'));
                }, 'json');
            });
        },
        _facebookConnectCallback: function(response) {
            var
                _this = this;
            if (response.authResponse !== null) {
                FB.api('/v2.2/me/permissions', function(permissionsObj) {
                    if (App().publishPermissionGiven(permissionsObj) === false) {
                        App().showFacebookErrorModal('connecting', 'permissions');
                        var
                            $modal = App().getOpenModals().pop().getElement();
                        $modal.addClass('reconnect');
                        $modal.find('.reconnectBtn').click(function(event) {
                            event.preventDefault();
                            _this._element.find('div.network.facebook a.cta.facebook').trigger('click');
                        });
                    } else {
                        App().showBusyModal('facebookConnection');
                        jQuery.post('/facebook/connect', {
                            csrfToken: Sai.get('csrfToken')
                        }, function(response) {
                            if (response.success === true) {
                                Sai.set('loggedInUser', response.data.user);
                                setTimeout(function() {
                                    App().closeOpenModals();
                                    App().showAccountModal('social');
                                    if (response.data.connections.length > 0) {
                                        App().showFacebookConnectionsModal(response.data.connections);
                                    }
                                }, App().getTimeout('socialConnection'));
                            }
                        }, 'json');
                    }
                });
            }
        },
        _twitterConnectCallback: function(response) {
            App().showBusyModal('twitterConnection');
            Sai.set('loggedInUser', response.data.user);
            setTimeout(function() {
                App().closeOpenModals();
                App().showAccountModal('social');
            }, App().getTimeout('socialConnection'));
        }
    });
var
    AlertModalView = SpecialModalView.extend({
        _alert: null,
        _callback: null,
        init: function(element, alert, callback) {
            this._alert = alert;
            this._callback = callback;
            this._super(element);
            this._addButtonEvent();
        },
        _addButtonEvent: function() {
            var
                _this = this;
            this._element.find('.btn').click(function(event) {
                jQuery.proxy(_this._alert.button.callback, this)(event);
                _this._callback && _this._callback(_this);
            });
        }
    });
var
    BrowserUpgradeModalView = ModalView.extend({
        init: function(element) {
            this._super(element);
        }
    });
var
    BusyModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
        }
    });
var
    CategoryModalView = SpecialModalView.extend({
        _callback: null,
        init: function(element, callback) {
            this._super(element);
            this._callback = callback;
            this._setupForm();
            this._element.find('input[type="text"]').first().focus();
        },
        _setupForm: function() {
            var
                _this = this;
            new
            FormView(this._element.find('form'), function(response) {
                if (response.success === true) {
                    _this._callback({});
                }
            });
        }
    });
var
    CC0ModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
            this._addButtonEvent();
        },
        _addButtonEvent: function() {
            var
                _this = this;
            this._element.find('.btn').click(function(event) {
                event.preventDefault();
                App().closeCC0Modal();
            });
        }
    });
var
    CookieNoticeModalView = ModalView.extend({
        init: function(element) {
            this._super(element);
            this._addReloadEvent();
        },
        _addReloadEvent: function() {
            this._element.find('.btn-primary').click(function(event) {
                event.preventDefault();
                location.reload();
            });
        }
    });
var
    ConfirmModalView = SpecialModalView.extend({
        _confirm: null,
        _yesCallback: null,
        _noCallback: null,
        init: function(element, confirm, yesCallback, noCallback) {
            this._confirm = confirm;
            this._yesCallback = yesCallback;
            this._noCallback = noCallback;
            this._super(element);
            this._addButtonEvents();
        },
        _addButtonEvents: function() {
            var
                _this = this;
            this._element.find('.buttons a[data-yes="1"]').click(function(event) {
                jQuery.proxy(_this._yesCallback, this)(event);
            });
            this._element.find('.buttons a[data-no="1"]').click(function(event) {
                jQuery.proxy(_this._noCallback, this)(event);
            });
        }
    });
var
    ConnectModalView = ModalView.extend({
        _forms: {},
        init: function(element) {
            this._super(element);
            this._setupConnectForms();
            this._setupTogglers();
        },
        _setupConnectForms: function() {
            var
                _this = this;
            this._forms = {
                login: (new FormView(this._element.find('div#loginWrapper form'), function(response) {
                    App().logUserIn(response.data.user, response.data.uploads, function() {
                        App().updateUserMpPeopleData();
                        App().mpIdentify(response.data.user.id.toInt());
                        App().mpTrackEvent('User logged in');
                        App().closeOpenModals();
                        App().getFooter().show();
                        App().getConnectCallback()();
                    });
                })),
                register: (new FormView(this._element.find('div#registerWrapper form'), function(response) {
                    var
                        prompt = 'create';
                    if (_this._element.hasClass('upgradeState') === true) {
                        prompt = 'upgrade';
                    } else
                    if (_this._element.hasClass('checkoutState') === true) {
                        prompt = 'checkout';
                    } else
                    if (_this._element.hasClass('registerState') === true) {
                        prompt = 'register';
                    } else
                    if (_this._element.hasClass('testimonialsState') === true) {
                        prompt = 'testimonials';
                    }
                    App().trackEvent('User', 'created', prompt);
                    App().registerUser(response.data.user);
                    App().logUserIn(response.data.user, response.data.uploads, function() {
                        App().updateUserMpPeopleData();
                        App().mpAlias(response.data.user.id.toInt());
                        App().mpIdentify(response.data.user.id.toInt());
                        App().mpTrackEvent('User registered', {
                            _prompt: prompt
                        });
                        App().closeOpenModals();
                        App().getFooter().show();
                        App().getConnectCallback()();
                    });
                })),
                resetPassword: (new FormView(this._element.find('div#resetPasswordWrapper form'), function(response) {
                    var
                        emailElement = this._element.find('input[name="email"]');
                    _this.showLoginForm();
                    _this._forms.login._element.find('div.success').removeClass('hidden');
                    _this._element.find('div#loginWrapper input[name="email"]').val(emailElement.val());
                    _this._element.find('div#loginWrapper input[name="password"]').val('');
                    _this._element.find('div#loginWrapper input[name="password"]').nonIeFocus();
                    _this._forms.login.clearErrors();
                    _this._forms.resetPassword.clearErrors();
                }))
            }
        },
        _setupTogglers: function() {
            var
                _this = this;
            this._element.on('click', 'a.showLoginFormBtn', function(event) {
                event.preventDefault();
                _this.showLoginForm();
            });
            this._element.find('a.showRegisterFormBtn').click(function(event) {
                event.preventDefault();
                _this.showRegisterForm();
            });
            this._element.find('a.showResetPasswordFormBtn').click(function(event) {
                event.preventDefault();
                _this.showResetPasswordForm();
            });
        },
        showCreateState: function() {
            this._element.addClass('createState');
            this._element.removeClass('testimonialsState');
            this._element.removeClass('registerState');
            this._element.removeClass('checkoutState');
            this._element.removeClass('upgradeState');
        },
        showRegisterState: function() {
            this._element.addClass('registerState');
            this._element.removeClass('testimonialsState');
            this._element.removeClass('createState');
            this._element.removeClass('checkoutState');
            this._element.removeClass('upgradeState');
        },
        showTestimonialsState: function() {
            this._element.addClass('testimonialsState');
            this._element.removeClass('registerState');
            this._element.removeClass('createState');
            this._element.removeClass('checkoutState');
            this._element.removeClass('upgradeState');
        },
        showLoginForm: function() {
            this._element.addClass('loginView');
            this._element.removeClass('registerView');
            this._element.removeClass('resetPasswordView');
            this._forms.login._element.find('input[type!="hidden"][value=""]').first().nonIeFocus();
            var
                state = 'upgrade';
            if (this._element.hasClass('checkoutState') === true) {
                state = 'checkout';
            } else
            if (this._element.hasClass('createState') === true) {
                state = 'create';
            } else
            if (this._element.hasClass('registerState') === true) {
                state = 'register';
            } else
            if (this._element.hasClass('testimonialsState') === true) {
                state = 'testimonials';
            }
            App().trackView('/app/connect/login?state=' + (state));
            App().mpTrackEvent('Login form shown', {
                _state: state
            });
        },
        showRegisterForm: function() {
            this._element.removeClass('loginView');
            this._element.addClass('registerView');
            this._element.removeClass('resetPasswordView');
            this._forms.register._element.find('input[type!="hidden"]').first().nonIeFocus();
            var
                state = 'upgrade';
            if (this._element.hasClass('checkoutState') === true) {
                state = 'checkout';
            } else
            if (this._element.hasClass('createState') === true) {
                state = 'create';
            } else
            if (this._element.hasClass('registerState') === true) {
                state = 'register';
            } else
            if (this._element.hasClass('testimonialsState') === true) {
                state = 'testimonials';
            }
            App().trackView('/app/connect/register?state=' + (state));
            App().mpTrackEvent('Register form shown', {
                _state: state
            });
        },
        showResetPasswordForm: function() {
            this._element.removeClass('loginView');
            this._element.removeClass('registerView');
            this._element.addClass('resetPasswordView');
            this._forms.resetPassword._element.find('input[type!="hidden"]').first().nonIeFocus();
            var
                state = 'upgrade';
            if (this._element.hasClass('checkoutState') === true) {
                state = 'checkout';
            } else
            if (this._element.hasClass('createState') === true) {
                state = 'create';
            } else
            if (this._element.hasClass('registerState') === true) {
                state = 'register';
            } else
            if (this._element.hasClass('testimonialsState') === true) {
                state = 'testimonials';
            }
            App().trackView('/app/connect/resetPassword?state=' + (state));
            App().mpTrackEvent('Reset password form shown', {
                _state: state
            });
        },
        showUpgradeState: function() {
            this._element.addClass('upgradeState');
            this._element.removeClass('testimonialsState');
            this._element.removeClass('registerState');
            this._element.removeClass('checkoutState');
            this._element.removeClass('createState');
        },
        showCheckoutState: function() {
            this._element.addClass('checkoutState');
            this._element.removeClass('testimonialsState');
            this._element.removeClass('registerState');
            this._element.removeClass('upgradeState');
            this._element.removeClass('createState');
        }
    });
var
    CouponModalView = SpecialModalView.extend({
        _callback: null,
        init: function(element, callback) {
            this._super(element);
            this._callback = callback;
            this._setupForm();
            this._element.find('input[type="text"]').first().focus();
            var
                dateObj = (new Date());
            this._element.find('.dTWrapper').datetimepicker({
                icons: {
                    date: 'glyphicon glyphicon-calendar icon-calendar'
                }
            });
        },
        _setupForm: function() {
            var
                _this = this;
            new
            FormView(this._element.find('form'), function(response) {
                if (response.success === true) {
                    _this._callback({});
                }
            }, function(callback) {
                if (_this._element.find('input[name="redeemBy"]').val() !== '') {
                    _this._element.find('input[name="redeemBy"]').val(_this._element.find('.dTWrapper').first().data("DateTimePicker").getDate().utc().valueOf());
                }
                callback();
            });
        }
    });
var
    CouponCodeModalView = SpecialModalView.extend({
        _callback: null,
        init: function(element, callback) {
            this._super(element);
            this._callback = callback;
            this._setupForm();
            this._element.find('input[type="text"]').focus();
        },
        _setupForm: function() {
            var
                _this = this;
            (new FormView(this._element.find('form'), function(response) {
                if (response.success === true) {
                    _this._callback(response.data.coupon);
                }
            }));
        }
    });
var
    CouponCodeSuccessModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
        }
    });
var
    CustomUrlModalView = SpecialModalView.extend({
        _callback: null,
        init: function(element, callback) {
            this._super(element);
            this._callback = callback;
            this._addFormEvent();
            this._addCtaEvent();
        },
        _action: function() {
            this._callback(this._element.find('input.input-lg').val());
        },
        _addCtaEvent: function() {
            var
                _this = this;
            this._element.find('.btn').click(function(event) {
                event.preventDefault();
                _this._action();
            });
        },
        _addFormEvent: function() {
            var
                _this = this;
            this._element.find('form').submit(function(event) {
                event.preventDefault();
                _this._action();
            });
        }
    });
var
    ErrorModalView = ModalView.extend({
        init: function(element) {
            this._super(element);
            this._addReloadEvent();
        },
        _addReloadEvent: function() {
            this._element.find('.btn-primary').click(function(event) {
                event.preventDefault();
                location.reload();
            });
        }
    });
var
    FacebookConnectionsModalView = SpecialModalView.extend({
        _callback: null,
        init: function(element) {
            this._super(element);
        }
    });
var
    ImagesModalView = ModalView.extend({
        _images: [],
        _loadedPath: null,
        init: function(element) {
            this._super(element);
        },
        _addDeleteEvents: function() {
            var
                _this = this;
            this._element.find('.btn.deleteBtn').click(function(event) {
                event.preventDefault();
                if (App().userIsPro() == true) {
                    if (confirm('Are you sure you want to delete this image?') === true) {
                        App().trackEvent('Image', 'deleted', 'imagesModal');
                        App().mpTrackEvent('Image deleted', {
                            _source: 'Images modal'
                        });
                        _this._removeTooltips();
                        App().showBusyModal('loadingImages');
                        var
                            imageId = $(this).attr('data-image-id');
                        jQuery.post('/images/' + (imageId) + '/delete', {
                            csrfToken: Sai.get('csrfToken')
                        }, function(response) {
                            if (response.success === true) {
                                _this.load(_this._loadedPath);
                            } else {
                                if (App().siteHasBeenLocked(response)) {
                                    App().showLockedModal();
                                } else {
                                    App().showErrorModal(false, response.failedRules[0].error.reference);
                                }
                            }
                        }, 'json').fail(function() {
                            App().showErrorModal(false, 'a4n2');
                        });
                    }
                } else {
                    App().showUpsellModal('delete');
                }
            });
        },
        _addDownloadEvents: function() {
            var
                _this = this;
            this._element.find('.btn.downloadBtn').click(function(event) {
                event.preventDefault();
                if (App().userIsPro() == true) {
                    var
                        publicKey = $(this).attr('data-image-publickey');
                    App().trackEvent('Image', 'downloaded', 'imagesModal');
                    App().mpTrackEvent('Image downloaded', {
                        _source: 'Images modal'
                    });
                    var
                        path = '/i/' + (publicKey) + '/download';
                    if (App().userIsPro() === true) {
                        var
                            hasHighDef = $(this).attr('data-image-hashighdef');
                        if (hasHighDef === '1') {
                            path += '?hd';
                        }
                    }
                    location.href = path;
                } else {
                    App().showUpsellModal('download');
                }
            });
        },
        _addRemixEvents: function() {
            var
                _this = this;
            this._element.find('.btn.remixBtn').click(function(event) {
                event.preventDefault();
                var
                    iteration = $(this).attr('data-iteration'),
                    imageObj = _this._images[iteration];
                App().trackEvent('Image', 'remixed', 'imagesModal');
                App().mpTrackEvent('Image remixed', {
                    _source: 'Images modal'
                });
                App().remixImage(imageObj, 'loadingRemix');
                _this._removeTooltips();
            });
        },
        _addViewEvents: function() {
            this._element.find('.btn.viewBtn').click(function(event) {
                event.preventDefault();
                var
                    url = $(this).attr('data-image-url');
                App().trackEvent('Image', 'viewed', 'imagesModal');
                App().mpTrackEvent('Image viewed', {
                    _source: 'Images modal'
                });
                window.open(url);
            });
        },
        _addPaginationEvents: function() {
            var
                _this = this;
            this._element.find('.pagination a').click(function(event) {
                event.preventDefault();
                if (App().userIsPro() == false) {
                    App().showUpsellModal('pagination');
                } else {
                    var
                        href = $(this).attr('href');
                    if (href !== '#') {
                        _this.load(href);
                    }
                }
            });
        },
        load: function(path) {
            this._loadedPath = path;
            App().showBusyModal('loadingImages');
            this._removeTooltips();
            var
                _this = this;
            jQuery.get(path, {}, function(response) {
                _this._element.find('.content').empty();
                if (response.success === true) {
                    var
                        html = _.template(App().getTemplate('images'), {
                            user: Sai.get('loggedInUser'),
                            total: response.data.total,
                            images: response.data.images,
                            pagination: response.data.pagination
                        }),
                        elements = $(jQuery.parseHTML(html.trim()));
                    (new View(elements));
                    _this._images = response.data.images;
                    _this._element.find('.content').append(elements);
                    _this._addViewEvents();
                    _this._addRemixEvents();
                    _this._addDownloadEvents();
                    _this._addDeleteEvents();
                    _this._addPaginationEvents();
                    _this._addCloseEvents();
                    setTimeout(function() {
                        App().closeBusyModal();
                    }, App().getTimeout('loadingImages'));
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        App().showErrorModal(false, response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                App().showErrorModal(false, '7nna');
            });
        }
    });
var
    LockedModalView = ModalView.extend({
        init: function(element) {
            this._super(element);
        }
    });
var
    PendingModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
        }
    });
var
    PhotoEditModalView = SpecialModalView.extend({
        _callback: null,
        init: function(element, callback) {
            this._super(element);
            this._callback = callback;
            this._setupForm();
            this._element.find('textarea').first().select().focus();
        },
        _setupForm: function() {
            var
                _this = this;
            new
            FormView(this._element.find('form'), function(response) {
                if (response.success === true) {
                    _this._callback({});
                }
            }, function(callback) {
                callback();
            }, 0);
        }
    });
var
    PlansModalView = ModalView.extend({
        init: function(element) {
            this._super(element);
        }
    });
var
    ReferralModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
            this._addTwitterShareEvent();
            this._addFacebookShareEvent();
            this._addTextareaFocusEvents();
        },
        _addFacebookShareEvent: function() {
            var
                _this = this;
            this._element.find('.fb').click(function(event) {
                event.preventDefault();
                App().trackEvent('Referral', 'clicked', 'referralModal.facebook.clicked');
                App().mpTrackEvent('Facebook invite button clicked', {
                    _source: 'Referral modal'
                });
                FB.ui(_this._getFacebookShareObject(), function(response) {
                    if (typeof response !== 'undefined') {
                        return;
                        if (response === null) {
                            App().trackEvent('Image', 'shared', 'shareModal.facebook.failed');
                            App().mpTrackEvent('Image facebook share failed', {
                                _source: 'Share modal'
                            });
                        } else {
                            App().trackEvent('Image', 'shared', 'shareModal.facebook.successful');
                            App().mpTrackEvent('Image facebook share successful', {
                                _source: 'Share modal'
                            });
                        }
                    }
                });
            });
        },
        _addTextareaFocusEvents: function() {
            var
                inputElement = this._element.find('input[type="text"]'),
                callback = function(event) {
                    inputElement.select();
                    inputElement.mouseup(function() {
                        inputElement.unbind('mouseup');
                        return false;
                    });
                };
            this._element.find('input[type="text"]').focus(callback);
        },
        _addTwitterShareEvent: function() {
            var
                _this = this;
            this._element.find('.twitter').click(function(event) {
                event.preventDefault();
                App().trackEvent('Referral', 'clicked', 'referralModal.twitter.clicked');
                App().mpTrackEvent('Twitter invite button clicked', {
                    _source: 'Referral modal'
                });
                var
                    url = _this._getShareUrl(),
                    text = encodeURIComponent(_this._getSnippet());
                var
                    link = 'https://twitter.com/intent/tweet' + '?url=' + (url) + '&via=shareasimage' + '&text=' + (text);
                window.open(link, 'Twitter Share', 'width=640, height=420');
            });
        },
        _getFacebookShareObject: function() {
            return {
                method: 'feed',
                name: 'Save $20 on Share As Image PRO',
                description: 'Share As Image is the fastest way to double your ' + 'social engagement. Turn images or text into viral, ' + 'eye-catching micro-content that you can share in seconds. ' + 'Get $20 off!',
                link: this._getShareUrl(),
                picture: 'https://shareasimage.com/static/app/images/logos/' + 'square152x152.png',
                actions: [{
                    name: 'Save $20 now',
                    link: this._getShareUrl()
                }]
            };
        },
        _getShareUrl: function() {
            return this._element.find('input[type="text"]').val();
        },
        _getSnippet: function() {
            return 'Check out Share As Image, the easiest way to create amazing ' + 'graphics for #socialmedia:';
        }
    });
var
    ShareModalView = ModalView.extend({
        _imageObj: null,
        init: function(element, imageObj) {
            this._imageObj = imageObj;
            this._super(element);
            this._addPrintEvent();
            this._addFacebookShareEvent();
            this._addCreateNewEvent();
            this._addGooglePlusShareEvent();
            this._addPinterestShareEvent();
            this._addRedirectUrlEvents();
            this._addTwitterShareEvent();
            this._addViewImageEvents();
            this._addDownloadImageEvents();
        },
        _addPrintEvent: function() {
            var
                _this = this;
            this._element.find('div.print a.btn').click(function(event) {
                event.preventDefault();
                App().trackEvent('Image', 'printed', 'shareModal');
                App().mpTrackEvent('Print clicked', {
                    _source: 'Share modal'
                });
                var
                    callback = function() {
                        App().showAlertModal('hdPrint', function() {
                            var
                                hdDisplayUrl = _this._imageObj.displayUrl.replace(/\.net\//, '.net/hd.');
                            var
                                printUrl = 'http://store.canvaspop.com/api/pull' + '?image_url=' + (hdDisplayUrl) + '&access_key=217af58bfcb7efcb5b870c4e44402772';
                            window.open(printUrl);
                        });
                    };
                if (_this._imageObj.hasHighDef.toInt() === 1) {
                    var
                        hdDisplayUrl = _this._imageObj.displayUrl.replace(/\.net\//, '.net/hd.');
                    var
                        printUrl = 'http://store.canvaspop.com/api/pull' + '?image_url=' + (hdDisplayUrl) + '&access_key=217af58bfcb7efcb5b870c4e44402772';
                    window.open(printUrl);
                } else {
                    App().showPendingModal('hdImagePrint');
                    App().getImageDocument().getWatermarkLayer().hide(false);
                    var
                        ghost = (new Ghost(function(imageString) {
                            jQuery.post('/images/' + (_this._imageObj.id) + '/hd', {
                                csrfToken: Sai.get('csrfToken'),
                                imageString: imageString
                            }, function(response) {
                                App().getImageDocument().getWatermarkLayer().show(false);
                                if (response.success === true) {
                                    _this._imageObj = response.data.image;
                                    setTimeout(function() {
                                        App().closePendingModal();
                                        callback();
                                    }, 1000);
                                } else {
                                    if (App().siteHasBeenLocked(response)) {
                                        App().showLockedModal();
                                    } else {
                                        App().showErrorModal(false, response.failedRules[0].error.reference);
                                    }
                                }
                            }, 'json').fail(function() {
                                App().showErrorModal(false, 'mak3');
                            });
                        }));
                }
            });
        },
        _addCreateNewEvent: function() {
            var
                _this = this;
            this._element.find('a.createNewAnchor').click(function(event) {
                event.preventDefault();
                App().trackEvent('Image', 'cleared', 'shareModal');
                App().mpTrackEvent('Canvas cleared', {
                    _source: 'Share modal'
                });
                App().loadEmptyCanvas();
            });
        },
        _addEmailEvent: function() {
            var
                _this = this;
            this._element.find('div.social a.email').click(function(event) {
                event.preventDefault();
                var
                    subject = 'Check out this image I made',
                    body = _.template(App().getTemplate('emails', 'share'), {
                        image: _this._imageObj
                    }).trim();
                subject = encodeURIComponent(subject);
                body = encodeURIComponent(body);
                var
                    link = 'mailto:?subject=' + (subject) + '&body=' + (body);
                window.open(link);
                App().trackEvent('Image', 'shared', 'shareModal');
                App().mpTrackEvent('Email share link clicked', {
                    _source: 'Share modal'
                });
                App().trackView('/app/share/email');
            });
        },
        _getFacebookShareUrl: function() {
            var
                linkToImagePage = false;
            var
                url = this._getShareUrl(),
                link = 'https://www.facebook.com/sharer.php?u=' + (url);
            if (linkToImagePage === false) {
                var
                    title = encodeURIComponent(this._getSnippet(50)),
                    summary = encodeURIComponent(this._getSnippet()),
                    imageUrl = encodeURIComponent(this._imageObj.displayUrl);
                link = 'https://www.facebook.com/sharer.php' + '?s=100' + '&p[title]=' + (title) + '&p[url]=' + (url) + '&p[summary]=' + (summary) + '&p[images][0]=' + (imageUrl);
            }
            return link;
        },
        _addFacebookShareEvent: function() {
            var
                _this = this;
            this._element.find('div.social a.facebook').click(function(event) {
                event.preventDefault();
                _this.showFacebookShareDialog();
                App().trackEvent('Image', 'shared', 'shareModal');
                App().mpTrackEvent('Facebook share button clicked', {
                    _source: 'Share modal'
                });
                App().trackEvent('Image', 'shared', 'shareModal.facebook.attempted');
                App().trackView('/app/share/facebook');
            });
        },
        _addGooglePlusShareEvent: function() {
            var
                _this = this;
            this._element.find('div.social a.google').click(function(event) {
                event.preventDefault();
                var
                    url = _this._getShareUrl(),
                    link = 'https://plus.google.com/share?url=' + (url);
                window.open(link, 'Google Plus Share', 'width=640, height=420');
                App().trackEvent('Image', 'shared', 'shareModal');
                App().mpTrackEvent('Google+ share button clicked', {
                    _source: 'Share modal'
                });
                App().trackView('/app/share/googlePlus');
            });
        },
        _addPinterestShareEvent: function() {
            var
                _this = this;
            this._element.find('div.social a.pinterest').click(function(event) {
                event.preventDefault();
                var
                    url = _this._getShareUrl(),
                    imageUrl = encodeURIComponent(_this._imageObj.displayUrl),
                    description = encodeURIComponent(_this._getSnippet()),
                    link = 'https://pinterest.com/pin/create/button/' + '?url=' + (url) + '&media=' + (imageUrl) + '&description=' + (description);
                window.open(link, 'Pinterest Share', 'width=640, height=320');
                App().trackEvent('Image', 'shared', 'shareModal');
                App().mpTrackEvent('Pinterest share button clicked', {
                    _source: 'Share modal'
                });
                App().trackView('/app/share/pinterest');
            });
        },
        _addRedirectUrlEvents: function() {
            if (App().userIsPro() == true) {
                var
                    _this = this;
                (new FormView(this._element.find('div.shareUrl form'), function(response) {
                    if (response.success === true) {
                        this.enable();
                        this.getElement().addClass('loaded');
                        this.getElement().addClass('changed');
                        _this._imageObj = response.data.image;
                    }
                }));
                this._element.find('div.shareUrl form div.reset a').click(function(event) {
                    event.preventDefault();
                });
            } else {
                this._element.find('div.shareUrl form').submit(function(event) {
                    event.preventDefault();
                    App().showUpsellModal('redirectUrl');
                });
                this._element.find('button[data-submit="true"]').click(function(event) {
                    event.preventDefault();
                    App().showUpsellModal('redirectUrl');
                });
            }
        },
        _addTextareaFocusEvents: function() {
            var
                inputElement = this._element.find('input[type="text"]'),
                callback = function(event) {
                    inputElement.select();
                    inputElement.mouseup(function() {
                        inputElement.unbind('mouseup');
                        return false;
                    });
                };
            this._element.find('div.url i').click(callback);
            this._element.find('div.url input').focus(callback);
        },
        _addTwitterShareEvent: function() {
            var
                _this = this;
            this._element.find('div.social a.twitter').click(function(event) {
                event.preventDefault();
                var
                    url = _this._getShareUrl(),
                    text = encodeURIComponent('"' + _this._getSnippet(75) + '"');
                var
                    publisher = Sai.get('publisher');
                if (publisher !== false) {
                    url = _this._imageObj.url;
                    text = encodeURIComponent('"' + _this._getSnippet(60) + '"');
                    text += encodeURIComponent(' ') + _this._getShareUrl();
                }
                var
                    link = 'https://twitter.com/intent/tweet' + '?url=' + (url) + '&via=shareasimage' + '&text=' + (text);
                window.open(link, 'Twitter Share', 'width=640, height=320');
                App().trackEvent('Image', 'shared', 'shareModal');
                App().mpTrackEvent('Twitter share button clicked', {
                    _source: 'Share modal'
                });
                App().trackView('/app/share/twitter');
            });
        },
        _addViewImageEvents: function() {
            this._element.find('div.aux a.viewLink').click(function(event) {
                App().trackEvent('Image', 'viewed', 'shareModal.textLink');
                App().mpTrackEvent('Image view link clicked', {
                    _source: 'Share modal'
                });
            });
            this._element.find('a.previewThumbAnchor').click(function(event) {
                App().trackEvent('Image', 'viewed', 'shareModal.image');
                App().mpTrackEvent('Image view thumb clicked', {
                    _source: 'Share modal'
                });
            });
        },
        _addDownloadImageEvents: function() {
            var
                _this = this,
                $downloadLink = this._element.find('div.aux a.downloadLink');
            if (App().userIsPro() == true) {
                $downloadLink.click(function(event) {
                    event.preventDefault();
                    App().trackEvent('Image', 'downloaded', 'shareModal.textLink');
                    App().mpTrackEvent('Image downloaded', {
                        _source: 'Share modal'
                    });
                    if (_this._imageObj.hasHighDef.toInt() === 1) {
                        location.href = '/i/' + (_this._imageObj.publicKey) + '/download?hd';
                    } else {
                        App().showPendingModal('imageDownload');
                        var
                            ghost = (new Ghost(function(imageString) {
                                jQuery.post('/images/' + (_this._imageObj.id) + '/hd', {
                                    csrfToken: Sai.get('csrfToken'),
                                    imageString: imageString
                                }, function(response) {
                                    if (response.success === true) {
                                        _this._imageObj = response.data.image;
                                        location.href = '/i/' + (_this._imageObj.publicKey) + '/download?hd';
                                        setTimeout(function() {
                                            App().closePendingModal();
                                        }, 1000);
                                    } else {
                                        if (App().siteHasBeenLocked(response)) {
                                            App().showLockedModal();
                                        } else {
                                            App().showErrorModal(false, response.failedRules[0].error.reference);
                                        }
                                    }
                                }, 'json').fail(function() {
                                    App().showErrorModal(false, 'mak4');
                                });
                            }));
                    }
                });
            } else {
                $downloadLink.click(function(event) {
                    event.preventDefault();
                    App().showUpsellModal('download');
                });
            }
        },
        _getShareUrl: function() {
            var
                url = this._imageObj.url,
                role = Sai.get('config').role;
            if (role === 'dev') {
                url += '?bypass';
            }
            var
                publisher = Sai.get('publisher');
            if (publisher !== false) {
                url = this._imageObj.sourceUrl;
            }
            if (App().userIsPro() == true) {
                if (this._imageObj.redirectUrl !== '') {
                    url = this._imageObj.redirectUrl;
                }
            }
            return encodeURIComponent(url);
        },
        _getSnippet: function(limit, isTweet) {
            var
                schema = JSON.parse(this._imageObj.documentJson),
                text = [];
            $(schema.layers).each(function(index, layer) {
                if (layer.type === 'text') {
                    text.push(layer.styles.text);
                }
            });
            if (typeof limit === 'undefined') {
                return text.join(' / ');
            }
            text = text.join(' / ');
            if (text.length > limit) {
                return text.substring(0, limit) + '...';
            }
            return text;
        },
        _getFacebookShareObject: function() {
            return {
                method: 'feed',
                name: this._getSnippet(50),
                description: this._getSnippet(100) + "\n",
                link: decodeURIComponent(this._getShareUrl()),
                picture: this._imageObj.displayUrl,
                actions: [{
                    name: 'View full image',
                    link: (this._imageObj.url) + '?fb'
                }]
            };
        },
        showFacebookShareDialog: function() {
            var
                _this = this;
            FB.ui(this._getFacebookShareObject(), function(response) {
                if (typeof response !== 'undefined') {
                    if (response === null) {
                        App().trackEvent('Image', 'shared', 'shareModal.facebook.failed');
                        App().mpTrackEvent('Image facebook share failed', {
                            _source: 'Share modal'
                        });
                    } else {
                        App().trackEvent('Image', 'shared', 'shareModal.facebook.successful');
                        App().mpTrackEvent('Image facebook share successful', {
                            _source: 'Share modal'
                        });
                    }
                }
            });
        }
    });
var
    SmartShareModalView = ModalView.extend({
        _imageObj: null,
        init: function(element, imageObj) {
            this._imageObj = imageObj;
            this._super(element);
            this._addGoBackLinkEvent();
            this._addCreateNewEvent();
            this._addDownloadImageEvents();
            this._addViewImageEvents();
            this._addBufferShareEvent();
            this._addFacebookShareEvent();
            this._addTwitterShareEvent();
            this._addGooglePlusShareEvent();
            this._addPinterestShareEvent();
        },
        _addGoBackLinkEvent: function() {
            var
                _this = this;
            this._element.find('a.goBackLink').click(function(event) {
                event.preventDefault();
                App().resetStartTime();
            });
        },
        _addCreateNewEvent: function() {
            var
                _this = this;
            this._element.find('a.createNewAnchor').click(function(event) {
                event.preventDefault();
                App().trackEvent('Image', 'cleared', 'shareModal');
                App().resetStartTime();
                App().mpTrackEvent('Canvas cleared', {
                    _source: 'Share modal'
                });
                App().loadEmptyCanvas();
            });
        },
        _addBufferShareEvent: function() {
            var
                _this = this;
            this._element.find('div.social a.buffer').click(function(event) {
                event.preventDefault();
                var
                    url = _this._getShareUrl(),
                    link = 'https://bufferapp.com/add?url=' + (url),
                    pictureUrl = _this._imageObj.displayUrl;
                if (App().userIsPro() === true) {
                    pictureUrl = _this._imageObj.displayUrl.replace(/\.net\//, '.net/hd.');
                }
                link += '&picture=' + encodeURIComponent(pictureUrl);
                link += '&text=' + encodeURIComponent(_this._getSnippet(70));
                window.open(link, 'Buffer Share', 'width=900, height=840');
                App().trackView('/app/smartShare/buffer');
            });
        },
        _addFacebookShareEvent: function() {
            var
                _this = this;
            this._element.find('div.social a.facebook').click(function(event) {
                event.preventDefault();
                if (Sai.get('config').defaults.facebookActive === false) {
                    App().showAlertModal('facebookInactive');
                } else {
                    var
                        facebookConnections = [],
                        userObj = Sai.get('loggedInUser');
                    $(userObj.connections).each(function(index, connection) {
                        if (connection.network === 'facebook') {
                            facebookConnections.push(connection);
                        }
                    });
                    if (facebookConnections.length === 0) {
                        var
                            permissions = App().getRequiredFacebookPermissions();
                        FB.login(jQuery.proxy(_this._facebookConnectCallback, _this), {
                            scope: permissions.join(','),
                            enable_profile_selector: true
                        });
                    } else {
                        App().showFacebookShareModal(_this._imageObj);
                    }
                }
            });
        },
        _addGooglePlusShareEvent: function() {
            var
                _this = this;
            this._element.find('div.social a.google').click(function(event) {
                event.preventDefault();
                var
                    url = _this._getShareUrl(),
                    link = 'https://plus.google.com/share?url=' + (url);
                window.open(link, 'Google Plus Share', 'width=640, height=420');
                App().trackEvent('Image', 'shared', 'shareModal');
                App().mpTrackEvent('Google+ share button clicked', {
                    _source: 'Share modal'
                });
                App().trackView('/app/smartShare/googlePlus');
            });
        },
        _addPinterestShareEvent: function() {
            var
                _this = this;
            this._element.find('div.social a.pinterest').click(function(event) {
                event.preventDefault();
                var
                    callback = function() {
                        App().showCustomUrlModal(_this._imageObj, function(customUrl) {
                            App().closeCustomUrlModal();
                            var
                                url = encodeURIComponent(customUrl),
                                imageUrl = encodeURIComponent(_this._imageObj.displayUrl),
                                description = encodeURIComponent(_this._getSnippet());
                            if (App().userIsPro() === true) {
                                imageUrl = encodeURIComponent(_this._imageObj.displayUrl.replace(/\.net\//, '.net/hd.'));
                            }
                            var
                                link = 'https://pinterest.com/pin/create/button/' + '?url=' + (url) + '&media=' + (imageUrl) + '&description=' + (description);
                            window.open(link, 'Pinterest Share', 'width=640, height=320');
                            App().trackEvent('Image', 'shared', 'shareModal');
                            App().mpTrackEvent('Pinterest share button clicked', {
                                _source: 'Share modal'
                            });
                            App().trackView('/app/smartShare/pinterest');
                        });
                    };
                if (App().userIsPro() === true) {
                    if (Sai.get('hdImageCreated') === false) {
                        App().showPendingModal('processingHd');
                        setTimeout(function() {
                            var
                                sharing = setInterval(function() {
                                    if (Sai.get('hdImageCreated') === true) {
                                        clearInterval(sharing);
                                        App().closePendingModal();
                                        callback();
                                    }
                                }, 250);
                        }, 2500);
                    } else {
                        callback();
                    }
                } else {
                    callback();
                }
            });
        },
        _addTwitterShareEvent: function() {
            window.twitterConnectCallback = function(response) {
                _this._twitterConnectCallback(response);
            };
            var
                _this = this;
            this._element.find('div.social a.twitter').click(function(event) {
                event.preventDefault();
                if (Sai.get('config').defaults.twitterActive === false) {
                    App().showAlertModal('twitterInactive');
                } else {
                    var
                        twitterConnections = [],
                        userObj = Sai.get('loggedInUser');
                    $(userObj.connections).each(function(index, connection) {
                        if (connection.network === 'twitter') {
                            twitterConnections.push(connection);
                        }
                    });
                    if (twitterConnections.length === 0) {
                        window.open('/twitter/redirect', 'Twitter Connect', 'width=640, height=420');
                    } else {
                        App().showTwitterShareModal(_this._imageObj);
                    }
                }
            });
        },
        _addViewImageEvents: function() {
            this._element.find('div.aux a.viewLink').click(function(event) {
                App().trackEvent('Image', 'viewed', 'shareModal.textLink');
                App().mpTrackEvent('Image view link clicked', {
                    _source: 'Share modal'
                });
            });
            this._element.find('a.previewThumbAnchor').click(function(event) {
                App().trackEvent('Image', 'viewed', 'shareModal.image');
                App().mpTrackEvent('Image view thumb clicked', {
                    _source: 'Share modal'
                });
            });
        },
        _addDownloadImageEvents: function() {
            var
                _this = this,
                $low = this._element.find('div.download div.low a.cta'),
                $hd = this._element.find('div.download div.hd a.cta');
            $low.click(function(event) {
                event.preventDefault();
                App().trackEvent('Image', 'downloaded', 'shareModal.textLink.low');
                App().mpTrackEvent('Image downloaded', {
                    _source: 'Share modal',
                    _quality: 'low'
                });
                var
                    downloadPath = 'https://' + (location.hostname) + '/i/' + (_this._imageObj.publicKey) + '/download';
                if (App().userIsPro() === true) {
                    if (Sai.get('hdImageCreated') === false) {
                        window.open(downloadPath);
                    } else {
                        location.href = downloadPath;
                    }
                } else {
                    location.href = downloadPath;
                }
            });
            $hd.click(function(event) {
                event.preventDefault();
                if (App().userIsPro() === false) {
                    App().showUpsellModal('download');
                } else {
                    var
                        callback = function() {
                            App().trackEvent('Image', 'downloaded', 'shareModal.textLink.hd');
                            App().mpTrackEvent('Image downloaded', {
                                _source: 'Share modal',
                                _quality: 'hd'
                            });
                            location.href = '/i/' + (_this._imageObj.publicKey) + '/download?hd';
                        };
                    if (Sai.get('hdImageCreated') === false) {
                        App().showPendingModal('imageDownload');
                        setTimeout(function() {
                            var
                                sharing = setInterval(function() {
                                    if (Sai.get('hdImageCreated') === true) {
                                        App().closePendingModal();
                                        clearInterval(sharing);
                                        callback();
                                    }
                                }, 250);
                        }, 2500);
                    } else {
                        callback();
                    }
                }
            });
        },
        _facebookConnectCallback: function(response) {
            var
                _this = this;
            if (response.authResponse !== null) {
                FB.api('/v2.2/me/permissions', function(permissionsObj) {
                    if (App().publishPermissionGiven(permissionsObj) === false) {
                        App().showFacebookErrorModal('connecting', 'permissions');
                        var
                            $modal = App().getOpenModals().pop().getElement();
                        $modal.addClass('reconnect');
                        $modal.find('.reconnectBtn').click(function(event) {
                            event.preventDefault();
                            _this._element.find('div.social a.facebook').trigger('click');
                        });
                    } else {
                        App().showBusyModal('facebookConnection');
                        jQuery.post('/facebook/connect', {
                            csrfToken: Sai.get('csrfToken')
                        }, function(response) {
                            if (response.success === true) {
                                Sai.set('loggedInUser', response.data.user);
                                setTimeout(function() {
                                    App().closeBusyModal();
                                    App().showFacebookShareModal(_this._imageObj);
                                }, App().getTimeout('socialConnection'));
                            }
                        }, 'json');
                    }
                });
            }
        },
        _getShareUrl: function() {
            var
                url = this._imageObj.url,
                role = Sai.get('config').role;
            if (role === 'dev') {
                url += '?bypass';
            }
            var
                publisher = Sai.get('publisher');
            if (publisher !== false) {
                url = this._imageObj.sourceUrl;
            }
            if (App().userIsPro() == true) {
                if (this._imageObj.redirectUrl !== '') {
                    url = this._imageObj.redirectUrl;
                }
            }
            return encodeURIComponent(url);
        },
        _getSnippet: function(limit, isTweet) {
            var
                schema = JSON.parse(this._imageObj.documentJson),
                text = [];
            $(schema.layers).each(function(index, layer) {
                if (layer.type === 'text') {
                    text.push(layer.styles.text);
                }
            });
            if (typeof limit === 'undefined') {
                return text.join(' / ');
            }
            text = text.join(' / ');
            if (text.length > limit) {
                return text.substring(0, limit) + '...';
            }
            return text;
        },
        _twitterConnectCallback: function(response) {
            var
                _this = this;
            App().showBusyModal('twitterConnection');
            Sai.set('loggedInUser', response.data.user);
            setTimeout(function() {
                App().closeBusyModal();
                App().showTwitterShareModal(_this._imageObj);
            }, App().getTimeout('socialConnection'));
        }
    });
var
    FacebookErrorModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
            this._addReconnectEvent();
        },
        _addReconnectEvent: function() {
            var
                _this = this;
            this._element.find('div.footer').find('.btn').click(function(event) {
                event.preventDefault();
                _this.close();
            });
        }
    });
var
    FacebookShareModalView = SpecialModalView.extend({
        _imageObj: null,
        _currentlySelectedConnectionId: null,
        init: function(element, imageObj) {
            this._imageObj = imageObj;
            this._super(element);
            this._currentlySelectedConnectionId = this._element.find('select').val();
            this._addShareFormEvent();
            this._addConnectionChangeEvent();
            this._addTextareaChangeEvent();
            this._addInsertUrlEvent();
            this._element.find('select').selectpicker();
            this._element.find('textarea').focus();
            this._addSearchInputPlaceholderText();
        },
        _addSearchInputPlaceholderText: function() {},
        _addInsertUrlEvent: function() {
            var
                _this = this;
            this._element.find('div.insertCta a').click(function(event) {
                event.preventDefault();
                var
                    url = _this._imageObj.sourceUrl;
                _this._element.find('textarea').val((_this._element.find('textarea').val()) + ' ' + (url));
                _this._element.find('div.insertCta').remove();
                _this._element.find('textarea').focus();
                App().mpTrackEvent('Insert url link clicked');
            });
        },
        _facebookConnectCallback: function(response) {
            var
                _this = this;
            if (response.authResponse !== null) {
                App().showBusyModal('facebookConnection');
                jQuery.post('/facebook/connect', {
                    csrfToken: Sai.get('csrfToken')
                }, function(response) {
                    if (response.success === true) {
                        Sai.set('loggedInUser', response.data.user);
                        setTimeout(function() {
                            jQuery.removeCookie('lastFacebookConnectionId', {
                                path: '/',
                                domain: '.' + (location.host)
                            });
                            App().closeFacebookShareModal();
                            App().showFacebookShareModal(_this._imageObj);
                            App().closeBusyModal();
                        }, App().getTimeout('socialConnection'));
                    }
                }, 'json');
            }
        },
        _addConnectionChangeEvent: function() {
            var
                _this = this;
            this._element.find('select').change(function(event) {
                event.preventDefault();
                if ($(this).val() !== '#') {
                    _this._currentlySelectedConnectionId = $(this).val();
                    _this._update();
                } else {
                    $(this).selectpicker('val', _this._currentlySelectedConnectionId);
                    var
                        permissions = App().getRequiredFacebookPermissions();
                    FB.login(jQuery.proxy(_this._facebookConnectCallback, _this), {
                        scope: permissions.join(','),
                        enable_profile_selector: true
                    });
                }
            });
        },
        _setMessage: function() {
            var
                val = this._element.find('textarea').val();
            val = val.parseURL().parseHashtag();
            this._element.find('.message').html(jQuery.truncate(val, {
                length: 105
            }));
        },
        _addTextareaChangeEvent: function() {
            var
                _this = this;
            this._element.find('textarea').bind('input propertychange', function(event) {
                _this._setMessage();
            });
            this._element.find('.message').on('click', 'a', function(event) {
                event.preventDefault();
            });
        },
        _addShareFormEvent: function() {
            var
                _this = this;
            (new FormView(this._element.find('form').first(), function(response) {
                var
                    connectionId = _this._element.find('select[name="connections[]"]').val();
                if (response.success === true) {
                    App().closePendingModal();
                    _this.close();
                    Sai.set('loggedInUser', response.data.user);
                    if (response.data.shares[0].success === false) {
                        App().showFacebookErrorModal('sharing', 'unknown');
                    } else {
                        App().showFacebookSuccessModal(response.data.shares[0].data.id, _this._getConnection(connectionId));
                    }
                }
            }, function(callback) {
                App().showPendingModal('facebookShare');
                if (App().userIsPro() === true) {
                    var
                        sharing = setInterval(function() {
                            if (Sai.get('hdImageCreated') === true) {
                                clearInterval(sharing);
                                callback();
                            }
                        }, 250);
                } else {
                    callback();
                }
            }));
        },
        _getConnection: function(connectionId) {
            var
                connections = Sai.get('loggedInUser').connections,
                connection;
            $(connections).each(function(index, obj) {
                if (obj.id.toInt() === connectionId.toInt()) {
                    connection = obj;
                }
            });
            return connection;
        },
        _update: function() {
            var
                connectionId = this._element.find('select').val(),
                name = this._getConnection(connectionId).name,
                backgroundImageUrl = this._getConnection(connectionId).imageUrl;
            this._element.find('.preview').find('.display').css({
                backgroundImage: 'url(' + (backgroundImageUrl) + ')'
            });
            this._element.find('.preview').find('.name').text(name.truncate(25));
        }
    });
var
    FacebookSuccessModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
            this._addUpsellButtonEvent();
        },
        _addUpsellButtonEvent: function() {
            this._element.find('div.footer.upsell').find('.btn').click(function(event) {
                event.preventDefault();
                App().showAppropriateUpgradeStep('testimonials');
            });
        }
    });
var
    TwitterErrorModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
            this._addReconnectEvent();
        },
        _addReconnectEvent: function() {
            var
                _this = this;
            this._element.find('div.footer').find('.btn').click(function(event) {
                event.preventDefault();
                _this.close();
            });
        }
    });
var
    TwitterShareModalView = SpecialModalView.extend({
        _imageObj: null,
        _currentlySelectedConnectionId: null,
        init: function(element, imageObj) {
            this._imageObj = imageObj;
            this._super(element);
            this._currentlySelectedConnectionId = this._element.find('select').val();
            this._addShareFormEvent();
            this._addConnectionChangeEvent();
            this._addTextareaChangeEvent();
            this._addInsertUrlEvent();
            this._element.find('select').selectpicker();
            this._update();
            this._element.find('textarea').focus();
            this._addSearchInputPlaceholderText();
        },
        _addSearchInputPlaceholderText: function() {},
        _addInsertUrlEvent: function() {
            var
                _this = this;
            this._element.find('div.insertCta a').click(function(event) {
                event.preventDefault();
                var
                    url = _this._imageObj.sourceUrl;
                _this._element.find('textarea').val((_this._element.find('textarea').val()) + ' ' + (url));
                _this._element.find('div.insertCta').remove();
                _this._setMessage();
                _this._element.find('textarea').focus();
                App().mpTrackEvent('Insert url link clicked');
            });
        },
        _twitterConnectCallback: function(response) {
            var
                _this = this;
            App().showBusyModal('twitterConnection');
            Sai.set('loggedInUser', response.data.user);
            jQuery.removeCookie('lastTwitterConnectionId', {
                path: '/',
                domain: '.' + (location.host)
            });
            setTimeout(function() {
                App().closeTwitterShareModal();
                App().showTwitterShareModal(_this._imageObj);
                App().closeBusyModal();
            }, App().getTimeout('socialConnection'));
        },
        _addConnectionChangeEvent: function() {
            window.twitterConnectCallback = function(response) {
                _this._twitterConnectCallback(response);
            };
            var
                _this = this;
            this._element.find('select').change(function(event) {
                event.preventDefault();
                if ($(this).val() !== '#') {
                    _this._currentlySelectedConnectionId = $(this).val();
                    _this._update();
                } else {
                    $(this).selectpicker('val', _this._currentlySelectedConnectionId);
                    window.open('/twitter/redirect', 'Twitter Connect', 'width=640, height=420');
                }
            });
        },
        _setMessage: function() {
            var
                val = this._element.find('textarea').val();
            val += ' https://pic.twitter.com/Yidfd83';
            this._element.find('.message').html(val.parseURL().parseUsername().parseHashtag());
            var
                $counter = this._element.find('.current'),
                $message = this._element.find('.message'),
                messageStr = $message.text();
            messageStr = messageStr.replace(/[A-Za-z]+s:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g, '12345678901234567890123');
            messageStr = messageStr.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g, '1234567890123456789012');
            $counter.text(messageStr.length);
            $counter.removeClass('red');
            if (messageStr.length > 140) {
                $counter.addClass('red');
            }
        },
        _addTextareaChangeEvent: function() {
            var
                _this = this;
            this._element.find('textarea').bind('input propertychange', function(event) {
                _this._setMessage();
            });
            this._element.find('.message').on('click', 'a', function(event) {
                event.preventDefault();
            });
        },
        _addShareFormEvent: function() {
            var
                _this = this,
                form = (new FormView(this._element.find('form').first(), function(response) {
                    var
                        connectionId = _this._element.find('select[name="connections[]"]').val();
                    if (response.success === true) {
                        App().closePendingModal();
                        Sai.set('loggedInUser', response.data.user);
                        if (response.data.shares[0].success === false) {
                            var
                                copyKey = 'unknown';
                            if (response.data.shares[0].error.code.toInt() === 187) {
                                form.enable();
                                copyKey = 'duplicate';
                            } else
                            if (response.data.shares[0].error.code.toInt() === 186) {
                                form.enable();
                                copyKey = 'limit';
                            } else {
                                _this.close();
                            }
                            App().showTwitterErrorModal(copyKey);
                        } else {
                            _this.close();
                            App().showTwitterSuccessModal(response.data.shares[0].data.id, _this._getConnection(connectionId));
                        }
                    }
                }, function(callback) {
                    App().showPendingModal('twitterShare');
                    if (App().userIsPro() === true) {
                        var
                            sharing = setInterval(function() {
                                if (Sai.get('hdImageCreated') === true) {
                                    clearInterval(sharing);
                                    callback();
                                }
                            }, 250);
                    } else {
                        callback();
                    }
                }));
        },
        _getConnection: function(connectionId) {
            var
                connections = Sai.get('loggedInUser').connections,
                connection;
            $(connections).each(function(index, obj) {
                if (obj.id.toInt() === connectionId.toInt()) {
                    connection = obj;
                }
            });
            return connection;
        },
        _update: function() {
            var
                connectionId = this._element.find('select').val(),
                fullname = this._getConnection(connectionId).fullname,
                name = this._getConnection(connectionId).name,
                backgroundImageUrl = this._getConnection(connectionId).imageUrl;
            this._element.find('.preview').find('.display').css({
                backgroundImage: 'url(' + (backgroundImageUrl) + ')'
            });
            this._element.find('.preview').find('.fullname').text(fullname);
            this._element.find('.preview').find('.name').text('@' + (name));
            this._setMessage();
        }
    });
var
    TwitterSuccessModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
            this._addUpsellButtonEvent();
        },
        _addUpsellButtonEvent: function() {
            this._element.find('div.footer.upsell').find('.btn').click(function(event) {
                event.preventDefault();
                App().showAppropriateUpgradeStep('testimonials');
            });
        }
    });
var
    UpgradeModalView = SpecialModalView.extend({
        _coupon: null,
        _form: null,
        init: function(element) {
            this._super(element);
            this._setupForm();
            this._element.find('input[type!="hidden"][class!="hidden"]').first().nonIeFocus();
            this._addCouponEvents();
            this._addRateToggleEvent();
            this._addProvinceToggleEvent();
            this._addProvinceChangeEvent();
            this._addSuccessButtonEvent();
            this._updatePrices();
            App().trackPageView('/app/upgrade');
        },
        _addCouponEvents: function() {
            var
                _this = this;
            this._element.find('a.addCouponCodeAnchor').click(function(event) {
                event.preventDefault();
                App().showCouponCodeModal(function(couponObj) {
                    App().closeCouponCodeModal();
                    App().showCouponCodeSuccessModal(couponObj);
                    _this._element.find('.addCouponCodeAnchor').addClass('hidden');
                    _this._element.find('.removeCouponCodeAnchor').removeClass('hidden');
                    _this._coupon = couponObj;
                    _this._updateCoupon();
                    _this._updatePrices();
                });
            });
            this._element.find('a.removeCouponCodeAnchor').click(function(event) {
                event.preventDefault();
                _this._element.find('.addCouponCodeAnchor').removeClass('hidden');
                _this._element.find('.removeCouponCodeAnchor').addClass('hidden');
                _this._coupon = null;
                _this._updateCoupon();
                _this._updatePrices();
            });
        },
        _addRateToggleEvent: function() {
            var
                _this = this;
            this._element.find('div.toggler a').click(function(event) {
                event.preventDefault();
                var
                    $yearly = _this._element.find('[name="yearly"]');
                if ($(this).hasClass('monthly')) {
                    $yearly.prop('checked', false);
                } else {
                    $yearly.prop('checked', true);
                }
                _this._element.find('div.refundNotice').addClass('hidden');
                if ($yearly.prop('checked') === true) {
                    _this._element.find('div.refundNotice').removeClass('hidden');
                }
                _this._element.find('div.toggler a').removeClass('active');
                $(this).addClass('active');
                _this._element.find('.pricing').removeClass('monthly');
                _this._element.find('.pricing').removeClass('yearly');
                if ($yearly.prop('checked') === true) {
                    _this._element.find('.pricing').addClass('yearly');
                } else {
                    _this._element.find('.pricing').addClass('monthly');
                }
                _this._updatePrices();
            });
        },
        _addProvinceChangeEvent: function() {
            var
                _this = this;
            this._element.find('select[name="provinceId"]').change(function(event) {
                _this._updatePrices();
            });
        },
        _addProvinceToggleEvent: function() {
            var
                _this = this;
            this._element.find('input[name="isInCanada"]').click(function(event) {
                if (_this._form.isEnabled() === true) {
                    _this._element.find('div.provinceWrapper').toggleClass('hidden');
                    _this._updatePrices();
                } else {
                    event.preventDefault();
                }
            });
        },
        _addSuccessButtonEvent: function() {
            var
                _this = this;
            this._element.find('a.goBackBtn').click(function(event) {
                event.preventDefault();
                App().closeOpenModals();
                App().getFooter().show();
                App().getUpgradeCallback()();
            });
        },
        _showFormState: function() {
            this._element.removeClass('processingState');
            this._element.removeClass('successState');
            this._element.addClass('formState');
        },
        _showProcessingState: function() {
            this._element.removeClass('formState');
            this._element.removeClass('successState');
            this._element.addClass('processingState');
        },
        _showSuccessState: function() {
            App().getWatermarkTab().getElement().find('.switch').bootstrapSwitch('setState', false);
            this._element.removeClass('formState');
            this._element.removeClass('processingState');
            this._element.addClass('successState');
        },
        _setupForm: function() {
            var
                _this = this;
            this._form = (new CreditCardFormView(this._element.find('form'), function(response) {
                App().upgradeUser(response.data.user);
                _this._showSuccessState();
                var
                    freq = response.data.user.frequency;
                App().trackView('/app/upgrade/success/' + (freq));
                App().updateUserMpPeopleData();
                App().mpTrackEvent('User upgraded successsfully');
            }, {
                start: function() {
                    _this._showProcessingState();
                },
                end: function() {
                    _this._showFormState();
                }
            }));
        },
        _updateCoupon: function() {
            this._element.find('div.discounts div.trial').addClass('hidden');
            this._element.find('.trialPeriodNotice').addClass('hidden');
            this._element.find('[data-submit="true"]').find('.copy').text('Pay Securely');
            this._element.find('div.scratched div.monthly').addClass('hidden');
            this._element.find('div.discounts div.discount').addClass('hidden');
            if (this._coupon === null) {
                this._element.find('input[name="couponCode"]').val('');
            } else {
                this._element.find('input[name="couponCode"]').val(this._coupon.code);
                if (this._coupon.frequency !== 'both') {
                    this._element.find('div.toggler a.' + (this._coupon.frequency)).trigger('click');
                }
                if (this._coupon.numberOfFreeTrialDays.toInt() !== 0) {
                    if (this._coupon.frequency === 'both') {
                        this._element.find('div.discounts div.trial').removeClass('hidden');
                    } else {
                        if (this._coupon.frequency === 'monthly') {
                            this._element.find('div.discounts div.monthly div.trial').removeClass('hidden');
                        } else
                        if (this._coupon.frequency === 'yearly') {
                            this._element.find('div.discounts div.yearly div.trial').removeClass('hidden');
                        }
                    }
                    this._element.find('[rel="numberOfTrialPeriodDays"]').text(this._coupon.numberOfFreeTrialDays);
                    this._element.find('.trialPeriodNotice').removeClass('hidden');
                    this._element.find('[data-submit="true"]').find('.copy').text('Start Trial');
                }
                if (this._coupon.discount.toFloat() !== 0) {
                    if (this._coupon.frequency === 'both') {
                        this._element.find('div.scratched div.monthly').removeClass('hidden');
                        this._element.find('div.discounts div.discount').removeClass('hidden');
                    } else {
                        if (this._coupon.frequency === 'monthly') {
                            this._element.find('div.scratched div.monthly').removeClass('hidden');
                            this._element.find('div.discounts div.monthly div.discount').removeClass('hidden');
                        } else
                        if (this._coupon.frequency === 'yearly') {
                            this._element.find('div.discounts div.yearly div.discount').removeClass('hidden');
                        }
                    }
                    this._element.find('[rel="discount"]').text(this._coupon.discountType === 'percentage' ? ((this._coupon.discount) + '%') : ('$' + (this._coupon.discount.centsTo$())));
                }
            }
        },
        _getTaxAdjustedRate: function(rate) {
            var
                provinceId = this._element.find('select[name="provinceId"]').val().toInt(),
                isInCanada = this._element.find('[name="isInCanada"]').is(':checked');
            if (isInCanada === true && provinceId !== 0) {
                var
                    provinces = Sai.get('provinces'),
                    taxRate;
                $(provinces).each(function(index, province) {
                    if (province.id.toInt() === provinceId) {
                        taxRate = (province.taxableRate / 100);
                    }
                });
                return Math.round(rate * (1 + taxRate));
            }
            return rate;
        },
        _updateMonthlyScratchedRate: function() {
            var
                rate = this._getTaxAdjustedRate(Sai.get('loggedInUser').rate).toStr(),
                $el = this._element.find('.pricing .scratched .monthly'),
                cents = rate.match(/.{2}$/).pop(),
                dollars = rate.match(/(.+).{2}$/).pop();
            $el.find('.dollars').text(dollars);
            $el.find('.cents').text(cents);
        },
        _updateMonthlyRate: function() {
            var
                rate = Sai.get('loggedInUser').rate.toInt(),
                $el = this._element.find('.pricing .actual .monthly');
            if (this._coupon !== null && (this._coupon.frequency === 'both' || this._coupon.frequency === 'monthly')) {
                if (this._coupon.discountType === 'percentage') {
                    var
                        percentage = this._coupon.discount.toFloat();
                    rate = Math.round(rate * (100 - percentage) / 100);
                } else
                if (this._coupon.discountType === 'dollar') {
                    var
                        discount = this._coupon.discount.toFloat();
                    rate = Math.round(rate - discount);
                }
            }
            rate = this._getTaxAdjustedRate(rate).toStr();
            var
                cents = rate.match(/.{2}$/).pop(),
                dollars = rate.match(/(.+).{2}$/).pop();
            $el.find('.dollars').text(dollars);
            $el.find('.cents').text(cents);
        },
        _updateMonthlyScratchedYearlyRate: function() {
            var
                rate = this._getTaxAdjustedRate(Sai.get('loggedInUser').rate).toStr(),
                $el = this._element.find('.pricing .scratched .yearly'),
                cents = rate.match(/.{2}$/).pop(),
                dollars = rate.match(/(.+).{2}$/).pop();
            $el.find('.dollars').text(dollars);
            $el.find('.cents').text(cents);
        },
        _updateMonthlyYearlyRate: function() {
            var
                yearlyRate = Sai.get('loggedInUser').yearlyRate.toInt(),
                rate = yearlyRate / 12,
                $el = this._element.find('.pricing .actual .yearly');
            if (this._coupon !== null && (this._coupon.frequency === 'both' || this._coupon.frequency === 'yearly')) {
                if (this._coupon.discountType === 'percentage') {
                    var
                        percentage = this._coupon.discount.toFloat();
                    rate = Math.round(rate * (100 - percentage) / 100);
                    yearlyRate = Math.round(yearlyRate * (100 - percentage) / 100);
                } else
                if (this._coupon.discountType === 'dollar') {
                    var
                        discount = this._coupon.discount.toFloat();
                    rate = Math.round(rate - discount / 12);
                    yearlyRate = Math.round(yearlyRate - discount);
                }
            }
            rate = this._getTaxAdjustedRate(rate).toStr();
            var
                cents = rate.match(/.{2}$/).pop(),
                dollars = rate.match(/(.+).{2}$/).pop();
            $el.find('.dollars').text(dollars);
            $el.find('.cents').text(cents);
            this._element.find('[data-property="yearlyRate"]').text('$' + (this._getTaxAdjustedRate(yearlyRate).centsTo$()));
        },
        _updatePrices: function() {
            this._updateMonthlyScratchedRate();
            this._updateMonthlyRate();
            this._updateMonthlyScratchedYearlyRate();
            this._updateMonthlyYearlyRate();
        }
    });
var
    UpsellModalView = SpecialModalView.extend({
        init: function(element) {
            this._super(element);
            this._addUpgradeButtonEvent();
        },
        _addUpgradeButtonEvent: function() {
            this._element.find('a.upgradeBtn').click(function(event) {
                event.preventDefault();
                App().trackEvent('UpgradeModal', 'shown', 'upsellModal');
                App().mpTrackEvent('Upgrade modal shown', {
                    _source: 'Upsell modal'
                });
                App().showAppropriateUpgradeStep('testimonials');
                App().closeUpsellModal();
            });
        }
    });
var
    PageView = View.extend({
        init: function(element) {
            this._super(element);
            this._insertChromeWebstoreItemLinks();
        },
        _insertChromeWebstoreItemLinks: function() {
            var
                $app = $('<link />');
            $app.attr({
                rel: 'chrome-webstore-item',
                id: 'chrome-webstore-app',
                href: 'https://chrome.google.com/webstore/detail/bgjkdefgpgngdhagacbeajapgnoobjig'
            });
            var
                $extension = $('<link />');
            $extension.attr({
                rel: 'chrome-webstore-item',
                id: 'chrome-webstore-extension',
                href: 'https://chrome.google.com/webstore/detail/hgmhphfbdfbkokcfajipbmkcakmmepeb'
            });
            $('head').append($app, $extension);
        },
        _makeGaCall: function(call, override) {
            var
                role = Sai.get('config').role,
                user = Sai.get('loggedInUser');
            if (role === 'prod') {
                if (user === false || user.isAdmin.toInt() === 0 || (typeof override !== 'undefined' && override === true)) {
                    _gaq.push(call);
                }
            }
        },
        _makeMpCall: function(call, scope, args, override) {
            var
                role = Sai.get('config').role,
                user = Sai.get('loggedInUser');
            if (role === 'prod') {
                if (user === false || user.isAdmin.toInt() === 0 || (typeof override !== 'undefined' && override === true)) {
                    call.apply(scope, args);
                }
            }
        },
        trackCustomVar: function(index, name, value, scope) {
            var
                call = ['_setCustomVar', index, name, value, scope];
            this._makeGaCall(call);
        },
        trackEvent: function(category, action, optLabel, optValue, override) {
            var
                call = ['_trackEvent'];
            if (typeof category !== 'undefined') {
                call.push(category);
            }
            if (typeof action !== 'undefined') {
                call.push(action);
            }
            if (typeof optLabel !== 'undefined') {
                call.push(optLabel);
            }
            if (typeof optValue !== 'undefined') {
                call.push(optValue);
            }
            this._makeGaCall(call, override);
        },
        mpAlias: function(alias) {
            var
                publisher = Sai.get('publisher');
            if (publisher === false) {
                var
                    role = Sai.get('config').role;
                if (role === 'local') {
                    alias = 'l-' + (alias);
                } else
                if (role === 'dev') {
                    alias = 'd-' + (alias);
                } else
                if (role === 'prod') {
                    alias = 'p-' + (alias);
                }
               // this._makeMpCall(mixpanel.alias, mixpanel, [alias]);
            }
        },
        mpIdentify: function(alias) {
            var
                publisher = Sai.get('publisher');
            if (publisher === false) {
                var
                    role = Sai.get('config').role;
                if (role === 'local') {
                    alias = 'l-' + (alias);
                } else
                if (role === 'staging') {
                    alias = 'd-' + (alias);
                } else
                if (role === 'prod') {
                    alias = 'p-' + (alias);
                }
            }
        },
        mpRegister: function(properties) {
            var
                publisher = Sai.get('publisher');
            if (publisher === false) {}
        },
        mpPeopleSet: function(properties) {
            var
                publisher = Sai.get('publisher');
            if (publisher === false) {}
        },
        mpTrackEvent: function(name, properties) {
            var
                publisher = Sai.get('publisher');
            if (publisher === false) {}
        },
        trackView: function(path) {
            var
                call = ['_trackPageview', path];
            this._makeGaCall(call);
        }
    });
var
    TextTabView = View.extend({
        _maxTextFields: 100,
        init: function(element) {
            this._super(element);
            if (isChrome() === false) {}
            this._addScrollEvent();
            this._addTextAdditionEvent();
            this._drawTextControls();
            this.update();
            this._addScrollOverflowEvent(this._element);
        },
        _addEmptyTextLayer: function() {
            var
                newLayer = App().getImageDocument().addEmptyTextLayer();
            newLayer.getDrawing().draw();
            newLayer.drawControl();
            newLayer.getControl().getElement().find('textarea').select();
            App().getImageDocument().getWatermarkLayer().getDrawing().bringToFront();
        },
        _addScrollEvent: function() {
            var
                _this = this;
            this._element.scroll(function(event) {
                var
                    layers = App().getImageDocument().getTextLayers();
                $(layers).each(function(index, layer) {
                    var
                        pickers = layer.getControl().getColorPickers();
                    pickers.fillStyle && pickers.fillStyle.getSwatch().popover('hide');
                    pickers.plane && pickers.plane.getSwatch().popover('hide');
                    pickers.strokeStyle && pickers.strokeStyle.getSwatch().popover('hide');
                });
            });
        },
        _addTextAdditionEvent: function() {
            var
                _this = this;
            this._element.find('.addTextBtn').click(function(event) {
                event.preventDefault();
                _this._addEmptyTextLayer();
                _this.update();
            });
        },
        _drawTextControls: function() {
            var
                textLayers = App().getImageDocument().getTextLayers();
            $(textLayers).each(function(index, layer) {
                layer.drawControl();
            });
        },
        update: function() {
            var
                textLayers = App().getImageDocument().getTextLayers();
            this._element.find('.addTextBtn').removeClass('hidden');
            if (textLayers.length === this._maxTextFields) {
                this._element.find('.addTextBtn').addClass('hidden');
            }
            this._element.find('.remove').removeClass('hidden');
            this._element.find('.removeTextCta').removeClass('hidden');
            if (textLayers.length === 1) {
                this._element.find('.remove').addClass('hidden');
                this._element.find('.removeTextCta').addClass('hidden');
            }
            if (textLayers.length === 1) {
                this._element.find('textarea').css('height', '192px');
            } else {
                this._element.find('textarea').css('height', '69px');
                this._element.animate({
                    scrollTop: this._element.find('.controls').first().height()
                }, 'slow');
            }
        }
    });
var
    WatermarkTabView = View.extend({
        init: function(element) {
            this._super(element);
            this._setupOpacityEvent();
            this._setupSizeEvents();
            this._setupSourceEvent();
            this._setupToggler();
            this._element.find('div.disabled .btn').click(function(event) {
                event.preventDefault();
                App().trackEvent('UpgradeModal', 'shown', 'watermarkTab');
                App().mpTrackEvent('Upgrade modal shown', {
                    _source: 'Watermark tab'
                });
                App().showAppropriateUpgradeStep('upgrade');
            });
        },
        _setupOpacityEvent: function() {
            var
                _this = this,
                strengthElement = this._element.find('input[name="opacityStrength"]');
            strengthElement.slider();
            strengthElement.on('slideStop', function(event) {
                var
                    watermarkLayer = App().getImageDocument().getWatermarkLayer(),
                    opacityStrength = event.value.toInt();
                _this.turnSwitchOn();
                opacityStrength = 100 - opacityStrength;
                watermarkLayer.setFilter({
                    type: 'opacity',
                    properties: {
                        strength: opacityStrength
                    }
                });
                watermarkLayer.saveSettings();
            });
        },
        _setupSizeEvents: function() {
            var
                _this = this;
            this._element.find('input[name="size"]').change(function() {
                if (App().userIsPro() == true) {
                    var
                        size = $(this).val(),
                        watermarkLayer = App().getImageDocument().getWatermarkLayer();
                    watermarkLayer.setProperty('size', size);
                    App().trackEvent('WatermarkImage', 'resized', size);
                    App().mpTrackEvent('Watermark resized', {
                        _size: size
                    });
                    var
                        resizedImg = (new Image()),
                        maximumWatermarkDimensions = App().getMaximumWatermarkDimensions(size),
                        sourceSrc = watermarkLayer.getProperty('sourceSrc'),
                        resizedSrc = (sourceSrc) + '/convert' + '?w=' + (maximumWatermarkDimensions.width) + '&h=' + (maximumWatermarkDimensions.height) + '&fit=max';
                    App().getWatermarkTab().turnSwitchOn();
                    resizedImg.onload = function() {
                        var
                            dimensions = resizedImg.getFittedDimensions(maximumWatermarkDimensions);
                        watermarkLayer.setProperty('resizedSrc', resizedSrc);
                        watermarkLayer.setStyle('height', dimensions.height);
                        watermarkLayer.setStyle('width', dimensions.width);
                        watermarkLayer.getDrawing().refreshImage(true, function() {
                            watermarkLayer.getDrawing().refreshStyle('height');
                            watermarkLayer.getDrawing().refreshStyle('width');
                        });
                        watermarkLayer.saveSettings();
                    };
                    resizedImg.src = resizedSrc;
                } else {
                    var
                        $mediumOption = _this._element.find('input[name="size"][value="medium"]'),
                        _this2 = this;
                    setTimeout(function() {
                        $(_this2).attr('checked', false);
                        $(_this2).parent().removeClass('active');
                        $mediumOption.attr('checked', true);
                        $mediumOption.parent().addClass('active');
                    }, 0);
                    App().showUpsellModal('watermark');
                }
            });
        },
        _setupSourceEvent: function() {
            var
                _this = this;
            var
                showFilepicker = Sai.get('config').defaults.showFilepicker;
            if (showFilepicker === false) {
                this._element.find('a.uploadWatermarkBtn').popover({
                    placement: 'bottom',
                    content: 'Currently disabled due to a technical issue. We\'re actively working to resolve the issue. Thanks for your patience!',
                    trigger: 'hover'
                });
            }
            this._element.find('a.uploadWatermarkBtn').click(function(event) {
                event.preventDefault();
                var
                    isNewTabInChrome = Sai.get('config').referer !== false && Sai.get('config').referer.indexOf('_/chrome/newtab') !== -1;
                if (isNewTabInChrome) {
                    App().showAlertModal('filepickerUnavailable');
                } else {
                    if (showFilepicker === true) {
                        if (App().userIsPro() == true) {
                            App().trackEvent('WatermarkImage', 'clicked', 'watermarkTab');
                            App().mpTrackEvent('Filepicker shown', {
                                _source: 'Watermark tab'
                            });
                            App().showFilepicker(function(sourceSrc, InkBlob) {
                                App().trackEvent('WatermarkImage', 'pick', 'watermarkTab');
                                App().mpTrackEvent('Watermark uploaded', {
                                    _source: 'Watermark tab'
                                });
                                App().drawFPImageAsWatermarkLayer(sourceSrc, function() {
                                    var
                                        watermarkLayer = App().getImageDocument().getWatermarkLayer();
                                    watermarkLayer.saveSettings();
                                });
                            }, false);
                        } else {
                            App().showUpsellModal('watermark');
                        }
                    }
                }
            });
        },
        _setupToggler: function() {
            var
                _this = this;
            this._element.find('.switch').bootstrapSwitch();
            this._element.find('.switch').on('switch-change', function(event, data) {
                if (App().userIsPro() == true) {
                    $(this).bootstrapSwitch('setAnimated', true);
                    var
                        watermarkLayer = App().getImageDocument().getWatermarkLayer();
                    if (data.value === true) {
                        App().trackEvent('WatermarkImage', 'shown');
                        App().mpTrackEvent('Watermark toggled', {
                            _visible: 'Yes'
                        });
                        watermarkLayer.show();
                    } else {
                        App().trackEvent('WatermarkImage', 'hidden');
                        App().mpTrackEvent('Watermark toggled', {
                            _visible: 'No'
                        });
                        watermarkLayer.hide();
                    }
                } else {
                    if (data.value === false) {
                        $(this).bootstrapSwitch('setAnimated', false);
                        $(this).bootstrapSwitch('setState', true);
                        App().showUpsellModal('watermark');
                    }
                }
            });
        },
        disable: function() {
            this._element.addClass('disabledState');
        },
        enable: function() {
            this._element.removeClass('disabledState');
        },
        turnSwitchOn: function() {
            this._element.find('.switch').bootstrapSwitch('setState', true);
        }
    });
var
    AppView = PageView.extend({
        _alerts: {
            deliquent: {
                class: 'deliquent',
                headline: 'Your account needs updating!',
                message: 'We had trouble charging your card this month.<br />' + 'Please update your credit card details.',
                button: {
                    copy: 'Update Payment Details',
                    callback: function(event) {
                        event.preventDefault();
                        App().closeOpenModals();
                        App().showAccountModal('payment');
                    }
                }
            },
            facebookInactive: {
                class: 'facebookInactive',
                headline: 'Facebook is temporarily off',
                message: 'Sorry about the trouble.<br /><br />We\'re working on ' + 'it, and will have things up<br />and running as soon as ' + 'possible.',
                button: {
                    copy: 'Okay',
                    callback: function(event) {
                        event.preventDefault();
                        App().closeAlertModal();
                    }
                }
            },
            twitterInactive: {
                class: 'twitterInactive',
                headline: 'Twitter is temporarily off',
                message: 'Sorry about the trouble.<br /><br />We\'re working on ' + 'it, and will have things up<br />and running as soon as ' + 'possible.',
                button: {
                    copy: 'Okay',
                    callback: function(event) {
                        event.preventDefault();
                        App().closeAlertModal();
                    }
                }
            },
            weeklySnaps: {
                class: 'weeklySnaps',
                headline: 'Introducing',
                message: '20 Royalty free images in you<br />inbox every week!',
                button: {
                    copy: 'Go To WeeklySnaps.com',
                    callback: function(event) {
                        event.preventDefault();
                        window.open('http://weeklysnaps.com');
                        App().closeOpenModals();
                    }
                }
            },
            filepickerUnavailable: {
                class: 'filepickerUnavailable',
                headline: 'File uploading alert',
                message: 'You are not on a website right now. Please go to a ' + 'valid website<br />(i.e. <a href="https://www.yahoo.com" target="_blank">https://www.yahoo.com</a> or any website) ' + 'in order to use file uploads.',
                button: {
                    copy: 'Okay',
                    callback: function(event) {
                        event.preventDefault();
                        App().closeAlertModal();
                    }
                }
            },
            hdPrint: {
                class: 'hdPrint',
                headline: 'Your image is ready!',
                message: 'Click below to view options on printing your image on ' + 'a canvas.',
                button: {
                    copy: 'View Print Options',
                    callback: function(event) {
                        event.preventDefault();
                        App().closeAlertModal();
                    }
                }
            },
            print: {
                class: 'print',
                headline: 'Printing is coming soon!',
                message: 'We\'re working on letting you order prints<br />' + 'on canvas. We hope to get it live soon.',
                button: {
                    copy: 'Okay',
                    callback: function(event) {
                        event.preventDefault();
                        App().closeAlertModal();
                    }
                }
            },
            templateSaved: {
                class: 'templateSaved',
                headline: 'Your template has been saved!',
                message: 'Use it anytime from the Templates tab.',
                button: {
                    copy: 'Okay',
                    callback: function(event) {
                        event.preventDefault();
                        App().closeOpenModals();
                    }
                }
            }
        },
        _backgroundControl: null,
        _backgroundTab: null,
        _boxFitting: {
            single: {
                fontSize: {
                    minimum: '12px',
                    maximum: '48px'
                }
            },
            double: {
                fontSize: [{
                    minimum: '12px',
                    maximum: '48px'
                }, {
                    minimum: '16px',
                    maximum: '24px'
                }]
            }
        },
        _busyModalCopy: {
            cancellingSubscription: 'Cancelling subscription...',
            loggingOut: 'Logging you out...',
            facebookConnection: 'Connecting to Facebook...',
            twitterConnection: 'Connecting to Twitter...',
            creatingImage: 'Saving your image...',
            savingImageAsTemplate: 'Saving your image as a template...',
            creatingPublisherImage: 'Saving your image...',
            disconnectingConnection: 'Updating social settings...',
            loadingEmptyCanvas: 'Preparing new image...',
            loadingImages: 'Loading your images...',
            loadingPhoto: 'Loading photo...',
            loadingFilepickerImage: 'Loading your preview...',
            loadingRemix: 'Loading image...',
            loadingTemplate: 'Loading template...',
            processingCreditCard: 'Securely processing your order<br />This may ' + 'take up to 15 seconds',
            resizing: 'Resizing your image...',
            upgrading: '<i class="icon-lock"></i>Connecting to secure server...'
        },
        _callbacks: {
            connect: function() {},
            upgrade: function() {}
        },
        _canvasDimensionsLimit: {
            height: 385,
            width: 495
        },
        _changeStack: [],
        _confirms: {
            backgroundImageChange: {
                class: 'backgroundImageChange',
                headline: 'Do you want to change your background<br />image to this one?',
                message: 'Are you sure you want to do this?',
                buttons: {
                    yes: {
                        copy: 'Yes'
                    },
                    no: {
                        copy: 'No'
                    }
                }
            },
            watermarkSize: {
                class: 'watermarkSize',
                headline: 'Your watermark is too small',
                message: '...',
                buttons: [{
                    copy: 'Choose another watermark',
                    type: 'button',
                    callback: function(event) {
                        event.preventDefault();
                        log('test');
                    }
                }, {
                    copy: 'Use this one',
                    type: 'text',
                    callback: function(event) {
                        event.preventDefault();
                        App().closeOpenModals();
                    }
                }]
            }
        },
        _currentTab: 'text',
        _defaultImageDocumentJson: {
            layers: [{
                isBackground: true,
                type: 'rectangle',
                filters: [],
                styles: {
                    fillStyle: '#304e66',
                    height: '{replace}',
                    width: '{replace}',
                    x: 0,
                    y: 0
                }
            }, {
                styles: {
                    align: 'center',
                    fillStyle: '#ffffff',
                    shadowColor: 'rgba(0,0,0,0.25)',
                    fontFamily: 'Amaranth',
                    fontSize: '28px',
                    fontStyle: 'normal',
                    text: 'Click & drag to move me around.',
                    x: 'center',
                    y: 'center'
                },
                type: 'text'
            }]
        },
        _defaultLineHeight: 1.2,
        _filtersTab: null,
        _fontFamilies: [{
            name: 'Amaranth',
            bold: true,
            italic: true
        }, {
            name: 'Antic Slab',
            bold: false,
            italic: false
        }, {
            name: 'Baumans',
            bold: false,
            italic: false
        }, {
            name: 'Bevan',
            bold: false,
            italic: false
        }, {
            name: 'Bitter',
            bold: true,
            italic: true
        }, {
            name: 'Black Ops One',
            bold: false,
            italic: false
        }, {
            name: 'Buenard',
            bold: true,
            italic: false
        }, {
            name: 'Butterfly Kids',
            bold: false,
            italic: false
        }, {
            name: 'Codystar',
            bold: false,
            italic: false
        }, {
            name: 'Concert One',
            bold: false,
            italic: false
        }, {
            name: 'Crete Round',
            bold: false,
            italic: true
        }, {
            name: 'Dancing Script',
            bold: true,
            italic: false
        }, {
            name: 'Dosis',
            bold: true,
            italic: false
        }, {
            name: 'Graduate',
            bold: false,
            italic: false
        }, {
            name: 'Helvetica',
            bold: false,
            italic: false,
            webfont: true
        }, {
            name: 'Lilita One',
            bold: false,
            italic: false
        }, {
            name: 'Lily Script One',
            bold: false,
            italic: false
        }, {
            name: 'Merriweather Sans',
            bold: true,
            italic: true
        }, {
            name: 'Monoton',
            bold: false,
            italic: false
        }, {
            name: 'Noticia Text',
            bold: true,
            italic: true
        }, {
            name: 'Open Sans',
            bold: true,
            italic: true
        }, {
            name: 'Oswald',
            bold: true,
            italic: false
        }, {
            name: 'PT Mono',
            bold: false,
            italic: false
        }, {
            name: 'Parisienne',
            bold: false,
            italic: false
        }, {
            name: 'Permanent Marker',
            bold: false,
            italic: false
        }, {
            name: 'Quattrocento Sans',
            bold: true,
            italic: true
        }, {
            name: 'Quicksand',
            bold: true,
            italic: false
        }, {
            name: 'Qwigley',
            bold: false,
            italic: false
        }, {
            name: 'Rokkitt',
            bold: true,
            italic: false
        }, {
            name: 'Satisfy',
            bold: false,
            italic: false
        }, {
            name: 'Shadows Into Light Two',
            bold: false,
            italic: false
        }, {
            name: 'Special Elite',
            bold: false,
            italic: false
        }, {
            name: 'The Girl Next Door',
            bold: false,
            italic: false
        }, {
            name: 'Playfair Display',
            bold: true,
            italic: true
        }, {
            name: 'Cabin Sketch',
            bold: true,
            italic: false
        }, {
            name: 'Emilys Candy',
            bold: false,
            italic: false
        }, {
            name: 'Nixie One',
            bold: false,
            italic: false
        }, {
            name: 'Yellowtail',
            bold: false,
            italic: false
        }, {
            name: 'Bad Script',
            bold: false,
            italic: false
        }, {
            name: 'Roboto Slab',
            bold: true,
            italic: false
        }, {
            name: 'Rye',
            bold: false,
            italic: false
        }, {
            name: 'Josefin Sans',
            bold: true,
            italic: true
        }, {
            name: 'Rock Salt',
            bold: false,
            italic: false
        }, {
            name: 'Damion',
            bold: false,
            italic: false
        }, {
            name: 'Quando',
            bold: false,
            italic: false
        }, {
            name: 'Chewy',
            bold: false,
            italic: false
        }, {
            name: 'Courgette',
            bold: false,
            italic: false
        }, {
            name: 'Comfortaa',
            bold: true,
            italic: false
        }, {
            name: 'Fredoka One',
            bold: false,
            italic: false
        }, {
            name: 'Bowlby One SC',
            bold: false,
            italic: false
        }, {
            name: 'Sacramento',
            bold: false,
            italic: false
        }, {
            name: 'Changa One',
            bold: false,
            italic: true
        }, {
            name: 'Lusitana',
            bold: true,
            italic: false
        }, {
            name: 'Reenie Beanie',
            bold: false,
            italic: false
        }],
        _footer: null,
        _imageDocument: null,
        _isGhost: false,
        _loadedWebFonts: [],
        _maximumCanvasDimensions: {
            height: 385,
            width: 495
        },
        _maximumWatermarkDimensions: {
            tiny: {
                height: 50,
                width: 50
            },
            small: {
                height: 100,
                width: 100
            },
            medium: {
                height: 200,
                width: 200
            },
            large: {
                height: 300,
                width: 300
            }
        },
        _pendingModalCopy: {
            facebookShare: 'Posting to Facebook<br />' + 'Just a few more seconds...',
            loadingFonts: 'Loading 50+ fonts<br />' + 'Just a few more seconds...',
            imageDownload: 'Saving your image as HD<br />' + 'Download will begin shortly',
            hdImagePrint: 'Saving your image as HD and removing watermark. ' + 'Just a few seconds',
            processingHd: 'Saving your image as HD<br />' + 'Just a few more seconds...',
            twitterShare: 'Posting to Twitter<br />' + 'Just a few more seconds...'
        },
        _tips: [{
            copy: 'Images can now<br />be shared in high resolution!',
            type: 'new'
        }, {
            copy: 'When you share images on Facebook<br />& Twitter, ' + 'they\'ll stand out on your timeline like never before!',
            type: 'dyk'
        }, {
            copy: 'Photo tweets are <strong>400%</strong> more<br />likely to ' + 'be shared than text-based ones!',
            type: 'dyk'
        }, {
            copy: 'Start branding images with<br />your company logo.',
            type: 'new'
        }, {
            copy: 'Images get <strong>84%</strong> more<br />click-throughs ' + 'than text-based posts.',
            type: 'dyk'
        }, {
            copy: 'Create and share your micro-content<br />directly to Facebook & Twitter.',
            type: 'new'
        }, {
            copy: 'When you tweet an image<br />it is <strong>150%</strong> ' + 'more likely to be retweeted.',
            type: 'dyk'
        }],
        _facebookErrorModalCopy: {
            top: {
                sharing: 'Error while trying to<br />share to Facebook',
                connecting: 'Something went wrong while connecting to Facebook'
            },
            bottom: {
                unknown: 'This can normally be fixed<br />by <strong>reconnecting</strong> to Facebook',
                empty: 'No new profiles or pages found. You can<br />try logging out ' + 'of Facebook to add more accounts',
                permissions: 'In order to share to Facebook, you need to allow permissions to our app.'
            }
        },
        _twitterErrorModalCopy: {
            unknown: 'This can normally be fixed<br />by <strong>reconnecting</strong> to Twitter',
            limit: 'Tweet cannot be longer than 140 characters',
            duplicate: 'This tweet is a duplicate'
        },
        _pingInterval: 3 * 60 * 1000,
        _pingIntervalReference: null,
        _publisherUxConfig: null,
        _openModals: [],
        _startTime: Math.round(new Date().getTime() / 1000),
        _templatesTab: null,
        _textMaxWidthRatio: 0.95,
        _textTab: null,
        _timeouts: {
            browserUpgrade: 1000,
            ccProcessingStateDelay: 500,
            cookieNotice: 1000,
            disconnectingConnection: 2500,
            loadingApp: 500,
            loadingEmptyCanvas: 2000,
            loadingImages: 1250,
            loggingOut: 2500,
            remixingImage: 1500,
            resizing: 500,
            socialConnection: 2500,
            submittingForm: 2000,
            upgrading: 3000,
            watermarkAutoSaveDelay: 2500,
            watermarkCallout: 15000
        },
        _upsellModalCopy: {
            facebookConnections: 'Upgrade to connect more<br />than 1 Facebook profile',
            twitterConnections: 'Upgrade to connect more<br />than 1 Twitter profile',
            googleConnections: 'Upgrade to connect more<br />than 1 Google profile',
            delete: 'Go PRO to delete<br />your images',
            download: 'Go PRO to download<br />your images in HD',
            filters: 'Upgrade to use<br />PRO filters',
            pagination: 'Go PRO to view<br />all your images',
            fonts: 'Upgrade to use<br />PRO fonts',
            photos: 'Upgrade to use<br />PRO photos',
            templates: 'Upgrade to use<br />templates',
            redirectUrl: 'Upgrade to link images<br />back to your site',
            watermark: 'Go PRO to add<br />your logo'
        },
        _useSmartShare: false,
        _usingReservedFont: false,
        _usingReservedPhoto: false,
        _usingReservedTemplate: false,
        _watermarkTab: null,
        init: function(element, isGhost) {
            var
                _this = this;
            this._isGhost = typeof
            isGhost === 'undefined' ? false : isGhost;
            this._defaultImageDocumentJson.layers[0].styles.height = this._maximumCanvasDimensions.height;
            this._defaultImageDocumentJson.layers[0].styles.width = this._maximumCanvasDimensions.width;
            this._super(element);
            if (this.isFirefox() === true) {
                this._defaultImageDocumentJson.layers[1].styles.shadowColor = 'rgba(0,0,0,0)';
            }
            if (this._isGhost === false) {
                this._fontFamilies.sort(Sai.nameSort);
                this._addTemplateSaveEvent();
                this._addResizeEvents();
                this._addUndoEvent();
                this._addCreateButtonEvent();
                this._addTestButtonEvent();
                this._addBusinessButtonEvent();
                this._addInvitationButtonEvent();
                this._addTabToggleEvents();
                this._addCloseButtonEvent();
                this._addLockImageClickEvents();
                this._addPostMessageListeners();
                this._addDelayedReferralModalPrompt();
                this._setupPingInterval();
                setTimeout(function() {
                    var
                        config = Sai.get('config'),
                        errorImage = (new Image());
                    errorImage.src = 'https://' + (config.cloudfront.static) + '/static/app/images/backgrounds/milk2.png';
                }, 0);
                setTimeout(function() {
                    var
                        role = Sai.get('config').role;
                    if (role === 'local' || role === 'dev' || role === 'prod') {
                        _this._useSmartShare = true;
                    }
                }, 0);
                setTimeout(function() {
                    _this.trackEmbedType();
                    _this.trackFlow();
                    _this.trackRole();
                    if (Sai.get('loggedInUser') !== false) {
                        App().updateUserMpPeopleData();
                        App().mpIdentify(Sai.get('loggedInUser').id.toInt());
                    }
                    App().mpTrackEvent('App opened');
                }, 0);
                setTimeout(function() {
                    var
                        config = Sai.get('config');
                    filepicker.setKey(config.filepicker.key);
                }, 0);
                setTimeout(function() {
                    var
                        config = Sai.get('config');
                    Stripe.setPublishableKey(config.stripe.publishableKey);
                }, 0);
            }
        },
        _addCloseButtonEvent: function() {
            var
                _this = this;
            this._element.find('.closeButton').click(function(event) {
                event.preventDefault();
                _this.slideAppOutOfView();
            });
        },
        _addDelayedReferralModalPrompt: function() {
            var
                _this = this,
                interval = setInterval(function() {
                    if (typeof $.cookie('referralModalSeen') === 'undefined' && _this.userIsPro() && Sai.get('loggedInUser').stripeCustomerId !== '') {
                        clearInterval(interval);
                        _this.showReferralModal();
                    }
                }, 3 * 60 * 1000);
        },
        _addPostMessageListeners: function() {
            var
                _this = this,
                listener = function(event) {
                    var
                        check = Sai.get('referer') && Sai.get('referer').indexOf(event.origin) === 0;
                    if (check === true) {
                        var
                            data = JSON.parse(event.data);
                        if (data.action === 'open') {
                            _this.slideAppIntoView();
                        } else
                        if (data.action === 'close') {
                            _this.slideAppOutOfView();
                        }
                    }
                };
            if (window.addEventListener) {
                addEventListener('message', listener, false);
            } else {
                attachEvent('onmessage', listener);
            }
        },
        _addUndoEvent: function() {
            var
                _this = this;
            this._element.find('#undoBtn').click(function(event) {
                event.preventDefault();
                _this.undoChange();
            });
        },
        _addTemplateSaveEvent: function() {
            var
                _this = this;
            this._element.find('#saveToTemplates a').click(function(event) {
                event.preventDefault();
                if (App().userIsPro() === true) {
                    App().saveImageAsTemplate();
                } else {
                    App().showUpsellModal('templates');
                }
            });
        },
        saveImageAsTemplate: function() {
            App().createImage(true);
        },
        _addResizeEvents: function() {
            var
                _this = this,
                $dropdown = this._element.find('[name="resize"]');
            $dropdown.selectpicker({
                container: 'body'
            });
            $dropdown.change(function(event) {
                var
                    val = $(this).val(),
                    imageDocument = _this._imageDocument,
                    backgroundLayer = imageDocument.getBackgroundLayer(),
                    width = _this._canvasDimensionsLimit.width,
                    height = _this._canvasDimensionsLimit.height;
                event.preventDefault();
                if (val === 'wide') {
                    height = Math.floor(width / 2);
                } else
                if (val === 'tall') {
                    width = Math.ceil(height / 2);
                } else
                if (val === 'square') {
                    width = height;
                }
                _this._maximumCanvasDimensions = {
                    width: width,
                    height: height
                };
                _this.resize(val === 'original');
                _this._resetSizeCopy();
                App().getElement().find('#createImageBtn').first().focus();
                App().getElement().find('#createImageBtn').first().blur();
            });
            this._resetSizeCopy();
        },
        _addWatermarkCalloutEvents: function() {
            return;
            var
                $callout = this._element.find('.watermarkCallout');
            $callout.tooltip({
                container: '#editor',
                trigger: 'manual'
            }).tooltip('show');
            $callout.data('bs.tooltip').$tip.addClass('watermarkCalloutTooltip');
            var
                cookieCallback = function() {
                    $.cookie('watermarkCalloutHasBeenSeen', '1', {
                        path: '/',
                        domain: '.' + (location.host)
                    });
                };
            $callout.data('bs.tooltip').$tip.find('a.closeLink').click(function(event) {
                event.preventDefault();
                $callout.tooltip('destroy');
                cookieCallback();
            });
            $callout.data('bs.tooltip').$tip.find('a.blue').click(function(event) {
                event.preventDefault();
                App().showUpsellModal('watermark');
                $callout.tooltip('destroy');
                cookieCallback();
                App().trackEvent('Watermark Callout', 'clicked', 'app');
                App().mpTrackEvent('Watermark callout clicked', {});
            });
        },
        _addBusinessButtonEvent:function() {
             var
                _this = this;
            this._element.find('#business').click(function(event) {
                event.preventDefault();
              //  alert("business btn clicked");
                 var
                html = _.template(_this.getTemplate('tabs', 'templates_business'), {});
               
                 templateElements = $(jQuery.parseHTML(html.trim())),//this will trim some html and get us the html 
                tabElement = App().getElement().find('div.templatesTab');
            tabElement.html(templateElements);//ippudu em chesa. instead of adding elements. i am ?just populating. i am not appending. got it?
            _this._templatesTab = (new TemplatesTabView(tabElement));
            App().showTemplatesTab();
            return;
            });
        },
        _addInvitationButtonEvent:function() {
             var
                _this = this;
            this._element.find('#invitation').click(function(event) {
                event.preventDefault();
         //       alert("invitation btn clicked");
                 var
                html = _.template(_this.getTemplate('tabs', 'templates_invitation'), {});
                 templateElements = $(jQuery.parseHTML(html.trim())),//this will trim some html and get us the html 
                tabElement = App().getElement().find('div.templatesTab');
            tabElement.html(templateElements);//ippudu em chesa. instead of adding elements. i am ?just populating. i am not appending. got it?
            _this._templatesTab = (new TemplatesTabView(tabElement));
            App().showTemplatesTab();
            return;
            });
        },
         _addTestButtonEvent: function() {
            var
                _this = this;
            this._element.find('#testBtn').click(function(event) {
                event.preventDefault();
             //   console.log("tst");
        //   alert("test in event");
             Sai.set("test",122345678);
               var
                html = _.template(_this.getTemplate('tabs', 'templates'), {});//
                //above line gets what template . which tell fast templatesTabTemplate yes. got it aa? one line ala flow chuskovali.ok
                //lets see what gettemplate is doing okk
                //why ask .  so why ante. i want to redraw the thumbs.y. test ane button will say invitationthen invitations will 
                //be populated. if we say business then business thumbs have to come. already i am able to redraw the template area. 
                //template area is the thumbs area. but i am just putting the same html. this function and all functions in this 
                //are js functions that get templates and draw the element and attach the events. vv imp if u dont understand u cant do it 
               //draw elements ante text ah on . thumbs? no any functio in this like lets say createbutton
               //that will get template of create button which will have image and then put it in dom and then attach events like backbone this is 
               //template ante html + js so that u dont need to string concatenate. same old concepts be strong in them. 
               //ok. baga ardam ainda. sarley we will see this first. 
               //chusthunna they are setting and getin i wanna see if i can do the same.
                templateElements = $(jQuery.parseHTML(html.trim())),//this will trim some html and get us the html 
                tabElement = App().getElement().find('div.templatesTab');
            tabElement.html(templateElements);//ippudu em chesa. instead of adding elements. i am ?just populating. i am not appending. got it?
            _this._templatesTab = (new TemplatesTabView(tabElement));
            App().showTemplatesTab();
            //this function gets templateTabTemplate and puts the template, template2 variables data and puts it in which element 
            //i meant which div in dom templatetabtemplate2 lo peduthundi. no honey it gets the template html 
            //that way we dont need to string concatenate. andulo pettadu ye line lo techindi . 27021 ok gud 
            //next em chsindi ye div lo pedthundi abbaa 
            //template is not div . template just makes it easy to build html. it wont show up in dom in backbone like if u remember movies 
            //ye div lo pedthundi . .html ekkada undi adi chudu chalu easy . dont overthink it easy . 
            //teemplateements so what is templateelements div.templatesTab. comon honey dont be so dumb. 
               
                return;
            });
         },
        _addCreateButtonEvent: function() {
            var
                _this = this;
            this._element.find('#createImageBtn').click(function(event) {
                event.preventDefault();
                        //javascript:void(window.open().location = "http://thunderify.com/createit.php?form_dataurl=document.getElementsByTagName("canvas")[0].toDataURL("image/png"));
                var image = document.getElementsByTagName("canvas")[0].toDataURL("image/png");
                App().showCanvasModal(image);
      
            //  var canvas = document.getElementsByTagName("canvas")[0];

              //  $("#picture").html('<img src="'+image+'"/>'); 
                return;
               
                if (Sai.get('publisher') !== false) {
                    _this.createPublisherImage();
                } else {
                    if (_this.userIsPro() === false && _this._usingReservedPhoto === true) {
                        _this.showUpsellModal('photos');
                    } else {
                        if (_this.userIsPro() === false && _this._usingReservedFont === true) {
                            _this.showUpsellModal('fonts');
                        } else {
                            if (_this.userIsPro() === false && _this._usingReservedTemplate === true) {
                                _this.showUpsellModal('templates');
                            } else {
                                if (Sai.get('loggedInUser') !== false) {
                                    _this._createImageOrPromptForDeliquency();
                                } else {
                                    _this.setConnectCallback(jQuery.proxy(_this._createImageOrPromptForDeliquency, _this));
                                    _this.showConnectModal('register', 'create');
                                }
                            }
                        }
                    }
                }
            });
        },
        _addLockImageClickEvents: function() {
            var
                _this = this;
            this._element.find('#preview .fontUpgradeLock').click(function(event) {
                event.preventDefault();
                App().showUpsellModal('fonts');
            });
            this._element.find('#preview .photoUpgradeLock').click(function(event) {
                event.preventDefault();
                App().showUpsellModal('photos');
            });
            this._element.find('#preview .templateUpgradeLock').click(function(event) {
                event.preventDefault();
                App().showUpsellModal('templates');
            });
        },
        _addTabToggleEvents: function() {
            var
                _this = this;
            this._element.find('ul.tabs li a').click(function(event) {
                event.preventDefault();
                var
                    href = $(this).attr('href'),
                    tabName = href.replace('#', '');
                _this._currentTab = tabName;
                _this.showCurrentTab();
            });
        },
        _clearCanvas: function(drawingTemplate) {
            this._canvas.getElement().removeLayers();
            this._canvas.getElement().drawLayers();
            this._canvas.getElement().clearCanvas();
            this._element.find('div#settings div#background').contents().remove();
            this._element.find('div#settings div.textTab').contents().remove();
            this._element.find('div#settings div.filtersTab').contents().remove();
            this._element.find('div#settings div.watermarkTab').contents().remove();
            if (!drawingTemplate) {
                this._element.find('div#settings div.backgroundTab').contents().remove();
                this._element.find('div#settings div.templatesTab').contents().remove();
            }
            this._element.find('canvas').remove();
            delete
            this._canvas;
        },
        _cookiesEnabled: function() {
            var
                enabled = (navigator.cookieEnabled) ? true : false;
            if (typeof navigator.cookieEnabled == 'undefined' && !enabled) {
                document.cookie = 'canary';
                enabled = (document.cookie.indexOf('canary') != -1) ? true : false;
            }
            return enabled;
        },
        _createImageOrPromptForDeliquency: function() {
            var
                userObj = Sai.get('loggedInUser');
            if (userObj.stripeIsDeliquent.toInt() === 1) {
                this.showAlertModal('deliquent');
            } else {
                this.createImage();
            }
        },
        _resetSizeCopy: function() {
            var
                $current = this._element.find('.resizeDropdownWrapper').find('.filter-option.pull-left'),
                currentCopy = $current.text();
            $current.text(currentCopy.split(' ').shift());
        },
        _resetWatermarkToUsers: function(callback) {
            var
                watermarkLayer = this._imageDocument.getWatermarkLayer();
            watermarkLayer.removeFromImageDocument();
            watermarkLayer.getDrawing().removeFromCanvas();
            var
                watermarkJson = JSON.parse(Sai.get('loggedInUser').watermarkJson),
                newLayer = (new WatermarkLayer(watermarkJson));
            this._imageDocument.addLayer(newLayer);
            newLayer.getDrawing().draw(function() {
                newLayer.getDrawing().bringToFront();
                newLayer.getDrawing().makeDraggable();
                callback && callback();
            });
        },
        _setupPingInterval: function() {
            var
                _this = this;
            this._pingIntervalReference = setInterval(function() {
                jQuery.get('./ping.php', {
                    _: $.now()
                }, function(response) {
                    if (response.success === true) {
                        Sai.set('csrfToken', response.data.csrfToken);
                        _this._element.find('input[name="csrfToken"]').val(response.data.csrfToken);
                    } else {
                        if (_this.siteHasBeenLocked(response)) {
                            _this.showLockedModal();
                        }
                    }
                }, 'json').fail(function() {
                 //   _this.showErrorModal(false, 'j1lk');
                });
            }, this._pingInterval);
        },
        addToCallStack: function() {},
        resetCallStack: function() {
            this._changeStack = [];
        },
        closeAlertModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === AlertModalView) {
                    modalView.close();
                }
            });
        },
        closeBusyModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === BusyModalView) {
                    modalView.close();
                }
            });
        },
        closeCategoryModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === CategoryModalView) {
                    modalView.close();
                }
            });
        },
        closeCC0Modal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === CC0ModalView) {
                    modalView.close();
                }
            });
        },
        closeReferralModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === ReferralModalView) {
                    modalView.close();
                }
            });
        },
        closeConfirmModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === ConfirmModalView) {
                    modalView.close();
                }
            });
        },
        closeCouponCodeModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === CouponCodeModalView) {
                    modalView.close();
                }
            });
        },
        closeCouponModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === CouponModalView) {
                    modalView.close();
                }
            });
        },
        closeCustomUrlModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === CustomUrlModalView) {
                    modalView.close();
                }
            });
        },
        closeFacebookShareModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === FacebookShareModalView) {
                    modalView.close();
                }
            });
        },
        closeOpenModals: function() {
            $(this._openModals).each(function(index, modalView) {
                modalView.close();
            });
        },
        closePendingModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === PendingModalView) {
                    modalView.close();
                }
            });
        },
        closePhotoEditModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === PhotoEditModalView) {
                    modalView.close();
                }
            });
        },
        closeTwitterShareModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === TwitterShareModalView) {
                    modalView.close();
                }
            });
        },
        closeUpsellModal: function() {
            $(this._openModals).each(function(index, modalView) {
                if (modalView.constructor === UpsellModalView) {
                    modalView.close();
                }
            });
        },
        undoChange: function() {
            var
                _this = this,
                lastImageJson = this._changeStack.pop();
            this.setImageDocumentJson(lastImageJson);
            log(lastImageJson);
            this.redrawImage(function() {
                setTimeout(function() {
                    _this._footer.show();
                    setTimeout(function() {
                        _this._canvas.getElement().removeClass('hidden');
                    }, 0);
                }, _this._timeouts.remixingImage);
            });
        },
        createImage: function(savingAsTemplate) {
            var
                _this = this,
                data = {
                    csrfToken: Sai.get('csrfToken'),
                    documentJson: this.getImageDocument().exportToJsonString(),
                    imageString: this.getImageDocument().exportToImageString(),
                    secondsToCreate: Sai.getUnixTimestamp() - this._startTime
                };
            var
                busyModalCopyKey = 'creatingImage',
                showRandomTip = true;
            if (savingAsTemplate) {
                data.userTemplating = 1;
                data.isUserTemplate = 1;
                busyModalCopyKey = 'savingImageAsTemplate';
                showRandomTip = false;
            }
            data['stat-embedType'] = '';
            data['stat-flow'] = '';
            if (typeof query.get('embedType') !== 'undefined') {
                data['stat-embedType'] = query.get('embedType');
            }
            if (typeof query.get('flow') !== 'undefined') {
                data['stat-flow'] = query.get('flow');
            }
            if (Sai.get('sourceUrl') !== false) {
                data.sourceUrl = Sai.get('sourceUrl');
                Sai.set('sourceUrl', false);
            }
            if (Sai.get('sourceImage') !== false) {
                data.sourceImageId = Sai.get('sourceImage').id;
            }
            this.showBusyModal(busyModalCopyKey, showRandomTip);
            var
                previous = (new Date()).getTime();
            jQuery.post('/images', data, function(response) {
                if (response.success === true) {
                    Sai.set('hdImageCreated', false);
                    var
                        callback = function() {
                            _this.trackEvent('Image', 'created', 'app');
                            App().mpTrackEvent('Image created', {
                                _source: 'app',
                                _url: response.data.image.url
                            });
                            var
                                imageObj = response.data.image,
                                userObj = response.data.user;
                            Sai.set('loggedInUser', userObj);
                            App().updateUserMpPeopleData();
                            var
                                img = (new Image());
                            img.onload = function() {
                                var
                                    interval = setInterval(function() {
                                        var
                                            now = (new Date()).getTime();
                                        if ((now - previous) > 3500) {
                                            clearInterval(interval);
                                            if (typeof query.get('hasSaveCallback') !== 'undefined' && query.get('hasSaveCallback').toInt() === 1) {
                                                var
                                                    urls = {
                                                        standard: imageObj.cloudfrontUrl
                                                    };
                                                if (typeof query.get('saveAsHd') !== 'undefined' && query.get('saveAsHd').toInt() === 1) {
                                                    urls.hd = imageObj.cloudfrontUrl.replace(/\.net\//, '.net/hd.');
                                                }
                                                var
                                                    formattedImageObj = {
                                                        urls: urls,
                                                        text: imageObj.text
                                                    },
                                                    data = {
                                                        action: 'saveCallback',
                                                        data: formattedImageObj
                                                    };
                                                window.parent.postMessage(JSON.stringify(data), '*');
                                            } else {
                                                _this.closeOpenModals();
                                                if (savingAsTemplate) {
                                                    Sai.set('userTemplates', response.data.userTemplates);
                                                    App().showTemplatesTab();
                                                    App()._templatesTab.drawUserResourceTab();
                                                    App()._templatesTab.showUserTemplatesTab();
                                                    App().showAlertModal('templateSaved');
                                                } else {
                                                    var
                                                        user = Sai.get('loggedInUser');
                                                    if (_this._useSmartShare === true) {
                                                        _this.showSmartShareModal(imageObj);
                                                    } else {
                                                        _this.showShareModal(imageObj);
                                                    }
                                                }
                                            }
                                        }
                                    }, 50);
                            };
                            img.src = imageObj.displayUrl;
                        };
                    if (_this._useSmartShare === true) {
                        (new Ghost(function(imageString) {
                            callback();
                            jQuery.post('/images/' + (response.data.image.id) + '/hd', {
                                csrfToken: Sai.get('csrfToken'),
                                imageString: imageString
                            }, function(response) {
                                if (response.success === true) {
                                    Sai.set('hdImageCreated', true);
                                } else {
                                    if (App().siteHasBeenLocked(response)) {
                                        App().showLockedModal();
                                    } else {
                                        App().showErrorModal(false, response.failedRules[0].error.reference);
                                    }
                                }
                            }, 'json').fail(function() {
                                App().showErrorModal(false, 'mak5');
                            });
                        }));
                    } else {
                        callback();
                    }
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        _this.showErrorModal(false, response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                _this.showErrorModal(false, 'u2n3');
            });
        },
        createPublisherImage: function() {
            var
                _this = this,
                data = {
                    csrfToken: Sai.get('csrfToken'),
                    documentJson: this.getImageDocument().exportToJsonString(),
                    imageString: this.getImageDocument().exportToImageString(),
                    publisherId: Sai.get('publisher').id,
                    secondsToCreate: Sai.getUnixTimestamp() - this._startTime
                };
            data['stat-embedType'] = '';
            data['stat-flow'] = '';
            if (typeof query.get('embedType') !== 'undefined') {
                data['stat-embedType'] = query.get('embedType');
            }
            if (typeof query.get('flow') !== 'undefined') {
                data['stat-flow'] = query.get('flow');
            }
            if (Sai.get('sourceUrl') !== false) {
                data.sourceUrl = Sai.get('sourceUrl');
            }
            this.showBusyModal('creatingPublisherImage');
            var
                previous = (new Date()).getTime();
            jQuery.post('/images', data, function(response) {
                if (response.success === true) {
                    Sai.set('hdImageCreated', false);
                    var
                        callback = function() {
                            _this.trackEvent('Image', 'created', 'publisher');
                            App().mpTrackEvent('Image created', {
                                _source: 'publisher'
                            });
                            var
                                imageObj = response.data.image,
                                publisherObj = response.data.publisher;
                            Sai.set('publisher', publisherObj);
                            var
                                img = (new Image());
                            img.onload = function() {
                                var
                                    interval = setInterval(function() {
                                        var
                                            now = (new Date()).getTime();
                                        if ((now - previous) > 3500) {
                                            clearInterval(interval);
                                            if (typeof query.get('hasSaveCallback') !== 'undefined' && query.get('hasSaveCallback').toInt() === 1) {
                                                var
                                                    urls = {
                                                        standard: imageObj.cloudfrontUrl
                                                    };
                                                if (typeof query.get('saveAsHd') !== 'undefined' && query.get('saveAsHd').toInt() === 1) {
                                                    urls.hd = imageObj.cloudfrontUrl.replace(/\.net\//, '.net/hd.');
                                                }
                                                var
                                                    formattedImageObj = {
                                                        urls: urls,
                                                        text: imageObj.text
                                                    },
                                                    data = {
                                                        action: 'saveCallback',
                                                        data: formattedImageObj
                                                    };
                                                window.parent.postMessage(JSON.stringify(data), '*');
                                            } else {
                                                _this.closeOpenModals();
                                                _this.showShareModal(imageObj);
                                            }
                                        }
                                    }, 50);
                            };
                            img.src = imageObj.displayUrl;
                        };
                    if (typeof query.get('saveAsHd') !== 'undefined' && query.get('saveAsHd').toInt() === 1) {
                        (new Ghost(function(imageString) {
                            jQuery.post('/images/' + (response.data.image.id) + '/hd', {
                                csrfToken: Sai.get('csrfToken'),
                                imageString: imageString
                            }, function(response) {
                                if (response.success === true) {
                                    callback();
                                    Sai.set('hdImageCreated', true);
                                } else {
                                    if (App().siteHasBeenLocked(response)) {
                                        App().showLockedModal();
                                    } else {
                                        App().showErrorModal(false, response.failedRules[0].error.reference);
                                    }
                                }
                            }, 'json').fail(function() {
                                App().showErrorModal(false, 'mak5');
                            });
                        }));
                    } else {
                        callback();
                    }
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        _this.showErrorModal(false, response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                _this.showErrorModal(false, '8b5b');
            });
        },
        drawBackgroundControl: function() {
            var
                html = _.template(this.getTemplate('controls', 'background'), {
                    layer: this.getImageDocument().getBackgroundLayer()
                });
            var
                templateElements = $(jQuery.parseHTML(html.trim())),
                backgroundElement = this._element.find('div#background');
            backgroundElement.append(templateElements);
            this._backgroundControl = (new BackgroundControlView(backgroundElement));
        },
        drawCanvas: function() {
            var
                html = _.template(this.getTemplate('canvas'), {
                    width: this._imageDocument.getBackgroundLayer().getStyle('width'),
                    height: this._imageDocument.getBackgroundLayer().getStyle('height')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#preview').append(element);
            return (new CanvasView(element));
        },
        drawCloudinaryImageAsBackgroundLayer: function(sourceSrc, callback, fit, trackAsUpload) {
        	
      //  alert(2);
            var
                _this = this,
                resizedImg = (new Image()),
                maximumCanvasDimensions = this._maximumCanvasDimensions;
            if (App().userIsLoggedIn() === true && trackAsUpload === true) {
                App().trackUpload(sourceSrc);
            }
            var
                resizedSrc = App().getCloudinaryUrl(sourceSrc, {
                    width: maximumCanvasDimensions.width,
                    height: maximumCanvasDimensions.height,
                    fit: fit
                }, true);
            resizedImg.onload = function() {
                var
                    backgroundLayer = _this._imageDocument.getBackgroundLayer();
                backgroundLayer.removeFromImageDocument();
                backgroundLayer.getDrawing().removeFromCanvas();
                var
                    dimensions = resizedImg.getFittedDimensions(maximumCanvasDimensions);
                var
                    properties = {
                        isBackground: true,
                        type: 'image',
                        filters: [],
                        sourceSrc: sourceSrc,
                        resizedSrc: resizedSrc,
                        styles: {
                            height: dimensions.height,
                            width: dimensions.width,
                            x: 0,
                            y: 0
                        }
                    },
                    newLayer = (new ImageLayer(properties));
                _this._imageDocument.addLayer(newLayer);
               // _this.getFiltersTab().enable();
               // _this.getFiltersTab().reset();
                newLayer.getDrawing().draw(function() {
                    newLayer.getDrawing().sendToBack();
                    _this.getCanvas().resize();
                    callback();
                });
            };
            resizedImg.src = resizedSrc;
        },
        drawFiltersTab: function() {
            var
                html = _.template(this.getTemplate('tabs', 'filters'), {
                    layer: this.getImageDocument().getBackgroundLayer()
                }),
                templateElements = $(jQuery.parseHTML(html.trim())),
                tabElement = App().getElement().find('div.filtersTab');
            tabElement.append(templateElements);
            this._filtersTab = (new FiltersTabView(tabElement));
            this._filtersTab.enable();
            if (this.getImageDocument().getBackgroundLayer().getProperty('type') === 'rectangle') {
                this._filtersTab.disable();
            }
        },
        drawFooter: function() {
            var
                userObj = Sai.get('loggedInUser'),
                html = _.template(this.getTemplate('footer'), {
                    config: Sai.get('config'),
                    user: userObj
                }),
                element = $(jQuery.parseHTML(html.trim()));
        //    this._element.find('div#wrapper').append(element);
            this._footer = (new FooterView(element));
            //this._footer.update();
            this._footer.hide();
        },
        drawFPImageAsBackgroundLayer: function(sourceSrc, fit, callback) {
            var
                _this = this,
                resizedImg = (new Image()),
                maximumCanvasDimensions = this._maximumCanvasDimensions,
                resizedSrc = (sourceSrc) + '/convert' + '?w=' + (maximumCanvasDimensions.width) + '&h=' + (maximumCanvasDimensions.height) + '&fit=' + (fit);
            resizedImg.onload = function() {
                var
                    backgroundLayer = _this._imageDocument.getBackgroundLayer();
                backgroundLayer.removeFromImageDocument();
                backgroundLayer.getDrawing().removeFromCanvas();
                var
                    dimensions = resizedImg.getFittedDimensions(maximumCanvasDimensions);
                var
                    properties = {
                        isBackground: true,
                        type: 'image',
                        filters: [],
                        sourceSrc: sourceSrc,
                        resizedSrc: resizedSrc,
                        styles: {
                            height: dimensions.height,
                            width: dimensions.width,
                            x: 0,
                            y: 0
                        }
                    },
                    newLayer = (new ImageLayer(properties));
                _this._imageDocument.addLayer(newLayer);
           //     _this.getFiltersTab().enable();
           //     _this.getFiltersTab().reset();
                newLayer.getDrawing().draw(function() {
                    newLayer.getDrawing().sendToBack();
                    _this.getCanvas().resize();
                    callback && callback();
                    _this.closeOpenModals();
                    _this._footer.show();
                });
            };
            resizedImg.src = resizedSrc;
        },
        drawFPImageAsWatermarkLayer: function(sourceSrc, callback) {
            var
                _this = this,
                resizedImg = (new Image()),
                watermarkLayer = _this._imageDocument.getWatermarkLayer(),
                previousSize = watermarkLayer.getProperty('size'),
                maximumWatermarkDimensions = this._maximumWatermarkDimensions[previousSize],
                resizedSrc = (sourceSrc) + '/convert' + '?w=' + (maximumWatermarkDimensions.width) + '&h=' + (maximumWatermarkDimensions.height) + '&fit=max';
            this.getWatermarkTab().turnSwitchOn();
            resizedImg.onload = function() {
                var
                    previousXPoisition = watermarkLayer.getStyle('x'),
                    previousYPoisition = watermarkLayer.getStyle('y');
                watermarkLayer.removeFromImageDocument();
                watermarkLayer.getDrawing().removeFromCanvas();
                previousXPoisition = 'left';
                previousYPoisition = 'bottom';
                var
                    dimensions = resizedImg.getFittedDimensions(maximumWatermarkDimensions);
                var
                    properties = {
                        filters: [{
                            properties: {
                                strength: 100
                            },
                            type: 'opacity'
                        }],
                        isWatermark: true,
                        resizedSrc: resizedSrc,
                        size: previousSize,
                        sourceSrc: sourceSrc,
                        styles: {
                            height: dimensions.height,
                            width: dimensions.width,
                            visible: true,
                            x: previousXPoisition,
                            y: previousYPoisition
                        },
                        type: 'image'
                    },
                    newLayer = (new WatermarkLayer(properties));
                _this._imageDocument.addLayer(newLayer);
                newLayer.getDrawing().draw(function() {
                    newLayer.getDrawing().bringToFront();
                    newLayer.getDrawing().makeDraggable();
                    callback();
                    _this.closeOpenModals();
                    _this._footer.show();
                });
            };
            resizedImg.src = resizedSrc;
        },
        drawImage: function(callback, canvas, drawingTemplate) {
            canvas = canvas || this._canvas;
            var
                _this = this;
            canvas.drawBackgroundLayer(function() {
                canvas.drawImageLayers(function() {
                    canvas.drawRectangleLayers();
                    canvas.alignRuleRectangleLayers();
                    canvas.alignInstagramOverlayRectangleLayers();
                    canvas.alignTwitterOverlayRectangleLayers();
                    canvas.drawRuleRectangleLayers();
                    canvas.drawInstagramOverlayRectangleLayers();
                    canvas.drawTwitterOverlayRectangleLayers();
                    canvas.drawTextLayers();
                    _this.drawBackgroundControl();
                    _this.drawTextTab();
                   // _this.drawFiltersTab();
                    _this.drawWatermarkTab();
                    if (_this._isGhost === false && !drawingTemplate) {
                        _this.drawBackgroundTab();
                        _this.drawTemplatesTab();
                    }
                    var
                        watermarkLayer = _this._imageDocument.getWatermarkLayer();
                    watermarkLayer.getDrawing().bringToFront();
                    if (Sai.get('publisher') === false && App().userIsPro() == true) {
                        watermarkLayer.getDrawing().makeDraggable();
                    }
                    callback();
                });
            });
        },
        drawBackgroundTab: function() {
            var
                _this = this;
//            jQuery.get('./photos.php', {}, function(response) {
//                if (response.success === true) {
//                    Sai.set('photos', response.data.photos);
//                    var
//                        html = _.template(_this.getTemplate('tabs', 'background'), {}),
//                        templateElements = $(jQuery.parseHTML(html.trim())),
//                        tabElement = App().getElement().find('div.backgroundTab');
//                    tabElement.append(templateElements);
//                    _this._backgroundTab = (new BackgroundTabView(tabElement));
//                } else {
//                    if (App().siteHasBeenLocked(response)) {
//                        App().showLockedModal();
//                    } else {
//                        App().showErrorModal(false, response.failedRules[0].error.reference);
//                    }
//                }
//            }, 'json').fail(function() {
//                App().showErrorModal(false, 'z1jk');
//            });
        },
        drawTemplatesTab: function() {
            var
                html = _.template(this.getTemplate('tabs', 'templates'), {}),
                templateElements = $(jQuery.parseHTML(html.trim())),
                tabElement = App().getElement().find('div.templatesTab');
            tabElement.append(templateElements);
            this._templatesTab = (new TemplatesTabView(tabElement));
        },
        drawTextTab: function() {
            var
                html = _.template(this.getTemplate('tabs', 'text'), {}),
                templateElements = $(jQuery.parseHTML(html.trim())),
                tabElement = App().getElement().find('div.textTab');
            tabElement.append(templateElements);
            this._textTab = (new TextTabView(tabElement));
        },
        drawWatermarkTab: function() {
            var
                html = _.template(this.getTemplate('tabs', 'watermark'), {
                    watermarkLayer: this.getImageDocument().getWatermarkLayer()
                }),
                templateElements = $(jQuery.parseHTML(html.trim())),
                tabElement = App().getElement().find('div.watermarkTab');
            tabElement.append(templateElements);
            this._watermarkTab = (new WatermarkTabView(tabElement));
            this._watermarkTab.enable();
            if (Sai.get('loggedInUser') === false || Sai.get('loggedInUser').isPro.toInt() === 0) {}
        },
        getBackgroundControl: function() {
            return this._backgroundControl;
        },
        getBackgroundTab: function() {
            return this._backgroundTab;
        },
        getCanvas: function() {
            return this._canvas;
        },
        getCloudinaryUrl: function(sourceSrc, properties, proxy) {
            var
                height = Math.floor(properties.height),
                width = Math.floor(properties.width),
                fit = properties.fit,
                path = sourceSrc.replace(/upload\//, ('upload/' + 'c_' + (fit) + ',' + 'h_' + (height) + ',' + 'w_' + (width) + '/'));
            if (typeof proxy !== 'undefined' && proxy === true) {
                path = path.replace('res.cloudinary.com', Sai.get('config').cloudfront.cloudinary);
            }
            return path;
        },
        getFilepickerUrl: function(sourceSrc, properties) {
            var
                height = Math.floor(properties.height),
                width = Math.floor(properties.width),
                fit = properties.fit;
            return (sourceSrc) ;//+ '/convert?w=' + (width) + '&h=' + (height) + '&' + 'fit=crop';
        },
        getConnectCallback: function() {
            return this._callbacks.connect;
        },
        getDefaultLineHeight: function() {
            return this._defaultLineHeight;
        },
        getTextMaxWidthRatio: function() {
            return this._textMaxWidthRatio;
        },
        getFontFamilies: function() {
            return this._fontFamilies.slice();
        },
        getFontFamily: function(fontFamily) {
            var
                found = false;
            $(this._fontFamilies).each(function(index, font) {
                if (fontFamily === font.name) {
                    found = font;
                }
            });
            return found;
        },
        getFooter: function() {
            return this._footer;
        },
        getFiltersTab: function() {
            return this._filtersTab;
        },
        getImageDocument: function() {
            return this._imageDocument;
        },
        getInitialImageDocumentJson: function(processQueryParams) {
            var
                imageDocumentJson = jQuery.extend(true, {}, this._defaultImageDocumentJson),
                watermarkJson = jQuery.extend(true, {}, Sai.get('config').watermark);
            if (Sai.get('publisher') !== false) {
                if (Sai.get('sourceImage') !== false) {
                    imageDocumentJson = JSON.parse(Sai.get('sourceImage').documentJson);
                } else {
                    imageDocumentJson = JSON.parse(Sai.get('publisher').imageTemplate.documentJson);
                }
                watermarkJson = JSON.parse(Sai.get('publisher').adminUser.watermarkJson);
            } else
            if (Sai.get('sourceImage') !== false) {
                imageDocumentJson = JSON.parse(Sai.get('sourceImage').documentJson);
                if (Sai.get('loggedInUser') !== false) {
                    watermarkJson = JSON.parse(Sai.get('loggedInUser').watermarkJson);
                }
            } else {
                if (Sai.get('loggedInUser') !== false) {
                    watermarkJson = JSON.parse(Sai.get('loggedInUser').watermarkJson);
                }
            }
            if (processQueryParams === true) {
                var
                    sourceUrl = query.get('sourceUrl');
                Sai.set('sourceUrl', sourceUrl);
                var
                    referer = query.get('referer');
                Sai.set('referer', referer);
                var
                    text = query.get('text');
                if (typeof text === 'undefined') {
                    text = [];
                } else {
                    if (typeof text === 'string') {
                        text = [text];
                    } else {
                        var
                            pieces = [];
                        $(text).each(function(index, val) {
                            if (index < 2) {
                                pieces.push(val);
                            }
                        });
                        text = pieces;
                    }
                }
                var
                    lastTextLayer;
                if (text.length > 0) {
                    var
                        textStr;
                    $(imageDocumentJson.layers).each(function(index, layer) {
                        if (layer.type === 'text') {
                            lastTextLayer = layer;
                            textStr = text.shift();
                            if (typeof textStr === 'undefined') {
                                imageDocumentJson.layers.splice(index, 1);
                            } else {
                                layer.styles.text = textStr;
                            }
                        }
                    });
                    if (text.length > 0) {
                        var
                            newTextLayer;
                        $(text).each(function(index, val) {
                            newTextLayer = jQuery.extend(true, {}, lastTextLayer);
                            newTextLayer.styles.text = val;
                            imageDocumentJson.layers.push(newTextLayer);
                        });
                    }
                }
                var
                    config = query.get('config');
                if (typeof config !== 'undefined') {
                    config = JSON.parse(config);
                    this._publisherUxConfig = (new PublisherUxConfig(config));
                    (new ConfigStyleBlock(this._publisherUxConfig.getAll())).insert();
                }
            }
            imageDocumentJson.layers.push(watermarkJson);
            return imageDocumentJson;
        },
        getMaximumCanvasDimensions: function() {
            return this._maximumCanvasDimensions;
        },
        upscaleMaximumCanvasDimensions: function() {
            return {
                width: this._maximumCanvasDimensions.width * 2,
                height: this._maximumCanvasDimensions.height * 2
            };
        },
        getMaximumWatermarkDimensions: function(size) {
            return this._maximumWatermarkDimensions[size];
        },
        getOpenModals: function() {
            return this._openModals;
        },
        getPublisherUxConfig: function() {
            return this._publisherUxConfig;
        },
        getRandomTip: function() {
            var
                numberOfOptions = this._tips.length;
            return this._tips[Math.floor((Math.random() * numberOfOptions))];
        },
        getRequiredFacebookPermissions: function() {
            return ['manage_pages', 'read_insights', 'publish_actions'];
        },
        getTemplate: function() {
            var
                args = arguments,//arguments passed to the function. we can pass any number of arguments this way 
                //we dint put function(arg1, arg2) ade adugudama nukunna
                ref = this.getTemplates();//calling gettemplates 
            $(args).each(function(index, arg) { //first time index is 0 and arg is tabs and second time index is 1 and arg is template
                ref = ref[arg];//vvv imp first time ref is getTemplates.tabs .. second time ref is vv imp tell getTemplates.tabs.template ok so 
                //wat is the value tell now. from below function
            });
            return ref;
            
            
        },
        getTemplates: function() {//get templates is here. getTemplate('tabs', 'templates'),
            return {
                admin: {
                    categories: this._element.find('#categoriesAdminTemplate').html(),
                    coupons: this._element.find('#couponsAdminTemplate').html(),
                    images: this._element.find('#imagesAdminTemplate').html(),
                    photos: this._element.find('#photosAdminTemplate').html(),
                    users: this._element.find('#usersAdminTemplate').html()
                },
                canvas: this._element.find('#canvasTemplate').html(),
                controls: {
                    background: this._element.find('#backgroundControlTemplate').html(),
                    text: this._element.find('#textControlTemplate').html()
                },
                emails: {
                    share: this._element.find('#shareEmailTemplate').html(),
                },
                footer: this._element.find('#footerTemplate').html(),
                images: this._element.find('#imagesTemplate').html(),
                modals: {
                    account: this._element.find('#accountModalTemplate').html(),
                    alert: this._element.find('#alertModalTemplate').html(),
                    cC0: this._element.find('#cC0ModalTemplate').html(),
                    browserUpgrade: this._element.find('#browserUpgradeModalTemplate').html(),
                    busy: this._element.find('#busyModalTemplate').html(),
                    category: this._element.find('#categoryModalTemplate').html(),
                    confirm: this._element.find('#confirmModalTemplate').html(),
                    connect: this._element.find('#connectModalTemplate').html(),
                    cookieNotice: this._element.find('#cookieNoticeModalTemplate').html(),
                    coupon: this._element.find('#couponModalTemplate').html(),
                    couponCode: this._element.find('#couponCodeModalTemplate').html(),
                    couponCodeSuccess: this._element.find('#couponCodeSuccessModalTemplate').html(),
                    customUrl: this._element.find('#customUrlModalTemplate').html(),
                    error: this._element.find('#errorModalTemplate').html(),
                    facebookConnections: this._element.find('#facebookConnectionsModalTemplate').html(),
                    facebookError: this._element.find('#facebookErrorModalTemplate').html(),
                    facebookShare: this._element.find('#facebookShareModalTemplate').html(),
                    facebookSuccess: this._element.find('#facebookSuccessModalTemplate').html(),
                    images: this._element.find('#imagesModalTemplate').html(),
                    locked: this._element.find('#lockedModalTemplate').html(),
                    pending: this._element.find('#pendingModalTemplate').html(),
                    photoEdit: this._element.find('#photoEditModalTemplate').html(),
                    referral: this._element.find('#referralModalTemplate').html(),
                    share: this._element.find('#shareModalTemplate').html(),
                    smartShare: this._element.find('#smartShareModalTemplate').html(),
                    twitterError: this._element.find('#twitterErrorModalTemplate').html(),
                    twitterShare: this._element.find('#twitterShareModalTemplate').html(),
                    twitterSuccess: this._element.find('#twitterSuccessModalTemplate').html(),
                    upgrade: this._element.find('#upgradeModalTemplate').html(),
                    modal_canvas:this._element.find('#canvasModalTemplate').html(),
                    upsell: this._element.find('#upsellModalTemplate').html()
                },
                tabs: {
                    filters: this._element.find('#filtersTabTemplate').html(),
                    text: this._element.find('#textTabTemplate').html(),
                    background: this._element.find('#backgroundTabTemplate').html(),
                    templates: this._element.find('#templatesTabTemplate').html(),
                    templates_business:this._element.find('#businesstemplate').html(),
                     templates_invitation:this._element.find('#invitationtemplate').html(),
                    watermark: this._element.find('#watermarkTabTemplate').html()
                }
            };
        },
        getTemplatesTab: function() {
            return this._templatesTab;
        },
        getTextTab: function() {
            return this._textTab;
        },
        getTimeout: function(key) {
            return this._timeouts[key];
        },
        getUpgradeCallback: function() {
            return this._callbacks.upgrade;
        },
        getUserRole: function() {
            var
                role = 'guest';
            if (Sai.get('loggedInUser') !== false) {
                role = 'registered';
                if (Sai.get('loggedInUser').isPro.toInt() === 1) {
                    role = 'pro';
                }
            }
            return role;
        },
        getWatermarkTab: function() {
            return this._watermarkTab;
        },
        go: function(callbackPre) {
            var
                _this = this;
            if (this.validBrowser() === true && this._cookiesEnabled() === true) {
                if (this._isGhost === false) {
                    var
                        imageDocumentJson = this.getInitialImageDocumentJson(true);
                    this.setImageDocumentJson(imageDocumentJson);
                }
                this.drawFooter();
                this._canvas = this.drawCanvas();
                var
                    fontsToLoad = _this._fontFamilies.slice(0, 15);
                fontsToLoad = jQuery.merge(fontsToLoad, _this._imageDocument.getActiveFonts());
                this.loadWebFonts(fontsToLoad, function() {
                    _this.showCurrentTab();
                    _this.trackEvent('Speed', 'app.ready', 'milliseconds', (new Date()).getTime() - start);
                    _this.drawImage(function() {
                        setTimeout(function() {
                            var
                                callback = function() {
                                    _this.slideAppIntoView();
                                    _this._element.find('.customModal').remove();
                                    _this._footer.show();
                                    setTimeout(function() {
                                        _this._canvas.getElement().removeClass('hidden');
                                        _this._canvas.alignMargins();
                                    }, 0);
                                    if (query.get('flow') === 'checkout' && (Sai.get('loggedInUser') === false || Sai.get('loggedInUser').isPro.toInt() === 0)) {
                                        _this.showAppropriateUpgradeStep('checkout');
                                    }
                                    if (query.get('route') === 'login' && (Sai.get('loggedInUser') === false)) {
                                        _this.showConnectModal('login', 'register');
                                    }
                                    var
                                        publisher = Sai.get('publisher');
                                    if (publisher !== false && publisher.id.toInt() === 2) {
                                        _this.showBackgroundTab(false);
                                    }
                                    setTimeout(function() {
                                        if (_this.userIsPro() === false && typeof $.cookie('watermarkCalloutHasBeenSeen') === 'undefined' && App().getOpenModals().length === 0) {
                                            if (Sai.get('publisher') === false) {
                                                _this._addWatermarkCalloutEvents();
                                            }
                                        }
                                    }, _this._timeouts.watermarkCallout);
                                    callbackPre && callbackPre();
                                };
                            if (_this._isGhost === false) {
                                if (Sai.get('imageUrl') === false) {
                                    callback();
                                } else {
                                    _this.drawCloudinaryImageAsBackgroundLayer(Sai.get('imageUrl'), function() {
                                        App().getImageDocument().getBackgroundLayer().setProperty('wasManuallyUploaded', true);
                                        callback();
                                    }, 'limit', true);
                                }
                            } else {
                                callback();
                            }
                        }, _this._isGhost === true ? 0 : _this._timeouts.loadingApp);
                    });
                });
            } else {
                if (this.validBrowser() === false) {
                    setTimeout(function() {
                        _this.showBrowserUpgradeModal();
                    }, _this._timeouts.browserUpgrade);
                } else
                if (this._cookiesEnabled() === false) {
                    setTimeout(function() {
                        _this.showCookieNoticeModal();
                    }, _this._timeouts.cookieNotice);
                }
            }
        },
        hideFontUpgradeImage: function() {
            this._element.find('.fontUpgradeLock').addClass('hidden');
        },
        hidePhotoUpgradeImage: function() {
            this._element.find('.photoUpgradeLock').addClass('hidden');
        },
        hideTemplateUpgradeImage: function() {
            this._element.find('.templateUpgradeLock').addClass('hidden');
        },
        isFirefox: function() {
            return navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
        },
        isGhost: function() {
            return this._isGhost;
        },
        isIe: function() {
            var
                userAgent = navigator.userAgent;
            return userAgent.match(/msie/i) !== null || userAgent.match(/trident\/7/i) !== null;
        },
        isSafari5x: function() {
            var
                userAgent = navigator.userAgent;
            return userAgent.match(/Safari\//i) !== null && userAgent.match(/Version\/5/i) !== null;
        },
        isUsingReservedFont: function() {
            return this._usingReservedFont
        },
        isUsingReservedPhoto: function() {
            return this._usingReservedPhoto
        },
        isUsingReservedTemplate: function() {
            return this._usingReservedTemplate
        },
        loadEmptyCanvas: function() {
            var
                _this = this,
                imageJson;
            Sai.set('sourceImage', false);
            imageJson = this.getInitialImageDocumentJson(false);
            this.showBusyModal('loadingEmptyCanvas');
            this.setImageDocumentJson(imageJson);
            this.redrawImage(function() {
                setTimeout(function() {
                    _this.closeOpenModals();
                    _this._footer.show();
                    setTimeout(function() {
                        _this._canvas.getElement().removeClass('hidden');
                    }, 0);
                }, _this._timeouts.loadingEmptyCanvas);
            });
        },
        loadWebFonts: function(fonts, callback) {
            if (this._isGhost === true) {
                callback && callback();
            } else {
                if (fonts.length === 0) {
                    callback && callback();
                } else {
                    var
                        font = fonts.shift(),
                        families = [];
                    if (typeof font.webfont === 'undefined' && this._loadedWebFonts.indexOf(font) === -1) {
                        this._loadedWebFonts.push(font);
                        families.push(font.name);
                        if (font.bold) {
                            families.push((font.name) + ':b');
                        }
                        if (font.italic) {
                            families.push((font.name) + ':i');
                        }
                        if (window.isChrome() === true) {
                            App().getFontFamily(font.name).italic = true;
                        }
                        WebFont.load({
                            active: function() {
                                App().loadWebFonts(fonts, callback);
                            },
                            google: {
                                families: families
                            },
                            timeout: 5000
                        });
                    } else {
                        App().loadWebFonts(fonts, callback);
                    }
                }
            }
        },
        registerUser: function(userObj, callback) {
            var
                facebookAdId = 6018804392714,
                val = 0,
                img = new
            Image(1, 1), path = 'https://www.facebook.com/offsite_event.php' + '?id=' + (facebookAdId) + '&amp;value=' + (val) + '&amp;currency=USD';
            img.src = path;
            callback && callback();
        },
        logUserIn: function(userObj, uploads, callback) {
            Sai.set('loggedInUser', userObj);
            Sai.set('uploads', uploads);
            this.trackRole();
            this._footer.update();
            this._backgroundTab.drawUploadsResourceTab();
            this._templatesTab.drawUserResourceTab();
            if (userObj.isPro.toInt() === 1) {
                var
                    _this = this;
                this.hideFontUpgradeImage();
                this.hidePhotoUpgradeImage();
                this._backgroundTab.refreshCategory();
                this.hideTemplateUpgradeImage();
                this._resetWatermarkToUsers(function() {
                    _this.getWatermarkTab().enable();
                    callback && callback();
                });
            } else {
                callback && callback();
            }
        },
        publishPermissionGiven: function(permissions) {
            if (!permissions.data) {
                return false;
            }
            if (permissions.data.length === 0) {
                return false;
            }
            for (var
                    x = 0, l = permissions.data.length, p; x < l; ++x) {
                p = permissions.data[x];
                if (p.permission === 'publish_actions' && p.status === 'granted') {
                    return true;
                }
            }
            return false;
        },
        redrawImage: function(callback, drawingTemplate) {
            this._clearCanvas(drawingTemplate);
            this._canvas = this.drawCanvas();
            this.drawImage(callback, this._canvas, drawingTemplate);
        },
        remixImage: function(imageObj, busyModalCopyKey, callback, drawingTemplate) {
            var
                _this = this,
                imageJson;
            Sai.set('sourceImage', imageObj);
            imageJson = this.getInitialImageDocumentJson(false);
            this.showBusyModal(busyModalCopyKey);
            this.setImageDocumentJson(imageJson);
            this.loadWebFonts(this._imageDocument.getActiveFonts(), function() {
                _this.redrawImage(function() {
                    setTimeout(function() {
                        _this.closeOpenModals();
                        _this._footer.show();
                        setTimeout(function() {
                            _this._canvas.getElement().removeClass('hidden');
                            callback && callback();
                        }, 0);
                    }, _this._timeouts.remixingImage);
                }, drawingTemplate);
            });
        },
        resetSize: function() {
            this._maximumCanvasDimensions = {
                width: this._canvasDimensionsLimit.width,
                height: this._canvasDimensionsLimit.height
            };
            var
                $dropdown = this._element.find('[name="resize"]');
            $dropdown.selectpicker('val', 'original');
            this._resetSizeCopy();
        },
        resetStartTime: function() {
            this._startTime = Sai.getUnixTimestamp();
        },
        resize: function(resizingToOriginal) {
            var
                _this = this,
                backgroundLayer = this._imageDocument.getBackgroundLayer();
            if (backgroundLayer.getProperty('type') !== 'rectangle') {
                var
                    sourceSrc = backgroundLayer.getProperty('sourceSrc'),
                    isCloudinary = sourceSrc.match('cloudinary.com') !== null;
                if (isCloudinary) {
                    var
                        fill;
                    if (resizingToOriginal) {
                        App().resetSize();
                    }
                    fill = 'lfill';
                    if (backgroundLayer.getProperty('wasManuallyUploaded') === false) {
                        fill = 'lfill';
                    }
                    App().drawCloudinaryImageAsBackgroundLayer(sourceSrc, function() {}, fill, false);
                } else {
                    var
                        fit = 'crop';
                    if (resizingToOriginal) {
                        App().resetSize();
                        fit = 'max';
                    }
                    App().drawFPImageAsBackgroundLayer(sourceSrc, fit, function() {});
                }
            } else {
                var
                    dimensions = {
                        width: this._maximumCanvasDimensions.width,
                        height: this._maximumCanvasDimensions.height
                    };
                backgroundLayer.setStyles(dimensions);
                backgroundLayer.getDrawing().refreshStyles(['width', 'height']);
                App().getCanvas().resize();
            }
        },
        setConnectCallback: function(callback) {
            this._callbacks.connect = callback;
        },
        setImageDocument: function(imageDocument) {
            this._imageDocument = imageDocument;
        },
        setImageDocumentJson: function(imageDocumentJson) {
            if (this._imageDocument !== null) {
                delete
                this._imageDocument;
            }
            this._imageDocument = (new ImageDocument(imageDocumentJson));
        },
        setUpgradeCallback: function(callback) {
            this._callbacks.upgrade = callback;
        },
        showAccountModal: function(defaultTab) {
            var
                html = _.template(this.getTemplate('modals', 'account'), {
                    user: Sai.get('loggedInUser'),
                    csrfToken: Sai.get('csrfToken')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            App().mpTrackEvent('Account modal shown');
            var
                modalView = (new AccountModalView(element));
            if (typeof defaultTab === 'undefined') {
                modalView.showCurrentTab();
            } else {
                modalView.showTab(defaultTab);
            }
            this._openModals.push(modalView);
            this._footer.hide();
        },
        showAppropriateUpgradeStep: function(connectModalState) {
            var
                _this = this,
                directCheckoutFlow = connectModalState === 'checkout';
            if (Sai.get('loggedInUser') !== false) {
                this.showUpgradeModal(false, directCheckoutFlow);
            } else {
                this.showConnectModal('register', connectModalState);
                this.setConnectCallback(function() {
                    if (Sai.get('loggedInUser').isPro.toInt() === 0) {
                        _this.showUpgradeModal(false, directCheckoutFlow);
                    }
                });
            }
        },
        showBackgroundTab: function(trackPageView) {
            if (typeof $.cookie('weeklySnapsPromoSeen') === 'undefined') {
                if (Sai.get('publisher') === false) {
                    if (Sai.get('loggedInUser') !== false && false) {
                        $.cookie('weeklySnapsPromoSeen', '1', {
                            path: '/',
                            domain: '.' + (location.host)
                        });
                        App().showAlertModal('weeklySnaps');
                    }
                }
            }
            if (typeof $.cookie('cC0PromoSeen') === 'undefined') {
                if (Sai.get('publisher') === false) {
                    $.cookie('cC0PromoSeen', '1', {
                        path: '/',
                        domain: '.' + (location.host),
                        expires: 365 * 2
                    });
                    App().showCC0Modal();
                }
            }
            this._currentTab = 'background';
            this._element.find('ul.tabs li.active').removeClass('active');
            this._element.find('ul.tabs li.background').addClass('active');
            this._element.find('div.tabContent > div').addClass('hidden');
            this._element.find('div.tabContent > div.backgroundTab').removeClass('hidden');
            this._element.find('div.tabContent > div.backgroundTab div.photos').trigger('scroll');
            if (typeof trackPageView === 'undefined' || trackPageView === true) {
                App().trackView('/app/background');
                App().mpTrackEvent('Background tab shown');
            }
        },
        showBrowserUpgradeModal: function() {
            var
                html = _.template(this.getTemplate('modals', 'browserUpgrade'), {}),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new BrowserUpgradeModalView(element));
            this._openModals.push(modalView);
            App().trackView('/app/browserUpgrade');
            App().mpTrackEvent('Browser upgrade modal shown');
        },
        showCanvasModal: function(copyKey) {
            var
                html = _.template(this.getTemplate('modals', 'modal_canvas'), {
                    copyKey: copyKey,
                   
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new BusyModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/busy/' + (copyKey));
            App().mpTrackEvent('Busy modal shown', {
                _copyKey: copyKey
            });
        },
        showBusyModal: function(copyKey, showRandomTip) {
            var
                html = _.template(this.getTemplate('modals', 'busy'), {
                    copyKey: copyKey,
                    copy: this._busyModalCopy[copyKey],
                    showRandomTip: showRandomTip
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new BusyModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/busy/' + (copyKey));
            App().mpTrackEvent('Busy modal shown', {
                _copyKey: copyKey
            });
        },
        showCategoryModal: function(callback) {
            var
                html = _.template(this.getTemplate('modals', 'category'), {
                    csrfToken: Sai.get('csrfToken')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new CategoryModalView(element, callback));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/category');
            App().mpTrackEvent('Category modal shown');
        },
        showCookieNoticeModal: function() {
            var
                html = _.template(this.getTemplate('modals', 'cookieNotice'), {}),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new CookieNoticeModalView(element));
            this._openModals.push(modalView);
            App().trackView('/app/cookieNotice');
            App().mpTrackEvent('Cookie notice modal shown');
        },
        showCouponModal: function(callback) {
            var
                html = _.template(this.getTemplate('modals', 'coupon'), {
                    csrfToken: Sai.get('csrfToken')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new CouponModalView(element, callback));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/coupon');
            App().mpTrackEvent('Coupon modal shown');
        },
        showCouponCodeModal: function(callback) {
            var
                html = _.template(this.getTemplate('modals', 'couponCode'), {
                    csrfToken: Sai.get('csrfToken'),
                    user: Sai.get('loggedInUser')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new CouponCodeModalView(element, callback));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/couponCode');
            App().mpTrackEvent('Coupon code modal shown');
        },
        showCouponCodeSuccessModal: function(couponObj) {
            var
                html = _.template(this.getTemplate('modals', 'couponCodeSuccess'), {
                    couponObj: couponObj,
                    user: Sai.get('loggedInUser')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new CouponCodeSuccessModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/couponCodeSuccess');
            App().mpTrackEvent('Coupon code success modal shown', {
                _couponCode: couponObj.code
            });
        },
        showCustomUrlModal: function(imageObj, callback) {
            var
                html = _.template(this.getTemplate('modals', 'customUrl'), {
                    csrfToken: Sai.get('csrfToken'),
                    image: imageObj
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new CustomUrlModalView(element, callback));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/customUrl');
            App().mpTrackEvent('Custom url modal shown');
        },
        showConnectModal: function(type, state) {
            var
                html = _.template(this.getTemplate('modals', 'connect'), {
                    config: Sai.get('config'),
                    csrfToken: Sai.get('csrfToken'),
                    imageString: this.getImageDocument().exportToImageString()
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new ConnectModalView(element));
            this._openModals.push(modalView);
            if (state === 'upgrade') {
                modalView.showUpgradeState();
            } else
            if (state === 'checkout') {
                modalView.showCheckoutState();
            } else
            if (state === 'create') {
                modalView.showCreateState();
            } else
            if (state === 'register') {
                modalView.showRegisterState();
            } else
            if (state === 'testimonials') {
                modalView.showTestimonialsState();
            }
            var
                loginOverride = false;
            if (state === 'create' && typeof $.cookie('isLoggedIn') !== 'undefined') {
                loginOverride = true;
            }
            App().mpTrackEvent('Connect modal shown', {
                _state: state
            });
            if (type === 'login' || loginOverride) {
                modalView.showLoginForm();
            } else
            if (type === 'register') {
                modalView.showRegisterForm();
            } else
            if (type === 'resetPassword') {
                modalView.showResetPasswordForm();
            }
            this._footer.hide();
        },
        showCurrentTab: function() {
            var
                capitalized = this._currentTab.charAt(0).toUpperCase() + this._currentTab.slice(1),
                functionName = 'show' + (capitalized) + 'Tab';
            this[functionName]();
            this._element.find('#editor').attr('class', '');
            this._element.find('#editor').addClass((this._currentTab) + 'TabVisible');
        },
        showErrorModal: function(copy, referenceCode, headline) {
            var
                html = _.template(this.getTemplate('modals', 'error'), {
                    headline: headline || 'Uh oh. Something bad happened.',
                    copy: copy || 'Please try again',
                    referenceCode: referenceCode
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new ErrorModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/error/' + (referenceCode));
            App().mpTrackEvent('Error modal shown', {
                _copy: copy,
                _referenceCode: referenceCode
            });
        },
        showFacebookConnectionsModal: function(connections) {
            var
                html = _.template(this.getTemplate('modals', 'facebookConnections'), {
                    connections: connections,
                    user: Sai.get('loggedInUser')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new FacebookConnectionsModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/facebookConnections');
            App().mpTrackEvent('Facebook connections modal shown');
        },
        showFacebookErrorModal: function(facebookTopErrorKey, facebookBottomErrorKey) {
            var
                html = _.template(this.getTemplate('modals', 'facebookError'), {
                    topCopy: this._facebookErrorModalCopy.top[facebookTopErrorKey],
                    bottomCopy: this._facebookErrorModalCopy.bottom[facebookBottomErrorKey]
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new FacebookErrorModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/facebookError');
            App().mpTrackEvent('Facebook error modal shown', {
                _facebookTopErrorKey: facebookTopErrorKey,
                _facebookBottomErrorKey: facebookBottomErrorKey
            });
        },
        showFacebookShareModal: function(imageObj) {
            var
                html = _.template(this.getTemplate('modals', 'facebookShare'), {
                    csrfToken: Sai.get('csrfToken'),
                    image: imageObj,
                    user: Sai.get('loggedInUser')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new FacebookShareModalView(element, imageObj));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/facebookShare');
            App().mpTrackEvent('Facebook share modal shown');
        },
        showFacebookSuccessModal: function(shareId, connectionObj) {
            var
                html = _.template(this.getTemplate('modals', 'facebookSuccess'), {
                    connection: connectionObj,
                    shareId: shareId,
                    user: Sai.get('loggedInUser')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new FacebookSuccessModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/facebookSuccess');
            App().mpTrackEvent('Facebook success modal shown', {
                _shareId: shareId
            });
        },
        showFilepicker: function(callback, multiple) {
            var
                _this = this,
                options = {
                    mimetypes: ['image/jpg', 'image/jpeg', 'image/png', 'image/gif'],
                    container: 'window',
                    services: ['COMPUTER', 'FACEBOOK', 'URL', 'INSTAGRAM', 'IMAGE_SEARCH'],
                    openTo: 'COMPUTER',
                    multiple: multiple
                };
            if (multiple === true) {
                options.maxFiles = 250;
            }
            filepicker.pickAndStore(options, {
                location: 'S3',
                access: 'public'
            }, function(inkBlobs) {
                if (multiple === false) {
                    var
                        InkBlob = inkBlobs[0],
                        key = InkBlob.url.split('/').pop(),
                        sourceSrc = 'https://' + (Sai.get('config').cloudfront.filepicker) + '/api/file/' + (key);
                    _this.showBusyModal('loadingFilepickerImage');
                    callback(sourceSrc, InkBlob);
                } else {
                    _this.showBusyModal('loadingFilepickerImage');
                    callback(inkBlobs);
                }
            }, function(FPError) {
                log(FPError);
                log(FPError.toString());
            });
        },
        showFiltersTab: function() {
            this._currentTab = 'filters';
            this._element.find('ul.tabs li.active').removeClass('active');
            this._element.find('ul.tabs li.filters').addClass('active');
            this._element.find('div.tabContent > div').addClass('hidden');
            this._element.find('div.tabContent > div.filtersTab').removeClass('hidden');
            App().trackView('/app/filters');
            App().mpTrackEvent('Filters tab shown');
        },
        showFontUpgradeImage: function() {
            var
                $lock = this._element.find('.fontUpgradeLock');
            $lock.removeClass('hidden');
            var
                bottom = (this._element.find('#preview').css('height').toInt() - this._canvas.getElement().css('height').toInt()) / 2;
            $lock.css('bottom', Math.round(bottom));
            var
                right = (this._element.find('#preview').css('width').toInt() - this._canvas.getElement().css('width').toInt()) / 2;
            $lock.css('right', Math.round(right));
        },
        showImagesModal: function() {
            var
                userId = Sai.get('loggedInUser').id.toInt(),
                html = _.template(this.getTemplate('modals', 'images'), {}),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new ImagesModalView(element));
            modalView.load('/images?userId=' + (userId));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/images');
            App().mpTrackEvent('Images modal shown');
        },
        showLockedModal: function() {
            var
                html = _.template(this.getTemplate('modals', 'locked'), {}),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new LockedModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/locked');
            App().mpTrackEvent('Locked modal shown');
            clearInterval(this._pingIntervalReference);
        },
        showPendingModal: function(copyKey) {
            var
                html = _.template(this.getTemplate('modals', 'pending'), {
                    copy: this._pendingModalCopy[copyKey]
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new PendingModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/pending/' + (copyKey));
            App().mpTrackEvent('Pending modal shown', {
                _copyKey: copyKey
            });
        },
        showPhotoEditModal: function(photoId, callback) {
            var
                _this = this;
            this.showBusyModal('loadingPhoto');
            jQuery.get('/photos/' + (photoId), {}, function(response) {
                var
                    html = _.template(_this.getTemplate('modals', 'photoEdit'), {
                        csrfToken: Sai.get('csrfToken'),
                        markup: response
                    }),
                    element = $(jQuery.parseHTML(html.trim()));
                _this._element.find('#body').append(element);
                _this.closeBusyModal();
                var
                    modalView = (new PhotoEditModalView(element, callback));
                _this._openModals.push(modalView);
                _this._footer.hide();
                App().trackView('/app/photoEdit');
                App().mpTrackEvent('Photo edit modal shown');
            }).fail(function() {
                _this.showErrorModal(false, 'y1lk');
            });
        },
        showPhotoUpgradeImage: function() {
            var
                $lock = this._element.find('.photoUpgradeLock');
            $lock.removeClass('hidden');
            var
                bottom = (this._element.find('#preview').css('height').toInt() - this._canvas.getElement().css('height').toInt()) / 2;
            $lock.css('bottom', Math.round(bottom));
            var
                right = (this._element.find('#preview').css('width').toInt() - this._canvas.getElement().css('width').toInt()) / 2;
            $lock.css('right', Math.round(right));
        },
        showShareModal: function(imageObj) {
            var
                html = _.template(this.getTemplate('modals', 'share'), {
                    csrfToken: Sai.get('csrfToken'),
                    image: imageObj,
                    user: Sai.get('loggedInUser'),
                    publisher: Sai.get('publisher')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new ShareModalView(element, imageObj));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/share');
            App().mpTrackEvent('Share modal shown');
        },
        showSmartShareModal: function(imageObj) {
            var
                html = _.template(this.getTemplate('modals', 'smartShare'), {
                    csrfToken: Sai.get('csrfToken'),
                    image: imageObj,
                    user: Sai.get('loggedInUser'),
                    publisher: Sai.get('publisher')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new SmartShareModalView(element, imageObj));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/smartShare');
            App().mpTrackEvent('Smart share modal shown');
        },
        showTemplateUpgradeImage: function() {
            var
                $lock = this._element.find('.templateUpgradeLock');
            $lock.removeClass('hidden');
            var
                bottom = (this._element.find('#preview').css('height').toInt() - this._canvas.getElement().css('height').toInt()) / 2;
            $lock.css('bottom', Math.round(bottom));
            var
                right = (this._element.find('#preview').css('width').toInt() - this._canvas.getElement().css('width').toInt()) / 2;
            $lock.css('right', Math.round(right));
        },
        showTextTab: function() {
            this._currentTab = 'text';
            this._element.find('ul.tabs li.active').removeClass('active');
            this._element.find('ul.tabs li.text').addClass('active');
            this._element.find('div.tabContent > div').addClass('hidden');
            this._element.find('div.tabContent > div.textTab').removeClass('hidden');
        },
        showTwitterErrorModal: function(twitterErrorKey) {
            var
                html = _.template(this.getTemplate('modals', 'twitterError'), {
                    copy: this._twitterErrorModalCopy[twitterErrorKey]
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new TwitterErrorModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/twitterError');
            App().mpTrackEvent('Twitter error modal shown', {
                _twitterErrorKey: twitterErrorKey
            });
        },
        showTwitterShareModal: function(imageObj) {
            var
                html = _.template(this.getTemplate('modals', 'twitterShare'), {
                    csrfToken: Sai.get('csrfToken'),
                    image: imageObj,
                    user: Sai.get('loggedInUser')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new TwitterShareModalView(element, imageObj));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/twitterShare');
            App().mpTrackEvent('Twitter share modal shown');
        },
        showTwitterSuccessModal: function(shareId, connectionObj) {
            var
                html = _.template(this.getTemplate('modals', 'twitterSuccess'), {
                    connection: connectionObj,
                    shareId: shareId,
                    user: Sai.get('loggedInUser')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new TwitterSuccessModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/twitterSuccess');
            App().mpTrackEvent('Twitter success modal shown', {
                _shareId: shareId
            });
        },
        showAlertModal: function(alertKey, callback) {
            var
                html = _.template(this.getTemplate('modals', 'alert'), {
                    alert: this._alerts[alertKey]
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new AlertModalView(element, this._alerts[alertKey], callback));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/alert/' + (alertKey));
            App().mpTrackEvent('Alert modal shown', {
                _alertKey: alertKey
            });
        },
        showCC0Modal: function() {
            var
                html = _.template(this.getTemplate('modals', 'cC0'), {}),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new CC0ModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/cC0');
            App().mpTrackEvent('CC0 modal shown', {});
        },
        showConfirmModal: function(confirmKey, yesCallback, noCallback) {
            var
                html = _.template(this.getTemplate('modals', 'confirm'), {
                    confirm: this._confirms[confirmKey]
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new ConfirmModalView(element, this._confirms[confirmKey], yesCallback, noCallback));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/confirm/' + (confirmKey));
            App().mpTrackEvent('Confirm modal shown', {
                _confirmKey: confirmKey
            });
        },
        showUpgradeModal: function(creatingImageFlow, directCheckoutFlow) {
            var
                _this = this;
            this.showBusyModal('upgrading');
            setTimeout(function() {
                App().trackView('/app/upgrade');
                App().mpTrackEvent('Upgrade modal shown', {
                    _creatingImageFlow: creatingImageFlow,
                    _directCheckoutFlow: directCheckoutFlow
                });
                var
                    html = _.template(_this.getTemplate('modals', 'upgrade'), {
                        defaults: Sai.get('config').defaults,
                        copy: App()._busyModalCopy.processingCreditCard,
                        creatingImageFlow: creatingImageFlow,
                        directCheckoutFlow: directCheckoutFlow,
                        user: Sai.get('loggedInUser'),
                        csrfToken: Sai.get('csrfToken'),
                        provinces: Sai.get('provinces'),
                        referredByPartner: typeof
                        jQuery.cookie('partner') !== 'undefined'
                    }),
                    element = $(jQuery.parseHTML(html.trim()));
                _this._element.find('#body').append(element);
                var
                    modalView = (new UpgradeModalView(element));
                _this._openModals.push(modalView);
                if (directCheckoutFlow === true) {
                    modalView.getElement().addClass('directCheckoutFlow');
                }
                App().closeBusyModal();
            }, this._timeouts.upgrading);
            this._footer.hide();
        },
        showReferralModal: function() {
            $.cookie('referralModalSeen', '1', {
                path: '/',
                domain: '.' + (location.host),
                expires: 365 * 2
            });
            var
                html = _.template(this.getTemplate('modals', 'referral'), {
                    user: Sai.get('loggedInUser')
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new ReferralModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().mpTrackEvent('Referral modal shown');
            App().trackView('/app/referral');
        },
        showUpsellModal: function(type) {
            var
                defaults = Sai.get('config').defaults,
                frequency = defaults.frequency,
                user = Sai.get('loggedInUser');
            if (user !== false) {
                frequency = user.frequency;
            }
            if (frequency === 'yearly') {
                frequency = 'year';
            } else
            if (frequency === 'monthly') {
                frequency = 'month';
            }
            var
                rate = defaults.rate;
            if (defaults.frequency === 'yearly') {
                rate = defaults.yearlyRate / 12;
            }
            if (user !== false) {
                rate = user.rate;
                if (user.frequency === 'yearly') {
                    rate = user.yearlyRate / 12;
                }
            }
            rate = rate / 100;
            var
                copy = this._upsellModalCopy[type];
            var
                html = _.template(this.getTemplate('modals', 'upsell'), {
                    copy: copy,
                    type: type,
                    rate: rate,
                    frequency: frequency
                }),
                element = $(jQuery.parseHTML(html.trim()));
            this._element.find('#body').append(element);
            var
                modalView = (new UpsellModalView(element));
            this._openModals.push(modalView);
            this._footer.hide();
            App().trackView('/app/upsell/' + (type));
            App().mpTrackEvent('Upsell modal shown', {
                _type: type
            });
        },
        showTemplatesTab: function() {
            this._currentTab = 'templates';
            this._element.find('ul.tabs li.active').removeClass('active');
            this._element.find('ul.tabs li.templates').addClass('active');
            this._element.find('div.tabContent > div').addClass('hidden');
            this._element.find('div.tabContent > div.templatesTab').removeClass('hidden');
            App().trackView('/app/templates');
            App().mpTrackEvent('Templates tab shown');
        },
        showWatermarkTab: function() {
            this._currentTab = 'watermark';
            this._element.find('ul.tabs li.active').removeClass('active');
            this._element.find('ul.tabs li.watermark').addClass('active');
            this._element.find('div.tabContent > div').addClass('hidden');
            this._element.find('div.tabContent > div.watermarkTab').removeClass('hidden');
            App().trackView('/app/watermark');
            App().mpTrackEvent('Watermark tab shown');
        },
        siteHasBeenLocked: function(response) {
            if (response.failedRules) {
                if (response.failedRules[0].validator) {
                    if (response.failedRules[0].validator[0] === 'CommonValidator' && response.failedRules[0].validator[1] === 'siteIsNotLocked') {
                        return true;
                    }
                    return false;
                }
                return false;
            }
            return false;
        },
        slideAppIntoView: function() {
            var
                _this = this;
            this._element.removeClass('sai-closed');
            this._element.addClass('sai-opening');
            setTimeout(function() {
                _this._element.removeClass('sai-opening');
                _this._element.addClass('sai-open');
            }, 500);
            var
                data = {
                    action: 'opened'
                };
            window.parent.postMessage(JSON.stringify(data), '*');
        },
        slideAppOutOfView: function() {
            var
                _this = this;
            this._element.removeClass('sai-open');
            this._element.addClass('sai-closing');
            setTimeout(function() {
                _this._element.removeClass('sai-closing');
                _this._element.addClass('sai-closed');
            }, 500);
            var
                data = {
                    action: 'hide'
                };
            window.parent.postMessage(JSON.stringify(data), '*');
        },
        trackEmbedType: function() {
            var
                embedType = 'unknown';
            if (typeof query.get('embedType') !== 'undefined') {
                embedType = query.get('embedType');
            }
            this.trackCustomVar(3, 'Embed Type', embedType, 2);
        },
        trackFlow: function() {
            var
                flow = 'unknown';
            if (typeof query.get('flow') !== 'undefined') {
                flow = query.get('flow');
            }
            this.trackCustomVar(2, 'Flow', flow, 2);
        },
        trackPageView: function(path) {
            jQuery.post('/users/trackPageView', {
                csrfToken: Sai.get('csrfToken'),
                path: path
            }, function(response) {
                if (response.success === true) {
                    Sai.set('loggedInUser', response.data.user);
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        App().showErrorModal(false, response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                App().showErrorModal(false, '51jk');
            });
        },
        trackRole: function() {
            this.trackCustomVar(1, 'Role', App().getUserRole(), 2);
        },
        trackUpload: function(url, callback) {
            jQuery.post('/uploads', {
                url: url,
                csrfToken: Sai.get('csrfToken')
            }, function(response) {
                if (response.success === true) {
                    callback && callback(response.data.upload);
                } else {
                    if (App().siteHasBeenLocked(response)) {
                        App().showLockedModal();
                    } else {
                        App().showErrorModal('Oh ho!', response.failedRules[0].error.reference);
                    }
                }
            }, 'json').fail(function() {
                App().showErrorModal('Oh ho!', 'avi3');
            });
        },
        updateUserMpPeopleData: function() {
            var
                userObj = Sai.get('loggedInUser'),
                data = {
                    '$email': userObj.email,
                    '$created': (new Date(userObj.created.toInt() * 1000)),
                    _id: userObj.id.toInt(),
                    _isLegacyProUser: userObj.isLegacyProUser.toInt() === 1 ? true : false,
                    _isAdmin: userObj.isAdmin.toInt() === 1 ? true : false,
                    _isPro: userObj.isPro.toInt() === 1 ? true : false,
                    _rate: userObj.rate.toInt(),
                    _frequency: userObj.frequency,
                    _yearlyRate: userObj.yearlyRate.toInt(),
                    _imagesSaved: userObj.imagesSaved.toInt(),
                    '$first_name': userObj.firstName,
                    '$username': userObj.username,
                    '$last_name': userObj.lastName,
                    '$name': (userObj.firstName) + ' ' + (userObj.lastName)
                };
            App().mpPeopleSet(data);
        },
        upgradeUser: function(userObj) {
            Sai.set('loggedInUser', userObj);
            this.trackRole();
            this.hideFontUpgradeImage();
            this.hidePhotoUpgradeImage();
            this.getWatermarkTab().enable();
            this._backgroundTab.refreshCategory();
            this._backgroundTab.drawUploadsResourceTab();
            this._footer.update();
            this._imageDocument.getWatermarkLayer().getDrawing().makeDraggable();
            var
                facebookAdId = 6018803995514,
                frequency = userObj.frequency,
                val = frequency === 'yearly' ? userObj.yearlyRate : userObj.rate,
                img = new
            Image(1, 1), path = 'https://www.facebook.com/offsite_event.php' + '?id=' + (facebookAdId) + '&amp;value=' + (val) + '&amp;currency=USD';
            img.src = path;
            var
                img = new
            Image(1, 1);
            var
                google_conversion_id = 960784177;
            var
                google_conversion_language = "en";
            var
                google_conversion_format = "3";
            var
                google_conversion_color = "ffffff";
            var
                google_conversion_label = "FD6JCPeUg1gQsc6RygM";
            var
                google_conversion_value = 12.00;
            var
                google_conversion_currency = "USD";
            var
                google_remarketing_only = false;
            img.src = 'https://www.googleadservices.com/pagead/conversion/' + google_conversion_id + '/?' + 'value=' + (frequency === 'yearly' ? (userObj.yearlyRate / 100) : (userObj.rate / 100)) + '&amp;currency_code=' + (google_conversion_currency) + '&amp;label=' + (google_conversion_label) + '&amp;guid=ON&amp;script=0';
        },
        userIsAdmin: function() {
            return Sai.get('loggedInUser') !== false && Sai.get('loggedInUser').isAdmin.toInt() === 1;
        },
        userIsLoggedIn: function() {
            return Sai.get('loggedInUser') !== false;
        },
        userIsPro: function() {
            return Sai.get('loggedInUser') !== false && Sai.get('loggedInUser').isPro.toInt() === 1;
        },
        useSmartShare: function() {
            return this._useSmartShare;
        },
        usingReservedFont: function(yes) {
            this._usingReservedFont = yes;
            if (yes) {
                this.showFontUpgradeImage();
            } else {
                this.hideFontUpgradeImage();
            }
        },
        usingReservedPhoto: function(yes) {
            this._usingReservedPhoto = yes;
            if (yes) {
                this.showPhotoUpgradeImage();
            } else {
                this.hidePhotoUpgradeImage();
            }
        },
        usingReservedTemplate: function(yes) {
            this._usingReservedTemplate = yes;
            if (yes) {
                this.showTemplateUpgradeImage();
            } else {
                this.hideTemplateUpgradeImage();
            }
        },
        validBrowser: function() {
            var
                elem = document.createElement('canvas');
            return !!(elem.getContext && elem.getContext('2d'));
            return 'hi';
        }
    });
var
    Sai = (function() {
        var
            _benchmark = 0;
        var
            _pageView;
        var
            _store = {};
        return {
            benchmark: function() {
                _benchmark = (new Date()).getTime();
            },
            elapsed: function() {
                return (new Date()).getTime() - _benchmark;
            },
            get: function(key) {
                return _store[key];
            },
            getPageView: function() {
                return _pageView;
            },
            getUnixTimestamp: function() {
                return Math.round((new Date()).getTime() / 1000);
            },
            moveCaretToEnd: function(el) {
                if (typeof el.selectionStart == 'number') {
                    el.selectionStart = el.selectionEnd = el.value.length;
                } else
                if (typeof el.createTextRange != 'undefined') {
                    el.focus();
                    var
                        range = el.createTextRange();
                    range.collapse(false);
                    range.select();
                }
            },
            nameSort: function(a, b) {
                if (a.name < b.name) {
                    return -1;
                }
                if (a.name > b.name) {
                    return 1;
                }
                return 0;
            },
            setPageView: function(pageView) {
                _pageView = pageView;
            },
            getRandomHash: function() {
                var
                    text = '',
                    possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789',
                    i = 0;
                for (i = 0; i < 5; i++) {
                    text += possible.charAt(Math.floor(Math.random() * possible.length));
                }
                return text;
            },
            setUrlParam: function(url, param, value) {
                var
                    val = new
                RegExp('(\\?|\\&)' + param + '=.*?(?=(&|$))'), parts = url.toString().split('#'), url = parts[0], hash = parts[1], qstring = /\?.+$/, newURL = url;
                if (val.test(url)) {
                    newURL = url.replace(val, '$1' + param + '=' + value);
                } else
                if (qstring.test(url)) {
                    newURL = url + '&' + param + '=' + value;
                } else {
                    newURL = url + '?' + param + '=' + value;
                }
                if (hash) {
                    newURL += '#' + hash;
                }
                return newURL;
            },
            init: function() {
                var
                    bodyElement = $('body').first(),
                    pageViewName = bodyElement.attr('data-pageViewName');
                if (typeof pageViewName === 'undefined') {
                    log('No page view defined.');
                } else {
                    _pageView = (new window[pageViewName](bodyElement));
                }
                $.fn.serializeObject = function() {
                    var
                        o = {};
                    var
                        a = this.serializeArray();
                    $.each(a, function() {
                        if (o[this.name] !== undefined) {
                            if (!o[this.name].push) {
                                o[this.name] = [o[this.name]];
                            }
                            o[this.name].push(this.value || '');
                        } else {
                            o[this.name] = this.value || '';
                        }
                    });
                    return o;
                };
                String.prototype.toInt = Number.prototype.toInt = function() {
                    return parseInt(this, 10);
                };
                String.prototype.toFloat = Number.prototype.toFloat = function() {
                    return parseFloat(this);
                };
                String.prototype.toStr = Number.prototype.toStr = function() {
                    return this + '';
                };
                String.prototype.toCommas = Number.prototype.toCommas = function() {
                    return this.toStr().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                };
                String.prototype.centsTo$ = Number.prototype.centsTo$ = function() {
                    var
                        dollars = (this.toInt() / 100) + '';
                    if (dollars.indexOf('.') === -1) {
                        dollars += '.00';
                    } else
                    if (dollars.match(/\.[0-9]{1}$/) !== null) {
                        dollars += '0';
                    }
                    return dollars;
                };
                String.prototype.ucfirst = function() {
                    return this.charAt(0).toUpperCase() + this.slice(1);
                };
                String.prototype.truncate = function(limit) {
                    if (this.length > limit) {
                        return this.substring(0, limit) + '...';
                    }
                    return this;
                };
                String.prototype.linkable = function() {
                    return this.replace(/((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/gi, function(url) {
                        var
                            full_url = url;
                        if (!full_url.match('^https?:\/\/')) {
                            full_url = 'http://' + full_url;
                        }
                        return '<a href="' + full_url + '">' + url + '</a>';
                    });
                };
                String.prototype.parseURL = function() {
                    return this.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g, function(url) {
                        return url.link('#');
                    });
                };
                String.prototype.parseUsername = function() {
                    return this.replace(/[@]+[A-Za-z0-9-_]+/g, function(u) {
                        var
                            username = u.replace('@', '');
                        return u.link('#');
                    });
                };
                String.prototype.parseHashtag = function() {
                    return this.replace(/[#]+[A-Za-z0-9-_]+/g, function(t) {
                        var
                            tag = t.replace('#', '%23');
                        return t.link('#');
                    });
                };
                String.prototype.tweetable = function() {
                    var
                        base_url = 'https://twitter.com/',
                        hashtag_part = 'search?q=#',
                        text = '';
                    text = this.replace(/(>|<a[^<>]+href=['"])?(https?:\/\/([-a-z0-9]+\.)+[a-z]{2,5}(\/[-a-z0-9!#()\/?&.,]*[^ !#?().,])?)/gi, function($0, $1, $2) {
                        return ($1 ? $0 : '<a href="' + $2 + '" target="_blank">' + $2 + '</a>');
                    });
                    text = text.replace(/(:\/\/|>)?\b(([-a-z0-9]+\.)+[a-z]{2,5}(\/[-a-z0-9!#()\/?&.]*[^ !#?().,])?)/gi, function($0, $1, $2) {
                        return ($1 ? $0 : '<a href="http://' + $2 + '">' + $2 + '</a>');
                    });
                    text = text.replace(/(:\/\/|>)?(@([_a-z0-9\-]+))/gi, function($0, $1, $2, $3) {
                        return ($1 ? $0 : '<a href="' + base_url + $3 + '" title="Follow ' + $3 + '" target="_blank">@' + $3 + '</a>');
                    });
                    text = text.replace(/(:\/\/[^ <]*|>)?(\#([_a-z0-9\-]+))/gi, function($0, $1, $2, $3) {
                        return ($1 ? $0 : '<a href="' + base_url + hashtag_part + $3 + '" title="Search tag: ' + $3 + '" target="_blank">#' + $3 + '</a>');
                    });
                    return text;
                };
                Image.prototype.getFittedDimensions = function(max) {
                    var
                        ratio = 0,
                        width = Math.floor(this.width),
                        height = Math.floor(this.height);
                    if (width <= max.width && height <= max.height) {
                        return {
                            width: width,
                            height: height
                        };
                    }
                    if (width > height) {
                        ratio = width / max.width;
                        width = max.width;
                        height = height / ratio;
                        return {
                            width: Math.floor(width),
                            height: Math.floor(height)
                        }
                    }
                    ratio = height / max.height;
                    height = max.height;
                    width = width / ratio;
                    return {
                        width: Math.floor(width),
                        height: Math.floor(height)
                    }
                };
                $.extend($.fn, {
                    nonIeFocus: function() {
                        if (App().isIe() === false) {
                            this.focus();
                        }
                    }
                });
            },
            set: function(key, value) {
                _store[key] = value;
            }
        };
    })();
queue.unshift(Sai.init);
isChrome = function() {
    return /chrom(e|ium)/.test(navigator.userAgent.toLowerCase());
};
App = function() {
    return Sai.getPageView();
};
//log('pre: ', (new Date()).getTime() - start);
queue.process();
//log('post: ', (new Date()).getTime() - start);